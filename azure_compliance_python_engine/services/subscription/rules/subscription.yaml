version: '1.0'
provider: azure
service: subscription
discovery:
- discovery_id: azure.resource.list
  calls:
  - action: list
    save_as: list_response
  emit:
    items_for: '{{ list_response.value }}'
    as: item
    item:
      id: '{{ item.id }}'
      subscription_id: '{{ item.subscription_id }}'
      display_name: '{{ item.display_name }}'
      state: '{{ item.state }}'
      subscription_policies: '{{ item.subscription_policies }}'
      authorization_source: '{{ item.authorization_source }}'
- discovery_id: azure.subscription.list
  calls:
  - action: list
    save_as: list_response
  emit:
    items_for: '{{ list_response.value }}'
    as: item
    item:
      id: '{{ item.id }}'
      subscription_id: '{{ item.subscription_id }}'
      display_name: '{{ item.display_name }}'
      state: '{{ item.state }}'
      subscription_policies: '{{ item.subscription_policies }}'
      authorization_source: '{{ item.authorization_source }}'
checks:
- rule_id: azure.resource.sku.standard.enforcement
  for_each: azure.resource.list
  conditions:
    var: item.state
    op: equals
    value: Enabled
- rule_id: azure.resource.manager.resource.lock.verification
  for_each: azure.resource.list
  conditions:
    var: item.state
    op: equals
    value: Enabled
- rule_id: azure.resource.groups_group.governance_project_required_guardrail_policies_attached
  for_each: azure.resource.list
  conditions:
    var: item.subscription_policies
    op: not_empty
- rule_id: azure.resource.groups_group.governance_project_security_services_mandatory_enabled
  for_each: azure.resource.list
  conditions:
    var: item.state
    op: equals
    value: Enabled
- rule_id: azure.resource.groups_group.governance_project_no_public_admin_roles
  for_each: azure.resource.list
  conditions:
    var: item.authorization_source
    op: not_equals
    value: Public
- rule_id: azure.subscription.owner.count.check
  for_each: azure.subscription.list
  conditions:
    var: item.authorization_source
    op: not_empty
