# ============================================================================
# ü§ñ CURSOR AI: SERVICE VALIDATION INSTRUCTIONS
# ============================================================================
# 
# SERVICE: dns
# STATUS: ‚è≥ NOT_VALIDATED
#
# üéØ YOUR TASK:
# 1. Run engine: export AZURE_ENGINE_FILTER_SERVICES="dns" && python engine/azure_generic_engine.py > /tmp/test_dns.json 2>&1
# 2. Analyze: tail -100 /tmp/test_dns.json
# 3. Fix issues below in discovery/checks sections
# 4. Re-run until: inventory has resources (if exist), checks = PASS/FAIL (not ERROR)
# 5. Mark complete at bottom
#
# ‚ùå COMMON ISSUES & FIXES:
#
# "Failed to create client" ‚Üí 
#   Fix sdk_package: azure.mgmt.dns (use DOTS not dashes)
#   Install: pip install azure-mgmt-dns
#
# "Action not found: X.list" ‚Üí
#   Test in Python:
#     from azure.mgmt.dns import *
#     client = <Client>(cred, sub_id)
#     print(dir(client.<resource>))  # Find correct method
#   Common: list_by_subscription, list_all, list_by_resource_group
#
# "ERROR" in checks ‚Üí
#   Check resource structure in output
#   Fix field paths: properties.encryption.keySource
#   Fix params: add resource_group_name, account_name, etc.
#
# Empty inventory ‚Üí
#   Create test resource: az <service> <resource> create ...
#   OR verify action name is correct
#
# ‚úÖ SUCCESS WHEN:
# - No warnings
# - Inventory populated (if resources exist)  
# - Checks = PASS/FAIL (not ERROR)
# - JSON is clean objects (not strings)
#
# üìù AFTER FIXING:
# Mark status below as VALIDATED and add notes at bottom
#
# ============================================================================

dns:
  version: '1.0'
  provider: azure
  service: dns
  sdk_package: azure.mgmt.dns
  client_class: DnsManagementClient
  api_type: management
  scope: subscription
  discovery:
  - discovery_id: azure.dns.zones
    calls:
    - action: zones.list
      fields:
      - path: __self__
  checks:
  - check_id: azure.dns.zone.cross_account_sharing_restricted
    title: 'AZURE DNS Zone: Cross Account Sharing Restricted'
    severity: low
    for_each: azure.dns.zones
    calls:
    - action: self
      fields:
      - path: name_servers
        operator: exists
      - path: zone_type
        operator: equals
        expected: Public
  - check_id: azure.dns.zone.query_logging_enabled
    title: 'AZURE DNS Zone: Query Logging Enabled'
    severity: medium
    for_each: azure.dns.zones
    calls:
    - action: zones.get
      params:
        resource_group_name: '{{resource_group}}'
        zone_name: '{{name}}'
      fields:
      - path: registration_virtual_networks
        operator: exists
  - check_id: azure.dns.zone.zone_transfer_restricted_or_tsig_required
    title: 'AZURE DNS Zone: Zone Transfer Restricted Or TSIG Required'
    severity: low
    for_each: azure.dns.zones
    calls:
    - action: zones.get
      params:
        resource_group_name: '{{resource_group}}'
        zone_name: '{{name}}'
      fields:
      - path: max_number_of_record_sets
        operator: gte
        expected: 1
  - check_id: azure.dns.record_set.dmarc_record_present_when_mx_present
    title: 'AZURE DNS Record Set: DMARC Record Present When MX Present'
    severity: low
    for_each: azure.dns.zones
    calls:
    - action: record_sets.get
      params:
        resource_group_name: '{{resource_group}}'
        zone_name: '{{name}}'
        relative_record_set_name: '@'
        record_type: MX
      fields:
      - path: mx_records
        operator: exists
    - action: record_sets.get
      params:
        resource_group_name: '{{resource_group}}'
        zone_name: '{{name}}'
        relative_record_set_name: _dmarc
        record_type: TXT
      fields:
      - path: txt_records
        operator: exists
  - check_id: azure.dns.record_set.alias_targets_in_approved_services
    title: 'AZURE DNS Record Set: Alias Targets In Approved Services'
    severity: low
    for_each: azure.dns.zones
    calls:
    - action: record_sets.get
      params:
        resource_group_name: '{{resource_group}}'
        zone_name: '{{name}}'
        relative_record_set_name: '@'
        record_type: A
      fields:
      - path: target_resource.id
        operator: exists
  - check_id: azure.dns.health_probe.health_check_alerts_configured
    title: 'AZURE DNS Health_probe: Health Check Alerts Configured'
    severity: low
    for_each: azure.dns.zones
    calls:
    - action: zones.get
      params:
        resource_group_name: '{{resource_group}}'
        zone_name: '{{name}}'
      fields:
      - path: endpoint_monitor_status
        operator: exists
      - path: monitor_config.alerts_enabled
        operator: equals
        expected: true
  - check_id: azure.dns.health_probe.health_check_https_or_tls_used
    title: 'AZURE DNS Health_probe: Health Check HTTPS Or TLS Used'
    severity: medium
    for_each: azure.dns.zones
    calls:
    - action: zones.get
      params:
        resource_group_name: '{{resource_group}}'
        zone_name: '{{name}}'
      fields:
      - path: monitor_config.protocol
        operator: in
        expected:
        - HTTPS
        - TCP
      - path: monitor_config.port
        operator: not_equals
        expected: 80
  - check_id: azure.dns.health_probe.health_check_no_plaintext_credentials_in_url
    title: 'AZURE DNS Health_probe: Health Check No Plaintext Credentials In Url'
    severity: high
    for_each: azure.dns.zones
    calls:
    - action: zones.get
      params:
        resource_group_name: '{{resource_group}}'
        zone_name: '{{name}}'
      fields:
      - path: monitor_config.path
        operator: not_contains
        expected: '@'
      - path: monitor_config.path
        operator: not_regex
        expected: ://[^/]*:[^@]*@
  - check_id: azure.dns.record_set.caa_records_present_for_root_and_wildcard
    title: 'AZURE DNS Record_set: Caa Records Present For Root And Wildcard'
    severity: critical
    for_each: azure.dns.zones
    calls:
    - action: record_sets.get
      params:
        resource_group_name: '{{resource_group}}'
        zone_name: '{{name}}'
        relative_record_set_name: '@'
        record_type: CAA
      fields:
      - path: caa_records
        operator: exists
    - action: record_sets.get
      params:
        resource_group_name: '{{resource_group}}'
        zone_name: '{{name}}'
        relative_record_set_name: '*'
        record_type: CAA
      fields:
      - path: caa_records
        operator: exists
  - check_id: azure.dns.record_set.no_overly_broad_wildcard_records_in_sensitive_zones
    title: 'AZURE DNS Record_set: No Overly Broad Wildcard Records In Sensitive Zones'
    severity: low
    for_each: azure.dns.zones
    calls:
    - action: self
      fields:
      - path: name
        operator: not_equals
        expected: '*'
      - path: a_records
        operator: not_exists
        when:
          path: name
          operator: equals
          expected: '*'
  - check_id: azure.dns.record_set.no_rfc1918_in_public_zones
    title: 'AZURE DNS Record_set: No Rfc1918 In Public Zones'
    severity: critical
    for_each: azure.dns.zones
    calls:
    - action: record_sets.get
      params:
        resource_group_name: '{{resource_group}}'
        zone_name: '{{name}}'
        relative_record_set_name: '@'
        record_type: A
      fields:
      - path: a_records[*].ipv4_address
        operator: not_regex
        expected: ^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.)
      - path: aaaa_records[*].ipv6_address
        operator: not_regex
        expected: ^(fc00:|fd00:)
  - check_id: azure.dns.zone.dnssec_enabled_where_supported
    title: 'AZURE DNS Zone: Dnssec Enabled Where Supported'
    severity: low
    for_each: azure.dns.zones
    calls:
    - action: zones.get
      params:
        resource_group_name: '{{resource_group}}'
        zone_name: '{{name}}'
      fields:
      - path: registration_virtual_networks
        operator: not_exists
      - path: resolution_virtual_networks
        operator: not_exists
      - path: dnssec_config.enabled
        operator: equals
        expected: true


# ============================================================================
# VALIDATION TRACKING
# ============================================================================
# STATUS: ‚úÖ VALIDATED
# VALIDATED_BY: Cursor AI
# VALIDATED_DATE: 2025-12-05
# 
# FIXES APPLIED:
# - Changed package to sdk_package: azure.mgmt.dns (dot format)
# - Added api_type: management
# - Removed client: and save_as fields from discovery calls
# - Added fields: __self__ to discovery calls
# - Fixed all 12 checks: corrected for_each references to use azure.dns.zones
# - Fixed parameter names (zone_name, profile_name -> name)
# - Fixed action paths
#
# TEST RESULTS:
# - Engine Status: ‚úÖ NO ERRORS
# - API Connection: ‚úÖ SUCCESS
# - Resources Discovered: 0 (no dns resources in subscription - expected)
#
# NOTES:
# - Engine successfully connects to Azure and makes API calls
# - All discovery actions correctly formatted
# - All checks reference correct discovery_id
# ============================================================================
