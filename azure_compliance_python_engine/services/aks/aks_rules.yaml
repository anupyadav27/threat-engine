aks:
  version: '1.0'
  provider: azure
  service: aks
  sdk_package: azure.mgmt.containerservice
  client_class: ContainerServiceClient
  api_type: management
  scope: subscription
  discovery:
  - discovery_id: azure.aks.clusters
    calls:
    - action: managed_clusters.list
      fields:
      - path: __self__
  - discovery_id: azure.aks.agent_pools
    calls:
    - action: agent_pools.list
      fields:
      - path: __self__
  - discovery_id: azure.aks.snapshots
    calls:
    - action: snapshots.list
      fields:
      - path: __self__
  checks:
  - check_id: azure.aks.authorization.mode.check
    title: 'AZURE AKS Authorization: Mode Check'
    severity: medium
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: aad_profile.enable_azure_rbac
        operator: equals
        expected: true
  - check_id: azure.aks.cluster.private.cluster.enabled
    title: 'AZURE AKS Cluster: Private Cluster Enabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: api_server_access_profile.enable_private_cluster
        operator: equals
        expected: true
  - check_id: azure.aks.service.account.default.usage.check
    title: 'AZURE AKS Service: Account Default Usage Check'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: service_principal_profile.client_id
        operator: exists
  - check_id: azure.kubernetes.controller_manager.containers_secure_port_tls_enabled
    title: 'AZURE Kubernetes Controller Manager: Containers Secure Port TLS Enabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: api_server_access_profile.enable_private_cluster_public_fqdn
        operator: equals
        expected: false
  - check_id: azure.kubernetes.deployment.containers_workload_host_network_pid_ipc_disabled
    title: 'AZURE Kubernetes Deployment: Containers Workload Host Network Pid Ipc Disabled'
    severity: medium
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: security_profile.defender.security_monitoring.enabled
        operator: equals
        expected: true
  - check_id: azure.aks.cluster.cis_3_2_6_needs_development
    title: 'AZURE KUBERNETES Resource: Cis 3 2 6 Needs Development'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: security_profile
        operator: exists
        expected: true
  - check_id: azure.aks.cluster.private.endpoint.and.public.access.check
    title: 'AZURE AKS Cluster: Private Endpoint And Public Access Check'
    severity: critical
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: api_server_access_profile.enable_private_cluster
        operator: equals
        expected: true
      - path: api_server_access_profile.disable_run_command
        operator: equals
        expected: true
  - check_id: azure.aks.cluster.private_nodes_enabled
    title: 'AZURE AKS Resource: Clusters Created With Private Nodes'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: agent_pool_profiles[*].enable_node_public_ip
        operator: equals
        expected: false
  - check_id: azure.aks.cluster.public_access_disabled
    title: 'AZURE AKS Resource: Clusters Public Access Disabled'
    severity: critical
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: api_server_access_profile.enable_private_cluster
        operator: equals
        expected: true
      - path: api_server_access_profile.authorized_ip_ranges
        operator: empty
        expected: true
  - check_id: azure.aks.kubelet.certificate.rotation.check
    title: 'AZURE AKS Kubelet: Certificate Rotation Check'
    severity: medium
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: agent_pool_profiles[*].kubelet_config.rotate_certificates
        operator: equals
        expected: true
  - check_id: azure.aks.kubelet.rotate.certificates.check
    title: 'AZURE AKS Kubelet: Rotate Certificates Check'
    severity: medium
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: agent_pool_profiles[*].kubelet_config.server_tls_bootstrap
        operator: equals
        expected: true
  - check_id: azure.aks.kubelet.streaming.connection.idle.timeout.check
    title: 'AZURE AKS Kubelet: Streaming Connection Idle Timeout Check'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: agent_pool_profiles[*].kubelet_config.streaming_connection_idle_timeout
        operator: less_than_or_equal
        expected: 300
  - check_id: azure.aks.namespace.network.policy.compliance.check
    title: 'AZURE AKS Namespace: Network Policy Compliance Check'
    severity: medium
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: network_profile.network_policy
        operator: not_equals
        expected: null
  - check_id: azure.aks.network.cni.version.check
    title: 'AZURE AKS Network: Cni Version Check'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: network_profile.network_plugin
        operator: in
        expected:
        - azure
        - kubenet
  - check_id: azure.aks.network.policy_enabled
    title: 'AZURE AKS Network: Policy Enabled'
    severity: medium
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: network_profile.network_policy
        operator: in
        expected:
        - azure
        - calico
  - check_id: azure.aks.pod.service.account.tokens.automount.disabled
    title: 'AZURE AKS Pod: Service Account Tokens Automount Disabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: security_profile.workload_identity.enabled
        operator: equals
        expected: true
  - check_id: azure.aks.rbac.check.cluster.admin.usage
    title: 'AZURE AKS Rbac: Check Cluster Admin Usage'
    severity: critical
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: enable_rbac
        operator: equals
        expected: true
      - path: aad_profile.enable_azure_rbac
        operator: equals
        expected: true
  - check_id: azure.kubernetes.addon.containers_from_trusted_channel
    title: 'AZURE KUBERNETES Addon: Containers From Trusted Channel'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: addon_profiles
        operator: exists
        expected: true
  - check_id: azure.kubernetes.addon.containers_no_privileged_permissions
    title: 'AZURE KUBERNETES Addon: Containers No Privileged Permissions'
    severity: high
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: security_profile.defender.security_monitoring.enabled
        operator: equals
        expected: true
  - check_id: azure.kubernetes.addon.containers_version_pinned_and_supported
    title: 'AZURE KUBERNETES Addon: Containers Version Pinned And Supported'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: kubernetes_version
        operator: matches_pattern
        expected: ^[0-9]+\.[0-9]+\.[0-9]+$
  - check_id: azure.kubernetes.admission_controller.containers_admission_host_namespace_usage_denied
    title: 'AZURE KUBERNETES Admission_controller: Containers Admission Host Namespace Usage Denied'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: security_profile.azure_policy_addon.enabled
        operator: equals
        expected: true
  - check_id: azure.kubernetes.admission_controller.containers_admission_image_registry_allowlist_enforced
    title: 'AZURE KUBERNETES Admission_controller: Containers Admission Image Registry Allowlist Enforced'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: security_profile.image_cleaner.enabled
        operator: equals
        expected: true
  - check_id: azure.kubernetes.admission_controller.containers_admission_image_signature_verification_enabled
    title: 'AZURE KUBERNETES Admission_controller: Containers Admission Image Signature Verification Enabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: security_profile.image_integrity.enabled
        operator: equals
        expected: true
  - check_id: azure.kubernetes.admission_controller.containers_admission_pod_security_admission_restricted_default
    title: 'AZURE KUBERNETES Admission_controller: Containers Admission Pod Security Admission Restricted Default'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: security_profile.defender.log_analytics_workspace_resource_id
        operator: not_equals
        expected: null
  - check_id: azure.kubernetes.admission_controller.containers_admission_privilege_escalation_denied
    title: 'AZURE KUBERNETES Admission_controller: Containers Admission Privilege Escalation Denied'
    severity: high
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: security_profile.defender.security_monitoring.enabled
        operator: equals
        expected: true
      - path: enable_rbac
        operator: equals
        expected: true
  - check_id: azure.kubernetes.agent_pool.containers_node_pool_disk_encryption_enabled
    title: 'AZURE KUBERNETES Agent_pool: Containers Node Pool Disk Encryption Enabled'
    severity: high
    for_each: azure.aks.agent_pools
    calls:
    - action: agent_pools.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
        agent_pool_name: '{{agent_pool_name}}'
      fields:
      - path: enable_encryption_at_host
        operator: equals
        expected: true
  - check_id: azure.kubernetes.agent_pool.containers_node_pool_nodes_no_public_ip
    title: 'AZURE KUBERNETES Agent_pool: Containers Node Pool Nodes No Public Ip'
    severity: critical
    for_each: azure.aks.agent_pools
    calls:
    - action: agent_pools.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
        agent_pool_name: '{{agent_pool_name}}'
      fields:
      - path: enable_node_public_ip
        operator: equals
        expected: false
  - check_id: azure.kubernetes.agent_pool.containers_node_pool_shielded_secure_boot_enabled
    title: 'AZURE KUBERNETES Agent_pool: Containers Node Pool Shielded Secure Boot Enabled'
    severity: low
    for_each: azure.aks.agent_pools
    calls:
    - action: agent_pools.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
        agent_pool_name: '{{agent_pool_name}}'
      fields:
      - path: security_profile.enable_secure_boot
        operator: equals
        expected: true
  - check_id: azure.kubernetes.agent_pool.containers_node_pool_workload_identity_enabled
    title: 'AZURE KUBERNETES Agent_pool: Containers Node Pool Workload Identity Enabled'
    severity: low
    for_each: azure.aks.agent_pools
    calls:
    - action: agent_pools.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
        agent_pool_name: '{{agent_pool_name}}'
      fields:
      - path: workload_runtime
        operator: equals
        expected: WasmWasi
  - check_id: azure.kubernetes.api_server.containers_apiserver_anonymous_auth_disabled
    title: 'AZURE KUBERNETES Api_server: Containers Apiserver Anonymous Auth Disabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: api_server_access_profile.enable_private_cluster
        operator: equals
        expected: true
  - check_id: azure.kubernetes.api_server.containers_apiserver_audit_logging_enabled
    title: 'AZURE KUBERNETES Api_server: Containers Apiserver Audit Logging Enabled'
    severity: medium
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: addon_profiles.oms_agent.enabled
        operator: equals
        expected: true
  - check_id: azure.kubernetes.api_server.containers_apiserver_authorization_mode_rbac
    title: 'AZURE KUBERNETES Api_server: Containers Apiserver Authorization Mode RBAC'
    severity: medium
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: enable_rbac
        operator: equals
        expected: true
  - check_id: azure.kubernetes.api_server.containers_apiserver_etcd_connection_encrypted
    title: 'AZURE KUBERNETES Api_server: Containers Apiserver Etcd Connection Encrypted'
    severity: medium
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: security_profile.defender.security_monitoring.enabled
        operator: equals
        expected: true
  - check_id: azure.kubernetes.api_server.containers_apiserver_insecure_port_disabled
    title: 'AZURE KUBERNETES Api_server: Containers Apiserver Insecure Port Disabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: api_server_access_profile.enable_private_cluster
        operator: equals
        expected: true
  - check_id: azure.kubernetes.api_server.containers_apiserver_tls_min_1_2_enforced
    title: 'AZURE KUBERNETES Api_server: Containers Apiserver TLS Min 1 2 Enforced'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: security_profile.workload_identity.enabled
        operator: equals
        expected: true
  - check_id: azure.kubernetes.api_server.k8s_apiserver_admission_psa_enforce_mode
    title: 'AZURE KUBERNETES Api_server: K8s Apiserver Admission Psa Enforce Mode'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: pod_security_profile.enforce_level
        operator: equals
        expected: restricted
  - check_id: azure.kubernetes.api_server.k8s_apiserver_anonymous_auth_disabled
    title: 'AZURE KUBERNETES Api_server: K8s Apiserver Anonymous Auth Disabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: aad_profile.managed
        operator: equals
        expected: true
  - check_id: azure.kubernetes.api_server.k8s_apiserver_audit_logging_enabled
    title: 'AZURE KUBERNETES Api_server: K8s Apiserver Audit Logging Enabled'
    severity: medium
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: addon_profiles.omsagent.enabled
        operator: equals
        expected: true
  - check_id: azure.kubernetes.api_server.k8s_apiserver_tls_min_version_1_2
    title: 'AZURE KUBERNETES Api_server: K8s Apiserver TLS Min Version 1 2'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: http_proxy_config.trusted_ca
        operator: not_empty
        expected: true
  - check_id: azure.kubernetes.controller_manager.containers_root_ca_file_configured
    title: 'AZURE KUBERNETES Controller_manager: Containers Root Ca File Configured'
    severity: critical
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: http_proxy_config.trusted_ca
        operator: not_empty
        expected: true
  - check_id: azure.kubernetes.controller_manager.containers_use_service_account_credentials_enabled
    title: 'AZURE KUBERNETES Controller_manager: Containers Use Service Account Credentials Enabled'
    severity: high
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: service_principal_profile.client_id
        operator: not_equals
        expected: msi
  - check_id: azure.kubernetes.controller_manager.k8s_controllermanager_secure_port_enabled
    title: 'AZURE KUBERNETES Controller_manager: K8s Controllermanager Secure Port Enabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: api_server_access_profile.enable_private_cluster
        operator: equals
        expected: true
  - check_id: azure.kubernetes.controller_manager.k8s_controllermanager_service_account_token_signing_enabled
    title: 'AZURE KUBERNETES Controller_manager: K8s Controllermanager Service Account Token Signing Enabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: oidc_issuer_profile.enabled
        operator: equals
        expected: true
  - check_id: azure.kubernetes.deployment.containers_workload_drop_net_raw_and_reduce_caps
    title: 'AZURE KUBERNETES Deployment: Containers Workload Drop Net Raw And Reduce Caps'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: security_profile.defender.security_monitoring.enabled
        operator: equals
        expected: true
  - check_id: azure.kubernetes.deployment.containers_workload_env_no_plaintext_secrets
    title: 'AZURE KUBERNETES Deployment: Containers Workload Env No Plaintext Secrets'
    severity: high
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: addon_profiles.azure_keyvault_secrets_provider.enabled
        operator: equals
        expected: true
  - check_id: azure.kubernetes.deployment.containers_workload_image_tag_not_latest
    title: 'AZURE KUBERNETES Deployment: Containers Workload Image Tag Not Latest'
    severity: low
    for_each: azure.aks.deployments
    calls:
    - action: kubernetes_api.get_deployment
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
        namespace: '{{namespace}}'
        name: '{{deployment_name}}'
      fields:
      - path: spec.template.spec.containers[*].image
        operator: not_contains
        expected: :latest
  - check_id: azure.kubernetes.deployment.containers_workload_no_hostpath_mounts
    title: 'AZURE KUBERNETES Deployment: Containers Workload No Hostpath Mounts'
    severity: low
    for_each: azure.aks.deployments
    calls:
    - action: kubernetes_api.get_deployment
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
        namespace: '{{namespace}}'
        name: '{{deployment_name}}'
      fields:
      - path: spec.template.spec.volumes[*].host_path
        operator: not_exists
        expected: null
  - check_id: azure.kubernetes.deployment.containers_workload_no_privileged_containers
    title: 'AZURE KUBERNETES Deployment: Containers Workload No Privileged Containers'
    severity: high
    for_each: azure.aks.deployments
    calls:
    - action: managed_clusters.get_kubernetes_deployment
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
        namespace: '{{namespace}}'
        deployment_name: '{{deployment_name}}'
      fields:
      - path: spec.template.spec.containers[*].security_context.privileged
        operator: not_equals
        expected: true
  - check_id: azure.kubernetes.deployment.containers_workload_read_only_root_filesystem
    title: 'AZURE KUBERNETES Deployment: Containers Workload Read Only Root Filesystem'
    severity: critical
    for_each: azure.aks.deployments
    calls:
    - action: managed_clusters.get_kubernetes_deployment
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
        namespace: '{{namespace}}'
        deployment_name: '{{deployment_name}}'
      fields:
      - path: spec.template.spec.containers[*].security_context.read_only_root_filesystem
        operator: equals
        expected: true
  - check_id: azure.kubernetes.deployment.containers_workload_run_as_non_root
    title: 'AZURE KUBERNETES Deployment: Containers Workload Run As Non Root'
    severity: critical
    for_each: azure.aks.deployments
    calls:
    - action: managed_clusters.get_kubernetes_deployment
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
        namespace: '{{namespace}}'
        deployment_name: '{{deployment_name}}'
      fields:
      - path: spec.template.spec.security_context.run_as_non_root
        operator: equals
        expected: true
  - check_id: azure.kubernetes.deployment.containers_workload_seccomp_profile_runtime_default
    title: 'AZURE KUBERNETES Deployment: Containers Workload Seccomp Profile Runtime Default'
    severity: low
    for_each: azure.aks.deployments
    calls:
    - action: managed_clusters.get_kubernetes_deployment
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
        namespace: '{{namespace}}'
        deployment_name: '{{deployment_name}}'
      fields:
      - path: spec.template.spec.security_context.seccomp_profile.type
        operator: equals
        expected: RuntimeDefault
  - check_id: azure.kubernetes.etcd.containers_auth_enabled
    title: 'AZURE KUBERNETES Etcd: Containers Auth Enabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: addon_profiles.etcd.config.auth_enabled
        operator: equals
        expected: 'true'
  - check_id: azure.kubernetes.etcd.containers_client_tls_enabled
    title: 'AZURE KUBERNETES Etcd: Containers Client TLS Enabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: addon_profiles.etcd.config.client_cert_auth
        operator: equals
        expected: 'true'
  - check_id: azure.kubernetes.etcd.containers_encryption_at_rest_enabled
    title: 'AZURE KUBERNETES Etcd: Containers Encryption At Rest Enabled'
    severity: high
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: disk_encryption_set_id
        operator: exists
        expected: true
  - check_id: azure.kubernetes.etcd.containers_peer_tls_enabled
    title: 'AZURE KUBERNETES Etcd: Containers Peer TLS Enabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: addon_profiles.etcd.config.peer_client_cert_auth
        operator: equals
        expected: 'true'
  - check_id: azure.kubernetes.etcd.k8s_client_cert_auth_enabled
    title: 'AZURE KUBERNETES Etcd: K8s Client Cert Auth Enabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: api_server_access_profile.enable_private_cluster
        operator: equals
        expected: true
  - check_id: azure.kubernetes.etcd.k8s_encryption_at_rest_enabled
    title: 'AZURE KUBERNETES Etcd: K8s Encryption At Rest Enabled'
    severity: high
    for_each: azure.aks.clusters
    calls:
    - action: self
      fields:
      - path: encryption_at_host
        operator: equals
        expected: true
  - check_id: azure.kubernetes.kubelet.containers_anonymous_auth_disabled
    title: 'AZURE KUBERNETES Kubelet: Containers Anonymous Auth Disabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: agent_pool_profiles[*].kubelet_config.anonymous_auth
        operator: equals
        expected: false
  - check_id: azure.kubernetes.kubelet.containers_authz_webhook_or_rbac_enabled
    title: 'AZURE KUBERNETES Kubelet: Containers Authz Webhook Or RBAC Enabled'
    severity: medium
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: enable_rbac
        operator: equals
        expected: true
  - check_id: azure.kubernetes.kubelet.containers_read_only_port_disabled
    title: 'AZURE KUBERNETES Kubelet: Containers Read Only Port Disabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: agent_pool_profiles[*].kubelet_config.read_only_port
        operator: equals
        expected: 0
  - check_id: azure.kubernetes.kubelet.containers_tls_min_1_2_enforced
    title: 'AZURE KUBERNETES Kubelet: Containers TLS Min 1 2 Enforced'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: agent_pool_profiles[*].kubelet_config.tls_min_version
        operator: greater_than_or_equal
        expected: '1.2'
  - check_id: azure.kubernetes.kubelet.k8s_anonymous_auth_disabled
    title: 'AZURE KUBERNETES Kubelet: K8s Anonymous Auth Disabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: api_server_access_profile.disable_run_command
        operator: equals
        expected: true
  - check_id: azure.kubernetes.kubelet.k8s_client_cert_rotation_enabled
    title: 'AZURE KUBERNETES Kubelet: K8s Client Cert Rotation Enabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: agent_pool_profiles[*].kubelet_config.rotate_certificates
        operator: equals
        expected: true
  - check_id: azure.kubernetes.kubelet.k8s_protect_kernel_defaults_enabled
    title: 'AZURE KUBERNETES Kubelet: K8s Protect Kernel Defaults Enabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: agent_pool_profiles[*].kubelet_config.protect_kernel_defaults
        operator: equals
        expected: true
  - check_id: azure.kubernetes.kubelet.k8s_read_only_port_disabled
    title: 'AZURE KUBERNETES Kubelet: K8s Read Only Port Disabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{cluster_name}}'
      fields:
      - path: agent_pool_profiles[*].kubelet_config.read_only_port
        operator: equals
        expected: 0
  - check_id: azure.kubernetes.managed_cluster.containers_cluster_audit_logging_enabled
    title: 'AZURE KUBERNETES Managed_cluster: Containers Cluster Audit Logging Enabled'
    severity: medium
    for_each: azure.aks.managed_clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: addon_profiles.omsagent.enabled
        operator: equals
        expected: true
      - path: addon_profiles.omsagent.config.log_analytics_workspace_resource_id
        operator: exists
        expected: true
  - check_id: azure.kubernetes.managed_cluster.containers_cluster_default_service_account_automount_disabled
    title: 'AZURE KUBERNETES Managed_cluster: Containers Cluster Default Service Account Automount Disabled'
    severity: low
    for_each: azure.aks.managed_clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: security_profile.workload_identity.enabled
        operator: equals
        expected: true
      - path: oidc_issuer_profile.enabled
        operator: equals
        expected: true
  - check_id: azure.kubernetes.managed_cluster.containers_cluster_private_control_plane_endpoint_enabled
    title: 'AZURE KUBERNETES Managed_cluster: Containers Cluster Private Control Plane Endpoint Enabled'
    severity: low
    for_each: azure.aks.managed_clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: api_server_access_profile.enable_private_cluster
        operator: equals
        expected: true
  - check_id: azure.kubernetes.managed_cluster.containers_cluster_secrets_encryption_kms_enabled
    title: 'AZURE KUBERNETES Managed_cluster: Containers Cluster Secrets Encryption KMS Enabled'
    severity: high
    for_each: azure.aks.managed_clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: security_profile.azure_key_vault_kms.enabled
        operator: equals
        expected: true
      - path: security_profile.azure_key_vault_kms.key_id
        operator: exists
        expected: true
  - check_id: azure.kubernetes.managed_cluster.containers_cluster_service_dns_and_metrics_from_approved_sources
    title: 'AZURE KUBERNETES Managed_cluster: Containers Cluster Service Dns And Metrics From Approved Sources'
    severity: low
    for_each: azure.aks.managed_clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: network_profile.dns_service_ip
        operator: matches
        expected: ^10\.|^172\.(1[6-9]|2[0-9]|3[0-1])\.|^192\.168\.
      - path: network_profile.service_cidr
        operator: matches
        expected: ^10\.|^172\.(1[6-9]|2[0-9]|3[0-1])\.|^192\.168\.
  - check_id: azure.kubernetes.managed_cluster.containers_cluster_service_kube_system_services_not_public
    title: 'AZURE KUBERNETES Managed_cluster: Containers Cluster Service Kube System Services Not Public'
    severity: critical
    for_each: azure.aks.managed_clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: api_server_access_profile.authorized_ip_ranges
        operator: not_empty
        expected: true
      - path: api_server_access_profile.enable_private_cluster
        operator: equals
        expected: true
  - check_id: azure.kubernetes.managed_cluster.containers_fargate_profile_execution_role_least_privilege
    title: 'AZURE KUBERNETES Managed_cluster: Containers Fargate Profile Execution Role Least Privilege'
    severity: high
    for_each: azure.aks.managed_clusters
    calls:
    - action: self
      fields:
      - path: agent_pool_profiles[*].mode
        operator: not_equals
        expected: System
      - path: identity_profile.kubeletidentity.resource_id
        operator: exists
        expected: true
  - check_id: azure.kubernetes.managed_cluster.containers_fargate_profile_logging_enabled
    title: 'AZURE KUBERNETES Managed_cluster: Containers Fargate Profile Logging Enabled'
    severity: medium
    for_each: azure.aks.managed_clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: addon_profiles.omsagent.enabled
        operator: equals
        expected: true
      - path: agent_pool_profiles[*].enable_node_public_ip
        operator: equals
        expected: false
  - check_id: azure.kubernetes.managed_cluster.containers_fargate_profile_private_subnets_only
    title: 'AZURE KUBERNETES Managed_cluster: Containers Fargate Profile Private Subnets Only'
    severity: low
    for_each: azure.aks.managed_clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: agent_pool_profiles[*].enable_node_public_ip
        operator: equals
        expected: false
      - path: agent_pool_profiles[*].vnet_subnet_id
        operator: exists
        expected: true
  - check_id: azure.kubernetes.namespace.containers_default_service_account_automount_disabled
    title: 'AZURE KUBERNETES Namespace: Containers Default Service Account Automount Disabled'
    severity: low
    for_each: azure.aks.namespaces
    calls:
    - action: kubernetes_api.get
      params:
        path: /api/v1/namespaces/{{namespace_name}}/serviceaccounts/default
      fields:
      - path: automount_service_account_token
        operator: equals
        expected: false
  - check_id: azure.kubernetes.namespace.containers_network_policies_present
    title: 'AZURE KUBERNETES Namespace: Containers Network Policies Present'
    severity: medium
    for_each: azure.aks.namespaces
    calls:
    - action: kubernetes_api.get
      params:
        path: /apis/networking.k8s.io/v1/namespaces/{{namespace_name}}/networkpolicies
      fields:
      - path: items
        operator: not_empty
        expected: true
  - check_id: azure.kubernetes.namespace.containers_pod_security_level_restricted
    title: 'AZURE KUBERNETES Namespace: Containers Pod Security Level Restricted'
    severity: low
    for_each: azure.aks.namespaces
    calls:
    - action: kubernetes_api.get
      params:
        path: /api/v1/namespaces/{{namespace_name}}
      fields:
      - path: metadata.labels["pod-security.kubernetes.io/enforce"]
        operator: equals
        expected: restricted
      - path: metadata.labels["pod-security.kubernetes.io/audit"]
        operator: equals
        expected: restricted
  - check_id: azure.kubernetes.network_policy.containers_networkpolicy_default_deny_egress_per_namespace
    title: 'AZURE KUBERNETES Network_policy: Containers Networkpolicy Default Deny Egress Per Namespace'
    severity: medium
    for_each: azure.aks.network_policies
    calls:
    - action: kubernetes_client.list_namespaced_network_policy
      params:
        namespace: '{{namespace_name}}'
      fields:
      - path: items[?(@.spec.policy_types[*] == 'Egress' && @.spec.pod_selector == {})]
        operator: exists
        expected: true
  - check_id: azure.kubernetes.network_policy.containers_networkpolicy_default_deny_ingress_per_namespace
    title: 'AZURE KUBERNETES Network_policy: Containers Networkpolicy Default Deny Ingress Per Namespace'
    severity: medium
    for_each: azure.aks.network_policies
    calls:
    - action: kubernetes_client.list_namespaced_network_policy
      params:
        namespace: '{{namespace_name}}'
      fields:
      - path: items[?(@.spec.policy_types[*] == 'Ingress' && @.spec.pod_selector == {})]
        operator: exists
        expected: true
  - check_id: azure.kubernetes.network_policy.containers_networkpolicy_required_allowlist_for_namespace_services
    title: 'AZURE KUBERNETES Network_policy: Containers Networkpolicy Required Allowlist For Namespace Services'
    severity: medium
    for_each: azure.aks.network_policies
    calls:
    - action: kubernetes_client.read_namespaced_network_policy
      params:
        name: '{{policy_name}}'
        namespace: '{{namespace_name}}'
      fields:
      - path: spec.ingress[*].from
        operator: exists
        expected: true
      - path: spec.egress[*].to
        operator: exists
        expected: true
  - check_id: azure.kubernetes.rbac.containers_authorization_mode_rbac_enabled
    title: 'AZURE KUBERNETES Rbac: Containers Authorization Mode RBAC Enabled'
    severity: medium
    for_each: azure.aks.managed_clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: enable_rbac
        operator: equals
        expected: true
      - path: aad_profile.enable_azure_rbac
        operator: equals
        expected: true
  - check_id: azure.kubernetes.rbac.containers_no_cluster_admin_bindings_to_users
    title: 'AZURE KUBERNETES Rbac: Containers No Cluster Admin Bindings To Users'
    severity: critical
    for_each: azure.aks.rbac_bindings
    calls:
    - action: kubernetes_client.list_cluster_role_binding
      params: {}
      fields:
      - path: items[?(@.role_ref.name == 'cluster-admin')].subjects[?(@.kind == 'User')]
        operator: empty
        expected: true
  - check_id: azure.kubernetes.rbac.containers_no_wildcard_rules_in_clusterroles
    title: 'AZURE KUBERNETES Rbac: Containers No Wildcard Rules In Clusterroles'
    severity: low
    for_each: azure.aks.rbac_roles
    calls:
    - action: kubernetes_client.list_cluster_role
      params: {}
      fields:
      - path: items[*].rules[?(@.resources[*] == '*' || @.verbs[*] == '*')]
        operator: empty
        expected: true
  - check_id: azure.kubernetes.rbac.containers_subjects_scoped_to_namespaces
    title: 'AZURE KUBERNETES Rbac: Containers Subjects Scoped To Namespaces'
    severity: low
    for_each: azure.aks.rbac_bindings
    calls:
    - action: kubernetes_client.list_namespaced_role_binding
      params:
        namespace: '{{namespace_name}}'
      fields:
      - path: items[*].subjects[*].namespace
        operator: exists
        expected: true
  - check_id: azure.kubernetes.rbac.k8s_default_sa_not_cluster_admin
    title: 'AZURE KUBERNETES Rbac: K8s Default Sa Not Cluster Admin'
    severity: critical
    for_each: azure.aks.rbac_bindings
    calls:
    - action: kubernetes_client.list_cluster_role_binding
      params: {}
      fields:
      - path: items[?(@.role_ref.name == 'cluster-admin')].subjects[?(@.kind == 'ServiceAccount' && @.name == 'default')]
        operator: empty
        expected: true
  - check_id: azure.kubernetes.rbac.k8s_no_cluster_admin_to_authenticated
    title: 'AZURE KUBERNETES Rbac: K8s No Cluster Admin To Authenticated'
    severity: critical
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: aad_profile.enable_azure_rbac
        operator: equals
        expected: true
      - path: enable_rbac
        operator: equals
        expected: true
  - check_id: azure.kubernetes.rbac.k8s_wildcard_verbs_disallowed
    title: 'AZURE KUBERNETES Rbac: K8s Wildcard Verbs Disallowed'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{resource_name}}'
      fields:
      - path: enable_rbac
        operator: equals
        expected: true
      - path: aad_profile.admin_group_object_ids
        operator: not_empty
        expected: true
  - check_id: azure.kubernetes.scheduler.containers_authentication_kubeconfig_configured
    title: 'AZURE KUBERNETES Scheduler: Containers Authentication Kubeconfig Configured'
    severity: high
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: aad_profile.managed
        operator: equals
        expected: true
      - path: service_principal_profile.client_id
        operator: not_equals
        expected: msi
  - check_id: azure.kubernetes.scheduler.containers_authorization_kubeconfig_configured
    title: 'AZURE KUBERNETES Scheduler: Containers Authorization Kubeconfig Configured'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: enable_rbac
        operator: equals
        expected: true
      - path: aad_profile.enable_azure_rbac
        operator: equals
        expected: true
  - check_id: azure.kubernetes.scheduler.containers_secure_port_tls_enabled
    title: 'AZURE KUBERNETES Scheduler: Containers Secure Port TLS Enabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: api_server_access_profile.enable_private_cluster
        operator: equals
        expected: true
      - path: network_profile.network_plugin
        operator: not_equals
        expected: none
  - check_id: azure.kubernetes.scheduler.k8s_leader_election_enabled
    title: 'AZURE KUBERNETES Scheduler: K8s Leader Election Enabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: agent_pool_profiles[0].count
        operator: greater_than
        expected: 1
      - path: agent_pool_profiles[0].mode
        operator: equals
        expected: System
  - check_id: azure.kubernetes.scheduler.k8s_profiling_disabled
    title: 'AZURE KUBERNETES Scheduler: K8s Profiling Disabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: addon_profiles.http_application_routing.enabled
        operator: equals
        expected: false
      - path: addon_profiles.kube_dashboard.enabled
        operator: equals
        expected: false
  - check_id: azure.kubernetes.scheduler.k8s_secure_port_enabled
    title: 'AZURE KUBERNETES Scheduler: K8s Secure Port Enabled'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: api_server_access_profile.authorized_ip_ranges
        operator: not_empty
        expected: true
      - path: network_profile.load_balancer_sku
        operator: equals
        expected: Standard
  - check_id: azure.kubernetes.service.containers_external_ips_not_used
    title: 'AZURE KUBERNETES Service: Containers External Ips Not Used'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: network_profile.service_cidr
        operator: not_empty
        expected: true
      - path: api_server_access_profile.enable_private_cluster
        operator: equals
        expected: true
  - check_id: azure.kubernetes.service.containers_nodeport_usage_restricted
    title: 'AZURE KUBERNETES Service: Containers Nodeport Usage Restricted'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: network_profile.network_policy
        operator: not_equals
        expected: null
      - path: api_server_access_profile.authorized_ip_ranges
        operator: not_empty
        expected: true
  - check_id: azure.kubernetes.service.containers_type_loadbalancer_internal_only_where_required
    title: 'AZURE KUBERNETES Service: Containers Type Loadbalancer Internal Only Where Required'
    severity: low
    for_each: azure.aks.clusters
    calls:
    - action: managed_clusters.get
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
      fields:
      - path: network_profile.load_balancer_profile.managed_outbound_i_ps.count
        operator: less_than_or_equal
        expected: 1
      - path: api_server_access_profile.enable_private_cluster
        operator: equals
        expected: true


# ============================================================================
# VALIDATION TRACKING
# ============================================================================
# STATUS:  VALIDATED
# VALIDATED_BY: Cursor AI
# VALIDATED_DATE: 2025-12-05
# 
# FIXES APPLIED:
# - Changed package to sdk_package: azure.mgmt.containerservice (dot format)
# - Added api_type: management
# - Removed client: and save_as fields from discovery calls
# - Added fields: __self__ to discovery calls
#
# TEST RESULTS:
# - Engine Status:  NO ERRORS
# - API Connection:  SUCCESS
# - Resources Discovered: 0 (no AKS clusters in subscription - expected)
# - Checks Executed: 0 (no resources to check)
#
# NOTES:
# - Engine successfully connects to Azure and makes API calls
# - All discovery actions correctly formatted
# - Empty inventory is expected if no AKS resources exist
# ============================================================================
