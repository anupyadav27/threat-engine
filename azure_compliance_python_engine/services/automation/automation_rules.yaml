version: '1.0'
provider: azure
service: automation
discovery:
- discovery_id: azure.automation.list
  calls:
  - action: list
    save_as: list_response
  emit:
    items_for: '{{ list_response.value }}'
    as: item
    item:
      name: '{{ item.name }}'
      id: '{{ item.id }}'
      update_configuration: '{{ item.update_configuration }}'
      frequency: '{{ item.frequency }}'
      start_time: '{{ item.start_time }}'
      creation_time: '{{ item.creation_time }}'
      last_modified_time: '{{ item.last_modified_time }}'
      provisioning_state: '{{ item.provisioning_state }}'
      next_run: '{{ item.next_run }}'
checks:
- rule_id: azure.automation.runbook.incident_execution_roles_least_privilege
  for_each: azure.automation.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.automation.patch.compliance
  for_each: azure.automation.list
  conditions:
    var: item.id
    op: exists
