iot:
  version: '1.0'
  provider: azure
  service: iot
  package: azure-mgmt-iothub
  client_class: IotHubClient
  scope: subscription
  discovery:
  - discovery_id: azure.iot.hubs
    calls:
    - client: iot
      action: iot_hub_resource.list_by_subscription
      save_as: hubs
  - discovery_id: azure.iot.security_solutions
    calls:
    - client: iot
      action: iot_security_solution.list_by_subscription
      save_as: security_solutions
  checks:
  - check_id: azure.iot.hub.defender.for.iot.status.check
    title: 'AZURE IOT Hub: Defender For IoT Status Check'
    severity: low
    for_each: azure.iot.hubs
    calls:
    - action: iot_hub_resource.get_security_settings
      params:
        resource_group_name: '{{resource_group}}'
        resource_name: '{{name}}'
        security_settings_name: default
      fields:
      - path: device_defender_enabled
        operator: equals
        expected: true
