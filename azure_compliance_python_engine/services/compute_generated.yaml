version: '1.0'
provider: azure
service: compute
discovery:
- discovery_id: azure.compute.list
  calls:
  - action: list
    save_as: list_response
  emit:
    items_for: '{{ list_response.value }}'
    as: item
    item:
      id: '{{ item.id }}'
      name: '{{ item.name }}'
      type: '{{ item.type }}'
      system_data: '{{ item.system_data }}'
      tags: '{{ item.tags }}'
      location: '{{ item.location }}'
      source: '{{ item.source }}'
      parameters: '{{ item.parameters }}'
      protected_parameters: '{{ item.protected_parameters }}'
      async_execution: '{{ item.async_execution }}'
      run_as_user: '{{ item.run_as_user }}'
      run_as_password: '{{ item.run_as_password }}'
      timeout_in_seconds: '{{ item.timeout_in_seconds }}'
      output_blob_uri: '{{ item.output_blob_uri }}'
      error_blob_uri: '{{ item.error_blob_uri }}'
      output_blob_managed_identity: '{{ item.output_blob_managed_identity }}'
      error_blob_managed_identity: '{{ item.error_blob_managed_identity }}'
      provisioning_state: '{{ item.provisioning_state }}'
      instance_view: '{{ item.instance_view }}'
      treat_failure_as_deployment_failure: '{{ item.treat_failure_as_deployment_failure
        }}'
checks:
- rule_id: azure.compute.virtual_machine.vm_imds_hardened
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.dedicated_host.instance_auto_placement_controlled
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.spot_virtual_machine.spot_instance_instance_profile_least_privilege
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.virtual_machine.vm_ssh_key_based_auth_required
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.securitygroup.allow.ingress.from.internet.to.all.ports,.azure.api.management.restapi.waf.acl.attached,.azure.load.balancer.waf.acl.attached
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.disk.cmk_cmek_configured
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.vm.security.extensions.check
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.vm.extensions.approved.check
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.virtual_machine.vm_ssh_password_auth_disabled
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.virtual_machine_template.launch_template_user_data_no_secrets
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.virtualmachines.managed.by.automation
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.vm.managed.by.ssm
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.image.vuln_scanned_no_critical
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.paas_lightsail_instance.paas_instance_no_public_ip_unless_required
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.virtual_machine.vm_no_public_ip_assigned
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.ssh_public_key.key_pair_max_age_days
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.networkacl.allow.ingress.tcp.port.22,.azure.compute.securitygroup.allow.ingress.from.internet.to.all.ports,.azure.compute.networkacl.allow.ingress.tcp.port.3389,.azure.machine.learning.notebook.instance.without.direct.internet.access.configured
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.instance.older_than_specific_days
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.virtual_machine_template.launch_template_security_groups_restrictive
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.vm.instance.managed.by.ssm
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.virtual_machine_template.launch_template_imds_hardened
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.image.approved_image_allowlist_enforced
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.image.image_signed_and_verified
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.vmss.configured
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.instance.profile_attached
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.vm.ssm.managed
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.vm.managed.by.automation
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.vm.unrestricted_ingress
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.disk.in_use
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.vm.managed.disks.compliance.check
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.virtual_machine_scale_set.instance_group_instance_profile_least_privilege
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.ssh_public_key.key_pair_disable_unused_keys
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.disk.snapshots_not_public
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.vm.disk.data.access.auth.mode.check
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.virtual_machine_scale_set.instance_group_no_public_ip_assigned
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.vm.disk.network.access.policy.check
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.vm.unrestricted_network_ingress
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.virtual_machine.vm_serial_console_access_restricted
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.spot_virtual_machine.spot_instance_uses_approved_launch_template
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.paas_lightsail_instance.paas_instance_ssh_password_auth_disabled
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.image.not_publicly_shared
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.vm.automation_compliance
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.dedicated_host.host_sharing_restricted
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.virtual_machine_template.launch_template_instance_profile_least_privilege
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.virtual_machine.vm_security_group_inbound_restricted
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.vm.elastic.ip.unassigned
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.spot_virtual_machine.spot_instance_no_public_ip_assigned
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.vm.trusted.launch.secure.boot.vtpm.check
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.vm.stopped_instance
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.vm.patch_compliance
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.virtual_machine_scale_set.instance_group_uses_approved_launch_template
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.virtual_machine.vm_user_data_no_secrets
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.compute.virtual_machine_template.launch_template_no_public_ip_default
  for_each: azure.compute.list
  conditions:
    var: item.id
    op: exists
