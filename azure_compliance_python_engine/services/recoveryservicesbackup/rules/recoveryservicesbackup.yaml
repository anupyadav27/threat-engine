version: '1.0'
provider: azure
service: recoveryservicesbackup
discovery:
- discovery_id: azure.backup.list
  calls:
  - action: list
    save_as: list_response
  emit:
    items_for: '{{ list_response.value }}'
    as: item
    item:
      name: '{{ item.name }}'
      display: '{{ item.display }}'
      origin: '{{ item.origin }}'
      properties: '{{ item.properties }}'
- discovery_id: azure.dataprotection.list
  calls:
  - action: list
    save_as: list_response
  emit:
    items_for: '{{ list_response.value }}'
    as: item
    item:
      name: '{{ item.name }}'
      display: '{{ item.display }}'
      origin: '{{ item.origin }}'
      properties: '{{ item.properties }}'
checks:
- rule_id: azure.backup.policy.dr_immutable_or_worm_enabled_where_supported
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: contains
    value: dr_immutable_or_worm_enabled
- rule_id: azure.backup.recovery.services.vault.soft.delete.settings
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.policy.min_retention_configured
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.protected_item.resilience_dr_source_min_telemtry_required_no_pii
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.job.monitoring_alert_rules_for_failures_configured
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.policy.access_backup_vault_rbac_least_privilege
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.recovery.point_encrypted
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: contains
    value: encrypted
- rule_id: azure.backup.backup_job.resilience_network_private_only
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: contains
    value: resilience_network_private_only
- rule_id: azure.backup.policy.resilience_recovery_coverage_unprotected_assets_alerting_enabled
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.policy.access_no_public_access_to_backup_vault
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.job.monitoring_metrics_export_enabled
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.recovery_plan.resilience_storage_encrypted_and_private
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.recoveryservices.vault.cross.subscription.restore.disabled
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: contains
    value: crossSubscriptionRestoreDisabled
- rule_id: azure.backup.recovery_point.resilience_recovery_instance_security_groups_restrictive
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.policy.access_backup_keys_access_least_privilege
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.recoveryservices.vault.encryption.at.rest.cmk.enabled
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: contains
    value: encryption
- rule_id: azure.backup.vault.encryption_backup_storage_immutability_enabled
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: contains
    value: encryption_backup_storage_immutability
- rule_id: azure.backup.recovery.services.vault.public.network.access.disabled
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: contains
    value: Disabled
- rule_id: azure.backup.vault.immutability.locked
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.recovery_point.resilience_recovery_instance_volumes_encrypted
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.policy.resilience_recovery_health_last_backup_recency_within_days
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.policy.dr_encrypted_at_rest_cmek
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.job.monitoring_alert_rules_for_sla_breach_configured
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.backup_job.resilience_roles_least_privilege
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.recovery.point_retention_configured
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.policy.dr_schedule_defined_min_frequency
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.vault.cross.region.restore.check
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.protected_item.resilience_dr_source_agent_to_service_tls_required
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: contains
    value: tls_required
- rule_id: azure.backup.vault.encryption_cmk_cmek_key_configured
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.vault.encryption_encryption_in_transit_tls_min_1_2
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: contains
    value: TLS1_2
- rule_id: azure.backup.vault.encryption_enabled
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: contains
    value: encryption
- rule_id: azure.backup.recovery_plan.resilience_approvals_required_for_changes
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.policy.resilience_recovery_coverage_assignment_complete
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.vault.cross.subscription.restore.check
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: exists
- rule_id: azure.backup.policy.configured
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.backup_job.resilience_logs_enabled
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.policy.resilience_recovery_health_job_success_rate_minimum
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.recovery_plan.resilience_change_audit_logging_enabled
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.policy.resilience_recovery_health_failed_jobs_alerting_enabled
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.job.monitoring_alert_destinations_configured
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.policy.dr_destination_private_only
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: contains
    value: dr_destination_private_only
- rule_id: azure.backup.recovery_point.resilience_recovery_instance_private_network_only
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.vault.soft_delete_enabled
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: contains
    value: softDelete
- rule_id: azure.backup.vault.enabled_for_vms
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.policy.access_backup_admins_mfa_required
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: contains
    value: mfa_required
- rule_id: azure.backup.protected_item.resilience_dr_source_encryption_at_rest_cmek_where_supported
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.recovery.services.vault.infrastructure.encryption.enabled.check
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: contains
    value: infrastructureEncryptionEnabled
- rule_id: azure.backup.vault.encryption_key_rotation_enabled
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: contains
    value: encryptionKeyRotation
- rule_id: azure.backup.vault.encryption_encryption_at_rest_enabled
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: contains
    value: encryption
- rule_id: azure.backup.policy.resilience_recovery_inventory_resource_discovery_synced
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.backup.vault.encryption_key_policy_least_privilege
  for_each: azure.backup.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.dataprotection.backup.vault.immutability.check
  for_each: azure.dataprotection.list
  conditions:
    var: item.properties
    op: not_empty
- rule_id: azure.dataprotection.backup.vault.cross.region.restore.enabled
  for_each: azure.dataprotection.list
  conditions:
    var: item.properties
    op: contains
    value: crossRegionRestoreEnabled
- rule_id: azure.dataprotection.backupvault.infrastructure.encryption.enabled
  for_each: azure.dataprotection.list
  conditions:
    var: item.properties
    op: contains
    value: infrastructureEncryption
- rule_id: azure.dataprotection.backup.vault.encryption.cmk.enabled
  for_each: azure.dataprotection.list
  conditions:
    var: item.properties
    op: contains
    value: cmk
- rule_id: azure.dataprotection.backup.vault.soft.delete.compliance.check
  for_each: azure.dataprotection.list
  conditions:
    var: item.properties
    op: not_empty
