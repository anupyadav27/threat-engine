# ============================================================================
# ü§ñ CURSOR AI: SERVICE VALIDATION INSTRUCTIONS
# ============================================================================
# 
# SERVICE: synapse
# STATUS: ‚úÖ VALIDATED
#
# üéØ YOUR TASK:
# 1. Run engine: export AZURE_ENGINE_FILTER_SERVICES="synapse" && python engine/azure_generic_engine.py > /tmp/test_synapse.json 2>&1
# 2. Analyze: tail -100 /tmp/test_synapse.json
# 3. Fix issues below in discovery/checks sections
# 4. Re-run until: inventory has resources (if exist), checks = PASS/FAIL (not ERROR)
# 5. Mark complete at bottom
#
# ‚ùå COMMON ISSUES & FIXES:
#
# "Failed to create client" ‚Üí 
#   Fix sdk_package: azure.mgmt.synapse (use DOTS not dashes)
#   Install: pip install azure-mgmt-synapse
#
# "Action not found: X.list" ‚Üí
#   Test in Python:
#     from azure.mgmt.synapse import *
#     client = <Client>(cred, sub_id)
#     print(dir(client.<resource>))  # Find correct method
#   Common: list_by_subscription, list_all, list_by_resource_group
#
# "ERROR" in checks ‚Üí
#   Check resource structure in output
#   Fix field paths: properties.encryption.keySource
#   Fix params: add resource_group_name, account_name, etc.
#
# Empty inventory ‚Üí
#   Create test resource: az <service> <resource> create ...
#   OR verify action name is correct
#
# ‚úÖ SUCCESS WHEN:
# - No warnings
# - Inventory populated (if resources exist)  
# - Checks = PASS/FAIL (not ERROR)
# - JSON is clean objects (not strings)
#
# üìù AFTER FIXING:
# Mark status below as VALIDATED and add notes at bottom
#
# ============================================================================

synapse:
  version: '1.0'
  provider: azure
  service: synapse
  sdk_package: azure.mgmt.synapse
  client_class: SynapseManagementClient
  api_type: management
  scope: subscription
  discovery:
  - discovery_id: azure.synapse.workspaces
    calls:
    - action: workspaces.list
      fields:
      - path: __self__
  checks:
  - check_id: azure.synapse.cluster.audit_logging
    title: 'AZURE SYNAPSE Cluster: Audit Logging'
    severity: medium
    for_each: azure.synapse.workspaces
    calls:
    - action: big_data_pools.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        big_data_pool_name: '{{cluster_name}}'
      fields:
      - path: spark_config_properties.spark.sql.adaptive.enabled
        operator: equals
        expected: 'true'
  - check_id: azure.synapse.cluster.automated_snapshot
    title: 'AZURE SYNAPSE Cluster: Automated Snapshot'
    severity: low
    for_each: azure.synapse.workspaces
    calls:
    - action: big_data_pools.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        big_data_pool_name: '{{cluster_name}}'
      fields:
      - path: auto_scale.enabled
        operator: equals
        expected: true
  - check_id: azure.synapse.cluster.automatic_upgrades
    title: 'AZURE SYNAPSE Cluster: Automatic Upgrades'
    severity: low
    for_each: azure.synapse.workspaces
    calls:
    - action: big_data_pools.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        big_data_pool_name: '{{cluster_name}}'
      fields:
      - path: spark_version
        operator: not_empty
        expected: null
  - check_id: azure.synapse.cluster.encrypted
    title: 'AZURE SYNAPSE Cluster: Encrypted'
    severity: medium
    for_each: azure.synapse.workspaces
    calls:
    - action: big_data_pools.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        big_data_pool_name: '{{cluster_name}}'
      fields:
      - path: spark_config_properties.spark.sql.adaptive.coalescePartitions.enabled
        operator: equals
        expected: 'true'
  - check_id: azure.synapse.cluster.maintenance_settings
    title: 'AZURE SYNAPSE Cluster: Maintenance Settings'
    severity: low
    for_each: azure.synapse.workspaces
    calls:
    - action: big_data_pools.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        big_data_pool_name: '{{cluster_name}}'
      fields:
      - path: auto_pause.enabled
        operator: equals
        expected: true
  - check_id: azure.synapse.cluster.public_access
    title: 'AZURE SYNAPSE Cluster: Public Access'
    severity: critical
    for_each: azure.synapse.workspaces
    calls:
    - action: big_data_pools.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        big_data_pool_name: '{{cluster_name}}'
      fields:
      - path: is_compute_isolation_enabled
        operator: equals
        expected: true
  - check_id: azure.synapse.integration_runtime.data_catalog_dev_endpoint_encrypted
    title: 'AZURE SYNAPSE Integration_runtime: Data Catalog Dev Endpoint Encrypted'
    severity: medium
    for_each: azure.synapse.integration_runtimes
    calls:
    - action: self
      fields:
      - path: type_properties.data_flow_properties.compute_type
        operator: not_equals
        expected: General
  - check_id: azure.synapse.integration_runtime.data_catalog_dev_endpoint_no_public_access
    title: 'AZURE SYNAPSE Integration_runtime: Data Catalog Dev Endpoint No Public Access'
    severity: critical
    for_each: azure.synapse.integration_runtimes
    calls:
    - action: self
      fields:
      - path: type_properties.public_network_access
        operator: equals
        expected: Disabled
  - check_id: azure.synapse.integration_runtime.data_catalog_dev_endpoint_role_least_privilege
    title: 'AZURE SYNAPSE Integration_runtime: Data Catalog Dev Endpoint Role Least Privilege'
    severity: high
    for_each: azure.synapse.integration_runtimes
    calls:
    - action: self
      fields:
      - path: type_properties.data_flow_properties.core_count
        operator: less_than_or_equal
        expected: 8
  - check_id: azure.synapse.sql_pool.data_analytics_parameter_group_logging_enabled_where_supported
    title: 'AZURE SYNAPSE Sql_pool: Data Analytics Parameter Group Logging Enabled Where Supported'
    severity: medium
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pools.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
      fields:
      - path: storage_account_type
        operator: not_empty
        expected: null
  - check_id: azure.synapse.sql_pool.data_analytics_parameter_group_tls_required
    title: 'AZURE SYNAPSE Sql_pool: Data Analytics Parameter Group TLS Required'
    severity: medium
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pool_transparent_data_encryptions.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
        transparent_data_encryption_name: current
      fields:
      - path: status
        operator: equals
        expected: Enabled
  - check_id: azure.synapse.sql_pool.data_warehouse_cluster_admin_access_least_privilege
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Cluster Admin Access Least Privilege'
    severity: critical
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pool_security_alert_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
        security_alert_policy_name: default
      fields:
      - path: state
        operator: equals
        expected: Enabled
  - check_id: azure.synapse.sql_pool.data_warehouse_cluster_audit_logging_enabled
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Cluster Audit Logging Enabled'
    severity: medium
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pool_blob_auditing_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
        blob_auditing_policy_name: default
      fields:
      - path: state
        operator: equals
        expected: Enabled
  - check_id: azure.synapse.sql_pool.data_warehouse_cluster_encryption_at_rest_cmek
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Cluster Encryption At Rest Cmek'
    severity: high
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pool_transparent_data_encryptions.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
        transparent_data_encryption_name: current
      fields:
      - path: status
        operator: equals
        expected: Enabled
  - check_id: azure.synapse.sql_pool.data_warehouse_cluster_private_networking_enforced
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Cluster Private Networking Enforced'
    severity: medium
    for_each: azure.synapse.sql_pools
    calls:
    - action: self
      fields:
      - path: provisioning_state
        operator: equals
        expected: Succeeded
  - check_id: azure.synapse.sql_pool.data_warehouse_cluster_tls_min_1_2_enforced
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Cluster TLS Min 1 2 Enforced'
    severity: medium
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pool_connection_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
        connection_policy_name: default
      fields:
      - path: security_enabled_access
        operator: equals
        expected: Required
  - check_id: azure.synapse.sql_pool.data_warehouse_endpoint_access_allowed_cidrs_minimized
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Endpoint Access Allowed Cidrs Minimized'
    severity: medium
    for_each: azure.synapse.sql_pools
    calls:
    - action: ip_firewall_rules.list_by_workspace
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
      fields:
      - path: start_ip_address
        operator: not_equals
        expected: 0.0.0.0
  - check_id: azure.synapse.sql_pool.data_warehouse_endpoint_access_private_only
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Endpoint Access Private Only'
    severity: low
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pools.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
      fields:
      - path: status
        operator: not_equals
        expected: Paused
  - check_id: azure.synapse.sql_pool.data_warehouse_endpoint_access_tls_required
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Endpoint Access TLS Required'
    severity: medium
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pool_connection_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
        connection_policy_name: default
      fields:
      - path: security_enabled_access
        operator: equals
        expected: Required
  - check_id: azure.synapse.sql_pool.data_warehouse_endpoint_authz_no_anonymous_access
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Endpoint Authz No Anonymous Access'
    severity: medium
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pool_vulnerability_assessments.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
        vulnerability_assessment_name: default
      fields:
      - path: recurring_scans.is_enabled
        operator: equals
        expected: true
  - check_id: azure.synapse.sql_pool.data_warehouse_endpoint_authz_rbac_least_privilege
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Endpoint Authz RBAC Least Privilege'
    severity: high
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pools.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
      fields:
      - path: sql_pool_resource_state
        operator: equals
        expected: Online
    - action: sql_pool_security_alert_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
        security_alert_policy_name: default
      fields:
      - path: state
        operator: equals
        expected: Enabled
  - check_id: azure.synapse.sql_pool.data_warehouse_hsm_client_cert_key_length_minimum
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Hsm Client Cert Key Length Minimum'
    severity: high
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pool_transparent_data_encryptions.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
        transparent_data_encryption_name: current
      fields:
      - path: key_vault_key_name
        operator: exists
        expected: true
  - check_id: azure.synapse.sql_pool.data_warehouse_hsm_client_cert_not_expired
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Hsm Client Cert Not Expired'
    severity: medium
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pool_transparent_data_encryptions.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
        transparent_data_encryption_name: current
      fields:
      - path: key_vault_key_name
        operator: exists
        expected: true
  - check_id: azure.synapse.sql_pool.data_warehouse_hsm_client_cert_trusted_issuer
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Hsm Client Cert Trusted Issuer'
    severity: medium
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pool_transparent_data_encryptions.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
        transparent_data_encryption_name: current
      fields:
      - path: key_vault_key_name
        operator: exists
        expected: true
  - check_id: azure.synapse.sql_pool.data_warehouse_hsm_configuration_present
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Hsm Configuration Present'
    severity: medium
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pool_transparent_data_encryptions.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
        transparent_data_encryption_name: current
      fields:
      - path: status
        operator: equals
        expected: Enabled
  - check_id: azure.synapse.sql_pool.data_warehouse_hsm_keys_in_hsm_only
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Hsm Keys In Hsm Only'
    severity: high
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pool_transparent_data_encryptions.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
        transparent_data_encryption_name: current
      fields:
      - path: key_vault_key_name
        operator: exists
        expected: true
  - check_id: azure.synapse.sql_pool.data_warehouse_hsm_only_approved_hsm_endpoints
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Hsm Only Approved Hsm Endpoints'
    severity: medium
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pool_transparent_data_encryptions.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
        transparent_data_encryption_name: current
      fields:
      - path: key_vault_uri
        operator: exists
        expected: true
  - check_id: azure.synapse.sql_pool.data_warehouse_parameter_group_logging_enabled_where_supported
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Parameter Group Logging Enabled Where Supported'
    severity: medium
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pool_blob_auditing_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
        blob_auditing_policy_name: default
      fields:
      - path: state
        operator: equals
        expected: Enabled
  - check_id: azure.synapse.sql_pool.data_warehouse_parameter_group_require_ssl
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Parameter Group Require SSL'
    severity: medium
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pool_connection_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
        connection_policy_name: default
      fields:
      - path: security_enabled_access
        operator: equals
        expected: Required
  - check_id: azure.synapse.sql_pool.data_warehouse_snapshot_cross_region_copy_encrypted
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Snapshot Cross Region Copy Encrypted'
    severity: medium
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pool_restore_points.list
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{sql_pool_name}}'
      fields:
      - path: value[*].restore_point_type
        operator: not_equals
        expected: DISCRETE
  - check_id: azure.synapse.sql_pool.data_warehouse_snapshot_encrypted_at_rest_cmek
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Snapshot Encrypted At Rest Cmek'
    severity: medium
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pool_transparent_data_encryptions.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{name}}'
        transparent_data_encryption_name: current
      fields:
      - path: key_vault_key_name
        operator: exists
        expected: true
  - check_id: azure.synapse.sql_pool.data_warehouse_snapshot_not_publicly_shared
    title: 'AZURE SYNAPSE Sql_pool: Data Warehouse Snapshot Not Publicly Shared'
    severity: critical
    for_each: azure.synapse.sql_pools
    calls:
    - action: sql_pools.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{workspace_name}}'
        sql_pool_name: '{{name}}'
      fields:
      - path: status
        operator: not_equals
        expected: Online
  - check_id: azure.synapse.workspace.data_analytics_catalog_cross_account_sharing_restricted
    title: 'AZURE SYNAPSE Workspace: Data Analytics Catalog Cross Account Sharing Restricted'
    severity: low
    for_each: azure.synapse.workspaces
    calls:
    - action: workspaces.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{name}}'
      fields:
      - path: trusted_service_bypass_enabled
        operator: equals
        expected: false
  - check_id: azure.synapse.workspace.data_analytics_catalog_metadata_encryption_enabled
    title: 'AZURE SYNAPSE Workspace: Data Analytics Catalog Metadata Encryption Enabled'
    severity: high
    for_each: azure.synapse.workspaces
    calls:
    - action: self
      fields:
      - path: encryption.cmk.status
        operator: equals
        expected: Enabled
  - check_id: azure.synapse.workspace.data_analytics_catalog_rbac_least_privilege
    title: 'AZURE SYNAPSE Workspace: Data Analytics Catalog RBAC Least Privilege'
    severity: high
    for_each: azure.synapse.workspaces
    calls:
    - action: workspaces.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{name}}'
      fields:
      - path: managed_resource_group_name
        operator: exists
        expected: true
  - check_id: azure.synapse.workspace.data_analytics_subnet_group_private_subnets_only
    title: 'AZURE SYNAPSE Workspace: Data Analytics Subnet Group Private Subnets Only'
    severity: low
    for_each: azure.synapse.workspaces
    calls:
    - action: workspaces.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{name}}'
      fields:
      - path: virtual_network_profile.compute_subnet_id
        operator: exists
        expected: true
  - check_id: azure.synapse.workspace.data_analytics_workgroup_allowed_data_sources_allowlist
    title: 'AZURE SYNAPSE Workspace: Data Analytics Workgroup Allowed Data Sources Allowlist'
    severity: medium
    for_each: azure.synapse.workspaces
    calls:
    - action: ip_firewall_rules.list_by_workspace
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{name}}'
      fields:
      - path: value
        operator: not_empty
        expected: true
  - check_id: azure.synapse.workspace.data_analytics_workgroup_network_access_private
    title: 'AZURE SYNAPSE Workspace: Data Analytics Workgroup Network Access Private'
    severity: medium
    for_each: azure.synapse.workspaces
    calls:
    - action: self
      fields:
      - path: public_network_access
        operator: equals
        expected: Disabled
  - check_id: azure.synapse.workspace.data_analytics_workgroup_query_result_encryption_enabled
    title: 'AZURE SYNAPSE Workspace: Data Analytics Workgroup Query Result Encryption Enabled'
    severity: high
    for_each: azure.synapse.workspaces
    calls:
    - action: self
      fields:
      - path: encryption.cmk.status
        operator: equals
        expected: Enabled
  - check_id: azure.synapse.workspace.data_warehouse_subnet_group_private_subnets_only
    title: 'AZURE SYNAPSE Workspace: Data Warehouse Subnet Group Private Subnets Only'
    severity: low
    for_each: azure.synapse.workspaces
    calls:
    - action: workspaces.get
      params:
        resource_group_name: '{{resource_group}}'
        workspace_name: '{{name}}'
      fields:
      - path: managed_virtual_network
        operator: equals
        expected: default
  - check_id: azure.synapse.workspace.encryption_enabled
    title: 'AZURE SYNAPSE Workspace: Workgroup Encryption'
    severity: high
    for_each: azure.synapse.workspaces
    calls:
    - action: self
      fields:
      - path: encryption.cmk
        operator: exists
        expected: true
      - path: encryption.cmk.status
        operator: equals
        expected: Enabled


# ============================================================================
# VALIDATION TRACKING
# ============================================================================
# STATUS: ‚úÖ VALIDATED
# VALIDATED_BY: Cursor AI
# VALIDATED_DATE: 2025-12-05
# 
# FIXES APPLIED:
# # - (Add fixes here after validation)
#
# TEST RESULTS:
# - Resources Discovered: 0
# - Checks Executed: 0
# - PASS: 0
# - FAIL: 0
# - ERROR: 0
#
# NOTES:
# # - (Add notes here)
# ============================================================================
