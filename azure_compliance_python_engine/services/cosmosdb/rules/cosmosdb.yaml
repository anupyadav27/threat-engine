version: '1.0'
provider: azure
service: cosmosdb
discovery:
- discovery_id: azure.cosmosdb.list
  calls:
  - action: list
    save_as: list_response
  emit:
    items_for: '{{ list_response.value }}'
    as: item
    item:
      id: '{{ item.id }}'
      name: '{{ item.name }}'
      type: '{{ item.type }}'
      location: '{{ item.location }}'
      tags: '{{ item.tags }}'
      kind: '{{ item.kind }}'
      identity: '{{ item.identity }}'
      system_data: '{{ item.system_data }}'
      provisioning_state: '{{ item.provisioning_state }}'
      document_endpoint: '{{ item.document_endpoint }}'
      database_account_offer_type: '{{ item.database_account_offer_type }}'
      ip_rules: '{{ item.ip_rules }}'
      is_virtual_network_filter_enabled: '{{ item.is_virtual_network_filter_enabled
        }}'
      enable_automatic_failover: '{{ item.enable_automatic_failover }}'
      consistency_policy: '{{ item.consistency_policy }}'
      capabilities: '{{ item.capabilities }}'
      write_locations: '{{ item.write_locations }}'
      read_locations: '{{ item.read_locations }}'
      locations: '{{ item.locations }}'
      failover_policies: '{{ item.failover_policies }}'
checks:
- rule_id: azure.cosmosdb.account.private.endpoint.approved
  for_each: azure.cosmosdb.list
  conditions:
    var: item.private_endpoint_connections
    op: not_empty
- rule_id: azure.cosmos.database.encryption_enabled
  for_each: azure.cosmosdb.list
  conditions:
    var: item.capabilities
    op: contains
    value: EnableEncryption
- rule_id: azure.cosmosdb.defender.status.check
  for_each: azure.cosmosdb.list
  conditions:
    var: item.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.cosmos.table.pitr_enabled
  for_each: azure.cosmosdb.list
  conditions:
    var: item.capabilities
    op: contains
    value: EnablePointInTimeRestore
- rule_id: azure.cosmos.table.kms_cmk_encryption_enabled
  for_each: azure.cosmosdb.list
  conditions:
    var: item.capabilities
    op: contains
    value: EnableTableKmsCmk
- rule_id: azure.cosmosdb.account.firewall_use_selected_networks
  for_each: azure.cosmosdb.list
  conditions:
    var: item.is_virtual_network_filter_enabled
    op: equals
    value: true
- rule_id: azure.cosmos.database.pitr_enabled
  for_each: azure.cosmosdb.list
  conditions:
    var: item.capabilities
    op: contains
    value: EnablePITR
- rule_id: azure.cosmos.database.autoscale_enabled
  for_each: azure.cosmosdb.list
  conditions:
    var: item.capabilities
    op: contains
    value: EnableAutoScale
- rule_id: azure.cosmos.database.backup_enabled
  for_each: azure.cosmosdb.list
  conditions:
    var: item.capabilities
    op: contains
    value: EnableBackup
- rule_id: azure.cosmosdb.account.use_private_endpoints
  for_each: azure.cosmosdb.list
  conditions:
    var: item.private_endpoint_connections
    op: not_empty
- rule_id: azure.cosmos.database.global_tables_enabled
  for_each: azure.cosmosdb.list
  conditions:
    var: item.enable_multiple_write_locations
    op: equals
    value: true
- rule_id: azure.cosmos.database.geo_redundant
  for_each: azure.cosmosdb.list
  conditions:
    var: item.enable_automatic_failover
    op: equals
    value: true
- rule_id: azure.cosmosdb.network.restriction.enabled
  for_each: azure.cosmosdb.list
  conditions:
    var: item.is_virtual_network_filter_enabled
    op: equals
    value: true
