cosmosdb:
  version: '1.0'
  provider: azure
  service: cosmosdb
  package: azure-mgmt-cosmosdb
  client_class: CosmosDBManagementClient
  scope: subscription
  discovery:
  - discovery_id: azure.cosmosdb.database_accounts
    calls:
    - client: cosmosdb
      action: database_accounts.list
      save_as: database_accounts
  - discovery_id: azure.cosmosdb.sql_resources
    calls:
    - client: cosmosdb
      action: sql_resources.list_sql_databases
      save_as: sql_databases
  - discovery_id: azure.cosmosdb.table_resources
    calls:
    - client: cosmosdb
      action: table_resources.list_tables
      save_as: table_resources
  - discovery_id: azure.cosmosdb.private_endpoints
    calls:
    - client: cosmosdb
      action: private_endpoint_connections.list_by_database_account
      save_as: private_endpoints
  checks:
  - check_id: azure.cosmos.db.table.encryption.enabled
    title: 'AZURE COSMOS DB Table: Encryption Enabled'
    severity: high
    for_each: azure.cosmosdb.table_resources
    calls:
    - action: table_resources.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{account_name}}'
        table_name: '{{name}}'
      fields:
      - path: options.encryption_at_rest_policy
        operator: exists
  - check_id: azure.cosmosdb.account.private.endpoint.approved
    title: 'AZURE COSMOSDB Account: Private Endpoint Approved'
    severity: low
    for_each: azure.cosmosdb.private_endpoints
    calls:
    - action: private_endpoint_connections.list_by_database_account
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{account_name}}'
      fields:
      - path: private_link_service_connection_state.status
        operator: equals
        expected: Approved
  - check_id: azure.cosmos.database.encryption_enabled
    title: 'AZURE COSMOS Database: Encryption Enabled'
    severity: high
    for_each: azure.cosmosdb.sql_databases
    calls:
    - action: sql_resources.get_sql_database
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{account_name}}'
        database_name: '{{name}}'
      fields:
      - path: options.encryption_at_rest_policy.state
        operator: equals
        expected: Enabled
  - check_id: azure.cosmos.table.pitr_enabled
    title: 'AZURE COSMOS Table: PITR Enabled'
    severity: low
    for_each: azure.cosmosdb.table_resources
    calls:
    - action: table_resources.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{account_name}}'
        table_name: '{{name}}'
      fields:
      - path: options.continuous_backup_restore_policy
        operator: exists
  - check_id: azure.cosmosdb.account.firewall.configured
    title: 'AZURE COSMOSDB Account: Firewall Configured'
    severity: medium
    for_each: azure.cosmosdb.database_accounts
    calls:
    - action: database_accounts.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{name}}'
      fields:
      - path: ip_rules
        operator: exists
  - check_id: azure.cosmosdb.account.virtual.network.filter.enabled
    title: 'AZURE COSMOSDB Account: Virtual Network Filter Enabled'
    severity: medium
    for_each: azure.cosmosdb.database_accounts
    calls:
    - action: database_accounts.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{name}}'
      fields:
      - path: is_virtual_network_filter_enabled
        operator: equals
        expected: true
  - check_id: azure.cosmosdb.account.automatic.failover.enabled
    title: 'AZURE COSMOSDB Account: Automatic Failover Enabled'
    severity: medium
    for_each: azure.cosmosdb.database_accounts
    calls:
    - action: database_accounts.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{name}}'
      fields:
      - path: enable_automatic_failover
        operator: equals
        expected: true
  - check_id: azure.cosmosdb.account.multi.region.writes.enabled
    title: 'AZURE COSMOSDB Account: Multi Region Writes Enabled'
    severity: low
    for_each: azure.cosmosdb.database_accounts
    calls:
    - action: database_accounts.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{name}}'
      fields:
      - path: enable_multiple_write_locations
        operator: equals
        expected: true
  - check_id: azure.cosmosdb.account.public.network.access.disabled
    title: 'AZURE COSMOSDB Account: Public Network Access Disabled'
    severity: high
    for_each: azure.cosmosdb.database_accounts
    calls:
    - action: self
      fields:
      - path: public_network_access
        operator: equals
        expected: Disabled
  - check_id: azure.cosmosdb.account.key.based.metadata.write.access.disabled
    title: 'AZURE COSMOSDB Account: Key Based Metadata Write Access Disabled'
    severity: medium
    for_each: azure.cosmosdb.database_accounts
    calls:
    - action: database_accounts.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{name}}'
      fields:
      - path: disable_key_based_metadata_write_access
        operator: equals
        expected: true
  - check_id: azure.cosmosdb.account.local.auth.disabled
    title: 'AZURE COSMOSDB Account: Local Auth Disabled'
    severity: medium
    for_each: azure.cosmosdb.database_accounts
    calls:
    - action: database_accounts.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{name}}'
      fields:
      - path: disable_local_auth
        operator: equals
        expected: true
  - check_id: azure.cosmosdb.account.backup.policy.configured
    title: 'AZURE COSMOSDB Account: Backup Policy Configured'
    severity: medium
    for_each: azure.cosmosdb.database_accounts
    calls:
    - action: database_accounts.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{name}}'
      fields:
      - path: backup_policy
        operator: exists
  - check_id: azure.cosmosdb.account.analytical.storage.enabled
    title: 'AZURE COSMOSDB Account: Analytical Storage Enabled'
    severity: low
    for_each: azure.cosmosdb.database_accounts
    calls:
    - action: database_accounts.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{name}}'
      fields:
      - path: enable_analytical_storage
        operator: equals
        expected: true
  - check_id: azure.cosmosdb.account.free.tier.enabled
    title: 'AZURE COSMOSDB Account: Free Tier Enabled'
    severity: low
    for_each: azure.cosmosdb.database_accounts
    calls:
    - action: database_accounts.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{name}}'
      fields:
      - path: enable_free_tier
        operator: equals
        expected: false
  - check_id: azure.cosmosdb.defender.status.check
    title: 'AZURE COSMOSDB Defender: Status Check'
    severity: low
    for_each: azure.cosmosdb.defender
    calls:
    - action: self
      fields:
      - path: properties.defenderStatus
        operator: equals
        expected: Enabled
  - check_id: azure.cosmos.database.pitr_enabled
    title: 'AZURE COSMOSDB Resource: Pitr Enabled'
    severity: low
    for_each: azure.cosmosdb.resource
    calls:
    - action: self
      fields:
      - path: backup_policy.type
        operator: equals
        expected: Continuous
  - check_id: azure.cosmosdb.account.firewall_use_selected_networks
    title: 'AZURE COSMOSDB Account: Firewall Use Selected Networks'
    severity: medium
    for_each: azure.cosmosdb.account
    calls:
    - action: self
      fields:
      - path: properties.isVirtualNetworkFilterEnabled
        operator: equals
        expected: true
      - path: properties.publicNetworkAccess
        operator: not_equals
        expected: Enabled
  - check_id: azure.cosmos.db.table.encryption.enabled
    title: 'AZURE COSMOS DB: Table Encryption Enabled'
    severity: high
    for_each: azure.cosmosdb.db
    calls:
    - action: cosmosdb_client.get_database_account
      fields:
      - path: properties.encryption.status
        operator: equals
        expected: Enabled
      - path: properties.keyVaultKeyUri
        operator: exists
        expected: true
  - check_id: azure.cosmos.table.kms_cmk_encryption_enabled
    title: 'AZURE COSMOS Resource: Db Tables KMS CMK Encryption Enabled'
    severity: high
    for_each: azure.cosmosdb.resource
    calls:
    - action: self
      fields:
      - path: properties.keyVaultKeyUri
        operator: not_null
        expected: true
      - path: kind
        operator: equals
        expected: GlobalDocumentDB
      - path: properties.capabilities
        operator: contains
        expected:
          name: EnableTable
  - check_id: azure.cosmos.database.autoscale_enabled
    title: 'AZURE COSMOSDB Resource: Autoscale Enabled'
    severity: low
    for_each: azure.cosmosdb.resource
    calls:
    - action: self
      fields:
      - path: properties.options.autoscaleSettings
        operator: exists
        expected: true
  - check_id: azure.cosmos.database.global_tables_enabled
    title: 'AZURE COSMOSDB Resource: Global Tables Enabled'
    severity: low
    for_each: azure.cosmosdb.resource
    calls:
    - action: self
      fields:
      - path: properties.locations
        operator: greater_than
        expected: 1
  - check_id: azure.cosmos.database.backup_enabled
    title: 'AZURE COSMOSDB Resource: Backup Enabled'
    severity: medium
    for_each: azure.cosmosdb.resource
    calls:
    - action: self
      fields:
      - path: backup_policy.type
        operator: not_equals
        expected: null
      - path: backup_policy.type
        operator: in
        expected:
        - Periodic
        - Continuous
  - check_id: azure.cosmosdb.account.use_private_endpoints
    title: 'AZURE COSMOSDB Account: Use Private Endpoints'
    severity: low
    for_each: azure.cosmosdb.account
    calls:
    - action: self
      fields:
      - path: properties.privateEndpointConnections
        operator: not_empty
  - check_id: azure.cosmos.database.geo_redundant
    title: 'AZURE COSMOSDB Resource: Geo Redundant'
    severity: low
    for_each: azure.cosmosdb.resource
    calls:
    - action: self
      fields:
      - path: properties.enableMultipleWriteLocations
        operator: equals
        expected: true
      - path: properties.locations
        operator: count_greater_than
        expected: 1
  - check_id: azure.cosmosdb.network.restriction.enabled
    title: 'AZURE COSMOSDB Network: Restriction Enabled'
    severity: low
    for_each: azure.cosmosdb.accounts
    calls:
    - action: self
      fields:
      - path: properties.isVirtualNetworkFilterEnabled
        operator: equals
        expected: true
  - check_id: azure.cosmos.db.table.encryption.enabled
    title: Azure Cosmos DB Table Encryption Enabled
    severity: high
    for_each: azure.cosmosdb.account
    calls:
    - action: cosmosdb_client.get_database_account
      fields:
      - path: properties.encryption.status
        operator: equals
        expected: Enabled
      - path: properties.keyVaultKeyUri
        operator: exists
        expected: true
