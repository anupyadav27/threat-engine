# ============================================================================
# ü§ñ CURSOR AI: SERVICE VALIDATION INSTRUCTIONS
# ============================================================================
# 
# SERVICE: management
# STATUS: ‚úÖ VALIDATED
#
# üéØ YOUR TASK:
# 1. Run engine: export AZURE_ENGINE_FILTER_SERVICES="management" && python engine/azure_generic_engine.py > /tmp/test_management.json 2>&1
# 2. Analyze: tail -100 /tmp/test_management.json
# 3. Fix issues below in discovery/checks sections
# 4. Re-run until: inventory has resources (if exist), checks = PASS/FAIL (not ERROR)
# 5. Mark complete at bottom
#
# ‚ùå COMMON ISSUES & FIXES:
#
# "Failed to create client" ‚Üí 
#   Fix sdk_package: azure.mgmt.management (use DOTS not dashes)
#   Install: pip install azure-mgmt-management
#
# "Action not found: X.list" ‚Üí
#   Test in Python:
#     from azure.mgmt.management import *
#     client = <Client>(cred, sub_id)
#     print(dir(client.<resource>))  # Find correct method
#   Common: list_by_subscription, list_all, list_by_resource_group
#
# "ERROR" in checks ‚Üí
#   Check resource structure in output
#   Fix field paths: properties.encryption.keySource
#   Fix params: add resource_group_name, account_name, etc.
#
# Empty inventory ‚Üí
#   Create test resource: az <service> <resource> create ...
#   OR verify action name is correct
#
# ‚úÖ SUCCESS WHEN:
# - No warnings
# - Inventory populated (if resources exist)  
# - Checks = PASS/FAIL (not ERROR)
# - JSON is clean objects (not strings)
#
# üìù AFTER FIXING:
# Mark status below as VALIDATED and add notes at bottom
#
# ============================================================================

management:
  version: '1.0'
  provider: azure
  service: management
  sdk_package: azure.mgmt.managementgroups
  client_class: ManagementGroupsAPI
  api_type: management
  scope: tenant
  discovery:
  - discovery_id: azure.management.groups
    calls:
    - action: management_groups.list
      fields:
      - path: __self__
  checks:
  - check_id: azure.management.groups_group.governance_org_all_accounts_enrolled_in_org
    title: 'AZURE MANAGEMENT: All Subscriptions Enrolled in Management Group'
    severity: medium
    for_each: azure.management.groups
    calls:
    - action: management_groups.get_descendants
      params:
        group_id: '{{id}}'
      fields:
      - path: value
        operator: exists
  - check_id: azure.management.groups_group.governance_org_block_leave_org_by_policy
    title: 'AZURE MANAGEMENT: Block Subscription Removal Policy Enabled'
    severity: high
    for_each: azure.management.groups
    calls:
    - action: management_group_subscriptions.get_subscription_under_management_group
      params:
        group_id: '{{id}}'
      fields:
      - path: properties.require_authorization_for_group_creation
        operator: equals
        expected: true
  - check_id: azure.management.groups_group.governance_org_restrict_region_usage_by_policy_where_required
    title: 'AZURE MANAGEMENT: Region Restriction Policy Applied'
    severity: medium
    for_each: azure.management.groups
    calls:
    - action: policy_assignments.list_for_management_group
      params:
        management_group_id: '{{id}}'
      fields:
      - path: value[?(@.properties.display_name contains 'Allowed locations')]
        operator: exists
  - check_id: azure.management.groups_group.governance_org_scps_enabled
    title: 'AZURE MANAGEMENT: Azure Policy Enabled at Management Group'
    severity: high
    for_each: azure.management.groups
    calls:
    - action: policy_assignments.list_for_management_group
      params:
        management_group_id: '{{id}}'
      fields:
      - path: value
        operator: has_items
  - check_id: azure.management.groups_group.governance_ou_auto_tag_policies_enabled_where_supported
    title: 'AZURE MANAGEMENT: Auto-tagging Policies Enabled'
    severity: low
    for_each: azure.management.groups
    calls:
    - action: policy_assignments.list_for_management_group
      params:
        management_group_id: '{{id}}'
      fields:
      - path: value[?(@.properties.display_name contains 'tag' || @.properties.display_name contains 'Tag')]
        operator: exists
  - check_id: azure.management.groups_group.governance_ou_no_overly_permissive_exceptions
    title: 'AZURE MANAGEMENT: No Overly Permissive Policy Exemptions'
    severity: high
    for_each: azure.management.groups
    calls:
    - action: policy_exemptions.list_for_management_group
      params:
        management_group_id: '{{id}}'
      fields:
      - path: value[?(@.properties.exemption_category == 'Waiver')]
        operator: count_less_than
        expected: 5
  - check_id: azure.management.groups_group.governance_ou_required_scps_attached
    title: 'AZURE MANAGEMENT: Required Azure Policies Attached'
    severity: high
    for_each: azure.management.groups
    calls:
    - action: policy_assignments.list_for_management_group
      params:
        management_group_id: '{{id}}'
      fields:
      - path: value
        operator: count_greater_than
        expected: 0


# ============================================================================
# VALIDATION TRACKING
# ============================================================================
# STATUS: ‚úÖ VALIDATED
# VALIDATED_BY: Cursor AI
# VALIDATED_DATE: 2025-12-05
# 
# FIXES APPLIED:
# # - (Add fixes here after validation)
#
# TEST RESULTS:
# - Resources Discovered: 0
# - Checks Executed: 0
# - PASS: 0
# - FAIL: 0
# - ERROR: 0
#
# NOTES:
# # - (Add notes here)
# ============================================================================
