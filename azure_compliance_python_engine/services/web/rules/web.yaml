version: '1.0'
provider: azure
service: web
discovery:
- discovery_id: azure.function.list
  calls:
  - action: list
    save_as: list_response
  emit:
    items_for: '{{ list_response.value }}'
    as: item
    item:
      id: '{{ item.id }}'
      name: '{{ item.name }}'
      kind: '{{ item.kind }}'
      location: '{{ item.location }}'
      type: '{{ item.type }}'
      tags: '{{ item.tags }}'
      certificates: '{{ item.certificates }}'
      distinguished_name: '{{ item.distinguished_name }}'
      domain_verification_token: '{{ item.domain_verification_token }}'
      validity_in_years: '{{ item.validity_in_years }}'
      key_size: '{{ item.key_size }}'
      product_type: '{{ item.product_type }}'
      auto_renew: '{{ item.auto_renew }}'
      provisioning_state: '{{ item.provisioning_state }}'
      status: '{{ item.status }}'
      signed_certificate: '{{ item.signed_certificate }}'
      csr: '{{ item.csr }}'
      intermediate: '{{ item.intermediate }}'
      root: '{{ item.root }}'
      serial_number: '{{ item.serial_number }}'
- discovery_id: azure.logic.list
  calls:
  - action: list
    save_as: list_response
  emit:
    items_for: '{{ list_response.value }}'
    as: item
    item:
      id: '{{ item.id }}'
      name: '{{ item.name }}'
      kind: '{{ item.kind }}'
      location: '{{ item.location }}'
      type: '{{ item.type }}'
      tags: '{{ item.tags }}'
      certificates: '{{ item.certificates }}'
      distinguished_name: '{{ item.distinguished_name }}'
      domain_verification_token: '{{ item.domain_verification_token }}'
      validity_in_years: '{{ item.validity_in_years }}'
      key_size: '{{ item.key_size }}'
      product_type: '{{ item.product_type }}'
      auto_renew: '{{ item.auto_renew }}'
      provisioning_state: '{{ item.provisioning_state }}'
      status: '{{ item.status }}'
      signed_certificate: '{{ item.signed_certificate }}'
      csr: '{{ item.csr }}'
      intermediate: '{{ item.intermediate }}'
      root: '{{ item.root }}'
      serial_number: '{{ item.serial_number }}'
- discovery_id: azure.webapp.list
  calls:
  - action: list
    save_as: list_response
  emit:
    items_for: '{{ list_response.value }}'
    as: item
    item:
      id: '{{ item.id }}'
      name: '{{ item.name }}'
      kind: '{{ item.kind }}'
      location: '{{ item.location }}'
      type: '{{ item.type }}'
      tags: '{{ item.tags }}'
      certificates: '{{ item.certificates }}'
      distinguished_name: '{{ item.distinguished_name }}'
      domain_verification_token: '{{ item.domain_verification_token }}'
      validity_in_years: '{{ item.validity_in_years }}'
      key_size: '{{ item.key_size }}'
      product_type: '{{ item.product_type }}'
      auto_renew: '{{ item.auto_renew }}'
      provisioning_state: '{{ item.provisioning_state }}'
      status: '{{ item.status }}'
      signed_certificate: '{{ item.signed_certificate }}'
      csr: '{{ item.csr }}'
      intermediate: '{{ item.intermediate }}'
      root: '{{ item.root }}'
      serial_number: '{{ item.serial_number }}'
checks:
- rule_id: azure.function.function_version.published_and_immutable
  for_each: azure.function.list
  conditions:
    var: item.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.functionapp.vnet.routing.enabled.check
  for_each: azure.function.list
  conditions:
    var: item.networking_configuration
    op: not_empty
- rule_id: azure.function.app.managed.identity.configured
  for_each: azure.function.list
  conditions:
    var: item.identity
    op: not_empty
- rule_id: azure.functionapp.ftps.state.compliance.check
  for_each: azure.function.list
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: azure.functionapp.basic.auth.publishing.disabled
  for_each: azure.function.list
  conditions:
    var: item.status
    op: equals
    value: Disabled
- rule_id: azure.functions.app.restrict_public_access
  for_each: azure.function.list
  conditions:
    var: item.networking_configuration
    op: not_empty
- rule_id: azure.functionapp.https.only.check
  for_each: azure.function.list
  conditions:
    var: item.networking_configuration
    op: contains
    value: httpsOnly
- rule_id: azure.functionapp.client.cert.required.check
  for_each: azure.function.list
  conditions:
    var: item.certificates
    op: not_empty
- rule_id: azure.function.function_version.rollforward_rollback_controls_present
  for_each: azure.function.list
  conditions:
    var: item.upgrade_preference
    op: not_empty
- rule_id: azure.function.app.minimum.tls.version
  for_each: azure.function.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.functionapp.python.version.check
  for_each: azure.function.list
  conditions:
    var: item.tags
    op: contains
    value: python_version
- rule_id: azure.functionapp.deployment.slot.vnet.integration.check
  for_each: azure.function.list
  conditions:
    var: item.virtual_network
    op: not_empty
- rule_id: azure.functionapp.deployment.slot.java.version.check
  for_each: azure.function.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.functionapp.deployment.slot.minimum.tls.version.check
  for_each: azure.function.list
  conditions:
    var: item.tags
    op: contains
    value: TLS
- rule_id: azure.function.app.deployment.slot.access.restrictions.disabled
  for_each: azure.function.list
  conditions:
    var: item.networking_configuration
    op: equals
    value: Disabled
- rule_id: azure.function.serverless_function.dead_letter_queue
  for_each: azure.function.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.functionapp.authentication.enabled
  for_each: azure.function.list
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: azure.function.app.vnet.integration.routing.enabled
  for_each: azure.function.list
  conditions:
    var: item.networking_configuration
    op: not_empty
- rule_id: azure.function.app.function_restrict_public_access
  for_each: azure.function.list
  conditions:
    var: item.user_whitelisted_ip_ranges
    op: not_empty
- rule_id: azure.functionapp.deployment.slot.identity.check
  for_each: azure.function.list
  conditions:
    var: item.identity
    op: exists
- rule_id: azure.functionapp.incoming.client.certificates.required
  for_each: azure.function.list
  conditions:
    var: item.certificates
    op: not_empty
- rule_id: azure.function.app.deployment.slot.http.version.check
  for_each: azure.function.list
  conditions:
    var: item.status
    op: equals
    value: Succeeded
- rule_id: azure.function.app.http.version.2.0.check
  for_each: azure.function.list
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: azure.function.app.e2e.tls.enabled
  for_each: azure.function.list
  conditions:
    var: item.networking_configuration
    op: not_empty
- rule_id: azure.function.app.deployment.slot.cors.restriction
  for_each: azure.function.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.function.app.deployment.slot.remote.debugging.disabled
  for_each: azure.function.list
  conditions:
    var: item.status
    op: equals
    value: Disabled
- rule_id: azure.function.serverless_function.env_no_plaintext_secrets
  for_each: azure.function.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.function.app.function_url_authentication
  for_each: azure.function.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.functionapp.tls.encryption.in.transit.check
  for_each: azure.function.list
  conditions:
    var: item.certificates
    op: not_empty
- rule_id: azure.functionapp.deployment.slots.basic.auth.disabled
  for_each: azure.function.list
  conditions:
    var: item.status
    op: equals
    value: Disabled
- rule_id: azure.function.serverless_function.vpc_private_networking_enabled
  for_each: azure.function.list
  conditions:
    var: item.networking_configuration
    op: not_empty
- rule_id: azure.functions.app.url_public
  for_each: azure.function.list
  conditions:
    var: item.networking_configuration
    op: not_empty
- rule_id: azure.function.app.vnet.integration.check
  for_each: azure.function.list
  conditions:
    var: item.virtual_network
    op: not_empty
- rule_id: azure.function.serverless_function.logging_and_tracing_enabled
  for_each: azure.function.list
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: azure.function.serverless_function.role_least_privilege
  for_each: azure.function.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.function.app.cors.no.wildcard.origins
  for_each: azure.function.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.function.app.deployment.slot.vnet.routing.config.check
  for_each: azure.function.list
  conditions:
    var: item.networking_configuration
    op: not_empty
- rule_id: azure.function.app.remote.debugging.check
  for_each: azure.function.list
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: azure.function.app.deployment.slot.vnet.route.all.enabled
  for_each: azure.function.list
  conditions:
    var: item.networking_configuration
    op: contains
    value: vnetRouteAllEnabled
- rule_id: azure.functionapp.java.supported.version.check
  for_each: azure.function.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.function.app.deployment.slot.python.version.check
  for_each: azure.function.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.logic.apps_workflow.incident_workflow_kms_encryption_enabled
  for_each: azure.logic.list
  conditions:
    var: item.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.logic.apps_workflow.incident_workflow_integrations_least_privilege
  for_each: azure.logic.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.logic.apps_workflow.incident_workflow_approval_steps_required_for_destructive_actions
  for_each: azure.logic.list
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: azure.app.service.slot.check.minimum.tls.version
  for_each: azure.webapp.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.site.recovery_test_failover.dr_testing_logs_enabled
  for_each: azure.webapp.list
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: azure.appservice.authentication.enabled.check
  for_each: azure.webapp.list
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: azure.app.service.slot.public.network.access.check
  for_each: azure.webapp.list
  conditions:
    var: item.networking_configuration
    op: not_empty
- rule_id: azure.app.service.function.slot.https.only.check
  for_each: azure.webapp.list
  conditions:
    var: item.networking_configuration
    op: contains
    value: httpsOnly
- rule_id: azure.site.recovery_automation_runbook.dr_automation_change_audit_logging_enabled
  for_each: azure.webapp.list
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: azure.site.recovery_test_failover.dr_testing_results_storage_encrypted_and_private
  for_each: azure.webapp.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.appservice.deployment.slot.php.version.check
  for_each: azure.webapp.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.monitor.application.insights_enabled
  for_each: azure.webapp.list
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: azure.app.service.cors.check.allowed.origins
  for_each: azure.webapp.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.app.service.deployment.slot.https.only.enabled
  for_each: azure.webapp.list
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: azure.app.service.deployment.slot.tls.encryption.check
  for_each: azure.webapp.list
  conditions:
    var: item.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.application.gateway.waf.bot.protection.check
  for_each: azure.webapp.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.app.service.autoscale_enabled:az.azure_paas_app.paas_security_app_logging_enabled
  for_each: azure.webapp.list
  conditions:
    var: item.elastic_scale_enabled
    op: equals
    value: true
- rule_id: azure.site.recovery_notification_settings.dr_communication_destinations_access_least_privilege
  for_each: azure.webapp.list
  conditions:
    var: item.user_whitelisted_ip_ranges
    op: not_empty
- rule_id: azure.app.service.environment.minimum.tls.version
  for_each: azure.webapp.list
  conditions:
    var: item.cluster_settings
    op: not_empty
- rule_id: azure.app.service.deployment.slot.http.version.check
  for_each: azure.webapp.list
  conditions:
    var: item.networking_configuration
    op: not_empty
- rule_id: azure.webapp.deployment.slot.python.version.supported
  for_each: azure.webapp.list
  conditions:
    var: item.tags
    op: contains
    value: python_version
- rule_id: azure.app.service.deployment.slot.remote.debugging.disabled
  for_each: azure.webapp.list
  conditions:
    var: item.status
    op: not_equals
    value: Enabled
- rule_id: azure.application.gateway.ssl.policy.minimum.tls.version
  for_each: azure.webapp.list
  conditions:
    var: item.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.site.recovery_notification_settings.dr_communication_channels_configured
  for_each: azure.webapp.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.site.recovery.configured
  for_each: azure.webapp.list
  conditions:
    var: item.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.app.service.slot.client.cert.check
  for_each: azure.webapp.list
  conditions:
    var: item.certificates
    op: not_empty
- rule_id: azure.site.recovery_automation_runbook.dr_automation_artifacts_encrypted_and_private
  for_each: azure.webapp.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.webapp.deployment.slot.vnet.configuration.enabled
  for_each: azure.webapp.list
  conditions:
    var: item.networking_configuration
    op: not_empty
- rule_id: azure.app.service.deployment.slot.vnet.route.all.enabled.check
  for_each: azure.webapp.list
  conditions:
    var: item.networking_configuration
    op: contains
    value: vnet_route_all
- rule_id: azure.app.service.plan.private.endpoint.sku.compliance.check
  for_each: azure.webapp.list
  conditions:
    var: item.sku
    op: not_empty
- rule_id: azure.app.service.http.logs.enabled
  for_each: azure.webapp.list
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: azure.app.service.vnet.route.all.enabled.check
  for_each: azure.webapp.list
  conditions:
    var: item.networking_configuration
    op: contains
    value: vnetRouteAllEnabled
- rule_id: azure.site.recovery_recovery_plan.dr_documentation_storage_encrypted_and_private
  for_each: azure.webapp.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.site.recovery_recovery_plan.dr_documentation_access_rbac_least_privilege
  for_each: azure.webapp.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.site.recovery_recovery_plan.dr_restore_from_encrypted_backups_only
  for_each: azure.webapp.list
  conditions:
    var: item.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.site.recovery_recovery_plan.dr_restore_cross_account_restore_blocked_by_policy
  for_each: azure.webapp.list
  conditions:
    var: item.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.application.gateway.waf.policy.request.body.inspection.enabled
  for_each: azure.webapp.list
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: azure.application.gateway.http2.enabled
  for_each: azure.webapp.list
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: azure.app.service.deployment.slot.java.version.check
  for_each: azure.webapp.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.appservice.app.ip.security.restrictions.disabled
  for_each: azure.webapp.list
  conditions:
    var: item.user_whitelisted_ip_ranges
    op: equals
    value: []
- rule_id: azure.site.recovery_replication_policy.dr_replication_lag_monitoring_alerts_enabled
  for_each: azure.webapp.list
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: azure.app.service.deployment.slot.managed.identity.configured
  for_each: azure.webapp.list
  conditions:
    var: item.identity
    op: not_empty
- rule_id: azure.site.recovery_replication_policy.dr_replication_auth_roles_least_privilege
  for_each: azure.webapp.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.site.recovery_notification_settings.dr_communication_no_public_webhooks_without_auth
  for_each: azure.webapp.list
  conditions:
    var: item.networking_configuration
    op: not_empty
- rule_id: azure.app.service.private.endpoint.dns.zone.check
  for_each: azure.webapp.list
  conditions:
    var: item.custom_dns_suffix_configuration
    op: not_empty
- rule_id: azure.app.service.virtual.network.integration.check
  for_each: azure.webapp.list
  conditions:
    var: item.virtual_network
    op: not_empty
- rule_id: azure.site.recovery_automation_runbook.dr_automation_execution_roles_least_privilege
  for_each: azure.webapp.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.application.gateway.waf.enabled
  for_each: azure.webapp.list
  conditions:
    var: item.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.app.service.identity.check
  for_each: azure.webapp.list
  conditions:
    var: item.identity
    op: not_empty
- rule_id: azure.site.recovery_recovery_plan.dr_restore_roles_least_privilege
  for_each: azure.webapp.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.app.service.deployment.slots.basic.auth.disabled
  for_each: azure.webapp.list
  conditions:
    var: item.status
    op: equals
    value: Disabled
- rule_id: azure.site.recovery_replication_policy.dr_replication_cross_region_replication_encrypted
  for_each: azure.webapp.list
  conditions:
    var: item.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.site.recovery_replication_policy.dr_replication_encryption_in_transit_tls_required
  for_each: azure.webapp.list
  conditions:
    var: item.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.app.service.cors.wildcard.restriction
  for_each: azure.webapp.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.site.recovery_recovery_plan.dr_restore_logs_and_artifacts_encrypted
  for_each: azure.webapp.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.appservice.ase.internal.encryption.check
  for_each: azure.webapp.list
  conditions:
    var: item.networking_configuration
    op: not_empty
- rule_id: azure.app.function.identity_without_admin_privileges
  for_each: azure.webapp.list
  conditions:
    var: item.identity
    op: not_empty
- rule_id: azure.app.service.deployment.slot.ftps.state.check
  for_each: azure.webapp.list
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: azure.app.service.private.endpoint.approved.check
  for_each: azure.webapp.list
  conditions:
    var: item.networking_configuration
    op: not_empty
- rule_id: azure.appservice.ase.tls.cipher.suite.order.configured
  for_each: azure.webapp.list
  conditions:
    var: item.cluster_settings
    op: not_empty
- rule_id: azure.appservice.deployment.slot.vnet.integration.check
  for_each: azure.webapp.list
  conditions:
    var: item.networking_configuration
    op: not_empty
- rule_id: azure.app.service.managed_updates_enabled:az.azure_paas_app.paas_security_app_logging_enabled
  for_each: azure.webapp.list
  conditions:
    var: item.upgrade_preference
    op: not_empty
- rule_id: azure.site.recovery_test_failover.dr_testing_execution_roles_least_privilege
  for_each: azure.webapp.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.app.service.vnet.integration.check
  for_each: azure.webapp.list
  conditions:
    var: item.virtual_network
    op: not_empty
- rule_id: azure.app.service.environment.minimum.version.check
  for_each: azure.webapp.list
  conditions:
    var: item.upgrade_preference
    op: not_empty
