keyvault:
  version: '1.0'
  provider: azure
  service: keyvault
  package: azure-mgmt-keyvault
  client_class: KeyVaultManagementClient
  scope: subscription
  discovery:
  - discovery_id: azure.keyvault.vaults
    calls:
    - client: keyvault
      action: vaults.list
      save_as: vaults
  - discovery_id: azure.keyvault.keys
    calls:
    - client: keyvault
      action: keys.list
      save_as: keys
  - discovery_id: azure.keyvault.secrets
    calls:
    - client: keyvault
      action: secrets.list
      save_as: secrets
  - discovery_id: azure.keyvault.certificates
    calls:
    - client: keyvault
      action: certificates.list
      save_as: certificates
  checks:
  - check_id: azure.keyvault.key.expiration_date_set
    title: 'AZURE KEYVAULT Key: Expiration Date Set'
    severity: medium
    for_each: azure.keyvault.keys
    calls:
    - action: keys.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{name}}'
      fields:
      - path: attributes.expires
        operator: exists
  - check_id: azure.keyvault.key.rotation_policy_enabled
    title: 'AZURE KEYVAULT Key: Rotation Policy Enabled'
    severity: medium
    for_each: azure.keyvault.keys
    calls:
    - action: keys.get_rotation_policy
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{name}}'
      fields:
      - path: lifetime_actions
        operator: exists
  - check_id: azure.keyvault.key.hsm_protected
    title: 'AZURE KEYVAULT Key: HSM Protected'
    severity: high
    for_each: azure.keyvault.keys
    calls:
    - action: keys.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{name}}'
      fields:
      - path: kty
        operator: equals
        expected: RSA-HSM
  - check_id: azure.keyvault.key.minimum_key_size
    title: 'AZURE KEYVAULT Key: Minimum Key Size'
    severity: medium
    for_each: azure.keyvault.keys
    calls:
    - action: keys.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{name}}'
      fields:
      - path: key_size
        operator: gte
        expected: 2048
  - check_id: azure.keyvault.secret.expiration_date_set
    title: 'AZURE KEYVAULT Secret: Expiration Date Set'
    severity: medium
    for_each: azure.keyvault.secrets
    calls:
    - action: secrets.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        secret_name: '{{name}}'
      fields:
      - path: attributes.expires
        operator: exists
  - check_id: azure.keyvault.secret.content_type_specified
    title: 'AZURE KEYVAULT Secret: Content Type Specified'
    severity: low
    for_each: azure.keyvault.secrets
    calls:
    - action: secrets.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        secret_name: '{{name}}'
      fields:
      - path: content_type
        operator: exists
  - check_id: azure.keyvault.certificate.expiration_date_set
    title: 'AZURE KEYVAULT Certificate: Expiration Date Set'
    severity: medium
    for_each: azure.keyvault.certificates
    calls:
    - action: certificates.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        certificate_name: '{{name}}'
      fields:
      - path: attributes.expires
        operator: exists
  - check_id: azure.keyvault.certificate.auto_renewal_enabled
    title: 'AZURE KEYVAULT Certificate: Auto Renewal Enabled'
    severity: medium
    for_each: azure.keyvault.certificates
    calls:
    - action: certificates.get_certificate_policy
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        certificate_name: '{{name}}'
      fields:
      - path: lifetime_actions[0].action.action_type
        operator: equals
        expected: AutoRenew
  - check_id: azure.keyvault.certificate.minimum_key_size
    title: 'AZURE KEYVAULT Certificate: Minimum Key Size'
    severity: medium
    for_each: azure.keyvault.certificates
    calls:
    - action: certificates.get_certificate_policy
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        certificate_name: '{{name}}'
      fields:
      - path: key_properties.key_size
        operator: gte
        expected: 2048
  - check_id: azure.keyvault.vault.public_network_access_disabled
    title: 'AZURE KEYVAULT Vault: Public Network Access Disabled'
    severity: high
    for_each: azure.keyvault.vaults
    calls:
    - action: self
      fields:
      - path: properties.public_network_access
        operator: equals
        expected: Disabled
  - check_id: azure.keyvault.key.enabled_status
    title: 'AZURE KEYVAULT Key: Enabled Status'
    severity: medium
    for_each: azure.keyvault.keys
    calls:
    - action: keys.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{name}}'
      fields:
      - path: attributes.enabled
        operator: equals
        expected: true
  - check_id: azure.keyvault.secret.enabled_status
    title: 'AZURE KEYVAULT Secret: Enabled Status'
    severity: medium
    for_each: azure.keyvault.secrets
    calls:
    - action: secrets.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        secret_name: '{{name}}'
      fields:
      - path: attributes.enabled
        operator: equals
        expected: true
  - check_id: azure.keyvault.certificate.enabled_status
    title: 'AZURE KEYVAULT Certificate: Enabled Status'
    severity: medium
    for_each: azure.keyvault.certificates
    calls:
    - action: certificates.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        certificate_name: '{{name}}'
      fields:
      - path: attributes.enabled
        operator: equals
        expected: true
  - check_id: azure.keyvault.key.not_before_date_set
    title: 'AZURE KEYVAULT Key: Not Before Date Set'
    severity: low
    for_each: azure.keyvault.keys
    calls:
    - action: keys.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{name}}'
      fields:
      - path: attributes.not_before
        operator: exists
  - check_id: azure.keyvault.secret.not_before_date_set
    title: 'AZURE KEYVAULT Secret: Not Before Date Set'
    severity: low
    for_each: azure.keyvault.secrets
    calls:
    - action: secrets.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        secret_name: '{{name}}'
      fields:
      - path: attributes.not_before
        operator: exists
  - check_id: azure.keyvault.certificate.not_before_date_set
    title: 'AZURE KEYVAULT Certificate: Not Before Date Set'
    severity: low
    for_each: azure.keyvault.certificates
    calls:
    - action: certificates.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        certificate_name: '{{name}}'
      fields:
      - path: attributes.not_before
        operator: exists
  - check_id: azure.keyvault.vault.sku_premium
    title: 'AZURE KEYVAULT Vault: SKU Premium'
    severity: low
    for_each: azure.keyvault.vaults
    calls:
    - action: self
      fields:
      - path: properties.sku.name
        operator: equals
        expected: premium
  - check_id: azure.keyvault.key.curve_name_specified
    title: 'AZURE KEYVAULT Key: Curve Name Specified'
    severity: low
    for_each: azure.keyvault.keys
    calls:
    - action: keys.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{name}}'
      fields:
      - path: key.crv
        operator: exists
  - check_id: azure.keyvault.certificate.key_usage_specified
    title: 'AZURE KEYVAULT Certificate: Key Usage Specified'
    severity: medium
    for_each: azure.keyvault.certificates
    calls:
    - action: certificates.get_certificate_policy
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        certificate_name: '{{name}}'
      fields:
      - path: key_properties.key_usage
        operator: exists
  - check_id: azure.keyvault.key.key_operations_restricted
    title: 'AZURE KEYVAULT Key: Key Operations Restricted'
    severity: medium
    for_each: azure.keyvault.keys
    calls:
    - action: keys.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{name}}'
      fields:
      - path: key_ops
        operator: exists
  - check_id: azure.keyvault.certificate.subject_alternative_names
    title: 'AZURE KEYVAULT Certificate: Subject Alternative Names'
    severity: low
    for_each: azure.keyvault.certificates
    calls:
    - action: certificate_policy.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        certificate_name: '{{name}}'
      fields:
      - path: x509_certificate_properties.subject_alternative_names
        operator: exists
  - check_id: azure.keyvault.key.release_policy_configured
    title: 'AZURE KEYVAULT Key: Release Policy Configured'
    severity: medium
    for_each: azure.keyvault.keys
    calls:
    - action: keys.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{name}}'
      fields:
      - path: release_policy
        operator: exists
  - check_id: azure.keyvault.certificate.validity_months_configured
    title: 'AZURE KEYVAULT Certificate: Validity Months Configured'
    severity: medium
    for_each: azure.keyvault.certificates
    calls:
    - action: certificate_policy.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        certificate_name: '{{name}}'
      fields:
      - path: x509_certificate_properties.validity_in_months
        operator: lte
        expected: 12
  - check_id: azure.keyvault.key.exportable_configured
    title: 'AZURE KEYVAULT Key: Exportable Configured'
    severity: medium
    for_each: azure.keyvault.keys
    calls:
    - action: keys.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{name}}'
      fields:
      - path: attributes.exportable
        operator: equals
        expected: false
  - check_id: azure.keyvault.certificate.issuer_configured
    title: 'AZURE KEYVAULT Certificate: Issuer Configured'
    severity: medium
    for_each: azure.keyvault.certificates
    calls:
    - action: certificate_policy.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        certificate_name: '{{name}}'
      fields:
      - path: issuer_parameters.name
        operator: exists
  - check_id: azure.keyvault.vault.provisioning_state_succeeded
    title: 'AZURE KEYVAULT Vault: Provisioning State Succeeded'
    severity: low
    for_each: azure.keyvault.vaults
    calls:
    - action: self
      fields:
      - path: properties.provisioning_state
        operator: equals
        expected: Succeeded
  - check_id: azure.keyvault.managed_hsm.public_network_access_disabled
    title: 'AZURE KEYVAULT Managed HSM: Public Network Access Disabled'
    severity: high
    for_each: azure.keyvault.vaults
    calls:
    - action: self
      fields:
      - path: properties.public_network_access
        operator: equals
        expected: Disabled
  - check_id: azure.keyvault.managed_hsm.soft_delete_retention_days
    title: 'AZURE KEYVAULT Managed HSM: Soft Delete Retention Days'
    severity: medium
    for_each: azure.keyvault.vaults
    calls:
    - action: managed_hsms.get
      params:
        resource_group_name: '{{resource_group}}'
        name: '{{name}}'
      fields:
      - path: soft_delete_retention_in_days
        operator: gte
        expected: 90
  - check_id: azure.keyvault.alias.alias_alias_points_to_active_key
    title: 'AZURE AZURE Crypto_alias: Secrets Alias Alias Points To Active Key'
    severity: high
    for_each: azure.keyvault.crypto_aliases
    calls:
    - action: keys.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{key_name}}'
      fields:
      - path: key.target_key_id
        operator: not_empty
        expected: true
      - path: attributes.enabled
        operator: equals
        expected: true
  - check_id: azure.keyvault.alias.alias_key_has_alias
    title: 'AZURE AZURE Crypto_alias: Secrets Alias Key Has Alias'
    severity: high
    for_each: azure.keyvault.crypto_aliases
    calls:
    - action: keys.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{key_name}}'
      fields:
      - path: key.aliases
        operator: not_empty
        expected: true
  - check_id: azure.keyvault.certificate.certificate_key_length_minimum
    title: 'AZURE AZURE Crypto_certificate: Secrets Certificate Key Length Minimum'
    severity: high
    for_each: azure.keyvault.crypto_certificates
    calls:
    - action: certificates.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        certificate_name: '{{certificate_name}}'
      fields:
      - path: policy.key_properties.key_size
        operator: greater_than_or_equal
        expected: 2048
  - check_id: azure.keyvault.certificate.certificate_not_expired
    title: 'AZURE AZURE Crypto_certificate: Secrets Certificate Not Expired'
    severity: high
    for_each: azure.keyvault.crypto_certificates
    calls:
    - action: certificates.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        certificate_name: '{{certificate_name}}'
      fields:
      - path: attributes.expires
        operator: greater_than
        expected: current_time
  - check_id: azure.keyvault.certificate.certificate_trusted_issuer
    title: 'AZURE AZURE Crypto_certificate: Secrets Certificate Trusted Issuer'
    severity: high
    for_each: azure.keyvault.crypto_certificates
    calls:
    - action: certificates.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        certificate_name: '{{certificate_name}}'
      fields:
      - path: policy.issuer_parameters.name
        operator: in
        expected:
        - DigiCert
        - GlobalSign
        - Let's Encrypt
        - Verisign
  - check_id: azure.keyvault.certificate.max.12.months.validity.check
    title: 'AZURE KEYVAULT Certificate: Max 12 Months Validity Check'
    severity: medium
    for_each: azure.keyvault.certificates
    calls:
    - action: certificates.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        certificate_name: '{{certificate_name}}'
      fields:
      - path: policy.x509_certificate_properties.validity_in_months
        operator: less_than_or_equal
        expected: 12
  - check_id: azure.keyvault.defender.pricing.tier.check
    title: 'AZURE KEYVAULT Defender: Pricing Tier Check'
    severity: medium
    for_each: azure.keyvault.defenders
    calls:
    - action: pricings.get
      params:
        pricing_name: KeyVaults
      fields:
      - path: pricing_tier
        operator: equals
        expected: Standard
  - check_id: azure.keyvault.grant.kms_grant_constraints_present
    title: 'AZURE AZURE Crypto_grant: Secrets KMS Grant Constraints Present'
    severity: high
    for_each: azure.keyvault.crypto_grants
    calls:
    - action: keys.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{key_name}}'
      fields:
      - path: key.constraints
        operator: not_empty
        expected: true
  - check_id: azure.keyvault.grant.kms_grant_grantee_principal_valid
    title: 'AZURE AZURE Crypto_grant: Secrets KMS Grant Grantee Principal Valid'
    severity: high
    for_each: azure.keyvault.crypto_grants
    calls:
    - action: keys.get_grant
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{key_name}}'
        grant_id: '{{grant_id}}'
      fields:
      - path: properties.grantee_principal
        operator: not_empty
        expected: true
      - path: properties.grantee_principal
        operator: regex_match
        expected: ^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$
  - check_id: azure.keyvault.grant.kms_grant_lessthan_wildcard_permissions
    title: 'AZURE AZURE Crypto_grant: Secrets KMS Grant Lessthan Wildcard Permissions'
    severity: high
    for_each: azure.keyvault.crypto_grants
    calls:
    - action: keys.get_grant
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{key_name}}'
        grant_id: '{{grant_id}}'
      fields:
      - path: properties.operations
        operator: not_contains
        expected: '*'
  - check_id: azure.keyvault.key.expiration.check
    title: 'AZURE KEYVAULT Key: Expiration Check'
    severity: medium
    for_each: azure.keyvault.keys
    calls:
    - action: keys.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{key_name}}'
      fields:
      - path: attributes.expires
        operator: not_null
        expected: true
      - path: attributes.expires
        operator: greater_than
        expected: current_time
  - check_id: azure.keyvault.key.not_scheduled_for_deletion
    title: 'AZURE KEYVAULT Key: Not Scheduled For Deletion'
    severity: medium
    for_each: azure.keyvault.keys
    calls:
    - action: keys.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{key_name}}'
      fields:
      - path: attributes.enabled
        operator: equals
        expected: true
      - path: scheduled_purge_date
        operator: is_null
        expected: true
  - check_id: azure.keyvault.key.rotation.policy.enabled
    title: 'AZURE KEYVAULT Key: Rotation Policy Enabled'
    severity: medium
    for_each: azure.keyvault.keys
    calls:
    - action: keys.get_rotation_policy
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{key_name}}'
      fields:
      - path: lifetime_actions
        operator: not_empty
        expected: true
  - check_id: azure.keyvault.key.rotation_enabled
    title: 'AZURE KEYVAULT Key: Rotation Enabled'
    severity: medium
    for_each: azure.keyvault.keys
    calls:
    - action: keys.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        key_name: '{{key_name}}'
      fields:
      - path: rotation_policy.attributes.expiry_time
        operator: not_null
        expected: true
  - check_id: azure.keyvault.keys.check.expiration
    title: 'AZURE KEYVAULT Keys: Check Expiration'
    severity: medium
    for_each: azure.keyvault.keys
    calls:
    - action: keys.list
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
      fields:
      - path: value[*].attributes.expires
        operator: all_greater_than
        expected: current_time
  - check_id: azure.keyvault.managedhsm.compliance.check
    title: 'AZURE KEYVAULT Managedhsm: Compliance Check'
    severity: medium
    for_each: azure.keyvault.managedhsms
    calls:
    - action: managed_hsms.get
      params:
        resource_group_name: '{{resource_group}}'
        name: '{{hsm_name}}'
      fields:
      - path: properties.enable_purge_protection
        operator: equals
        expected: true
      - path: properties.enable_soft_delete
        operator: equals
        expected: true
  - check_id: azure.keyvault.non.rbac.secret.expiration.check
    title: 'AZURE KEYVAULT Non: RBAC Secret Expiration Check'
    severity: high
    for_each: azure.keyvault.secrets
    calls:
    - action: secrets.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        secret_name: '{{secret_name}}'
      fields:
      - path: attributes.expires
        operator: not_null
        expected: true
      - path: attributes.expires
        operator: greater_than
        expected: current_time
  - check_id: azure.keyvault.paas_app.env_secrets_from_vault_only
    title: 'AZURE AZURE Paas_app: Env Secrets From Vault Only'
    severity: high
    for_each: azure.keyvault.paas_apps
    calls:
    - action: web_apps.list_application_settings
      params:
        resource_group_name: '{{resource_group}}'
        name: '{{app_name}}'
      fields:
      - path: properties.*
        operator: all_match_pattern
        expected: '@Microsoft.KeyVault\(SecretUri=https://.*\)'
  - check_id: azure.keyvault.paas_application_version.paas_app_version_artifact_encrypted
    title: 'AZURE AZURE Paas_application_version: Paas App Version Artifact Encrypted'
    severity: medium
    for_each: azure.keyvault.paas_application_versions
    calls:
    - action: self
      fields:
      - path: properties.encryption_settings.enabled
        operator: equals
        expected: true
      - path: properties.encryption_settings.key_vault_key_url
        operator: not_empty
        expected: true
  - check_id: azure.keyvault.privacy_anonymization.outputs_encrypted
    title: 'AZURE AZURE Privacy_anonymization: Outputs Encrypted'
    severity: medium
    for_each: azure.keyvault.vaults
    calls:
    - action: self
      fields:
      - path: properties.encryption.key_source
        operator: equals
        expected: Microsoft.KeyVault
      - path: properties.encryption.key_vault_properties.key_name
        operator: exists
        expected: true
  - check_id: azure.keyvault.privacy_consent.store_encrypted
    title: 'AZURE AZURE Privacy_consent: Store Encrypted'
    severity: medium
    for_each: azure.keyvault.vaults
    calls:
    - action: self
      fields:
      - path: properties.encryption.key_source
        operator: equals
        expected: Microsoft.KeyVault
      - path: properties.enabled_for_disk_encryption
        operator: equals
        expected: true
  - check_id: azure.keyvault.private_ca.private_ca_ca_key_in_hsm_where_supported
    title: 'AZURE AZURE Crypto_private_ca: Secrets Private Ca Ca Key In Hsm Where Supported'
    severity: high
    for_each: azure.keyvault.certificates
    calls:
    - action: certificates.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        certificate_name: '{{name}}'
      fields:
      - path: properties.key_properties.key_type
        operator: equals
        expected: RSA-HSM
      - path: properties.key_properties.reuse_key
        operator: equals
        expected: false
  - check_id: azure.keyvault.private_ca.private_ca_crl_or_ocsp
    title: 'AZURE AZURE Crypto_private_ca: Secrets Private Ca Crl Or Ocsp Configured'
    severity: high
    for_each: azure.keyvault.certificates
    calls:
    - action: certificates.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        certificate_name: '{{name}}'
      fields:
      - path: properties.policy.issuer_parameters.certificate_transparency
        operator: equals
        expected: true
      - path: properties.policy.x509_certificate_properties.validity_in_months
        operator: less_than
        expected: 13
  - check_id: azure.keyvault.private_ca.private_ca_path_length_constraints_set
    title: 'AZURE AZURE Crypto_private_ca: Secrets Private Ca Path Length Constraints Set'
    severity: high
    for_each: azure.keyvault.certificates
    calls:
    - action: certificates.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        certificate_name: '{{name}}'
      fields:
      - path: properties.policy.x509_certificate_properties.basic_constraints.ca
        operator: equals
        expected: true
      - path: properties.policy.x509_certificate_properties.basic_constraints.path_len_constraint
        operator: exists
        expected: true
  - check_id: azure.keyvault.public.network.access.disabled
    title: 'AZURE KEYVAULT Public: Network Access Disabled'
    severity: medium
    for_each: azure.keyvault.vaults
    calls:
    - action: self
      fields:
      - path: properties.network_acls.default_action
        operator: equals
        expected: Deny
      - path: properties.public_network_access
        operator: equals
        expected: Disabled
  - check_id: azure.keyvault.rbac.secrets.expiration.check
    title: 'AZURE KEYVAULT Rbac: Secrets Expiration Check'
    severity: high
    for_each: azure.keyvault.secrets
    calls:
    - action: secrets.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        secret_name: '{{secret_name}}'
      fields:
      - path: attributes.expires
        operator: exists
        expected: true
      - path: attributes.enabled
        operator: equals
        expected: true
  - check_id: azure.keyvault.secret.kms_key
    title: 'AZURE AZURE Secrets_parameter: KMS Key Configured'
    severity: high
    for_each: azure.keyvault.vaults
    calls:
    - action: self
      fields:
      - path: properties.encryption.key_source
        operator: equals
        expected: Microsoft.KeyVault
      - path: properties.encryption.key_vault_properties.key_name
        operator: exists
        expected: true
  - check_id: azure.keyvault.secret.rotation_enabled
    title: 'AZURE KEYVAULT Resource: Secret Rotation Enabled'
    severity: high
    for_each: azure.keyvault.secrets
    calls:
    - action: secrets.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        secret_name: '{{secret_name}}'
      fields:
      - path: attributes.expires
        operator: exists
        expected: true
      - path: attributes.not_before
        operator: exists
        expected: true
  - check_id: azure.keyvault.secret.secure_string_type_for_sensitive
    title: 'AZURE AZURE Secrets_parameter: Secure String Type For Sensitive'
    severity: medium
    for_each: azure.keyvault.secrets
    calls:
    - action: secrets.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        secret_name: '{{secret_name}}'
      fields:
      - path: content_type
        operator: equals
        expected: application/x-pkcs12
      - path: attributes.enabled
        operator: equals
        expected: true
  - check_id: azure.keyvault.secrets_secret.kms_key
    title: 'AZURE AZURE Secrets_secret: KMS Key Configured'
    severity: high
    for_each: azure.keyvault.secrets
    calls:
    - action: secrets.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        secret_name: '{{secret_name}}'
      fields:
      - path: managed
        operator: equals
        expected: true
      - path: attributes.enabled
        operator: equals
        expected: true
  - check_id: azure.keyvault.secrets_secret.no_plaintext_exposed_in_policy_or_tags
    title: 'AZURE AZURE Secrets_secret: No Plaintext Exposed In Policy Or Tags'
    severity: critical
    for_each: azure.keyvault.secrets
    calls:
    - action: self
      fields:
      - path: tags
        operator: not_contains_sensitive
        expected: true
      - path: value
        operator: not_exposed
        expected: true
  - check_id: azure.keyvault.secrets_secret.rotation_where_applicable
    title: 'AZURE AZURE Secrets_secret: Rotation Configured Where Applicable'
    severity: medium
    for_each: azure.keyvault.secrets
    calls:
    - action: secrets.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        secret_name: '{{secret_name}}'
      fields:
      - path: attributes.expires
        operator: exists
        expected: true
      - path: attributes.not_before
        operator: less_than_days_from_now
        expected: 90
  - check_id: azure.keyvault.secrets_store.kms_encryption_enabled
    title: 'AZURE AZURE Secrets_store: KMS Encryption Enabled'
    severity: high
    for_each: azure.keyvault.vaults
    calls:
    - action: self
      fields:
      - path: properties.encryption.key_source
        operator: equals
        expected: Microsoft.KeyVault
      - path: properties.enabled_for_disk_encryption
        operator: equals
        expected: true
  - check_id: azure.keyvault.secrets_store.rotation_enabled_for_rotatable_secrets
    title: 'AZURE AZURE Secrets_store: Rotation Enabled For Rotatable Secrets'
    severity: high
    for_each: azure.keyvault.secrets
    calls:
    - action: secrets.get
      params:
        resource_group_name: '{{resource_group}}'
        vault_name: '{{vault_name}}'
        secret_name: '{{secret_name}}'
      fields:
      - path: attributes.expires
        operator: exists
        expected: true
      - path: attributes.enabled
        operator: equals
        expected: true
  - check_id: azure.keyvault.vaults.purge.protection.status
    title: 'AZURE KEYVAULT Vaults: Purge Protection Status'
    severity: medium
    for_each: azure.keyvault.vaults
    calls:
    - action: self
      fields:
      - path: properties.enablePurgeProtection
        operator: equals
        expected: true
  - check_id: azure.keyvault.vault.logging_enabled
    title: 'AZURE KEYVAULT Resource: Logging Enabled'
    severity: medium
    for_each: azure.keyvault.resource
    calls:
    - action: monitor.diagnostic_settings.list
      fields:
      - path: value
        operator: not_empty
      - path: value[*].properties.logs[?(@.enabled==true)]
        operator: not_empty
  - check_id: azure.keyvault.private.endpoint.association.check
    title: 'AZURE KEYVAULT Private: Endpoint Association Check'
    severity: medium
    for_each: azure.keyvault.private
    calls:
    - action: self
      fields:
      - path: properties.privateEndpointConnections
        operator: not_empty
      - path: properties.privateEndpointConnections[*].properties.connectionState.status
        operator: equals
        expected: Approved
  - check_id: azure.keyvault.secret.access_rbac_least_privilege
    title: 'AZURE AZURE Secrets_parameter: Access RBAC Least Privilege'
    severity: high
    for_each: azure.keyvault.secrets_parameter
    calls:
    - action: authorization_client.role_assignments_list_for_scope
      fields:
      - path: properties.principal_type
        operator: not_equals
        expected: User
      - path: properties.role_definition_id
        operator: not_contains
        expected: /providers/Microsoft.Authorization/roleDefinitions/b86a8fe4-44ce-4948-aee5-eccb2c155cd7
      - path: properties.role_definition_id
        operator: not_contains
        expected: /providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635
  - check_id: azure.keyvault.secrets_store.access_rbac_least_privilege
    title: 'AZURE AZURE Secrets_store: Access RBAC Least Privilege'
    severity: high
    for_each: azure.keyvault.secrets_store
    calls:
    - action: authorization_client.role_assignments_list_for_scope
      fields:
      - path: properties.principal_type
        operator: not_equals
        expected: User
      - path: properties.role_definition_id
        operator: not_contains
        expected: /subscriptions/*/providers/Microsoft.Authorization/roleDefinitions/b86a8fe4-44ce-4948-aee5-eccb2c155cd7
    - action: self
      fields:
      - path: properties.access_policies
        operator: array_all
        conditions:
        - path: permissions.secrets
          operator: not_contains_all
          expected:
          - all
          - '*'
        - path: permissions.keys
          operator: not_contains_all
          expected:
          - all
          - '*'
        - path: permissions.certificates
          operator: not_contains_all
          expected:
          - all
          - '*'
  - check_id: azure.keyvault.vault.private_endpoints_enabled
    title: 'AZURE KEYVAULT Resource: Private Endpoints'
    severity: low
    for_each: azure.keyvault.resource
    calls:
    - action: self
      fields:
      - path: properties.private_endpoint_connections
        operator: not_empty
        expected: true
  - check_id: azure.keyvault.rbac.authorization.enabled
    title: 'AZURE KEYVAULT Rbac: Authorization Enabled'
    severity: medium
    for_each: azure.keyvault.vaults
    calls:
    - action: self
      fields:
      - path: properties.enableRbacAuthorization
        operator: equals
        expected: true
  - check_id: azure.keyvault.diagnostic.logging.check
    title: 'AZURE KEYVAULT Diagnostic: Logging Check'
    severity: medium
    for_each: azure.keyvault.diagnostic
    calls:
    - action: self
      fields:
      - path: logs
        operator: not_empty
      - path: logs[*].enabled
        operator: equals
        expected: true
      - path: logs[*].category
        operator: contains_any
        expected:
        - AuditEvent
        - AzurePolicyEvaluationDetails
  - check_id: azure.keyvault.private_ca.private_ca_ca_access_rbac_least_privilege
    title: 'AZURE AZURE Crypto_private_ca: Secrets Private Ca Ca Access RBAC Least Privilege'
    severity: high
    for_each: azure.keyvault.crypto_private_ca
    calls:
    - action: authorization_client.role_assignments_list_for_scope
      fields:
      - path: value[*].properties.roleDefinitionId
        operator: not_contains
        expected: /subscriptions/*/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635
      - path: value[*].properties.roleDefinitionId
        operator: not_contains
        expected: /subscriptions/*/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9
      - path: value[*].properties.principalType
        operator: not_equals
        expected: ServicePrincipal
