version: '1.0'
provider: azure
service: keyvault
discovery:
- discovery_id: azure.keyvault.list_vaults
  calls:
  - action: list_by_subscription
    save_as: list_vaults_response
  emit:
    items_for: '{{ list_vaults_response.value }}'
    as: item
    item:
      id: '{{ item.id }}'
      name: '{{ item.name }}'
      type: '{{ item.type }}'
      location: '{{ item.location }}'
      tags: '{{ item.tags }}'
      system_data: '{{ item.system_data }}'
      properties: '{{ item.properties }}'

checks:
- rule_id: azure.keyvault.vault.soft_delete_enabled
  for_each: azure.keyvault.list_vaults
  conditions:
    var: item.properties.enable_soft_delete
    op: equals
    value: true

- rule_id: azure.keyvault.vault.purge_protection_enabled
  for_each: azure.keyvault.list_vaults
  conditions:
    var: item.properties.enable_purge_protection
    op: equals
    value: true

- rule_id: azure.keyvault.vault.rbac_authorization_enabled
  for_each: azure.keyvault.list_vaults
  conditions:
    var: item.properties.enable_rbac_authorization
    op: equals
    value: true

- rule_id: azure.keyvault.vault.public_network_access_disabled
  for_each: azure.keyvault.list_vaults
  conditions:
    var: item.properties.public_network_access
    op: equals
    value: Disabled

- rule_id: azure.keyvault.vault.soft_delete_retention_90_days
  for_each: azure.keyvault.list_vaults
  conditions:
    var: item.properties.soft_delete_retention_in_days
    op: gte
    value: 90

- rule_id: azure.keyvault.vault.has_tags
  for_each: azure.keyvault.list_vaults
  conditions:
    var: item.tags
    op: not_empty

- rule_id: azure.keyvault.vault.private_endpoint_configured
  for_each: azure.keyvault.list_vaults
  conditions:
    var: item.properties.private_endpoint_connections
    op: not_empty

