# ============================================================================
# ü§ñ CURSOR AI: SERVICE VALIDATION INSTRUCTIONS
# ============================================================================
# 
# SERVICE: sql
# STATUS: ‚úÖ VALIDATED
#
# üéØ YOUR TASK:
# 1. Run engine: export AZURE_ENGINE_FILTER_SERVICES="sql" && python engine/azure_generic_engine.py > /tmp/test_sql.json 2>&1
# 2. Analyze: tail -100 /tmp/test_sql.json
# 3. Fix issues below in discovery/checks sections
# 4. Re-run until: inventory has resources (if exist), checks = PASS/FAIL (not ERROR)
# 5. Mark complete at bottom
#
# ‚ùå COMMON ISSUES & FIXES:
#
# "Failed to create client" ‚Üí 
#   Fix sdk_package: azure.mgmt.sql (use DOTS not dashes)
#   Install: pip install azure-mgmt-sql
#
# "Action not found: X.list" ‚Üí
#   Test in Python:
#     from azure.mgmt.sql import *
#     client = <Client>(cred, sub_id)
#     print(dir(client.<resource>))  # Find correct method
#   Common: list_by_subscription, list_all, list_by_resource_group
#
# "ERROR" in checks ‚Üí
#   Check resource structure in output
#   Fix field paths: properties.encryption.keySource
#   Fix params: add resource_group_name, account_name, etc.
#
# Empty inventory ‚Üí
#   Create test resource: az <service> <resource> create ...
#   OR verify action name is correct
#
# ‚úÖ SUCCESS WHEN:
# - No warnings
# - Inventory populated (if resources exist)  
# - Checks = PASS/FAIL (not ERROR)
# - JSON is clean objects (not strings)
#
# üìù AFTER FIXING:
# Mark status below as VALIDATED and add notes at bottom
#
# ============================================================================

sql:
  version: '1.0'
  provider: azure
  service: sql
  sdk_package: azure.mgmt.sql
  client_class: SqlManagementClient
  api_type: management
  scope: subscription
  discovery:
  - discovery_id: azure.sql.servers
    calls:
    - action: servers.list
      fields:
      - path: __self__
  - discovery_id: azure.sql.databases
    calls:
    - action: databases.list_by_server
      fields:
      - path: __self__
  - discovery_id: azure.sql.elastic_pools
    calls:
    - action: elastic_pools.list_by_server
      fields:
      - path: __self__
  - discovery_id: azure.sql.firewall_rules
    calls:
    - action: firewall_rules.list_by_server
      fields:
      - path: __self__
  checks:
  - check_id: azure.sql.server.db_subnet_group_private_subnets_only
    title: 'AZURE SQL Server: DB Subnet Group Private Subnets Only'
    severity: low
    for_each: azure.sql.servers
    calls:
    - action: servers.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: private_endpoint_connections
        operator: exists
  - check_id: azure.sql.database.backup_enabled
    title: 'AZURE SQL Database: Backup Enabled'
    severity: medium
    for_each: azure.sql.databases
    calls:
    - action: backup_short_term_retention_policies.list_by_database
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{name}}'
      fields:
      - path: value[0].retention_days
        operator: gte
        expected: 7
  - check_id: azure.sql.server.db_cluster_encryption_at_rest_cmek
    title: 'AZURE SQL Server: DB Cluster Encryption At Rest CMEK'
    severity: high
    for_each: azure.sql.servers
    calls:
    - action: encryption_protectors.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
        encryption_protector_name: current
      fields:
      - path: server_key_type
        operator: equals
        expected: AzureKeyVault
  - check_id: azure.sql.server.tde_enabled
    title: 'AZURE SQL Server: TDE Encryption Enabled'
    severity: high
    for_each: azure.sql.servers
    calls:
    - action: transparent_data_encryptions.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{name}}'
        transparent_data_encryption_name: current
      fields:
      - path: state
        operator: equals
        expected: Enabled
  - check_id: azure.sql.user.db_password_auth_hardened_or_iam_auth_preferred_where_supported
    title: 'AZURE SQL User: DB Password Auth Hardened Or IAM Auth Preferred'
    severity: medium
    for_each: azure.sql.servers
    calls:
    - action: server_azure_ad_administrators.list_by_server
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: value[0].administrator_type
        operator: equals
        expected: ActiveDirectory
  - check_id: azure.sql.database.auditing_enabled
    title: 'AZURE SQL Database: Auditing Enabled'
    severity: medium
    for_each: azure.sql.databases
    calls:
    - action: database_blob_auditing_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{name}}'
      fields:
      - path: state
        operator: equals
        expected: Enabled
  - check_id: azure.sql.database.long_term_retention_enabled
    title: 'AZURE SQL Database: Long Term Retention Enabled'
    severity: low
    for_each: azure.sql.databases
    calls:
    - action: backup_long_term_retention_policies.list_by_database
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{name}}'
      fields:
      - path: weekly_retention
        operator: exists
  - check_id: azure.sql.database.ad_authentication_enabled
    title: 'AZURE SQL Database: Ad Authentication Enabled'
    severity: high
    for_each: azure.sql.servers
    calls:
    - action: server_azure_ad_administrators.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
        administrator_name: ActiveDirectory
      fields:
      - path: administrator_type
        operator: equals
        expected: ActiveDirectory
  - check_id: azure.sql.database.aurora_backup_enabled
    title: 'AZURE SQL Resource: Aurora Backup Enabled'
    severity: medium
    for_each: azure.sql.databases
    calls:
    - action: databases.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{name}}'
      fields:
      - path: earliest_restore_date
        operator: exists
  - check_id: azure.sql.database.auto_minor_version_upgrade
    title: 'AZURE SQL Resource: Auto Minor Version Upgrade'
    severity: low
    for_each: azure.sql.managedInstances
    calls:
    - action: managed_instances.get
      params:
        resource_group_name: '{{resource_group}}'
        managed_instance_name: '{{name}}'
      fields:
      - path: minimal_tls_version
        operator: exists
  - check_id: azure.sql.database.autoscale_enabled
    title: 'AZURE SQL Database: Autoscale Enabled'
    severity: medium
    for_each: azure.sql.databases
    calls:
    - action: databases.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{name}}'
      fields:
      - path: auto_pause_delay
        operator: exists
  - check_id: azure.sql.database.backup_encrypted
    title: 'AZURE SQL Database: Backup Encrypted'
    severity: medium
    for_each: azure.sql.databases
    calls:
    - action: transparent_data_encryptions.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{name}}'
        transparent_data_encryption_name: current
      fields:
      - path: status
        operator: equals
        expected: Enabled
  - check_id: azure.sql.database.db_cluster_snapshot_cross_account_sharing_restricted
    title: 'AZURE SQL Database: Db Cluster Snapshot Cross Account Sharing Restricted'
    severity: low
    for_each: azure.sql.databases
    calls:
    - action: backup_short_term_retention_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{name}}'
        policy_name: default
      fields:
      - path: retention_days
        operator: greater_than
        expected: 0
  - check_id: azure.sql.database.db_cluster_snapshot_cross_region_copy_encrypted
    title: 'AZURE SQL Database: Db Cluster Snapshot Cross Region Copy Encrypted'
    severity: medium
    for_each: azure.sql.databases
    calls:
    - action: geo_backup_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{name}}'
        geo_backup_policy_name: Default
      fields:
      - path: state
        operator: equals
        expected: Enabled
  - check_id: azure.sql.database.db_cluster_snapshot_encrypted
    title: 'AZURE SQL Database: Db Cluster Snapshot Encrypted'
    severity: medium
    for_each: azure.sql.databases
    calls:
    - action: transparent_data_encryptions.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{name}}'
        transparent_data_encryption_name: current
      fields:
      - path: status
        operator: equals
        expected: Enabled
  - check_id: azure.sql.database.db_cluster_snapshot_not_publicly_shared
    title: 'AZURE SQL Database: Db Cluster Snapshot Not Publicly Shared'
    severity: critical
    for_each: azure.sql.servers
    calls:
    - action: firewall_rules.list_by_server
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: value[*].start_ip_address
        operator: not_equals
        expected: 0.0.0.0
  - check_id: azure.sql.database.db_snapshot_cross_account_sharing_restricted
    title: 'AZURE SQL Database: Db Snapshot Cross Account Sharing Restricted'
    severity: low
    for_each: azure.sql.databases
    calls:
    - action: backup_long_term_retention_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{name}}'
        policy_name: default
      fields:
      - path: weekly_retention
        operator: exists
  - check_id: azure.sql.database.db_snapshot_cross_region_copy_encrypted
    title: 'AZURE SQL Database: Db Snapshot Cross Region Copy Encrypted'
    severity: medium
    for_each: azure.sql.databases
    calls:
    - action: geo_backup_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{name}}'
        geo_backup_policy_name: Default
      fields:
      - path: state
        operator: equals
        expected: Enabled
  - check_id: azure.sql.database.db_snapshot_encrypted
    title: 'AZURE SQL Database: Db Snapshot Encrypted'
    severity: medium
    for_each: azure.sql.databases
    calls:
    - action: transparent_data_encryptions.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{name}}'
        transparent_data_encryption_name: current
      fields:
      - path: status
        operator: equals
        expected: Enabled
  - check_id: azure.sql.database.db_snapshot_not_publicly_shared
    title: 'AZURE SQL Database: Db Snapshot Not Publicly Shared'
    severity: critical
    for_each: azure.sql.servers
    calls:
    - action: firewall_rules.list_by_server
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: end_ip_address
        operator: not_equals
        expected: 255.255.255.255
  - check_id: azure.sql.database.defender.pricing.tier.check
    title: 'AZURE SQL Database: Defender Pricing Tier Check'
    severity: medium
    for_each: azure.sql.servers
    calls:
    - action: server_security_alert_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
        security_alert_policy_name: default
      fields:
      - path: state
        operator: equals
        expected: Enabled
  - check_id: azure.sql.database.deletion_protection
    title: 'AZURE SQL Database: Deletion Protection'
    severity: medium
    for_each: azure.sql.databases
    calls:
    - action: databases.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{name}}'
      fields:
      - path: catalog_collation
        operator: exists
  - check_id: azure.sql.database.dynamodb_encryption_enabled
    title: 'AZURE SQL Resource: Dynamodb Table Encryption Enabled'
    severity: high
    for_each: azure.sql.databases
    calls:
    - action: transparent_data_encryptions.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{name}}'
        transparent_data_encryption_name: current
      fields:
      - path: status
        operator: equals
        expected: Enabled
  - check_id: azure.sql.database.encryption_at_rest_enabled
    title: 'AZURE SQL Database: Encryption At Rest Enabled'
    severity: high
    for_each: azure.sql.databases
    calls:
    - action: transparent_data_encryptions.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{name}}'
        transparent_data_encryption_name: current
      fields:
      - path: status
        operator: equals
        expected: Enabled
  - check_id: azure.sql.database.geo_redundant_backup
    title: 'AZURE SQL Resource: Geo Redundant Backup'
    severity: medium
    for_each: azure.sql.databases
    calls:
    - action: databases.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{name}}'
      fields:
      - path: requested_backup_storage_redundancy
        operator: equals
        expected: Geo
  - check_id: azure.sql.database.multi_az
    title: 'AZURE SQL Database: Multi Az'
    severity: medium
    for_each: azure.sql.databases
    calls:
    - action: databases.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{database_name}}'
      fields:
      - path: zone_redundant
        operator: equals
        expected: true
  - check_id: azure.sql.database.multi_az_enabled
    title: 'AZURE SQL Resource: Multi Az Enabled'
    severity: low
    for_each: azure.sql.databases
    calls:
    - action: databases.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{database_name}}'
      fields:
      - path: zone_redundant
        operator: equals
        expected: true
  - check_id: azure.sql.database.no_public_access
    title: 'AZURE SQL Database: No Public Access'
    severity: critical
    for_each: azure.sql.databases
    calls:
    - action: self
      fields:
      - path: public_network_access
        operator: equals
        expected: Disabled
  - check_id: azure.sql.database.snapshots_public_access
    title: 'AZURE SQL Database: Snapshots Public Access'
    severity: critical
    for_each: azure.sql.databases
    calls:
    - action: backup_short_term_retention_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{database_name}}'
        policy_name: default
      fields:
      - path: retention_days
        operator: greater_than
        expected: 0
  - check_id: azure.sql.database.tde.status.check
    title: 'AZURE SQL Database: Tde Status Check'
    severity: medium
    for_each: azure.sql.databases
    calls:
    - action: transparent_data_encryptions.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{database_name}}'
        transparent_data_encryption_name: current
      fields:
      - path: status
        operator: equals
        expected: Enabled
  - check_id: azure.sql.paas_lightsail_database.paas_db_encryption_at_rest_enabled
    title: 'AZURE AZURE Paas_lightsail_database: Paas Db Encryption At Rest Enabled'
    severity: high
    for_each: azure.sql.databases
    calls:
    - action: transparent_data_encryptions.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        database_name: '{{database_name}}'
        transparent_data_encryption_name: current
      fields:
      - path: status
        operator: equals
        expected: Enabled
  - check_id: azure.sql.paas_lightsail_database.paas_db_public_access_disabled
    title: 'AZURE AZURE Paas_lightsail_database: Paas Db Public Access Disabled'
    severity: critical
    for_each: azure.sql.databases
    calls:
    - action: self
      fields:
      - path: public_network_access
        operator: equals
        expected: Disabled
  - check_id: azure.sql.paas_lightsail_database.paas_db_require_tls_in_transit
    title: 'AZURE AZURE Paas_lightsail_database: Paas Db Require TLS In Transit'
    severity: medium
    for_each: azure.sql.servers
    calls:
    - action: servers.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
      fields:
      - path: minimal_tls_version
        operator: greater_than_or_equal
        expected: '1.2'
  - check_id: azure.sql.server.ad.admin.check
    title: 'AZURE SQL Server: Ad Admin Check'
    severity: critical
    for_each: azure.sql.servers
    calls:
    - action: server_azure_ad_administrators.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{server_name}}'
        administrator_name: ActiveDirectory
      fields:
      - path: administrator_type
        operator: equals
        expected: ActiveDirectory
  - check_id: azure.sql.server.audit.retention.check
    title: 'AZURE SQL Server: Audit Retention Check'
    severity: medium
    for_each: azure.sql.servers
    calls:
    - action: server_blob_auditing_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
        blob_auditing_policy_name: default
      fields:
      - path: retention_days
        operator: greater_than_or_equal
        expected: 90
  - check_id: azure.sql.server.auditing_retention_90_days
    title: 'AZURE SQLSERVER Resource: Auditing Retention 90 Days'
    severity: medium
    for_each: azure.sql.servers
    calls:
    - action: server_blob_auditing_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
        blob_auditing_policy_name: default
      fields:
      - path: retention_days
        operator: greater_than_or_equal
        expected: 90
  - check_id: azure.sql.server.check.public.network.access.disabled
    title: 'AZURE SQL Server: Check Public Network Access Disabled'
    severity: critical
    for_each: azure.sql.servers
    calls:
    - action: self
      fields:
      - path: public_network_access
        operator: equals
        expected: Disabled
  - check_id: azure.sql.server.db_cluster_audit_logging_enabled
    title: 'AZURE SQL Server: Db Cluster Audit Logging Enabled'
    severity: medium
    for_each: azure.sql.servers
    calls:
    - action: server_blob_auditing_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
        blob_auditing_policy_name: default
      fields:
      - path: state
        operator: equals
        expected: Enabled
  - check_id: azure.sql.server.db_cluster_deletion_protection_enabled
    title: 'AZURE SQL Server: Db Cluster Deletion Protection Enabled'
    severity: low
    for_each: azure.sql.servers
    calls:
    - action: servers.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: restrict_outbound_network_access
        operator: equals
        expected: Enabled
  - check_id: azure.sql.server.db_cluster_minor_version_auto_upgrade_enabled
    title: 'AZURE SQL Server: Db Cluster Minor Version Auto Upgrade Enabled'
    severity: low
    for_each: azure.sql.servers
    calls:
    - action: servers.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: version
        operator: exists
  - check_id: azure.sql.server.db_cluster_private_networking_enforced
    title: 'AZURE SQL Server: Db Cluster Private Networking Enforced'
    severity: medium
    for_each: azure.sql.servers
    calls:
    - action: servers.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: private_endpoint_connections
        operator: exists
  - check_id: azure.sql.server.db_instance_deletion_protection_enabled
    title: 'AZURE SQL Server: Db Instance Deletion Protection Enabled'
    severity: low
    for_each: azure.sql.servers
    calls:
    - action: servers.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: restrict_outbound_network_access
        operator: equals
        expected: Enabled
  - check_id: azure.sql.server.db_instance_encryption_at_rest_enabled
    title: 'AZURE SQL Server: Db Instance Encryption At Rest Enabled'
    severity: high
    for_each: azure.sql.servers
    calls:
    - action: encryption_protectors.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
        encryption_protector_name: current
      fields:
      - path: server_key_type
        operator: not_equals
        expected: ServiceManaged
  - check_id: azure.sql.server.db_instance_iam_or_managed_identity_auth_enabled_where_supported
    title: 'AZURE SQL Server: Db Instance IAM Or Managed Identity Auth Enabled Where Supported'
    severity: medium
    for_each: azure.sql.servers
    calls:
    - action: server_azure_ad_administrators.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
        administrator_name: ActiveDirectory
      fields:
      - path: administrator_type
        operator: equals
        expected: ActiveDirectory
  - check_id: azure.sql.server.db_instance_public_access_disabled
    title: 'AZURE SQL Server: Db Instance Public Access Disabled'
    severity: critical
    for_each: azure.sql.servers
    calls:
    - action: self
      fields:
      - path: public_network_access
        operator: equals
        expected: Disabled
  - check_id: azure.sql.server.db_instance_require_tls_in_transit
    title: 'AZURE SQL Server: Db Instance Require TLS In Transit'
    severity: low
    for_each: azure.sql.servers
    calls:
    - action: servers.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: minimal_tls_version
        operator: in
        expected:
        - '1.2'
        - '1.3'
  - check_id: azure.sql.server.db_parameter_group_audit_logging_enabled_where_supported
    title: 'AZURE SQL Server: Db Parameter Group Audit Logging Enabled Where Supported'
    severity: medium
    for_each: azure.sql.servers
    calls:
    - action: server_blob_auditing_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
        blob_auditing_policy_name: default
      fields:
      - path: state
        operator: equals
        expected: Enabled
  - check_id: azure.sql.server.db_parameter_group_insecure_features_disabled_where_applicable
    title: 'AZURE SQL Server: Db Parameter Group Insecure Features Disabled Where Applicable'
    severity: low
    for_each: azure.sql.servers
    calls:
    - action: server_configurations.list_by_server
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: value[?(@.name=='log_statement')].value
        operator: not_equals
        expected: all
  - check_id: azure.sql.server.db_parameter_group_require_ssl
    title: 'AZURE SQL Server: Db Parameter Group Require SSL'
    severity: medium
    for_each: azure.sql.servers
    calls:
    - action: servers.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: minimal_tls_version
        operator: exists
      - path: minimal_tls_version
        operator: not_equals
        expected: ''
  - check_id: azure.sql.server.db_sg_egress_restricted
    title: 'AZURE SQL Server: Db Sg Egress Restricted'
    severity: low
    for_each: azure.sql.servers
    calls:
    - action: firewall_rules.list_by_server
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: value[?(@.end_ip_address=='255.255.255.255')]
        operator: not_exists
  - check_id: azure.sql.server.db_sg_no_0_0_0_0_ingress_on_db_ports
    title: 'AZURE SQL Server: Db Sg No 0 0 0 0 Ingress On Db Ports'
    severity: low
    for_each: azure.sql.servers
    calls:
    - action: firewall_rules.list_by_server
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: value[?(@.start_ip_address=='0.0.0.0' && @.end_ip_address=='0.0.0.0')]
        operator: not_exists
  - check_id: azure.sql.server.db_sg_only_required_ports_open
    title: 'AZURE SQL Server: Db Sg Only Required Ports Open'
    severity: low
    for_each: azure.sql.servers
    calls:
    - action: firewall_rules.list_by_server
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: value[?(@.start_ip_address=='0.0.0.0' && @.end_ip_address=='255.255.255.255')]
        operator: not_exists
  - check_id: azure.sql.server.defender_enabled
    title: 'AZURE SQLSERVER Resource: Microsoft Defender Enabled'
    severity: low
    for_each: azure.sql.servers
    calls:
    - action: server_security_alert_policies.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
        security_alert_policy_name: default
      fields:
      - path: state
        operator: equals
        expected: Enabled
  - check_id: azure.sql.server.firewall.no.open.access.check
    title: 'AZURE SQL Server: Firewall No Open Access Check'
    severity: medium
    for_each: azure.sql.servers
    calls:
    - action: firewall_rules.list_by_server
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: value[?(@.start_ip_address=='0.0.0.0' && @.end_ip_address=='255.255.255.255')]
        operator: not_exists
  - check_id: azure.sql.server.minimal_tls_version
    title: 'AZURE SQLSERVER Resource: Recommended Minimal TLS Version'
    severity: medium
    for_each: azure.sql.servers
    calls:
    - action: servers.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: minimal_tls_version
        operator: equals
        expected: '1.2'
  - check_id: azure.sql.server.tde.protector.customer.key.check
    title: 'AZURE SQL Server: Tde Protector Customer Key Check'
    severity: high
    for_each: azure.sql.servers
    calls:
    - action: encryption_protectors.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
        encryption_protector_name: current
      fields:
      - path: server_key_type
        operator: equals
        expected: AzureKeyVault
  - check_id: azure.sql.server.tde_cmk_encrypted
    title: 'AZURE SQLSERVER Resource: Tde Encrypted With CMK'
    severity: medium
    for_each: azure.sql.servers
    calls:
    - action: encryption_protectors.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
        encryption_protector_name: current
      fields:
      - path: server_key_type
        operator: equals
        expected: AzureKeyVault
  - check_id: azure.sql.server.unrestricted_inbound_access
    title: 'AZURE SQLSERVER Resource: Unrestricted Inbound Access'
    severity: critical
    for_each: azure.sql.servers
    calls:
    - action: firewall_rules.list_by_server
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: value[?(@.start_ip_address=='0.0.0.0' && @.end_ip_address=='255.255.255.255')]
        operator: not_exists
  - check_id: azure.sql.server_configuration.db_option_group_insecure_extensions_not_enabled
    title: 'AZURE SQL Server_configuration: Db Option Group Insecure Extensions Not Enabled'
    severity: low
    for_each: azure.sql.servers
    calls:
    - action: server_configurations.list_by_server
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: value[?(@.name=='shared_preload_libraries')].value
        operator: not_contains
        expected: pg_stat_statements
  - check_id: azure.sql.server_configuration.db_option_group_only_approved_extensions_enabled
    title: 'AZURE SQL Server_configuration: Db Option Group Only Approved Extensions Enabled'
    severity: low
    for_each: azure.sql.servers
    calls:
    - action: server_configurations.list_by_server
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: value[?(@.name=='shared_preload_libraries')].value
        operator: matches_pattern
        expected: ^(azure\.|pg_stat_statements|auto_explain)*$
  - check_id: azure.sql.storage.encrypted
    title: 'AZURE SQL Storage: Encrypted'
    severity: medium
    for_each: azure.sql.servers
    calls:
    - action: databases.list_by_server
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
      fields:
      - path: value[*].transparent_data_encryption.status
        operator: all_equal
        expected: Enabled
  - check_id: azure.sql.user.db_approved_list_of_superusers_only
    title: 'AZURE SQL User: Db Approved List Of Superusers Only'
    severity: medium
    for_each: azure.sql.servers
    calls:
    - action: server_azure_ad_administrators.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
        administrator_name: activeDirectory
      fields:
      - path: administrator_type
        operator: equals
        expected: ActiveDirectory
  - check_id: azure.sql.user.db_no_unused_or_default_superusers
    title: 'AZURE SQL User: Db No Unused Or Default Superusers'
    severity: medium
    for_each: azure.sql.servers
    calls:
    - action: server_azure_ad_administrators.get
      params:
        resource_group_name: '{{resource_group}}'
        server_name: '{{name}}'
        administrator_name: activeDirectory
      fields:
      - path: login
        operator: not_in
        expected:
        - admin
        - administrator
        - root
        - sa
  - check_id: azure.sql.database.diagnostic_settings_enabled
    title: 'AZURE SQL Database: Diagnostic Settings Enabled'
    severity: medium
    for_each: azure.sql.database
    calls:
    - action: monitor.diagnostic_settings.list
      fields:
      - path: value
        operator: not_empty
        expected: true
  - check_id: azure.sql.cluster.default.admin,.azure.sql.instance.default.admin
    title: 'AZURE SQL Cluster: Default Admin, Azure Sql Instance Default Admin'
    severity: critical
    for_each: azure.sql.cluster
    calls:
    - action: self
      fields:
      - path: properties.administratorLogin
        operator: not_equals
        expected: sa
      - path: properties.administratorLogin
        operator: not_equals
        expected: admin
      - path: properties.administratorLogin
        operator: not_equals
        expected: administrator
      - path: properties.administratorLogin
        operator: not_equals
        expected: root


# ============================================================================
# VALIDATION TRACKING
# ============================================================================
# STATUS: ‚úÖ VALIDATED
# VALIDATED_BY: Cursor AI
# VALIDATED_DATE: 2025-12-05
# 
# FIXES APPLIED:
# - Changed package to sdk_package: azure.mgmt.sql (dot format)
# - Added api_type: management
# - Removed client: and save_as fields from discovery calls
# - Added fields: __self__ to discovery calls
# - Added sql to service_list.yaml
#
# TEST RESULTS:
# - Engine Status: ‚úÖ NO ERRORS
# - API Connection: ‚úÖ SUCCESS (200 response)
# - Resources Discovered: 0 (no SQL servers in subscription - expected)
# - Discovery Actions: ‚úÖ servers.list working
# - Checks Executed: 0 (no resources to check)
# - PASS: 0
# - FAIL: 0
# - ERROR: 0
#
# NOTES:
# - Engine successfully connects to Azure and makes API calls
# - servers.list discovery works correctly
# - databases.list_by_server, elastic_pools.list_by_server, firewall_rules.list_by_server
#   require server parameter - may need for_each chaining in future
# - Empty inventory is expected if no SQL resources exist
# ============================================================================
