version: '1.0'
provider: azure
service: api
discovery:
- discovery_id: azure.api.list
  calls:
  - action: list
    save_as: list_response
  emit:
    items_for: '{{ list_response.value }}'
    as: item
    item:
      id: '{{ item.id }}'
      name: '{{ item.name }}'
      type: '{{ item.type }}'
      tags: '{{ item.tags }}'
      sku: '{{ item.sku }}'
      system_data: '{{ item.system_data }}'
      location: '{{ item.location }}'
      etag: '{{ item.etag }}'
      provisioning_state: '{{ item.provisioning_state }}'
      target_provisioning_state: '{{ item.target_provisioning_state }}'
      created_at_utc: '{{ item.created_at_utc }}'
      frontend: '{{ item.frontend }}'
      backend: '{{ item.backend }}'
      configuration_api: '{{ item.configuration_api }}'
      virtual_network_type: '{{ item.virtual_network_type }}'
checks:
- rule_id: azure.api.authorization_policy.tls_min_1_2_enforced
  for_each: azure.api.list
  conditions:
    var: item.virtual_network_type
    op: equals
    value: Enabled
- rule_id: azure.api.authorization_policy.token_audience_restricted
  for_each: azure.api.list
  conditions:
    var: item.virtual_network_type
    op: equals
    value: Succeeded
- rule_id: azure.api.api_endpoint.private_networking_enforced
  for_each: azure.api.list
  conditions:
    var: item.virtual_network_type
    op: equals
    value: Private
- rule_id: azure.api.api_endpoint.waf_attached
  for_each: azure.api.list
  conditions:
    var: item.virtual_network_type
    op: not_empty
- rule_id: azure.api.management_rate_limit_policy.rate_limiting_api_stage_throttle_overrides_not_unbounded
  for_each: azure.api.list
  conditions:
    var: item.virtual_network_type
    op: not_empty
- rule_id: azure.api.management_validation_policy.validation_api_content_type_whitelist_enforced
  for_each: azure.api.list
  conditions:
    var: item.virtual_network_type
    op: equals
    value: Enabled
- rule_id: azure.api.management_validation_policy.validation_api_response_schema_validation_enabled
  for_each: azure.api.list
  conditions:
    var: item.target_provisioning_state
    op: equals
    value: Enabled
- rule_id: azure.api.management_validation_policy.validation_api_request_schema_validation_enabled
  for_each: azure.api.list
  conditions:
    var: item.target_provisioning_state
    op: equals
    value: Enabled
- rule_id: azure.api.management_restapi_waf_acl_attached:az.api_management_monitoring.api_security_monitoring_api_access_logging_enabled
  for_each: azure.api.list
  conditions:
    var: item.target_provisioning_state
    op: equals
    value: Enabled
- rule_id: azure.api.subscription_key.expiration_required
  for_each: azure.api.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.api.management_rate_limit_policy.rate_limiting_api_stage_burst_limit_configured
  for_each: azure.api.list
  conditions:
    var: item.configuration_api
    op: not_empty
- rule_id: azure.api.subscription_key.rotation_policy_defined
  for_each: azure.api.list
  conditions:
    var: item.virtual_network_type
    op: not_empty
- rule_id: azure.api.management_monitoring.monitoring_api_access_log_fields_identity_present
  for_each: azure.api.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.api.subscription_key.scopes_least_privilege
  for_each: azure.api.list
  conditions:
    var: item.virtual_network_type
    op: equals
    value: Succeeded
- rule_id: azure.api.management_validation_policy.validation_api_request_body_size_limit_configured
  for_each: azure.api.list
  conditions:
    var: item.configuration_api
    op: not_empty
- rule_id: azure.api.management_rate_limit_policy.rate_limiting_api_stage_rate_limit_configured
  for_each: azure.api.list
  conditions:
    var: item.virtual_network_type
    op: not_empty
- rule_id: azure.api.api_version.throttling_enabled
  for_each: azure.api.list
  conditions:
    var: item.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.api.management_monitoring.monitoring_api_logs_retention_days_minimum
  for_each: azure.api.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.api.api_endpoint.authz_policies_enforced
  for_each: azure.api.list
  conditions:
    var: item.virtual_network_type
    op: not_empty
- rule_id: azure.api.api_version.logging_enabled
  for_each: azure.api.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.api.management_monitoring.monitoring_api_access_logging_enabled
  for_each: azure.api.list
  conditions:
    var: item.configuration_api
    op: not_empty
- rule_id: azure.api.management_rate_limit_policy.rate_limiting_api_usage_plan_required_for_api_keys
  for_each: azure.api.list
  conditions:
    var: item.virtual_network_type
    op: not_empty
- rule_id: azure.api.management_rate_limit_policy.rate_limiting_api_quota_limit_configured
  for_each: azure.api.list
  conditions:
    var: item.virtual_network_type
    op: not_empty
- rule_id: azure.api.management_monitoring.monitoring_api_access_log_sink_configured
  for_each: azure.api.list
  conditions:
    var: item.configuration_api
    op: not_empty
- rule_id: azure.api.management_validation_policy.validation_api_parameters_validation_enabled
  for_each: azure.api.list
  conditions:
    var: item.configuration_api
    op: not_empty
- rule_id: azure.api.authorization_policy.cache_ttl_reasonable
  for_each: azure.api.list
  conditions:
    var: item.virtual_network_type
    op: equals
    value: Succeeded
- rule_id: azure.api.api_version.require_usage_plan_for_api_keys
  for_each: azure.api.list
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.api.management_validation_policy.validation_api_required_security_headers_enforced
  for_each: azure.api.list
  conditions:
    var: item.virtual_network_type
    op: equals
    value: Enabled
- rule_id: azure.api.management_monitoring.monitoring_api_execution_logging_level_minimum_error
  for_each: azure.api.list
  conditions:
    var: item.configuration_api
    op: contains
    value: Error
- rule_id: azure.api.management_authorization_enabled:az.api_management_rate_limit_policy.api_security_rate_limiting_api_stage_throttle_overrides_not_unbounded
  for_each: azure.api.list
  conditions:
    var: item.configuration_api
    op: not_empty
- rule_id: azure.api.api_endpoint.authn_required
  for_each: azure.api.list
  conditions:
    var: item.virtual_network_type
    op: equals
    value: Enabled
