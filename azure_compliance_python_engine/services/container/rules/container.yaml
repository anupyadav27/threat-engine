version: '1.0'
provider: azure
service: container
discovery:
- discovery_id: azure.container.list
  calls:
  - action: list
    save_as: list_response
  emit:
    items_for: '{{ list_response.value }}'
    as: item
    item:
      identity: '{{ item.identity }}'
      provisioning_state: '{{ item.provisioning_state }}'
      containers: '{{ item.containers }}'
      image_registry_credentials: '{{ item.image_registry_credentials }}'
      restart_policy: '{{ item.restart_policy }}'
      ip_address: '{{ item.ip_address }}'
      os_type: '{{ item.os_type }}'
      volumes: '{{ item.volumes }}'
      instance_view: '{{ item.instance_view }}'
      diagnostics: '{{ item.diagnostics }}'
      subnet_ids: '{{ item.subnet_ids }}'
      dns_config: '{{ item.dns_config }}'
      sku: '{{ item.sku }}'
      encryption_properties: '{{ item.encryption_properties }}'
      init_containers: '{{ item.init_containers }}'
      extensions: '{{ item.extensions }}'
      confidential_compute_properties: '{{ item.confidential_compute_properties }}'
      priority: '{{ item.priority }}'
      id: '{{ item.id }}'
      name: '{{ item.name }}'
checks:
- rule_id: azure.container.registry.encryption_enabled
  for_each: azure.container.list
  conditions:
    var: item.encryption_properties
    op: not_empty
- rule_id: azure.container.instances_group.containers_kubernetes_instance_no_privileged_containers
  for_each: azure.container.list
  conditions:
    var: item.containers
    op: not_empty
- rule_id: azure.container.instance.logging_enabled
  for_each: azure.container.list
  conditions:
    var: item.diagnostics
    op: not_empty
- rule_id: azure.container.instances_group.containers_kubernetes_instance_read_only_root_filesystem
  for_each: azure.container.list
  conditions:
    var: item.containers
    op: exists
- rule_id: azure.container.instance.managed.identity.least.privilege.check
  for_each: azure.container.list
  conditions:
    var: item.identity
    op: not_empty
- rule_id: azure.container.registry.image_scan_enabled
  for_each: azure.container.list
  conditions:
    var: item.diagnostics
    op: not_empty
- rule_id: azure.container.instances_group.containers_kubernetes_instance_env_no_plaintext_secrets
  for_each: azure.container.list
  conditions:
    var: item.containers
    op: not_empty
