version: '1.0'
provider: azure
service: storage
discovery:
- discovery_id: azure.storage.list
  calls:
  - action: list
    save_as: list_response
  emit:
    items_for: '{{ list_response.value }}'
    as: item
    item:
      id: '{{ item.id }}'
      name: '{{ item.name }}'
      type: '{{ item.type }}'
      properties: '{{ item.properties }}'
checks:
- rule_id: azure.storage.file_share.data_protection_fileshare_kms_key_policy_least_privilege
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.blob.soft.delete.enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.storage.account.encryption.with.customer.managed.keys
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.account.smb.minimum.version.enforcement
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.bucket.cross.region.replication,.azure.compute.ebs.public.snapshot,.azure.sql.instance.no.public.access,.azure.aks.endpoints.not.publicly.accessible,.azure.virtual.network.endpoint.for.ec2.enabled,.azure.storage.account.level.public.access.blocks,.azure.awslambda.function.not.publicly.accessible,.azure.hdinsight.cluster.master.nodes.no.public.ip,.azure.compute.instance.public.ip,.azure.sql.snapshots.public.access,.azure.search.service.domains.not.publicly.accessible,.azure.synapse.cluster.public.access,.azure.awslambda.function.inside.vpc,.azure.compute.securitygroup.allow.ingress.from.internet.to.tcp.port.22,.azure.database.migration.instance.no.public.access,.azure.machine.learning.notebook.instance.without.direct.internet.access.configured,.azure.automation.managed.compliant.patching,.azure.sql.cluster.default.admin,.azure.sql.instance.default.admin
  for_each: azure.storage.list
  conditions:
    var: item.properties.public_network_access
    op: equals
    value: Disabled
- rule_id: azure.storage.account.data_protection_bucket_require_tls_in_transit
  for_each: azure.storage.list
  conditions:
    var: item.properties.enable_https_traffic_only
    op: equals
    value: true
- rule_id: azure.storage.snapshot.data_protection_encrypted
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.account.data_protection_bucket_cmk_cmek_configured
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.soft.delete.configuration.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.geo_redundant
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.disk.data_protection_volume_cmk_cmek_configured
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.readonly.lock.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.access.keys.rotation.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.readonly.lock.compliance.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.shared.key.access.disabled.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.infrastructure.encryption.enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.account.cross.tenant.replication.disabled
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.file_share.data_protection_fileshare_snapshots_enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.storage.private.endpoint.presence.and.configuration.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.secure_transport_policy
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.https.traffic.only.check
  for_each: azure.storage.list
  conditions:
    var: item.properties.enable_https_traffic_only
    op: equals
    value: true
- rule_id: azure.storage.accounts.private.endpoints.verification
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.data_protection_bucket_policy_no_wildcards_on_actions_or_principals
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.encryption.at.rest.with.cmk
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.file_share.data_protection_fileshare_private_network_only
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.data_protection_bucket_notification_destination_encrypted
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.account.data_protection_bucket_policy_deny_unencrypted_puts
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.sas.policy.compliance.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.snapshot.data_protection_not_public
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.smb.channel.encryption.in.transit
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.account.redundancy.check.geo.redundant
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.secure.transfer.enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.storage.account.default.network.access.rule.set.to.deny
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.public.network.access.disabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.public_network_access
    op: equals
    value: Disabled
- rule_id: azure.storage.account.default.to.microsoft.entra.authorization.enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.enable_rbac_authorization
    op: equals
    value: true
- rule_id: azure.storage.blob.data_protection_object_object_lock_or_immutability_enabled_where_supported
  for_each: azure.storage.list
  conditions:
    var: item.properties.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.storage.account.network.rule.trusted.services.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.sas.linked.to.stored.access.policy
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.table.data_protection_global_pitr_enabled_where_supported
  for_each: azure.storage.list
  conditions:
    var: item.properties.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.storage.sas.https.only.check
  for_each: azure.storage.list
  conditions:
    var: item.properties.enable_https_traffic_only
    op: equals
    value: true
- rule_id: azure.storage.nfs.root.squash.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.disable.shared.key.access.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.queue.data_protection_auth_required
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.threat_ip_set.storage_encrypted
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.queue.logging.read.write.delete.enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.diagnostic_settings
    op: not_empty
- rule_id: azure.storage.table.data_protection_encryption_at_rest_enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.account.cannot.delete.lock.applied
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.file_share.data_protection_fileshare_encryption_at_rest_enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.queue.data_protection_private_network_only_where_supported
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.disk.data_protection_volume_encryption_at_rest_enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.table.data_protection_global_cross_region_replication_encrypted
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.account.geo.redundancy.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.encryption.cmk.check
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.disk.data_protection_volume_snapshots_encrypted
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.blob.data_protection_object_not_publicly_readable
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.encryption.at.rest.microsoft.managed.keys.enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.s3.dataevents.read.enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.storage.account.sas.https.only
  for_each: azure.storage.list
  conditions:
    var: item.properties.enable_https_traffic_only
    op: equals
    value: true
- rule_id: azure.storage.account.data_protection_bucket_notification_destination_least_privilege
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.blob.versioning.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.sas.expiration.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.smb.protocol.version.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.sas.token.expiration.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.bucket.server.access.logging.enabled,.azure.monitor.s3.dataevents.read.enabled,.azure.monitor.multi.region.enabled,.azure.monitor.cloudwatch.logging.enabled,.azure.synapse.cluster.audit.logging
  for_each: azure.storage.list
  conditions:
    var: item.properties.diagnostic_settings
    op: not_empty
- rule_id: azure.storage.account.data_protection_bucket_policy_denies_public_and_insecure
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.smb.channel.encryption.in.transit.aes256gcm
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.threat_custom_identifier.storage_encrypted
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.table.data_protection_global_encryption_at_rest_all_regions
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.snapshot.data_protection_cross_region_copy_encrypted
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.account.cannot.delete.lock.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.container.locked.immutability.policy.enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.storage.account.data_protection_bucket_notification_cross_destinations_restricted
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.queue.data_protection_cross_account_send_receive_restricted
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.blob.versioning.enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.storage.account.data_protection_bucket_access_logging_enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.diagnostic_settings
    op: not_empty
- rule_id: azure.storage.bucket.object.versioning
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.minimum.tls.version
  for_each: azure.storage.list
  conditions:
    var: item.properties.enable_https_traffic_only
    op: equals
    value: true
- rule_id: azure.storage.account.blob.anonymous.access.disabled
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.table.service.logging.rw.delete.enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.diagnostic_settings
    op: not_empty
- rule_id: azure.storage.account.data_protection_bucket_policy_no_public_principals
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.table.data_protection_private_network_only_where_supported
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.bucket.server.access.logging.enabled,.azure.monitor.s3.dataevents.read.enabled,.azure.monitor.multi.region.enabled,.azure.monitor.cloudwatch.logging.enabled,.azure.synapse.cluster.audit.logging,.azure.policy.recorder.all.regions.enabled,.azure.storage.bucket.object.versioning,.azure.monitor.log.file.validation.enabled,.azure.storage.bucket.cross.region.replication
  for_each: azure.storage.list
  conditions:
    var: item.properties.diagnostic_settings
    op: not_empty
- rule_id: azure.storage.account.key.rotation.reminder.enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.storage.account.data_protection_bucket_encryption_at_rest_enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.account.data_protection_bucket_policy_deny_insecure_transport
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.file.share.soft.delete.enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.storage.queue.data_protection_encryption_at_rest_enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.blob.data_protection_object_encrypted_at_rest
  for_each: azure.storage.list
  conditions:
    var: item.properties.encryption.enabled
    op: equals
    value: true
- rule_id: azure.storage.table.data_protection_rbac_least_privilege
  for_each: azure.storage.list
  conditions:
    var: item.properties.enable_rbac_authorization
    op: equals
    value: true
- rule_id: azure.storage.account.network.bypass.azure.services.enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.storage.account.data_protection_bucket_block_public_access_enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.allow_blob_public_access
    op: equals
    value: false
- rule_id: azure.storage.account.data_protection_bucket_versioning_enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.storage.account.blob.logging.read.write.delete.enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.diagnostic_settings
    op: not_empty
- rule_id: azure.storage.account.access.key.rotation.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.file.shares.soft.delete.retention.policy
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.s3.dataevents.write.enabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.provisioning_state
    op: equals
    value: Succeeded
- rule_id: azure.storage.account.private.endpoint.approved
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.network.access.deny.by.default.check
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.storage.account.network.access.public.disabled
  for_each: azure.storage.list
  conditions:
    var: item.properties.public_network_access
    op: equals
    value: Disabled
- rule_id: azure.storage.account.allow.blob.anonymous.access.disabled
  for_each: azure.storage.list
  conditions:
    var: item.id
    op: exists
