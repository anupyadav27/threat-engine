netappfiles:
  version: '1.0'
  provider: azure
  service: netappfiles
  package: azure-mgmt-netapp
  client_class: NetAppManagementClient
  scope: subscription
  discovery:
  - discovery_id: azure.netappfiles.accounts
    calls:
    - client: netappfiles
      action: accounts.list
      save_as: accounts
  - discovery_id: azure.netappfiles.pools
    calls:
    - client: netappfiles
      action: pools.list
      save_as: pools
  - discovery_id: azure.netappfiles.volumes
    calls:
    - client: netappfiles
      action: volumes.list
      save_as: volumes
  - discovery_id: azure.netappfiles.snapshots
    calls:
    - client: netappfiles
      action: snapshots.list
      save_as: snapshots
  - discovery_id: azure.netappfiles.backups
    calls:
    - client: netappfiles
      action: backups.list
      save_as: backups
  checks:
  - check_id: azure.netappfiles.encryption.key.source.cmk.check
    title: 'AZURE NETAPPFILES Encryption: Key Source CMK Check'
    severity: high
    for_each: azure.netappfiles.volumes
    calls:
    - action: self
      fields:
      - path: encryption_key_source
        operator: equals
        expected: Microsoft.KeyVault
  - check_id: azure.netappfiles.volume.backup.enabled.check
    title: 'AZURE NETAPPFILES Volume: Backup Enabled Check'
    severity: medium
    for_each: azure.netappfiles.volumes
    calls:
    - action: volumes.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{account_name}}'
        pool_name: '{{pool_name}}'
        volume_name: '{{name}}'
      fields:
      - path: data_protection.backup
        operator: exists
  - check_id: azure.netappfiles.volume.snapshot.policy.check
    title: 'AZURE NETAPPFILES Volume: Snapshot Policy Check'
    severity: medium
    for_each: azure.netappfiles.volumes
    calls:
    - action: volumes.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{account_name}}'
        pool_name: '{{pool_name}}'
        volume_name: '{{name}}'
      fields:
      - path: data_protection.snapshot.snapshot_policy_id
        operator: exists
  - check_id: azure.netappfiles.account.active.directory.check
    title: 'AZURE NETAPPFILES Account: Active Directory Check'
    severity: high
    for_each: azure.netappfiles.accounts
    calls:
    - action: accounts.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{name}}'
      fields:
      - path: active_directories[0].active_directory_id
        operator: exists
  - check_id: azure.netappfiles.volume.protocol.security.check
    title: 'AZURE NETAPPFILES Volume: Protocol Security Check'
    severity: high
    for_each: azure.netappfiles.volumes
    calls:
    - action: volumes.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{account_name}}'
        pool_name: '{{pool_name}}'
        volume_name: '{{name}}'
      fields:
      - path: protocol_types[0]
        operator: equals
        expected: NFSv4.1
  - check_id: azure.netappfiles.pool.qos.type.check
    title: 'AZURE NETAPPFILES Pool: QoS Type Check'
    severity: medium
    for_each: azure.netappfiles.pools
    calls:
    - action: pools.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{account_name}}'
        pool_name: '{{name}}'
      fields:
      - path: qos_type
        operator: equals
        expected: Manual
  - check_id: azure.netappfiles.volume.export.policy.check
    title: 'AZURE NETAPPFILES Volume: Export Policy Check'
    severity: high
    for_each: azure.netappfiles.volumes
    calls:
    - action: volumes.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{account_name}}'
        pool_name: '{{pool_name}}'
        volume_name: '{{name}}'
      fields:
      - path: export_policy.rules[0].allowed_clients
        operator: exists
  - check_id: azure.netappfiles.backup.vault.encryption.check
    title: 'AZURE NETAPPFILES Backup: Vault Encryption Check'
    severity: high
    for_each: azure.netappfiles.backups
    calls:
    - action: self
      fields:
      - path: encryption.key_source
        operator: equals
        expected: Microsoft.KeyVault
  - check_id: azure.netappfiles.volume.throughput.mibps.check
    title: 'AZURE NETAPPFILES Volume: Throughput MiBps Check'
    severity: low
    for_each: azure.netappfiles.volumes
    calls:
    - action: volumes.get
      params:
        resource_group_name: '{{resource_group}}'
        account_name: '{{account_name}}'
        pool_name: '{{pool_name}}'
        volume_name: '{{name}}'
      fields:
      - path: throughput_mibps
        operator: gte
        expected: 16
  - check_id: azure.netappfiles.account.system.assigned.identity.check
    title: 'AZURE NETAPPFILES Account: System Assigned Identity Check'
    severity: medium
    for_each: azure.netappfiles.accounts
    calls:
    - action: self
      fields:
      - path: identity.type
        operator: equals
        expected: SystemAssigned
