webapp:
  version: '1.0'
  provider: azure
  service: webapp
  package: azure-mgmt-web
  client_class: WebSiteManagementClient
  scope: subscription
  discovery:
  - discovery_id: azure.webapp.web_apps
    calls:
    - client: webapp
      action: web_apps.list
      save_as: web_apps
  - discovery_id: azure.webapp.app_service_plans
    calls:
    - client: webapp
      action: app_service_plans.list
      save_as: app_service_plans
  - discovery_id: azure.webapp.certificates
    calls:
    - client: webapp
      action: certificates.list
      save_as: certificates
  - discovery_id: azure.webapp.domains
    calls:
    - client: webapp
      action: domains.list
      save_as: domains
  checks:
  - check_id: azure.app.service.slot.check.minimum.tls.version
    title: 'AZURE APP Service Slot: Check Minimum TLS Version'
    severity: medium
    for_each: azure.webapp.web_apps
    calls:
    - action: web_apps.get_configuration
      params:
        resource_group_name: '{{resource_group}}'
        name: '{{name}}'
      fields:
      - path: min_tls_version
        operator: gte
        expected: '1.2'
  - check_id: azure.site.recovery_test_failover.dr_testing_logs_enabled
    title: 'AZURE SITE Recovery Test Failover: DR Testing Logs Enabled'
    severity: low
    for_each: azure.webapp.web_apps
    calls:
    - action: web_apps.get_diagnostic_logs_configuration
      params:
        resource_group_name: '{{resource_group}}'
        name: '{{name}}'
      fields:
      - path: detailed_error_messages.enabled
        operator: equals
        expected: true
  - check_id: azure.appservice.authentication.enabled.check
    title: 'AZURE APPSERVICE Authentication: Enabled Check'
    severity: medium
    for_each: azure.webapp.web_apps
    calls:
    - action: web_apps.get_auth_settings
      params:
        resource_group_name: '{{resource_group}}'
        name: '{{name}}'
      fields:
      - path: enabled
        operator: equals
        expected: true
  - check_id: azure.app.service.slot.public.network.access.check
    title: 'AZURE APP Service Slot: Public Network Access Check'
    severity: critical
    for_each: azure.webapp.web_apps
    calls:
    - action: self
      fields:
      - path: public_network_access
        operator: equals
        expected: Disabled
  - check_id: azure.app.service.function.slot.https.only.check
    title: 'AZURE APP Service Function Slot: HTTPS Only Check'
    severity: low
    for_each: azure.webapp.web_apps
    calls:
    - action: web_apps.get
      params:
        resource_group_name: '{{resource_group}}'
        name: '{{name}}'
      fields:
      - path: https_only
        operator: equals
        expected: true
  - check_id: azure.monitor.application.insights_enabled
    title: 'AZURE APPLICATION Resource: Insights Enabled'
    severity: low
    for_each: azure.webapp.resource
    calls:
    - action: self
      fields:
      - path: properties.siteConfig.appSettings
        operator: contains_key
        expected: APPINSIGHTS_INSTRUMENTATIONKEY
      - path: properties.siteConfig.appSettings
        operator: contains_key
        expected: APPLICATIONINSIGHTS_CONNECTION_STRING
  - check_id: azure.site.recovery_automation_runbook.dr_automation_change_audit_logging_enabled
    title: 'AZURE SITE Recovery_automation_runbook: DR Automation Change Audit Logging Enabled'
    severity: medium
    for_each: azure.webapp.recovery_automation_runbook
    calls:
    - action: automation_client.get_automation_account
      fields:
      - path: properties.auditLogging.enabled
        operator: equals
        expected: true
      - path: properties.auditLogging.changeTracking
        operator: equals
        expected: true
  - check_id: azure.app.service.cors.check.allowed.origins
    title: 'AZURE APP Service: CORS Check Allowed Origins'
    severity: low
    for_each: azure.webapp.service
    calls:
    - action: web_apps.get_configuration
      fields:
      - path: cors.allowed_origins
        operator: not_contains
        expected: '*'
      - path: cors.allowed_origins
        operator: not_empty
  - check_id: azure.appservice.deployment.slot.php.version.check
    title: 'AZURE APPSERVICE Deployment: Slot Php Version Check'
    severity: low
    for_each: azure.webapp.deployment
    calls:
    - action: web_apps.get_configuration_slot
      fields:
      - path: php_version
        operator: not_equals
        expected: ''
      - path: php_version
        operator: not_in
        expected:
        - '5.6'
        - '7.0'
        - '7.1'
        - '7.2'
  - check_id: azure.site.recovery_test_failover.dr_testing_results_storage_encrypted_and_private
    title: 'AZURE SITE Recovery_test_failover: DR Testing Results Storage Encrypted And Private'
    severity: low
    for_each: azure.webapp.recovery_test_failover
    calls:
    - action: recoveryservices.replication_recovery_plans.get
      fields:
      - path: properties.recovery_plan_groups[*].group_type
        operator: contains
        expected: TestFailover
    - action: storage.storage_accounts.get_properties
      fields:
      - path: properties.encryption.services.blob.enabled
        operator: equals
        expected: true
      - path: properties.public_network_access
        operator: equals
        expected: Disabled
      - path: properties.network_rule_set.default_action
        operator: equals
        expected: Deny
  - check_id: azure.app.service.deployment.slot.https.only.enabled
    title: 'AZURE APP Service: Deployment Slot HTTPS Only Enabled'
    severity: low
    for_each: azure.webapp.service
    calls:
    - action: web_apps.list_slots
      fields:
      - path: value[*].properties.httpsOnly
        operator: equals
        expected: true
  - check_id: azure.app.service.deployment.slot.tls.encryption.check
    title: 'AZURE APP Service: Deployment Slot TLS Encryption Check'
    severity: high
    for_each: azure.webapp.service
    calls:
    - action: service_operation.list_deployment_slots
      fields:
      - path: value[*].properties.httpsOnly
        operator: equals
        expected: true
      - path: value[*].properties.siteConfig.minTlsVersion
        operator: in
        expected:
        - '1.2'
        - '1.3'
  - check_id: azure.application.gateway.waf.bot.protection.check
    title: 'AZURE APPLICATION Gateway: Waf Bot Protection Check'
    severity: low
    for_each: azure.webapp.gateway
    calls:
    - action: self
      fields:
      - path: web_application_firewall_configuration.rule_set_type
        operator: exists
      - path: web_application_firewall_configuration.enabled
        operator: equals
        expected: true
      - path: web_application_firewall_configuration.firewall_mode
        operator: in
        expected:
        - Detection
        - Prevention
      - path: web_application_firewall_configuration.rule_set_version
        operator: exists
  - check_id: azure.app.service.autoscale_enabled:az.azure_paas_app.paas_security_app_logging_enabled
    title: 'AZURE APP Service: Autoscale Enabled:az Azure Paas App Paas Security App Logging Enabled'
    severity: medium
    for_each: azure.webapp.service
    calls:
    - action: web_management_client.web_apps.list_configurations
      fields:
      - path: properties.logs.application_logs.file_system.level
        operator: not_equals
        expected: 'Off'
      - path: properties.logs.application_logs.azure_blob_storage.level
        operator: not_equals
        expected: 'Off'
    - action: monitor_management_client.autoscale_settings.list_by_resource_group
      fields:
      - path: properties.enabled
        operator: equals
        expected: true
      - path: properties.target_resource_uri
        operator: contains
        expected: resource.id
  - check_id: azure.site.recovery_notification_settings.dr_communication_destinations_access_least_privilege
    title: 'AZURE SITE Recovery_notification_settings: DR Communication Destinations Access Least Privilege'
    severity: high
    for_each: azure.webapp.recovery_notification_settings
    calls:
    - action: self
      fields:
      - path: properties.notification_settings.email_recipients
        operator: not_empty
      - path: properties.notification_settings.email_recipients[*].role_assignments
        operator: contains_only
        expected:
        - Site Recovery Operator
        - Site Recovery Reader
        - Backup Operator
      - path: properties.notification_settings.webhook_endpoints[*].authentication.managed_identity.permissions
        operator: equals
        expected: minimal
      - path: properties.notification_settings.sms_recipients[*].access_level
        operator: in
        expected:
        - read
        - operator
  - check_id: azure.app.service.environment.minimum.tls.version
    title: 'AZURE APP Service: Environment Minimum TLS Version'
    severity: medium
    for_each: azure.webapp.service
    calls:
    - action: self
      fields:
      - path: site_config.min_tls_version
        operator: in
        expected:
        - '1.2'
        - '1.3'
  - check_id: azure.application.gateway.ssl.policy.minimum.tls.version
    title: 'AZURE APPLICATION Gateway: SSL Policy Minimum TLS Version'
    severity: medium
    for_each: azure.webapp.gateway
    calls:
    - action: self
      fields:
      - path: properties.sslPolicy.minProtocolVersion
        operator: in
        expected:
        - TLSv1_2
        - TLSv1_3
  - check_id: azure.app.service.deployment.slot.remote.debugging.disabled
    title: 'AZURE APP Service: Deployment Slot Remote Debugging Disabled'
    severity: low
    for_each: azure.webapp.service
    calls:
    - action: web_apps.list_slots
      fields:
      - path: value[*].properties.siteConfig.remoteDebuggingEnabled
        operator: equals
        expected: false
  - check_id: azure.app.service.deployment.slot.http.version.check
    title: 'AZURE APP Service: Deployment Slot Http Version Check'
    severity: low
    for_each: azure.webapp.service
    calls:
    - action: web_apps.list_slots
      fields:
      - path: value[*].properties.siteConfig.httpVersion
        operator: equals
        expected: '2.0'
  - check_id: azure.webapp.deployment.slot.python.version.supported
    title: 'AZURE WEBAPP Deployment: Slot Python Version Supported'
    severity: low
    for_each: azure.webapp.deployment
    calls:
    - action: web_apps.get_configuration_slot
      fields:
      - path: python_version
        operator: in
        expected:
        - '3.7'
        - '3.8'
        - '3.9'
        - '3.10'
        - '3.11'
  - check_id: azure.site.recovery_notification_settings.dr_communication_channels_configured
    title: 'AZURE SITE Recovery_notification_settings: DR Communication Channels Configured'
    severity: low
    for_each: azure.webapp.recovery_notification_settings
    calls:
    - action: self
      fields:
      - path: properties.customEmailAddresses
        operator: not_empty
      - path: properties.sendToOwners
        operator: equals
        expected: true
  - check_id: azure.app.service.slot.client.cert.check
    title: 'AZURE APP Service: Slot Client Cert Check'
    severity: low
    for_each: azure.webapp.service
    calls:
    - action: web_apps.list_slots
      fields:
      - path: value[*].properties.clientCertEnabled
        operator: equals
        expected: true
  - check_id: azure.site.recovery.configured
    title: 'AZURE SITE Resource: Recovery Configured'
    severity: low
    for_each: azure.webapp.resource
    calls:
    - action: self
      fields:
      - path: properties.site_config.backup_policy
        operator: not_null
        expected: true
      - path: properties.site_config.backup_policy.enabled
        operator: equals
        expected: true
  - check_id: azure.site.recovery_automation_runbook.dr_automation_artifacts_encrypted_and_private
    title: 'AZURE SITE Recovery_automation_runbook: DR Automation Artifacts Encrypted And Private'
    severity: medium
    for_each: azure.webapp.recovery_automation_runbook
    calls:
    - action: self
      fields:
      - path: properties.isEncrypted
        operator: equals
        expected: true
      - path: properties.runbookType
        operator: equals
        expected: Script
      - path: properties.publishContentLink.contentHash.algorithm
        operator: in
        expected:
        - SHA256
        - SHA512
      - path: properties.draft
        operator: is_null
        expected: true
  - check_id: azure.webapp.deployment.slot.vnet.configuration.enabled
    title: 'AZURE WEBAPP Deployment: Slot Vnet Configuration Enabled'
    severity: low
    for_each: azure.webapp.deployment
    calls:
    - action: web_apps.get_slot_network_config
      fields:
      - path: swift_supported
        operator: equals
        expected: true
      - path: vnet_name
        operator: not_null
        expected: true
  - check_id: azure.app.service.http.logs.enabled
    title: 'AZURE APP Service: Http Logs Enabled'
    severity: low
    for_each: azure.webapp.service
    calls:
    - action: web_apps.get_configuration
      fields:
      - path: http_logs.file_system.enabled
        operator: equals
        expected: true
  - check_id: azure.app.service.vnet.route.all.enabled.check
    title: 'AZURE APP Service: Vnet Route All Enabled Check'
    severity: low
    for_each: azure.webapp.service
    calls:
    - action: self
      fields:
      - path: site_config.vnet_route_all_enabled
        operator: equals
        expected: true
  - check_id: azure.app.service.deployment.slot.vnet.route.all.enabled.check
    title: 'AZURE APP Service: Deployment Slot Vnet Route All Enabled Check'
    severity: low
    for_each: azure.webapp.service
    calls:
    - action: web_apps.list_slots
      fields:
      - path: value[*].properties.siteConfig.vnetRouteAllEnabled
        operator: equals
        expected: true
  - check_id: azure.app.service.plan.private.endpoint.sku.compliance.check
    title: 'AZURE APP Service: Plan Private Endpoint Sku Compliance Check'
    severity: low
    for_each: azure.webapp.service
    calls:
    - action: web_management_client.app_service_plans.get
      args:
        resource_group_name: '{{ resource_group_name }}'
        name: '{{ server_farm_id | basename }}'
      fields:
      - path: sku.tier
        operator: in
        expected:
        - PremiumV2
        - PremiumV3
        - Isolated
        - IsolatedV2
  - check_id: azure.site.recovery_recovery_plan.dr_documentation_storage_encrypted_and_private
    title: 'AZURE SITE Recovery_recovery_plan: DR Documentation Storage Encrypted And Private'
    severity: medium
    for_each: azure.webapp.recovery_recovery_plan
    calls:
    - action: site_recovery_management.recovery_plans.get
      fields:
      - path: properties.groups[*].replication_protected_items[*].recovery_point_id
        operator: exists
    - action: storage_management.storage_accounts.get_properties
      fields:
      - path: properties.encryption.services.blob.enabled
        operator: equals
        expected: true
      - path: properties.public_network_access
        operator: equals
        expected: Disabled
      - path: properties.allow_blob_public_access
        operator: equals
        expected: false
  - check_id: azure.site.recovery_recovery_plan.dr_restore_cross_account_restore_blocked_by_policy
    title: 'AZURE SITE Recovery_recovery_plan: DR Restore Cross Account Restore Blocked By Policy'
    severity: low
    for_each: azure.siterecovery.recovery_plan
    calls:
    - action: self
      fields:
      - path: properties.allowed_operations
        operator: not_contains
        expected: CrossAccountRestore
  - check_id: azure.application.gateway.waf.policy.request.body.inspection.enabled
    title: 'AZURE APPLICATION Gateway: Waf Policy Request Body Inspection Enabled'
    severity: medium
    for_each: azure.webapp.gateway
    calls:
    - action: self
      fields:
      - path: properties.webApplicationFirewallConfiguration.requestBodyCheck
        operator: equals
        expected: true
  - check_id: azure.application.gateway.http2.enabled
    title: 'AZURE APPLICATION Gateway: Http2 Enabled'
    severity: low
    for_each: azure.webapp.gateway
    calls:
    - action: self
      fields:
      - path: properties.enableHttp2
        operator: equals
        expected: true
  - check_id: azure.site.recovery_recovery_plan.dr_restore_from_encrypted_backups_only
    title: 'AZURE SITE Recovery_recovery_plan: DR Restore From Encrypted Backups Only'
    severity: medium
    for_each: azure.webapp.recovery_recovery_plan
    calls:
    - action: self
      fields:
      - path: properties.groups[].replicationProtectedItems[].properties.providerSpecificDetails.encryptionInfo.encryptionStatus
        operator: equals
        expected: Enabled
      - path: properties.groups[].replicationProtectedItems[].properties.providerSpecificDetails.diskEncryptionInfo.diskEncryptionStatus
        operator: equals
        expected: Enabled
  - check_id: azure.site.recovery_recovery_plan.dr_documentation_access_rbac_least_privilege
    title: 'AZURE SITE Recovery_recovery_plan: DR Documentation Access RBAC Least Privilege'
    severity: high
    for_each: azure.webapp.recovery_recovery_plan
    calls:
    - action: authorization.role_assignments.list_for_scope
      fields:
      - path: scope
        operator: equals
        expected: '{{.id}}'
    - action: self
      fields:
      - path: role_assignments[*].role_definition_name
        operator: not_contains_any
        expected:
        - Owner
        - Contributor
        - User Access Administrator
      - path: role_assignments[?(@.role_definition_name == 'Site Recovery Reader')].principal_type
        operator: equals
        expected: User
      - path: role_assignments[?(@.role_definition_name == 'Site Recovery Operator')].principal_type
        operator: not_equals
        expected: Group
  - check_id: azure.appservice.app.ip.security.restrictions.disabled
    title: 'AZURE APPSERVICE App: Ip Security Restrictions Disabled'
    severity: low
    for_each: azure.webapp.app
    calls:
    - action: service_operation.get_configuration
      fields:
      - path: ip_security_restrictions
        operator: empty
        expected: true
  - check_id: azure.app.service.deployment.slot.managed.identity.configured
    title: 'AZURE APP Service: Deployment Slot Managed Identity Configured'
    severity: medium
    for_each: azure.webapp.service
    calls:
    - action: web_apps.list_slots
      fields:
      - path: value[*].identity
        operator: not_null
      - path: value[*].identity.type
        operator: in
        expected:
        - SystemAssigned
        - UserAssigned
        - SystemAssigned,UserAssigned
  - check_id: azure.app.service.deployment.slot.java.version.check
    title: 'AZURE APP Service: Deployment Slot Java Version Check'
    severity: low
    for_each: azure.webapp.service
    calls:
    - action: service_operation.list_deployment_slots
      fields:
      - path: value[*].properties.siteConfig.javaVersion
        operator: not_empty
      - path: value[*].properties.siteConfig.javaVersion
        operator: regex_match
        expected: ^(1\.8|11|17|21)$
  - check_id: azure.site.recovery_replication_policy.dr_replication_auth_roles_least_privilege
    title: 'AZURE SITE Recovery_replication_policy: DR Replication Auth Roles Least Privilege'
    severity: high
    for_each: azure.webapp.recovery_replication_policy
    calls:
    - action: authorization.role_assignments.list_for_resource
      fields:
      - path: value[*].properties.roleDefinitionId
        operator: not_contains
        expected: /subscriptions/{subscriptionId}/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635
      - path: value[*].properties.roleDefinitionId
        operator: not_contains
        expected: /subscriptions/{subscriptionId}/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9
    - action: self
      fields:
      - path: properties.allowedAuthenticationType
        operator: equals
        expected: KeyBased
      - path: properties.applicationConsistentSnapshotFrequencyInHours
        operator: less_than_or_equal
        expected: 24
  - check_id: azure.site.recovery_replication_policy.dr_replication_lag_monitoring_alerts_enabled
    title: 'AZURE SITE Recovery_replication_policy: DR Replication Lag Monitoring Alerts Enabled'
    severity: medium
    for_each: azure.webapp.recovery_replication_policy
    calls:
    - action: self
      fields:
      - path: properties.application_consistent_snapshot_frequency_in_hours
        operator: not_null
      - path: properties.crash_consistent_snapshot_frequency_in_hours
        operator: not_null
      - path: properties.recovery_point_retention_in_hours
        operator: greater_than
        expected: 0
    - action: monitor.activity_log_alerts.list
      fields:
      - path: value[?contains(properties.condition.allOf[].field, 'Microsoft.RecoveryServices/vaults/replicationPolicies')]
        operator: not_empty
      - path: value[?properties.enabled == `true`]
        operator: not_empty
  - check_id: azure.app.service.virtual.network.integration.check
    title: 'AZURE APP Service: Virtual Network Integration Check'
    severity: medium
    for_each: azure.webapp.service
    calls:
    - action: self
      fields:
      - path: virtual_network_subnet_id
        operator: not_null
        expected: true
  - check_id: azure.site.recovery_notification_settings.dr_communication_no_public_webhooks_without_auth
    title: 'AZURE SITE Recovery_notification_settings: DR Communication No Public Webhooks Without Auth'
    severity: critical
    for_each: azure.webapp.recovery_notification_settings
    calls:
    - action: self
      fields:
      - path: webhook_url
        operator: starts_with
        expected: https://
      - path: authentication_type
        operator: not_equals
        expected: None
      - path: webhook_url
        operator: not_contains
        expected: ://public
    condition: all
  - check_id: azure.app.service.private.endpoint.dns.zone.check
    title: 'AZURE APP Service: Private Endpoint Dns Zone Check'
    severity: low
    for_each: azure.webapp.service
    calls:
    - action: network_client.private_endpoints.list_by_subscription
      fields:
      - path: value[?subnet.id contains @.id].private_dns_zone_configs
        operator: not_empty
        expected: true
  - check_id: azure.application.gateway.waf.enabled
    title: 'AZURE APPLICATION Gateway: Waf Enabled'
    severity: low
    for_each: azure.webapp.gateway
    calls:
    - action: self
      fields:
      - path: web_application_firewall_configuration.enabled
        operator: equals
        expected: true
  - check_id: azure.site.recovery_automation_runbook.dr_automation_execution_roles_least_privilege
    title: 'AZURE SITE Recovery_automation_runbook: DR Automation Execution Roles Least Privilege'
    severity: high
    for_each: azure.webapp.recovery_automation_runbook
    calls:
    - action: automation_client.runbooks.get
      fields:
      - path: properties.runbook_type
        operator: equals
        expected: PowerShell
    - action: automation_client.job_schedules.list_by_automation_account
      fields:
      - path: properties.runbook.name
        operator: equals
        expected: '{{ item.name }}'
    - action: authorization_client.role_assignments.list_for_resource
      fields:
      - path: properties.role_definition_id
        operator: not_contains
        expected: /subscriptions/*/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635
      - path: properties.role_definition_id
        operator: not_contains
        expected: /subscriptions/*/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9
      - path: properties.principal_type
        operator: equals
        expected: ServicePrincipal
  - check_id: azure.app.service.identity.check
    title: 'AZURE APP Service: Identity Check'
    severity: medium
    for_each: azure.webapp.service
    calls:
    - action: self
      fields:
      - path: identity.type
        operator: not_equals
        expected: None
  - check_id: azure.site.recovery_replication_policy.dr_replication_cross_region_replication_encrypted
    title: 'AZURE SITE Recovery_replication_policy: DR Replication Cross Region Replication Encrypted'
    severity: low
    for_each: azure.webapp.recovery_replication_policy
    calls:
    - action: self
      fields:
      - path: properties.encryption_details.encryption_enabled
        operator: equals
        expected: true
      - path: properties.replication_frequency_in_seconds
        operator: exists
        expected: true
  - check_id: azure.app.service.deployment.slots.basic.auth.disabled
    title: 'AZURE APP Service: Deployment Slots Basic Auth Disabled'
    severity: low
    for_each: azure.webapp.service
    calls:
    - action: service_operation.list_deployment_slots
      fields:
      - path: value[*].properties.siteConfig.scmIpSecurityRestrictionsUseMain
        operator: equals
        expected: false
      - path: value[*].properties.siteConfig.basicAuthEnabled
        operator: equals
        expected: false
  - check_id: azure.site.recovery_replication_policy.dr_replication_encryption_in_transit_tls_required
    title: 'AZURE SITE Recovery_replication_policy: DR Replication Encryption In Transit TLS Required'
    severity: high
    for_each: azure.webapp.recovery_replication_policy
    calls:
    - action: self
      fields:
      - path: properties.provider_specific_input.encryption_details.encryption_type
        operator: equals
        expected: InTransit
      - path: properties.provider_specific_input.encryption_details.tls_certificate_store_name
        operator: not_empty
      - path: properties.provider_specific_input.use_managed_identity_for_replication_traffic
        operator: equals
        expected: true
  - check_id: azure.app.service.cors.wildcard.restriction
    title: 'AZURE APP Service: CORS Wildcard Restriction'
    severity: low
    for_each: azure.webapp.service
    calls:
    - action: web_apps.get_configuration
      fields:
      - path: cors.allowed_origins
        operator: not_contains
        expected: '*'
  - check_id: azure.site.recovery_recovery_plan.dr_restore_logs_and_artifacts_encrypted
    title: 'AZURE SITE Recovery_recovery_plan: DR Restore Logs And Artifacts Encrypted'
    severity: medium
    for_each: azure.webapp.recovery_recovery_plan
    calls:
    - action: self
      fields:
      - path: properties.recovery_plan_properties.encryption_details.logs_encrypted
        operator: equals
        expected: true
      - path: properties.recovery_plan_properties.encryption_details.artifacts_encrypted
        operator: equals
        expected: true
  - check_id: azure.site.recovery_recovery_plan.dr_restore_roles_least_privilege
    title: 'AZURE SITE Recovery_recovery_plan: DR Restore Roles Least Privilege'
    severity: high
    for_each: azure.webapp.recovery_recovery_plan
    calls:
    - action: recovery_services_site_recovery_management.recovery_plans.get
      fields:
      - path: properties.groups[*].replication_protected_items[*].recovery_azure_vm_size
        operator: not_equals
        expected: null
      - path: properties.groups[*].start_group_actions[*].custom_details.script_name
        operator: contains
        expected: role-assignment
      - path: properties.groups[*].end_group_actions[*].custom_details.script_name
        operator: contains
        expected: role-cleanup
    - action: authorization_management.role_assignments.list_for_subscription
      fields:
      - path: value[*].properties.principal_type
        operator: equals
        expected: ServicePrincipal
      - path: value[*].properties.role_definition_id
        operator: not_contains
        expected: /subscriptions/*/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635
  - check_id: azure.appservice.ase.internal.encryption.check
    title: 'AZURE APPSERVICE Ase: Internal Encryption Check'
    severity: high
    for_each: azure.webapp.ase
    calls:
    - action: self
      fields:
      - path: properties.internalLoadBalancingMode
        operator: equals
        expected: Web, Publishing
      - path: properties.frontEndScaleFactor
        operator: greater_than_or_equal
        expected: 15
      - path: properties.ipSslAddressCount
        operator: greater_than
        expected: 0
  - check_id: azure.app.function.identity_without_admin_privileges
    title: 'AZURE APP Function: Identity Without Admin Privileges'
    severity: critical
    for_each: azure.webapp.function
    calls:
    - action: web_apps.get_auth_settings_v2
      fields:
      - path: properties.identityProviders.azureActiveDirectory.registration.clientSecretSettingName
        operator: not_empty
      - path: properties.identityProviders.azureActiveDirectory.login.scopes
        operator: not_contains
        expected: https://graph.microsoft.com/.default
    - action: web_apps.list_application_settings
      fields:
      - path: properties
        operator: not_contains_key
        expected: WEBSITE_RUN_FROM_PACKAGE_BLOB_MI_RESOURCE_ID
  - check_id: azure.app.service.deployment.slot.ftps.state.check
    title: 'AZURE APP Service: Deployment Slot Ftps State Check'
    severity: low
    for_each: azure.webapp.service
    calls:
    - action: web_apps.list_deployment_slots
      fields:
      - path: value[*].properties.siteConfig.ftpsState
        operator: not_equals
        expected: AllAllowed
  - check_id: azure.app.service.private.endpoint.approved.check
    title: 'AZURE APP Service: Private Endpoint Approved Check'
    severity: low
    for_each: azure.webapp.service
    calls:
    - action: self
      fields:
      - path: properties.privateEndpointConnections[*].properties.privateLinkServiceConnectionState.status
        operator: equals
        expected: Approved
  - check_id: azure.appservice.deployment.slot.vnet.integration.check
    title: 'AZURE APPSERVICE Deployment: Slot Vnet Integration Check'
    severity: low
    for_each: azure.webapp.deployment
    calls:
    - action: web_apps.get_slot
      fields:
      - path: properties.virtual_network_subnet_id
        operator: not_null
        expected: true
  - check_id: azure.app.service.managed_updates_enabled:az.azure_paas_app.paas_security_app_logging_enabled
    title: 'AZURE APP Service: Managed Updates Enabled:az Azure Paas App Paas Security App Logging Enabled'
    severity: medium
    for_each: azure.webapp.service
    calls:
    - action: self
      fields:
      - path: site_config.auto_heal_enabled
        operator: equals
        expected: true
      - path: site_config.http_logging_enabled
        operator: equals
        expected: true
      - path: site_config.detailed_error_logging_enabled
        operator: equals
        expected: true
      - path: site_config.request_tracing_enabled
        operator: equals
        expected: true
  - check_id: azure.appservice.ase.tls.cipher.suite.order.configured
    title: 'AZURE APPSERVICE Ase: TLS Cipher Suite Order Configured'
    severity: medium
    for_each: azure.webapp.ase
    calls:
    - action: self
      fields:
      - path: properties.clusterSettings
        operator: contains
        expected:
          name: TlsCipherSuiteOrder
          value: TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_SHA256,TLS_RSA_WITH_AES_256_CBC_SHA256,TLS_RSA_WITH_AES_128_CBC_SHA256,TLS_RSA_WITH_AES_256_CBC_SHA,TLS_RSA_WITH_AES_128_CBC_SHA
  - check_id: azure.app.service.vnet.integration.check
    title: 'AZURE APP Service: Vnet Integration Check'
    severity: low
    for_each: azure.webapp.service
    calls:
    - action: self
      fields:
      - path: properties.virtualNetworkSubnetId
        operator: not_null
        expected: true
  - check_id: azure.site.recovery_test_failover.dr_testing_execution_roles_least_privilege
    title: 'AZURE SITE Recovery_test_failover: DR Testing Execution Roles Least Privilege'
    severity: high
    for_each: azure.webapp.recovery_test_failover
    calls:
    - action: authorization.role_assignments.list_for_scope
      fields:
      - path: properties.principalType
        operator: in
        expected:
        - User
        - Group
        - ServicePrincipal
      - path: properties.roleDefinitionId
        operator: not_contains
        expected: /subscriptions/{subscriptionId}/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635
      - path: properties.roleDefinitionId
        operator: not_contains
        expected: /subscriptions/{subscriptionId}/providers/Microsoft.Authorization/roleDefinitions/18d7d88d-d35e-4fb5-a5c3-7773c20a72d9
    - action: self
      fields:
      - path: properties.testFailoverSettings.customRoles
        operator: exists
        expected: true
      - path: properties.testFailoverSettings.customRoles[*].permissions.actions
        operator: not_contains
        expected: '*'
      - path: properties.testFailoverSettings.customRoles[*].permissions.actions
        operator: contains_only
        expected:
        - Microsoft.RecoveryServices/vaults/replicationJobs/read
        - Microsoft.RecoveryServices/vaults/replicationProtectedItems/testFailover/action
        - Microsoft.RecoveryServices/vaults/replicationRecoveryPlans/testFailover/action
  - check_id: azure.app.service.environment.minimum.version.check
    title: 'AZURE APP Service: Environment Minimum Version Check'
    severity: low
    for_each: azure.webapp.service
    calls:
    - action: self
      fields:
      - path: site_config.net_framework_version
        operator: version_gte
        expected: v4.0
      - path: site_config.php_version
        operator: version_gte
        expected: '7.4'
      - path: site_config.python_version
        operator: version_gte
        expected: '3.8'
      - path: site_config.node_version
        operator: version_gte
        expected: '14.0'
      - path: site_config.java_version
        operator: version_gte
        expected: '11'
