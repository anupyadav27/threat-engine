version: '1.0'
provider: azure
service: monitor
discovery: []
checks:
- check_id: monitor_action_group_incident_escalation_change_audit_logging_enabled
  name: 'AZURE MONITOR Action_group: Incident Escalation Change Audit Logging Enabled'
  severity: MEDIUM
  for_each: action_groups
  param: action_group
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.groupShortName
      operator: exists
      expected: true
    - path: properties.emailReceivers
      operator: exists
      expected: true
    - path: properties.smsReceivers
      operator: exists
      expected: true
    - path: properties.webhookReceivers
      operator: exists
      expected: true
    - path: properties.armRoleReceivers
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_action_group_incident_escalation_oncall_contacts_verified
  name: 'AZURE MONITOR Action_group: Incident Escalation Oncall Contacts Verified'
  severity: LOW
  for_each: action_groups
  param: action_group
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.emailReceivers
      operator: exists
      expected: true
    - path: properties.smsReceivers
      operator: exists
      expected: true
    - path: properties.webhookReceivers
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_action_group_incident_escalation_policy_exists_for_critical_severity
  name: 'AZURE MONITOR Action_group: Incident Escalation Policy Exists For Critical
    Sever'
  severity: MEDIUM
  for_each: action_groups
  param: action_group
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.groupShortName
      operator: exists
      expected: true
    - path: properties.emailReceivers
      operator: exists
      expected: true
    - path: properties.smsReceivers
      operator: exists
      expected: true
    - path: properties.webhookReceivers
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_action_group_incident_notification_destinations_configured
  name: 'AZURE MONITOR Action_group: Incident Notification Destinations Configured'
  severity: LOW
  for_each: action_groups
  param: action_group
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.email_receivers
      operator: exists
      expected: true
    - path: properties.sms_receivers
      operator: exists
      expected: true
    - path: properties.webhook_receivers
      operator: exists
      expected: true
  multi_step: false
  logic: OR
  errors_as_fail: []
- check_id: monitor_action_group_incident_notification_endpoints_authenticated
  name: 'AZURE MONITOR Action_group: Incident Notification Endpoints Authenticated'
  severity: LOW
  for_each: action_groups
  param: action_group
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.email_receivers
      operator: exists
      expected: true
    - path: properties.sms_receivers
      operator: exists
      expected: true
    - path: properties.webhook_receivers
      operator: exists
      expected: true
    - path: properties.webhook_receivers[*].use_aad_auth
      operator: equals
      expected: true
    - path: properties.azure_function_receivers
      operator: exists
      expected: true
    - path: properties.azure_function_receivers[*].use_common_alert_schema
      operator: equals
      expected: true
    - path: properties.logic_app_receivers
      operator: exists
      expected: true
    - path: properties.logic_app_receivers[*].use_common_alert_schema
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_action_group_incident_notification_message_encryption_in_transit
  name: 'AZURE MONITOR Action_group: Incident Notification Message Encryption In Transit'
  severity: HIGH
  for_each: action_groups
  param: action_group
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.email_receivers
      operator: exists
      expected: true
    - path: properties.email_receivers[*].use_common_alert_schema
      operator: equals
      expected: true
    - path: properties.sms_receivers
      operator: exists
      expected: true
    - path: properties.sms_receivers[*].use_common_alert_schema
      operator: equals
      expected: true
    - path: properties.webhook_receivers
      operator: exists
      expected: true
    - path: properties.webhook_receivers[*].use_common_alert_schema
      operator: equals
      expected: true
    - path: properties.webhook_receivers[*].use_aad_auth
      operator: equals
      expected: true
    - path: properties.logic_app_receivers
      operator: exists
      expected: true
    - path: properties.logic_app_receivers[*].use_common_alert_schema
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_action_group_incident_notification_no_public_webhooks
  name: 'AZURE MONITOR Action_group: Incident Notification No Public Webhooks'
  severity: CRITICAL
  for_each: action_groups
  param: action_group
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.webhookReceivers
      operator: exists
      expected: true
    - path: properties.webhookReceivers[*].serviceUri
      operator: contains
      expected: https://hooks.slack.com
    - path: properties.webhookReceivers[*].serviceUri
      operator: contains
      expected: https://outlook.office.com
    - path: properties.webhookReceivers[*].serviceUri
      operator: contains
      expected: https://discord.com
    - path: properties.webhookReceivers[*].useCommonAlertSchema
      operator: equals
      expected: false
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_activity_log_alert_create_or_update_public_ip_address
  name: 'AZURE MONITOR Activity: Log Alert Create Or Update Public Ip Address'
  severity: CRITICAL
  for_each: activitys
  param: activity
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.condition.allOf[?(@.field=='operationName')].equals
      operator: contains
      expected: Microsoft.Network/publicIPAddresses/write
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.scopes
      operator: exists
      expected: true
    - path: properties.actions.actionGroups
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_activity_log_alert_delete_nsg_exists
  name: 'AZURE MONITOR Activity: Log Alert Delete Nsg Exists'
  severity: LOW
  for_each: activitys
  param: activity
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.condition.allOf[?(@.field=='operationName')].equals
      operator: contains
      expected: Microsoft.Network/networkSecurityGroups/delete
    - path: properties.enabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_activity_log_alert_delete_policy_assignment_exists
  name: 'AZURE MONITOR Activity: Log Alert Delete Policy Assignment Exists'
  severity: LOW
  for_each: activitys
  param: activity
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.condition.allOf[0].equals
      operator: equals
      expected: Microsoft.Authorization/policyAssignments/delete
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.scopes
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_activity_log_alert_exists_delete_security_solution
  name: 'AZURE MONITOR Activity: Log Alert Exists Delete Security Solution'
  severity: LOW
  for_each: activitys
  param: activity
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.condition.allOf[*].equals
      operator: contains
      expected: Microsoft.Security/securitySolutions/delete
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.scopes
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_activity_log_alert_nsg_operation_condition_check
  name: 'AZURE MONITOR Activity: Log Alert Nsg Operation Condition Check'
  severity: LOW
  for_each: activitys
  param: activity
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.condition.allOf[*].field
      operator: contains
      expected: operationName
    - path: properties.condition.allOf[*].equals
      operator: contains
      expected: Microsoft.Network/networkSecurityGroups/write
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.scopes
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_activity_log_alert_policy_assignment_check
  name: 'AZURE MONITOR Activity: Log Alert Policy Assignment Check'
  severity: LOW
  for_each: activitys
  param: activity
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.condition.allOf[0].field
      operator: equals
      expected: category
    - path: properties.condition.allOf[0].equals
      operator: equals
      expected: Policy
    - path: properties.condition.allOf[1].field
      operator: equals
      expected: operationName
    - path: properties.condition.allOf[1].equals
      operator: contains
      expected: Microsoft.Authorization/policyAssignments
    - path: properties.actions.actionGroups
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_activity_log_alert_public_ip_delete_check
  name: 'AZURE MONITOR Activity: Log Alert Public Ip Delete Check'
  severity: CRITICAL
  for_each: activitys
  param: activity
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.condition.allOf[?(@.field=='category')].equals
      operator: contains
      expected: Administrative
    - path: properties.condition.allOf[?(@.field=='operationName')].equals
      operator: contains
      expected: Microsoft.Network/publicIPAddresses/delete
    - path: properties.actions.actionGroups
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_activity_log_alert_security_solution_update_check
  name: 'AZURE MONITOR Activity: Log Alert Security Solution Update Check'
  description: Validates that AZURE monitor activity has log alert security solution
    update check configured according to security best practices. Proper configuration
    reduces security risks, prevents unauthorized access
  service: monitor
  resource: activity
  title: 'AZURE MONITOR Activity: Log Alert Security Solution Update Check'
  severity: LOW
  for_each: activitys
  param: activity
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.condition.allOf[?(@.field=='category')].equals
      operator: contains
      expected: Security
    - path: properties.condition.allOf[?(@.field=='operationName')].equals
      operator: contains
      expected: Microsoft.Security/securitySolutions/write
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_activity_log_alert_service_health_exists
  name: 'AZURE MONITOR Activity: Log Alert Service Health Exists'
  severity: LOW
  for_each: activitys
  param: activity
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.condition.allOf[?(@.field=='category')].equals
      operator: contains
      expected: ServiceHealth
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.scopes
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_activity_log_alert_sql_server_firewall_rule_deletion_check
  name: 'AZURE MONITOR Activity: Log Alert Sql Server Firewall Rule Deletion Check'
  severity: MEDIUM
  for_each: activitys
  param: activity
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.condition.allOf[?(@.field=='category')].equals
      operator: contains
      expected: Administrative
    - path: properties.condition.allOf[?(@.field=='operationName')].equals
      operator: contains
      expected: Microsoft.Sql/servers/firewallRules/delete
    - path: properties.actions.actionGroups
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_activity_log_alert_sql_server_firewall_rule_exists
  name: 'AZURE MONITOR Activity: Log Alert Sql Server Firewall Rule Exists'
  severity: MEDIUM
  for_each: activitys
  param: activity
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.condition.allOf[*].equals
      operator: contains
      expected: Microsoft.Sql/servers/firewallRules/write
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.scopes
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_admin_account_usage_check
  name: 'AZURE MONITOR Admin: Account Usage Check'
  severity: LOW
  for_each: admins
  param: admin
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.accountUsageMonitoring.enabled
      operator: equals
      expected: true
    - path: properties.accountUsageMonitoring.alertEnabled
      operator: equals
      expected: true
    - path: properties.accountUsageMonitoring.thresholdPercentage
      operator: exists
      expected: null
    - path: properties.securitySettings.adminAccountMonitoring
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_alarm_configured
  name: 'AZURE MONITOR Resource: Alarm Configured'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.condition
      operator: exists
      expected: true
    - path: properties.actions
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_alert_create_update_nsg
  name: 'AZURE MONITOR Resource: Alert Create Update Nsg'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: type
      operator: equals
      expected: Microsoft.Insights/activityLogAlerts
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.condition.allOf[?(@.field=='operationName')].equals
      operator: contains
      expected: Microsoft.Network/networkSecurityGroups/write
    - path: properties.actions.actionGroups
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_alert_create_update_public_ip_address_rule
  name: 'AZURE MONITOR Resource: Alert Create Update Public Ip Address Rule'
  severity: CRITICAL
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: type
      operator: equals
      expected: Microsoft.Insights/activityLogAlerts
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.condition.allOf[?(@.field=='operationName')].equals
      operator: contains
      expected: Microsoft.Network/publicIPAddresses/write
    - path: properties.scopes
      operator: exists
      expected: true
    - path: properties.actions.actionGroups
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_alert_create_update_security_solution
  name: 'AZURE MONITOR Resource: Alert Create Update Security Solution'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.actions
      operator: exists
      expected: true
    - path: properties.condition.allOf[0].field
      operator: equals
      expected: category
    - path: properties.condition.allOf[0].equals
      operator: equals
      expected: Security
    - path: properties.condition.allOf[1].field
      operator: equals
      expected: operationName
    - path: properties.condition.allOf[1].anyOf[0].equals
      operator: contains
      expected: Microsoft.Security/securitySolutions/write
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_alert_create_update_sqlserver_fr
  name: 'AZURE MONITOR Resource: Alert Create Update Sqlserver Fr'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.actions
      operator: exists
      expected: true
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.condition.allOf[0].metricName
      operator: contains
      expected: Microsoft.Sql/servers
    - path: properties.condition.allOf[0].operator
      operator: exists
      expected: true
    - path: properties.condition.allOf[0].threshold
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_alert_delete_nsg
  name: 'AZURE MONITOR Resource: Alert Delete Nsg'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: type
      operator: equals
      expected: Microsoft.Insights/activityLogAlerts
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.condition.allOf[*].field
      operator: contains
      expected: operationName
    - path: properties.condition.allOf[*].equals
      operator: contains
      expected: Microsoft.Network/networkSecurityGroups/delete
    - path: properties.scopes
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_alert_delete_public_ip_address_rule
  name: 'AZURE MONITOR Resource: Alert Delete Public Ip Address Rule'
  severity: CRITICAL
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.condition.allOf[*].field
      operator: contains
      expected: Microsoft.Network/publicIPAddresses/delete/action
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.actions.actionGroups
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_alert_delete_security_solution
  name: 'AZURE MONITOR Resource: Alert Delete Security Solution'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: type
      operator: equals
      expected: Microsoft.Insights/activityLogAlerts
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.condition.allOf[?(@.field=='operationName')].equals
      operator: contains
      expected: Microsoft.Security/securitySolutions/delete
    - path: properties.scopes
      operator: exists
      expected: true
    - path: properties.actions.actionGroups
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_alert_delete_sqlserver_fr
  name: 'AZURE MONITOR Resource: Alert Delete Sqlserver Fr'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.condition.allOf[0].metricName
      operator: equals
      expected: Delete SQL Server
    - path: properties.actions[0].actionGroupId
      operator: exists
      expected: true
    - path: properties.severity
      operator: equals
      expected: 3
    - path: properties.evaluationFrequency
      operator: equals
      expected: PT5M
    - path: properties.windowSize
      operator: equals
      expected: PT15M
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_alert_rule_dr_monitoring_alert_destinations_configured
  name: 'AZURE MONITOR Alert_rule: DR Monitoring Alert Destinations Configured'
  severity: MEDIUM
  for_each: alert_rules
  param: alert_rule
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.actions
      operator: exists
      expected: true
    - path: properties.actions
      operator: contains
      expected: Microsoft.Insights/actionGroups
    - path: properties.enabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_alert_rule_dr_monitoring_alerts_for_backup_failures_configured
  name: 'AZURE MONITOR Alert_rule: DR Monitoring Alerts For Backup Failures Configured'
  severity: MEDIUM
  for_each: alert_rules
  param: alert_rule
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.condition.allOf[0].metricName
      operator: contains
      expected: BackupHealthEvent
    - path: properties.condition.allOf[0].operator
      operator: equals
      expected: GreaterThan
    - path: properties.condition.allOf[0].threshold
      operator: equals
      expected: 0
    - path: properties.actions
      operator: exists
      expected: true
    - path: properties.description
      operator: contains
      expected: backup failure
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_alert_rule_dr_monitoring_alerts_for_replication_lag_configured
  name: 'AZURE MONITOR Alert_rule: DR Monitoring Alerts For Replication Lag Configured'
  severity: MEDIUM
  for_each: alert_rules
  param: alert_rule
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.condition.allOf[0].metricName
      operator: contains
      expected: replication_lag
    - path: properties.condition.allOf[0].operator
      operator: equals
      expected: GreaterThan
    - path: properties.condition.allOf[0].threshold
      operator: exists
      expected: true
    - path: properties.actions
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_alert_rule_dr_monitoring_alerts_for_rpo_rto_breach_configured
  name: 'AZURE MONITOR Alert_rule: DR Monitoring Alerts For Rpo Rto Breach Configured'
  severity: MEDIUM
  for_each: alert_rules
  param: alert_rule
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.criteria.microsoftAzureMonitorSingleResourceMultipleMetricCriteria.allOf[0].metricName
      operator: contains
      expected: RPO
    - path: properties.criteria.microsoftAzureMonitorSingleResourceMultipleMetricCriteria.allOf[1].metricName
      operator: contains
      expected: RTO
    - path: properties.actions
      operator: exists
      expected: true
    - path: properties.severity
      operator: equals
      expected: 2
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_application_insights_configuration_check
  name: 'AZURE MONITOR Application: Insights Configuration Check'
  severity: LOW
  for_each: applications
  param: application
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.application_type
      operator: exists
      expected: true
    - path: properties.ingestion_mode
      operator: equals
      expected: ApplicationInsights
    - path: properties.public_network_access_for_ingestion
      operator: equals
      expected: Disabled
    - path: properties.public_network_access_for_query
      operator: equals
      expected: Disabled
    - path: properties.retention_in_days
      operator: exists
      expected: true
    - path: properties.sampling_percentage
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_capacity_alerts_configured
  name: 'AZURE MONITOR Resource: Capacity Alerts Configured'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.condition.allOf[0].metricName
      operator: contains
      expected: capacity
    - path: properties.condition.allOf[0].threshold
      operator: exists
      expected: true
    - path: properties.actions
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_changes_to_vpcs_alarm_configured
  name: 'AZURE MONITOR Resource: Changes To Vpcs Alarm Configured'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.condition.allOf
      operator: exists
      expected: true
    - path: properties.condition.allOf[0].field
      operator: equals
      expected: category
    - path: properties.condition.allOf[0].equals
      operator: equals
      expected: Administrative
    - path: properties.condition.allOf[1].field
      operator: equals
      expected: operationName
    - path: properties.condition.allOf[1].equals
      operator: contains
      expected: Microsoft.Network/virtualNetworks
    - path: properties.actions.actionGroups
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_diagnostic_setting_categories_compliance_check
  name: 'AZURE MONITOR Diagnostic: Setting Categories Compliance Check'
  severity: LOW
  for_each: diagnostics
  param: diagnostic
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.logs
      operator: exists
      expected: true
    - path: properties.metrics
      operator: exists
      expected: true
    - path: properties.logs[*].enabled
      operator: equals
      expected: true
    - path: properties.metrics[*].enabled
      operator: equals
      expected: true
    - path: properties.logs[*].category
      operator: exists
      expected: true
    - path: properties.storageAccountId
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_diagnostic_settings_compliance_check
  name: 'AZURE MONITOR Diagnostic: Settings Compliance Check'
  severity: LOW
  for_each: diagnostics
  param: diagnostic
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.logs
      operator: exists
      expected: true
    - path: properties.metrics
      operator: exists
      expected: true
    - path: properties.storageAccountId
      operator: exists
      expected: true
    - path: properties.workspaceId
      operator: exists
      expected: true
    - path: properties.eventHubAuthorizationRuleId
      operator: exists
      expected: true
  multi_step: false
  logic: OR
  errors_as_fail: []
- check_id: monitor_diagnostic_setting_with_appropriate_categories
  name: 'AZURE MONITOR Resource: Diagnostic Setting With Appropriate Categories'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.logs
      operator: exists
      expected: true
    - path: properties.logs[*].enabled
      operator: equals
      expected: true
    - path: properties.logs[*].category
      operator: contains
      expected: Administrative
    - path: properties.logs[*].category
      operator: contains
      expected: Security
    - path: properties.logs[*].category
      operator: contains
      expected: Alert
    - path: properties.metrics
      operator: exists
      expected: true
    - path: properties.metrics[*].enabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_diagnostic_settings_exists
  name: 'AZURE MONITOR Resource: Diagnostic Settings Exists'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.diagnosticSettings
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_group_kms_encryption_enabled
  name: 'AZURE MONITOR Group: KMS Encryption Enabled'
  severity: HIGH
  for_each: groups
  param: group
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryption.keySource
      operator: equals
      expected: Microsoft.KeyVault
    - path: properties.encryption.keyVaultProperties.keyIdentifier
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_kms_encryption_enabled
  name: 'AZURE MONITOR Resource: KMS Encryption Enabled'
  severity: HIGH
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryption.keySource
      operator: equals
      expected: Microsoft.KeyVault
    - path: properties.encryption.keyVaultProperties.keyIdentifier
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_log_group_retention_policy_specific_days_enabled,_storage_bucket_lifecycle_enabled
  name: 'AZURE MONITOR Log: Group Retention Policy Specific Days Enabled, Azure Storage
    B'
  severity: LOW
  for_each: logs
  param: log
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.retentionInDays
      operator: exists
      expected: true
    - path: properties.retentionInDays
      operator: equals
      expected: 30
    - path: properties.lifecycleManagementPolicy.properties.policy.rules
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_log_metric_filter_policy_changes,_active_directory_password_policy_reuse_24,_active_directory_user_accesskey_unused,_active_directory_user_console_access_unused
  name: 'AZURE MONITOR Log: Metric Filter Policy Changes, Azure Active Directory Password'
  severity: HIGH
  for_each: logs
  param: log
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.logs.categories
      operator: contains
      expected: Policy
    - path: properties.logs.enabled
      operator: equals
      expected: true
    - path: properties.metricAlerts
      operator: exists
      expected: true
    - path: properties.retentionPolicy.enabled
      operator: equals
      expected: true
    - path: properties.retentionPolicy.days
      operator: equals
      expected: 365
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_log_analysis_enabled
  name: 'AZURE MONITOR Resource: Log Analysis Enabled'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.workspaceId
      operator: exists
      expected: true
    - path: properties.logs.enabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_log_analytics_workspace_logging_destination_endpoint_private_networking
  name: 'AZURE MONITOR Log_analytics_workspace: Logging Destination Endpoint Private
    Netw'
  severity: MEDIUM
  for_each: log_analytics_workspaces
  param: log_analytics_workspace
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.publicNetworkAccessForIngestion
      operator: equals
      expected: Disabled
    - path: properties.publicNetworkAccessForQuery
      operator: equals
      expected: Disabled
    - path: properties.networkAccessControlSettings.publicNetworkAccessForIngestion
      operator: equals
      expected: Disabled
    - path: properties.networkAccessControlSettings.publicNetworkAccessForQuery
      operator: equals
      expected: Disabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_log_analytics_workspace_logging_destination_iam_policy_least_privilege
  name: 'AZURE MONITOR Log_analytics_workspace: Logging Destination IAM Policy Least
    Priv'
  severity: HIGH
  for_each: log_analytics_workspaces
  param: log_analytics_workspace
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.publicNetworkAccessForIngestion
      operator: equals
      expected: Disabled
    - path: properties.publicNetworkAccessForQuery
      operator: equals
      expected: Disabled
    - path: properties.features.enableLogAccessUsingOnlyResourcePermissions
      operator: equals
      expected: true
    - path: properties.workspaceCapping.dailyQuotaGb
      operator: exists
      expected: true
    - path: identity.type
      operator: equals
      expected: SystemAssigned
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_log_analytics_workspace_logging_destination_tls_min_1_2_enforced
  name: 'AZURE MONITOR Log_analytics_workspace: Logging Destination TLS Min 1 2 Enforced'
  severity: MEDIUM
  for_each: log_analytics_workspaces
  param: log_analytics_workspace
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.features.enableLogAccessUsingOnlyResourcePermissions
      operator: equals
      expected: true
    - path: properties.publicNetworkAccessForIngestion
      operator: equals
      expected: Disabled
    - path: properties.publicNetworkAccessForQuery
      operator: equals
      expected: Disabled
    - path: properties.workspaceCapping.dailyQuotaGb
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_log_file_integrity_enabled
  name: 'AZURE MONITOR Resource: Log File Integrity Enabled'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.logFileIntegrityEnabled
      operator: equals
      expected: true
    - path: properties.monitoringSettings.fileIntegrityMonitoring.enabled
      operator: equals
      expected: true
  multi_step: false
  logic: OR
  errors_as_fail: []
- check_id: monitor_log_metric_filter_alarm_configured
  name: 'AZURE MONITOR Resource: Log Metric Filter Alarm Configured'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.metricAlerts
      operator: exists
      expected: true
    - path: properties.metricAlerts.enabled
      operator: equals
      expected: true
    - path: properties.logProfiles
      operator: exists
      expected: true
    - path: properties.logProfiles.categories
      operator: contains
      expected: Administrative
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_log_retention_configured
  name: 'AZURE MONITOR Resource: Log Retention Configured'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.retentionPolicy.enabled
      operator: equals
      expected: true
    - path: properties.retentionPolicy.days
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_logging_enabled
  name: 'AZURE MONITOR Resource: Logging Enabled'
  severity: MEDIUM
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.logs.enabled
      operator: equals
      expected: true
    - path: properties.workspaceId
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_metric_filter_root_usage
  name: 'AZURE MONITOR Metric: Filter Root Usage'
  severity: CRITICAL
  for_each: metrics
  param: metric
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.criteria.allOf
      operator: exists
      expected: true
    - path: properties.criteria.allOf[0].metricName
      operator: equals
      expected: RootAccess
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.actions
      operator: exists
      expected: true
    - path: properties.scopes
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_metric_alert_logging_metric_filter_console_root_login_detected_filter_present
  name: 'AZURE MONITOR Metric_alert: Logging Metric Filter Console Root Login Detected
    Fi'
  severity: CRITICAL
  for_each: metric_alerts
  param: metric_alert
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.criteria.allOf
      operator: exists
      expected: true
    - path: properties.criteria.allOf[*].dimensions
      operator: exists
      expected: true
    - path: properties.criteria.allOf[*].metricName
      operator: contains
      expected: ConsoleRootLogin
    - path: properties.scopes
      operator: exists
      expected: true
    - path: properties.enabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_metric_alert_logging_metric_filter_iam_policy_change_detected_filter_present
  name: 'AZURE MONITOR Metric_alert: Logging Metric Filter IAM Policy Change Detected
    Fil'
  severity: MEDIUM
  for_each: metric_alerts
  param: metric_alert
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.criteria.allOf
      operator: exists
      expected: true
    - path: properties.criteria.allOf[0].metricName
      operator: equals
      expected: Administrative operations
    - path: properties.criteria.allOf[0].operator
      operator: equals
      expected: GreaterThan
    - path: properties.criteria.allOf[0].threshold
      operator: equals
      expected: 0
    - path: properties.scopes
      operator: exists
      expected: true
    - path: properties.actions
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_metric_alert_logging_metric_filter_kms_key_deletion_or_disable_detected_filter_present
  name: 'AZURE MONITOR Metric_alert: Logging Metric Filter KMS Key Deletion Or Disable
    De'
  severity: HIGH
  for_each: metric_alerts
  param: metric_alert
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.criteria.allOf
      operator: exists
      expected: true
    - path: properties.criteria.allOf[0].metricName
      operator: equals
      expected: AuditEvent
    - path: properties.criteria.allOf[0].dimensions
      operator: exists
      expected: true
    - path: properties.criteria.allOf[0].dimensions[0].name
      operator: equals
      expected: ActivityName
    - path: properties.criteria.allOf[0].dimensions[0].values
      operator: contains
      expected: Microsoft.KeyVault/vaults/keys/delete
    - path: properties.scopes
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_metric_alert_logging_metric_filter_network_acl_or_sg_change_detected_filter_present
  name: 'AZURE MONITOR Metric_alert: Logging Metric Filter Network ACL Or Sg Change
    Detec'
  severity: MEDIUM
  for_each: metric_alerts
  param: metric_alert
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.enabled
      operator: equals
      expected: true
    - path: properties.criteria.allOf[0].metricName
      operator: equals
      expected: AzureNetworkAnalytics_CL
    - path: properties.criteria.allOf[0].operator
      operator: equals
      expected: GreaterThan
    - path: properties.criteria.allOf[0].threshold
      operator: equals
      expected: 0
    - path: properties.description
      operator: contains
      expected: network security group
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_metrics_data_analytics_monitoring_admin_activity_logging_enabled
  name: 'AZURE MONITOR Metrics: Data Analytics Monitoring Admin Activity Logging Enabled'
  severity: CRITICAL
  for_each: metricss
  param: metrics
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.logs.categories
      operator: contains
      expected: Administrative
    - path: properties.logs.enabled
      operator: equals
      expected: true
    - path: properties.storageAccount.enabled
      operator: equals
      expected: true
    - path: properties.retentionPolicy.enabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_metrics_data_analytics_monitoring_logs_retention_days_minimum
  name: 'AZURE MONITOR Metrics: Data Analytics Monitoring Logs Retention Days Minimum'
  severity: MEDIUM
  for_each: metricss
  param: metrics
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.retentionInDays
      operator: exists
      expected: true
    - path: properties.retentionInDays
      operator: greater_than_or_equal
      expected: 90
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_metrics_data_analytics_monitoring_query_access_logging_enabled
  name: 'AZURE MONITOR Metrics: Data Analytics Monitoring Query Access Logging Enabled'
  severity: MEDIUM
  for_each: metricss
  param: metrics
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.logs.categories
      operator: exists
      expected: true
    - path: properties.logs.categories
      operator: contains
      expected: QueryRuntimeStatistics
    - path: properties.logs.retentionPolicy.enabled
      operator: equals
      expected: true
    - path: properties.storageAccount
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_multi_region_enabled
  name: 'AZURE MONITOR Resource: Multi Region Enabled'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.global_service_enabled
      operator: equals
      expected: true
    - path: properties.cross_region_restore_enabled
      operator: equals
      expected: true
    - path: properties.geo_redundant_backup
      operator: equals
      expected: true
  multi_step: false
  logic: OR
  errors_as_fail: []
- check_id: monitor_network_acls_alarm_configured
  name: 'AZURE MONITOR Network: Acls Alarm Configured'
  severity: LOW
  for_each: networks
  param: network
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.networkAcls.defaultAction
      operator: equals
      expected: Deny
    - path: properties.networkAcls.bypass
      operator: exists
      expected: true
    - path: properties.alertRules
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_network_gateways_alarm_configured
  name: 'AZURE MONITOR Network: Gateways Alarm Configured'
  severity: LOW
  for_each: networks
  param: network
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.gatewayAlarmConfiguration.enabled
      operator: equals
      expected: true
    - path: properties.gatewayAlarmConfiguration.alertRules
      operator: exists
      expected: true
    - path: properties.monitoringConfiguration.networkGatewayAlertsEnabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_network_route_tables_alarm_configured
  name: 'AZURE MONITOR Network: Route Tables Alarm Configured'
  severity: LOW
  for_each: networks
  param: network
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.routeTables
      operator: exists
      expected: true
    - path: properties.routeTables[*].properties.routes
      operator: exists
      expected: true
    - path: properties.monitoring.alertRules
      operator: exists
      expected: true
    - path: properties.monitoring.alertRules[*].properties.condition.dataSource.resourceUri
      operator: contains
      expected: routeTables
    - path: properties.monitoring.alertRules[*].properties.isEnabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_policy_assignment
  name: 'AZURE MONITOR Policy: Assignment'
  severity: MEDIUM
  for_each: policys
  param: policy
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.assignmentId
      operator: exists
      expected: true
    - path: properties.enforcementMode
      operator: equals
      expected: Default
    - path: properties.policyDefinitionId
      operator: exists
      expected: true
    - path: properties.scope
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_policy_specific_days_enabled
  name: 'AZURE MONITOR Policy: Specific Days Enabled'
  severity: MEDIUM
  for_each: policys
  param: policy
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.parameters.daysOfTheWeek.value
      operator: exists
      expected: true
    - path: properties.parameters.daysOfTheWeek.value
      operator: contains
      expected: Monday
    - path: properties.parameters.daysOfTheWeek.value
      operator: contains
      expected: Tuesday
    - path: properties.parameters.daysOfTheWeek.value
      operator: contains
      expected: Wednesday
    - path: properties.parameters.daysOfTheWeek.value
      operator: contains
      expected: Thursday
    - path: properties.parameters.daysOfTheWeek.value
      operator: contains
      expected: Friday
    - path: properties.policyType
      operator: equals
      expected: Custom
    - path: properties.mode
      operator: equals
      expected: All
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_resource_logging_enabled_check
  name: 'AZURE MONITOR Resource: Logging Enabled Check'
  severity: MEDIUM
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.logs
      operator: exists
      expected: true
    - path: properties.logs[*].enabled
      operator: equals
      expected: true
    - path: properties.diagnosticSettings
      operator: exists
      expected: true
    - path: properties.diagnosticSettings[*].properties.logs[*].enabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_storage_account_with_activity_logs_cmk_encrypted
  name: 'AZURE MONITOR Storage: Account With Activity Logs CMK Encrypted'
  severity: MEDIUM
  for_each: storages
  param: storage
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryption.keySource
      operator: equals
      expected: Microsoft.Keyvault
    - path: properties.encryption.keyvaultproperties.keyname
      operator: exists
      expected: true
    - path: properties.encryption.keyvaultproperties.keyvaulturi
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_storage_account_with_activity_logs_is_private
  name: 'AZURE MONITOR Storage: Account With Activity Logs Is Private'
  severity: LOW
  for_each: storages
  param: storage
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
    - path: properties.allowBlobPublicAccess
      operator: equals
      expected: false
    - path: properties.networkAcls.defaultAction
      operator: equals
      expected: Deny
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_storage_read_events_enabled
  name: 'AZURE MONITOR Storage: Read Events Enabled'
  severity: LOW
  for_each: storages
  param: storage
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.logging.read
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: monitor_storage_write_events_enabled
  name: 'AZURE MONITOR Storage: Write Events Enabled'
  severity: LOW
  for_each: storages
  param: storage
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.networkAcls.defaultAction
      operator: exists
      expected: true
    - path: properties.logging.write
      operator: equals
      expected: true
    - path: properties.logging.version
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
