version: '1.0'
provider: azure
service: sql
discovery: []
checks:
- check_id: sql_aurora_backup_enabled
  name: 'AZURE SQL Resource: Aurora Backup Enabled'
  severity: MEDIUM
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.backupPolicy.backupRetentionDays
      operator: exists
      expected: true
    - path: properties.backupPolicy.geoRedundantBackup
      operator: equals
      expected: Enabled
    - path: properties.backupPolicy.backupRetentionDays
      operator: equals
      expected: 7
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_auto_minor_version_upgrade
  name: 'AZURE SQL Resource: Auto Minor Version Upgrade'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.minorVersion
      operator: equals
      expected: Auto
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_backup_enabled
  name: 'AZURE SQL Resource: Backup Enabled'
  severity: MEDIUM
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.backupPolicy.retentionPolicy.retentionPolicyType
      operator: exists
      expected: true
    - path: properties.backupPolicy.backupEnabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_cluster_default_admin,_sql_instance_default_admin
  name: 'AZURE SQL Cluster: Default Admin, Azure Sql Instance Default Admin'
  severity: CRITICAL
  for_each: clusters
  param: cluster
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.administratorLogin
      operator: exists
      expected: true
    - path: properties.administratorLogin
      operator: equals
      expected: sa
    - path: properties.administratorLoginPassword
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_ad_authentication_enabled
  name: 'AZURE SQL Database: Ad Authentication Enabled'
  severity: HIGH
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.administrators.azureADOnlyAuthentication
      operator: equals
      expected: true
    - path: properties.administrators.administratorType
      operator: equals
      expected: ActiveDirectory
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_auditing_enabled
  name: 'AZURE SQL Database: Auditing Enabled'
  severity: MEDIUM
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.auditingPolicy.auditingState
      operator: equals
      expected: Enabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_autoscale_enabled
  name: 'AZURE SQL Database: Autoscale Enabled'
  severity: MEDIUM
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.currentServiceObjectiveName
      operator: contains
      expected: GP_S
    - path: properties.requestedServiceObjectiveName
      operator: contains
      expected: GP_S
  multi_step: false
  logic: OR
  errors_as_fail: []
- check_id: sql_database_backup_enabled
  name: 'AZURE SQL Database: Backup Enabled'
  severity: MEDIUM
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.requestedBackupStorageRedundancy
      operator: exists
      expected: true
    - path: properties.requestedBackupStorageRedundancy
      operator: equals
      expected: Geo
  multi_step: false
  logic: OR
  errors_as_fail: []
- check_id: sql_database_backup_encrypted
  name: 'AZURE SQL Database: Backup Encrypted'
  severity: MEDIUM
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.transparentDataEncryption.status
      operator: equals
      expected: Enabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_db_cluster_snapshot_cross_account_sharing_restricted
  name: 'AZURE SQL Database: Db Cluster Snapshot Cross Account Sharing Restricted'
  severity: LOW
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.crossAccountRestoreEnabled
      operator: equals
      expected: false
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
    - path: properties.restrictOutboundNetworkAccess
      operator: equals
      expected: Enabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_db_cluster_snapshot_cross_region_copy_encrypted
  name: 'AZURE SQL Database: Db Cluster Snapshot Cross Region Copy Encrypted'
  severity: MEDIUM
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.backup_encryption_state
      operator: equals
      expected: Enabled
    - path: properties.cross_region_backup_enabled
      operator: equals
      expected: true
    - path: properties.backup_storage_redundancy
      operator: contains
      expected: GRS
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_db_cluster_snapshot_encrypted
  name: 'AZURE SQL Database: Db Cluster Snapshot Encrypted'
  severity: MEDIUM
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.transparentDataEncryption.status
      operator: equals
      expected: Enabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_db_cluster_snapshot_not_publicly_shared
  name: 'AZURE SQL Database: Db Cluster Snapshot Not Publicly Shared'
  severity: CRITICAL
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
    - path: properties.restrictOutboundNetworkAccess
      operator: equals
      expected: Enabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_db_snapshot_cross_account_sharing_restricted
  name: 'AZURE SQL Database: Db Snapshot Cross Account Sharing Restricted'
  severity: LOW
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.isLedgerDatabase
      operator: equals
      expected: false
    - path: properties.requestedBackupStorageRedundancy
      operator: exists
      expected: true
    - path: properties.backupStorageRedundancy
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_db_snapshot_cross_region_copy_encrypted
  name: 'AZURE SQL Database: Db Snapshot Cross Region Copy Encrypted'
  severity: MEDIUM
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.transparentDataEncryption.status
      operator: equals
      expected: Enabled
    - path: properties.encryption.protectorType
      operator: exists
      expected: true
    - path: properties.backupStorageRedundancy
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_db_snapshot_encrypted
  name: 'AZURE SQL Database: Db Snapshot Encrypted'
  severity: MEDIUM
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.transparentDataEncryption.status
      operator: equals
      expected: Enabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_db_snapshot_not_publicly_shared
  name: 'AZURE SQL Database: Db Snapshot Not Publicly Shared'
  severity: CRITICAL
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
    - path: properties.restrictOutboundNetworkAccess
      operator: equals
      expected: Enabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_defender_pricing_tier_check
  name: 'AZURE SQL Database: Defender Pricing Tier Check'
  severity: MEDIUM
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.advancedThreatProtectionSettings.state
      operator: equals
      expected: Enabled
    - path: properties.securityAlertPolicies.state
      operator: equals
      expected: Enabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_deletion_protection
  name: 'AZURE SQL Database: Deletion Protection'
  severity: MEDIUM
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.deletionProtectionEnabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_diagnostic_settings_enabled
  name: 'AZURE SQL Database: Diagnostic Settings Enabled'
  severity: MEDIUM
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.diagnosticSettings
      operator: exists
      expected: true
    - path: properties.diagnosticSettings.logs
      operator: exists
      expected: true
    - path: properties.diagnosticSettings.metrics
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_encryption_at_rest_enabled
  name: 'AZURE SQL Database: Encryption At Rest Enabled'
  severity: HIGH
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.transparentDataEncryption.status
      operator: equals
      expected: Enabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_multi_az
  name: 'AZURE SQL Database: Multi Az'
  severity: MEDIUM
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.zoneRedundant
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_no_public_access
  name: 'AZURE SQL Database: No Public Access'
  severity: CRITICAL
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
    - path: properties.restrictOutboundNetworkAccess
      operator: equals
      expected: Enabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_snapshots_public_access
  name: 'AZURE SQL Database: Snapshots Public Access'
  severity: CRITICAL
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
    - path: properties.restrictOutboundNetworkAccess
      operator: equals
      expected: Enabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_database_tde_status_check
  name: 'AZURE SQL Database: Tde Status Check'
  severity: MEDIUM
  for_each: databases
  param: database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.transparentDataEncryption.status
      operator: equals
      expected: Enabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_dynamodb_table_encryption_enabled
  name: 'AZURE SQL Resource: Dynamodb Table Encryption Enabled'
  severity: HIGH
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryption.status
      operator: equals
      expected: Enabled
    - path: properties.encryption.keySource
      operator: exists
      expected: true
    - path: properties.transparentDataEncryption.status
      operator: equals
      expected: Enabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_geo_redundant_backup
  name: 'AZURE SQL Resource: Geo Redundant Backup'
  severity: MEDIUM
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.storageAccountType
      operator: equals
      expected: GRS
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_instance_no_public_access,_compute_securitygroup_allow_ingress_from_internet_to_all_ports,_compute_networkacl_allow_ingress_tcp_port_22,_awslambda_function_not_publicly_accessible,_compute_networkacl_allow_ingress_tcp_port_3389,_synapse_cluster_public_access,_search_service_domains_not_publicly_accessible,_storage_bucket_policy_public_write_access,_awslambda_function_inside_vpc,_storage_bucket_public_write_acl,_database_migration_instance_no_public_access,_machine_learning_notebook_instance_without_direct_internet_access_configured
  name: 'AZURE SQL Instance: No Public Access, Azure Compute Securitygroup Allow Ingress'
  severity: CRITICAL
  for_each: instances
  param: instance
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
    - path: properties.restrictOutboundNetworkAccess
      operator: equals
      expected: Enabled
    - path: properties.firewallRules
      operator: exists
      expected: true
    - path: properties.virtualNetworkRules
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_long_term_retention_enabled
  name: 'AZURE SQL Resource: Long Term Retention Enabled'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.longTermRetentionPolicy.weeklyRetention
      operator: exists
      expected: true
    - path: properties.longTermRetentionPolicy.monthlyRetention
      operator: exists
      expected: true
    - path: properties.longTermRetentionPolicy.yearlyRetention
      operator: exists
      expected: true
  multi_step: false
  logic: OR
  errors_as_fail: []
- check_id: sql_multi_az_enabled
  name: 'AZURE SQL Resource: Multi Az Enabled'
  severity: LOW
  for_each: resources
  param: resource
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.zoneRedundant
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_ad_admin_check
  name: 'AZURE SQL Server: Ad Admin Check'
  severity: CRITICAL
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.administrators.administratorType
      operator: equals
      expected: ActiveDirectory
    - path: properties.administrators.login
      operator: exists
      expected: true
    - path: properties.administrators.sid
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_audit_retention_check
  name: 'AZURE SQL Server: Audit Retention Check'
  severity: MEDIUM
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.auditingPolicy.retentionDays
      operator: exists
      expected: true
    - path: properties.auditingPolicy.retentionDays
      operator: equals
      expected: 90
    - path: properties.auditingPolicy.state
      operator: equals
      expected: Enabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_check_public_network_access_disabled
  name: 'AZURE SQL Server: Check Public Network Access Disabled'
  severity: CRITICAL
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_db_cluster_audit_logging_enabled
  name: 'AZURE SQL Server: Db Cluster Audit Logging Enabled'
  severity: MEDIUM
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.auditingSettings.state
      operator: equals
      expected: Enabled
    - path: properties.auditingSettings.storageEndpoint
      operator: exists
      expected: true
    - path: properties.auditingSettings.isAzureMonitorTargetEnabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_db_cluster_deletion_protection_enabled
  name: 'AZURE SQL Server: Db Cluster Deletion Protection Enabled'
  severity: LOW
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.deletionProtectionEnabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_db_cluster_encryption_at_rest_cmek
  name: 'AZURE SQL Server: Db Cluster Encryption At Rest Cmek'
  severity: HIGH
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryption.keySource
      operator: equals
      expected: Microsoft.Keyvault
    - path: properties.encryption.keyVaultProperties.keyName
      operator: exists
      expected: true
    - path: properties.encryption.keyVaultProperties.keyVaultUri
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_db_cluster_minor_version_auto_upgrade_enabled
  name: 'AZURE SQL Server: Db Cluster Minor Version Auto Upgrade Enabled'
  severity: LOW
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.minimalTlsVersion
      operator: exists
      expected: true
    - path: properties.automaticTuning.desiredState
      operator: equals
      expected: Auto
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_db_cluster_private_networking_enforced
  name: 'AZURE SQL Server: Db Cluster Private Networking Enforced'
  severity: MEDIUM
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
    - path: properties.restrictOutboundNetworkAccess
      operator: equals
      expected: Enabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_db_instance_deletion_protection_enabled
  name: 'AZURE SQL Server: Db Instance Deletion Protection Enabled'
  severity: LOW
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.restrictOutboundNetworkAccess
      operator: equals
      expected: true
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_db_instance_encryption_at_rest_enabled
  name: 'AZURE SQL Server: Db Instance Encryption At Rest Enabled'
  severity: HIGH
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryption.keySource
      operator: exists
      expected: true
    - path: properties.encryption.keySource
      operator: equals
      expected: Microsoft.Sql
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_db_instance_iam_or_managed_identity_auth_enabled_where_supported
  name: 'AZURE SQL Server: Db Instance IAM Or Managed Identity Auth Enabled Where
    Support'
  severity: MEDIUM
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: identity.type
      operator: exists
      expected: true
    - path: properties.administrators.administratorType
      operator: equals
      expected: ActiveDirectory
    - path: properties.administrators.azureADOnlyAuthentication
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_db_instance_public_access_disabled
  name: 'AZURE SQL Server: Db Instance Public Access Disabled'
  severity: CRITICAL
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_db_instance_require_tls_in_transit
  name: 'AZURE SQL Server: Db Instance Require TLS In Transit'
  severity: LOW
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.minimal_tls_version
      operator: exists
      expected: true
    - path: properties.minimal_tls_version
      operator: equals
      expected: '1.2'
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_db_parameter_group_audit_logging_enabled_where_supported
  name: 'AZURE SQL Server: Db Parameter Group Audit Logging Enabled Where Supported'
  severity: MEDIUM
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.auditingPolicy.auditLogsTableName
      operator: exists
      expected: true
    - path: properties.auditingPolicy.state
      operator: equals
      expected: Enabled
    - path: properties.auditingPolicy.storageEndpoint
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_db_parameter_group_insecure_features_disabled_where_applicable
  name: 'AZURE SQL Server: Db Parameter Group Insecure Features Disabled Where Applicable'
  severity: LOW
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.administratorLogin
      operator: exists
      expected: true
    - path: properties.version
      operator: exists
      expected: true
    - path: properties.minimalTlsVersion
      operator: equals
      expected: '1.2'
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
    - path: properties.restrictOutboundNetworkAccess
      operator: equals
      expected: Enabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_db_parameter_group_require_ssl
  name: 'AZURE SQL Server: Db Parameter Group Require SSL'
  severity: MEDIUM
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.minimalTlsVersion
      operator: exists
      expected: true
    - path: properties.minimalTlsVersion
      operator: equals
      expected: '1.2'
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_db_sg_egress_restricted
  name: 'AZURE SQL Server: Db Sg Egress Restricted'
  severity: LOW
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.restrictOutboundNetworkAccess
      operator: equals
      expected: Enabled
    - path: properties.firewallRules
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_db_sg_no_0_0_0_0_ingress_on_db_ports
  name: 'AZURE SQL Server: Db Sg No 0 0 0 0 Ingress On Db Ports'
  severity: LOW
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.firewallRules
      operator: exists
      expected: true
    - path: properties.firewallRules[*].startIpAddress
      operator: equals
      expected: 0.0.0.0
    - path: properties.firewallRules[*].endIpAddress
      operator: equals
      expected: 0.0.0.0
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_db_sg_only_required_ports_open
  name: 'AZURE SQL Server: Db Sg Only Required Ports Open'
  severity: LOW
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.firewallRules
      operator: exists
      expected: true
    - path: properties.firewallRules[*].startIpAddress
      operator: equals
      expected: 0.0.0.0
    - path: properties.firewallRules[*].endIpAddress
      operator: equals
      expected: 0.0.0.0
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_db_subnet_group_private_subnets_only
  name: 'AZURE SQL Server: Db Subnet Group Private Subnets Only'
  severity: LOW
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.virtualNetworkRules
      operator: exists
      expected: true
    - path: properties.virtualNetworkRules[*].virtualNetworkSubnetId
      operator: contains
      expected: /subnets/
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_firewall_no_open_access_check
  name: 'AZURE SQL Server: Firewall No Open Access Check'
  severity: MEDIUM
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
    - path: properties.restrictOutboundNetworkAccess
      operator: equals
      expected: Enabled
  multi_step: false
  logic: OR
  errors_as_fail: []
- check_id: sql_server_tde_protector_customer_key_check
  name: 'AZURE SQL Server: Tde Protector Customer Key Check'
  severity: HIGH
  for_each: servers
  param: server
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryption.protector.serverKeyType
      operator: equals
      expected: AzureKeyVault
    - path: properties.encryption.protector.serverKeyName
      operator: exists
      expected: true
    - path: properties.encryption.protector.uri
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_configuration_db_option_group_insecure_extensions_not_enabled
  name: 'AZURE SQL Server_configuration: Db Option Group Insecure Extensions Not Enabled'
  severity: LOW
  for_each: server_configurations
  param: server_configuration
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.configurationOptions.dbOptionsGroup.insecureExtensionsEnabled
      operator: equals
      expected: false
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_server_configuration_db_option_group_only_approved_extensions_enabled
  name: 'AZURE SQL Server_configuration: Db Option Group Only Approved Extensions
    Enabled'
  severity: LOW
  for_each: server_configurations
  param: server_configuration
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.optionGroupSettings.extensions
      operator: exists
      expected: true
    - path: properties.optionGroupSettings.extensions
      operator: contains
      expected: approved_extensions_only
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_storage_encrypted
  name: 'AZURE SQL Storage: Encrypted'
  severity: MEDIUM
  for_each: storages
  param: storage
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryption.keySource
      operator: exists
      expected: true
    - path: properties.encryption.services.blob.enabled
      operator: equals
      expected: true
    - path: properties.encryption.services.file.enabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_user_db_approved_list_of_superusers_only
  name: 'AZURE SQL User: Db Approved List Of Superusers Only'
  severity: MEDIUM
  for_each: users
  param: user
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.administratorType
      operator: equals
      expected: ActiveDirectory
    - path: properties.principalType
      operator: equals
      expected: User
    - path: properties.sid
      operator: exists
      expected: true
    - path: name
      operator: contains
      expected: approved
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_user_db_no_unused_or_default_superusers
  name: 'AZURE SQL User: Db No Unused Or Default Superusers'
  severity: MEDIUM
  for_each: users
  param: user
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.principalType
      operator: equals
      expected: User
    - path: properties.defaultSchema
      operator: exists
      expected: true
    - path: properties.loginName
      operator: contains
      expected: false
    - path: properties.hasDbAccess
      operator: equals
      expected: true
    - path: properties.isSystemObject
      operator: equals
      expected: false
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: sql_user_db_password_auth_hardened_or_iam_auth_preferred_where_supported
  name: 'AZURE SQL User: Db Password Auth Hardened Or IAM Auth Preferred Where Supported'
  severity: MEDIUM
  for_each: users
  param: user
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.authenticationType
      operator: equals
      expected: SqlPassword
    - path: properties.loginName
      operator: exists
      expected: true
    - path: properties.password
      operator: exists
      expected: false
  - action: identity
    params: {}
    fields:
    - path: properties.authenticationType
      operator: equals
      expected: ActiveDirectoryPassword
    - path: properties.sid
      operator: exists
      expected: true
  multi_step: false
  logic: OR
  errors_as_fail: []
