version: '1.0'
provider: azure
service: data
discovery: []
checks:
- check_id: data_factory_dataset_pipeline_object_environment_no_plaintext_secrets
  name: 'AZURE DATA Factory_dataset: Pipeline Object Environment No Plaintext Secrets'
  severity: HIGH
  for_each: factory_datasets
  param: factory_dataset
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.linkedServiceName.parameters
      operator: exists
      expected: true
    - path: properties.parameters
      operator: exists
      expected: true
    - path: properties.activities
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_dataset_pipeline_object_execution_role_least_privilege
  name: 'AZURE DATA Factory_dataset: Pipeline Object Execution Role Least Privilege'
  severity: HIGH
  for_each: factory_datasets
  param: factory_dataset
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.linkedServiceName.referenceName
      operator: exists
      expected: true
    - path: properties.parameters
      operator: exists
      expected: true
    - path: properties.activities
      operator: exists
      expected: true
    - path: identity.type
      operator: equals
      expected: SystemAssigned
    - path: properties.roleAssignments
      operator: exists
      expected: true
    - path: properties.accessPolicies
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_dataset_pipeline_object_logging_enabled
  name: 'AZURE DATA Factory_dataset: Pipeline Object Logging Enabled'
  severity: MEDIUM
  for_each: factory_datasets
  param: factory_dataset
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.linkedServiceName
      operator: exists
      expected: true
    - path: properties.activities
      operator: exists
      expected: true
    - path: properties.policy.activityPolicy.logging.enableLogging
      operator: equals
      expected: true
    - path: properties.policy.activityPolicy.logging.logLevel
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_dataset_pipeline_object_network_private_only
  name: 'AZURE DATA Factory_dataset: Pipeline Object Network Private Only'
  severity: MEDIUM
  for_each: factory_datasets
  param: factory_dataset
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.typeProperties.publicNetworkAccess
      operator: equals
      expected: Disabled
    - path: properties.typeProperties.privateEndpointConnections
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_pipeline_definition_signed_and_verified
  name: 'AZURE DATA Factory_pipeline: Pipeline Definition Signed And Verified'
  severity: MEDIUM
  for_each: factory_pipelines
  param: factory_pipeline
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.definition.signature
      operator: exists
      expected: true
    - path: properties.definition.signature.verified
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_pipeline_definition_storage_encrypted
  name: 'AZURE DATA Factory_pipeline: Pipeline Definition Storage Encrypted'
  severity: MEDIUM
  for_each: factory_pipelines
  param: factory_pipeline
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryption.keySource
      operator: exists
      expected: true
    - path: properties.encryption.keySource
      operator: equals
      expected: Microsoft.KeyVault
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_pipeline_definition_storage_private
  name: 'AZURE DATA Factory_pipeline: Pipeline Definition Storage Private'
  severity: LOW
  for_each: factory_pipelines
  param: factory_pipeline
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.policy.secureInput
      operator: equals
      expected: true
    - path: properties.policy.secureOutput
      operator: equals
      expected: true
    - path: properties.parameters
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_pipeline_definition_version_immutability_enforced
  name: 'AZURE DATA Factory_pipeline: Pipeline Definition Version Immutability Enforced'
  severity: MEDIUM
  for_each: factory_pipelines
  param: factory_pipeline
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.policy.elapsedTimeMetric.duration
      operator: exists
      expected: true
    - path: properties.parameters
      operator: exists
      expected: true
    - path: properties.folder.name
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_pipeline_pipeline_artifacts_private_and_encrypted
  name: 'AZURE DATA Factory_pipeline: Pipeline Pipeline Artifacts Private And Encrypted'
  severity: MEDIUM
  for_each: factory_pipelines
  param: factory_pipeline
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
    - path: properties.encryption
      operator: exists
      expected: true
    - path: properties.encryption.keySource
      operator: equals
      expected: Microsoft.KeyVault
    - path: properties.managedVirtualNetwork
      operator: exists
      expected: true
    - path: properties.managedPrivateEndpoints
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_pipeline_pipeline_execution_roles_least_privilege
  name: 'AZURE DATA Factory_pipeline: Pipeline Pipeline Execution Roles Least Privilege'
  description: Validates that AZURE data factory_pipeline has pipeline pipeline execution
    roles least privilege configured according to security best practices. Proper
    configuration reduces security risks, prevents unauthorized access.
  severity: HIGH
  for_each: factory_pipelines
  param: factory_pipeline
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.activities
      operator: exists
      expected: true
    - path: properties.activities[*].typeProperties.linkedServiceName
      operator: exists
      expected: true
    - path: properties.parameters
      operator: exists
      expected: true
    - path: properties.runDimensions
      operator: exists
      expected: false
    - path: identity.type
      operator: equals
      expected: SystemAssigned
    - path: properties.activities[*].dependsOn
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_pipeline_pipeline_kms_encryption_enabled
  name: 'AZURE DATA Factory_pipeline: Pipeline Pipeline KMS Encryption Enabled'
  severity: HIGH
  for_each: factory_pipelines
  param: factory_pipeline
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryption.keySource
      operator: equals
      expected: Microsoft.KeyVault
    - path: properties.encryption.keyName
      operator: exists
      expected: true
    - path: properties.encryption.keyVersion
      operator: exists
      expected: true
    - path: properties.encryption.keyVaultUri
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_pipeline_pipeline_logs_and_metrics_enabled
  name: 'AZURE DATA Factory_pipeline: Pipeline Pipeline Logs And Metrics Enabled'
  severity: LOW
  for_each: factory_pipelines
  param: factory_pipeline
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.activities
      operator: exists
      expected: true
    - path: properties.pipeline.activities
      operator: exists
      expected: true
    - path: properties.logging_enabled
      operator: equals
      expected: true
    - path: properties.metrics_enabled
      operator: equals
      expected: true
    - path: properties.monitoring.enabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_pipeline_pipeline_private_networking_enforced
  name: 'AZURE DATA Factory_pipeline: Pipeline Pipeline Private Networking Enforced'
  severity: MEDIUM
  for_each: factory_pipelines
  param: factory_pipeline
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
    - path: properties.privateEndpointConnections
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_allowed_values_defined_where_applicable
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Allowed Values
    Defined'
  severity: MEDIUM
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.allowedValues
      operator: exists
      expected: true
    - path: properties.allowedValues
      operator: not_empty
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_attributes_no_plaintext_secrets
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Attributes No Plaintex'
  severity: HIGH
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.parameters.*.type
      operator: equals
      expected: SecureString
    - path: properties.parameters.*.defaultValue
      operator: exists
      expected: false
    - path: properties.activities.*.typeProperties.*.value
      operator: contains
      expected: '@parameters'
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_binding_only_expected_params_bound
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Binding Only Expected'
  severity: MEDIUM
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.parameters
      operator: exists
      expected: true
    - path: properties.activities
      operator: exists
      expected: true
    - path: properties.activities[*].dependsOn[*].activity
      operator: contains
      expected: '@pipeline().parameters'
    - path: properties.activities[*].typeProperties
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_binding_secret_refs_resolved_at_runtime
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Binding Secret
    Refs Re'
  severity: HIGH
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.parameters.*.type
      operator: equals
      expected: SecureString
    - path: properties.parameters.*.defaultValue
      operator: exists
      expected: false
    - path: properties.pipeline.parameters.*.type
      operator: equals
      expected: SecureString
    - path: properties.pipeline.parameters.*.defaultValue
      operator: exists
      expected: false
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_binding_sensitive_params_not_logged
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Binding Sensitive
    Para'
  severity: LOW
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.parameters
      operator: exists
      expected: true
    - path: properties.activities
      operator: exists
      expected: true
    - path: properties.logging.enableActivityLevelLogging
      operator: equals
      expected: false
    - path: properties.parameters.*.type
      operator: contains
      expected: SecureString
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_constraint_allowlist_defined_when_applicable
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Constraint Allowlist
    D'
  severity: MEDIUM
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.defaultValue
      operator: exists
      expected: true
    - path: properties.allowedValues
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_constraint_max_length_defined_when_applicable
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Constraint Max
    Length'
  severity: MEDIUM
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.type
      operator: equals
      expected: String
    - path: properties.maxLength
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_constraint_min_length_defined_when_applicable
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Constraint Min
    Length'
  severity: MEDIUM
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: type
      operator: equals
      expected: String
    - path: properties.minLength
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_constraint_pattern_defined_when_applicable
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Constraint Pattern
    Def'
  severity: MEDIUM
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.defaultValue
      operator: exists
      expected: true
    - path: properties.type
      operator: exists
      expected: true
    - path: properties.constraints.pattern
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_default_not_sensitive
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Default Not Sensitive'
  severity: MEDIUM
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.defaultValue
      operator: exists
      expected: false
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_max_length_defined_where_applicable
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Max Length Defined
    Where Applicable'
  severity: MEDIUM
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.parameters
      operator: exists
      expected: true
    - path: properties.parameters.*.type
      operator: equals
      expected: String
    - path: properties.parameters.*.maxLength
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_metadata_disallowed_attribute_keys_blocked
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Metadata Disallowed
    At'
  severity: HIGH
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.parameters.*.metadata
      operator: exists
      expected: true
    - path: properties.parameters.*.metadata.sensitive
      operator: equals
      expected: false
    - path: properties.parameters.*.metadata.debug
      operator: exists
      expected: false
    - path: properties.parameters.*.metadata.password
      operator: exists
      expected: false
    - path: properties.parameters.*.metadata.secret
      operator: exists
      expected: false
    - path: properties.parameters.*.metadata.internal
      operator: exists
      expected: false
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_metadata_sensitive_keys_require_secret_type
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Metadata Sensitive
    Key'
  severity: HIGH
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.parameters
      operator: exists
      expected: true
    - path: properties.parameters[*].type
      operator: equals
      expected: SecureString
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_metadata_values_not_plaintext_secret
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Metadata Values
    Not Plaintext Secret'
  severity: HIGH
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.parameters
      operator: exists
      expected: true
    - path: properties.parameters.*.metadata.description
      operator: contains
      expected: false
    - path: properties.parameters.*.metadata.sensitive
      operator: equals
      expected: true
    - path: properties.parameters.*.defaultValue
      operator: contains
      expected: false
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_min_length_defined_where_applicable
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Min Length Defined
    Where Applicable'
  severity: MEDIUM
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.parameters
      operator: exists
      expected: true
    - path: properties.parameters.*.type
      operator: equals
      expected: String
    - path: properties.parameters.*.minLength
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_pattern_defined_where_applicable
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Pattern Defined
    Where Applicable'
  severity: MEDIUM
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.pattern
      operator: exists
      expected: true
    - path: properties.pattern
      operator: equals
      expected: ''
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_type_set
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Type Set'
  severity: MEDIUM
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: type
      operator: exists
      expected: true
    - path: type
      operator: equals
      expected: ''
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_parameter_pipeline_parameter_value_from_secrets_manager_when_sensitive
  name: 'AZURE DATA Factory_pipeline_parameter: Pipeline Parameter Value From Secrets
    Man'
  severity: HIGH
  for_each: factory_pipeline_parameters
  param: factory_pipeline_parameter
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.defaultValue
      operator: contains
      expected: '@Microsoft.KeyVault'
    - path: type
      operator: equals
      expected: SecureString
  multi_step: false
  logic: OR
  errors_as_fail: []
- check_id: data_factory_pipeline_run_analytics_snapshot_encrypted_at_rest_cmek
  name: 'AZURE DATA Factory_pipeline_run: Analytics Snapshot Encrypted At Rest Cmek'
  severity: MEDIUM
  for_each: factory_pipeline_runs
  param: factory_pipeline_run
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryption.keySource
      operator: equals
      expected: Microsoft.KeyVault
    - path: properties.encryption.keyVaultProperties.keyIdentifier
      operator: exists
      expected: true
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_run_analytics_snapshot_kms_key_policy_least_privilege
  name: 'AZURE DATA Factory_pipeline_run: Analytics Snapshot KMS Key Policy Least
    Privilege'
  severity: HIGH
  for_each: factory_pipeline_runs
  param: factory_pipeline_run
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryption.keyVaultProperties.keyName
      operator: exists
      expected: true
    - path: properties.encryption.keyVaultProperties.keyVersion
      operator: exists
      expected: true
    - path: properties.encryption.identity.type
      operator: equals
      expected: SystemAssigned
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_factory_pipeline_run_analytics_snapshot_not_publicly_shared
  name: 'AZURE DATA Factory_pipeline_run: Analytics Snapshot Not Publicly Shared'
  severity: CRITICAL
  for_each: factory_pipeline_runs
  param: factory_pipeline_run
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
    - path: properties.analytics.enabled
      operator: equals
      expected: false
    - path: properties.globalParameters.publicAccess
      operator: exists
      expected: false
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_catalog_datalake_catalog_audit_logging_enabled
  name: 'AZURE DATA Lake_analytics_catalog: Datalake Catalog Audit Logging Enabled'
  severity: MEDIUM
  for_each: lake_analytics_catalogs
  param: lake_analytics_catalog
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.auditLoggingEnabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_catalog_datalake_catalog_cross_account_sharing_restricted
  name: 'AZURE DATA Lake_analytics_catalog: Datalake Catalog Cross Account Sharing
    Restri'
  severity: LOW
  for_each: lake_analytics_catalogs
  param: lake_analytics_catalog
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.crossAccountSharingEnabled
      operator: equals
      expected: false
    - path: properties.catalogSettings.crossTenantAccessEnabled
      operator: equals
      expected: false
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_catalog_datalake_catalog_metaencryption_enabled
  name: 'AZURE DATA Lake_analytics_catalog: Datalake Catalog Metaencryption Enabled'
  severity: HIGH
  for_each: lake_analytics_catalogs
  param: lake_analytics_catalog
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.defaultDataLakeStoreAccount.properties.encryptionConfig.type
      operator: equals
      expected: ServiceManaged
    - path: properties.catalogEncryption.keySource
      operator: equals
      expected: Microsoft.DataLakeAnalytics
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_catalog_datalake_catalog_rbac_least_privilege
  name: 'AZURE DATA Lake_analytics_catalog: Datalake Catalog RBAC Least Privilege'
  severity: HIGH
  for_each: lake_analytics_catalogs
  param: lake_analytics_catalog
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.catalog.rbac.enabled
      operator: equals
      expected: true
    - path: properties.catalog.rbac.permissions
      operator: exists
      expected: true
    - path: properties.catalog.rbac.permissions[*].permission
      operator: contains
      expected: Read
    - path: properties.catalog.rbac.permissions[*].principalType
      operator: equals
      expected: User
    - path: properties.catalog.rbac.inheritanceEnabled
      operator: equals
      expected: false
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_classifier_datalake_classifier_definition_version_pinned
  name: 'AZURE DATA Lake_analytics_classifier: Datalake Classifier Definition Version
    Pin'
  severity: MEDIUM
  for_each: lake_analytics_classifiers
  param: lake_analytics_classifier
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.classifierDefinition.version
      operator: exists
      expected: true
    - path: properties.classifierDefinition.version
      operator: equals
      expected: ''
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_classifier_datalake_classifier_rbac_least_privilege
  name: 'AZURE DATA Lake_analytics_classifier: Datalake Classifier RBAC Least Privilege'
  severity: HIGH
  for_each: lake_analytics_classifiers
  param: lake_analytics_classifier
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.roleAssignments
      operator: exists
      expected: true
    - path: properties.roleAssignments[*].principalType
      operator: contains
      expected: User
    - path: properties.roleAssignments[*].roleDefinitionName
      operator: equals
      expected: Data Lake Analytics Developer
    - path: properties.minimumRequiredPermissions
      operator: equals
      expected: Read
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_classifier_datalake_classifier_source_trusted
  name: 'AZURE DATA Lake_analytics_classifier: Datalake Classifier Source Trusted'
  severity: MEDIUM
  for_each: lake_analytics_classifiers
  param: lake_analytics_classifier
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.classifierSource
      operator: equals
      expected: trusted
    - path: properties.isEnabled
      operator: equals
      expected: true
    - path: properties.trustedSourceConfiguration
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_compute_policy_datalake_dev_endpoint_encrypted
  name: 'AZURE DATA Lake_analytics_compute_policy: Datalake Dev Endpoint Encrypted'
  severity: MEDIUM
  for_each: lake_analytics_compute_policys
  param: lake_analytics_compute_policy
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryption.enabled
      operator: equals
      expected: true
    - path: properties.devEndpointEncryption.enabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_compute_policy_datalake_dev_endpoint_no_public_access
  name: 'AZURE DATA Lake_analytics_compute_policy: Datalake Dev Endpoint No Public
    Access'
  severity: CRITICAL
  for_each: lake_analytics_compute_policys
  param: lake_analytics_compute_policy
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.is_public_ip_allowed
      operator: equals
      expected: false
    - path: properties.public_ip_policy
      operator: equals
      expected: Deny
    - path: properties.enable_public_access
      operator: equals
      expected: false
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_compute_policy_datalake_dev_endpoint_role_least_privilege
  name: 'AZURE DATA Lake_analytics_compute_policy: Datalake Dev Endpoint Role Least
    Privi'
  severity: HIGH
  for_each: lake_analytics_compute_policys
  param: lake_analytics_compute_policy
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.objectType
      operator: equals
      expected: User
    - path: properties.permissions
      operator: contains
      expected: Read
    - path: properties.permissions
      operator: not_contains
      expected: FullAccess
    - path: properties.maxDegreeOfParallelismPerJob
      operator: exists
      expected: true
    - path: properties.minPriorityPerJob
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_connection_datalake_connection_credentials_in_secrets_manager
  name: 'AZURE DATA Lake_analytics_connection: Datalake Connection Credentials In
    Secrets'
  severity: HIGH
  for_each: lake_analytics_connections
  param: lake_analytics_connection
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.typeProperties.useManagedIdentity
      operator: equals
      expected: true
    - path: properties.typeProperties.servicePrincipalCredentialType
      operator: equals
      expected: ServicePrincipalKey
    - path: properties.typeProperties.servicePrincipalCredential.type
      operator: equals
      expected: AzureKeyVaultSecret
    - path: properties.typeProperties.accountName
      operator: exists
      expected: true
    - path: properties.typeProperties.resourceGroupName
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_connection_datalake_connection_private_networking_enforced
  name: 'AZURE DATA Lake_analytics_connection: Datalake Connection Private Networking
    Enf'
  severity: MEDIUM
  for_each: lake_analytics_connections
  param: lake_analytics_connection
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.isPrivateConnectionEnabled
      operator: equals
      expected: true
    - path: properties.privateEndpointConnections
      operator: exists
      expected: true
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_connection_datalake_connection_role_least_privilege
  name: 'AZURE DATA Lake_analytics_connection: Datalake Connection Role Least Privilege'
  severity: HIGH
  for_each: lake_analytics_connections
  param: lake_analytics_connection
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.dataLakeStoreAccount.properties.roleAssignments
      operator: exists
      expected: true
    - path: properties.dataLakeStoreAccount.properties.roleAssignments[*].roleDefinitionName
      operator: contains
      expected: Storage Blob Data Reader
    - path: properties.dataLakeStoreAccount.properties.roleAssignments[*].roleDefinitionName
      operator: contains
      expected: Data Lake Analytics Developer
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_connection_datalake_connection_tls_required
  name: 'AZURE DATA Lake_analytics_connection: Datalake Connection TLS Required'
  severity: MEDIUM
  for_each: lake_analytics_connections
  param: lake_analytics_connection
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryptionConfig.type
      operator: equals
      expected: ServiceManaged
    - path: properties.isDefault
      operator: exists
      expected: true
    - path: properties.suffix
      operator: contains
      expected: azuredatalakestore.net
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_database_datalake_database_cross_account_sharing_restricted
  name: 'AZURE DATA Lake_analytics_database: Datalake Database Cross Account Sharing
    Rest'
  severity: MEDIUM
  for_each: lake_analytics_databases
  param: lake_analytics_database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.crossTenantReplicationEnabled
      operator: equals
      expected: false
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_database_datalake_database_encrypted
  name: 'AZURE DATA Lake_analytics_database: Datalake Database Encrypted'
  severity: MEDIUM
  for_each: lake_analytics_databases
  param: lake_analytics_database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryptionConfig.type
      operator: exists
      expected: true
    - path: properties.encryptionConfig.type
      operator: equals
      expected: ServiceManaged
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_database_datalake_database_policy_least_privilege
  name: 'AZURE DATA Lake_analytics_database: Datalake Database Policy Least Privilege'
  severity: HIGH
  for_each: lake_analytics_databases
  param: lake_analytics_database
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.defaultSchema
      operator: exists
      expected: true
    - path: properties.catalogCollation
      operator: exists
      expected: true
    - path: properties.catalogName
      operator: exists
      expected: true
    - path: properties.catalogMetadata.permissions
      operator: exists
      expected: true
    - path: properties.catalogMetadata.permissions.*.principalType
      operator: contains
      expected: User
    - path: properties.catalogMetadata.permissions.*.permission
      operator: contains
      expected: Read
    - path: properties.catalogMetadata.defaultPermissions
      operator: exists
      expected: true
    - path: properties.catalogMetadata.defaultPermissions.permission
      operator: equals
      expected: Read
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_job_datalake_crawler_logs_enabled
  name: 'AZURE DATA Lake_analytics_job: Datalake Crawler Logs Enabled'
  severity: LOW
  for_each: lake_analytics_jobs
  param: lake_analytics_job
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.log_file_patterns
      operator: exists
      expected: true
    - path: properties.debug_info
      operator: equals
      expected: All
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_job_datalake_crawler_network_private_only
  name: 'AZURE DATA Lake_analytics_job: Datalake Crawler Network Private Only'
  severity: MEDIUM
  for_each: lake_analytics_jobs
  param: lake_analytics_job
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.network_access_control.is_public_network_access_enabled
      operator: equals
      expected: false
    - path: properties.crawler_configuration.network_mode
      operator: equals
      expected: private
    - path: properties.virtual_network_configuration.subnet_id
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_job_datalake_crawler_role_least_privilege
  name: 'AZURE DATA Lake_analytics_job: Datalake Crawler Role Least Privilege'
  severity: HIGH
  for_each: lake_analytics_jobs
  param: lake_analytics_job
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.degreeOfParallelism
      operator: exists
      expected: true
    - path: properties.priority
      operator: exists
      expected: true
    - path: properties.runtimeVersion
      operator: exists
      expected: true
    - path: properties.script
      operator: contains
      expected: GRANT
    - path: properties.type
      operator: equals
      expected: USql
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_job_datalake_crawler_scope_restricted_to_allowlist
  name: 'AZURE DATA Lake_analytics_job: Datalake Crawler Scope Restricted To Allowlist'
  severity: MEDIUM
  for_each: lake_analytics_jobs
  param: lake_analytics_job
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.crawler.scope.allowList
      operator: exists
      expected: true
    - path: properties.crawler.scope.restrictToAllowList
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_job_datalake_job_logs_and_metrics_enabled
  name: 'AZURE DATA Lake_analytics_job: Datalake Job Logs And Metrics Enabled'
  severity: LOW
  for_each: lake_analytics_jobs
  param: lake_analytics_job
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.degreeOfParallelism
      operator: exists
      expected: true
    - path: properties.logFilePatterns
      operator: exists
      expected: true
    - path: properties.priority
      operator: exists
      expected: true
    - path: properties.runtimeVersion
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_job_datalake_job_network_private_only
  name: 'AZURE DATA Lake_analytics_job: Datalake Job Network Private Only'
  severity: MEDIUM
  for_each: lake_analytics_jobs
  param: lake_analytics_job
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.runInformation.networkIsolationLevel
      operator: equals
      expected: private
    - path: properties.runInformation.publicNetworkAccess
      operator: equals
      expected: disabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_job_datalake_job_role_least_privilege
  name: 'AZURE DATA Lake_analytics_job: Datalake Job Role Least Privilege'
  severity: HIGH
  for_each: lake_analytics_jobs
  param: lake_analytics_job
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.degreeOfParallelism
      operator: exists
      expected: true
    - path: properties.priority
      operator: exists
      expected: true
    - path: properties.runtimeVersion
      operator: exists
      expected: true
    - path: properties.script
      operator: exists
      expected: true
    - path: properties.type
      operator: equals
      expected: USql
    - path: properties.degreeOfParallelism
      operator: equals
      expected: 1
    - path: properties.priority
      operator: equals
      expected: 1000
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_job_datalake_job_script_location_private_and_encrypted
  name: 'AZURE DATA Lake_analytics_job: Datalake Job Script Location Private And Encrypte'
  severity: MEDIUM
  for_each: lake_analytics_jobs
  param: lake_analytics_job
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.script.uri
      operator: contains
      expected: https://
    - path: properties.script.storageAccount.isDefault
      operator: equals
      expected: false
    - path: properties.script.storageAccount.encryptionType
      operator: equals
      expected: ServiceManaged
    - path: properties.script.storageAccount.publicNetworkAccess
      operator: equals
      expected: Disabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_lineage_datalake_lineage_access_rbac_least_privilege
  name: 'AZURE DATA Lake_analytics_lineage: Datalake Lineage Access RBAC Least Privilege'
  severity: HIGH
  for_each: lake_analytics_lineages
  param: lake_analytics_lineage
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.dataLineageAccess.roleAssignments
      operator: exists
      expected: true
    - path: properties.dataLineageAccess.roleAssignments[*].roleDefinitionId
      operator: contains
      expected: Reader
    - path: properties.dataLineageAccess.inheritPermissions
      operator: equals
      expected: false
    - path: properties.dataLineageAccess.customRoleAssignments[*].permissions
      operator: exists
      expected: true
    - path: properties.accessControl.minimumPermissions
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_lineage_datalake_lineage_capture_enabled
  name: 'AZURE DATA Lake_analytics_lineage: Datalake Lineage Capture Enabled'
  severity: MEDIUM
  for_each: lake_analytics_lineages
  param: lake_analytics_lineage
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.lineageSettings.enabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_lineage_datalake_lineage_export_destination_encrypted
  name: 'AZURE DATA Lake_analytics_lineage: Datalake Lineage Export Destination Encrypted'
  severity: MEDIUM
  for_each: lake_analytics_lineages
  param: lake_analytics_lineage
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.lineageExportSettings.encryptionEnabled
      operator: equals
      expected: true
    - path: properties.lineageExportSettings.encryptionConfiguration.keySource
      operator: exists
      expected: null
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_ml_transform_datalake_ml_transform_logs_enabled
  name: 'AZURE DATA Lake_analytics_ml_transform: Datalake Ml Transform Logs Enabled'
  severity: LOW
  for_each: lake_analytics_ml_transforms
  param: lake_analytics_ml_transform
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.diagnosticSettings.logs.enabled
      operator: equals
      expected: true
    - path: properties.diagnosticSettings.logs.category
      operator: contains
      expected: MLTransform
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_ml_transform_datalake_ml_transform_network_private_only
  name: 'AZURE DATA Lake_analytics_ml_transform: Datalake Ml Transform Network Private
    On'
  severity: MEDIUM
  for_each: lake_analytics_ml_transforms
  param: lake_analytics_ml_transform
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.networkConfiguration.enablePrivateEndpoint
      operator: equals
      expected: true
    - path: properties.networkConfiguration.publicNetworkAccess
      operator: equals
      expected: Disabled
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_ml_transform_datalake_ml_transform_role_least_privilege
  name: 'AZURE DATA Lake_analytics_ml_transform: Datalake Ml Transform Role Least
    Privile'
  severity: HIGH
  for_each: lake_analytics_ml_transforms
  param: lake_analytics_ml_transform
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.role_assignments
      operator: exists
      expected: true
    - path: properties.role_assignments.*.role_definition_name
      operator: contains
      expected: Data Lake Analytics Developer
    - path: properties.permissions.*.actions
      operator: contains
      expected: Microsoft.DataLakeAnalytics/accounts/transforms/*
    - path: properties.permissions.*.not_actions
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_partition_datalake_partition_access_policies_least_privilege
  name: 'AZURE DATA Lake_analytics_partition: Datalake Partition Access Policies Least
    Pr'
  severity: HIGH
  for_each: lake_analytics_partitions
  param: lake_analytics_partition
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.access_policies
      operator: exists
      expected: true
    - path: properties.access_policies.permissions
      operator: contains
      expected: Read
    - path: properties.access_policies.permissions
      operator: contains
      expected: Write
    - path: properties.access_policies.permissions
      operator: contains
      expected: Execute
    - path: properties.minimum_required_permissions
      operator: equals
      expected: Read
    - path: properties.access_control.enforce_least_privilege
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_partition_datalake_partition_catalog_encrypted
  name: 'AZURE DATA Lake_analytics_partition: Datalake Partition Catalog Encrypted'
  severity: MEDIUM
  for_each: lake_analytics_partitions
  param: lake_analytics_partition
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.catalogEncryption.enabled
      operator: equals
      expected: true
    - path: properties.catalogEncryption.keyVaultMetaInfo.keyVaultResourceId
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_quality_datalake_quality_logs_enabled
  name: 'AZURE DATA Lake_analytics_quality: Datalake Quality Logs Enabled'
  severity: LOW
  for_each: lake_analytics_qualitys
  param: lake_analytics_quality
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.logs.enabled
      operator: equals
      expected: true
    - path: properties.logs.categories
      operator: exists
      expected: true
    - path: properties.logs.retentionPolicy.enabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_quality_datalake_quality_output_location_private_and_encrypted
  name: 'AZURE DATA Lake_analytics_quality: Datalake Quality Output Location Private
    And Encrypted'
  severity: MEDIUM
  for_each: lake_analytics_qualitys
  param: lake_analytics_quality
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.outputConfiguration.location.isPrivate
      operator: equals
      expected: true
    - path: properties.outputConfiguration.encryption.enabled
      operator: equals
      expected: true
    - path: properties.outputConfiguration.encryption.keySource
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_quality_datalake_quality_role_least_privilege
  name: 'AZURE DATA Lake_analytics_quality: Datalake Quality Role Least Privilege'
  severity: HIGH
  for_each: lake_analytics_qualitys
  param: lake_analytics_quality
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.roleAssignments
      operator: exists
      expected: true
    - path: properties.roleAssignments.permissions
      operator: contains
      expected: Reader
    - path: properties.roleAssignments.scope
      operator: equals
      expected: minimal
    - path: properties.access.defaultAction
      operator: equals
      expected: Deny
    - path: properties.principalType
      operator: equals
      expected: User
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_registry_datalake_registry_cross_account_sharing_restricted
  name: 'AZURE DATA Lake_analytics_registry: Datalake Registry Cross Account Sharing
    Rest'
  severity: MEDIUM
  for_each: lake_analytics_registrys
  param: lake_analytics_registry
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.crossAccountSharingEnabled
      operator: equals
      expected: false
    - path: properties.publicNetworkAccess
      operator: equals
      expected: Disabled
    - path: properties.allowCrossAccountAccess
      operator: equals
      expected: false
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_registry_datalake_registry_metaencryption_enabled
  name: 'AZURE DATA Lake_analytics_registry: Datalake Registry Metaencryption Enabled'
  severity: HIGH
  for_each: lake_analytics_registrys
  param: lake_analytics_registry
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryption.enabled
      operator: equals
      expected: true
    - path: properties.encryption.keySource
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_registry_datalake_registry_rbac_least_privilege
  name: 'AZURE DATA Lake_analytics_registry: Datalake Registry RBAC Least Privilege'
  severity: HIGH
  for_each: lake_analytics_registrys
  param: lake_analytics_registry
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.roleAssignments
      operator: exists
      expected: true
    - path: properties.roleAssignments[*].roleDefinitionId
      operator: contains
      expected: ba92f5b4-2d11-453d-a403-e96b0029c9fe
    - path: properties.roleAssignments[*].principalType
      operator: equals
      expected: User
    - path: properties.accessPolicies[*].permissions.data
      operator: contains
      expected: r
    - path: properties.defaultDataLakeStorageAccountName
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_schema_datalake_schema_encrypted
  name: 'AZURE DATA Lake_analytics_schema: Datalake Schema Encrypted'
  severity: MEDIUM
  for_each: lake_analytics_schemas
  param: lake_analytics_schema
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryption.keySource
      operator: exists
      expected: true
    - path: properties.encryption.keySource
      operator: equals
      expected: Microsoft.KeyVault
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_schema_datalake_schema_rbac_least_privilege
  name: 'AZURE DATA Lake_analytics_schema: Datalake Schema RBAC Least Privilege'
  severity: HIGH
  for_each: lake_analytics_schemas
  param: lake_analytics_schema
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.roleAssignments
      operator: exists
      expected: true
    - path: properties.roleAssignments.*.principalType
      operator: contains
      expected: User
    - path: properties.roleAssignments.*.roleDefinitionId
      operator: exists
      expected: true
    - path: properties.permissions.minimumPrivilegeEnabled
      operator: equals
      expected: true
    - path: properties.access.readOnlyAccess
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_schema_datalake_schema_version_immutability_enforced
  name: 'AZURE DATA Lake_analytics_schema: Datalake Schema Version Immutability Enforced'
  severity: MEDIUM
  for_each: lake_analytics_schemas
  param: lake_analytics_schema
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.schemaVersionImmutability
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_table_datalake_table_access_policies_least_privilege
  name: 'AZURE DATA Lake_analytics_table: Datalake Table Access Policies Least Privilege'
  severity: HIGH
  for_each: lake_analytics_tables
  param: lake_analytics_table
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.accessControlList
      operator: exists
      expected: true
    - path: properties.accessControlList.*.permissions
      operator: contains
      expected: r--
    - path: properties.defaultAccessControlList
      operator: exists
      expected: true
    - path: properties.defaultAccessControlList.*.permissions
      operator: contains
      expected: r--
    - path: properties.publicAccess
      operator: equals
      expected: false
    - path: properties.enableRoleBasedAccessControl
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_table_datalake_table_column_level_access_controls_enabled
  name: 'AZURE DATA Lake_analytics_table: Datalake Table Column Level Access Controls
    Ena'
  severity: MEDIUM
  for_each: lake_analytics_tables
  param: lake_analytics_table
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.columnLevelAccessControlsEnabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_table_datalake_table_encrypted
  name: 'AZURE DATA Lake_analytics_table: Datalake Table Encrypted'
  severity: MEDIUM
  for_each: lake_analytics_tables
  param: lake_analytics_table
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryption.enabled
      operator: equals
      expected: true
    - path: properties.encryption.keySource
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_table_datalake_table_public_sharing_disabled
  name: 'AZURE DATA Lake_analytics_table: Datalake Table Public Sharing Disabled'
  severity: CRITICAL
  for_each: lake_analytics_tables
  param: lake_analytics_table
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.publicDataShare
      operator: equals
      expected: false
    - path: properties.allowPublicAccess
      operator: equals
      expected: false
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_trigger_datalake_trigger_event_sources_restricted
  name: 'AZURE DATA Lake_analytics_trigger: Datalake Trigger Event Sources Restricted'
  severity: MEDIUM
  for_each: lake_analytics_triggers
  param: lake_analytics_trigger
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.eventSources
      operator: exists
      expected: true
    - path: properties.eventSources
      operator: contains
      expected: Microsoft.DataLakeStore
    - path: properties.restrictedEventSources
      operator: equals
      expected: true
    - path: properties.allowedEventSourceTypes
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_trigger_datalake_trigger_logs_enabled
  name: 'AZURE DATA Lake_analytics_trigger: Datalake Trigger Logs Enabled'
  severity: LOW
  for_each: lake_analytics_triggers
  param: lake_analytics_trigger
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.diagnosticSettings.logs.enabled
      operator: equals
      expected: true
    - path: properties.diagnosticSettings.logs.categories
      operator: exists
      expected: true
    - path: properties.logging.enabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_trigger_datalake_trigger_targets_least_privilege
  name: 'AZURE DATA Lake_analytics_trigger: Datalake Trigger Targets Least Privilege'
  severity: HIGH
  for_each: lake_analytics_triggers
  param: lake_analytics_trigger
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.scope
      operator: exists
      expected: true
    - path: properties.scope
      operator: contains
      expected: /subscriptions/
    - path: properties.condition
      operator: exists
      expected: true
    - path: properties.actions
      operator: exists
      expected: true
    - path: properties.actions[*].actionType
      operator: equals
      expected: Microsoft.DataLakeAnalytics/accounts/jobs/write
    - path: properties.enabled
      operator: equals
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_workflow_datalake_workflow_cross_account_trusts_restricted
  name: 'AZURE DATA Lake_analytics_workflow: Datalake Workflow Cross Account Trusts
    Restr'
  severity: MEDIUM
  for_each: lake_analytics_workflows
  param: lake_analytics_workflow
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.crossAccountTrusts.enabled
      operator: equals
      expected: false
    - path: properties.crossAccountTrusts.restrictedAccounts
      operator: exists
      expected: true
    - path: properties.crossAccountTrusts.allowedExternalAccounts
      operator: equals
      expected: []
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_workflow_datalake_workflow_execution_role_least_privilege
  name: 'AZURE DATA Lake_analytics_workflow: Datalake Workflow Execution Role Least
    Privi'
  severity: HIGH
  for_each: lake_analytics_workflows
  param: lake_analytics_workflow
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.executionRole.permissions
      operator: exists
      expected: true
    - path: properties.executionRole.scope
      operator: equals
      expected: minimal
    - path: properties.executionRole.principalType
      operator: equals
      expected: ServicePrincipal
    - path: properties.executionRole.actions
      operator: contains
      expected: Microsoft.DataLakeAnalytics/accounts/jobs/read
    - path: properties.executionRole.notActions
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
- check_id: data_lake_analytics_workflow_datalake_workflow_kms_encryption_enabled
  name: 'AZURE DATA Lake_analytics_workflow: Datalake Workflow KMS Encryption Enabled'
  severity: HIGH
  for_each: lake_analytics_workflows
  param: lake_analytics_workflow
  calls:
  - action: identity
    params: {}
    fields:
    - path: properties.encryption.keySource
      operator: equals
      expected: Microsoft.KeyVault
    - path: properties.encryption.keyVaultProperties.keyIdentifier
      operator: exists
      expected: true
  multi_step: false
  logic: AND
  errors_as_fail: []
