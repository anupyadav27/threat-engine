version: '1.0'
provider: azure
service: policy
discovery:
- discovery_id: azure.policy.list
  calls:
  - action: list
    save_as: list_response
  emit:
    items_for: '{{ list_response.value }}'
    as: item
    item:
      id: '{{ item.id }}'
      name: '{{ item.name }}'
      type: '{{ item.type }}'
      deny_assignment_name: '{{ item.deny_assignment_name }}'
      description: '{{ item.description }}'
      permissions: '{{ item.permissions }}'
      scope: '{{ item.scope }}'
      do_not_apply_to_child_scopes: '{{ item.do_not_apply_to_child_scopes }}'
      principals: '{{ item.principals }}'
      exclude_principals: '{{ item.exclude_principals }}'
      is_system_protected: '{{ item.is_system_protected }}'
      condition: '{{ item.condition }}'
      condition_version: '{{ item.condition_version }}'
      created_on: '{{ item.created_on }}'
      updated_on: '{{ item.updated_on }}'
      created_by: '{{ item.created_by }}'
      updated_by: '{{ item.updated_by }}'
checks:
- rule_id: azure.policy.assignment.governance_config_recorder_global_resource_types_tracked
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.definition.identity_access_rbac_conditions_used_where_applicable
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.remediation_task.configuration_management_config_remediation_auto_remediation_enabled_for_high
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.definition.identity_access_rbac_resource_constraints_present
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.registry_lifecycle_policy.supply_chain_lifecycle_policy_policy_storage_encrypted
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.definition.governance_editors_rbac_least_privilege
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.compliance.configuration_management_config_drift_alerts_configured
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.set_definition.governance_aggregator_org_aggregator_enabled
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.definition.governance_scp_mandatory_deny_iam_star_admin
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.assignment.configuration_management_config_recorder_enabled
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.registry_policy.supply_chain_no_wildcard_admin
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.rule.governance_config_remediation_targets_bound
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.assignment.enabled
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.definition.governance_scp_no_allow_star_on_star_resources
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.rule.configuration_management_config_required_rules_present
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.rule.configuration_management_config_remediation_targets_bound
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.definition.identity_access_rbac_no_action_star_on_resource_star
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.registry_policy.supply_chain_no_public_pull_push
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.assignment.check.disabled.effect
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.assignment.governance_config_recorder_enabled
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.definition.governance_scp_mandatory_block_disabling_guardrail_services
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.assignment.governance_aggregation_authorization_not_expired_or_revoked
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.definition.governance_no_wildcard_admin_actions
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.definition.governance_versioning_and_change_audit_enabled
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.set_definition.configuration_management_config_baseline_parameters_set
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.rule.governance_config_required_rules_present
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.assignment.configuration_management_config_aggregation_org_aggregator_enabled
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.compliance_assessment.configuration_management_config_compliance_evidence_export_configured
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.set_definition.governance_aggregator_auto_enroll_new_accounts
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.assignment.governance_aggregation_authorization_trusts_least_privilege
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.assignment.configuration_management_config_aggregation_auto_enroll_new_accounts
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.rule.configuration_management_config_rules_enabled
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.definition.identity_access_rbac_no_policy_allows_without_constraints
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.assignment.configuration_management_config_delivery_secure_destination_configured
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.definition.configuration_management_config_delivery_destination_access_least_privilege
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.remediation_task.configuration_management_config_remediation_manual_runbooks_attached
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.definition.governance_scp_mandatory_require_mfa_for_console_where_supported
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.assignment.configuration_management_config_recorder_global_resource_types_tracked
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.assignment.governance_aggregation_authorization_target_accounts_correct
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.assignment.governance_delivery_channel_secure_destination_configured
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.rule.governance_config_rules_enabled
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.compliance_assessment.configuration_management_config_compliance_reporting_dashboards_enabled
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.compliance.configuration_management_config_drift_critical_resources_drift_detection_enabled
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.assignment.governance_delivery_channel_destination_access_least_privilege
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.registry_lifecycle_policy.supply_chain_lifecycle_policy_unused_or_old_tags_expire
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.assignment.asc_enforcement_enabled
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.assignment.recorder_all_regions_enabled
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.set_definition.governance_aggregation_authorization_present_and_valid
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.set_definition.configuration_management_config_baseline_conformance_pack_deployed
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.definition.configuration_management_config_delivery_kms_encryption_enabled
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.policy.assignment.governance_delivery_channel_kms_encryption_enabled
  for_each: azure.policy.list
  conditions:
    var: item.id
    op: exists
