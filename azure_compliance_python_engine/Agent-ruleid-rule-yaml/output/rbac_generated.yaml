version: '1.0'
provider: azure
service: rbac
discovery:
- discovery_id: azure.rbac.list
  calls:
  - action: list
    save_as: list_response
  emit:
    items_for: '{{ list_response.value }}'
    as: item
    item:
      id: '{{ item.id }}'
      name: '{{ item.name }}'
      type: '{{ item.type }}'
      deny_assignment_name: '{{ item.deny_assignment_name }}'
      description: '{{ item.description }}'
      permissions: '{{ item.permissions }}'
      scope: '{{ item.scope }}'
      do_not_apply_to_child_scopes: '{{ item.do_not_apply_to_child_scopes }}'
      principals: '{{ item.principals }}'
      exclude_principals: '{{ item.exclude_principals }}'
      is_system_protected: '{{ item.is_system_protected }}'
      condition: '{{ item.condition }}'
      condition_version: '{{ item.condition_version }}'
      created_on: '{{ item.created_on }}'
      updated_on: '{{ item.updated_on }}'
      created_by: '{{ item.created_by }}'
      updated_by: '{{ item.updated_by }}'
checks:
- rule_id: azure.rbac.role_definition.identity_access_role_trust_principals_allowlist_only
  for_each: azure.rbac.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.rbac.vulnerability_automation.vuln_automation_execution_roles_least_privilege
  for_each: azure.rbac.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.rbac.role.resource.lock.check
  for_each: azure.rbac.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.rbac.vulnerability_maintenance.vuln_maintenance_execution_roles_least_privilege
  for_each: azure.rbac.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.rbac.role_definition.identity_access_role_trust_requires_external_id_or_audience_condition_where_supported
  for_each: azure.rbac.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.rbac.serverless_provisioned_concurrency.serverless_prov_conc_execution_role_least_privilege
  for_each: azure.rbac.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.rbac.role_definition.identity_access_role_attached_policies_not_admin_star
  for_each: azure.rbac.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.rbac.role_definition.identity_access_role_session_duration_reasonable_where_applicable
  for_each: azure.rbac.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.rbac.role_definition.identity_access_role_no_inline_policies
  for_each: azure.rbac.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.rbac.role_definition.identity_access_role_max_session_duration_reasonable
  for_each: azure.rbac.list
  conditions:
    var: item.id
    op: exists
