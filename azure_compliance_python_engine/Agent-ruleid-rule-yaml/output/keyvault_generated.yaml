version: '1.0'
provider: azure
service: keyvault
discovery:
- discovery_id: azure.keyvault.list_by_resource_group
  calls:
  - action: list_by_resource_group
    save_as: list_by_resource_group_response
  emit:
    items_for: '{{ list_by_resource_group_response.value }}'
    as: item
    item:
      id: '{{ item.id }}'
      name: '{{ item.name }}'
      type: '{{ item.type }}'
      location: '{{ item.location }}'
      sku: '{{ item.sku }}'
      tags: '{{ item.tags }}'
      system_data: '{{ item.system_data }}'
      identity: '{{ item.identity }}'
      properties: '{{ item.properties }}'
checks:
- rule_id: azure.keyvault.secrets_secret.kms_key
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.key_uri
    op: not_empty
- rule_id: azure.keyvault.key.rotation_enabled
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.rotation_policy
    op: not_empty
- rule_id: azure.keyvault.paas_app.env_secrets_from_vault_only
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.key_uri
    op: not_empty
- rule_id: azure.keyvault.secret.secure_string_type_for_sensitive
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.keyvault.paas_application_version.paas_app_version_artifact_encrypted
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.attributes
    op: contains
    value: encrypted
- rule_id: azure.keyvault.secrets_store.rotation_enabled_for_rotatable_secrets
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.rotation_policy
    op: not_empty
- rule_id: azure.keyvault.grant.kms_grant_lessthan_wildcard_permissions
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.key_ops
    op: not_equals
    value: '*'
- rule_id: azure.keyvault.alias.alias_key_has_alias
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.name
    op: not_empty
- rule_id: azure.keyvault.grant.kms_grant_constraints_present
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.release_policy
    op: not_empty
- rule_id: azure.keyvault.private_ca.private_ca_crl_or_ocsp
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.keyvault.secret.access_rbac_least_privilege
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.keyvault.certificate.max.12.months.validity.check
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.attributes
    op: contains
    value: validity_period
- rule_id: azure.keyvault.private.endpoint.association.check
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.keyvault.non.rbac.secret.expiration.check
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.attributes
    op: not_empty
- rule_id: azure.keyvault.keys.check.expiration
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.attributes
    op: contains
    value: exp
- rule_id: azure.keyvault.vaults.purge.protection.status
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.attributes
    op: contains
    value: Enabled
- rule_id: azure.keyvault.key.rotation.policy.enabled
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.rotation_policy
    op: not_empty
- rule_id: azure.keyvault.grant.kms_grant_grantee_principal_valid
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.identity
    op: not_empty
- rule_id: azure.keyvault.privacy_anonymization.outputs_encrypted
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.keyvault.secrets_secret.no_plaintext_exposed_in_policy_or_tags
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.keyvault.certificate.certificate_trusted_issuer
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.keyvault.secrets_store.access_rbac_least_privilege
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.keyvault.alias.alias_alias_points_to_active_key
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.attributes
    op: exists
- rule_id: azure.keyvault.vault.logging_enabled
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.keyvault.managedhsm.compliance.check
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.keyvault.defender.pricing.tier.check
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.sku
    op: not_empty
- rule_id: azure.keyvault.certificate.certificate_key_length_minimum
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.key_size
    op: gte
    value: 2048
- rule_id: azure.keyvault.certificate.certificate_not_expired
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.attributes
    op: exists
- rule_id: azure.keyvault.secret.rotation_enabled
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.rotation_policy
    op: not_empty
- rule_id: azure.keyvault.secrets_secret.rotation_where_applicable
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.rotation_policy
    op: not_empty
- rule_id: azure.keyvault.private_ca.private_ca_ca_key_in_hsm_where_supported
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.kty
    op: equals
    value: RSA-HSM
- rule_id: azure.keyvault.secret.kms_key
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.key_uri
    op: not_empty
- rule_id: azure.keyvault.private_ca.private_ca_path_length_constraints_set
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.keyvault.key.expiration.check
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.attributes
    op: not_empty
- rule_id: azure.keyvault.key.not_scheduled_for_deletion
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.attributes
    op: not_empty
- rule_id: azure.keyvault.vault.private_endpoints_enabled
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.keyvault.rbac.authorization.enabled
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.identity
    op: not_empty
- rule_id: azure.keyvault.public.network.access.disabled
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.tags
    op: contains
    value: public_network_access:Disabled
- rule_id: azure.keyvault.diagnostic.logging.check
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.keyvault.rbac.secrets.expiration.check
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.rotation_policy
    op: not_empty
- rule_id: azure.keyvault.secrets_store.kms_encryption_enabled
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.key_uri
    op: not_empty
- rule_id: azure.keyvault.private_ca.private_ca_ca_access_rbac_least_privilege
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.tags
    op: not_empty
- rule_id: azure.keyvault.privacy_consent.store_encrypted
  for_each: azure.keyvault.list_by_resource_group
  conditions:
    var: item.attributes
    op: contains
    value: encrypted
