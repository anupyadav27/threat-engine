version: '1.0'
provider: azure
service: aks
discovery:
- discovery_id: azure.aks.list
  calls:
  - action: list
    save_as: list_response
  emit:
    items_for: '{{ list_response.value }}'
    as: item
    item:
      id: '{{ item.id }}'
      name: '{{ item.name }}'
      type: '{{ item.type }}'
      system_data: '{{ item.system_data }}'
      tags: '{{ item.tags }}'
      location: '{{ item.location }}'
      e_tag: '{{ item.e_tag }}'
      sku: '{{ item.sku }}'
      extended_location: '{{ item.extended_location }}'
      identity: '{{ item.identity }}'
      kind: '{{ item.kind }}'
      provisioning_state: '{{ item.provisioning_state }}'
      power_state: '{{ item.power_state }}'
      max_agent_pools: '{{ item.max_agent_pools }}'
      kubernetes_version: '{{ item.kubernetes_version }}'
      current_kubernetes_version: '{{ item.current_kubernetes_version }}'
      dns_prefix: '{{ item.dns_prefix }}'
      fqdn_subdomain: '{{ item.fqdn_subdomain }}'
      fqdn: '{{ item.fqdn }}'
      private_fqdn: '{{ item.private_fqdn }}'
checks:
- rule_id: azure.aks.authorization.mode.check
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.aks.cluster.private.cluster.enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.aks.service.account.default.usage.check
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.controller_manager.containers_secure_port_tls_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.deployment.containers_workload_host_network_pid_ipc_disabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.rbac.containers_subjects_scoped_to_namespaces
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.controller_manager.containers_root_ca_file_configured
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.aks.cluster.cis_3_2_6_needs_development
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.agent_pool.containers_node_pool_workload_identity_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.kubelet.containers_read_only_port_disabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.kubelet.k8s_anonymous_auth_disabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.aks.cluster.public_access_disabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.admission_controller.containers_admission_pod_security_admission_restricted_default
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.api_server.containers_apiserver_authorization_mode_rbac
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.kubelet.containers_tls_min_1_2_enforced
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.managed_cluster.containers_cluster_audit_logging_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.agent_pool.containers_node_pool_shielded_secure_boot_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.deployment.containers_workload_no_hostpath_mounts
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.aks.kubelet.streaming.connection.idle.timeout.check
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.admission_controller.containers_admission_host_namespace_usage_denied
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.aks.kubelet.rotate.certificates.check
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.admission_controller.containers_admission_image_signature_verification_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.namespace.containers_default_service_account_automount_disabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.managed_cluster.containers_cluster_secrets_encryption_kms_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.rbac.containers_authorization_mode_rbac_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.etcd.containers_auth_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.managed_cluster.containers_cluster_service_dns_and_metrics_from_approved_sources
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.deployment.containers_workload_env_no_plaintext_secrets
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.managed_cluster.containers_fargate_profile_execution_role_least_privilege
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.managed_cluster.containers_cluster_private_control_plane_endpoint_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.etcd.k8s_client_cert_auth_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.namespace.containers_pod_security_level_restricted
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.deployment.containers_workload_run_as_non_root
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.etcd.containers_peer_tls_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.aks.rbac.check.cluster.admin.usage
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.addon.containers_no_privileged_permissions
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.api_server.containers_apiserver_anonymous_auth_disabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.deployment.containers_workload_seccomp_profile_runtime_default
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.rbac.k8s_default_sa_not_cluster_admin
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.rbac.k8s_wildcard_verbs_disallowed
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.namespace.containers_network_policies_present
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.addon.containers_from_trusted_channel
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.scheduler.k8s_profiling_disabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.addon.containers_version_pinned_and_supported
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.etcd.k8s_encryption_at_rest_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.kubelet.containers_anonymous_auth_disabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.kubelet.k8s_read_only_port_disabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.network_policy.containers_networkpolicy_default_deny_egress_per_namespace
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.deployment.containers_workload_no_privileged_containers
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.service.containers_nodeport_usage_restricted
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.deployment.containers_workload_image_tag_not_latest
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.aks.kubelet.certificate.rotation.check
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.admission_controller.containers_admission_image_registry_allowlist_enforced
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.rbac.containers_no_cluster_admin_bindings_to_users
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.kubelet.k8s_protect_kernel_defaults_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.api_server.containers_apiserver_insecure_port_disabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.scheduler.k8s_secure_port_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.agent_pool.containers_node_pool_disk_encryption_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.aks.namespace.network.policy.compliance.check
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.rbac.k8s_no_cluster_admin_to_authenticated
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.controller_manager.containers_use_service_account_credentials_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.network_policy.containers_networkpolicy_required_allowlist_for_namespace_services
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.api_server.k8s_apiserver_anonymous_auth_disabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.deployment.containers_workload_drop_net_raw_and_reduce_caps
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.service.containers_type_loadbalancer_internal_only_where_required
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.etcd.containers_encryption_at_rest_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.managed_cluster.containers_cluster_service_kube_system_services_not_public
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.api_server.k8s_apiserver_tls_min_version_1_2
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.agent_pool.containers_node_pool_nodes_no_public_ip
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.aks.cluster.private_nodes_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.scheduler.containers_secure_port_tls_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.scheduler.containers_authorization_kubeconfig_configured
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.api_server.containers_apiserver_tls_min_1_2_enforced
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.admission_controller.containers_admission_privilege_escalation_denied
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.aks.pod.service.account.tokens.automount.disabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.api_server.k8s_apiserver_admission_psa_enforce_mode
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.api_server.containers_apiserver_audit_logging_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.aks.network.policy_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.controller_manager.k8s_controllermanager_service_account_token_signing_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.etcd.containers_client_tls_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.managed_cluster.containers_cluster_default_service_account_automount_disabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.network_policy.containers_networkpolicy_default_deny_ingress_per_namespace
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.deployment.containers_workload_read_only_root_filesystem
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.kubelet.k8s_client_cert_rotation_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.scheduler.containers_authentication_kubeconfig_configured
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.api_server.k8s_apiserver_audit_logging_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.aks.network.cni.version.check
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.kubelet.containers_authz_webhook_or_rbac_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.service.containers_external_ips_not_used
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.scheduler.k8s_leader_election_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.api_server.containers_apiserver_etcd_connection_encrypted
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.rbac.containers_no_wildcard_rules_in_clusterroles
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.aks.cluster.private.endpoint.and.public.access.check
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.managed_cluster.containers_fargate_profile_private_subnets_only
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.managed_cluster.containers_fargate_profile_logging_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.kubernetes.controller_manager.k8s_controllermanager_secure_port_enabled
  for_each: azure.aks.list
  conditions:
    var: item.id
    op: exists
