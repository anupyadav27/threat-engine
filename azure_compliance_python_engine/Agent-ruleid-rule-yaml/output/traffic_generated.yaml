version: '1.0'
provider: azure
service: traffic
discovery:
- discovery_id: azure.traffic.list
  calls:
  - action: list
    save_as: list_response
  emit:
    items_for: '{{ list_response.value }}'
    as: item
    item:
      id: '{{ item.id }}'
      name: '{{ item.name }}'
      type: '{{ item.type }}'
      location: '{{ item.location }}'
      tags: '{{ item.tags }}'
      etag: '{{ item.etag }}'
      zones: '{{ item.zones }}'
      identity: '{{ item.identity }}'
      sku: '{{ item.sku }}'
      ssl_policy: '{{ item.ssl_policy }}'
      operational_state: '{{ item.operational_state }}'
      gateway_ip_configurations: '{{ item.gateway_ip_configurations }}'
      authentication_certificates: '{{ item.authentication_certificates }}'
      trusted_root_certificates: '{{ item.trusted_root_certificates }}'
      trusted_client_certificates: '{{ item.trusted_client_certificates }}'
      ssl_certificates: '{{ item.ssl_certificates }}'
      frontend_ip_configurations: '{{ item.frontend_ip_configurations }}'
      frontend_ports: '{{ item.frontend_ports }}'
      probes: '{{ item.probes }}'
      backend_address_pools: '{{ item.backend_address_pools }}'
checks:
- rule_id: azure.traffic.manager_profile.dns_policy_policy_documents_encrypted_and_private
  for_each: azure.traffic.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.traffic.manager_profile.dns_policy_targets_approved_domains_only
  for_each: azure.traffic.list
  conditions:
    var: item.id
    op: exists
- rule_id: azure.traffic.manager_profile.dns_policy_health_checks_required_for_failover
  for_each: azure.traffic.list
  conditions:
    var: item.id
    op: exists
