# ============================================================================
# CURSOR AI: GCP SERVICE VALIDATION INSTRUCTIONS
# ============================================================================
# 
# üéØ YOUR MISSION: Validate and fix this GCP service YAML file
#
# WORKFLOW:
# 1. Read this entire YAML file structure
# 2. Run: `export GCP_ENGINE_FILTER_SERVICES="<SERVICE>" && python engine/gcp_engine.py > output/test_<service>.json 2>&1`
# 3. Analyze output - check for inventories, main_checks, errors
# 4. Fix issues in discovery and checks sections below
# 5. Re-run engine and verify output
# 6. Iterate until all checks work (PASS/FAIL based on resources)
# 7. Update validation status at bottom of file
#
# COMMON ISSUES & FIXES:
#
# ‚ùå Empty inventories ‚Üí Fix discovery action (must be: list_<resource>, aggregatedList_<resource>)
# ‚ùå Zero checks executed ‚Üí Fix for_each to match discovery_id
# ‚ùå All checks fail ‚Üí Fix field paths to match GCP API response
# ‚ùå Skipped checks ‚Üí Verify discovery_id exists and completed
# ‚ùå Python errors ‚Üí Check YAML syntax, action names
#
# TESTING:
# - Run engine: `export GCP_ENGINE_FILTER_SERVICES="<service>" && python engine/gcp_engine.py > output/test.json 2>&1`
# - Check output: `cat output/test.json | python3 -m json.tool`
# - Verify: inventories array has resources, main_checks array has results
#
# SUCCESS CRITERIA:
# ‚úÖ Engine runs without Python exceptions
# ‚úÖ Inventories populated (if resources exist in GCP)
# ‚úÖ All checks execute (PASS/FAIL based on actual resource state)
# ‚úÖ No skipped checks (unless expected)
# ‚úÖ Clean JSON output
#
# DOCUMENTATION:
# After fixing, update validation section at bottom:
# # VALIDATION STATUS:
# # - Issues Found: <what was wrong>
# # - Fixes Applied: <what you fixed>
# # - Tested: <date>
# # - Inventories: <count>
# # - Checks: <count executed>
# # - Status: ‚úÖ VALIDATED / ‚è≥ IN PROGRESS / ‚ùå NEEDS WORK
#
# ============================================================================

service_name:  # e.g., compute, gcs, pubsub

artifactregistry:
  version: '1.0'
  provider: gcp
  service: artifactregistry
  scope: regional
  discovery:
  - discovery_id: list_artifactregistry_repositories
    calls:
    - action: list
      fields:
      - path: name
        var: repository_name
      - path: location
        var: repository_location
      - path: format
        var: repository_format
  - discovery_id: list_artifactregistry_iam_policies
    calls:
    - action: get_iam_policy
      fields:
      - path: bindings
        var: iam_bindings
  checks:
  - check_id: gcp.artifactregistry.repository.container_analysis_enabled
    title: Ensure Container Analysis is Enabled for Artifact Registry Repositories
    severity: high
    for_each: list_artifactregistry_repositories
    logic: AND
    calls:
    - action: eval
      fields:
      - path: containerAnalysisConfig.enabled
        operator: equals
        expected: true
  - check_id: gcp.artifactregistry.repository.container_scanning_enabled
    title: Enable Container Scanning in Artifact Registry
    severity: high
    for_each: list_artifactregistry_repositories
    logic: AND
    calls:
    - action: eval
      fields:
      - path: scanConfig.vulnerabilityScanning.enabled
        operator: equals
        expected: true
  - check_id: gcp.artifactregistry.repository.registry_image_scan_on_push_enabled
    title: Enable Image Scan on Push for Artifact Registry Repositories
    severity: medium
    for_each: list_artifactregistry_repositories
    logic: AND
    calls:
    - action: eval
      fields:
      - path: scanConfig.scanOnPush
        operator: equals
        expected: true
  - check_id: gcp.artifactregistry.repository.registry_repository_encryption_enabled
    title: Ensure Artifact Registry Repositories Use Encryption at Rest
    severity: high
    for_each: list_artifactregistry_repositories
    logic: AND
    calls:
    - action: eval
      fields:
      - path: kmsKeyName
        operator: exists
        expected: true
  - check_id: gcp.artifactregistry.repository.repository_minimum_user_access
    title: Ensure Minimal User Access to Artifact Registry Repositories
    severity: medium
    for_each: list_artifactregistry_iam_policies
    logic: AND
    calls:
    - action: eval
      fields:
      - path: bindings[].members[]
        operator: not_contains
        expected: allUsers
    - action: eval
      fields:
      - path: bindings[].members[]
        operator: not_contains
        expected: allAuthenticatedUsers
  - check_id: gcp.artifactregistry.repository.supply_chain_policy_storage_encrypted
    title: Ensure Artifact Registry Repositories Use Encrypted Storage
    severity: high
    for_each: list_artifactregistry_repositories
    logic: OR
    calls:
    - action: eval
      fields:
      - path: kmsKeyName
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: encryptionConfig.kmsKeyName
        operator: exists
        expected: true
  - check_id: gcp.artifactregistry.repository.supply_chain_registry_image_scanning_enabled
    title: Enable Image Scanning in Artifact Registry Repositories
    severity: high
    for_each: list_artifactregistry_repositories
    logic: AND
    calls:
    - action: eval
      fields:
      - path: vulnerabilityScanning.enabled
        operator: equals
        expected: true
    - action: eval
      fields:
      - path: scanConfig.enabled
        operator: equals
        expected: true
  - check_id: gcp.artifactregistry.repository.supply_chain_registry_immutable_tags_or_signing_enforced
    title: Enforce Immutable Tags or Signing in Artifact Registry
    severity: medium
    for_each: list_artifactregistry_repositories
    logic: OR
    calls:
    - action: eval
      fields:
      - path: dockerConfig.immutableTags
        operator: equals
        expected: true
    - action: eval
      fields:
      - path: binaryAuthorizationConfig.enabled
        operator: equals
        expected: true
  - check_id: gcp.artifactregistry.repository.supply_chain_registry_no_public_pull_push
    title: Restrict Public Pull/Push on Artifact Registry Repositories
    severity: critical
    for_each: list_artifactregistry_iam_policies
    logic: AND
    calls:
    - action: eval
      fields:
      - path: bindings[?(@.role=='roles/artifactregistry.reader')].members[]
        operator: not_contains
        expected: allUsers
    - action: eval
      fields:
      - path: bindings[?(@.role=='roles/artifactregistry.writer')].members[]
        operator: not_contains
        expected: allUsers
  - check_id: gcp.artifactregistry.repository.supply_chain_registry_no_wildcard_admin
    title: Restrict Admin Rights in Artifact Registry Repositories
    severity: high
    for_each: list_artifactregistry_iam_policies
    logic: AND
    calls:
    - action: eval
      fields:
      - path: bindings[?(@.role=='roles/artifactregistry.admin')].members[]
        operator: not_contains
        expected: '*'
    - action: eval
      fields:
      - path: bindings[?(@.role=='roles/artifactregistry.repoAdmin')].members[]
        operator: not_contains
        expected: domain:*
  - check_id: gcp.artifactregistry.repository.supply_chain_registry_private_or_access_restricted
    title: Ensure Artifact Registry Repositories Are Private or Access Restricted
    severity: high
    for_each: list_artifactregistry_repositories
    logic: AND
    calls:
    - action: eval
      fields:
      - path: mode
        operator: not_equals
        expected: STANDARD_REPOSITORY
    - action: get_iam_policy
      fields:
      - path: bindings[].members[]
        operator: not_contains
        expected: allUsers
  - check_id: gcp.artifactregistry.repository.supply_chain_registry_replication_cross_region_encrypted
    title: Ensure Cross-Region Encrypted Replication for Artifact Repositories
    severity: medium
    for_each: list_artifactregistry_repositories
    logic: AND
    calls:
    - action: eval
      fields:
      - path: remoteRepositoryConfig.encryptionConfig.kmsKeyName
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: remoteRepositoryConfig.encryptionConfig.enabled
        operator: equals
        expected: true
  - check_id: gcp.artifactregistry.repository.supply_chain_registry_replication_destinations_lea_privilege
    title: Limit Artifact Registry Replication Destination Privileges
    severity: medium
    for_each: list_artifactregistry_repositories
    logic: AND
    calls:
    - action: eval
      fields:
      - path: remoteRepositoryConfig.upstreamCredentials.usernamePasswordCredentials
        operator: not_exists
        expected: true
    - action: eval
      fields:
      - path: remoteRepositoryConfig.description
        operator: contains
        expected: least-privilege
  - check_id: gcp.artifactregistry.repository.supply_chain_unused_or_old_tags_expire
    title: Ensure Expiration of Unused or Old Tags in Artifact Repositories
    severity: low
    for_each: list_artifactregistry_repositories
    logic: OR
    calls:
    - action: eval
      fields:
      - path: cleanupPolicies[].condition.tagState
        operator: equals
        expected: TAGGED
    - action: eval
      fields:
      - path: cleanupPolicies[].condition.olderThan
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: dockerConfig.cleanupPolicy.enabled
        operator: equals
        expected: true
  - check_id: gcp.artifactregistry.repository.vulnerability_scanning_enabled
    title: Enable Vulnerability Scanning for Artifact Registry Repositories
    severity: high
    for_each: list_artifactregistry_repositories
    logic: AND
    calls:
    - action: eval
      fields:
      - path: vulnerabilityScanning.enabled
        operator: equals
        expected: true
    - action: eval
      fields:
      - path: vulnerabilityScanning.scanOnPush
        operator: equals
        expected: true
  api_name: artifactregistry
  api_version: v1
  project_param_format: projects/{{project_id}}
