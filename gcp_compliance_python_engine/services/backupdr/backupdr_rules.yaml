# ============================================================================
# CURSOR AI: GCP SERVICE VALIDATION INSTRUCTIONS
# ============================================================================
# 
# üéØ YOUR MISSION: Validate and fix this GCP service YAML file
#
# WORKFLOW:
# 1. Read this entire YAML file structure
# 2. Run: `export GCP_ENGINE_FILTER_SERVICES="<SERVICE>" && python engine/gcp_engine.py > output/test_<service>.json 2>&1`
# 3. Analyze output - check for inventories, main_checks, errors
# 4. Fix issues in discovery and checks sections below
# 5. Re-run engine and verify output
# 6. Iterate until all checks work (PASS/FAIL based on resources)
# 7. Update validation status at bottom of file
#
# COMMON ISSUES & FIXES:
#
# ‚ùå Empty inventories ‚Üí Fix discovery action (must be: list_<resource>, aggregatedList_<resource>)
# ‚ùå Zero checks executed ‚Üí Fix for_each to match discovery_id
# ‚ùå All checks fail ‚Üí Fix field paths to match GCP API response
# ‚ùå Skipped checks ‚Üí Verify discovery_id exists and completed
# ‚ùå Python errors ‚Üí Check YAML syntax, action names
#
# TESTING:
# - Run engine: `export GCP_ENGINE_FILTER_SERVICES="<service>" && python engine/gcp_engine.py > output/test.json 2>&1`
# - Check output: `cat output/test.json | python3 -m json.tool`
# - Verify: inventories array has resources, main_checks array has results
#
# SUCCESS CRITERIA:
# ‚úÖ Engine runs without Python exceptions
# ‚úÖ Inventories populated (if resources exist in GCP)
# ‚úÖ All checks execute (PASS/FAIL based on actual resource state)
# ‚úÖ No skipped checks (unless expected)
# ‚úÖ Clean JSON output
#
# DOCUMENTATION:
# After fixing, update validation section at bottom:
# # VALIDATION STATUS:
# # - Issues Found: <what was wrong>
# # - Fixes Applied: <what you fixed>
# # - Tested: <date>
# # - Inventories: <count>
# # - Checks: <count executed>
# # - Status: ‚úÖ VALIDATED / ‚è≥ IN PROGRESS / ‚ùå NEEDS WORK
#
# ============================================================================

service_name:  # e.g., compute, gcs, pubsub

backupdr:
  version: '1.0'
  provider: gcp
  service: backupdr
  scope: regional
  discovery:
  - discovery_id: list_backup_plans
    calls:
    - action: list
      fields:
      - path: name
        var: backup_plan_name
      - path: location
        var: backup_plan_location
  - discovery_id: list_backup_vaults
    calls:
    - action: list
      fields:
      - path: name
        var: backup_vault_name
      - path: location
        var: backup_vault_location
  - discovery_id: list_management_servers
    calls:
    - action: list
      fields:
      - path: name
        var: management_server_name
      - path: location
        var: management_server_location
  checks:
  - check_id: gcp.backupdr.backup_plan.backup_access_backup_admins_mfa_required
    title: Ensure MFA for Backup Admins Accessing Backup Plans
    severity: high
    for_each: list_backup_plans
    logic: AND
    calls:
    - action: eval
      fields:
      - path: iamPolicy.bindings[?(@.role=='roles/backupdr.admin')].condition.expression
        operator: contains
        expected: has({}.mfaEnabled)
  - check_id: gcp.backupdr.backup_plan.backup_access_backup_keys_access_least_privilege
    title: Ensure Least Privilege Access to Backup Keys in Backup Plans
    severity: high
    for_each: list_backup_plans
    logic: AND
    calls:
    - action: eval
      fields:
      - path: iamPolicy.bindings[?(@.role=='roles/backupdr.cryptoKeyEncrypterDecrypter')].members
        operator: exists
      - path: iamPolicy.bindings[?(@.role=='roles/backupdr.cryptoKeyEncrypterDecrypter')].members
        operator: not_contains
        expected: allUsers
  - check_id: gcp.backupdr.backup_plan.backup_access_backup_vault_rbac_least_privilege
    title: Ensure Backup Vault Access Follows Least Privilege Principle
    severity: high
    for_each: list_backup_plans
    logic: AND
    calls:
    - action: eval
      fields:
      - path: iamPolicy.bindings[?(@.role=='roles/backupdr.vaultAdmin')].members
        operator: exists
      - path: iamPolicy.bindings[?(@.role=='roles/backupdr.vaultAdmin')].members
        operator: not_contains
        expected: allAuthenticatedUsers
  - check_id: gcp.backupdr.backup_plan.backup_access_no_public_access_to_backup_vault
    title: Restrict Public Access to Backup Vaults in GCP
    severity: critical
    for_each: list_backup_plans
    logic: AND
    calls:
    - action: eval
      fields:
      - path: iamPolicy.bindings[].members
        operator: not_contains
        expected: allUsers
      - path: iamPolicy.bindings[].members
        operator: not_contains
        expected: allAuthenticatedUsers
  - check_id: gcp.backupdr.backup_plan.backup_monitoring_alert_destinations_configured
    title: Ensure Backup Plan Alert Destinations Are Configured
    severity: medium
    for_each: list_backup_plans
    logic: AND
    calls:
    - action: eval
      fields:
      - path: alertPolicy.notificationChannels
        operator: exists
      - path: alertPolicy.notificationChannels
        operator: not_equals
        expected: []
  - check_id: gcp.backupdr.backup_plan.backup_monitoring_alert_rules_for_job_failures_configured
    title: Configure Alert Rules for Backup Job Failures
    severity: high
    for_each: list_backup_plans
    logic: AND
    calls:
    - action: eval
      fields:
      - path: alertPolicy.conditions[?(@.displayName=='Backup Job Failure')].conditionThreshold.filter
        operator: contains
        expected: resource.type="backupdr_backup_job"
      - path: alertPolicy.enabled
        operator: equals
        expected: true
  - check_id: gcp.backupdr.backup_plan.backup_monitoring_alert_rules_for_sla_breach_configured
    title: Configure SLA Breach Alerts for Backup Plans
    severity: high
    for_each: list_backup_plans
    logic: AND
    calls:
    - action: eval
      fields:
      - path: alertPolicy.conditions[?(@.displayName=='SLA Breach')].conditionThreshold.filter
        operator: contains
        expected: resource.type="backupdr_backup_plan"
      - path: slaPolicy.enabled
        operator: equals
        expected: true
  - check_id: gcp.backupdr.backup_plan.backup_monitoring_metrics_export_enabled
    title: Enable Backup Monitoring Metrics Export for Backup Plans
    severity: medium
    for_each: list_backup_plans
    logic: AND
    calls:
    - action: eval
      fields:
      - path: monitoringConfig.metricsExport.enabled
        operator: equals
        expected: true
      - path: monitoringConfig.metricsExport.destination
        operator: exists
  - check_id: gcp.backupdr.backup_plan.dr_configured
    title: Ensure Backup Plans Have Disaster Recovery Configured
    severity: high
    for_each: list_backup_plans
    logic: AND
    calls:
    - action: eval
      fields:
      - path: disasterRecoveryConfig.enabled
        operator: equals
        expected: true
      - path: disasterRecoveryConfig.targetRegion
        operator: exists
  - check_id: gcp.backupdr.backup_plan.plan_min_retention_configured
    title: Ensure Backup Plan Minimum Retention Period is Configured
    severity: medium
    for_each: list_backup_plans
    logic: AND
    calls:
    - action: eval
      fields:
      - path: retentionPolicy.minimumRetentionDays
        operator: exists
      - path: retentionPolicy.minimumRetentionDays
        operator: not_equals
        expected: 0
  - check_id: gcp.backupdr.backup_plan.recovery_point_retention_configured
    title: Ensure Recovery Point Retention is Configured for Backup Plans
    severity: medium
    for_each: list_backup_plans
    logic: AND
    calls:
    - action: eval
      fields:
      - path: recoveryPointRetention.retentionPeriodDays
        operator: exists
      - path: recoveryPointRetention.retentionPeriodDays
        operator: not_equals
        expected: 0
  - check_id: gcp.backupdr.backup_plan.resilience_recovery_backup_coverage_policy_assignme_complete
    title: Ensure Complete Backup Coverage in Backup Plan
    severity: high
    for_each: list_backup_plans
    logic: AND
    calls:
    - action: eval
      fields:
      - path: backupCoverage.policyAssignments
        operator: exists
      - path: backupCoverage.coveragePercentage
        operator: equals
        expected: 100
  - check_id: gcp.backupdr.backup_plan.resilience_recovery_backup_coverage_unprotected_asse_enabled
    title: Ensure Backup Coverage for All Critical Assets in GCP Backup Plan
    severity: high
    for_each: list_backup_plans
    logic: AND
    calls:
    - action: eval
      fields:
      - path: assetCoverage.unprotectedAssets
        operator: equals
        expected: []
      - path: assetCoverage.criticalAssetsProtected
        operator: equals
        expected: true
  - check_id: gcp.backupdr.backup_plan.resilience_recovery_backup_health_failed_jobs_alerti_enabled
    title: Enable Alerting for Failed Backup Jobs in Backup Plans
    severity: high
    for_each: list_backup_plans
    logic: AND
    calls:
    - action: eval
      fields:
      - path: healthMonitoring.failedJobsAlerting.enabled
        operator: equals
        expected: true
      - path: healthMonitoring.failedJobsAlerting.threshold
        operator: exists
  - check_id: gcp.backupdr.backup_plan.resilience_recovery_backup_health_job_success_rate_minimum
    title: Ensure Backup Plan Job Success Rate Meets Minimum Threshold
    severity: medium
    for_each: list_backup_plans
    logic: AND
    calls:
    - action: eval
      fields:
      - path: healthMonitoring.jobSuccessRate.minimumThreshold
        operator: exists
      - path: healthMonitoring.jobSuccessRate.minimumThreshold
        operator: not_equals
        expected: 0
  - check_id: gcp.backupdr.backup_plan.resilience_recovery_backup_health_last_backup_recency_w_days
    title: Ensure Backup Health by Monitoring Last Backup Recency
    severity: medium
    for_each: list_backup_plans
    logic: AND
    calls:
    - action: eval
      fields:
      - path: healthMonitoring.lastBackupRecency.maxDaysThreshold
        operator: exists
      - path: healthMonitoring.lastBackupRecency.alertingEnabled
        operator: equals
        expected: true
  - check_id: gcp.backupdr.backup_plan.resilience_recovery_backup_inventory_resource_discove_synced
    title: Ensure Backup Inventory Resource Discovery is Synced
    severity: medium
    for_each: list_backup_plans
    logic: AND
    calls:
    - action: eval
      fields:
      - path: inventoryConfig.resourceDiscovery.syncStatus
        operator: equals
        expected: SYNCED
      - path: inventoryConfig.resourceDiscovery.lastSyncTime
        operator: exists
  - check_id: gcp.backupdr.backup_vault.backup_encryption_backup_storage_immutability_enabled
    title: Ensure Backup Storage Immutability and Encryption
    severity: high
    for_each: list_backup_vaults
    logic: AND
    calls:
    - action: eval
      fields:
      - path: storageConfig.immutabilityPolicy.enabled
        operator: equals
        expected: true
      - path: encryptionConfig.encryptionType
        operator: exists
  - check_id: gcp.backupdr.backup_vault.backup_encryption_cmk_cmek_key_configured
    title: Ensure Backup Vaults Use Customer-Managed Encryption Keys (CMEK)
    severity: high
    for_each: list_backup_vaults
    logic: AND
    calls:
    - action: eval
      fields:
      - path: encryptionConfig.encryptionType
        operator: equals
        expected: CUSTOMER_MANAGED_ENCRYPTION
      - path: encryptionConfig.kmsKeyName
        operator: exists
  - check_id: gcp.backupdr.backup_vault.backup_encryption_enabled
    title: Ensure Backup Vault Encryption is Enabled
    severity: critical
    for_each: list_backup_vaults
    logic: AND
    calls:
    - action: eval
      fields:
      - path: encryptionConfig.encryptionType
        operator: exists
      - path: encryptionConfig.encryptionType
        operator: not_equals
        expected: ENCRYPTION_TYPE_UNSPECIFIED
  - check_id: gcp.backupdr.management_server.network_security_firewall_rules_configured
    title: Ensure Management Server Firewall Rules Are Properly Configured
    severity: high
    for_each: list_management_servers
    logic: AND
    calls:
    - action: eval
      fields:
      - path: networkConfig.firewallRules
        operator: exists
      - path: networkConfig.firewallRules[?(@.direction=='INGRESS')].sourceRanges
        operator: not_contains
        expected: 0.0.0.0/0
  - check_id: gcp.backupdr.management_server.network_security_private_ip_enabled
    title: Ensure Management Server Uses Private IP Addresses
    severity: medium
    for_each: list_management_servers
    logic: AND
    calls:
    - action: eval
      fields:
      - path: networkConfig.privateIpEnabled
        operator: equals
        expected: true
      - path: networkConfig.publicIpEnabled
        operator: equals
        expected: false
  - check_id: gcp.backupdr.management_server.security_access_control_rbac_configured
    title: Ensure Management Server RBAC is Properly Configured
    severity: high
    for_each: list_management_servers
    logic: AND
    calls:
    - action: eval
      fields:
      - path: iamPolicy.bindings
        operator: exists
      - path: iamPolicy.bindings[].members
        operator: not_contains
        expected: allUsers
  - check_id: gcp.backupdr.management_server.security_access_control_service_account_least_privilege
    title: Ensure Management Server Service Account Follows Least Privilege
    severity: high
    for_each: list_management_servers
    logic: AND
    calls:
    - action: eval
      fields:
      - path: serviceAccount.email
        operator: exists
      - path: serviceAccount.scopes
        operator: not_contains
        expected: https://www.googleapis.com/auth/cloud-platform
  - check_id: gcp.backupdr.management_server.security_logging_audit_logs_enabled
    title: Ensure Management Server Audit Logging is Enabled
    severity: medium
    for_each: list_management_servers
    logic: AND
    calls:
    - action: eval
      fields:
      - path: loggingConfig.auditLogsEnabled
        operator: equals
        expected: true
      - path: loggingConfig.logSink
        operator: exists
  api_name: backupdr
  api_version: v1
  project_param_format: projects/{{project_id}}
