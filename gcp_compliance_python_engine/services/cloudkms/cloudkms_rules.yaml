# ============================================================================
# CURSOR AI: GCP SERVICE VALIDATION INSTRUCTIONS
# ============================================================================
# 
# üéØ YOUR MISSION: Validate and fix this GCP service YAML file
#
# WORKFLOW:
# 1. Read this entire YAML file structure
# 2. Run: `export GCP_ENGINE_FILTER_SERVICES="<SERVICE>" && python engine/gcp_engine.py > output/test_<service>.json 2>&1`
# 3. Analyze output - check for inventories, main_checks, errors
# 4. Fix issues in discovery and checks sections below
# 5. Re-run engine and verify output
# 6. Iterate until all checks work (PASS/FAIL based on resources)
# 7. Update validation status at bottom of file
#
# COMMON ISSUES & FIXES:
#
# ‚ùå Empty inventories ‚Üí Fix discovery action (must be: list_<resource>, aggregatedList_<resource>)
# ‚ùå Zero checks executed ‚Üí Fix for_each to match discovery_id
# ‚ùå All checks fail ‚Üí Fix field paths to match GCP API response
# ‚ùå Skipped checks ‚Üí Verify discovery_id exists and completed
# ‚ùå Python errors ‚Üí Check YAML syntax, action names
#
# TESTING:
# - Run engine: `export GCP_ENGINE_FILTER_SERVICES="<service>" && python engine/gcp_engine.py > output/test.json 2>&1`
# - Check output: `cat output/test.json | python3 -m json.tool`
# - Verify: inventories array has resources, main_checks array has results
#
# SUCCESS CRITERIA:
# ‚úÖ Engine runs without Python exceptions
# ‚úÖ Inventories populated (if resources exist in GCP)
# ‚úÖ All checks execute (PASS/FAIL based on actual resource state)
# ‚úÖ No skipped checks (unless expected)
# ‚úÖ Clean JSON output
#
# DOCUMENTATION:
# After fixing, update validation section at bottom:
# # VALIDATION STATUS:
# # - Issues Found: <what was wrong>
# # - Fixes Applied: <what you fixed>
# # - Tested: <date>
# # - Inventories: <count>
# # - Checks: <count executed>
# # - Status: ‚úÖ VALIDATED / ‚è≥ IN PROGRESS / ‚ùå NEEDS WORK
#
# ============================================================================

service_name:  # e.g., compute, gcs, pubsub

cloudkms:
  version: '1.0'
  provider: gcp
  service: cloudkms
  scope: global
  api_name: cloudkms
  api_version: v1
  discovery:
  - discovery_id: list_cloudkms_key_rings
    calls:
    - action: list
      fields:
      - path: name
        var: key_ring_name
      - path: location
        var: key_ring_location
  - discovery_id: list_cloudkms_crypto_keys
    calls:
    - action: list
      fields:
      - path: name
        var: crypto_key_name
      - path: purpose
        var: key_purpose
      - path: primary.state
        var: key_state
      - path: rotationPeriod
        var: rotation_period
      - path: nextRotationTime
        var: next_rotation_time
  - discovery_id: get_crypto_key_iam_policy
    calls:
    - action: get_iam_policy
      fields:
      - path: bindings
        var: iam_bindings
      - path: bindings[].members[]
        var: iam_members
  checks:
  - check_id: gcp.cloudkms.crypto_key.cmk_rotation_enabled
    title: Ensure CMK Rotation is Enabled for Crypto Keys
    severity: high
    for_each: list_cloudkms_crypto_keys
    logic: AND
    calls:
    - action: eval
      fields:
      - path: rotationPeriod
        operator: exists
        expected: true
      - path: purpose
        operator: equals
        expected: ENCRYPT_DECRYPT
  - check_id: gcp.cloudkms.crypto_key.encryption_enabled
    title: Ensure Cloud KMS Crypto Keys are Encrypted
    severity: critical
    for_each: list_cloudkms_crypto_keys
    logic: AND
    calls:
    - action: eval
      fields:
      - path: primary.state
        operator: equals
        expected: ENABLED
      - path: purpose
        operator: exists
        expected: true
  - check_id: gcp.cloudkms.crypto_key.expiration_set
    title: Ensure Expiration is Set for Cloud KMS Crypto Keys
    severity: medium
    for_each: list_cloudkms_crypto_keys
    logic: OR
    calls:
    - action: eval
      fields:
      - path: primary.destroyTime
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: versionTemplate.expirationTime
        operator: exists
        expected: true
  - check_id: gcp.cloudkms.crypto_key.key_iam_policy_public_access_configured
    title: Prevent Public Access to Cloud KMS Crypto Keys
    severity: critical
    for_each: get_crypto_key_iam_policy
    logic: AND
    calls:
    - action: eval
      fields:
      - path: bindings[].members[]
        operator: not_contains
        expected: allUsers
      - path: bindings[].members[]
        operator: not_contains
        expected: allAuthenticatedUsers
  - check_id: gcp.cloudkms.crypto_key.lifecycle_policy
    title: Implement and Maintain KMS Key Lifecycle Management
    severity: medium
    for_each: list_cloudkms_crypto_keys
    logic: AND
    calls:
    - action: eval
      fields:
      - path: versionTemplate.algorithm
        operator: exists
        expected: true
      - path: versionTemplate.protectionLevel
        operator: exists
        expected: true
      - path: labels
        operator: exists
        expected: true
  - check_id: gcp.cloudkms.crypto_key.not_publicly_accessible
    title: Ensure KMS Crypto Keys Are Not Publicly Accessible
    severity: critical
    for_each: get_crypto_key_iam_policy
    logic: AND
    calls:
    - action: eval
      fields:
      - path: bindings[].members[]
        operator: not_contains
        expected: allUsers
      - path: bindings[].members[]
        operator: not_contains
        expected: allAuthenticatedUsers
      - path: bindings[].role
        operator: not_contains
        expected: roles/cloudkms.cryptoKeyEncrypterDecrypter
  - check_id: gcp.cloudkms.crypto_key.not_scheduled_for_deletion
    title: Ensure GCP KMS Keys Are Not Scheduled for Deletion
    severity: high
    for_each: list_cloudkms_crypto_keys
    logic: AND
    calls:
    - action: eval
      fields:
      - path: primary.state
        operator: not_equals
        expected: DESTROY_SCHEDULED
      - path: primary.destroyTime
        operator: not_exists
        expected: true
  - check_id: gcp.cloudkms.crypto_key.privacy_encryption_at_rest_cmek_enabled
    title: Ensure CMEK is Enabled for KMS Encryption at Rest
    severity: high
    for_each: list_cloudkms_crypto_keys
    logic: AND
    calls:
    - action: eval
      fields:
      - path: purpose
        operator: equals
        expected: ENCRYPT_DECRYPT
      - path: versionTemplate.protectionLevel
        operator: equals
        expected: SOFTWARE
      - path: labels.cmek-enabled
        operator: equals
        expected: 'true'
  - check_id: gcp.cloudkms.crypto_key.privacy_encryption_in_transit_tls_min_1_2
    title: Ensure TLS 1.2+ for Cloud KMS Crypto Key Encryption
    severity: medium
    for_each: list_cloudkms_crypto_keys
    logic: AND
    calls:
    - action: eval
      fields:
      - path: labels.tls-version
        operator: contains
        expected: '1.2'
      - path: versionTemplate.algorithm
        operator: contains
        expected: RSA
  - check_id: gcp.cloudkms.crypto_key.project_no_secrets_in_variables_gcp_cloud_build_proj_logging
    title: Prevent Secrets in Cloud Build Variables and Enable Logging
    severity: high
    for_each: list_cloudkms_crypto_keys
    logic: AND
    calls:
    - action: eval
      fields:
      - path: labels.cloud-build-safe
        operator: equals
        expected: 'true'
      - path: labels.logging-enabled
        operator: equals
        expected: 'true'
      - path: name
        operator: not_contains
        expected: cloudbuild
  - check_id: gcp.cloudkms.crypto_key.rotation_compliance_configured
    title: Ensure Crypto Key Rotation Policy is Configured
    severity: high
    for_each: list_cloudkms_crypto_keys
    logic: AND
    calls:
    - action: eval
      fields:
      - path: rotationPeriod
        operator: exists
        expected: true
      - path: nextRotationTime
        operator: exists
        expected: true
      - path: labels.rotation-compliant
        operator: equals
        expected: 'true'
  - check_id: gcp.cloudkms.crypto_key.rotation_enabled
    title: Ensure Cloud KMS Crypto Key Rotation is Enabled
    severity: high
    for_each: list_cloudkms_crypto_keys
    logic: AND
    calls:
    - action: eval
      fields:
      - path: rotationPeriod
        operator: exists
        expected: true
      - path: purpose
        operator: equals
        expected: ENCRYPT_DECRYPT
      - path: primary.state
        operator: equals
        expected: ENABLED
  - check_id: gcp.cloudkms.crypto_key.secrets_kms_key_deletion_requires_waiting_period
    title: Require Waiting Period for KMS Key Deletion
    severity: medium
    for_each: list_cloudkms_crypto_keys
    logic: OR
    calls:
    - action: eval
      fields:
      - path: primary.destroyEventTime
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: labels.deletion-protection
        operator: equals
        expected: enabled
  - check_id: gcp.cloudkms.crypto_key.secrets_kms_key_not_publicly_accessible
    title: Ensure KMS Keys Are Not Publicly Accessible
    severity: critical
    for_each: get_crypto_key_iam_policy
    logic: AND
    calls:
    - action: eval
      fields:
      - path: bindings[].members[]
        operator: not_contains
        expected: allUsers
      - path: bindings[].members[]
        operator: not_contains
        expected: allAuthenticatedUsers
      - path: bindings[].condition
        operator: exists
        expected: true
  - check_id: gcp.cloudkms.crypto_key.secrets_kms_key_policy_least_privilege
    title: Ensure KMS Key Policies Enforce Least Privilege Access
    severity: high
    for_each: get_crypto_key_iam_policy
    logic: AND
    calls:
    - action: eval
      fields:
      - path: bindings[].role
        operator: not_equals
        expected: roles/owner
      - path: bindings[].role
        operator: not_equals
        expected: roles/editor
      - path: bindings[].condition
        operator: exists
        expected: true
  - check_id: gcp.cloudkms.crypto_key.secrets_kms_key_rotation_enabled
    title: Enable Rotation for Secrets KMS Crypto Keys
    severity: high
    for_each: list_cloudkms_crypto_keys
    logic: AND
    calls:
    - action: eval
      fields:
      - path: rotationPeriod
        operator: exists
        expected: true
      - path: labels.key-type
        operator: equals
        expected: secrets
      - path: nextRotationTime
        operator: exists
        expected: true
  - check_id: gcp.cloudkms.key_ring.secrets_kms_default_keys_disabled_where_cmek_required
    title: Disable Default KMS Keys for Secrets When CMEK is Required
    severity: medium
    for_each: list_cloudkms_key_rings
    logic: AND
    calls:
    - action: eval
      fields:
      - path: labels.cmek-required
        operator: equals
        expected: 'true'
      - path: labels.default-keys-disabled
        operator: equals
        expected: 'true'
      - path: name
        operator: not_contains
        expected: google-managed
  - check_id: gcp.cloudkms.key_ring.secrets_kms_logging_enabled
    title: Ensure Cloud KMS Key Ring Logging is Enabled
    severity: medium
    for_each: list_cloudkms_key_rings
    logic: AND
    calls:
    - action: eval
      fields:
      - path: labels.audit-logging
        operator: equals
        expected: enabled
      - path: labels.data-access-logging
        operator: equals
        expected: enabled
      - path: name
        operator: exists
        expected: true
