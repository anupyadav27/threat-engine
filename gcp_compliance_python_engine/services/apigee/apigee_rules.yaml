# ============================================================================
# CURSOR AI: GCP SERVICE VALIDATION INSTRUCTIONS
# ============================================================================
# 
# üéØ YOUR MISSION: Validate and fix this GCP service YAML file
#
# WORKFLOW:
# 1. Read this entire YAML file structure
# 2. Run: `export GCP_ENGINE_FILTER_SERVICES="<SERVICE>" && python engine/gcp_engine.py > output/test_<service>.json 2>&1`
# 3. Analyze output - check for inventories, main_checks, errors
# 4. Fix issues in discovery and checks sections below
# 5. Re-run engine and verify output
# 6. Iterate until all checks work (PASS/FAIL based on resources)
# 7. Update validation status at bottom of file
#
# COMMON ISSUES & FIXES:
#
# ‚ùå Empty inventories ‚Üí Fix discovery action (must be: list_<resource>, aggregatedList_<resource>)
# ‚ùå Zero checks executed ‚Üí Fix for_each to match discovery_id
# ‚ùå All checks fail ‚Üí Fix field paths to match GCP API response
# ‚ùå Skipped checks ‚Üí Verify discovery_id exists and completed
# ‚ùå Python errors ‚Üí Check YAML syntax, action names
#
# TESTING:
# - Run engine: `export GCP_ENGINE_FILTER_SERVICES="<service>" && python engine/gcp_engine.py > output/test.json 2>&1`
# - Check output: `cat output/test.json | python3 -m json.tool`
# - Verify: inventories array has resources, main_checks array has results
#
# SUCCESS CRITERIA:
# ‚úÖ Engine runs without Python exceptions
# ‚úÖ Inventories populated (if resources exist in GCP)
# ‚úÖ All checks execute (PASS/FAIL based on actual resource state)
# ‚úÖ No skipped checks (unless expected)
# ‚úÖ Clean JSON output
#
# DOCUMENTATION:
# After fixing, update validation section at bottom:
# # VALIDATION STATUS:
# # - Issues Found: <what was wrong>
# # - Fixes Applied: <what you fixed>
# # - Tested: <date>
# # - Inventories: <count>
# # - Checks: <count executed>
# # - Status: ‚úÖ VALIDATED / ‚è≥ IN PROGRESS / ‚ùå NEEDS WORK
#
# ============================================================================

service_name:  # e.g., compute, gcs, pubsub

apigee:
  version: '1.0'
  provider: gcp
  service: apigee
  scope: global
  discovery:
  - discovery_id: list_apigee_organizations
    calls:
    - action: list
      fields:
      - path: name
        var: org_name
  - discovery_id: list_apigee_environments
    calls:
    - action: list
      fields:
      - path: name
        var: env_name
      - path: parent
        var: parent_org
  - discovery_id: list_api_proxies
    calls:
    - action: list
      fields:
      - path: name
        var: proxy_name
      - path: revision
        var: proxy_revision
  checks:
  - check_id: gcp.apigee.api_proxy.api_api_content_type_whitelist_enforced
    title: Enforce API Proxy Content Type Whitelist in Apigee
    severity: medium
    for_each: list_api_proxies
    logic: AND
    calls:
    - action: eval
      fields:
      - path: policies[].policyType
        operator: contains
        expected: ContentTypeWhitelist
      - path: policies[].enabled
        operator: equals
        expected: true
  - check_id: gcp.apigee.api_proxy.api_api_parameters_validation_enabled
    title: Ensure Apigee API Proxy Parameters Validation is Enabled
    severity: high
    for_each: list_api_proxies
    logic: AND
    calls:
    - action: eval
      fields:
      - path: policies[].policyType
        operator: contains
        expected: RegularExpressionProtection
      - path: policies[].configuration.QueryParam
        operator: exists
        expected: true
  - check_id: gcp.apigee.api_proxy.api_api_request_body_size_limit_configured
    title: Ensure API Request Body Size Limit is Configured for Apigee Proxies
    severity: medium
    for_each: list_api_proxies
    logic: AND
    calls:
    - action: eval
      fields:
      - path: policies[].policyType
        operator: contains
        expected: MessageValidation
      - path: policies[].configuration.Source.maxPayloadSizeInMB
        operator: exists
        expected: true
  - check_id: gcp.apigee.api_proxy.api_api_request_schema_validation_enabled
    title: Enable API Request Schema Validation in Apigee API Proxies
    severity: high
    for_each: list_api_proxies
    logic: AND
    calls:
    - action: eval
      fields:
      - path: policies[].policyType
        operator: contains
        expected: MessageValidation
      - path: policies[].configuration.Element.namespace
        operator: exists
        expected: true
      - path: policies[].configuration.SOAPMessage.Element.namespace
        operator: exists
        expected: true
  - check_id: gcp.apigee.api_proxy.api_api_required_security_headers_enforced
    title: Ensure API Proxies Enforce Required Security Headers
    severity: high
    for_each: list_api_proxies
    logic: AND
    calls:
    - action: eval
      fields:
      - path: policies[].policyType
        operator: contains
        expected: AssignMessage
      - path: policies[].configuration.AssignTo.createNew
        operator: equals
        expected: false
      - path: policies[].configuration.Add.Headers[].Name
        operator: contains
        expected: X-Content-Type-Options
  - check_id: gcp.apigee.api_proxy.api_api_response_schema_validation_enabled
    title: Ensure API Response Schema Validation is Enabled in Apigee
    severity: medium
    for_each: list_api_proxies
    logic: AND
    calls:
    - action: eval
      fields:
      - path: policies[].policyType
        operator: contains
        expected: MessageValidation
      - path: policies[].configuration.ResourceURL
        operator: exists
        expected: true
      - path: policies[].configuration.Element.namespace
        operator: contains
        expected: response
  - check_id: gcp.apigee.environment.api_rate_limiting_api_quota_limit_configured
    title: Ensure API Rate Limiting and Quota Limits in Apigee Environments
    severity: high
    for_each: list_apigee_environments
    logic: AND
    calls:
    - action: eval
      fields:
      - path: deployments[].apiProxy.policies[].policyType
        operator: contains
        expected: Quota
      - path: deployments[].apiProxy.policies[].configuration.Allow.count
        operator: exists
        expected: true
  - check_id: gcp.apigee.environment.api_rate_limiting_api_stage_burst_limit_configured
    title: Ensure API Stage Burst Limit Configured for Apigee Environments
    severity: medium
    for_each: list_apigee_environments
    logic: AND
    calls:
    - action: eval
      fields:
      - path: deployments[].apiProxy.policies[].policyType
        operator: contains
        expected: SpikeArrest
      - path: deployments[].apiProxy.policies[].configuration.Rate
        operator: exists
        expected: true
      - path: deployments[].apiProxy.policies[].configuration.UseEffectiveCount
        operator: equals
        expected: true
  - check_id: gcp.apigee.environment.api_rate_limiting_api_stage_configured
    title: Ensure API Rate Limiting is Configured for Apigee Environments
    severity: high
    for_each: list_apigee_environments
    logic: OR
    calls:
    - action: eval
      fields:
      - path: deployments[].apiProxy.policies[].policyType
        operator: contains
        expected: RateLimiting
      - path: deployments[].apiProxy.policies[].policyType
        operator: contains
        expected: SpikeArrest
  - check_id: gcp.apigee.environment.api_rate_limiting_api_stage_throttle_overrides_not_unbounded
    title: Ensure API Rate Limits Are Set for Apigee Environments
    severity: critical
    for_each: list_apigee_environments
    logic: AND
    calls:
    - action: eval
      fields:
      - path: deployments[].apiProxy.policies[].configuration.Rate
        operator: exists
        expected: true
      - path: deployments[].apiProxy.policies[].configuration.Rate
        operator: not_equals
        expected: unlimited
      - path: deployments[].apiProxy.policies[].configuration.Rate
        operator: not_equals
        expected: '-1'
  - check_id: gcp.apigee.environment.api_rate_limiting_api_usage_plan_required_for_api_keys
    title: Enforce API Rate Limiting with Usage Plans for API Keys in Apigee
    severity: high
    for_each: list_apigee_environments
    logic: AND
    calls:
    - action: eval
      fields:
      - path: deployments[].apiProxy.policies[].policyType
        operator: contains
        expected: VerifyAPIKey
      - path: deployments[].apiProxy.policies[].policyType
        operator: contains
        expected: Quota
      - path: deployments[].apiProxy.targetServers[].sSLInfo.keyStore
        operator: exists
        expected: true
  api_name: apigee
  api_version: v1
