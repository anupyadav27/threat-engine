# ============================================================================
# CURSOR AI: GCP SERVICE VALIDATION INSTRUCTIONS
# ============================================================================
# 
# üéØ YOUR MISSION: Validate and fix this GCP service YAML file
#
# WORKFLOW:
# 1. Read this entire YAML file structure
# 2. Run: `export GCP_ENGINE_FILTER_SERVICES="<SERVICE>" && python engine/gcp_engine.py > output/test_<service>.json 2>&1`
# 3. Analyze output - check for inventories, main_checks, errors
# 4. Fix issues in discovery and checks sections below
# 5. Re-run engine and verify output
# 6. Iterate until all checks work (PASS/FAIL based on resources)
# 7. Update validation status at bottom of file
#
# COMMON ISSUES & FIXES:
#
# ‚ùå Empty inventories ‚Üí Fix discovery action (must be: list_<resource>, aggregatedList_<resource>)
# ‚ùå Zero checks executed ‚Üí Fix for_each to match discovery_id
# ‚ùå All checks fail ‚Üí Fix field paths to match GCP API response
# ‚ùå Skipped checks ‚Üí Verify discovery_id exists and completed
# ‚ùå Python errors ‚Üí Check YAML syntax, action names
#
# TESTING:
# - Run engine: `export GCP_ENGINE_FILTER_SERVICES="<service>" && python engine/gcp_engine.py > output/test.json 2>&1`
# - Check output: `cat output/test.json | python3 -m json.tool`
# - Verify: inventories array has resources, main_checks array has results
#
# SUCCESS CRITERIA:
# ‚úÖ Engine runs without Python exceptions
# ‚úÖ Inventories populated (if resources exist in GCP)
# ‚úÖ All checks execute (PASS/FAIL based on actual resource state)
# ‚úÖ No skipped checks (unless expected)
# ‚úÖ Clean JSON output
#
# DOCUMENTATION:
# After fixing, update validation section at bottom:
# # VALIDATION STATUS:
# # - Issues Found: <what was wrong>
# # - Fixes Applied: <what you fixed>
# # - Tested: <date>
# # - Inventories: <count>
# # - Checks: <count executed>
# # - Status: ‚úÖ VALIDATED / ‚è≥ IN PROGRESS / ‚ùå NEEDS WORK
#
# ============================================================================

service_name:  # e.g., compute, gcs, pubsub

dlp:
  version: '1.0'
  provider: gcp
  service: dlp
  scope: global
  discovery:
  - discovery_id: list_dlp_inspect_templates
    calls:
    - action: list
      fields:
      - path: name
        var: template_name
      - path: inspectConfig
        var: inspect_config
      - path: displayName
        var: display_name
  - discovery_id: list_dlp_jobs
    calls:
    - action: list
      fields:
      - path: name
        var: job_name
      - path: type
        var: job_type
      - path: inspectDetails
        var: inspect_details
      - path: riskDetails
        var: risk_details
      - path: state
        var: job_state
  checks:
  - check_id: gcp.dlp.inspect_template.data_governance_classification_auto_classification_supported
    title: Enable Auto Classification in DLP Inspect Templates
    severity: medium
    for_each: list_dlp_inspect_templates
    logic: AND
    calls:
    - action: eval
      fields:
      - path: inspectConfig.customInfoTypes
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: inspectConfig.includeQuote
        operator: equals
        expected: true
    - action: eval
      fields:
      - path: inspectConfig.minLikelihood
        operator: exists
        expected: true
  - check_id: gcp.dlp.inspect_template.data_governance_classification_policy_blocks_publi_sensitive
    title: Ensure DLP Templates Enforce Publi Sensitive Data Classification
    severity: high
    for_each: list_dlp_inspect_templates
    logic: AND
    calls:
    - action: eval
      fields:
      - path: inspectConfig.infoTypes
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: inspectConfig.minLikelihood
        operator: contains
        expected: LIKELY
    - action: eval
      fields:
      - path: inspectConfig.limits.maxFindingsPerRequest
        operator: exists
        expected: true
  - check_id: gcp.dlp.inspect_template.data_governance_classification_required_sensitivity__present
    title: Ensure DLP Inspector Templates Classify Sensitive Data
    severity: high
    for_each: list_dlp_inspect_templates
    logic: AND
    calls:
    - action: eval
      fields:
      - path: inspectConfig.infoTypes
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: inspectConfig.customInfoTypes
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: inspectConfig.ruleSet
        operator: exists
        expected: true
  - check_id: gcp.dlp.job.data_governance_compliance_access_rbac_least_privilege
    title: Ensure DLP Job RBAC Follows Least Privilege Principle
    severity: high
    for_each: list_dlp_jobs
    logic: AND
    calls:
    - action: get_iam_policy
      fields:
      - path: bindings[].role
        operator: not_contains
        expected: roles/owner
    - action: get_iam_policy
      fields:
      - path: bindings[].role
        operator: not_contains
        expected: roles/editor
    - action: eval
      fields:
      - path: inspectDetails.requestedOptions.jobConfig.storageConfig
        operator: exists
        expected: true
  - check_id: gcp.dlp.job.data_governance_compliance_export_destinations_private
    title: Ensure DLP Job Export Destinations are Private
    severity: high
    for_each: list_dlp_jobs
    logic: AND
    calls:
    - action: eval
      fields:
      - path: inspectDetails.result.outputConfig.table.projectId
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: inspectDetails.result.outputConfig.outputSchema
        operator: equals
        expected: BASIC_COLUMNS
    - action: get_dataset_metadata
      fields:
      - path: access[].role
        operator: not_contains
        expected: allUsers
  - check_id: gcp.dlp.job.data_governance_compliance_reports_storage_encrypted
    title: Ensure DLP Job Reports are Encrypted at Rest
    severity: high
    for_each: list_dlp_jobs
    logic: AND
    calls:
    - action: eval
      fields:
      - path: inspectDetails.result.outputConfig.table
        operator: exists
        expected: true
    - action: get_table_metadata
      fields:
      - path: encryptionConfiguration.kmsKeyName
        operator: exists
        expected: true
    - action: get_bucket_metadata
      fields:
      - path: encryption.defaultKmsKeyName
        operator: exists
        expected: true
  - check_id: gcp.dlp.job.privacy_anonymization_jobs_private_networking
    title: Ensure DLP Anonymization Jobs Use Private Networking
    severity: medium
    for_each: list_dlp_jobs
    logic: AND
    calls:
    - action: eval
      fields:
      - path: type
        operator: equals
        expected: RISK_ANALYSIS_JOB
    - action: eval
      fields:
      - path: riskDetails.requestedOptions.privacyMetric
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: inspectDetails.requestedOptions.jobConfig.storageConfig.cloudStorageOptions.fileSet.url
        operator: not_contains
        expected: gs://public
  - check_id: gcp.dlp.job.privacy_anonymization_outputs_encrypted
    title: Ensure DLP Job Outputs are Encrypted for Privacy
    severity: high
    for_each: list_dlp_jobs
    logic: AND
    calls:
    - action: eval
      fields:
      - path: inspectDetails.result.outputConfig
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: riskDetails.requestedOptions.actions[].saveFindings.outputConfig
        operator: exists
        expected: true
    - action: get_bucket_metadata
      fields:
      - path: encryption.defaultKmsKeyName
        operator: exists
        expected: true
  - check_id: gcp.dlp.job.privacy_masking_execution_roles_least_privilege
    title: Enforce Least Privilege for DLP Privacy Masking Roles
    severity: high
    for_each: list_dlp_jobs
    logic: AND
    calls:
    - action: get_iam_policy
      fields:
      - path: bindings[].role
        operator: contains
        expected: roles/dlp
    - action: get_iam_policy
      fields:
      - path: bindings[].role
        operator: not_contains
        expected: roles/owner
    - action: eval
      fields:
      - path: inspectDetails.requestedOptions.actions[].deidentify
        operator: exists
        expected: true
  - check_id: gcp.dlp.job.privacy_masking_policies_present_for_sensitive_fields
    title: Ensure Privacy Masking for Sensitive Data in DLP Jobs
    severity: high
    for_each: list_dlp_jobs
    logic: AND
    calls:
    - action: eval
      fields:
      - path: inspectDetails.requestedOptions.actions[].deidentify.transformationConfig
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: inspectDetails.requestedOptions.actions[].deidentify.transformationDetailsStorageConfig
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: inspectDetails.requestedOptions.inspectConfig.infoTypes
        operator: exists
        expected: true
  api_name: dlp
  api_version: v2
  project_param_format: projects/{{project_id}}
