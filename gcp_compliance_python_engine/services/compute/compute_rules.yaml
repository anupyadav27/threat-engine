compute:
  scope: regional

  discovery:
    - discovery_id: instances
      calls:
        - action: aggregated_list_instances
    - discovery_id: firewalls
      calls:
        - action: list_firewalls

  checks:
    - check_id: compute_instance_no_external_ip
      for_each: instances
      param: instance
      calls:
        - action: eval
          fields:
            - path: has_external_ip
              operator: equals
              expected: false
      multi_step: false
      logic: AND
      errors_as_fail: []

    - check_id: compute_instance_shielded_secure_boot
      for_each: instances
      param: instance
      calls:
        - action: eval
          fields:
            - path: shielded_secure_boot
              operator: equals
              expected: true
      multi_step: false
      logic: AND
      errors_as_fail: []

    - check_id: compute_instance_serial_port_disabled
      for_each: instances
      param: instance
      calls:
        - action: eval
          fields:
            - path: metadata.serial_port_enabled
              operator: equals
              expected: false
      multi_step: false
      logic: AND
      errors_as_fail: []

    - check_id: compute_firewall_no_ssh_from_anywhere
      for_each: firewalls
      param: firewall
      multi_step: true
      logic: AND
      calls:
        - action: eval
          fields:
            - path: source_ranges[]
              operator: contains
              expected: 0.0.0.0/0
            - path: allowed_tcp_ports[]
              operator: contains
              expected: "22"
      errors_as_fail: []

    - check_id: compute_firewall_no_rdp_from_anywhere
      for_each: firewalls
      param: firewall
      multi_step: true
      logic: AND
      calls:
        - action: eval
          fields:
            - path: source_ranges[]
              operator: contains
              expected: 0.0.0.0/0
            - path: allowed_tcp_ports[]
              operator: contains
              expected: "3389"
      errors_as_fail: []

    - check_id: compute_firewall_no_wide_tcp_range_from_anywhere
      for_each: firewalls
      param: firewall
      multi_step: true
      logic: AND
      calls:
        - action: eval
          fields:
            - path: source_ranges[]
              operator: contains
              expected: 0.0.0.0/0
            - path: allowed_tcp_ports[]
              operator: contains
              expected: "0-65535"
      errors_as_fail: [] 