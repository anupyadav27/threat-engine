# ============================================================================
# CURSOR AI: GCP SERVICE VALIDATION INSTRUCTIONS
# ============================================================================
# 
# üéØ YOUR MISSION: Validate and fix this GCP service YAML file
#
# WORKFLOW:
# 1. Read this entire YAML file structure
# 2. Run: `export GCP_ENGINE_FILTER_SERVICES="<SERVICE>" && python engine/gcp_engine.py > output/test_<service>.json 2>&1`
# 3. Analyze output - check for inventories, main_checks, errors
# 4. Fix issues in discovery and checks sections below
# 5. Re-run engine and verify output
# 6. Iterate until all checks work (PASS/FAIL based on resources)
# 7. Update validation status at bottom of file
#
# COMMON ISSUES & FIXES:
#
# ‚ùå Empty inventories ‚Üí Fix discovery action (must be: list_<resource>, aggregatedList_<resource>)
# ‚ùå Zero checks executed ‚Üí Fix for_each to match discovery_id
# ‚ùå All checks fail ‚Üí Fix field paths to match GCP API response
# ‚ùå Skipped checks ‚Üí Verify discovery_id exists and completed
# ‚ùå Python errors ‚Üí Check YAML syntax, action names
#
# TESTING:
# - Run engine: `export GCP_ENGINE_FILTER_SERVICES="<service>" && python engine/gcp_engine.py > output/test.json 2>&1`
# - Check output: `cat output/test.json | python3 -m json.tool`
# - Verify: inventories array has resources, main_checks array has results
#
# SUCCESS CRITERIA:
# ‚úÖ Engine runs without Python exceptions
# ‚úÖ Inventories populated (if resources exist in GCP)
# ‚úÖ All checks execute (PASS/FAIL based on actual resource state)
# ‚úÖ No skipped checks (unless expected)
# ‚úÖ Clean JSON output
#
# DOCUMENTATION:
# After fixing, update validation section at bottom:
# # VALIDATION STATUS:
# # - Issues Found: <what was wrong>
# # - Fixes Applied: <what you fixed>
# # - Tested: <date>
# # - Inventories: <count>
# # - Checks: <count executed>
# # - Status: ‚úÖ VALIDATED / ‚è≥ IN PROGRESS / ‚ùå NEEDS WORK
#
# ============================================================================

service_name:  # e.g., compute, gcs, pubsub

pubsub:
  version: '1.0'
  provider: gcp
  service: pubsub
  scope: global
  api_name: pubsub
  api_version: v1
  project_param_format: 'projects/{{project_id}}'
  discovery:
  - discovery_id: list_pubsub_topics
    calls:
    - action: list_topics
      fields:
      - path: name
        var: topic_name
      - path: kmsKeyName
        var: topic_kms_key
      - path: messageStoragePolicy
        var: topic_storage_policy
  - discovery_id: list_pubsub_subscriptions
    calls:
    - action: list_subscriptions
      fields:
      - path: name
        var: subscription_name
      - path: topic
        var: subscription_topic
      - path: pushConfig
        var: push_config
      - path: bigqueryConfig
        var: bigquery_config
      - path: cloudStorageConfig
        var: cloud_storage_config
  checks:
  - check_id: gcp.pubsub.subscription.data_analytics_event_cross_account_sharing_restricted
    title: Restrict Cross-Account Sharing for Pub/Sub Data Analytics Events
    severity: high
    for_each: list_pubsub_subscriptions
    logic: AND
    calls:
    - action: eval
      fields:
      - path: bigqueryConfig
        operator: exists
        expected: true
    - action: get_subscription_iam_policy
      fields:
      - path: bindings[].members[]
        operator: not_contains
        expected: allUsers
      - path: bindings[].members[]
        operator: not_contains
        expected: allAuthenticatedUsers
  - check_id: gcp.pubsub.subscription.data_analytics_event_destination_encrypted
    title: Ensure Pub/Sub Analytics Destinations are Encrypted
    severity: high
    for_each: list_pubsub_subscriptions
    logic: OR
    calls:
    - action: eval
      fields:
      - path: bigqueryConfig.useTopicSchema
        operator: exists
        expected: true
      - path: bigqueryConfig.writeMetadata
        operator: exists
        expected: true
  - check_id: gcp.pubsub.subscription.data_analytics_event_destination_least_privilege
    title: Ensure Pub/Sub Subscriptions Use Least Privilege for Data Analytics
    severity: medium
    for_each: list_pubsub_subscriptions
    logic: AND
    calls:
    - action: eval
      fields:
      - path: bigqueryConfig
        operator: exists
        expected: true
    - action: get_subscription_iam_policy
      fields:
      - path: bindings[].role
        operator: not_contains
        expected: roles/editor
      - path: bindings[].role
        operator: not_contains
        expected: roles/owner
  - check_id: gcp.pubsub.subscription.data_warehouse_event_cross_account_sharing_restricted
    title: Restrict Cross-Account Sharing for Pub/Sub Subscriptions
    severity: high
    for_each: list_pubsub_subscriptions
    logic: AND
    calls:
    - action: eval
      fields:
      - path: cloudStorageConfig
        operator: exists
        expected: true
    - action: get_subscription_iam_policy
      fields:
      - path: bindings[].members[]
        operator: not_contains
        expected: allUsers
  - check_id: gcp.pubsub.subscription.data_warehouse_event_destination_encrypted
    title: Ensure Pub/Sub Subscription Event Destination is Encrypted
    severity: high
    for_each: list_pubsub_subscriptions
    logic: AND
    calls:
    - action: eval
      fields:
      - path: cloudStorageConfig.bucket
        operator: exists
        expected: true
    - action: get_bucket_encryption
      fields:
      - path: encryption.defaultKmsKeyName
        operator: exists
        expected: true
  - check_id: gcp.pubsub.subscription.data_warehouse_event_destination_least_privilege
    title: Ensure Least Privilege for Pub/Sub Data Warehouse Subscriptions
    severity: medium
    for_each: list_pubsub_subscriptions
    logic: AND
    calls:
    - action: eval
      fields:
      - path: cloudStorageConfig
        operator: exists
        expected: true
    - action: get_subscription_iam_policy
      fields:
      - path: bindings[].role
        operator: contains
        expected: roles/pubsub.subscriber
  - check_id: gcp.pubsub.subscription.streaming_consumer_access_least_privilege
    title: Ensure Least Privilege for Pub/Sub Subscription Consumers
    severity: medium
    for_each: list_pubsub_subscriptions
    logic: AND
    calls:
    - action: get_subscription_iam_policy
      fields:
      - path: bindings[].role
        operator: not_equals
        expected: roles/pubsub.admin
      - path: bindings[].role
        operator: not_equals
        expected: roles/editor
  - check_id: gcp.pubsub.subscription.streaming_consumer_auth_required
    title: Ensure Pub/Sub Streaming Consumers Use Authenticated Connections
    severity: high
    for_each: list_pubsub_subscriptions
    logic: AND
    calls:
    - action: get_subscription_iam_policy
      fields:
      - path: bindings[].members[]
        operator: not_contains
        expected: allUsers
      - path: bindings[].members[]
        operator: not_contains
        expected: allAuthenticatedUsers
  - check_id: gcp.pubsub.subscription.streaming_destination_encrypted
    title: Ensure Pub/Sub Streaming Destination Encryption at Rest
    severity: high
    for_each: list_pubsub_subscriptions
    logic: OR
    calls:
    - action: eval
      fields:
      - path: pushConfig.oidcToken
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: pushConfig.attributes.x-goog-version
        operator: exists
        expected: true
  - check_id: gcp.pubsub.subscription.streaming_destination_least_privilege
    title: Ensure Pub/Sub Subscriptions Use Least Privilege
    severity: medium
    for_each: list_pubsub_subscriptions
    logic: AND
    calls:
    - action: get_subscription_iam_policy
      fields:
      - path: bindings[].role
        operator: equals
        expected: roles/pubsub.subscriber
  - check_id: gcp.pubsub.subscription.streaming_encryption_at_rest_enabled
    title: Ensure Pub/Sub Subscription Encryption At Rest is Enabled
    severity: high
    for_each: list_pubsub_subscriptions
    logic: AND
    calls:
    - action: eval
      fields:
      - path: topic
        operator: exists
        expected: true
    - action: get_topic_details
      fields:
      - path: kmsKeyName
        operator: exists
        expected: true
  - check_id: gcp.pubsub.subscription.streaming_logging_enabled
    title: Ensure Pub/Sub Subscription Has Streaming Logging Enabled
    severity: medium
    for_each: list_pubsub_subscriptions
    logic: AND
    calls:
    - action: eval
      fields:
      - path: enableMessageOrdering
        operator: exists
        expected: true
    - action: get_project_logging_config
      fields:
      - path: logSinks[].destination
        operator: contains
        expected: pubsub
  - check_id: gcp.pubsub.subscription.streaming_private_network_only_where_supported
    title: Ensure Pub/Sub Subscriptions Use Private Network for Streaming
    severity: medium
    for_each: list_pubsub_subscriptions
    logic: AND
    calls:
    - action: eval
      fields:
      - path: pushConfig.pushEndpoint
        operator: contains
        expected: https://
    - action: eval
      fields:
      - path: pushConfig.attributes.x-goog-pubsub-private-endpoint
        operator: equals
        expected: 'true'
  - check_id: gcp.pubsub.subscription.streaming_video_encryption_at_rest_enabled
    title: Ensure Pub/Sub Subscriptions Encrypt Streaming Video At Rest
    severity: high
    for_each: list_pubsub_subscriptions
    logic: AND
    calls:
    - action: eval
      fields:
      - path: labels.content-type
        operator: contains
        expected: video
    - action: get_topic_details
      fields:
      - path: kmsKeyName
        operator: exists
        expected: true
  - check_id: gcp.pubsub.subscription.streaming_video_encryption_in_transit_required
    title: Ensure Encryption In Transit for Pub/Sub Video Streams
    severity: high
    for_each: list_pubsub_subscriptions
    logic: AND
    calls:
    - action: eval
      fields:
      - path: labels.content-type
        operator: contains
        expected: video
      - path: pushConfig.pushEndpoint
        operator: contains
        expected: https://
  - check_id: gcp.pubsub.subscription.streaming_video_retention_days_minimum_configured
    title: Ensure Minimum Retention for Streaming Video Subscriptions in Pub/Sub
    severity: medium
    for_each: list_pubsub_subscriptions
    logic: AND
    calls:
    - action: eval
      fields:
      - path: labels.content-type
        operator: contains
        expected: video
      - path: messageRetentionDuration
        operator: exists
        expected: true
  - check_id: gcp.pubsub.subscription.topic_subscription_configured
    title: Ensure Pub/Sub Subscription Has Associated Topic
    severity: critical
    for_each: list_pubsub_subscriptions
    logic: AND
    calls:
    - action: eval
      fields:
      - path: topic
        operator: exists
        expected: true
      - path: topic
        operator: not_equals
        expected: ''
  - check_id: gcp.pubsub.topic.data_protection_storage_queue_auth_required
    title: Ensure Pub/Sub Topics Require Authentication
    severity: high
    for_each: list_pubsub_topics
    logic: AND
    calls:
    - action: get_topic_iam_policy
      fields:
      - path: bindings[].members[]
        operator: not_contains
        expected: allUsers
      - path: bindings[].members[]
        operator: not_contains
        expected: allAuthenticatedUsers
  - check_id: gcp.pubsub.topic.data_protection_storage_queue_cross_account_send__restricted
    title: Restrict Cross-Account Data Sent via Pub/Sub Topics
    severity: high
    for_each: list_pubsub_topics
    logic: AND
    calls:
    - action: get_topic_iam_policy
      fields:
      - path: bindings[].members[]
        operator: not_contains
        expected: 'domain:'
      - path: bindings[].role
        operator: not_equals
        expected: roles/pubsub.publisher
  - check_id: gcp.pubsub.topic.data_protection_storage_queue_encryption_at_rest_enabled
    title: Ensure Pub/Sub Topic Encryption at Rest is Enabled
    severity: high
    for_each: list_pubsub_topics
    logic: AND
    calls:
    - action: eval
      fields:
      - path: kmsKeyName
        operator: exists
        expected: true
      - path: kmsKeyName
        operator: not_equals
        expected: ''
  - check_id: gcp.pubsub.topic.message_ordering_enabled
    title: Ensure Pub/Sub Topic Has Message Ordering Enabled
    severity: low
    for_each: list_pubsub_topics
    logic: AND
    calls:
    - action: eval
      fields:
      - path: messageStoragePolicy.allowedPersistenceRegions
        operator: exists
        expected: true
  - check_id: gcp.pubsub.topic.message_retention_configured
    title: Ensure Pub/Sub Topic Has Message Retention Configured
    severity: medium
    for_each: list_pubsub_topics
    logic: AND
    calls:
    - action: eval
      fields:
      - path: messageRetentionDuration
        operator: exists
        expected: true
  - check_id: gcp.pubsub.topic.regional_persistence_enabled
    title: Ensure Pub/Sub Topic Has Regional Persistence Enabled
    severity: medium
    for_each: list_pubsub_topics
    logic: AND
    calls:
    - action: eval
      fields:
      - path: messageStoragePolicy.allowedPersistenceRegions
        operator: exists
        expected: true
      - path: messageStoragePolicy.allowedPersistenceRegions
        operator: not_equals
        expected: []
  - check_id: gcp.pubsub.topic.schema_validation_enabled
    title: Ensure Pub/Sub Topic Has Schema Validation Enabled
    severity: medium
    for_each: list_pubsub_topics
    logic: AND
    calls:
    - action: eval
      fields:
      - path: schemaSettings.schema
        operator: exists
        expected: true
      - path: schemaSettings.encoding
        operator: exists
        expected: true
  - check_id: gcp.pubsub.topic.dead_letter_policy_configured
    title: Ensure Pub/Sub Subscriptions Have Dead Letter Policy Configured
    severity: medium
    for_each: list_pubsub_subscriptions
    logic: AND
    calls:
    - action: eval
      fields:
      - path: deadLetterPolicy.deadLetterTopic
        operator: exists
        expected: true
      - path: deadLetterPolicy.maxDeliveryAttempts
        operator: exists
        expected: true
  - check_id: gcp.pubsub.subscription.ack_deadline_configured
    title: Ensure Pub/Sub Subscription Has Appropriate Acknowledgment Deadline
    severity: low
    for_each: list_pubsub_subscriptions
    logic: AND
    calls:
    - action: eval
      fields:
      - path: ackDeadlineSeconds
        operator: exists
        expected: true
  - check_id: gcp.pubsub.topic.labels_configured
    title: Ensure Pub/Sub Topics Have Appropriate Labels
    severity: low
    for_each: list_pubsub_topics
    logic: AND
    calls:
    - action: eval
      fields:
      - path: labels
        operator: exists
        expected: true
      - path: labels.environment
        operator: exists
        expected: true
