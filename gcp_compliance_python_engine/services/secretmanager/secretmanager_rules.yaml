# ============================================================================
# CURSOR AI: GCP SERVICE VALIDATION INSTRUCTIONS
# ============================================================================
# 
# üéØ YOUR MISSION: Validate and fix this GCP service YAML file
#
# WORKFLOW:
# 1. Read this entire YAML file structure
# 2. Run: `export GCP_ENGINE_FILTER_SERVICES="<SERVICE>" && python engine/gcp_engine.py > output/test_<service>.json 2>&1`
# 3. Analyze output - check for inventories, main_checks, errors
# 4. Fix issues in discovery and checks sections below
# 5. Re-run engine and verify output
# 6. Iterate until all checks work (PASS/FAIL based on resources)
# 7. Update validation status at bottom of file
#
# COMMON ISSUES & FIXES:
#
# ‚ùå Empty inventories ‚Üí Fix discovery action (must be: list_<resource>, aggregatedList_<resource>)
# ‚ùå Zero checks executed ‚Üí Fix for_each to match discovery_id
# ‚ùå All checks fail ‚Üí Fix field paths to match GCP API response
# ‚ùå Skipped checks ‚Üí Verify discovery_id exists and completed
# ‚ùå Python errors ‚Üí Check YAML syntax, action names
#
# TESTING:
# - Run engine: `export GCP_ENGINE_FILTER_SERVICES="<service>" && python engine/gcp_engine.py > output/test.json 2>&1`
# - Check output: `cat output/test.json | python3 -m json.tool`
# - Verify: inventories array has resources, main_checks array has results
#
# SUCCESS CRITERIA:
# ‚úÖ Engine runs without Python exceptions
# ‚úÖ Inventories populated (if resources exist in GCP)
# ‚úÖ All checks execute (PASS/FAIL based on actual resource state)
# ‚úÖ No skipped checks (unless expected)
# ‚úÖ Clean JSON output
#
# DOCUMENTATION:
# After fixing, update validation section at bottom:
# # VALIDATION STATUS:
# # - Issues Found: <what was wrong>
# # - Fixes Applied: <what you fixed>
# # - Tested: <date>
# # - Inventories: <count>
# # - Checks: <count executed>
# # - Status: ‚úÖ VALIDATED / ‚è≥ IN PROGRESS / ‚ùå NEEDS WORK
#
# ============================================================================

service_name:  # e.g., compute, gcs, pubsub

secretmanager:
  version: '1.0'
  provider: gcp
  service: secretmanager
  scope: global
  discovery:
  - discovery_id: list_secretmanager_secrets
    calls:
    - action: list
      fields:
      - path: name
        var: secret_name
      - path: createTime
        var: create_time
      - path: labels
        var: labels
      - path: replication
        var: replication
      - path: expireTime
        var: expire_time
      - path: rotation
        var: rotation
  - discovery_id: list_secretmanager_versions
    calls:
    - action: list
      fields:
      - path: name
        var: version_name
      - path: createTime
        var: version_create_time
      - path: state
        var: version_state
      - path: replicationStatus
        var: replication_status
  - discovery_id: get_secret_iam_policy
    calls:
    - action: get_iam_policy
      fields:
      - path: bindings
        var: iam_bindings
      - path: etag
        var: policy_etag
  checks:
  - check_id: gcp.secretmanager.secret.compliance
    title: Ensure Secret Manager Secrets Meet Compliance Standards
    severity: high
    for_each: list_secretmanager_secrets
    logic: AND
    calls:
    - action: eval
      fields:
      - path: labels.compliance
        operator: exists
      - path: labels.environment
        operator: exists
      - path: expireTime
        operator: exists
  - check_id: gcp.secretmanager.secret.compliant_patching
    title: Ensure Secret Manager Secrets Are Patched Regularly
    severity: medium
    for_each: list_secretmanager_versions
    logic: AND
    calls:
    - action: eval
      fields:
      - path: createTime
        operator: exists
      - path: state
        operator: equals
        expected: ENABLED
  - check_id: gcp.secretmanager.secret.manager_enabled
    title: Ensure Secret Manager is Enabled for Secrets
    severity: critical
    for_each: list_secretmanager_secrets
    logic: AND
    calls:
    - action: eval
      fields:
      - path: name
        operator: exists
      - path: __self__
        operator: exists
  - check_id: gcp.secretmanager.secret.patching
    title: Ensure Secret Manager Secrets Are Regularly Patched
    severity: medium
    for_each: list_secretmanager_versions
    logic: AND
    calls:
    - action: eval
      fields:
      - path: createTime
        operator: exists
      - path: state
        operator: equals
        expected: ENABLED
  - check_id: gcp.secretmanager.secret.secret_rotation_enabled
    title: Ensure Secret Rotation is Enabled for GCP Secrets
    severity: high
    for_each: list_secretmanager_secrets
    logic: AND
    calls:
    - action: eval
      fields:
      - path: rotation
        operator: exists
      - path: rotation.rotationPeriod
        operator: exists
  - check_id: gcp.secretmanager.secret.secrets_access_rbac_least_privilege
    title: Ensure Least Privilege for Secret Manager Access
    severity: high
    for_each: get_secret_iam_policy
    logic: AND
    calls:
    - action: eval
      fields:
      - path: bindings[].role
        operator: not_equals
        expected: roles/secretmanager.admin
      - path: bindings[].members[]
        operator: not_contains
        expected: allUsers
      - path: bindings[].members[]
        operator: not_contains
        expected: allAuthenticatedUsers
  - check_id: gcp.secretmanager.secret.secrets_alias_points_to_active_key
    title: Ensure Secrets Alias Points to Active Encryption Key
    severity: medium
    for_each: list_secretmanager_secrets
    logic: AND
    calls:
    - action: eval
      fields:
      - path: replication.userManaged.replicas[].customerManagedEncryption.kmsKeyName
        operator: exists
      - path: labels.key_alias
        operator: exists
  - check_id: gcp.secretmanager.secret.secrets_ca_access_rbac_least_privilege
    title: Enforce Least Privilege for Secret Access in Secret Manager
    severity: high
    for_each: get_secret_iam_policy
    logic: AND
    calls:
    - action: eval
      fields:
      - path: bindings[].role
        operator: not_equals
        expected: roles/secretmanager.secretAccessor
      - path: bindings[].members[]
        operator: not_contains
        expected: allUsers
  - check_id: gcp.secretmanager.secret.secrets_ca_key_in_hsm_where_supported
    title: Ensure Secrets CA Key Uses HSM Where Supported
    severity: medium
    for_each: list_secretmanager_secrets
    logic: AND
    calls:
    - action: eval
      fields:
      - path: replication.userManaged.replicas[].customerManagedEncryption.kmsKeyName
        operator: contains
        expected: hsm
  - check_id: gcp.secretmanager.secret.secrets_crl_or_ocsp_configured
    title: Ensure CRL or OCSP is Configured for Secrets
    severity: medium
    for_each: list_secretmanager_secrets
    logic: OR
    calls:
    - action: eval
      fields:
      - path: labels.crl_endpoint
        operator: exists
      - path: labels.ocsp_endpoint
        operator: exists
  - check_id: gcp.secretmanager.secret.secrets_key_has_alias
    title: Ensure Secret Manager Secrets Have Key Alias
    severity: low
    for_each: list_secretmanager_secrets
    logic: AND
    calls:
    - action: eval
      fields:
      - path: labels.key_alias
        operator: exists
  - check_id: gcp.secretmanager.secret.secrets_key_length_minimum
    title: Ensure Secret Key Length Is At Least 256 Bits
    severity: high
    for_each: list_secretmanager_secrets
    logic: AND
    calls:
    - action: eval
      fields:
      - path: labels.key_length
        operator: exists
      - path: labels.minimum_key_bits
        operator: equals
        expected: '256'
  - check_id: gcp.secretmanager.secret.secrets_kms_constraints_present
    title: Ensure Secrets Use KMS Encryption Constraints
    severity: medium
    for_each: list_secretmanager_secrets
    logic: AND
    calls:
    - action: eval
      fields:
      - path: replication.userManaged.replicas[].customerManagedEncryption
        operator: exists
      - path: labels.kms_constraints
        operator: exists
  - check_id: gcp.secretmanager.secret.secrets_kms_encryption_enabled
    title: Ensure Secrets Use Customer-Managed Encryption Keys
    severity: high
    for_each: list_secretmanager_secrets
    logic: AND
    calls:
    - action: eval
      fields:
      - path: replication.userManaged.replicas[].customerManagedEncryption.kmsKeyName
        operator: exists
  - check_id: gcp.secretmanager.secret.secrets_kms_grantee_principal_valid
    title: Ensure Valid KMS Grantee Principal for Secret Access
    severity: medium
    for_each: get_secret_iam_policy
    logic: AND
    calls:
    - action: eval
      fields:
      - path: bindings[].members[]
        operator: not_contains
        expected: 'deleted:'
      - path: bindings[].members[]
        operator: contains
        expected: '@'
  - check_id: gcp.secretmanager.secret.secrets_kms_key_configured
    title: Ensure Secrets Use Customer-Managed Encryption Keys
    severity: high
    for_each: list_secretmanager_secrets
    logic: AND
    calls:
    - action: eval
      fields:
      - path: replication.userManaged.replicas[].customerManagedEncryption.kmsKeyName
        operator: exists
  - check_id: gcp.secretmanager.secret.secrets_kms_lessthan_wildcard_permissions
    title: Limit KMS Permissions for Secrets in Secret Manager
    severity: high
    for_each: get_secret_iam_policy
    logic: AND
    calls:
    - action: eval
      fields:
      - path: bindings[].role
        operator: not_equals
        expected: roles/*
      - path: bindings[].members[]
        operator: not_equals
        expected: '*'
  - check_id: gcp.secretmanager.secret.secrets_no_plaintext_exposed_in_policy_or_tags
    title: Prevent Exposure of Secrets in Policies or Tags
    severity: critical
    for_each: list_secretmanager_secrets
    logic: AND
    calls:
    - action: eval
      fields:
      - path: labels
        operator: not_contains
        expected: password
      - path: labels
        operator: not_contains
        expected: secret
      - path: labels
        operator: not_contains
        expected: key
  - check_id: gcp.secretmanager.secret.secrets_not_expired
    title: Ensure Secrets in Secret Manager Have Expiration Dates
    severity: medium
    for_each: list_secretmanager_secrets
    logic: AND
    calls:
    - action: eval
      fields:
      - path: expireTime
        operator: exists
  - check_id: gcp.secretmanager.secret.secrets_path_length_constraints_set
    title: Ensure Secret Path Length Constraints in Secret Manager
    severity: low
    for_each: list_secretmanager_secrets
    logic: AND
    calls:
    - action: eval
      fields:
      - path: name
        operator: exists
      - path: labels.path_length_constraint
        operator: exists
  - check_id: gcp.secretmanager.secret.secrets_regional_replication
    title: Ensure Secrets Use Regional Replication for High Availability
    severity: medium
    for_each: list_secretmanager_secrets
    logic: OR
    calls:
    - action: eval
      fields:
      - path: replication.userManaged.replicas
        operator: exists
      - path: replication.automatic
        operator: exists
  - check_id: gcp.secretmanager.secret.secrets_version_destruction_scheduled
    title: Ensure Secret Versions Have Destruction Schedule
    severity: medium
    for_each: list_secretmanager_versions
    logic: AND
    calls:
    - action: eval
      fields:
      - path: destroyTime
        operator: exists
  - check_id: gcp.secretmanager.secret.secrets_audit_logging_enabled
    title: Ensure Audit Logging is Enabled for Secret Manager
    severity: high
    for_each: list_secretmanager_secrets
    logic: AND
    calls:
    - action: eval
      fields:
      - path: labels.audit_logging
        operator: equals
        expected: enabled
  - check_id: gcp.secretmanager.secret.secrets_network_access_restricted
    title: Ensure Network Access to Secrets is Restricted
    severity: high
    for_each: list_secretmanager_secrets
    logic: AND
    calls:
    - action: eval
      fields:
      - path: labels.network_policy
        operator: exists
      - path: labels.vpc_access_only
        operator: equals
        expected: 'true'
  api_name: secretmanager
  api_version: v1
  project_param_format: projects/{{project_id}}
