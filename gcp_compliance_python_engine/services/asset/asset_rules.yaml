# ============================================================================
# CURSOR AI: GCP SERVICE VALIDATION INSTRUCTIONS
# ============================================================================
# 
# üéØ YOUR MISSION: Validate and fix this GCP service YAML file
#
# WORKFLOW:
# 1. Read this entire YAML file structure
# 2. Run: `export GCP_ENGINE_FILTER_SERVICES="<SERVICE>" && python engine/gcp_engine.py > output/test_<service>.json 2>&1`
# 3. Analyze output - check for inventories, main_checks, errors
# 4. Fix issues in discovery and checks sections below
# 5. Re-run engine and verify output
# 6. Iterate until all checks work (PASS/FAIL based on resources)
# 7. Update validation status at bottom of file
#
# COMMON ISSUES & FIXES:
#
# ‚ùå Empty inventories ‚Üí Fix discovery action (must be: list_<resource>, aggregatedList_<resource>)
# ‚ùå Zero checks executed ‚Üí Fix for_each to match discovery_id
# ‚ùå All checks fail ‚Üí Fix field paths to match GCP API response
# ‚ùå Skipped checks ‚Üí Verify discovery_id exists and completed
# ‚ùå Python errors ‚Üí Check YAML syntax, action names
#
# TESTING:
# - Run engine: `export GCP_ENGINE_FILTER_SERVICES="<service>" && python engine/gcp_engine.py > output/test.json 2>&1`
# - Check output: `cat output/test.json | python3 -m json.tool`
# - Verify: inventories array has resources, main_checks array has results
#
# SUCCESS CRITERIA:
# ‚úÖ Engine runs without Python exceptions
# ‚úÖ Inventories populated (if resources exist in GCP)
# ‚úÖ All checks execute (PASS/FAIL based on actual resource state)
# ‚úÖ No skipped checks (unless expected)
# ‚úÖ Clean JSON output
#
# DOCUMENTATION:
# After fixing, update validation section at bottom:
# # VALIDATION STATUS:
# # - Issues Found: <what was wrong>
# # - Fixes Applied: <what you fixed>
# # - Tested: <date>
# # - Inventories: <count>
# # - Checks: <count executed>
# # - Status: ‚úÖ VALIDATED / ‚è≥ IN PROGRESS / ‚ùå NEEDS WORK
#
# ============================================================================

service_name:  # e.g., compute, gcs, pubsub

asset:
  version: '1.0'
  provider: gcp
  service: asset
  scope: global
  discovery:
  - discovery_id: list_asset_resources
    calls:
    - action: list
      fields:
      - path: name
        var: resource_name
      - path: assetType
        var: asset_type
  - discovery_id: list_asset_feeds
    calls:
    - action: list
      fields:
      - path: name
        var: feed_name
      - path: feedOutputConfig
        var: feed_output_config
  checks:
  - check_id: gcp.asset.asset.governance_aggregation_authorization_not_expired_or_revoked
    title: Ensure Governance Authorization is Valid and Not Revoked
    severity: high
    for_each: list_asset_resources
    logic: AND
    calls:
    - action: eval
      fields:
      - path: resource.data.aggregationAuthorization.state
        operator: equals
        expected: ACTIVE
    - action: eval
      fields:
      - path: resource.data.aggregationAuthorization.expirationTime
        operator: exists
    - action: eval
      fields:
      - path: resource.data.aggregationAuthorization.revoked
        operator: equals
        expected: false
  - check_id: gcp.asset.asset.governance_aggregation_authorization_target_accounts_correct
    title: Ensure Proper Authorization for Governance Aggregation
    severity: medium
    for_each: list_asset_resources
    logic: AND
    calls:
    - action: eval
      fields:
      - path: resource.data.aggregationAuthorization.authorizedAccountId
        operator: exists
    - action: eval
      fields:
      - path: resource.data.aggregationAuthorization.authorizedAccountId
        operator: contains
        expected: organizations/
    - action: eval
      fields:
      - path: resource.data.aggregationAuthorization.permissions
        operator: contains
        expected: cloudasset.assets.searchAllResources
  - check_id: gcp.asset.asset.governance_aggregation_authorization_trusts_least_privilege
    title: Enforce Least Privilege in Governance Aggregation Authorization
    severity: high
    for_each: list_asset_resources
    logic: AND
    calls:
    - action: eval
      fields:
      - path: resource.data.aggregationAuthorization.permissions
        operator: exists
    - action: eval
      fields:
      - path: resource.data.aggregationAuthorization.permissions
        operator: contains
        expected: cloudasset.assets.searchAllResources
    - action: eval
      fields:
      - path: resource.data.aggregationAuthorization.conditions
        operator: exists
  - check_id: gcp.asset.asset.governance_config_recorder_enabled
    title: Ensure Governance Config Recorder is Enabled for Asset Monitoring
    severity: critical
    for_each: list_asset_resources
    logic: AND
    calls:
    - action: eval
      fields:
      - path: resource.data.configRecorder.recordingGroup.allSupported
        operator: equals
        expected: true
    - action: eval
      fields:
      - path: resource.data.configRecorder.recordingGroup.recordingEnabled
        operator: equals
        expected: true
    - action: eval
      fields:
      - path: resource.data.configRecorder.state
        operator: equals
        expected: ACTIVE
  - check_id: gcp.asset.asset.governance_config_recorder_global_resource_types_tracked
    title: Track Global Resource Types with Governance Config Recorder
    severity: medium
    for_each: list_asset_resources
    logic: AND
    calls:
    - action: eval
      fields:
      - path: resource.data.configRecorder.recordingGroup.includeGlobalResourceTypes
        operator: equals
        expected: true
    - action: eval
      fields:
      - path: resource.data.configRecorder.recordingGroup.resourceTypes
        operator: contains
        expected: compute.googleapis.com/GlobalForwardingRule
    - action: eval
      fields:
      - path: resource.data.configRecorder.recordingGroup.resourceTypes
        operator: contains
        expected: iam.googleapis.com/Role
  - check_id: gcp.asset.asset.governance_delivery_channel_secure_destination_configured
    title: Ensure Secure Configuration for Governance Delivery Channel
    severity: high
    for_each: list_asset_resources
    logic: AND
    calls:
    - action: eval
      fields:
      - path: resource.data.deliveryChannel.deliveryProperties.deliveryFrequency
        operator: exists
    - action: eval
      fields:
      - path: resource.data.deliveryChannel.s3BucketName
        operator: exists
    - action: eval
      fields:
      - path: resource.data.deliveryChannel.snsTopicARN
        operator: exists
    - action: eval
      fields:
      - path: resource.data.deliveryChannel.deliveryProperties.encryptionEnabled
        operator: equals
        expected: true
  - check_id: gcp.asset.feed.governance_aggregation_authorization_present_and_valid
    title: Ensure Valid Authorization for Asset Feed Governance Aggregation
    severity: high
    for_each: list_asset_feeds
    logic: AND
    calls:
    - action: eval
      fields:
      - path: feedOutputConfig.pubsubDestination.topic
        operator: exists
    - action: eval
      fields:
      - path: condition
        operator: exists
    - action: eval
      fields:
      - path: assetTypes
        operator: exists
    - action: get_feed_authorization
      fields:
      - path: authorization.state
        operator: equals
        expected: ACTIVE
  - check_id: gcp.asset.feed.governance_aggregator_auto_enroll_new_accounts
    title: Auto-Enroll New Accounts in Governance Aggregator
    severity: medium
    for_each: list_asset_feeds
    logic: AND
    calls:
    - action: eval
      fields:
      - path: feedOutputConfig.pubsubDestination.topic
        operator: contains
        expected: organizations/
    - action: eval
      fields:
      - path: condition
        operator: contains
        expected: resource.data.iamPolicy.bindings
    - action: get_feed_policy
      fields:
      - path: bindings[].members[]
        operator: contains
        expected: 'domain:'
  - check_id: gcp.asset.feed.governance_aggregator_org_aggregator_enabled
    title: Enable Governance Aggregator for Organization Asset Monitoring
    severity: critical
    for_each: list_asset_feeds
    logic: AND
    calls:
    - action: eval
      fields:
      - path: name
        operator: contains
        expected: organizations/
    - action: eval
      fields:
      - path: assetTypes
        operator: contains
        expected: cloudresourcemanager.googleapis.com/Organization
    - action: eval
      fields:
      - path: feedOutputConfig.pubsubDestination.topic
        operator: exists
    - action: eval
      fields:
      - path: contentType
        operator: equals
        expected: RESOURCE
  - check_id: gcp.asset.feed.governance_delivery_channel_destination_access_lea_privilege
    title: Ensure Least Privilege for Asset Feed Delivery Channel
    severity: high
    for_each: list_asset_feeds
    logic: AND
    calls:
    - action: get_feed_iam_policy
      fields:
      - path: bindings[].role
        operator: equals
        expected: roles/pubsub.publisher
    - action: eval
      fields:
      - path: feedOutputConfig.pubsubDestination.topic
        operator: exists
    - action: get_topic_iam_policy
      fields:
      - path: bindings[].members[]
        operator: contains
        expected: 'serviceAccount:'
  - check_id: gcp.asset.feed.governance_delivery_channel_kms_encryption_enabled
    title: Ensure KMS Encryption for Asset Feed Governance Channels
    severity: high
    for_each: list_asset_feeds
    logic: AND
    calls:
    - action: get_pubsub_topic_details
      fields:
      - path: kmsKeyName
        operator: exists
    - action: eval
      fields:
      - path: feedOutputConfig.pubsubDestination.topic
        operator: exists
    - action: get_kms_key_details
      fields:
      - path: state
        operator: equals
        expected: ENABLED
  api_name: cloudasset
  api_version: v1
  project_param_format: projects/{{project_id}}
