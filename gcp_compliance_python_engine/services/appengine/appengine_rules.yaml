# ============================================================================
# CURSOR AI: GCP SERVICE VALIDATION INSTRUCTIONS
# ============================================================================
# 
# üéØ YOUR MISSION: Validate and fix this GCP service YAML file
#
# WORKFLOW:
# 1. Read this entire YAML file structure
# 2. Run: `export GCP_ENGINE_FILTER_SERVICES="<SERVICE>" && python engine/gcp_engine.py > output/test_<service>.json 2>&1`
# 3. Analyze output - check for inventories, main_checks, errors
# 4. Fix issues in discovery and checks sections below
# 5. Re-run engine and verify output
# 6. Iterate until all checks work (PASS/FAIL based on resources)
# 7. Update validation status at bottom of file
#
# COMMON ISSUES & FIXES:
#
# ‚ùå Empty inventories ‚Üí Fix discovery action (must be: list_<resource>, aggregatedList_<resource>)
# ‚ùå Zero checks executed ‚Üí Fix for_each to match discovery_id
# ‚ùå All checks fail ‚Üí Fix field paths to match GCP API response
# ‚ùå Skipped checks ‚Üí Verify discovery_id exists and completed
# ‚ùå Python errors ‚Üí Check YAML syntax, action names
#
# TESTING:
# - Run engine: `export GCP_ENGINE_FILTER_SERVICES="<service>" && python engine/gcp_engine.py > output/test.json 2>&1`
# - Check output: `cat output/test.json | python3 -m json.tool`
# - Verify: inventories array has resources, main_checks array has results
#
# SUCCESS CRITERIA:
# ‚úÖ Engine runs without Python exceptions
# ‚úÖ Inventories populated (if resources exist in GCP)
# ‚úÖ All checks execute (PASS/FAIL based on actual resource state)
# ‚úÖ No skipped checks (unless expected)
# ‚úÖ Clean JSON output
#
# DOCUMENTATION:
# After fixing, update validation section at bottom:
# # VALIDATION STATUS:
# # - Issues Found: <what was wrong>
# # - Fixes Applied: <what you fixed>
# # - Tested: <date>
# # - Inventories: <count>
# # - Checks: <count executed>
# # - Status: ‚úÖ VALIDATED / ‚è≥ IN PROGRESS / ‚ùå NEEDS WORK
#
# ============================================================================

service_name:  # e.g., compute, gcs, pubsub

appengine:
  version: '1.0'
  provider: gcp
  service: appengine
  scope: global
  discovery:
  - discovery_id: list_appengine_applications
    calls:
    - action: list
      fields:
      - path: name
        var: application_name
      - path: id
        var: application_id
  - discovery_id: list_appengine_services
    calls:
    - action: list
      fields:
      - path: name
        var: service_name
      - path: id
        var: service_id
  - discovery_id: list_appengine_versions
    calls:
    - action: list
      fields:
      - path: name
        var: version_name
      - path: id
        var: version_id
      - path: service
        var: parent_service
  checks:
  - check_id: gcp.appengine.application.enforce_https_in_transit
    title: Enforce HTTPS for App Engine Application Traffic
    severity: high
    for_each: list_appengine_applications
    logic: AND
    calls:
    - action: eval
      fields:
      - path: defaultHostname
        operator: exists
        expected: true
    - action: get_application_ssl_settings
      fields:
      - path: sslSettings.certificateId
        operator: exists
        expected: true
      - path: sslSettings.pendingManagedCertificateId
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: servingStatus
        operator: equals
        expected: SERVING
  - check_id: gcp.appengine.application.engine_managed_updates_enabled
    title: Ensure App Engine Managed Updates Are Enabled
    severity: medium
    for_each: list_appengine_applications
    logic: AND
    calls:
    - action: get_application_feature_settings
      fields:
      - path: featureSettings.splitHealthChecks
        operator: equals
        expected: true
      - path: featureSettings.useContainerOptimizedOs
        operator: equals
        expected: true
  - check_id: gcp.appengine.application.paas_app_env_secrets_from_vault_only
    title: Ensure App Engine Uses Vault for Environment Secrets
    severity: high
    for_each: list_appengine_versions
    logic: AND
    calls:
    - action: get_version_details
      fields:
      - path: envVariables
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: envVariables
        operator: contains
        expected: projects/*/secrets/*
    - action: eval
      fields:
      - path: betaSettings.cloud_sql_instances
        operator: not_exists
        expected: true
  - check_id: gcp.appengine.application.paas_app_logging_enabled
    title: Ensure App Engine Logging is Enabled
    severity: medium
    for_each: list_appengine_versions
    logic: AND
    calls:
    - action: get_version_details
      fields:
      - path: handlers[].script.scriptPath
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: automaticScaling.standardSchedulerSettings.targetCpuUtilization
        operator: exists
        expected: true
    - action: get_application_logs_config
      fields:
      - path: loggingConfig.level
        operator: equals
        expected: INFO
  - check_id: gcp.appengine.application.paas_app_private_networking_enforced
    title: Enforce Private Networking for App Engine Applications
    severity: high
    for_each: list_appengine_versions
    logic: AND
    calls:
    - action: get_version_details
      fields:
      - path: network.name
        operator: exists
        expected: true
      - path: network.subnetworkName
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: network.instanceTag
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: vpcAccessConnector.name
        operator: exists
        expected: true
  - check_id: gcp.appengine.application.paas_app_tls_min_1_2_enforced
    title: Enforce TLS 1.2+ for App Engine Applications
    severity: high
    for_each: list_appengine_applications
    logic: AND
    calls:
    - action: get_application_ssl_settings
      fields:
      - path: sslSettings.certificateId
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: iap.enabled
        operator: equals
        expected: true
    - action: get_domain_mappings
      fields:
      - path: sslSettings.sslManagementType
        operator: equals
        expected: MANAGED
      - path: sslSettings.certificateId
        operator: exists
        expected: true
  - check_id: gcp.appengine.version.paas_app_artifact_encrypted
    title: Encrypt App Engine Version Artifacts at Rest
    severity: high
    for_each: list_appengine_versions
    logic: AND
    calls:
    - action: get_version_details
      fields:
      - path: deployment.files
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: deployment.cloudBuildOptions.appYamlPath
        operator: exists
        expected: true
    - action: get_storage_encryption_config
      fields:
      - path: deployment.zip.sourceUrl
        operator: contains
        expected: storage.googleapis.com
    - action: eval
      fields:
      - path: diskUsageBytes
        operator: exists
        expected: true
  - check_id: gcp.appengine.version.paas_app_immutable
    title: Ensure App Engine Versions Are Immutable
    severity: medium
    for_each: list_appengine_versions
    logic: AND
    calls:
    - action: get_version_details
      fields:
      - path: servingStatus
        operator: equals
        expected: SERVING
    - action: eval
      fields:
      - path: versionUrl
        operator: exists
        expected: true
    - action: eval
      fields:
      - path: createTime
        operator: exists
        expected: true
    - action: get_version_traffic_allocation
      fields:
      - path: split.allocations
        operator: exists
        expected: true
  api_name: appengine
  api_version: v1
