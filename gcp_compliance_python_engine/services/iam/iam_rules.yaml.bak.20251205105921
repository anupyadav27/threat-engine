iam:
  version: '1.0'
  provider: gcp
  service: iam
  scope: global
  sdk_package: google.cloud.iam_admin_v1
  client_class: IAMClient
  discovery:
  - discovery_id: list_iam_groups
    calls:
    - action: list_groups
      client_params:
        parent: organizations/{{organization_id}}
  - discovery_id: group_metadata
    for_each: list_iam_groups
    calls:
    - action: get_group
      params:
        name: '{{name}}'
    - action: get_iam_policy
      params:
        resource: '{{name}}'
  - discovery_id: list_iam_service_accounts
    calls:
    - action: list_service_accounts
      client_params:
        name: projects/{{project_id}}
  - discovery_id: service_account_metadata
    for_each: list_iam_service_accounts
    calls:
    - action: get_service_account
      params:
        name: '{{name}}'
    - action: list_service_account_keys
      params:
        name: '{{name}}'
  - discovery_id: list_iam_policies
    calls:
    - action: list_policies
      client_params:
        parent: projects/{{project_id}}
  - discovery_id: policy_metadata
    for_each: list_iam_policies
    calls:
    - action: get_policy
      params:
        name: '{{name}}'
    - action: get_iam_policy
      params:
        resource: '{{name}}'
  checks:
  - check_id: gcp.iam.group.has_users
    title: Ensure IAM Groups Contain Active Users
    severity: medium
    for_each: group_metadata
    logic: AND
    calls:
    - action: eval
      fields:
      - path: members
        operator: exists
      - path: members
        operator: not_equals
        expected: []
  - check_id: gcp.iam.group.identity_access_rbac_attached_policies_not_admin_star
    title: Restrict Admin Role in Group IAM Policies
    severity: high
    for_each: group_metadata
    logic: AND
    calls:
    - action: eval
      fields:
      - path: bindings[].role
        operator: not_contains
        expected: roles/owner
      - path: bindings[].role
        operator: not_contains
        expected: roles/editor
  - check_id: gcp.iam.group.identity_access_rbac_external_sharing_restricted_w_supported
    title: Restrict External Sharing of IAM Group Access
    severity: high
    for_each: group_metadata
    logic: AND
    calls:
    - action: eval
      fields:
      - path: bindings[].members[]
        operator: not_contains
        expected: allUsers
      - path: bindings[].members[]
        operator: not_contains
        expected: allAuthenticatedUsers
  - check_id: gcp.iam.group.identity_access_rbac_no_inline_policies
    title: Avoid Inline Policies for IAM Group Access Control
    severity: medium
    for_each: group_metadata
    logic: AND
    calls:
    - action: eval
      fields:
      - path: inlinePolicies
        operator: not_exists
  - check_id: gcp.iam.key.90_days
    title: Ensure IAM Keys Are Rotated Every 90 Days
    severity: high
    for_each: service_account_metadata
    logic: AND
    calls:
    - action: eval
      fields:
      - path: keys[].validAfterTime
        operator: exists
      - path: keys[].validAfterTime
        operator: less_than_days
        expected: 90
  - check_id: gcp.iam.key.access_key_90_days
    title: Rotate IAM Access Keys Every 90 Days
    severity: high
    for_each: service_account_metadata
    logic: AND
    calls:
    - action: eval
      fields:
      - path: keys[].keyType
        operator: equals
        expected: USER_MANAGED
      - path: keys[].validAfterTime
        operator: less_than_days
        expected: 90
  - check_id: gcp.iam.key.key_configured
    title: Ensure IAM Keys are Properly Configured
    severity: medium
    for_each: service_account_metadata
    logic: AND
    calls:
    - action: eval
      fields:
      - path: keys[].keyAlgorithm
        operator: exists
      - path: keys[].keyOrigin
        operator: equals
        expected: GOOGLE_PROVIDED
  - check_id: gcp.iam.policy.attached_only_to_group_or_roles
    title: Ensure IAM Policies Are Attached Only to Groups or Roles
    severity: medium
    for_each: policy_metadata
    logic: AND
    calls:
    - action: eval
      fields:
      - path: bindings[].members[]
        operator: not_contains
        expected: 'user:'
  - check_id: gcp.iam.policy.audit_config_enabled
    title: Ensure Audit Configuration is Enabled
    severity: high
    for_each: policy_metadata
    logic: AND
    calls:
    - action: eval
      fields:
      - path: auditConfigs[].service
        operator: contains
        expected: allServices
      - path: auditConfigs[].auditLogConfigs[].logType
        operator: contains
        expected: ADMIN_READ
