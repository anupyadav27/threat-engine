version: '1.0'
provider: aws
service: shield
discovery:
- discovery_id: aws.shield.describe_protection
  calls:
  - action: describe_protection
    save_as: describe_protection_response
  emit:
    items_for: '{{ describe_protection_response.Protection }}'
    as: resource
    item:
      id: '{{ resource.Id }}'
      name: '{{ resource.Name }}'
      resource_arn: '{{ resource.ResourceArn }}'
      health_check_ids: '{{ resource.HealthCheckIds }}'
      protection_arn: '{{ resource.ProtectionArn }}'
      application_layer_automatic_response_configuration: '{{ resource.ApplicationLayerAutomaticResponseConfiguration
        }}'
- discovery_id: aws.shield.describe_subscription
  calls:
  - action: describe_subscription
    save_as: describe_subscription_response
  emit:
    items_for: '{{ describe_subscription_response.Subscription }}'
    as: resource
    item:
      start_time: '{{ resource.StartTime }}'
      end_time: '{{ resource.EndTime }}'
      time_commitment_in_seconds: '{{ resource.TimeCommitmentInSeconds }}'
      auto_renew: '{{ resource.AutoRenew }}'
      limits: '{{ resource.Limits }}'
      proactive_engagement_status: '{{ resource.ProactiveEngagementStatus }}'
      subscription_limits: '{{ resource.SubscriptionLimits }}'
      subscription_arn: '{{ resource.SubscriptionArn }}'
checks:
- rule_id: aws.shield.subscription.shield_web_acl_attached_to_cdn_configured
  for_each: aws.shield.describe_protection
  conditions:
    var: item.resource_arn
    op: exists
- rule_id: aws.shield.subscription.shield_ip_rate_limit_rules_configured_if_supported
  for_each: aws.shield.describe_protection
  conditions:
    var: item.application_layer_automatic_response_configuration
    op: exists
- rule_id: aws.shield.subscription.shield_block_actions_not_count_only_configured
  for_each: aws.shield.describe_protection
  conditions:
    var: item.application_layer_automatic_response_configuration
    op: exists
- rule_id: aws.shield.protection.shield_managed_rule_sets_enabled
  for_each: aws.shield.describe_protection
  conditions:
    var: item.application_layer_automatic_response_configuration
    op: exists
- rule_id: aws.shield.subscription.shield_managed_rule_sets_enabled
  for_each: aws.shield.describe_subscription
  conditions:
    var: item.proactive_engagement_status
    op: equals
    value: ENABLED
- rule_id: aws.shield.protection.shield_block_actions_not_count_only_configured
  for_each: aws.shield.describe_protection
  conditions:
    var: item.application_layer_automatic_response_configuration
    op: exists
- rule_id: aws.shield.protection.shield_ip_rate_limit_rules_configured_if_supported
  for_each: aws.shield.describe_protection
  conditions:
    var: item.application_layer_automatic_response_configuration
    op: exists
- rule_id: aws.shield.subscription.logging_enabled
  for_each: aws.shield.describe_subscription
  conditions:
    var: item.proactive_engagement_status
    op: equals
    value: ENABLED
- rule_id: aws.shield.advanced.shield_protection_in_internet_facing_load_balancers_configured
  for_each: aws.shield.describe_protection
  conditions:
    all:
    - var: item.application_layer_automatic_response_configuration
      op: exists
    - var: item.resource_arn
      op: contains
      value: arn:aws:elasticloadbalancing
- rule_id: aws.shield.protection.shield_web_acl_attached_to_cdn_configured
  for_each: aws.shield.describe_protection
  conditions:
    var: item.resource_arn
    op: exists
- rule_id: aws.shield.protection.logging_enabled
  for_each: aws.shield.describe_subscription
  conditions:
    var: item.proactive_engagement_status
    op: equals
    value: ENABLED
