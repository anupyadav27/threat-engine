version: '1.0'
provider: aws
service: accessanalyzer
discovery:
- discovery_id: aws.accessanalyzer.list_analyzers
  calls:
  - action: list_analyzers
    save_as: list_analyzers_response
  emit:
    items_for: '{{ list_analyzers_response.analyzers }}'
    as: resource
    item:
      arn: '{{ resource.arn }}'
      name: '{{ resource.name }}'
      type: '{{ resource.type }}'
      created_at: '{{ resource.createdAt }}'
      last_resource_analyzed: '{{ resource.lastResourceAnalyzed }}'
      last_resource_analyzed_at: '{{ resource.lastResourceAnalyzedAt }}'
      tags: '{{ resource.tags }}'
      status: '{{ resource.status }}'
      status_reason: '{{ resource.statusReason }}'
      configuration: '{{ resource.configuration }}'
- discovery_id: aws.accessanalyzer.get_access_preview
  calls:
  - action: get_access_preview
    save_as: get_access_preview_response
    params:
      accessPreviewId: '{{ item.id }}'
      analyzerArn: '{{ item.arn }}'
    on_error: continue
  for_each: aws.accessanalyzer.list_analyzers
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      id: '{{ get_access_preview_response.accessPreview.id }}'
      analyzer_arn: '{{ get_access_preview_response.accessPreview.analyzerArn }}'
      configurations: '{{ get_access_preview_response.accessPreview.configurations
        }}'
      created_at: '{{ get_access_preview_response.accessPreview.createdAt }}'
      status: '{{ get_access_preview_response.accessPreview.status }}'
checks:
- rule_id: aws.accessanalyzer.resource.access_analyzer_enabled
  for_each: aws.accessanalyzer.list_analyzers
  conditions:
    var: item.status
    op: equals
    value: ACTIVE
- rule_id: aws.accessanalyzer.resource.access_analyzer_enabled_without_findings
  for_each: aws.accessanalyzer.get_access_preview
  conditions:
    all:
    - var: item.status
      op: equals
      value: ACTIVE
    - var: item.id
      op: equals
      value: []
