version: '1.0'
provider: aws
service: docdb
discovery:
- discovery_id: aws.docdb.describe_db_cluster_snapshots
  calls:
  - action: describe_db_cluster_snapshots
    save_as: describe_db_cluster_snapshots_response
  emit:
    items_for: '{{ describe_db_cluster_snapshots_response.DBClusterSnapshots }}'
    as: resource
    item:
      availability_zones: '{{ resource.AvailabilityZones }}'
      db_cluster_snapshot_identifier: '{{ resource.DBClusterSnapshotIdentifier }}'
      db_cluster_identifier: '{{ resource.DBClusterIdentifier }}'
      snapshot_create_time: '{{ resource.SnapshotCreateTime }}'
      engine: '{{ resource.Engine }}'
      status: '{{ resource.Status }}'
      port: '{{ resource.Port }}'
      vpc_id: '{{ resource.VpcId }}'
      cluster_create_time: '{{ resource.ClusterCreateTime }}'
      master_username: '{{ resource.MasterUsername }}'
- discovery_id: aws.docdb.describe_db_clusters
  calls:
  - action: describe_db_clusters
    save_as: describe_db_clusters_response
  emit:
    items_for: '{{ describe_db_clusters_response.DBClusters }}'
    as: resource
    item:
      availability_zones: '{{ resource.AvailabilityZones }}'
      backup_retention_period: '{{ resource.BackupRetentionPeriod }}'
      db_cluster_identifier: '{{ resource.DBClusterIdentifier }}'
      db_cluster_parameter_group: '{{ resource.DBClusterParameterGroup }}'
      db_subnet_group: '{{ resource.DBSubnetGroup }}'
      status: '{{ resource.Status }}'
      percent_progress: '{{ resource.PercentProgress }}'
      earliest_restorable_time: '{{ resource.EarliestRestorableTime }}'
      endpoint: '{{ resource.Endpoint }}'
      reader_endpoint: '{{ resource.ReaderEndpoint }}'
- discovery_id: aws.docdb.describe_db_engine_versions
  calls:
  - action: describe_db_engine_versions
    save_as: describe_db_engine_versions_response
  emit:
    items_for: '{{ describe_db_engine_versions_response.DBEngineVersions }}'
    as: resource
    item:
      engine: '{{ resource.Engine }}'
      engine_version: '{{ resource.EngineVersion }}'
      db_parameter_group_family: '{{ resource.DBParameterGroupFamily }}'
      db_engine_description: '{{ resource.DBEngineDescription }}'
      db_engine_version_description: '{{ resource.DBEngineVersionDescription }}'
      valid_upgrade_target: '{{ resource.ValidUpgradeTarget }}'
      exportable_log_types: '{{ resource.ExportableLogTypes }}'
      supports_log_exports_to_cloudwatch_logs: '{{ resource.SupportsLogExportsToCloudwatchLogs
        }}'
      supported_ca_certificate_identifiers: '{{ resource.SupportedCACertificateIdentifiers
        }}'
      supports_certificate_rotation_without_restart: '{{ resource.SupportsCertificateRotationWithoutRestart
        }}'
- discovery_id: aws.docdb.describe_db_instances
  calls:
  - action: describe_db_instances
    save_as: describe_db_instances_response
  emit:
    items_for: '{{ describe_db_instances_response.DBInstances }}'
    as: resource
    item:
      db_instance_identifier: '{{ resource.DBInstanceIdentifier }}'
      db_instance_class: '{{ resource.DBInstanceClass }}'
      engine: '{{ resource.Engine }}'
      db_instance_status: '{{ resource.DBInstanceStatus }}'
      endpoint: '{{ resource.Endpoint }}'
      instance_create_time: '{{ resource.InstanceCreateTime }}'
      preferred_backup_window: '{{ resource.PreferredBackupWindow }}'
      backup_retention_period: '{{ resource.BackupRetentionPeriod }}'
      vpc_security_groups: '{{ resource.VpcSecurityGroups }}'
      availability_zone: '{{ resource.AvailabilityZone }}'
checks:
- rule_id: aws.docdb.cluster.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.docdb.describe_db_cluster_snapshots
  conditions:
    all:
    - var: item.engine
      op: equals
      value: docdb
    - var: item.engine_version
      op: gte
      value: '3.6'
- rule_id: aws.docdb.instance.require_tls_in_transit_configured
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.db_cluster_parameter_group
    op: contains
    value: rds.force_ssl
- rule_id: aws.docdb.cluster.public_access_disabled
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.vpc_security_groups
    op: equals
    value: []
- rule_id: aws.docdb.cluster.docdb_minor_version_auto_upgrade_enabled
  for_each: aws.docdb.describe_db_cluster_snapshots
  conditions:
    var: item.engine_version
    op: exists
- rule_id: aws.docdb.instance.encryption_at_rest_enabled
  for_each: aws.docdb.describe_db_cluster_snapshots
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.docdb.cluster.encryption_in_transit_enabled
  for_each: aws.docdb.describe_db_cluster_snapshots
  conditions:
    var: item.engine_version
    op: gte
    value: '3.6'
- rule_id: aws.docdb.cluster.audit_logging_to_cloudwatch_enabled
  for_each: aws.docdb.describe_db_engine_versions
  conditions:
    var: item.supports_log_exports_to_cloudwatch_logs
    op: equals
    value: true
- rule_id: aws.docdb.cluster.preferred_backup_window_configured
  for_each: aws.docdb.describe_db_clusters
  conditions:
    all:
    - var: item.backup_retention_period
      op: gt
      value: 0
    - var: item.preferred_backup_window
      op: exists
- rule_id: aws.docdb.cluster.docdb_cloudwatch_log_export_configured
  for_each: aws.docdb.describe_db_engine_versions
  conditions:
    var: item.supports_log_exports_to_cloudwatch_logs
    op: equals
    value: true
- rule_id: aws.docdb.resource.vpc_security_configuration_configured
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.vpc_security_groups
    op: exists
- rule_id: aws.docdb.instance.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.docdb.describe_db_instances
  conditions:
    all:
    - var: item.engine
      op: equals
      value: docdb
    - var: item.db_instance_status
      op: equals
      value: available
- rule_id: aws.docdb.cluster.encryption_at_rest_enabled
  for_each: aws.docdb.describe_db_cluster_snapshots
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.docdb.cluster.docdb_storage_encrypted
  for_each: aws.docdb.describe_db_cluster_snapshots
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.docdb.cluster.docdb_engine_version_configured
  for_each: aws.docdb.describe_db_cluster_snapshots
  conditions:
    var: item.engine_version
    op: equals
    value: 3.6.0
- rule_id: aws.docdb.instance.public_access_disabled
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.vpc_security_groups
    op: equals
    value: []
- rule_id: aws.docdb.cluster.encryption_at_rest_cmek_configured
  for_each: aws.docdb.describe_db_cluster_snapshots
  conditions:
    all:
    - var: item.storage_encrypted
      op: equals
      value: true
    - var: item.kms_key_id
      op: exists
- rule_id: aws.docdb.cluster.backup_retention_period_configured
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.backup_retention_period
    op: gt
    value: 0
- rule_id: aws.docdb.cluster.audit_logging_enabled
  for_each: aws.docdb.describe_db_engine_versions
  conditions:
    var: item.supports_log_exports_to_cloudwatch_logs
    op: equals
    value: true
- rule_id: aws.docdb.instance.deletion_protection_enabled
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.deletion_protection
    op: equals
    value: true
- rule_id: aws.docdb.cluster.docdb_multi_az_enabled
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.multi_az
    op: equals
    value: true
- rule_id: aws.docdb.cluster.deletion_protection_enabled
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.deletion_protection
    op: equals
    value: true
- rule_id: aws.docdb.cluster.require_tls_in_transit_configured
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.db_cluster_parameter_group
    op: contains
    value: rds.force_ssl
- rule_id: aws.docdb.cluster.private_networking_enforced
  for_each: aws.docdb.describe_db_clusters
  conditions:
    all:
    - var: item.db_subnet_group
      op: exists
    - var: item.vpc_security_groups
      op: exists
