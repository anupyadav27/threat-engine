version: '1.0'
provider: aws
service: sns
discovery:
- discovery_id: aws.sns.list_subscriptions
  calls:
  - action: list_subscriptions
    save_as: list_subscriptions_response
  emit:
    items_for: '{{ list_subscriptions_response.Subscriptions }}'
    as: resource
    item:
      subscription_arn: '{{ resource.SubscriptionArn }}'
      owner: '{{ resource.Owner }}'
      protocol: '{{ resource.Protocol }}'
      endpoint: '{{ resource.Endpoint }}'
      topic_arn: '{{ resource.TopicArn }}'
- discovery_id: aws.sns.list_origination_numbers
  calls:
  - action: list_origination_numbers
    save_as: list_origination_numbers_response
  emit:
    items_for: '{{ list_origination_numbers_response.PhoneNumbers }}'
    as: resource
    item:
      created_at: '{{ resource.CreatedAt }}'
      phone_number: '{{ resource.PhoneNumber }}'
      status: '{{ resource.Status }}'
      iso2_country_code: '{{ resource.Iso2CountryCode }}'
      route_type: '{{ resource.RouteType }}'
      number_capabilities: '{{ resource.NumberCapabilities }}'
- discovery_id: aws.sns.list_platform_applications
  calls:
  - action: list_platform_applications
    save_as: list_platform_applications_response
  emit:
    items_for: '{{ list_platform_applications_response.PlatformApplications }}'
    as: resource
    item:
      platform_application_arn: '{{ resource.PlatformApplicationArn }}'
      attributes: '{{ resource.Attributes }}'
checks:
- rule_id: aws.sns.topic.destinations_configured
  for_each: aws.sns.list_subscriptions
  conditions:
    all:
    - var: item.subscription_arn
      op: exists
    - var: item.protocol
      op: equals
      value:
      - HTTPS
      - SQS
      - Lambda
- rule_id: aws.sns.resource.topics_kms_encryption_at_rest_enabled
  for_each: aws.sns.list_subscriptions
  conditions:
    var: item.topic_arn
    op: exists
- rule_id: aws.sns.topic.no_public_webhooks_without_auth_configured
  for_each: aws.sns.list_subscriptions
  conditions:
    all:
    - var: item.protocol
      op: equals
      value: http
    - var: item.endpoint
      op: contains
      value: auth
- rule_id: aws.sns.subscription.no_public_webhooks_configured
  for_each: aws.sns.list_subscriptions
  conditions:
    all:
    - var: item.protocol
      op: equals
      value: https
    - var: item.endpoint
      op: contains
      value: public
- rule_id: aws.sns.subscription.oncall_contacts_verified
  for_each: aws.sns.list_origination_numbers
  conditions:
    var: item.status
    op: equals
    value: ACTIVE
- rule_id: aws.sns.topic.endpoints_authenticated_configured
  for_each: aws.sns.list_subscriptions
  conditions:
    all:
    - var: item.protocol
      op: equals
      value: https
    - var: item.endpoint
      op: exists
- rule_id: aws.sns.subscription.sns_subscription_destinations_configured
  for_each: aws.sns.list_subscriptions
  conditions:
    all:
    - var: item.protocol
      op: equals
      value:
      - HTTPS
      - Email
      - SQS
    - var: item.endpoint
      op: exists
- rule_id: aws.sns.topic.destinations_authenticated_configured
  for_each: aws.sns.list_subscriptions
  conditions:
    all:
    - var: item.protocol
      op: equals
      value: HTTPS
    - var: item.endpoint
      op: exists
- rule_id: aws.sns.subscription.endpoints_authenticated_configured
  for_each: aws.sns.list_subscriptions
  conditions:
    all:
    - var: item.protocol
      op: equals
      value: https
    - var: item.endpoint
      op: exists
- rule_id: aws.sns.subscription.change_audit_logging_enabled
  for_each: aws.sns.list_subscriptions
  conditions:
    var: item.subscription_arn
    op: exists
- rule_id: aws.sns.subscription.message_encryption_in_transit_configured
  for_each: aws.sns.list_subscriptions
  conditions:
    var: item.protocol
    op: equals
    value: https
- rule_id: aws.sns.subscription.policy_exists_for_critical_severity_configured
  for_each: aws.sns.list_subscriptions
  conditions:
    var: item.subscription_arn
    op: exists
- rule_id: aws.sns.topic.change_audit_logging_enabled
  for_each: aws.sns.list_platform_applications
  conditions:
    var: item.attributes
    op: contains
    value: LoggingEnabled
- rule_id: aws.sns.topic.critical_alarms_enabled
  for_each: aws.sns.list_origination_numbers
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.sns.topic.oncall_contacts_verified
  for_each: aws.sns.list_origination_numbers
  conditions:
    var: item.status
    op: equals
    value: ACTIVE
- rule_id: aws.sns.topics.kms_encryption_at_rest_enabled
  for_each: aws.sns.list_platform_applications
  conditions:
    var: item.attributes
    op: contains
    value: KmsMasterKeyId
- rule_id: aws.sns.topic.no_public_webhooks_configured
  for_each: aws.sns.list_subscriptions
  conditions:
    any:
    - var: item.protocol
      op: equals
      value: http
    - var: item.protocol
      op: equals
      value: https
- rule_id: aws.sns.topic.channels_configured
  for_each: aws.sns.list_subscriptions
  conditions:
    all:
    - var: item.subscription_arn
      op: exists
    - var: item.protocol
      op: contains
      value:
      - https
      - email
      - sms
- rule_id: aws.sns.topic.message_encryption_in_transit_configured
  for_each: aws.sns.list_subscriptions
  conditions:
    var: item.protocol
    op: equals
    value: https
- rule_id: aws.sns.topic.alarm_actions_configured
  for_each: aws.sns.list_subscriptions
  conditions:
    var: item.subscription_arn
    op: exists
