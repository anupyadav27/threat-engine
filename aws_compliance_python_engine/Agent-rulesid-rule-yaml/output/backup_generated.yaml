version: '1.0'
provider: aws
service: backup
discovery:
- discovery_id: aws.backup.list_backup_job_summaries
  calls:
  - action: list_backup_job_summaries
    save_as: list_backup_job_summaries_response
  emit:
    items_for: '{{ list_backup_job_summaries_response.BackupJobSummaries }}'
    as: resource
    item:
      region: '{{ resource.Region }}'
      account_id: '{{ resource.AccountId }}'
      state: '{{ resource.State }}'
      resource_type: '{{ resource.ResourceType }}'
      message_category: '{{ resource.MessageCategory }}'
      count: '{{ resource.Count }}'
      start_time: '{{ resource.StartTime }}'
      end_time: '{{ resource.EndTime }}'
- discovery_id: aws.backup.list_backup_jobs
  calls:
  - action: list_backup_jobs
    save_as: list_backup_jobs_response
  emit:
    items_for: '{{ list_backup_jobs_response.BackupJobs }}'
    as: resource
    item:
      account_id: '{{ resource.AccountId }}'
      backup_job_id: '{{ resource.BackupJobId }}'
      backup_vault_name: '{{ resource.BackupVaultName }}'
      backup_vault_arn: '{{ resource.BackupVaultArn }}'
      vault_type: '{{ resource.VaultType }}'
      vault_lock_state: '{{ resource.VaultLockState }}'
      recovery_point_arn: '{{ resource.RecoveryPointArn }}'
      recovery_point_lifecycle: '{{ resource.RecoveryPointLifecycle }}'
      encryption_key_arn: '{{ resource.EncryptionKeyArn }}'
      is_encrypted: '{{ resource.IsEncrypted }}'
- discovery_id: aws.backup.list_backup_plans
  calls:
  - action: list_backup_plans
    save_as: list_backup_plans_response
  emit:
    items_for: '{{ list_backup_plans_response.BackupPlansList }}'
    as: resource
    item:
      backup_plan_arn: '{{ resource.BackupPlanArn }}'
      backup_plan_id: '{{ resource.BackupPlanId }}'
      creation_date: '{{ resource.CreationDate }}'
      deletion_date: '{{ resource.DeletionDate }}'
      version_id: '{{ resource.VersionId }}'
      backup_plan_name: '{{ resource.BackupPlanName }}'
      creator_request_id: '{{ resource.CreatorRequestId }}'
      last_execution_date: '{{ resource.LastExecutionDate }}'
      advanced_backup_settings: '{{ resource.AdvancedBackupSettings }}'
- discovery_id: aws.backup.list_backup_vaults
  calls:
  - action: list_backup_vaults
    save_as: list_backup_vaults_response
  emit:
    items_for: '{{ list_backup_vaults_response.BackupVaultList }}'
    as: resource
    item:
      backup_vault_name: '{{ resource.BackupVaultName }}'
      backup_vault_arn: '{{ resource.BackupVaultArn }}'
      vault_type: '{{ resource.VaultType }}'
      vault_state: '{{ resource.VaultState }}'
      creation_date: '{{ resource.CreationDate }}'
      encryption_key_arn: '{{ resource.EncryptionKeyArn }}'
      creator_request_id: '{{ resource.CreatorRequestId }}'
      number_of_recovery_points: '{{ resource.NumberOfRecoveryPoints }}'
      locked: '{{ resource.Locked }}'
      min_retention_days: '{{ resource.MinRetentionDays }}'
- discovery_id: aws.backup.list_report_jobs
  calls:
  - action: list_report_jobs
    save_as: list_report_jobs_response
  emit:
    items_for: '{{ list_report_jobs_response.ReportJobs }}'
    as: resource
    item:
      report_job_id: '{{ resource.ReportJobId }}'
      report_plan_arn: '{{ resource.ReportPlanArn }}'
      report_template: '{{ resource.ReportTemplate }}'
      creation_time: '{{ resource.CreationTime }}'
      completion_time: '{{ resource.CompletionTime }}'
      status: '{{ resource.Status }}'
      status_message: '{{ resource.StatusMessage }}'
      report_destination: '{{ resource.ReportDestination }}'
- discovery_id: aws.backup.list_restore_jobs
  calls:
  - action: list_restore_jobs
    save_as: list_restore_jobs_response
  emit:
    items_for: '{{ list_restore_jobs_response.RestoreJobs }}'
    as: resource
    item:
      account_id: '{{ resource.AccountId }}'
      restore_job_id: '{{ resource.RestoreJobId }}'
      recovery_point_arn: '{{ resource.RecoveryPointArn }}'
      source_resource_arn: '{{ resource.SourceResourceArn }}'
      backup_vault_arn: '{{ resource.BackupVaultArn }}'
      creation_date: '{{ resource.CreationDate }}'
      completion_date: '{{ resource.CompletionDate }}'
      status: '{{ resource.Status }}'
      status_message: '{{ resource.StatusMessage }}'
      percent_done: '{{ resource.PercentDone }}'
- discovery_id: aws.backup.list_recovery_points_by_backup_vault
  calls:
  - action: list_recovery_points_by_backup_vault
    save_as: list_recovery_points_by_backup_vault_response
    params:
      BackupVaultName: '{{ item.backup_vault_name }}'
    on_error: continue
  for_each: aws.backup.list_backup_jobs
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      recovery_point_arn: '{{ list_recovery_points_by_backup_vault_response.RecoveryPoints.RecoveryPointArn
        }}'
      backup_vault_name: '{{ list_recovery_points_by_backup_vault_response.RecoveryPoints.BackupVaultName
        }}'
      backup_vault_arn: '{{ list_recovery_points_by_backup_vault_response.RecoveryPoints.BackupVaultArn
        }}'
      source_backup_vault_arn: '{{ list_recovery_points_by_backup_vault_response.RecoveryPoints.SourceBackupVaultArn
        }}'
      resource_arn: '{{ list_recovery_points_by_backup_vault_response.RecoveryPoints.ResourceArn
        }}'
- discovery_id: aws.backup.describe_backup_vault
  calls:
  - action: describe_backup_vault
    save_as: describe_backup_vault_response
    params:
      BackupVaultName: '{{ item.backup_vault_name }}'
    on_error: continue
  for_each: aws.backup.list_backup_jobs
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      mpa_session_arn: '{{ describe_backup_vault_response.LatestMpaApprovalTeamUpdate.MpaSessionArn
        }}'
      status: '{{ describe_backup_vault_response.LatestMpaApprovalTeamUpdate.Status
        }}'
      status_message: '{{ describe_backup_vault_response.LatestMpaApprovalTeamUpdate.StatusMessage
        }}'
      initiation_date: '{{ describe_backup_vault_response.LatestMpaApprovalTeamUpdate.InitiationDate
        }}'
      expiry_date: '{{ describe_backup_vault_response.LatestMpaApprovalTeamUpdate.ExpiryDate
        }}'
checks:
- rule_id: aws.backup.backupplan.failed_jobs_alerting_enabled
  for_each: aws.backup.list_backup_job_summaries
  conditions:
    var: item.state
    op: equals
    value: FAILED
- rule_id: aws.backup.restorejob.role_least_privilege
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.iam_role_arn
    op: exists
- rule_id: aws.backup.resource.vault_encryption_enabled
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.is_encrypted
    op: equals
    value: true
- rule_id: aws.backup.restorejob.backup_logs_and_artifacts_encrypted
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.is_encrypted
    op: equals
    value: true
- rule_id: aws.backup.backupplan.lag_monitoring_alerts_enabled
  for_each: aws.backup.list_backup_plans
  conditions:
    var: item.advanced_backup_settings
    op: exists
- rule_id: aws.backup.backupplan.backup_keys_access_least_privilege
  for_each: aws.backup.list_backup_jobs
  conditions:
    all:
    - var: item.is_encrypted
      op: equals
      value: true
    - var: item.encryption_key_arn
      op: exists
    - var: item.iam_role_arn
      op: exists
- rule_id: aws.backup.backupplan.backup_cross_region_replication_encrypted
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.is_encrypted
    op: equals
    value: true
- rule_id: aws.backup.recoverypoint.encryption_at_rest_cmek_if_supported
  for_each: aws.backup.list_recovery_points_by_backup_vault
  conditions:
    all:
    - var: item.is_encrypted
      op: equals
      value: true
    - var: item.encryption_key_type
      op: contains
      value:
      - AWS_KMS
      - CUSTOMER_MANAGED
- rule_id: aws.backup.backupvault.backup_vaults_exist_configured
  for_each: aws.backup.list_backup_vaults
  conditions:
    all:
    - var: item.min_retention_days
      op: gte
      value: 30
    - var: item.max_retention_days
      op: lte
      value: 365
    - var: item.locked
      op: equals
      value: true
- rule_id: aws.backup.recoverypoint.backup_point_encrypted
  for_each: aws.backup.list_backup_jobs
  conditions:
    all:
    - var: item.is_encrypted
      op: equals
      value: true
    - var: item.recovery_point_lifecycle
      op: exists
- rule_id: aws.backup.backupvault.backup_schedule_defined_min_frequency_configured
  for_each: aws.backup.list_backup_vaults
  conditions:
    all:
    - var: item.min_retention_days
      op: gte
      value: 1
    - var: item.max_retention_days
      op: gte
      value: 1
- rule_id: aws.backup.restorejob.from_encrypted_backups_only
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.is_encrypted
    op: equals
    value: true
- rule_id: aws.backup.backupvault.backup_vault_configured
  for_each: aws.backup.list_backup_vaults
  conditions:
    all:
    - var: item.min_retention_days
      op: gt
      value: 0
    - var: item.max_retention_days
      op: gt
      value: 0
    - var: item.locked
      op: equals
      value: true
- rule_id: aws.backup.backupplan.backup_vault_rbac_least_privilege
  for_each: aws.backup.list_backup_vaults
  conditions:
    all:
    - var: item.locked
      op: equals
      value: true
    - var: item.min_retention_days
      op: gte
      value: 1
    - var: item.max_retention_days
      op: gte
      value: 1
- rule_id: aws.backup.backupplan.backup_retention_minimum_configured
  for_each: aws.backup.list_backup_vaults
  conditions:
    var: item.min_retention_days
    op: gte
    value: 1
- rule_id: aws.backup.backupjob.alert_destinations_configured
  for_each: aws.backup.list_report_jobs
  conditions:
    var: item.report_destination
    op: exists
- rule_id: aws.backup.backupjob.alerts_for_rpo_rto_breach_configured
  for_each: aws.backup.list_backup_jobs
  conditions:
    all:
    - var: item.state
      op: equals
      value: COMPLETED
    - var: item.status_message
      op: exists
- rule_id: aws.backup.backupvault.key_rotation_enabled
  for_each: aws.backup.list_backup_vaults
  conditions:
    var: item.encryption_key_type
    op: equals
    value: ENABLED
- rule_id: aws.backup.backupplan.last_backup_recency_within_days
  for_each: aws.backup.list_backup_plans
  conditions:
    all:
    - var: item.last_execution_date
      op: exists
    - var: item.creation_date
      op: exists
- rule_id: aws.backup.backupjob.logging_enabled
  for_each: aws.backup.list_backup_jobs
  conditions:
    all:
    - var: item.state
      op: equals
      value: COMPLETED
    - var: item.status_message
      op: exists
- rule_id: aws.backup.backupjob.alerts_for_replication_lag_configured
  for_each: aws.backup.list_backup_jobs
  conditions:
    all:
    - var: item.state
      op: equals
      value: COMPLETED
    - var: item.status_message
      op: exists
- rule_id: aws.backup.backupjob.role_least_privilege
  for_each: aws.backup.list_backup_jobs
  conditions:
    all:
    - var: item.state
      op: equals
      value: COMPLETED
    - var: item.iam_role_arn
      op: exists
- rule_id: aws.backup.backupplan.no_public_access_to_backup_vault_configured
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.vault_lock_state
    op: equals
    value: LOCKED
- rule_id: aws.backup.resource.backup_vaults_encrypted
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.is_encrypted
    op: equals
    value: true
- rule_id: aws.backup.backupvault.backup_cross_region_replication_enabled
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.vault_type
    op: equals
    value: CROSS_REGION
- rule_id: aws.backup.backupplan.unprotected_assets_alerting_enabled
  for_each: aws.backup.list_backup_plans
  conditions:
    var: item.advanced_backup_settings
    op: exists
- rule_id: aws.backup.backupplan.backup_storage_encrypted_and_private
  for_each: aws.backup.list_backup_jobs
  conditions:
    all:
    - var: item.is_encrypted
      op: equals
      value: true
    - var: item.vault_lock_state
      op: equals
      value: LOCKED
- rule_id: aws.backup.backupplan.backup_admins_mfa_required
  for_each: aws.backup.describe_backup_vault
  conditions:
    var: item.mpa_session_arn
    op: exists
- rule_id: aws.backup.resource.backup_recovery_point_encrypted
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.is_encrypted
    op: equals
    value: true
- rule_id: aws.backup.backupjob.alert_rules_for_job_failures_configured
  for_each: aws.backup.list_backup_jobs
  conditions:
    all:
    - var: item.state
      op: equals
      value: COMPLETED
    - var: item.status_message
      op: exists
- rule_id: aws.backup.recoverypoint.private_network_only_configured
  for_each: aws.backup.list_recovery_points_by_backup_vault
  conditions:
    all:
    - var: item.status
      op: equals
      value: ACTIVE
    - var: item.vault_type
      op: equals
      value: PRIVATE
- rule_id: aws.backup.backupjob.alert_rules_for_sla_breach_configured
  for_each: aws.backup.list_backup_jobs
  conditions:
    all:
    - var: item.state
      op: equals
      value: COMPLETED
    - var: item.status_message
      op: exists
- rule_id: aws.backup.recoverypoint.backup_volumes_encrypted
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.is_encrypted
    op: equals
    value: true
- rule_id: aws.backup.backupplan.policy_assignment_complete
  for_each: aws.backup.list_backup_plans
  conditions:
    var: item.advanced_backup_settings
    op: exists
- rule_id: aws.backup.backupplan.retention_days_minimum
  for_each: aws.backup.list_backup_vaults
  conditions:
    var: item.min_retention_days
    op: gte
    value: 1
- rule_id: aws.backup.restorejob.cross_account_restore_blocked_by_policy_configured
  for_each: aws.backup.list_restore_jobs
  conditions:
    all:
    - var: item.status
      op: equals
      value: COMPLETED
    - var: item.iam_role_arn
      op: exists
- rule_id: aws.backup.backupvault.encryption_at_rest_enabled
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.is_encrypted
    op: equals
    value: true
- rule_id: aws.backup.backupvault.key_policy_least_privilege
  for_each: aws.backup.list_backup_jobs
  conditions:
    all:
    - var: item.vault_lock_state
      op: equals
      value: LOCKED
    - var: item.encryption_key_arn
      op: exists
    - var: item.vault_type
      op: equals
      value: STANDARD
- rule_id: aws.backup.backupplan.auth_roles_least_privilege
  for_each: aws.backup.list_backup_jobs
  conditions:
    all:
    - var: item.vault_lock_state
      op: equals
      value: LOCKED
    - var: item.is_encrypted
      op: equals
      value: true
    - var: item.iam_role_arn
      op: exists
- rule_id: aws.backup.recoverypoint.agent_to_service_tls_required
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.is_encrypted
    op: equals
    value: true
- rule_id: aws.backup.resource.encryption_enabled
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.is_encrypted
    op: equals
    value: true
- rule_id: aws.backup.backupvault.encryption_in_transit_tls_min_1_2_configured
  for_each: aws.backup.list_backup_vaults
  conditions:
    var: item.encryption_key_type
    op: equals
    value: KMS
- rule_id: aws.backup.backupjob.execution_roles_least_privilege
  for_each: aws.backup.list_backup_jobs
  conditions:
    all:
    - var: item.iam_role_arn
      op: exists
    - var: item.iam_role_arn
      op: equals
      value: arn:aws:iam::aws:policy/service-role/AWSBackupServiceRolePolicyForBackup
- rule_id: aws.backup.backupvault.cmk_cmek_key_configured
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.encryption_key_arn
    op: exists
- rule_id: aws.backup.backupjob.network_private_only_configured
  for_each: aws.backup.list_backup_job_summaries
  conditions:
    all:
    - var: item.state
      op: equals
      value: COMPLETED
    - var: item.resource_type
      op: equals
      value: AWS::EC2::Subnet
- rule_id: aws.backup.backupjob.backup_results_storage_encrypted_and_private
  for_each: aws.backup.list_backup_jobs
  conditions:
    all:
    - var: item.is_encrypted
      op: equals
      value: true
    - var: item.vault_lock_state
      op: equals
      value: LOCKED
- rule_id: aws.backup.backupplan.encryption_in_transit_tls_required
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.is_encrypted
    op: equals
    value: true
