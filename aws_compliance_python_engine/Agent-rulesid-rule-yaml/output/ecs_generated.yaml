version: '1.0'
provider: aws
service: ecs
discovery:
- discovery_id: aws.ecs.register_container_instance
  calls:
  - action: register_container_instance
    save_as: register_container_instance_response
  emit:
    items_for: '{{ register_container_instance_response.containerInstance }}'
    as: resource
    item:
      container_instance_arn: '{{ resource.containerInstanceArn }}'
      ec2_instance_id: '{{ resource.ec2InstanceId }}'
      capacity_provider_name: '{{ resource.capacityProviderName }}'
      version: '{{ resource.version }}'
      version_info: '{{ resource.versionInfo }}'
      remaining_resources: '{{ resource.remainingResources }}'
      registered_resources: '{{ resource.registeredResources }}'
      status: '{{ resource.status }}'
      status_reason: '{{ resource.statusReason }}'
      agent_connected: '{{ resource.agentConnected }}'
- discovery_id: aws.ecs.create_cluster
  calls:
  - action: create_cluster
    save_as: create_cluster_response
  emit:
    items_for: '{{ create_cluster_response.cluster }}'
    as: resource
    item:
      cluster_arn: '{{ resource.clusterArn }}'
      cluster_name: '{{ resource.clusterName }}'
      configuration: '{{ resource.configuration }}'
      status: '{{ resource.status }}'
      registered_container_instances_count: '{{ resource.registeredContainerInstancesCount
        }}'
      running_tasks_count: '{{ resource.runningTasksCount }}'
      pending_tasks_count: '{{ resource.pendingTasksCount }}'
      active_services_count: '{{ resource.activeServicesCount }}'
      statistics: '{{ resource.statistics }}'
      tags: '{{ resource.tags }}'
- discovery_id: aws.ecs.create_service
  calls:
  - action: create_service
    save_as: create_service_response
    params:
      serviceName: '{{ item.id }}'
    on_error: continue
  for_each: aws.ecs.register_container_instance
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      service_arn: '{{ create_service_response.service.serviceArn }}'
      service_name: '{{ create_service_response.service.serviceName }}'
      cluster_arn: '{{ create_service_response.service.clusterArn }}'
      load_balancers: '{{ create_service_response.service.loadBalancers }}'
      service_registries: '{{ create_service_response.service.serviceRegistries }}'
checks:
- rule_id: aws.ecs.container_instance.container_read_only_root_filesystem_configured
  for_each: aws.ecs.register_container_instance
  conditions:
    var: item.attributes
    op: contains
    value:
      name: ecs.capability.docker.readonlyRootFilesystem
      value: 'true'
- rule_id: aws.ecs.container_instance.no_privileged_containers_configured
  for_each: aws.ecs.register_container_instance
  conditions:
    var: item.attributes
    op: contains
    value:
      name: ecs.capability.privileged-container
      value: 'false'
- rule_id: aws.ecs.task_definition_image_source_verification.task_ecs_task_definition_image_source_verification_configured
  for_each: aws.ecs.create_cluster
  conditions:
    var: item.status
    op: equals
    value: ACTIVE
- rule_id: aws.ecs.resource.task_sets_assign_public_ip_disabled
  for_each: aws.ecs.create_service
  conditions:
    var: item.launch_type
    op: equals
    value: FARGATE
- rule_id: aws.ecs.resource.task_definition_logging_enabled
  for_each: aws.ecs.create_service
  conditions:
    var: item.enable_execute_command
    op: equals
    value: true
- rule_id: aws.ecs.container_instance.container_env_no_plaintext_secrets_configured
  for_each: aws.ecs.register_container_instance
  conditions:
    var: item.attributes
    op: exists
- rule_id: aws.ecs.task_definitions_logging_block_mode.task_definitions_logging_block_mode_configured
  for_each: aws.ecs.create_cluster
  conditions:
    var: item.status
    op: equals
    value: ACTIVE
- rule_id: aws.ecs.resource.task_definitions_logging_enabled
  for_each: aws.ecs.create_service
  conditions:
    var: item.enable_execute_command
    op: equals
    value: true
