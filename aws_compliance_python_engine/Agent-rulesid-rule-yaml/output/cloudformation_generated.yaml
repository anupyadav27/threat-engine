version: '1.0'
provider: aws
service: cloudformation
discovery:
- discovery_id: aws.cloudformation.describe_stacks
  calls:
  - action: describe_stacks
    save_as: describe_stacks_response
  emit:
    items_for: '{{ describe_stacks_response.Stacks }}'
    as: resource
    item:
      stack_id: '{{ resource.StackId }}'
      stack_name: '{{ resource.StackName }}'
      change_set_id: '{{ resource.ChangeSetId }}'
      description: '{{ resource.Description }}'
      parameters: '{{ resource.Parameters }}'
      creation_time: '{{ resource.CreationTime }}'
      deletion_time: '{{ resource.DeletionTime }}'
      last_updated_time: '{{ resource.LastUpdatedTime }}'
      rollback_configuration: '{{ resource.RollbackConfiguration }}'
      stack_status: '{{ resource.StackStatus }}'
checks:
- rule_id: aws.cloudformation.stack.cloudformation_approvals_required_for_changes
  for_each: aws.cloudformation.describe_stacks
  conditions:
    var: item.stack_status
    op: equals
    value: REVIEW_IN_PROGRESS
- rule_id: aws.cloudformation.stack.cloudformation_storage_encrypted_and_private
  for_each: aws.cloudformation.describe_stacks
  conditions:
    all:
    - var: item.stack_status
      op: equals
      value: CREATE_COMPLETE
    - var: item.capabilities
      op: contains
      value: CAPABILITY_AUTO_EXPAND
- rule_id: aws.cloudformation.stack.change_audit_logging_enabled
  for_each: aws.cloudformation.describe_stacks
  conditions:
    var: item.stack_status
    op: equals
    value: ENABLED
