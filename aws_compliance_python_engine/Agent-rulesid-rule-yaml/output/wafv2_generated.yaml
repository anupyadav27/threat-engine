version: '1.0'
provider: aws
service: wafv2
discovery:
- discovery_id: aws.wafv2.get_rule_group
  calls:
  - action: get_rule_group
    save_as: get_rule_group_response
  emit:
    items_for: '{{ get_rule_group_response.RuleGroup }}'
    as: resource
    item:
      name: '{{ resource.Name }}'
      id: '{{ resource.Id }}'
      capacity: '{{ resource.Capacity }}'
      arn: '{{ resource.ARN }}'
      description: '{{ resource.Description }}'
      rules: '{{ resource.Rules }}'
      visibility_config: '{{ resource.VisibilityConfig }}'
      label_namespace: '{{ resource.LabelNamespace }}'
      custom_response_bodies: '{{ resource.CustomResponseBodies }}'
      available_labels: '{{ resource.AvailableLabels }}'
- discovery_id: aws.wafv2.get_web_acl
  calls:
  - action: get_web_acl
    save_as: get_web_acl_response
  emit:
    items_for: '{{ get_web_acl_response.WebACL }}'
    as: resource
    item:
      name: '{{ resource.Name }}'
      id: '{{ resource.Id }}'
      arn: '{{ resource.ARN }}'
      default_action: '{{ resource.DefaultAction }}'
      description: '{{ resource.Description }}'
      rules: '{{ resource.Rules }}'
      visibility_config: '{{ resource.VisibilityConfig }}'
      data_protection_config: '{{ resource.DataProtectionConfig }}'
      capacity: '{{ resource.Capacity }}'
      pre_process_firewall_manager_rule_groups: '{{ resource.PreProcessFirewallManagerRuleGroups
        }}'
- discovery_id: aws.wafv2.get_ip_set
  calls:
  - action: get_ip_set
    save_as: get_ip_set_response
    params:
      Name: '{{ item.name }}'
      Scope: '{{ item.id }}'
      Id: '{{ item.id }}'
    on_error: continue
  for_each: aws.wafv2.get_rule_group
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      name: '{{ get_ip_set_response.IPSet.Name }}'
      id: '{{ get_ip_set_response.IPSet.Id }}'
      arn: '{{ get_ip_set_response.IPSet.ARN }}'
      description: '{{ get_ip_set_response.IPSet.Description }}'
      ip_address_version: '{{ get_ip_set_response.IPSet.IPAddressVersion }}'
- discovery_id: aws.wafv2.get_logging_configuration
  calls:
  - action: get_logging_configuration
    save_as: get_logging_configuration_response
    params:
      ResourceArn: '{{ item.arn }}'
    on_error: continue
  for_each: aws.wafv2.get_rule_group
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      resource_arn: '{{ get_logging_configuration_response.LoggingConfiguration.ResourceArn
        }}'
      log_destination_configs: '{{ get_logging_configuration_response.LoggingConfiguration.LogDestinationConfigs
        }}'
      redacted_fields: '{{ get_logging_configuration_response.LoggingConfiguration.RedactedFields
        }}'
      managed_by_firewall_manager: '{{ get_logging_configuration_response.LoggingConfiguration.ManagedByFirewallManager
        }}'
      logging_filter: '{{ get_logging_configuration_response.LoggingConfiguration.LoggingFilter
        }}'
- discovery_id: aws.wafv2.get_regex_pattern_set
  calls:
  - action: get_regex_pattern_set
    save_as: get_regex_pattern_set_response
    params:
      Name: '{{ item.name }}'
      Scope: '{{ item.id }}'
      Id: '{{ item.id }}'
    on_error: continue
  for_each: aws.wafv2.get_rule_group
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      name: '{{ get_regex_pattern_set_response.RegexPatternSet.Name }}'
      id: '{{ get_regex_pattern_set_response.RegexPatternSet.Id }}'
      arn: '{{ get_regex_pattern_set_response.RegexPatternSet.ARN }}'
      description: '{{ get_regex_pattern_set_response.RegexPatternSet.Description
        }}'
      regular_expression_list: '{{ get_regex_pattern_set_response.RegexPatternSet.RegularExpressionList
        }}'
- discovery_id: aws.wafv2.describe_managed_rule_group
  calls:
  - action: describe_managed_rule_group
    save_as: describe_managed_rule_group_response
    params:
      VendorName: '{{ item.name }}'
      Name: '{{ item.name }}'
      Scope: '{{ item.id }}'
    on_error: continue
  for_each: aws.wafv2.get_rule_group
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      name: '{{ describe_managed_rule_group_response.Rules.Name }}'
      action: '{{ describe_managed_rule_group_response.Rules.Action }}'
- discovery_id: aws.wafv2.list_tags_for_resource
  calls:
  - action: list_tags_for_resource
    save_as: list_tags_for_resource_response
    params:
      ResourceARN: '{{ item.arn }}'
    on_error: continue
  for_each: aws.wafv2.get_rule_group
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      resource_arn: '{{ list_tags_for_resource_response.TagInfoForResource.ResourceARN
        }}'
      tag_list: '{{ list_tags_for_resource_response.TagInfoForResource.TagList }}'
checks:
- rule_id: aws.wafv2.rule.wafv2_references_valid_ip_or_regex_sets_only_configured
  for_each: aws.wafv2.get_rule_group
  conditions:
    any:
    - var: item.rules
      op: contains
      value: IPSetReferenceStatement
    - var: item.rules
      op: contains
      value: RegexPatternSetReferenceStatement
- rule_id: aws.wafv2.rulegroup.wafv2_unique_priorities_configured
  for_each: aws.wafv2.get_rule_group
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.wafv2.rulegroup.wafv2_no_permit_all_rule_configured
  for_each: aws.wafv2.get_web_acl
  conditions:
    var: item.default_action
    op: not_equals
    value: ALLOW
- rule_id: aws.wafv2.rulegroup.wafv2_references_only_approved_managed_sets_where_used_configured
  for_each: aws.wafv2.get_rule_group
  conditions:
    var: item.name
    op: contains
    value:
    - AWSManagedRules
- rule_id: aws.wafv2.ipset.wafv2_not_empty_configured
  for_each: aws.wafv2.get_ip_set
  conditions:
    var: item.addresses
    op: not_equals
    value: []
- rule_id: aws.wafv2.webacl.wafv2_attached_to_cdn_configured
  for_each: aws.wafv2.get_web_acl
  conditions:
    var: item.managed_by_firewall_manager
    op: equals
    value: true
- rule_id: aws.wafv2.ipset.wafv2_used_by_at_least_one_rule_configured
  for_each: aws.wafv2.get_rule_group
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.wafv2.resource.webacl_logging_enabled
  for_each: aws.wafv2.get_logging_configuration
  conditions:
    var: item.log_destination_configs
    op: not_equals
    value: []
- rule_id: aws.wafv2.resource.webacl_rule_logging_enabled
  for_each: aws.wafv2.get_logging_configuration
  conditions:
    var: item.log_destination_configs
    op: exists
- rule_id: aws.wafv2.webacl.wafv2_ip_rate_limit_rules_configured_if_supported
  for_each: aws.wafv2.get_rule_group
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.wafv2.regexpatternset.wafv2_no_overly_broad_patterns_configured
  for_each: aws.wafv2.get_regex_pattern_set
  conditions:
    var: item.regular_expression_list
    op: equals
    value: []
- rule_id: aws.wafv2.rulegroup.wafv2_visibility_config_enabled
  for_each: aws.wafv2.get_rule_group
  conditions:
    var: item.visibility_config
    op: exists
- rule_id: aws.wafv2.rule.wafv2_has_effective_action_not_count_only_configured
  for_each: aws.wafv2.describe_managed_rule_group
  conditions:
    var: item.action
    op: not_equals
    value: COUNT
- rule_id: aws.wafv2.webacl.wafv2_managed_rule_sets_enabled
  for_each: aws.wafv2.get_rule_group
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.wafv2.rule.wafv2_priority_unique_within_web_acl_configured
  for_each: aws.wafv2.get_rule_group
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.wafv2.regexpatternset.wafv2_not_empty_configured
  for_each: aws.wafv2.get_regex_pattern_set
  conditions:
    var: item.regular_expression_list
    op: not_equals
    value: []
- rule_id: aws.wafv2.ipset.wafv2_cross_account_sharing_restricted
  for_each: aws.wafv2.list_tags_for_resource
  conditions:
    var: item.resource_arn
    op: exists
- rule_id: aws.wafv2.webacl.wafv2_block_actions_not_count_only_configured
  for_each: aws.wafv2.get_web_acl
  conditions:
    var: item.default_action
    op: not_equals
    value: COUNT
- rule_id: aws.wafv2.ipset.wafv2_cidrs_valid_and_minimized_configured
  for_each: aws.wafv2.get_ip_set
  conditions:
    all:
    - var: item.addresses
      op: exists
    - var: item.ip_address_version
      op: equals
      value: IPV4
- rule_id: aws.wafv2.webacl.logging_enabled
  for_each: aws.wafv2.get_logging_configuration
  conditions:
    var: item.log_destination_configs
    op: not_equals
    value: []
- rule_id: aws.wafv2.regexpatternset.wafv2_used_by_at_least_one_rule_configured
  for_each: aws.wafv2.get_rule_group
  conditions:
    var: item.rules
    op: exists
