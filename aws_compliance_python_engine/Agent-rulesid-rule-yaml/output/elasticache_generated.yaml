version: '1.0'
provider: aws
service: elasticache
discovery:
- discovery_id: aws.elasticache.describe_cache_clusters
  calls:
  - action: describe_cache_clusters
    save_as: describe_cache_clusters_response
  emit:
    items_for: '{{ describe_cache_clusters_response.CacheClusters }}'
    as: resource
    item:
      cache_cluster_id: '{{ resource.CacheClusterId }}'
      configuration_endpoint: '{{ resource.ConfigurationEndpoint }}'
      client_download_landing_page: '{{ resource.ClientDownloadLandingPage }}'
      cache_node_type: '{{ resource.CacheNodeType }}'
      engine: '{{ resource.Engine }}'
      engine_version: '{{ resource.EngineVersion }}'
      cache_cluster_status: '{{ resource.CacheClusterStatus }}'
      num_cache_nodes: '{{ resource.NumCacheNodes }}'
      preferred_availability_zone: '{{ resource.PreferredAvailabilityZone }}'
      preferred_outpost_arn: '{{ resource.PreferredOutpostArn }}'
- discovery_id: aws.elasticache.describe_replication_groups
  calls:
  - action: describe_replication_groups
    save_as: describe_replication_groups_response
  emit:
    items_for: '{{ describe_replication_groups_response.ReplicationGroups }}'
    as: resource
    item:
      replication_group_id: '{{ resource.ReplicationGroupId }}'
      description: '{{ resource.Description }}'
      global_replication_group_info: '{{ resource.GlobalReplicationGroupInfo }}'
      status: '{{ resource.Status }}'
      pending_modified_values: '{{ resource.PendingModifiedValues }}'
      member_clusters: '{{ resource.MemberClusters }}'
      node_groups: '{{ resource.NodeGroups }}'
      snapshotting_cluster_id: '{{ resource.SnapshottingClusterId }}'
      automatic_failover: '{{ resource.AutomaticFailover }}'
      multi_az: '{{ resource.MultiAZ }}'
- discovery_id: aws.elasticache.describe_cache_subnet_groups
  calls:
  - action: describe_cache_subnet_groups
    save_as: describe_cache_subnet_groups_response
  emit:
    items_for: '{{ describe_cache_subnet_groups_response.CacheSubnetGroups }}'
    as: resource
    item:
      cache_subnet_group_name: '{{ resource.CacheSubnetGroupName }}'
      cache_subnet_group_description: '{{ resource.CacheSubnetGroupDescription }}'
      vpc_id: '{{ resource.VpcId }}'
      subnets: '{{ resource.Subnets }}'
      arn: '{{ resource.ARN }}'
      supported_network_types: '{{ resource.SupportedNetworkTypes }}'
- discovery_id: aws.elasticache.describe_global_replication_groups
  calls:
  - action: describe_global_replication_groups
    save_as: describe_global_replication_groups_response
  emit:
    items_for: '{{ describe_global_replication_groups_response.GlobalReplicationGroups
      }}'
    as: resource
    item:
      global_replication_group_id: '{{ resource.GlobalReplicationGroupId }}'
      global_replication_group_description: '{{ resource.GlobalReplicationGroupDescription
        }}'
      status: '{{ resource.Status }}'
      cache_node_type: '{{ resource.CacheNodeType }}'
      engine: '{{ resource.Engine }}'
      engine_version: '{{ resource.EngineVersion }}'
      members: '{{ resource.Members }}'
      cluster_enabled: '{{ resource.ClusterEnabled }}'
      global_node_groups: '{{ resource.GlobalNodeGroups }}'
      auth_token_enabled: '{{ resource.AuthTokenEnabled }}'
- discovery_id: aws.elasticache.describe_service_updates
  calls:
  - action: describe_service_updates
    save_as: describe_service_updates_response
  emit:
    items_for: '{{ describe_service_updates_response.ServiceUpdates }}'
    as: resource
    item:
      service_update_name: '{{ resource.ServiceUpdateName }}'
      service_update_release_date: '{{ resource.ServiceUpdateReleaseDate }}'
      service_update_end_date: '{{ resource.ServiceUpdateEndDate }}'
      service_update_severity: '{{ resource.ServiceUpdateSeverity }}'
      service_update_recommended_apply_by_date: '{{ resource.ServiceUpdateRecommendedApplyByDate
        }}'
      service_update_status: '{{ resource.ServiceUpdateStatus }}'
      service_update_description: '{{ resource.ServiceUpdateDescription }}'
      service_update_type: '{{ resource.ServiceUpdateType }}'
      engine: '{{ resource.Engine }}'
      engine_version: '{{ resource.EngineVersion }}'
checks:
- rule_id: aws.elasticache.cluster.require_tls_in_transit_configured
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.transit_encryption_enabled
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.encryption_at_rest_cmek_configured
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.at_rest_encryption_enabled
    op: equals
    value: true
- rule_id: aws.elasticache.node.public_access_disabled
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.cache_security_groups
    op: equals
    value: []
- rule_id: aws.elasticache.cluster.elasticache_automatic_failover_enabled
  for_each: aws.elasticache.describe_replication_groups
  conditions:
    var: item.automatic_failover
    op: equals
    value: ENABLED
- rule_id: aws.elasticache.cluster.private_networking_enforced
  for_each: aws.elasticache.describe_cache_subnet_groups
  conditions:
    all:
    - var: item.vpc_id
      op: exists
    - var: item.supported_network_types
      op: contains
      value: PRIVATE
- rule_id: aws.elasticache.node.deletion_protection_enabled
  for_each: aws.elasticache.describe_global_replication_groups
  conditions:
    var: item.cluster_enabled
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.rest_encryption_enabled
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.at_rest_encryption_enabled
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.deletion_protection_enabled
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.cache_cluster_status
    op: equals
    value: ENABLED
- rule_id: aws.elasticache.cluster.elasticache_minor_version_auto_upgrade_enabled
  for_each: aws.elasticache.describe_service_updates
  conditions:
    var: item.auto_update_after_recommended_apply_by_date
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.audit_logging_enabled
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.auth_token_enabled
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.public_access_disabled
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.configuration_endpoint
    op: exists
- rule_id: aws.elasticache.node.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.auth_token_enabled
    op: equals
    value: true
- rule_id: aws.elasticache.node.require_tls_in_transit_configured
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.transit_encryption_enabled
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.in_transit_encryption_enabled
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.transit_encryption_enabled
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.auth_token_enabled
    op: equals
    value: true
- rule_id: aws.elasticache.node.encryption_at_rest_enabled
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.at_rest_encryption_enabled
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.encryption_at_rest_enabled
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.at_rest_encryption_enabled
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.elasticache_multi_az_enabled
  for_each: aws.elasticache.describe_replication_groups
  conditions:
    var: item.multi_az
    op: equals
    value: true
- rule_id: aws.elasticache.backupretention.backup_retention_configured
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.snapshot_retention_limit
    op: gt
    value: 0
