version: '1.0'
provider: aws
service: neptune
discovery:
- discovery_id: aws.neptune.describe_db_clusters
  calls:
  - action: describe_db_clusters
    save_as: describe_db_clusters_response
  emit:
    items_for: '{{ describe_db_clusters_response.DBClusters }}'
    as: resource
    item:
      allocated_storage: '{{ resource.AllocatedStorage }}'
      availability_zones: '{{ resource.AvailabilityZones }}'
      backup_retention_period: '{{ resource.BackupRetentionPeriod }}'
      character_set_name: '{{ resource.CharacterSetName }}'
      database_name: '{{ resource.DatabaseName }}'
      db_cluster_identifier: '{{ resource.DBClusterIdentifier }}'
      db_cluster_parameter_group: '{{ resource.DBClusterParameterGroup }}'
      db_subnet_group: '{{ resource.DBSubnetGroup }}'
      status: '{{ resource.Status }}'
      percent_progress: '{{ resource.PercentProgress }}'
- discovery_id: aws.neptune.describe_db_cluster_snapshots
  calls:
  - action: describe_db_cluster_snapshots
    save_as: describe_db_cluster_snapshots_response
  emit:
    items_for: '{{ describe_db_cluster_snapshots_response.DBClusterSnapshots }}'
    as: resource
    item:
      availability_zones: '{{ resource.AvailabilityZones }}'
      db_cluster_snapshot_identifier: '{{ resource.DBClusterSnapshotIdentifier }}'
      db_cluster_identifier: '{{ resource.DBClusterIdentifier }}'
      snapshot_create_time: '{{ resource.SnapshotCreateTime }}'
      engine: '{{ resource.Engine }}'
      allocated_storage: '{{ resource.AllocatedStorage }}'
      status: '{{ resource.Status }}'
      port: '{{ resource.Port }}'
      vpc_id: '{{ resource.VpcId }}'
      cluster_create_time: '{{ resource.ClusterCreateTime }}'
- discovery_id: aws.neptune.describe_db_engine_versions
  calls:
  - action: describe_db_engine_versions
    save_as: describe_db_engine_versions_response
  emit:
    items_for: '{{ describe_db_engine_versions_response.DBEngineVersions }}'
    as: resource
    item:
      engine: '{{ resource.Engine }}'
      engine_version: '{{ resource.EngineVersion }}'
      db_parameter_group_family: '{{ resource.DBParameterGroupFamily }}'
      db_engine_description: '{{ resource.DBEngineDescription }}'
      db_engine_version_description: '{{ resource.DBEngineVersionDescription }}'
      default_character_set: '{{ resource.DefaultCharacterSet }}'
      supported_character_sets: '{{ resource.SupportedCharacterSets }}'
      valid_upgrade_target: '{{ resource.ValidUpgradeTarget }}'
      supported_timezones: '{{ resource.SupportedTimezones }}'
      exportable_log_types: '{{ resource.ExportableLogTypes }}'
- discovery_id: aws.neptune.describe_orderable_db_instance_options
  calls:
  - action: describe_orderable_db_instance_options
    save_as: describe_orderable_db_instance_options_response
    params:
      Engine: '{{ item.engine }}'
    on_error: continue
  for_each: aws.neptune.describe_db_clusters
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      engine: '{{ describe_orderable_db_instance_options_response.OrderableDBInstanceOptions.Engine
        }}'
      engine_version: '{{ describe_orderable_db_instance_options_response.OrderableDBInstanceOptions.EngineVersion
        }}'
      db_instance_class: '{{ describe_orderable_db_instance_options_response.OrderableDBInstanceOptions.DBInstanceClass
        }}'
      license_model: '{{ describe_orderable_db_instance_options_response.OrderableDBInstanceOptions.LicenseModel
        }}'
      availability_zones: '{{ describe_orderable_db_instance_options_response.OrderableDBInstanceOptions.AvailabilityZones
        }}'
checks:
- rule_id: aws.neptune.cluster.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.neptune.describe_orderable_db_instance_options
  conditions:
    var: item.supports_iam_database_authentication
    op: equals
    value: true
- rule_id: aws.neptune.cluster.public_access_disabled
  for_each: aws.neptune.describe_db_clusters
  conditions:
    var: item.vpc_security_groups
    op: equals
    value: []
- rule_id: aws.neptune.instance.require_tls_in_transit_configured
  for_each: aws.neptune.describe_db_clusters
  conditions:
    var: item.db_cluster_parameter_group
    op: contains
    value: neptune_enforce_ssl
- rule_id: aws.neptune.security_configuration_review.security_configuration_review_configured
  for_each: aws.neptune.describe_db_clusters
  conditions:
    all:
    - var: item.status
      op: equals
      value: available
    - var: item.backup_retention_period
      op: gte
      value: 7
    - var: item.multi_az
      op: equals
      value: true
    - var: item.storage_encrypted
      op: equals
      value: true
- rule_id: aws.neptune.cluster.neptune_storage_encrypted
  for_each: aws.neptune.describe_db_cluster_snapshots
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.neptune.cluster.encryption_at_rest_enabled
  for_each: aws.neptune.describe_db_cluster_snapshots
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.neptune.cluster.iam_db_authentication_enabled
  for_each: aws.neptune.describe_orderable_db_instance_options
  conditions:
    var: item.supports_iam_database_authentication
    op: equals
    value: true
- rule_id: aws.neptune.cluster.neptune_integration_cloudwatch_logs_configured
  for_each: aws.neptune.describe_db_engine_versions
  conditions:
    var: item.supports_log_exports_to_cloudwatch_logs
    op: equals
    value: true
- rule_id: aws.neptune.cluster.deletion_protection_enabled
  for_each: aws.neptune.describe_db_clusters
  conditions:
    var: item.deletion_protection
    op: equals
    value: true
- rule_id: aws.neptune.cluster.network_security_audit_configured
  for_each: aws.neptune.describe_db_engine_versions
  conditions:
    var: item.supports_log_exports_to_cloudwatch_logs
    op: equals
    value: true
- rule_id: aws.neptune.instance.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.neptune.describe_orderable_db_instance_options
  conditions:
    var: item.supports_iam_database_authentication
    op: equals
    value: true
- rule_id: aws.neptune.instance.deletion_protection_enabled
  for_each: aws.neptune.describe_db_clusters
  conditions:
    var: item.deletion_protection
    op: equals
    value: true
- rule_id: aws.neptune.cluster.encryption_at_rest_cmek_configured
  for_each: aws.neptune.describe_db_cluster_snapshots
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.neptune.cluster.neptune_minor_version_auto_upgrade_enabled
  for_each: aws.neptune.describe_db_cluster_snapshots
  conditions:
    var: item.engine_version
    op: contains
    value: auto
- rule_id: aws.neptune.instance.encryption_at_rest_enabled
  for_each: aws.neptune.describe_db_cluster_snapshots
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.neptune.cluster.snapshot_encrypted
  for_each: aws.neptune.describe_db_cluster_snapshots
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.neptune.cluster.neptune_multi_az_configured
  for_each: aws.neptune.describe_db_clusters
  conditions:
    var: item.multi_az
    op: equals
    value: true
- rule_id: aws.neptune.instance.public_access_disabled
  for_each: aws.neptune.describe_db_clusters
  conditions:
    var: item.vpc_security_groups
    op: equals
    value: []
- rule_id: aws.neptune.cluster.copy_tags_to_snapshots_configured
  for_each: aws.neptune.describe_db_clusters
  conditions:
    var: item.copy_tags_to_snapshot
    op: equals
    value: true
- rule_id: aws.neptune.cluster.audit_logging_enabled
  for_each: aws.neptune.describe_db_engine_versions
  conditions:
    var: item.supports_log_exports_to_cloudwatch_logs
    op: equals
    value: true
- rule_id: aws.neptune.cluster.require_tls_in_transit_configured
  for_each: aws.neptune.describe_db_clusters
  conditions:
    var: item.db_cluster_parameter_group
    op: contains
    value: neptune_enforce_ssl
- rule_id: aws.neptune.cluster.encryption_in_transit_enforced
  for_each: aws.neptune.describe_db_cluster_snapshots
  conditions:
    var: item.engine_version
    op: gte
    value: '1.2'
