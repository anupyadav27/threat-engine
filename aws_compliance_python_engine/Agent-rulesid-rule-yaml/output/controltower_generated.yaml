version: '1.0'
provider: aws
service: controltower
discovery:
- discovery_id: aws.controltower.list_enabled_baselines
  calls:
  - action: list_enabled_baselines
    save_as: list_enabled_baselines_response
  emit:
    items_for: '{{ list_enabled_baselines_response.enabledBaselines }}'
    as: resource
    item:
      arn: '{{ resource.arn }}'
      baseline_identifier: '{{ resource.baselineIdentifier }}'
      baseline_version: '{{ resource.baselineVersion }}'
      drift_status_summary: '{{ resource.driftStatusSummary }}'
      target_identifier: '{{ resource.targetIdentifier }}'
      parent_identifier: '{{ resource.parentIdentifier }}'
      status_summary: '{{ resource.statusSummary }}'
- discovery_id: aws.controltower.list_control_operations
  calls:
  - action: list_control_operations
    save_as: list_control_operations_response
  emit:
    items_for: '{{ list_control_operations_response.controlOperations }}'
    as: resource
    item:
      operation_type: '{{ resource.operationType }}'
      start_time: '{{ resource.startTime }}'
      end_time: '{{ resource.endTime }}'
      status: '{{ resource.status }}'
      status_message: '{{ resource.statusMessage }}'
      operation_identifier: '{{ resource.operationIdentifier }}'
      control_identifier: '{{ resource.controlIdentifier }}'
      target_identifier: '{{ resource.targetIdentifier }}'
      enabled_control_identifier: '{{ resource.enabledControlIdentifier }}'
checks:
- rule_id: aws.controltower.landingzone.controltower_scps_enabled
  for_each: aws.controltower.list_enabled_baselines
  conditions:
    var: item.status_summary
    op: equals
    value: ENABLED
- rule_id: aws.controltower.enrollment.block_leave_org_by_policy_configured
  for_each: aws.controltower.list_control_operations
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.controltower.landingzone.block_leave_org_by_policy_configured
  for_each: aws.controltower.list_control_operations
  conditions:
    all:
    - var: item.status
      op: equals
      value: ACTIVE
    - var: item.status
      op: equals
      value: ENABLED
- rule_id: aws.controltower.enrollment.controltower_all_accounts_enrolled_in_org_configured
  for_each: aws.controltower.list_control_operations
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.controltower.enrollment.controltower_scps_enabled
  for_each: aws.controltower.list_enabled_baselines
  conditions:
    var: item.status_summary
    op: equals
    value: ENABLED
