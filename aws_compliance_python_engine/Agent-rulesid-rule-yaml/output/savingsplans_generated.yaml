version: '1.0'
provider: aws
service: savingsplans
discovery:
- discovery_id: aws.savingsplans.describe_savings_plans
  calls:
  - action: describe_savings_plans
    save_as: describe_savings_plans_response
  emit:
    items_for: '{{ describe_savings_plans_response.savingsPlans }}'
    as: resource
    item:
      offering_id: '{{ resource.offeringId }}'
      savings_plan_id: '{{ resource.savingsPlanId }}'
      savings_plan_arn: '{{ resource.savingsPlanArn }}'
      description: '{{ resource.description }}'
      start: '{{ resource.start }}'
      end: '{{ resource.end }}'
      state: '{{ resource.state }}'
      region: '{{ resource.region }}'
      ec2_instance_family: '{{ resource.ec2InstanceFamily }}'
      savings_plan_type: '{{ resource.savingsPlanType }}'
checks:
- rule_id: aws.savingsplans.savingsplan.savingsplans_approval_workflow_required
  for_each: aws.savingsplans.describe_savings_plans
  conditions:
    var: item.state
    op: equals
    value: ACTIVE
- rule_id: aws.savingsplans.savingsplan.purchase_permissions_restricted
  for_each: aws.savingsplans.describe_savings_plans
  conditions:
    all:
    - var: item.state
      op: equals
      value: ACTIVE
    - var: item.savings_plan_type
      op: equals
      value: RESTRICTED
- rule_id: aws.savingsplans.savingsplan.billing_admins_mfa_required
  for_each: aws.savingsplans.describe_savings_plans
  conditions:
    var: item.state
    op: equals
    value: ACTIVE
