version: '1.0'
provider: aws
service: ecr
discovery:
- discovery_id: aws.ecr.describe_repositories
  calls:
  - action: describe_repositories
    save_as: describe_repositories_response
  emit:
    items_for: '{{ describe_repositories_response.repositories }}'
    as: resource
    item:
      repository_arn: '{{ resource.repositoryArn }}'
      registry_id: '{{ resource.registryId }}'
      repository_name: '{{ resource.repositoryName }}'
      repository_uri: '{{ resource.repositoryUri }}'
      created_at: '{{ resource.createdAt }}'
      image_tag_mutability: '{{ resource.imageTagMutability }}'
      image_tag_mutability_exclusion_filters: '{{ resource.imageTagMutabilityExclusionFilters
        }}'
      image_scanning_configuration: '{{ resource.imageScanningConfiguration }}'
      encryption_configuration: '{{ resource.encryptionConfiguration }}'
- discovery_id: aws.ecr.describe_repository_creation_templates
  calls:
  - action: describe_repository_creation_templates
    save_as: describe_repository_creation_templates_response
  emit:
    items_for: '{{ describe_repository_creation_templates_response.repositoryCreationTemplates
      }}'
    as: resource
    item:
      prefix: '{{ resource.prefix }}'
      description: '{{ resource.description }}'
      encryption_configuration: '{{ resource.encryptionConfiguration }}'
      resource_tags: '{{ resource.resourceTags }}'
      image_tag_mutability: '{{ resource.imageTagMutability }}'
      image_tag_mutability_exclusion_filters: '{{ resource.imageTagMutabilityExclusionFilters
        }}'
      repository_policy: '{{ resource.repositoryPolicy }}'
      lifecycle_policy: '{{ resource.lifecyclePolicy }}'
      applied_for: '{{ resource.appliedFor }}'
      custom_role_arn: '{{ resource.customRoleArn }}'
- discovery_id: aws.ecr.delete_signing_configuration
  calls:
  - action: delete_signing_configuration
    save_as: delete_signing_configuration_response
  emit:
    items_for: '{{ delete_signing_configuration_response.signingConfiguration }}'
    as: resource
    item:
      rules: '{{ resource.rules }}'
- discovery_id: aws.ecr.batch_get_repository_scanning_configuration
  calls:
  - action: batch_get_repository_scanning_configuration
    save_as: batch_get_repository_scanning_configuration_response
    params:
      repositoryNames: '{{ item.repository_name }}'
    on_error: continue
  for_each: aws.ecr.describe_repositories
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      repository_arn: '{{ batch_get_repository_scanning_configuration_response.scanningConfigurations.repositoryArn
        }}'
      repository_name: '{{ batch_get_repository_scanning_configuration_response.scanningConfigurations.repositoryName
        }}'
      scan_on_push: '{{ batch_get_repository_scanning_configuration_response.scanningConfigurations.scanOnPush
        }}'
      scan_frequency: '{{ batch_get_repository_scanning_configuration_response.scanningConfigurations.scanFrequency
        }}'
      applied_scan_filters: '{{ batch_get_repository_scanning_configuration_response.scanningConfigurations.appliedScanFilters
        }}'
checks:
- rule_id: aws.ecr.imagescan.ecr_results_export_destination_encrypted
  for_each: aws.ecr.describe_repositories
  conditions:
    var: item.encryption_configuration
    op: exists
- rule_id: aws.ecr.resource.ecr_image_scan_on_push_enabled
  for_each: aws.ecr.batch_get_repository_scanning_configuration
  conditions:
    var: item.scan_on_push
    op: equals
    value: true
- rule_id: aws.ecr.resource.repository_encryption_enabled
  for_each: aws.ecr.describe_repositories
  conditions:
    var: item.encryption_configuration
    op: exists
- rule_id: aws.ecr.replication_configuration.ecr_cross_region_encrypted
  for_each: aws.ecr.describe_repositories
  conditions:
    var: item.encryption_configuration
    op: exists
- rule_id: aws.ecr.resource.ecr_repository_scan_on_push_enabled
  for_each: aws.ecr.batch_get_repository_scanning_configuration
  conditions:
    var: item.scan_on_push
    op: equals
    value: true
- rule_id: aws.ecr.repository.repo_private_or_access_restricted
  for_each: aws.ecr.describe_repository_creation_templates
  conditions:
    any:
    - var: item.repository_policy
      op: exists
    - var: item.repository_policy
      op: contains
      value: Deny
- rule_id: aws.ecr.repositories_not_publicly_accessible.repositories_not_publicly_accessible_configured
  for_each: aws.ecr.describe_repository_creation_templates
  conditions:
    var: item.repository_policy
    op: exists
- rule_id: aws.ecr.lifecyclepolicy.policy_storage_encrypted
  for_each: aws.ecr.describe_repositories
  conditions:
    var: item.encryption_configuration
    op: exists
- rule_id: aws.ecr.repository_policy.no_public_pull_push_configured
  for_each: aws.ecr.describe_repository_creation_templates
  conditions:
    var: item.repository_policy
    op: equals
    value: []
- rule_id: aws.ecr.lifecyclepolicy.ecr_unused_or_old_tags_expire_configured
  for_each: aws.ecr.describe_repository_creation_templates
  conditions:
    var: item.lifecycle_policy
    op: exists
- rule_id: aws.ecr.repository_policy.ecr_no_wildcard_admin_configured
  for_each: aws.ecr.describe_repository_creation_templates
  conditions:
    var: item.repository_policy
    op: exists
- rule_id: aws.ecr.repository.immutable_tags_or_signing_enforced
  for_each: aws.ecr.describe_repositories
  conditions:
    var: item.image_tag_mutability
    op: equals
    value: IMMUTABLE
- rule_id: aws.ecr.imagescan.scope_includes_all_asset_groups_configured
  for_each: aws.ecr.batch_get_repository_scanning_configuration
  conditions:
    var: item.scan_on_push
    op: equals
    value: true
- rule_id: aws.ecr.repository.ecr_image_scanning_enabled
  for_each: aws.ecr.describe_repositories
  conditions:
    var: item.image_scanning_configuration
    op: equals
    value:
      scanOnPush: true
- rule_id: aws.ecr.replication_configuration.ecr_destinations_least_privilege
  for_each: aws.ecr.delete_signing_configuration
  conditions:
    var: item.rules
    op: exists
