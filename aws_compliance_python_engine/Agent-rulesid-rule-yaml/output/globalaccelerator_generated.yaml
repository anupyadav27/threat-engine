version: '1.0'
provider: aws
service: globalaccelerator
discovery:
- discovery_id: aws.globalaccelerator.list_accelerators
  calls:
  - action: list_accelerators
    save_as: list_accelerators_response
  emit:
    items_for: '{{ list_accelerators_response.Accelerators }}'
    as: resource
    item:
      accelerator_arn: '{{ resource.AcceleratorArn }}'
      name: '{{ resource.Name }}'
      ip_address_type: '{{ resource.IpAddressType }}'
      enabled: '{{ resource.Enabled }}'
      ip_sets: '{{ resource.IpSets }}'
      dns_name: '{{ resource.DnsName }}'
      status: '{{ resource.Status }}'
      created_time: '{{ resource.CreatedTime }}'
      last_modified_time: '{{ resource.LastModifiedTime }}'
      dual_stack_dns_name: '{{ resource.DualStackDnsName }}'
- discovery_id: aws.globalaccelerator.describe_accelerator_attributes
  calls:
  - action: describe_accelerator_attributes
    save_as: describe_accelerator_attributes_response
    params:
      AcceleratorArn: '{{ item.accelerator_arn }}'
    on_error: continue
  for_each: aws.globalaccelerator.list_accelerators
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      flow_logs_enabled: '{{ describe_accelerator_attributes_response.AcceleratorAttributes.FlowLogsEnabled
        }}'
      flow_logs_s3_bucket: '{{ describe_accelerator_attributes_response.AcceleratorAttributes.FlowLogsS3Bucket
        }}'
      flow_logs_s3_prefix: '{{ describe_accelerator_attributes_response.AcceleratorAttributes.FlowLogsS3Prefix
        }}'
- discovery_id: aws.globalaccelerator.create_listener
  calls:
  - action: create_listener
    save_as: create_listener_response
    params:
      AcceleratorArn: '{{ item.accelerator_arn }}'
      PortRanges: '{{ item.id }}'
      Protocol: '{{ item.id }}'
      IdempotencyToken: '{{ item.id }}'
    on_error: continue
  for_each: aws.globalaccelerator.list_accelerators
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      listener_arn: '{{ create_listener_response.Listener.ListenerArn }}'
      port_ranges: '{{ create_listener_response.Listener.PortRanges }}'
      protocol: '{{ create_listener_response.Listener.Protocol }}'
      client_affinity: '{{ create_listener_response.Listener.ClientAffinity }}'
checks:
- rule_id: aws.globalaccelerator.accelerator.access_logs_enabled
  for_each: aws.globalaccelerator.describe_accelerator_attributes
  conditions:
    var: item.flow_logs_enabled
    op: equals
    value: true
- rule_id: aws.globalaccelerator.accelerator.listener_tls_min_1_2_configured
  for_each: aws.globalaccelerator.create_listener
  conditions:
    var: item.protocol
    op: equals
    value: TLS
- rule_id: aws.globalaccelerator.accelerator.valid_certificate_enabled
  for_each: aws.globalaccelerator.list_accelerators
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.globalaccelerator.accelerator.waf_attached_if_supported
  for_each: aws.globalaccelerator.list_accelerators
  conditions:
    all:
    - var: item.status
      op: equals
      value: DEPLOYED
    - var: item.enabled
      op: equals
      value: true
