version: '1.0'
provider: aws
service: quicksight
discovery:
- discovery_id: aws.quicksight.describe_account_settings
  calls:
  - action: describe_account_settings
    save_as: describe_account_settings_response
    params:
      AwsAccountId: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.quicksight.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      account_name: '{{ describe_account_settings_response.AccountSettings.AccountName
        }}'
      edition: '{{ describe_account_settings_response.AccountSettings.Edition }}'
      default_namespace: '{{ describe_account_settings_response.AccountSettings.DefaultNamespace
        }}'
      notification_email: '{{ describe_account_settings_response.AccountSettings.NotificationEmail
        }}'
      public_sharing_enabled: '{{ describe_account_settings_response.AccountSettings.PublicSharingEnabled
        }}'
- discovery_id: aws.quicksight.describe_account_subscription
  calls:
  - action: describe_account_subscription
    save_as: describe_account_subscription_response
    params:
      AwsAccountId: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.quicksight.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      account_name: '{{ describe_account_subscription_response.AccountInfo.AccountName
        }}'
      edition: '{{ describe_account_subscription_response.AccountInfo.Edition }}'
      notification_email: '{{ describe_account_subscription_response.AccountInfo.NotificationEmail
        }}'
      authentication_type: '{{ describe_account_subscription_response.AccountInfo.AuthenticationType
        }}'
      account_subscription_status: '{{ describe_account_subscription_response.AccountInfo.AccountSubscriptionStatus
        }}'
- discovery_id: aws.quicksight.create_group
  calls:
  - action: create_group
    save_as: create_group_response
    params:
      GroupName: '{{ item.FIELD_NAME }}'
      AwsAccountId: '{{ item.FIELD_NAME }}'
      Namespace: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.quicksight.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      arn: '{{ create_group_response.Group.Arn }}'
      group_name: '{{ create_group_response.Group.GroupName }}'
      description: '{{ create_group_response.Group.Description }}'
      principal_id: '{{ create_group_response.Group.PrincipalId }}'
- discovery_id: aws.quicksight.describe_data_set
  calls:
  - action: describe_data_set
    save_as: describe_data_set_response
    params:
      AwsAccountId: '{{ item.FIELD_NAME }}'
      DataSetId: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.quicksight.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      arn: '{{ describe_data_set_response.DataSet.Arn }}'
      data_set_id: '{{ describe_data_set_response.DataSet.DataSetId }}'
      name: '{{ describe_data_set_response.DataSet.Name }}'
      created_time: '{{ describe_data_set_response.DataSet.CreatedTime }}'
      last_updated_time: '{{ describe_data_set_response.DataSet.LastUpdatedTime }}'
- discovery_id: aws.quicksight.describe_action_connector
  calls:
  - action: describe_action_connector
    save_as: describe_action_connector_response
    params:
      AwsAccountId: '{{ item.FIELD_NAME }}'
      ActionConnectorId: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.quicksight.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      arn: '{{ describe_action_connector_response.ActionConnector.Arn }}'
      action_connector_id: '{{ describe_action_connector_response.ActionConnector.ActionConnectorId
        }}'
      type: '{{ describe_action_connector_response.ActionConnector.Type }}'
      name: '{{ describe_action_connector_response.ActionConnector.Name }}'
      created_time: '{{ describe_action_connector_response.ActionConnector.CreatedTime
        }}'
- discovery_id: aws.quicksight.describe_action_connector_permissions
  calls:
  - action: describe_action_connector_permissions
    save_as: describe_action_connector_permissions_response
    params:
      AwsAccountId: '{{ item.FIELD_NAME }}'
      ActionConnectorId: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.quicksight.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      principal: '{{ describe_action_connector_permissions_response.Permissions.Principal
        }}'
      actions: '{{ describe_action_connector_permissions_response.Permissions.Actions
        }}'
- discovery_id: aws.quicksight.describe_user
  calls:
  - action: describe_user
    save_as: describe_user_response
    params:
      UserName: '{{ item.FIELD_NAME }}'
      AwsAccountId: '{{ item.FIELD_NAME }}'
      Namespace: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.quicksight.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      arn: '{{ describe_user_response.User.Arn }}'
      user_name: '{{ describe_user_response.User.UserName }}'
      email: '{{ describe_user_response.User.Email }}'
      role: '{{ describe_user_response.User.Role }}'
      identity_type: '{{ describe_user_response.User.IdentityType }}'
checks:
- rule_id: aws.quicksight.dataset.public_sharing_disabled
  for_each: aws.quicksight.describe_account_settings
  conditions:
    var: item.public_sharing_enabled
    op: equals
    value: false
- rule_id: aws.quicksight.user.quicksight_sso_required
  for_each: aws.quicksight.describe_account_subscription
  conditions:
    var: item.authentication_type
    op: equals
    value: IAM_IDENTITY_CENTER
- rule_id: aws.quicksight.dashboard.quicksight_sharing_restricted_to_org_configured
  for_each: aws.quicksight.describe_account_settings
  conditions:
    var: item.public_sharing_enabled
    op: equals
    value: false
- rule_id: aws.quicksight.group.roles_minimal_configured
  for_each: aws.quicksight.create_group
  conditions:
    all:
    - var: item.arn
      op: exists
    - var: item.group_name
      op: exists
    - var: item.description
      op: exists
    - var: item.principal_id
      op: exists
- rule_id: aws.quicksight.dataset.encryption_at_rest_enabled
  for_each: aws.quicksight.describe_data_set
  conditions:
    var: item.import_mode
    op: equals
    value: SPICE
- rule_id: aws.quicksight.dashboard.admin_activity_logging_enabled
  for_each: aws.quicksight.describe_action_connector
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.quicksight.dataset.row_level_security_enabled
  for_each: aws.quicksight.describe_data_set
  conditions:
    var: item.row_level_permission_data_set
    op: exists
- rule_id: aws.quicksight.dataset.access_policies_least_privilege
  for_each: aws.quicksight.describe_action_connector_permissions
  conditions:
    all:
    - var: item.principal
      op: exists
    - var: item.actions
      op: equals
      value: []
- rule_id: aws.quicksight.group.quicksight_external_sharing_restricted
  for_each: aws.quicksight.describe_account_settings
  conditions:
    var: item.public_sharing_enabled
    op: equals
    value: false
- rule_id: aws.quicksight.dashboard.quicksight_export_controls_enabled
  for_each: aws.quicksight.describe_account_settings
  conditions:
    var: item.public_sharing_enabled
    op: equals
    value: true
- rule_id: aws.quicksight.dashboard.public_embeds_disabled
  for_each: aws.quicksight.describe_account_settings
  conditions:
    var: item.public_sharing_enabled
    op: equals
    value: false
- rule_id: aws.quicksight.dashboard.query_access_logging_enabled
  for_each: aws.quicksight.describe_action_connector
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.quicksight.dashboard.quicksight_sso_required
  for_each: aws.quicksight.describe_account_subscription
  conditions:
    var: item.authentication_type
    op: equals
    value: IAMIdentityCenter
- rule_id: aws.quicksight.user.external_access_reviewed_configured
  for_each: aws.quicksight.describe_user
  conditions:
    all:
    - var: item.external_login_federation_provider_type
      op: exists
    - var: item.external_login_federation_provider_url
      op: exists
    - var: item.external_login_id
      op: exists
- rule_id: aws.quicksight.user.roles_minimal_configured
  for_each: aws.quicksight.describe_user
  conditions:
    all:
    - var: item.role
      op: equals
      value: READER
    - var: item.active
      op: equals
      value: true
