version: '1.0'
provider: aws
service: directconnect
discovery:
- discovery_id: aws.directconnect.describe_connections
  calls:
  - action: describe_connections
    save_as: describe_connections_response
  emit:
    items_for: '{{ describe_connections_response.connections }}'
    as: resource
    item:
      owner_account: '{{ resource.ownerAccount }}'
      connection_id: '{{ resource.connectionId }}'
      connection_name: '{{ resource.connectionName }}'
      connection_state: '{{ resource.connectionState }}'
      region: '{{ resource.region }}'
      location: '{{ resource.location }}'
      bandwidth: '{{ resource.bandwidth }}'
      vlan: '{{ resource.vlan }}'
      partner_name: '{{ resource.partnerName }}'
      loa_issue_time: '{{ resource.loaIssueTime }}'
- discovery_id: aws.directconnect.create_bgp_peer
  calls:
  - action: create_bgp_peer
    save_as: create_bgp_peer_response
  emit:
    items_for: '{{ create_bgp_peer_response.virtualInterface }}'
    as: resource
    item:
      owner_account: '{{ resource.ownerAccount }}'
      virtual_interface_id: '{{ resource.virtualInterfaceId }}'
      location: '{{ resource.location }}'
      connection_id: '{{ resource.connectionId }}'
      virtual_interface_type: '{{ resource.virtualInterfaceType }}'
      virtual_interface_name: '{{ resource.virtualInterfaceName }}'
      vlan: '{{ resource.vlan }}'
      asn: '{{ resource.asn }}'
      asn_long: '{{ resource.asnLong }}'
      amazon_side_asn: '{{ resource.amazonSideAsn }}'
checks:
- rule_id: aws.directconnect.connection_redundancy.directconnect_connection_redundancy_configured
  for_each: aws.directconnect.describe_connections
  conditions:
    var: item.has_logical_redundancy
    op: equals
    value: ENABLED
- rule_id: aws.directconnect.connection.tunnel_health_monitoring_enabled
  for_each: aws.directconnect.create_bgp_peer
  conditions:
    var: item.virtual_interface_state
    op: equals
    value: AVAILABLE
- rule_id: aws.directconnect.virtual_interface_redundancy.directconnect_virtual_interface_redundancy_configured
  for_each: aws.directconnect.describe_connections
  conditions:
    var: item.has_logical_redundancy
    op: equals
    value: ENABLED
- rule_id: aws.directconnect.connection.pre_shared_keys_key_rotation_policy_configured
  for_each: aws.directconnect.create_bgp_peer
  conditions:
    var: item.auth_key
    op: exists
- rule_id: aws.directconnect.connection.ike_phase_encryption_strong_configured
  for_each: aws.directconnect.create_bgp_peer
  conditions:
    var: item.virtual_interface_state
    op: equals
    value: ENABLED
