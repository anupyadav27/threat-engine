version: '1.0'
provider: aws
service: workflows
discovery:
- discovery_id: aws.workflows.describe_activity
  calls:
  - action: describe_activity
    save_as: describe_activity_response
    params:
      activityArn: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.workflows.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      kms_key_id: '{{ describe_activity_response.encryptionConfiguration.kmsKeyId
        }}'
      kms_data_key_reuse_period_seconds: '{{ describe_activity_response.encryptionConfiguration.kmsDataKeyReusePeriodSeconds
        }}'
      type: '{{ describe_activity_response.encryptionConfiguration.type }}'
- discovery_id: aws.workflows.describe_execution
  calls:
  - action: describe_execution
    save_as: describe_execution_response
    params:
      executionArn: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.workflows.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      included: '{{ describe_execution_response.inputDetails.included }}'
checks:
- rule_id: aws.workflows.workflow.kms_encryption_enabled
  for_each: aws.workflows.describe_activity
  conditions:
    var: item.kms_key_id
    op: exists
- rule_id: aws.workflows.workflow.workflows_artifacts_encrypted_and_private
  for_each: aws.workflows.describe_activity
  conditions:
    all:
    - var: item.kms_key_id
      op: exists
    - var: item.kms_data_key_reuse_period_seconds
      op: gt
      value: 0
- rule_id: aws.workflows.workflow.execution_roles_least_privilege
  for_each: aws.workflows.describe_execution
  conditions:
    var: item.included
    op: equals
    value: true
