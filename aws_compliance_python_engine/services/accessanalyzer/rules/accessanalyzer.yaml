version: '1.0'
provider: aws
service: accessanalyzer
services:
  client: accessanalyzer
  module: boto3.client
discovery:
- discovery_id: aws.accessanalyzer.list_analyzers
  calls:
  - action: list_analyzers
    save_as: response
  emit:
    items_for: '{{ response.analyzers }}'
    as: resource
    item:
      arn: '{{ resource.arn }}'
      name: '{{ resource.name }}'
      type: '{{ resource.type }}'
      createdAt: '{{ resource.createdAt }}'
      lastResourceAnalyzed: '{{ resource.lastResourceAnalyzed }}'
      lastResourceAnalyzedAt: '{{ resource.lastResourceAnalyzedAt }}'
      tags: '{{ resource.tags }}'
      status: '{{ resource.status }}'
      statusReason: '{{ resource.statusReason }}'
      configuration: '{{ resource.configuration }}'
- discovery_id: aws.accessanalyzer.list_analyzed_resources
  calls:
  - action: list_analyzed_resources
    save_as: response
    params:
      analyzerArn: '{{ item.arn }}'
  for_each: aws.accessanalyzer.list_analyzers
  on_error: continue
  emit:
    items_for: '{{ response.analyzedResources }}'
    as: resource
    item:
      analyzerArn: '{{ item.arn }}'
      resourceArn: '{{ resource.resourceArn }}'
      resourceOwnerAccount: '{{ resource.resourceOwnerAccount }}'
      resourceType: '{{ resource.resourceType }}'
- discovery_id: aws.accessanalyzer.get_analyzed_resource
  calls:
  - action: get_analyzed_resource
    save_as: response
    params:
      analyzerArn: '{{ item.analyzerArn }}'
      resourceArn: '{{ item.resourceArn }}'
  for_each: aws.accessanalyzer.list_analyzed_resources
  on_error: continue
  emit:
    item:
      resourceArn: '{{ response.resource.resourceArn }}'
      resourceType: '{{ response.resource.resourceType }}'
      createdAt: '{{ response.resource.createdAt }}'
      analyzedAt: '{{ response.resource.analyzedAt }}'
      updatedAt: '{{ response.resource.updatedAt }}'
      isPublic: '{{ response.resource.isPublic }}'
      actions: '{{ response.resource.actions }}'
      sharedVia: '{{ response.resource.sharedVia }}'
      status: '{{ response.resource.status }}'
      resourceOwnerAccount: '{{ response.resource.resourceOwnerAccount }}'
      error: '{{ response.resource.error }}'
checks:
- rule_id: aws.accessanalyzer.resource.access_analyzer_enabled
  for_each: aws.accessanalyzer.list_analyzers
  conditions:
    var: item.status
    op: equals
    value: ACTIVE
- rule_id: aws.accessanalyzer.resource.access_analyzer_enabled_without_findings
  for_each: aws.accessanalyzer.get_analyzed_resource
  conditions:
    all:
    - var: item.status
      op: exists
    - var: item.status
      op: not_equals
      value: ACTIVE
