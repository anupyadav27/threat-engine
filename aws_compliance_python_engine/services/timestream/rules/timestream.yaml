version: '1.0'
provider: aws
service: timestream
services:
  client: timestream
  module: boto3.client
discovery:
- discovery_id: aws.timestream.describe_endpoints
  calls:
  - action: describe_endpoints
    save_as: response
  emit:
    item:
      Address: '{{ response.Endpoints.Address }}'
      CachePeriodInMinutes: '{{ response.Endpoints.CachePeriodInMinutes }}'
      Endpoints: '{{ resource.Endpoints }}'
- discovery_id: aws.timestream.list_scheduled_queries
  calls:
  - action: list_scheduled_queries
    save_as: response
  emit:
    items_for: '{{ response.ScheduledQueries }}'
    as: resource
    item:
      Arn: '{{ resource.Arn }}'
      Name: '{{ resource.Name }}'
      CreationTime: '{{ resource.CreationTime }}'
      State: '{{ resource.State }}'
      PreviousInvocationTime: '{{ resource.PreviousInvocationTime }}'
      NextInvocationTime: '{{ resource.NextInvocationTime }}'
      ErrorReportConfiguration: '{{ resource.ErrorReportConfiguration }}'
      TargetDestination: '{{ resource.TargetDestination }}'
      LastRunStatus: '{{ resource.LastRunStatus }}'
checks:
- rule_id: aws.timestream.resource.timestream_ingestion_secure_protocol_configured
  for_each: aws.timestream.describe_endpoints
  conditions:
    var: item.Endpoints
    op: not_equals
    value: 'null'
- rule_id: aws.timestream.database.check_encryption_at_rest_enabled
  for_each: aws.timestream.list_scheduled_queries
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.timestream.resource.security_configuration_compliance_configured
  for_each: aws.timestream.list_scheduled_queries
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.timestream.resource.cloudwatch_monitoring_and_alerting_enabled
  for_each: aws.timestream.list_scheduled_queries
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.timestream.database.encryption_at_rest_enabled
  for_each: aws.timestream.list_scheduled_queries
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.timestream.table.require_tls_in_transit_configured
  for_each: aws.timestream.list_scheduled_queries
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.timestream.database.require_tls_in_transit_configured
  for_each: aws.timestream.list_scheduled_queries
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.timestream.table.deletion_protection_enabled
  for_each: aws.timestream.list_scheduled_queries
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.timestream.database.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.timestream.list_scheduled_queries
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.timestream.table.private_network_only_if_supported
  for_each: aws.timestream.describe_endpoints
  conditions:
    var: item.Endpoints
    op: not_equals
    value: 'null'
- rule_id: aws.timestream.table.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.timestream.list_scheduled_queries
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.timestream.resource.iam_fine_grained_access_control_enabled
  for_each: aws.timestream.list_scheduled_queries
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.timestream.table.public_access_disabled
  for_each: aws.timestream.list_scheduled_queries
  conditions:
    var: item.State
    op: not_equals
    value: ENABLED
- rule_id: aws.timestream.database.public_access_disabled
  for_each: aws.timestream.list_scheduled_queries
  conditions:
    var: item.State
    op: equals
    value: DISABLED
- rule_id: aws.timestream.resource.cloudtrail_management_and_data_logging_enabled
  for_each: aws.timestream.list_scheduled_queries
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.timestream.database.deletion_protection_enabled
  for_each: aws.timestream.list_scheduled_queries
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.timestream.table.rbac_least_privilege
  for_each: aws.timestream.list_scheduled_queries
  conditions:
    var: item.State
    op: not_equals
    value: DISABLED
- rule_id: aws.timestream.table.encryption_at_rest_enabled
  for_each: aws.timestream.list_scheduled_queries
  conditions:
    var: item.State
    op: equals
    value: ENABLED
