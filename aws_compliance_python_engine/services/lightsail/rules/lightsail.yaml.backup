version: '1.0'
provider: aws
service: lightsail
discovery:
- discovery_id: aws.lightsail.get_alarms
  calls:
  - action: get_alarms
    save_as: get_alarms_response
  emit:
    items_for: '{{ get_alarms_response.alarms }}'
    as: resource
    item:
      name: '{{ resource.name }}'
      arn: '{{ resource.arn }}'
      created_at: '{{ resource.createdAt }}'
      location: '{{ resource.location }}'
      resource_type: '{{ resource.resourceType }}'
      support_code: '{{ resource.supportCode }}'
      monitored_resource_info: '{{ resource.monitoredResourceInfo }}'
      comparison_operator: '{{ resource.comparisonOperator }}'
      evaluation_periods: '{{ resource.evaluationPeriods }}'
      period: '{{ resource.period }}'
- discovery_id: aws.lightsail.get_relational_database_bundles
  calls:
  - action: get_relational_database_bundles
    save_as: get_relational_database_bundles_response
  emit:
    items_for: '{{ get_relational_database_bundles_response.bundles }}'
    as: resource
    item:
      bundle_id: '{{ resource.bundleId }}'
      name: '{{ resource.name }}'
      price: '{{ resource.price }}'
      ram_size_in_gb: '{{ resource.ramSizeInGb }}'
      disk_size_in_gb: '{{ resource.diskSizeInGb }}'
      transfer_per_month_in_gb: '{{ resource.transferPerMonthInGb }}'
      cpu_count: '{{ resource.cpuCount }}'
      is_encrypted: '{{ resource.isEncrypted }}'
      is_active: '{{ resource.isActive }}'
- discovery_id: aws.lightsail.get_instances
  calls:
  - action: get_instances
    save_as: get_instances_response
  emit:
    items_for: '{{ get_instances_response.instances }}'
    as: resource
    item:
      name: '{{ resource.name }}'
      arn: '{{ resource.arn }}'
      support_code: '{{ resource.supportCode }}'
      created_at: '{{ resource.createdAt }}'
      location: '{{ resource.location }}'
      resource_type: '{{ resource.resourceType }}'
      tags: '{{ resource.tags }}'
      blueprint_id: '{{ resource.blueprintId }}'
      blueprint_name: '{{ resource.blueprintName }}'
      bundle_id: '{{ resource.bundleId }}'
- discovery_id: aws.lightsail.create_container_service_registry_login
  calls:
  - action: create_container_service_registry_login
    save_as: create_container_service_registry_login_response
  emit:
    items_for: '{{ create_container_service_registry_login_response.registryLogin
      }}'
    as: resource
    item:
      username: '{{ resource.username }}'
      password: '{{ resource.password }}'
      expires_at: '{{ resource.expiresAt }}'
      registry: '{{ resource.registry }}'
- discovery_id: aws.lightsail.get_disks
  calls:
  - action: get_disks
    save_as: get_disks_response
  emit:
    items_for: '{{ get_disks_response.disks }}'
    as: resource
    item:
      name: '{{ resource.name }}'
      arn: '{{ resource.arn }}'
      support_code: '{{ resource.supportCode }}'
      created_at: '{{ resource.createdAt }}'
      location: '{{ resource.location }}'
      resource_type: '{{ resource.resourceType }}'
      tags: '{{ resource.tags }}'
      add_ons: '{{ resource.addOns }}'
      size_in_gb: '{{ resource.sizeInGb }}'
      is_system_disk: '{{ resource.isSystemDisk }}'
checks:
- rule_id: aws.lightsail.database.public_access_disabled
  for_each: aws.lightsail.get_alarms
  conditions:
    var: item.state
    op: equals
    value: PRIVATE
- rule_id: aws.lightsail.database.require_tls_in_transit_configured
  for_each: aws.lightsail.get_alarms
  conditions:
    var: item.state
    op: equals
    value: ENABLED
- rule_id: aws.lightsail.database.encryption_at_rest_enabled
  for_each: aws.lightsail.get_relational_database_bundles
  conditions:
    var: item.is_encrypted
    op: equals
    value: true
- rule_id: aws.lightsail.instance.no_public_ip_unless_required
  for_each: aws.lightsail.get_instances
  conditions:
    var: item.public_ip_address
    op: equals
- rule_id: aws.lightsail.instance.ssh_password_auth_disabled
  for_each: aws.lightsail.create_container_service_registry_login
  conditions:
    var: item.password
    op: equals
- rule_id: aws.lightsail.instance.lightsail_disk_encrypted
  for_each: aws.lightsail.get_disks
  conditions:
    var: item.is_attached
    op: equals
    value: true
