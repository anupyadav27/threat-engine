version: '1.0'
provider: aws
service: lightsail
services:
  client: lightsail
  module: boto3.client
discovery:
- discovery_id: aws.lightsail.get_relational_databases
  calls:
  - action: get_relational_databases
    save_as: response
  emit:
    item:
      name: '{{ response.relationalDatabases.name }}'
      arn: '{{ response.relationalDatabases.arn }}'
      supportCode: '{{ response.relationalDatabases.supportCode }}'
      createdAt: '{{ response.relationalDatabases.createdAt }}'
      location: '{{ response.relationalDatabases.location }}'
      resourceType: '{{ response.relationalDatabases.resourceType }}'
      tags: '{{ response.relationalDatabases.tags }}'
      relationalDatabaseBlueprintId: '{{ response.relationalDatabases.relationalDatabaseBlueprintId
        }}'
      relationalDatabaseBundleId: '{{ response.relationalDatabases.relationalDatabaseBundleId
        }}'
      masterDatabaseName: '{{ response.relationalDatabases.masterDatabaseName }}'
      hardware: '{{ response.relationalDatabases.hardware }}'
      state: '{{ response.relationalDatabases.state }}'
      secondaryAvailabilityZone: '{{ response.relationalDatabases.secondaryAvailabilityZone
        }}'
      backupRetentionEnabled: '{{ response.relationalDatabases.backupRetentionEnabled
        }}'
      pendingModifiedValues: '{{ response.relationalDatabases.pendingModifiedValues
        }}'
      engine: '{{ response.relationalDatabases.engine }}'
      engineVersion: '{{ response.relationalDatabases.engineVersion }}'
      latestRestorableTime: '{{ response.relationalDatabases.latestRestorableTime
        }}'
      masterUsername: '{{ response.relationalDatabases.masterUsername }}'
      parameterApplyStatus: '{{ response.relationalDatabases.parameterApplyStatus
        }}'
      preferredBackupWindow: '{{ response.relationalDatabases.preferredBackupWindow
        }}'
      preferredMaintenanceWindow: '{{ response.relationalDatabases.preferredMaintenanceWindow
        }}'
      publiclyAccessible: '{{ response.relationalDatabases.publiclyAccessible }}'
      masterEndpoint: '{{ response.relationalDatabases.masterEndpoint }}'
      pendingMaintenanceActions: '{{ response.relationalDatabases.pendingMaintenanceActions
        }}'
      caCertificateIdentifier: '{{ response.relationalDatabases.caCertificateIdentifier
        }}'
- discovery_id: aws.lightsail.get_distributions
  calls:
  - action: get_distributions
    save_as: response
  emit:
    item:
      name: '{{ response.distributions.name }}'
      arn: '{{ response.distributions.arn }}'
      supportCode: '{{ response.distributions.supportCode }}'
      createdAt: '{{ response.distributions.createdAt }}'
      location: '{{ response.distributions.location }}'
      resourceType: '{{ response.distributions.resourceType }}'
      alternativeDomainNames: '{{ response.distributions.alternativeDomainNames }}'
      status: '{{ response.distributions.status }}'
      isEnabled: '{{ response.distributions.isEnabled }}'
      domainName: '{{ response.distributions.domainName }}'
      bundleId: '{{ response.distributions.bundleId }}'
      certificateName: '{{ response.distributions.certificateName }}'
      origin: '{{ response.distributions.origin }}'
      originPublicDNS: '{{ response.distributions.originPublicDNS }}'
      defaultCacheBehavior: '{{ response.distributions.defaultCacheBehavior }}'
      cacheBehaviorSettings: '{{ response.distributions.cacheBehaviorSettings }}'
      cacheBehaviors: '{{ response.distributions.cacheBehaviors }}'
      ableToUpdateBundle: '{{ response.distributions.ableToUpdateBundle }}'
      ipAddressType: '{{ response.distributions.ipAddressType }}'
      tags: '{{ response.distributions.tags }}'
      viewerMinimumTlsProtocolVersion: '{{ response.distributions.viewerMinimumTlsProtocolVersion
        }}'
- discovery_id: aws.lightsail.get_relational_database_bundles
  calls:
  - action: get_relational_database_bundles
    save_as: response
  emit:
    item:
      bundleId: '{{ response.bundles.bundleId }}'
      name: '{{ response.bundles.name }}'
      price: '{{ response.bundles.price }}'
      ramSizeInGb: '{{ response.bundles.ramSizeInGb }}'
      diskSizeInGb: '{{ response.bundles.diskSizeInGb }}'
      transferPerMonthInGb: '{{ response.bundles.transferPerMonthInGb }}'
      cpuCount: '{{ response.bundles.cpuCount }}'
      isEncrypted: '{{ response.bundles.isEncrypted }}'
      isActive: '{{ response.bundles.isActive }}'
- discovery_id: aws.lightsail.get_instances
  calls:
  - action: get_instances
    save_as: response
  emit:
    item:
      name: '{{ response.instances.name }}'
      arn: '{{ response.instances.arn }}'
      supportCode: '{{ response.instances.supportCode }}'
      createdAt: '{{ response.instances.createdAt }}'
      location: '{{ response.instances.location }}'
      resourceType: '{{ response.instances.resourceType }}'
      tags: '{{ response.instances.tags }}'
      blueprintId: '{{ response.instances.blueprintId }}'
      blueprintName: '{{ response.instances.blueprintName }}'
      bundleId: '{{ response.instances.bundleId }}'
      addOns: '{{ response.instances.addOns }}'
      isStaticIp: '{{ response.instances.isStaticIp }}'
      privateIpAddress: '{{ response.instances.privateIpAddress }}'
      publicIpAddress: '{{ response.instances.publicIpAddress }}'
      ipv6Addresses: '{{ response.instances.ipv6Addresses }}'
      ipAddressType: '{{ response.instances.ipAddressType }}'
      hardware: '{{ response.instances.hardware }}'
      networking: '{{ response.instances.networking }}'
      state: '{{ response.instances.state }}'
      username: '{{ response.instances.username }}'
      sshKeyName: '{{ response.instances.sshKeyName }}'
      metadataOptions: '{{ response.instances.metadataOptions }}'
- discovery_id: aws.lightsail.get_container_services
  calls:
  - action: get_container_services
    save_as: response
  emit:
    item:
      containerServiceName: '{{ response.containerServices.containerServiceName }}'
      arn: '{{ response.containerServices.arn }}'
      createdAt: '{{ response.containerServices.createdAt }}'
      location: '{{ response.containerServices.location }}'
      resourceType: '{{ response.containerServices.resourceType }}'
      tags: '{{ response.containerServices.tags }}'
      power: '{{ response.containerServices.power }}'
      powerId: '{{ response.containerServices.powerId }}'
      state: '{{ response.containerServices.state }}'
      stateDetail: '{{ response.containerServices.stateDetail }}'
      scale: '{{ response.containerServices.scale }}'
      currentDeployment: '{{ response.containerServices.currentDeployment }}'
      nextDeployment: '{{ response.containerServices.nextDeployment }}'
      isDisabled: '{{ response.containerServices.isDisabled }}'
      principalArn: '{{ response.containerServices.principalArn }}'
      privateDomainName: '{{ response.containerServices.privateDomainName }}'
      publicDomainNames: '{{ response.containerServices.publicDomainNames }}'
      url: '{{ response.containerServices.url }}'
      privateRegistryAccess: '{{ response.containerServices.privateRegistryAccess
        }}'
checks:
- rule_id: aws.lightsail.database.public_access_disabled
  for_each: aws.lightsail.get_relational_databases
  conditions:
    var: item.publiclyAccessible
    op: equals
    value: 'false'
- rule_id: aws.lightsail.database.require_tls_in_transit_configured
  for_each: aws.lightsail.get_distributions
  conditions:
    var: item.viewerMinimumTlsProtocolVersion
    op: not_equals
    value: 'null'
- rule_id: aws.lightsail.database.encryption_at_rest_enabled
  for_each: aws.lightsail.get_relational_database_bundles
  conditions:
    var: item.isEncrypted
    op: equals
    value: 'true'
- rule_id: aws.lightsail.instance.no_public_ip_unless_required
  for_each: aws.lightsail.get_instances
  conditions:
    var: item.publicIpAddress
    op: not_equals
    value: 'null'
- rule_id: aws.lightsail.instance.ssh_password_auth_disabled
  for_each: aws.lightsail.get_container_services
  conditions:
    var: item.isDisabled
    op: equals
    value: true
- rule_id: aws.lightsail.instance.lightsail_disk_encrypted
  for_each: aws.lightsail.get_relational_database_bundles
  conditions:
    var: item.isEncrypted
    op: equals
    value: 'true'
