version: '1.0'
provider: aws
service: lightsail
discovery:
- discovery_id: aws.lightsail.databases
  calls:
  - client: lightsail
    action: list_lightsails
    save_as: database_list
    on_error: continue
    fields:
    - Lightsails
  emit:
    items_for: database_list[]
    as: database
    item:
      id: '{{ database.Id }}'
      name: '{{ database.Name }}'
- discovery_id: aws.lightsail.database_encryption
  for_each: aws.lightsail.databases
  calls:
  - client: lightsail
    action: list_lightsails
    params:
      DatabaseId: '{{ item.id }}'
    save_as: encryption
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      encryption_enabled: '{{ encryption.Encrypted if encryption.Encrypted is defined
        else false }}'
- discovery_id: aws.lightsail.instance_encryption
  calls:
  - client: lightsail
    action: get_instance
    save_as: instance_encryption
    on_error: continue
  emit:
    items_for: instance_encryption[]
    as: instance_encryption
    item:
      id: '{{ instance_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.lightsail.instances
  for_each: aws.lightsail.instance
  calls:
  - client: lightsail
    action: describe_db_instances
    save_as: instances
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
checks:
- title: 'LIGHTSAIL database: Public Access Disabled'
  severity: high
  rule_id: aws.lightsail.database.public_access_disabled
  for_each:
    discovery: aws.lightsail.databases
    as: database
    item: database
  conditions:
    var: database.is_public
    op: equals
    value: false
- title: 'LIGHTSAIL database: Require Tls In Transit Configured'
  severity: high
  rule_id: aws.lightsail.database.require_tls_in_transit_configured
  for_each:
    discovery: aws.lightsail.databases
    as: database
    item: database
  conditions:
    var: database.in_vpc
    op: equals
    value: true
- title: 'LIGHTSAIL database: Encryption At Rest Enabled'
  severity: high
  rule_id: aws.lightsail.database.encryption_at_rest_enabled
  for_each:
    discovery: aws.lightsail.database_encryption
    as: database
    item: database
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'LIGHTSAIL instance: No Public Ip Unless Required'
  severity: high
  rule_id: aws.lightsail.instance.no_public_ip_unless_required
  for_each:
    discovery: aws.lightsail.instances
    as: instance
    item: instance
  conditions:
    var: instance.is_public
    op: equals
    value: false
- title: 'LIGHTSAIL instance: Ssh Password Auth Disabled'
  severity: critical
  rule_id: aws.lightsail.instance.ssh_password_auth_disabled
  for_each:
    discovery: aws.lightsail.instances
    as: instance
    item: instance
  conditions:
    var: instance.compliant
    op: equals
    value: true
- title: 'LIGHTSAIL instance: Lightsail Disk Encrypted'
  severity: high
  rule_id: aws.lightsail.instance.lightsail_disk_encrypted
  for_each:
    discovery: aws.lightsail.instance_encryption
    as: instance
    item: instance
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
