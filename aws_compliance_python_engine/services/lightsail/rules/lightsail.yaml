version: '1.0'
provider: aws
service: lightsail
services:
  client: lightsail
  module: boto3.client
discovery:
- discovery_id: aws.lightsail.create_container_service_registry_login
  calls:
  - action: create_container_service_registry_login
    save_as: response
  emit:
    item:
      username: '{{ response.registryLogin.username }}'
      password: '{{ response.registryLogin.password }}'
      expiresAt: '{{ response.registryLogin.expiresAt }}'
      registry: '{{ response.registryLogin.registry }}'
- discovery_id: aws.lightsail.get_alarms
  calls:
  - action: get_alarms
    save_as: response
  emit:
    item:
      name: '{{ response.alarms.name }}'
      arn: '{{ response.alarms.arn }}'
      createdAt: '{{ response.alarms.createdAt }}'
      location: '{{ response.alarms.location }}'
      resourceType: '{{ response.alarms.resourceType }}'
      supportCode: '{{ response.alarms.supportCode }}'
      monitoredResourceInfo: '{{ response.alarms.monitoredResourceInfo }}'
      comparisonOperator: '{{ response.alarms.comparisonOperator }}'
      evaluationPeriods: '{{ response.alarms.evaluationPeriods }}'
      period: '{{ response.alarms.period }}'
      threshold: '{{ response.alarms.threshold }}'
      datapointsToAlarm: '{{ response.alarms.datapointsToAlarm }}'
      treatMissingData: '{{ response.alarms.treatMissingData }}'
      statistic: '{{ response.alarms.statistic }}'
      metricName: '{{ response.alarms.metricName }}'
      state: '{{ response.alarms.state }}'
      unit: '{{ response.alarms.unit }}'
      contactProtocols: '{{ response.alarms.contactProtocols }}'
      notificationTriggers: '{{ response.alarms.notificationTriggers }}'
      notificationEnabled: '{{ response.alarms.notificationEnabled }}'
- discovery_id: aws.lightsail.get_disks
  calls:
  - action: get_disks
    save_as: response
  emit:
    item:
      name: '{{ response.disks.name }}'
      arn: '{{ response.disks.arn }}'
      supportCode: '{{ response.disks.supportCode }}'
      createdAt: '{{ response.disks.createdAt }}'
      location: '{{ response.disks.location }}'
      resourceType: '{{ response.disks.resourceType }}'
      tags: '{{ response.disks.tags }}'
      addOns: '{{ response.disks.addOns }}'
      sizeInGb: '{{ response.disks.sizeInGb }}'
      isSystemDisk: '{{ response.disks.isSystemDisk }}'
      iops: '{{ response.disks.iops }}'
      path: '{{ response.disks.path }}'
      state: '{{ response.disks.state }}'
      attachedTo: '{{ response.disks.attachedTo }}'
      isAttached: '{{ response.disks.isAttached }}'
      attachmentState: '{{ response.disks.attachmentState }}'
      gbInUse: '{{ response.disks.gbInUse }}'
      autoMountStatus: '{{ response.disks.autoMountStatus }}'
- discovery_id: aws.lightsail.get_instances
  calls:
  - action: get_instances
    save_as: response
  emit:
    item:
      name: '{{ response.instances.name }}'
      arn: '{{ response.instances.arn }}'
      supportCode: '{{ response.instances.supportCode }}'
      createdAt: '{{ response.instances.createdAt }}'
      location: '{{ response.instances.location }}'
      resourceType: '{{ response.instances.resourceType }}'
      tags: '{{ response.instances.tags }}'
      blueprintId: '{{ response.instances.blueprintId }}'
      blueprintName: '{{ response.instances.blueprintName }}'
      bundleId: '{{ response.instances.bundleId }}'
      addOns: '{{ response.instances.addOns }}'
      isStaticIp: '{{ response.instances.isStaticIp }}'
      privateIpAddress: '{{ response.instances.privateIpAddress }}'
      publicIpAddress: '{{ response.instances.publicIpAddress }}'
      ipv6Addresses: '{{ response.instances.ipv6Addresses }}'
      ipAddressType: '{{ response.instances.ipAddressType }}'
      hardware: '{{ response.instances.hardware }}'
      networking: '{{ response.instances.networking }}'
      state: '{{ response.instances.state }}'
      username: '{{ response.instances.username }}'
      sshKeyName: '{{ response.instances.sshKeyName }}'
      metadataOptions: '{{ response.instances.metadataOptions }}'
- discovery_id: aws.lightsail.get_relational_database_bundles
  calls:
  - action: get_relational_database_bundles
    save_as: response
  emit:
    item:
      bundleId: '{{ response.bundles.bundleId }}'
      name: '{{ response.bundles.name }}'
      price: '{{ response.bundles.price }}'
      ramSizeInGb: '{{ response.bundles.ramSizeInGb }}'
      diskSizeInGb: '{{ response.bundles.diskSizeInGb }}'
      transferPerMonthInGb: '{{ response.bundles.transferPerMonthInGb }}'
      cpuCount: '{{ response.bundles.cpuCount }}'
      isEncrypted: '{{ response.bundles.isEncrypted }}'
      isActive: '{{ response.bundles.isActive }}'
checks:
- rule_id: aws.lightsail.database.public_access_disabled
  for_each: aws.lightsail.get_alarms
  conditions:
    var: item.state
    op: equals
    value: PRIVATE
- rule_id: aws.lightsail.database.require_tls_in_transit_configured
  for_each: aws.lightsail.get_alarms
  conditions:
    var: item.state
    op: equals
    value: ENABLED
- rule_id: aws.lightsail.database.encryption_at_rest_enabled
  for_each: aws.lightsail.get_relational_database_bundles
  conditions:
    var: item.isEncrypted
    op: equals
    value: true
- rule_id: aws.lightsail.instance.no_public_ip_unless_required
  for_each: aws.lightsail.get_instances
  conditions:
    var: item.publicIpAddress
    op: equals
- rule_id: aws.lightsail.instance.ssh_password_auth_disabled
  for_each: aws.lightsail.create_container_service_registry_login
  conditions:
    var: item.password
    op: equals
- rule_id: aws.lightsail.instance.lightsail_disk_encrypted
  for_each: aws.lightsail.get_disks
  conditions:
    var: item.isAttached
    op: equals
    value: true
