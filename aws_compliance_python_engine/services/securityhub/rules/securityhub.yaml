version: '1.0'
provider: aws
service: securityhub
services:
  client: securityhub
  module: boto3.client
discovery:
- discovery_id: aws.securityhub.describe_action_targets
  calls:
  - action: describe_action_targets
    save_as: response
  emit:
    item:
      ActionTargetArn: '{{ response.ActionTargets.ActionTargetArn }}'
      Name: '{{ response.ActionTargets.Name }}'
      Description: '{{ response.ActionTargets.Description }}'
- discovery_id: aws.securityhub.describe_organization_configuration
  calls:
  - action: describe_organization_configuration
    save_as: response
  emit:
    item:
      ConfigurationType: '{{ response.OrganizationConfiguration.ConfigurationType
        }}'
      Status: '{{ response.OrganizationConfiguration.Status }}'
      StatusMessage: '{{ response.OrganizationConfiguration.StatusMessage }}'
- discovery_id: aws.securityhub.get_administrator_account
  calls:
  - action: get_administrator_account
    save_as: response
  emit:
    item:
      AccountId: '{{ response.Administrator.AccountId }}'
      InvitationId: '{{ response.Administrator.InvitationId }}'
      InvitedAt: '{{ response.Administrator.InvitedAt }}'
      MemberStatus: '{{ response.Administrator.MemberStatus }}'
- discovery_id: aws.securityhub.list_automation_rules
  calls:
  - action: list_automation_rules
    save_as: response
  emit:
    items_for: '{{ response.AutomationRulesMetadata }}'
    as: resource
    item:
      RuleArn: '{{ resource.RuleArn }}'
      RuleStatus: '{{ resource.RuleStatus }}'
      RuleOrder: '{{ resource.RuleOrder }}'
      RuleName: '{{ resource.RuleName }}'
      Description: '{{ resource.Description }}'
      IsTerminal: '{{ resource.IsTerminal }}'
      CreatedAt: '{{ resource.CreatedAt }}'
      UpdatedAt: '{{ resource.UpdatedAt }}'
      CreatedBy: '{{ resource.CreatedBy }}'
- discovery_id: aws.securityhub.list_configuration_policies
  calls:
  - action: list_configuration_policies
    save_as: response
  emit:
    items_for: '{{ response.ConfigurationPolicySummaries }}'
    as: resource
    item:
      Arn: '{{ resource.Arn }}'
      Id: '{{ resource.Id }}'
      Name: '{{ resource.Name }}'
      Description: '{{ resource.Description }}'
      UpdatedAt: '{{ resource.UpdatedAt }}'
      ServiceEnabled: '{{ resource.ServiceEnabled }}'
checks:
- rule_id: aws.securityhub.finding.alert_destinations_configured
  for_each: aws.securityhub.describe_action_targets
  conditions:
    var: item.ActionTargetArn
    op: exists
- rule_id: aws.securityhub.hub.securityhub_detectors_enabled
  for_each: aws.securityhub.describe_organization_configuration
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.securityhub.finding.securityhub_archival_export_encrypted
  for_each: aws.securityhub.describe_organization_configuration
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.securityhub.resource.securityhub_resource_enabled
  for_each: aws.securityhub.list_configuration_policies
  conditions:
    var: item.ServiceEnabled
    op: equals
    value: true
- rule_id: aws.securityhub.action.rbac_least_privilege
  for_each: aws.securityhub.list_automation_rules
  conditions:
    var: item.RuleStatus
    op: equals
    value: ENABLED
- rule_id: aws.securityhub.hub.securityhub_enabled_in_all_regions
  for_each: aws.securityhub.describe_organization_configuration
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.securityhub.action.versioning_and_immutability_enabled
  for_each: aws.securityhub.list_automation_rules
  conditions:
    var: item.RuleStatus
    op: equals
    value: ENABLED
- rule_id: aws.securityhub.hub.securityhub_master_member_configured
  for_each: aws.securityhub.get_administrator_account
  conditions:
    var: item.MemberStatus
    op: equals
    value: ENABLED
- rule_id: aws.securityhub.hub.securityhub_finding_export_encrypted_destination
  for_each: aws.securityhub.describe_organization_configuration
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.securityhub.hub.securityhub_destinations_encrypted
  for_each: aws.securityhub.describe_organization_configuration
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.securityhub.hub.securityhub_auto_enroll_new_accounts_configured
  for_each: aws.securityhub.describe_organization_configuration
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.securityhub.resource.securityhub_hub_enabled_in_all_regions
  for_each: aws.securityhub.describe_organization_configuration
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
