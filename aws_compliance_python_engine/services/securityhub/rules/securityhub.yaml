version: '1.0'
provider: aws
service: securityhub
discovery:
- discovery_id: aws.securityhub.actions
  calls:
  - client: securityhub
    action: describe_hub
    save_as: action_list
    on_error: continue
    fields:
    - Securityhubs
  emit:
    items_for: action_list[]
    as: action
    item:
      id: '{{ action.Id }}'
      name: '{{ action.Name }}'
- discovery_id: aws.securityhub.action_encryption
  for_each: aws.securityhub.actions
  calls:
  - client: securityhub
    action: describe_hub
    params:
      ActionId: '{{ item.id }}'
    save_as: encryption
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      encryption_enabled: '{{ encryption.Encrypted if encryption.Encrypted is defined
        else false }}'
- discovery_id: aws.securityhub.hubs
  for_each: aws.securityhub.hub
  calls:
  - client: securityhub
    action: describe_action_targets
    save_as: hubs
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.securityhub.finding_encryption
  calls:
  - client: securityhub
    action: list_aggregators_v2
    save_as: finding_encryption
    on_error: continue
  emit:
    items_for: finding_encryption[]
    as: finding_encryption
    item:
      id: '{{ finding_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.securityhub.findings
  for_each: aws.securityhub.finding
  calls:
  - client: securityhub
    action: describe_action_targets
    save_as: findings
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.securityhub.hub_encryption
  calls:
  - client: securityhub
    action: list_aggregators_v2
    save_as: hub_encryption
    on_error: continue
  emit:
    items_for: hub_encryption[]
    as: hub_encryption
    item:
      id: '{{ hub_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.securityhub.resources
  for_each: aws.securityhub.resource
  calls:
  - client: securityhub
    action: describe_action_targets
    save_as: resources
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
checks:
- title: 'SECURITYHUB finding: Alert Destinations Configured'
  severity: medium
  rule_id: aws.securityhub.finding.alert_destinations_configured
  for_each:
    discovery: aws.securityhub.findings
    as: finding
    item: finding
  conditions:
    var: finding.monitoring_enabled
    op: equals
    value: true
- title: 'SECURITYHUB finding: Securityhub Suppression Rules Documented And Scoped
    Configured'
  severity: medium
  rule_id: aws.securityhub.finding.securityhub_suppression_rules_documented_and_scoped_configured
  for_each:
    discovery: aws.securityhub.findings
    as: finding
    item: finding
  conditions:
    var: finding.compliant
    op: equals
    value: true
- title: 'SECURITYHUB hub: Securityhub Detectors Enabled'
  severity: medium
  rule_id: aws.securityhub.hub.securityhub_detectors_enabled
  for_each:
    discovery: aws.securityhub.hubs
    as: hub
    item: hub
  conditions:
    var: hub.compliant
    op: equals
    value: true
- title: 'SECURITYHUB finding: Securityhub Archival Export Encrypted'
  severity: high
  rule_id: aws.securityhub.finding.securityhub_archival_export_encrypted
  for_each:
    discovery: aws.securityhub.finding_encryption
    as: finding
    item: finding
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'SECURITYHUB resource: Securityhub Resource Enabled'
  severity: medium
  rule_id: aws.securityhub.resource.securityhub_resource_enabled
  for_each:
    discovery: aws.securityhub.resources
    as: resource
    item: resource
  conditions:
    var: resource.compliant
    op: equals
    value: true
- title: 'SECURITYHUB action: Rbac Least Privilege'
  severity: high
  rule_id: aws.securityhub.action.rbac_least_privilege
  for_each:
    discovery: aws.securityhub.actions
    as: action
    item: action
  conditions:
    var: action.is_public
    op: equals
    value: false
- title: 'SECURITYHUB hub: Securityhub Enabled In All Regions'
  severity: medium
  rule_id: aws.securityhub.hub.securityhub_enabled_in_all_regions
  for_each:
    discovery: aws.securityhub.hubs
    as: hub
    item: hub
  conditions:
    var: hub.compliant
    op: equals
    value: true
- title: 'SECURITYHUB action: Versioning And Immutability Enabled'
  severity: low
  rule_id: aws.securityhub.action.versioning_and_immutability_enabled
  for_each:
    discovery: aws.securityhub.actions
    as: action
    item: action
  conditions:
    var: action.versioning_enabled
    op: equals
    value: true
- title: 'SECURITYHUB hub: Securityhub Master Member Configured'
  severity: medium
  rule_id: aws.securityhub.hub.securityhub_master_member_configured
  for_each:
    discovery: aws.securityhub.hubs
    as: hub
    item: hub
  conditions:
    var: hub.compliant
    op: equals
    value: true
- title: 'SECURITYHUB hub: Securityhub Finding Export Encrypted Destination'
  severity: high
  rule_id: aws.securityhub.hub.securityhub_finding_export_encrypted_destination
  for_each:
    discovery: aws.securityhub.hub_encryption
    as: hub
    item: hub
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'SECURITYHUB hub: Securityhub Destinations Encrypted'
  severity: high
  rule_id: aws.securityhub.hub.securityhub_destinations_encrypted
  for_each:
    discovery: aws.securityhub.hub_encryption
    as: hub
    item: hub
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'SECURITYHUB hub: Securityhub Auto Enroll New Accounts Configured'
  severity: medium
  rule_id: aws.securityhub.hub.securityhub_auto_enroll_new_accounts_configured
  for_each:
    discovery: aws.securityhub.hubs
    as: hub
    item: hub
  conditions:
    var: hub.compliant
    op: equals
    value: true
- title: 'SECURITYHUB action: Securityhub Storage Encrypted And Private'
  severity: high
  rule_id: aws.securityhub.action.securityhub_storage_encrypted_and_private
  for_each:
    discovery: aws.securityhub.action_encryption
    as: action
    item: action
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'SECURITYHUB resource: Securityhub Hub Enabled In All Regions'
  severity: medium
  rule_id: aws.securityhub.resource.securityhub_hub_enabled_in_all_regions
  for_each:
    discovery: aws.securityhub.resources
    as: resource
    item: resource
  conditions:
    var: resource.compliant
    op: equals
    value: true
