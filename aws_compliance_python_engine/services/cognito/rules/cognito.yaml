version: '1.0'
provider: aws
service: cognito
services:
  client: cognito
  module: boto3.client
discovery:
- discovery_id: aws.cognito.describe_user_pool
  calls:
  - action: describe_user_pool
    save_as: response
  emit:
    item:
      Id: '{{ response.UserPool.Id }}'
      Name: '{{ response.UserPool.Name }}'
      Policies: '{{ response.UserPool.Policies }}'
      DeletionProtection: '{{ response.UserPool.DeletionProtection }}'
      LambdaConfig: '{{ response.UserPool.LambdaConfig }}'
      Status: '{{ response.UserPool.Status }}'
      LastModifiedDate: '{{ response.UserPool.LastModifiedDate }}'
      CreationDate: '{{ response.UserPool.CreationDate }}'
      SchemaAttributes: '{{ response.UserPool.SchemaAttributes }}'
      AutoVerifiedAttributes: '{{ response.UserPool.AutoVerifiedAttributes }}'
      AliasAttributes: '{{ response.UserPool.AliasAttributes }}'
      UsernameAttributes: '{{ response.UserPool.UsernameAttributes }}'
      SmsVerificationMessage: '{{ response.UserPool.SmsVerificationMessage }}'
      EmailVerificationMessage: '{{ response.UserPool.EmailVerificationMessage }}'
      EmailVerificationSubject: '{{ response.UserPool.EmailVerificationSubject }}'
      VerificationMessageTemplate: '{{ response.UserPool.VerificationMessageTemplate
        }}'
      SmsAuthenticationMessage: '{{ response.UserPool.SmsAuthenticationMessage }}'
      UserAttributeUpdateSettings: '{{ response.UserPool.UserAttributeUpdateSettings
        }}'
      MfaConfiguration: '{{ response.UserPool.MfaConfiguration }}'
      DeviceConfiguration: '{{ response.UserPool.DeviceConfiguration }}'
      EstimatedNumberOfUsers: '{{ response.UserPool.EstimatedNumberOfUsers }}'
      EmailConfiguration: '{{ response.UserPool.EmailConfiguration }}'
      SmsConfiguration: '{{ response.UserPool.SmsConfiguration }}'
      UserPoolTags: '{{ response.UserPool.UserPoolTags }}'
      SmsConfigurationFailure: '{{ response.UserPool.SmsConfigurationFailure }}'
      EmailConfigurationFailure: '{{ response.UserPool.EmailConfigurationFailure }}'
      Domain: '{{ response.UserPool.Domain }}'
      CustomDomain: '{{ response.UserPool.CustomDomain }}'
      AdminCreateUserConfig: '{{ response.UserPool.AdminCreateUserConfig }}'
      UserPoolAddOns: '{{ response.UserPool.UserPoolAddOns }}'
      UsernameConfiguration: '{{ response.UserPool.UsernameConfiguration }}'
      Arn: '{{ response.UserPool.Arn }}'
      AccountRecoverySetting: '{{ response.UserPool.AccountRecoverySetting }}'
      UserPoolTier: '{{ response.UserPool.UserPoolTier }}'
- discovery_id: aws.cognito.describe_managed_login_branding
  calls:
  - action: describe_managed_login_branding
    save_as: response
  emit:
    item:
      ManagedLoginBrandingId: '{{ response.ManagedLoginBranding.ManagedLoginBrandingId
        }}'
      UserPoolId: '{{ response.ManagedLoginBranding.UserPoolId }}'
      UseCognitoProvidedValues: '{{ response.ManagedLoginBranding.UseCognitoProvidedValues
        }}'
      Settings: '{{ response.ManagedLoginBranding.Settings }}'
      Assets: '{{ response.ManagedLoginBranding.Assets }}'
      CreationDate: '{{ response.ManagedLoginBranding.CreationDate }}'
      LastModifiedDate: '{{ response.ManagedLoginBranding.LastModifiedDate }}'
- discovery_id: aws.cognito.get_user_pool_mfa_config
  calls:
  - action: get_user_pool_mfa_config
    save_as: response
  emit:
    item:
      SmsAuthenticationMessage: '{{ response.SmsMfaConfiguration.SmsAuthenticationMessage
        }}'
      SmsConfiguration: '{{ response.SmsMfaConfiguration.SmsConfiguration }}'
      MfaConfiguration: '{{ resource.MfaConfiguration }}'
- discovery_id: aws.cognito.list_users
  calls:
  - action: list_users
    save_as: response
  emit:
    items_for: '{{ response.Users }}'
    as: resource
    item:
      Username: '{{ resource.Username }}'
      Attributes: '{{ resource.Attributes }}'
      UserCreateDate: '{{ resource.UserCreateDate }}'
      UserLastModifiedDate: '{{ resource.UserLastModifiedDate }}'
      Enabled: '{{ resource.Enabled }}'
      UserStatus: '{{ resource.UserStatus }}'
      MFAOptions: '{{ resource.MFAOptions }}'
- discovery_id: aws.cognito.describe_user_pool_domain
  calls:
  - action: describe_user_pool_domain
    save_as: response
  emit:
    item:
      UserPoolId: '{{ response.DomainDescription.UserPoolId }}'
      AWSAccountId: '{{ response.DomainDescription.AWSAccountId }}'
      Domain: '{{ response.DomainDescription.Domain }}'
      S3Bucket: '{{ response.DomainDescription.S3Bucket }}'
      CloudFrontDistribution: '{{ response.DomainDescription.CloudFrontDistribution
        }}'
      Version: '{{ response.DomainDescription.Version }}'
      Status: '{{ response.DomainDescription.Status }}'
      CustomDomainConfig: '{{ response.DomainDescription.CustomDomainConfig }}'
      ManagedLoginVersion: '{{ response.DomainDescription.ManagedLoginVersion }}'
- discovery_id: aws.cognito.list_groups
  calls:
  - action: list_groups
    save_as: response
  emit:
    items_for: '{{ response.Groups }}'
    as: resource
    item:
      GroupName: '{{ resource.GroupName }}'
      UserPoolId: '{{ resource.UserPoolId }}'
      Description: '{{ resource.Description }}'
      RoleArn: '{{ resource.RoleArn }}'
      Precedence: '{{ resource.Precedence }}'
      LastModifiedDate: '{{ resource.LastModifiedDate }}'
      CreationDate: '{{ resource.CreationDate }}'
      UserPool: '{{ resource.UserPool }}'
checks:
- rule_id: aws.cognito.userpoolgroup.cognito_no_inline_policies_configured
  for_each: aws.cognito.describe_user_pool
  conditions:
    var: item.Policies
    op: not_equals
    value: 'null'
- rule_id: aws.cognito.userpool.console_password_present_only_if_required
  for_each: aws.cognito.describe_managed_login_branding
  conditions:
    var: item.UseCognitoProvidedValues
    op: equals
    value: 'true'
- rule_id: aws.cognito.userpool.mfa_required
  for_each: aws.cognito.get_user_pool_mfa_config
  conditions:
    var: item.MfaConfiguration
    op: equals
    value: ENABLED
- rule_id: aws.cognito.userpool.cognito_store_encrypted
  for_each: aws.cognito.list_users
  conditions:
    var: item.Enabled
    op: equals
    value: 'true'
- rule_id: aws.cognito.userpool.cognito_inactive_90_days_disabled
  for_each: aws.cognito.describe_user_pool_domain
  conditions:
    var: item.Status
    op: equals
    value: Disabled
- rule_id: aws.cognito.userpool.rbac_least_privilege
  for_each: aws.cognito.list_groups
  conditions:
    var: item.UserPool
    op: not_equals
    value: 'null'
- rule_id: aws.cognito.userpool.cognito_no_inline_policies_enabled
  for_each: aws.cognito.describe_user_pool
  conditions:
    var: item.Policies
    op: not_equals
    value: 'null'
- rule_id: aws.cognito.userpoolgroup.cognito_attached_policies_not_admin_star_configured
  for_each: aws.cognito.describe_user_pool
  conditions:
    var: item.Policies
    op: not_equals
    value: arn:aws:iam::aws:policy/AdministratorAccess
- rule_id: aws.cognito.userpool.cognito_workflow_storage_encrypted
  for_each: aws.cognito.list_users
  conditions:
    var: item.Enabled
    op: equals
    value: 'true'
- rule_id: aws.cognito.userpool.execution_roles_least_privilege
  for_each: aws.cognito.list_groups
  conditions:
    var: item.UserPool
    op: not_equals
    value: 'null'
- rule_id: aws.cognito.userpoolgroup.cognito_membership_review_enabled_if_supported
  for_each: aws.cognito.list_users
  conditions:
    var: item.Enabled
    op: equals
    value: 'true'
- rule_id: aws.cognito.userpool.access_keys_rotated_90_days_or_less_when_present
  for_each: aws.cognito.describe_user_pool
  conditions:
    var: item.LastModifiedDate
    op: exists
