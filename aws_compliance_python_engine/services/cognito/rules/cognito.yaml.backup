version: '1.0'
provider: aws
service: cognito
discovery:
- discovery_id: aws.cognito.list_user_pools
  calls:
  - action: list_user_pools
    save_as: list_user_pools_response
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      id: '{{ list_user_pools_response.UserPools.Id }}'
      name: '{{ list_user_pools_response.UserPools.Name }}'
      lambda_config: '{{ list_user_pools_response.UserPools.LambdaConfig }}'
      status: '{{ list_user_pools_response.UserPools.Status }}'
      last_modified_date: '{{ list_user_pools_response.UserPools.LastModifiedDate
        }}'
- discovery_id: aws.cognito.get_group
  calls:
  - action: get_group
    save_as: get_group_response
    params:
      GroupName: '{{ item.name }}'
      UserPoolId: '{{ item.id }}'
    on_error: continue
  for_each: aws.cognito.list_user_pools
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      group_name: '{{ get_group_response.Group.GroupName }}'
      user_pool_id: '{{ get_group_response.Group.UserPoolId }}'
      description: '{{ get_group_response.Group.Description }}'
      role_arn: '{{ get_group_response.Group.RoleArn }}'
      precedence: '{{ get_group_response.Group.Precedence }}'
- discovery_id: aws.cognito.describe_user_pool
  calls:
  - action: describe_user_pool
    save_as: describe_user_pool_response
    params:
      UserPoolId: '{{ item.id }}'
    on_error: continue
  for_each: aws.cognito.list_user_pools
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      id: '{{ describe_user_pool_response.UserPool.Id }}'
      name: '{{ describe_user_pool_response.UserPool.Name }}'
      policies: '{{ describe_user_pool_response.UserPool.Policies }}'
      deletion_protection: '{{ describe_user_pool_response.UserPool.DeletionProtection
        }}'
      lambda_config: '{{ describe_user_pool_response.UserPool.LambdaConfig }}'
- discovery_id: aws.cognito.list_users
  calls:
  - action: list_users
    save_as: list_users_response
    params:
      UserPoolId: '{{ item.id }}'
    on_error: continue
  for_each: aws.cognito.list_user_pools
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      username: '{{ list_users_response.Users.Username }}'
      attributes: '{{ list_users_response.Users.Attributes }}'
      user_create_date: '{{ list_users_response.Users.UserCreateDate }}'
      user_last_modified_date: '{{ list_users_response.Users.UserLastModifiedDate
        }}'
      enabled: '{{ list_users_response.Users.Enabled }}'
checks:
- rule_id: aws.cognito.userpool.access_keys_rotated_90_days_or_less_when_present
  for_each: aws.cognito.list_user_pools
  conditions:
    var: item.last_modified_date
    op: lte
    value: 90
- rule_id: aws.cognito.userpoolgroup.cognito_no_inline_policies_configured
  for_each: aws.cognito.get_group
  conditions:
    var: item.role_arn
    op: exists
- rule_id: aws.cognito.userpool.console_password_present_only_if_required
  for_each: aws.cognito.describe_user_pool
  conditions:
    var: item.policies
    op: exists
- rule_id: aws.cognito.userpool.mfa_required
  for_each: aws.cognito.list_users
  conditions:
    var: item.mfa_options
    op: exists
- rule_id: aws.cognito.userpool.cognito_store_encrypted
  for_each: aws.cognito.list_user_pools
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.cognito.userpool.cognito_inactive_90_days_disabled
  for_each: aws.cognito.list_users
  conditions:
    all:
    - var: item.user_status
      op: equals
      value: ENABLED
    - var: item.user_last_modified_date
      op: gt
      value: 90_days_ago
- rule_id: aws.cognito.userpool.cognito_no_inline_policies_enabled
  for_each: aws.cognito.describe_user_pool
  conditions:
    var: item.policies
    op: equals
- rule_id: aws.cognito.userpoolgroup.cognito_attached_policies_not_admin_star_configured
  for_each: aws.cognito.get_group
  conditions:
    var: item.role_arn
    op: not_contains
    value: arn:aws:iam::aws:policy/AdministratorAccess
- rule_id: aws.cognito.userpool.cognito_workflow_storage_encrypted
  for_each: aws.cognito.list_user_pools
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.cognito.userpool.execution_roles_least_privilege
  for_each: aws.cognito.get_group
  conditions:
    var: item.role_arn
    op: exists
- rule_id: aws.cognito.userpoolgroup.cognito_membership_review_enabled_if_supported
  for_each: aws.cognito.get_group
  conditions:
    var: item.description
    op: exists
