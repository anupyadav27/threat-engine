version: '1.0'
provider: aws
service: neptune
services:
  client: neptune
  module: boto3.client
discovery:
- discovery_id: aws.neptune.describe_db_cluster_snapshots
  calls:
  - action: describe_db_cluster_snapshots
    save_as: response
  emit:
    item:
      AvailabilityZones: '{{ response.DBClusterSnapshots.AvailabilityZones }}'
      DBClusterSnapshotIdentifier: '{{ response.DBClusterSnapshots.DBClusterSnapshotIdentifier
        }}'
      DBClusterIdentifier: '{{ response.DBClusterSnapshots.DBClusterIdentifier }}'
      SnapshotCreateTime: '{{ response.DBClusterSnapshots.SnapshotCreateTime }}'
      Engine: '{{ response.DBClusterSnapshots.Engine }}'
      AllocatedStorage: '{{ response.DBClusterSnapshots.AllocatedStorage }}'
      Status: '{{ response.DBClusterSnapshots.Status }}'
      Port: '{{ response.DBClusterSnapshots.Port }}'
      VpcId: '{{ response.DBClusterSnapshots.VpcId }}'
      ClusterCreateTime: '{{ response.DBClusterSnapshots.ClusterCreateTime }}'
      MasterUsername: '{{ response.DBClusterSnapshots.MasterUsername }}'
      EngineVersion: '{{ response.DBClusterSnapshots.EngineVersion }}'
      LicenseModel: '{{ response.DBClusterSnapshots.LicenseModel }}'
      SnapshotType: '{{ response.DBClusterSnapshots.SnapshotType }}'
      PercentProgress: '{{ response.DBClusterSnapshots.PercentProgress }}'
      StorageEncrypted: '{{ response.DBClusterSnapshots.StorageEncrypted }}'
      KmsKeyId: '{{ response.DBClusterSnapshots.KmsKeyId }}'
      DBClusterSnapshotArn: '{{ response.DBClusterSnapshots.DBClusterSnapshotArn }}'
      SourceDBClusterSnapshotArn: '{{ response.DBClusterSnapshots.SourceDBClusterSnapshotArn
        }}'
      IAMDatabaseAuthenticationEnabled: '{{ response.DBClusterSnapshots.IAMDatabaseAuthenticationEnabled
        }}'
      StorageType: '{{ response.DBClusterSnapshots.StorageType }}'
- discovery_id: aws.neptune.describe_db_clusters
  calls:
  - action: describe_db_clusters
    save_as: response
  emit:
    item:
      AllocatedStorage: '{{ response.DBClusters.AllocatedStorage }}'
      AvailabilityZones: '{{ response.DBClusters.AvailabilityZones }}'
      BackupRetentionPeriod: '{{ response.DBClusters.BackupRetentionPeriod }}'
      CharacterSetName: '{{ response.DBClusters.CharacterSetName }}'
      DatabaseName: '{{ response.DBClusters.DatabaseName }}'
      DBClusterIdentifier: '{{ response.DBClusters.DBClusterIdentifier }}'
      DBClusterParameterGroup: '{{ response.DBClusters.DBClusterParameterGroup }}'
      DBSubnetGroup: '{{ response.DBClusters.DBSubnetGroup }}'
      Status: '{{ response.DBClusters.Status }}'
      PercentProgress: '{{ response.DBClusters.PercentProgress }}'
      EarliestRestorableTime: '{{ response.DBClusters.EarliestRestorableTime }}'
      Endpoint: '{{ response.DBClusters.Endpoint }}'
      ReaderEndpoint: '{{ response.DBClusters.ReaderEndpoint }}'
      MultiAZ: '{{ response.DBClusters.MultiAZ }}'
      Engine: '{{ response.DBClusters.Engine }}'
      EngineVersion: '{{ response.DBClusters.EngineVersion }}'
      LatestRestorableTime: '{{ response.DBClusters.LatestRestorableTime }}'
      Port: '{{ response.DBClusters.Port }}'
      MasterUsername: '{{ response.DBClusters.MasterUsername }}'
      DBClusterOptionGroupMemberships: '{{ response.DBClusters.DBClusterOptionGroupMemberships
        }}'
      PreferredBackupWindow: '{{ response.DBClusters.PreferredBackupWindow }}'
      PreferredMaintenanceWindow: '{{ response.DBClusters.PreferredMaintenanceWindow
        }}'
      ReplicationSourceIdentifier: '{{ response.DBClusters.ReplicationSourceIdentifier
        }}'
      ReadReplicaIdentifiers: '{{ response.DBClusters.ReadReplicaIdentifiers }}'
      DBClusterMembers: '{{ response.DBClusters.DBClusterMembers }}'
      VpcSecurityGroups: '{{ response.DBClusters.VpcSecurityGroups }}'
      HostedZoneId: '{{ response.DBClusters.HostedZoneId }}'
      StorageEncrypted: '{{ response.DBClusters.StorageEncrypted }}'
      KmsKeyId: '{{ response.DBClusters.KmsKeyId }}'
      DbClusterResourceId: '{{ response.DBClusters.DbClusterResourceId }}'
      DBClusterArn: '{{ response.DBClusters.DBClusterArn }}'
      AssociatedRoles: '{{ response.DBClusters.AssociatedRoles }}'
      IAMDatabaseAuthenticationEnabled: '{{ response.DBClusters.IAMDatabaseAuthenticationEnabled
        }}'
      CloneGroupId: '{{ response.DBClusters.CloneGroupId }}'
      ClusterCreateTime: '{{ response.DBClusters.ClusterCreateTime }}'
      CopyTagsToSnapshot: '{{ response.DBClusters.CopyTagsToSnapshot }}'
      EnabledCloudwatchLogsExports: '{{ response.DBClusters.EnabledCloudwatchLogsExports
        }}'
      PendingModifiedValues: '{{ response.DBClusters.PendingModifiedValues }}'
      DeletionProtection: '{{ response.DBClusters.DeletionProtection }}'
      CrossAccountClone: '{{ response.DBClusters.CrossAccountClone }}'
      AutomaticRestartTime: '{{ response.DBClusters.AutomaticRestartTime }}'
      ServerlessV2ScalingConfiguration: '{{ response.DBClusters.ServerlessV2ScalingConfiguration
        }}'
      GlobalClusterIdentifier: '{{ response.DBClusters.GlobalClusterIdentifier }}'
      IOOptimizedNextAllowedModificationTime: '{{ response.DBClusters.IOOptimizedNextAllowedModificationTime
        }}'
      StorageType: '{{ response.DBClusters.StorageType }}'
- discovery_id: aws.neptune.describe_db_engine_versions
  calls:
  - action: describe_db_engine_versions
    save_as: response
  emit:
    item:
      Engine: '{{ response.DBEngineVersions.Engine }}'
      EngineVersion: '{{ response.DBEngineVersions.EngineVersion }}'
      DBParameterGroupFamily: '{{ response.DBEngineVersions.DBParameterGroupFamily
        }}'
      DBEngineDescription: '{{ response.DBEngineVersions.DBEngineDescription }}'
      DBEngineVersionDescription: '{{ response.DBEngineVersions.DBEngineVersionDescription
        }}'
      DefaultCharacterSet: '{{ response.DBEngineVersions.DefaultCharacterSet }}'
      SupportedCharacterSets: '{{ response.DBEngineVersions.SupportedCharacterSets
        }}'
      ValidUpgradeTarget: '{{ response.DBEngineVersions.ValidUpgradeTarget }}'
      SupportedTimezones: '{{ response.DBEngineVersions.SupportedTimezones }}'
      ExportableLogTypes: '{{ response.DBEngineVersions.ExportableLogTypes }}'
      SupportsLogExportsToCloudwatchLogs: '{{ response.DBEngineVersions.SupportsLogExportsToCloudwatchLogs
        }}'
      SupportsReadReplica: '{{ response.DBEngineVersions.SupportsReadReplica }}'
      SupportsGlobalDatabases: '{{ response.DBEngineVersions.SupportsGlobalDatabases
        }}'
- discovery_id: aws.neptune.describe_orderable_db_instance_options
  calls:
  - action: describe_orderable_db_instance_options
    save_as: response
    params:
      Engine: '{{ item.Engine }}'
  on_error: continue
  for_each: aws.neptune.describe_db_clusters
  emit:
    item:
      Engine: '{{ response.OrderableDBInstanceOptions.Engine }}'
      EngineVersion: '{{ response.OrderableDBInstanceOptions.EngineVersion }}'
      DBInstanceClass: '{{ response.OrderableDBInstanceOptions.DBInstanceClass }}'
      LicenseModel: '{{ response.OrderableDBInstanceOptions.LicenseModel }}'
      AvailabilityZones: '{{ response.OrderableDBInstanceOptions.AvailabilityZones
        }}'
      MultiAZCapable: '{{ response.OrderableDBInstanceOptions.MultiAZCapable }}'
      ReadReplicaCapable: '{{ response.OrderableDBInstanceOptions.ReadReplicaCapable
        }}'
      Vpc: '{{ response.OrderableDBInstanceOptions.Vpc }}'
      SupportsStorageEncryption: '{{ response.OrderableDBInstanceOptions.SupportsStorageEncryption
        }}'
      StorageType: '{{ response.OrderableDBInstanceOptions.StorageType }}'
      SupportsIops: '{{ response.OrderableDBInstanceOptions.SupportsIops }}'
      SupportsEnhancedMonitoring: '{{ response.OrderableDBInstanceOptions.SupportsEnhancedMonitoring
        }}'
      SupportsIAMDatabaseAuthentication: '{{ response.OrderableDBInstanceOptions.SupportsIAMDatabaseAuthentication
        }}'
      SupportsPerformanceInsights: '{{ response.OrderableDBInstanceOptions.SupportsPerformanceInsights
        }}'
      MinStorageSize: '{{ response.OrderableDBInstanceOptions.MinStorageSize }}'
      MaxStorageSize: '{{ response.OrderableDBInstanceOptions.MaxStorageSize }}'
      MinIopsPerDbInstance: '{{ response.OrderableDBInstanceOptions.MinIopsPerDbInstance
        }}'
      MaxIopsPerDbInstance: '{{ response.OrderableDBInstanceOptions.MaxIopsPerDbInstance
        }}'
      MinIopsPerGib: '{{ response.OrderableDBInstanceOptions.MinIopsPerGib }}'
      MaxIopsPerGib: '{{ response.OrderableDBInstanceOptions.MaxIopsPerGib }}'
      SupportsGlobalDatabases: '{{ response.OrderableDBInstanceOptions.SupportsGlobalDatabases
        }}'
checks:
- rule_id: aws.neptune.cluster.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.neptune.describe_orderable_db_instance_options
  conditions:
    var: item.SupportsIAMDatabaseAuthentication
    op: equals
    value: true
- rule_id: aws.neptune.cluster.public_access_disabled
  for_each: aws.neptune.describe_db_clusters
  conditions:
    var: item.VpcSecurityGroups
    op: equals
    value: []
- rule_id: aws.neptune.instance.require_tls_in_transit_configured
  for_each: aws.neptune.describe_db_clusters
  conditions:
    var: item.DBClusterParameterGroup
    op: contains
    value: neptune_enforce_ssl
- rule_id: aws.neptune.cluster.neptune_storage_encrypted
  for_each: aws.neptune.describe_db_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: true
- rule_id: aws.neptune.cluster.encryption_at_rest_enabled
  for_each: aws.neptune.describe_db_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: true
- rule_id: aws.neptune.cluster.iam_db_authentication_enabled
  for_each: aws.neptune.describe_orderable_db_instance_options
  conditions:
    var: item.SupportsIAMDatabaseAuthentication
    op: equals
    value: true
- rule_id: aws.neptune.cluster.neptune_integration_cloudwatch_logs_configured
  for_each: aws.neptune.describe_db_engine_versions
  conditions:
    var: item.SupportsLogExportsToCloudwatchLogs
    op: equals
    value: true
- rule_id: aws.neptune.cluster.deletion_protection_enabled
  for_each: aws.neptune.describe_db_clusters
  conditions:
    var: item.DeletionProtection
    op: equals
    value: true
- rule_id: aws.neptune.cluster.network_security_audit_configured
  for_each: aws.neptune.describe_db_engine_versions
  conditions:
    var: item.SupportsLogExportsToCloudwatchLogs
    op: equals
    value: true
- rule_id: aws.neptune.instance.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.neptune.describe_orderable_db_instance_options
  conditions:
    var: item.SupportsIAMDatabaseAuthentication
    op: equals
    value: true
- rule_id: aws.neptune.instance.deletion_protection_enabled
  for_each: aws.neptune.describe_db_clusters
  conditions:
    var: item.DeletionProtection
    op: equals
    value: true
- rule_id: aws.neptune.cluster.encryption_at_rest_cmek_configured
  for_each: aws.neptune.describe_db_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: true
- rule_id: aws.neptune.cluster.neptune_minor_version_auto_upgrade_enabled
  for_each: aws.neptune.describe_db_cluster_snapshots
  conditions:
    var: item.Engine
    op: contains
    value: auto
- rule_id: aws.neptune.instance.encryption_at_rest_enabled
  for_each: aws.neptune.describe_db_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: true
- rule_id: aws.neptune.cluster.snapshot_encrypted
  for_each: aws.neptune.describe_db_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: true
- rule_id: aws.neptune.cluster.neptune_multi_az_configured
  for_each: aws.neptune.describe_db_clusters
  conditions:
    var: item.MultiAZ
    op: equals
    value: true
- rule_id: aws.neptune.instance.public_access_disabled
  for_each: aws.neptune.describe_db_clusters
  conditions:
    var: item.VpcSecurityGroups
    op: equals
    value: []
- rule_id: aws.neptune.cluster.copy_tags_to_snapshots_configured
  for_each: aws.neptune.describe_db_clusters
  conditions:
    var: item.CopyTagsToSnapshot
    op: equals
    value: true
- rule_id: aws.neptune.cluster.audit_logging_enabled
  for_each: aws.neptune.describe_db_engine_versions
  conditions:
    var: item.SupportsLogExportsToCloudwatchLogs
    op: equals
    value: true
- rule_id: aws.neptune.cluster.require_tls_in_transit_configured
  for_each: aws.neptune.describe_db_clusters
  conditions:
    var: item.DBClusterParameterGroup
    op: contains
    value: neptune_enforce_ssl
- rule_id: aws.neptune.cluster.encryption_in_transit_enforced
  for_each: aws.neptune.describe_db_cluster_snapshots
  conditions:
    var: item.Engine
    op: gte
    value: '1.2'
