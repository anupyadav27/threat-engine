version: '1.0'
provider: aws
service: neptune
services:
  client: neptune
  module: boto3.client
discovery:
- discovery_id: aws.neptune.describe_d_b_clusters
  calls:
  - action: describe_db_clusters
    save_as: response
  emit:
    item:
      AllocatedStorage: '{{ response.DBClusters.AllocatedStorage }}'
      AvailabilityZones: '{{ response.DBClusters.AvailabilityZones }}'
      BackupRetentionPeriod: '{{ response.DBClusters.BackupRetentionPeriod }}'
      CharacterSetName: '{{ response.DBClusters.CharacterSetName }}'
      DatabaseName: '{{ response.DBClusters.DatabaseName }}'
      DBClusterIdentifier: '{{ response.DBClusters.DBClusterIdentifier }}'
      DBClusterParameterGroup: '{{ response.DBClusters.DBClusterParameterGroup }}'
      DBSubnetGroup: '{{ response.DBClusters.DBSubnetGroup }}'
      Status: '{{ response.DBClusters.Status }}'
      PercentProgress: '{{ response.DBClusters.PercentProgress }}'
      EarliestRestorableTime: '{{ response.DBClusters.EarliestRestorableTime }}'
      Endpoint: '{{ response.DBClusters.Endpoint }}'
      ReaderEndpoint: '{{ response.DBClusters.ReaderEndpoint }}'
      MultiAZ: '{{ response.DBClusters.MultiAZ }}'
      Engine: '{{ response.DBClusters.Engine }}'
      EngineVersion: '{{ response.DBClusters.EngineVersion }}'
      LatestRestorableTime: '{{ response.DBClusters.LatestRestorableTime }}'
      Port: '{{ response.DBClusters.Port }}'
      MasterUsername: '{{ response.DBClusters.MasterUsername }}'
      DBClusterOptionGroupMemberships: '{{ response.DBClusters.DBClusterOptionGroupMemberships
        }}'
      PreferredBackupWindow: '{{ response.DBClusters.PreferredBackupWindow }}'
      PreferredMaintenanceWindow: '{{ response.DBClusters.PreferredMaintenanceWindow
        }}'
      ReplicationSourceIdentifier: '{{ response.DBClusters.ReplicationSourceIdentifier
        }}'
      ReadReplicaIdentifiers: '{{ response.DBClusters.ReadReplicaIdentifiers }}'
      DBClusterMembers: '{{ response.DBClusters.DBClusterMembers }}'
      VpcSecurityGroups: '{{ response.DBClusters.VpcSecurityGroups }}'
      HostedZoneId: '{{ response.DBClusters.HostedZoneId }}'
      StorageEncrypted: '{{ response.DBClusters.StorageEncrypted }}'
      KmsKeyId: '{{ response.DBClusters.KmsKeyId }}'
      DbClusterResourceId: '{{ response.DBClusters.DbClusterResourceId }}'
      DBClusterArn: '{{ response.DBClusters.DBClusterArn }}'
      AssociatedRoles: '{{ response.DBClusters.AssociatedRoles }}'
      IAMDatabaseAuthenticationEnabled: '{{ response.DBClusters.IAMDatabaseAuthenticationEnabled
        }}'
      CloneGroupId: '{{ response.DBClusters.CloneGroupId }}'
      ClusterCreateTime: '{{ response.DBClusters.ClusterCreateTime }}'
      CopyTagsToSnapshot: '{{ response.DBClusters.CopyTagsToSnapshot }}'
      EnabledCloudwatchLogsExports: '{{ response.DBClusters.EnabledCloudwatchLogsExports
        }}'
      PendingModifiedValues: '{{ response.DBClusters.PendingModifiedValues }}'
      DeletionProtection: '{{ response.DBClusters.DeletionProtection }}'
      CrossAccountClone: '{{ response.DBClusters.CrossAccountClone }}'
      AutomaticRestartTime: '{{ response.DBClusters.AutomaticRestartTime }}'
      ServerlessV2ScalingConfiguration: '{{ response.DBClusters.ServerlessV2ScalingConfiguration
        }}'
      GlobalClusterIdentifier: '{{ response.DBClusters.GlobalClusterIdentifier }}'
      IOOptimizedNextAllowedModificationTime: '{{ response.DBClusters.IOOptimizedNextAllowedModificationTime
        }}'
      StorageType: '{{ response.DBClusters.StorageType }}'
      Enabled: '{{ resource.Enabled }}'
- discovery_id: aws.neptune.describe_d_b_instances
  calls:
  - action: describe_db_instances
    save_as: response
  emit:
    item:
      DBInstanceIdentifier: '{{ response.DBInstances.DBInstanceIdentifier }}'
      DBInstanceClass: '{{ response.DBInstances.DBInstanceClass }}'
      Engine: '{{ response.DBInstances.Engine }}'
      DBInstanceStatus: '{{ response.DBInstances.DBInstanceStatus }}'
      MasterUsername: '{{ response.DBInstances.MasterUsername }}'
      DBName: '{{ response.DBInstances.DBName }}'
      Endpoint: '{{ response.DBInstances.Endpoint }}'
      AllocatedStorage: '{{ response.DBInstances.AllocatedStorage }}'
      InstanceCreateTime: '{{ response.DBInstances.InstanceCreateTime }}'
      PreferredBackupWindow: '{{ response.DBInstances.PreferredBackupWindow }}'
      BackupRetentionPeriod: '{{ response.DBInstances.BackupRetentionPeriod }}'
      DBSecurityGroups: '{{ response.DBInstances.DBSecurityGroups }}'
      VpcSecurityGroups: '{{ response.DBInstances.VpcSecurityGroups }}'
      DBParameterGroups: '{{ response.DBInstances.DBParameterGroups }}'
      AvailabilityZone: '{{ response.DBInstances.AvailabilityZone }}'
      DBSubnetGroup: '{{ response.DBInstances.DBSubnetGroup }}'
      PreferredMaintenanceWindow: '{{ response.DBInstances.PreferredMaintenanceWindow
        }}'
      PendingModifiedValues: '{{ response.DBInstances.PendingModifiedValues }}'
      LatestRestorableTime: '{{ response.DBInstances.LatestRestorableTime }}'
      MultiAZ: '{{ response.DBInstances.MultiAZ }}'
      EngineVersion: '{{ response.DBInstances.EngineVersion }}'
      AutoMinorVersionUpgrade: '{{ response.DBInstances.AutoMinorVersionUpgrade }}'
      ReadReplicaSourceDBInstanceIdentifier: '{{ response.DBInstances.ReadReplicaSourceDBInstanceIdentifier
        }}'
      ReadReplicaDBInstanceIdentifiers: '{{ response.DBInstances.ReadReplicaDBInstanceIdentifiers
        }}'
      ReadReplicaDBClusterIdentifiers: '{{ response.DBInstances.ReadReplicaDBClusterIdentifiers
        }}'
      LicenseModel: '{{ response.DBInstances.LicenseModel }}'
      Iops: '{{ response.DBInstances.Iops }}'
      OptionGroupMemberships: '{{ response.DBInstances.OptionGroupMemberships }}'
      CharacterSetName: '{{ response.DBInstances.CharacterSetName }}'
      SecondaryAvailabilityZone: '{{ response.DBInstances.SecondaryAvailabilityZone
        }}'
      PubliclyAccessible: '{{ response.DBInstances.PubliclyAccessible }}'
      StatusInfos: '{{ response.DBInstances.StatusInfos }}'
      StorageType: '{{ response.DBInstances.StorageType }}'
      TdeCredentialArn: '{{ response.DBInstances.TdeCredentialArn }}'
      DbInstancePort: '{{ response.DBInstances.DbInstancePort }}'
      DBClusterIdentifier: '{{ response.DBInstances.DBClusterIdentifier }}'
      StorageEncrypted: '{{ response.DBInstances.StorageEncrypted }}'
      KmsKeyId: '{{ response.DBInstances.KmsKeyId }}'
      DbiResourceId: '{{ response.DBInstances.DbiResourceId }}'
      CACertificateIdentifier: '{{ response.DBInstances.CACertificateIdentifier }}'
      DomainMemberships: '{{ response.DBInstances.DomainMemberships }}'
      CopyTagsToSnapshot: '{{ response.DBInstances.CopyTagsToSnapshot }}'
      MonitoringInterval: '{{ response.DBInstances.MonitoringInterval }}'
      EnhancedMonitoringResourceArn: '{{ response.DBInstances.EnhancedMonitoringResourceArn
        }}'
      MonitoringRoleArn: '{{ response.DBInstances.MonitoringRoleArn }}'
      PromotionTier: '{{ response.DBInstances.PromotionTier }}'
      DBInstanceArn: '{{ response.DBInstances.DBInstanceArn }}'
      Timezone: '{{ response.DBInstances.Timezone }}'
      IAMDatabaseAuthenticationEnabled: '{{ response.DBInstances.IAMDatabaseAuthenticationEnabled
        }}'
      PerformanceInsightsEnabled: '{{ response.DBInstances.PerformanceInsightsEnabled
        }}'
      PerformanceInsightsKMSKeyId: '{{ response.DBInstances.PerformanceInsightsKMSKeyId
        }}'
      EnabledCloudwatchLogsExports: '{{ response.DBInstances.EnabledCloudwatchLogsExports
        }}'
      DeletionProtection: '{{ response.DBInstances.DeletionProtection }}'
- discovery_id: aws.neptune.describe_d_b_cluster_snapshots
  calls:
  - action: describe_db_cluster_snapshots
    save_as: response
  emit:
    item:
      AvailabilityZones: '{{ response.DBClusterSnapshots.AvailabilityZones }}'
      DBClusterSnapshotIdentifier: '{{ response.DBClusterSnapshots.DBClusterSnapshotIdentifier
        }}'
      DBClusterIdentifier: '{{ response.DBClusterSnapshots.DBClusterIdentifier }}'
      SnapshotCreateTime: '{{ response.DBClusterSnapshots.SnapshotCreateTime }}'
      Engine: '{{ response.DBClusterSnapshots.Engine }}'
      AllocatedStorage: '{{ response.DBClusterSnapshots.AllocatedStorage }}'
      Status: '{{ response.DBClusterSnapshots.Status }}'
      Port: '{{ response.DBClusterSnapshots.Port }}'
      VpcId: '{{ response.DBClusterSnapshots.VpcId }}'
      ClusterCreateTime: '{{ response.DBClusterSnapshots.ClusterCreateTime }}'
      MasterUsername: '{{ response.DBClusterSnapshots.MasterUsername }}'
      EngineVersion: '{{ response.DBClusterSnapshots.EngineVersion }}'
      LicenseModel: '{{ response.DBClusterSnapshots.LicenseModel }}'
      SnapshotType: '{{ response.DBClusterSnapshots.SnapshotType }}'
      PercentProgress: '{{ response.DBClusterSnapshots.PercentProgress }}'
      StorageEncrypted: '{{ response.DBClusterSnapshots.StorageEncrypted }}'
      KmsKeyId: '{{ response.DBClusterSnapshots.KmsKeyId }}'
      DBClusterSnapshotArn: '{{ response.DBClusterSnapshots.DBClusterSnapshotArn }}'
      SourceDBClusterSnapshotArn: '{{ response.DBClusterSnapshots.SourceDBClusterSnapshotArn
        }}'
      IAMDatabaseAuthenticationEnabled: '{{ response.DBClusterSnapshots.IAMDatabaseAuthenticationEnabled
        }}'
      StorageType: '{{ response.DBClusterSnapshots.StorageType }}'
checks:
- rule_id: aws.neptune.cluster.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.neptune.describe_d_b_clusters
  conditions:
    var: item.Enabled
    op: equals
    value: 'true'
- rule_id: aws.neptune.cluster.public_access_disabled
  for_each: aws.neptune.describe_d_b_instances
  conditions:
    var: item.PubliclyAccessible
    op: equals
    value: 'false'
- rule_id: aws.neptune.instance.require_tls_in_transit_configured
  for_each: aws.neptune.describe_d_b_clusters
  conditions:
    var: item.Enabled
    op: equals
    value: true
- rule_id: aws.neptune.security_configuration_review.security_configuration_review_configured
  for_each: aws.neptune.describe_d_b_clusters
  conditions:
    var: item.Enabled
    op: equals
    value: true
- rule_id: aws.neptune.cluster.neptune_storage_encrypted
  for_each: aws.neptune.describe_d_b_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: 'true'
- rule_id: aws.neptune.cluster.encryption_at_rest_enabled
  for_each: aws.neptune.describe_d_b_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: 'true'
- rule_id: aws.neptune.cluster.cloudwatch_monitoring_alerting_enabled
  for_each: aws.neptune.describe_d_b_clusters
  conditions:
    var: item.Enabled
    op: equals
    value: true
- rule_id: aws.neptune.cluster.iam_db_authentication_enabled
  for_each: aws.neptune.describe_d_b_cluster_snapshots
  conditions:
    var: item.IAMDatabaseAuthenticationEnabled
    op: equals
    value: 'true'
- rule_id: aws.neptune.cluster.neptune_integration_cloudwatch_logs_configured
  for_each: aws.neptune.describe_d_b_clusters
  conditions:
    var: item.EnabledCloudwatchLogsExports
    op: not_equals
    value: 'null'
- rule_id: aws.neptune.cluster.deletion_protection_enabled
  for_each: aws.neptune.describe_d_b_clusters
  conditions:
    var: item.DeletionProtection
    op: equals
    value: 'true'
- rule_id: aws.neptune.cluster.network_security_audit_configured
  for_each: aws.neptune.describe_d_b_clusters
  conditions:
    var: item.Enabled
    op: equals
    value: true
- rule_id: aws.neptune.cluster.private_networking_enforced
  for_each: aws.neptune.describe_d_b_instances
  conditions:
    var: item.PubliclyAccessible
    op: equals
    value: 'false'
- rule_id: aws.neptune.instance.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.neptune.describe_d_b_clusters
  conditions:
    var: item.Enabled
    op: equals
    value: 'true'
- rule_id: aws.neptune.instance.deletion_protection_enabled
  for_each: aws.neptune.describe_d_b_clusters
  conditions:
    var: item.DeletionProtection
    op: equals
    value: 'true'
- rule_id: aws.neptune.cluster.encryption_at_rest_cmek_configured
  for_each: aws.neptune.describe_d_b_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: 'true'
- rule_id: aws.neptune.cluster.neptune_minor_version_auto_upgrade_enabled
  for_each: aws.neptune.describe_d_b_instances
  conditions:
    var: item.AutoMinorVersionUpgrade
    op: equals
    value: 'true'
- rule_id: aws.neptune.instance.encryption_at_rest_enabled
  for_each: aws.neptune.describe_d_b_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: 'true'
- rule_id: aws.neptune.cluster.snapshot_encrypted
  for_each: aws.neptune.describe_d_b_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: 'true'
- rule_id: aws.neptune.cluster.neptune_multi_az_configured
  for_each: aws.neptune.describe_d_b_clusters
  conditions:
    var: item.MultiAZ
    op: equals
    value: 'true'
- rule_id: aws.neptune.instance.public_access_disabled
  for_each: aws.neptune.describe_d_b_instances
  conditions:
    var: item.PubliclyAccessible
    op: equals
    value: 'false'
- rule_id: aws.neptune.cluster.copy_tags_to_snapshots_configured
  for_each: aws.neptune.describe_d_b_clusters
  conditions:
    var: item.CopyTagsToSnapshot
    op: not_empty
- rule_id: aws.neptune.cluster.audit_logging_enabled
  for_each: aws.neptune.describe_d_b_clusters
  conditions:
    var: item.Enabled
    op: equals
    value: true
- rule_id: aws.neptune.cluster.require_tls_in_transit_configured
  for_each: aws.neptune.describe_d_b_clusters
  conditions:
    var: item.DBClusterParameterGroup
    op: not_equals
    value: 'null'
- rule_id: aws.neptune.cluster.encryption_in_transit_enforced
  for_each: aws.neptune.describe_d_b_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: 'true'
