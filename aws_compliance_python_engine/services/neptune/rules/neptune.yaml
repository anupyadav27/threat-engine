version: '1.0'
provider: aws
service: neptune
discovery:
- discovery_id: aws.neptune.instances
  calls:
  - client: neptune
    action: describe_db_clusters
    save_as: instance_list
    on_error: continue
    fields:
    - Neptunes
  emit:
    items_for: instance_list[]
    as: instance
    item:
      id: '{{ instance.Id }}'
      name: '{{ instance.Name }}'
- discovery_id: aws.neptune.instance_encryption
  for_each: aws.neptune.instances
  calls:
  - client: neptune
    action: describe_db_clusters
    params:
      InstanceId: '{{ item.id }}'
    save_as: encryption
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      encryption_enabled: '{{ encryption.Encrypted if encryption.Encrypted is defined
        else false }}'
- discovery_id: aws.neptune.instance_logging
  for_each: aws.neptune.instances
  calls:
  - client: neptune
    action: describe_db_cluster_endpoints
    params:
      InstanceId: '{{ item.id }}'
    save_as: logging
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      logging_enabled: '{{ logging.LoggingEnabled is defined if logging else false
        }}'
- discovery_id: aws.neptune.security_configuration_reviews
  for_each: aws.neptune.security_configuration_review
  calls:
  - client: neptune
    action: describe_db_cluster_endpoints
    save_as: security_configuration_reviews
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.neptune.clusters
  for_each: aws.neptune.cluster
  calls:
  - client: neptune
    action: describe_db_cluster_endpoints
    save_as: clusters
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.neptune.cluster_encryption
  calls:
  - client: neptune
    action: list_tags_for_resource
    save_as: cluster_encryption
    on_error: continue
  emit:
    items_for: cluster_encryption[]
    as: cluster_encryption
    item:
      id: '{{ cluster_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.neptune.cluster_logging
  calls:
  - client: neptune
    action: list_tags_for_resource
    save_as: cluster_logging
    on_error: continue
  emit:
    items_for: cluster_logging[]
    as: cluster_logging
    item:
      id: '{{ cluster_logging.Id }}'
      compliant: '{{ true }}'
checks:
- title: 'NEPTUNE cluster: Iam Or Managed Identity Auth Enabled If Supported'
  severity: high
  rule_id: aws.neptune.cluster.iam_or_managed_identity_auth_enabled_if_supported
  for_each:
    discovery: aws.neptune.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.is_public
    op: equals
    value: false
- title: 'NEPTUNE cluster: Public Access Disabled'
  severity: high
  rule_id: aws.neptune.cluster.public_access_disabled
  for_each:
    discovery: aws.neptune.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.is_public
    op: equals
    value: false
- title: 'NEPTUNE instance: Require Tls In Transit Configured'
  severity: high
  rule_id: aws.neptune.instance.require_tls_in_transit_configured
  for_each:
    discovery: aws.neptune.instances
    as: instance
    item: instance
  conditions:
    var: instance.in_vpc
    op: equals
    value: true
- title: 'NEPTUNE security configuration review: Security Configuration Review Configured'
  severity: medium
  rule_id: aws.neptune.security_configuration_review.security_configuration_review_configured
  for_each:
    discovery: aws.neptune.security_configuration_reviews
    as: security_configuration_review
    item: security_configuration_review
  conditions:
    var: security_configuration_review.compliant
    op: equals
    value: true
- title: 'NEPTUNE cluster: Neptune Storage Encrypted'
  severity: high
  rule_id: aws.neptune.cluster.neptune_storage_encrypted
  for_each:
    discovery: aws.neptune.cluster_encryption
    as: cluster
    item: cluster
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'NEPTUNE cluster: Encryption At Rest Enabled'
  severity: high
  rule_id: aws.neptune.cluster.encryption_at_rest_enabled
  for_each:
    discovery: aws.neptune.cluster_encryption
    as: cluster
    item: cluster
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'NEPTUNE cluster: Cloudwatch Monitoring Alerting Enabled'
  severity: medium
  rule_id: aws.neptune.cluster.cloudwatch_monitoring_alerting_enabled
  for_each:
    discovery: aws.neptune.cluster_logging
    as: cluster
    item: cluster
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'NEPTUNE cluster: Iam Db Authentication Enabled'
  severity: high
  rule_id: aws.neptune.cluster.iam_db_authentication_enabled
  for_each:
    discovery: aws.neptune.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.is_public
    op: equals
    value: false
- title: 'NEPTUNE cluster: Neptune Integration Cloudwatch Logs Configured'
  severity: medium
  rule_id: aws.neptune.cluster.neptune_integration_cloudwatch_logs_configured
  for_each:
    discovery: aws.neptune.cluster_logging
    as: cluster
    item: cluster
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'NEPTUNE cluster: Deletion Protection Enabled'
  severity: medium
  rule_id: aws.neptune.cluster.deletion_protection_enabled
  for_each:
    discovery: aws.neptune.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.compliant
    op: equals
    value: true
- title: 'NEPTUNE cluster: Network Security Audit Configured'
  severity: medium
  rule_id: aws.neptune.cluster.network_security_audit_configured
  for_each:
    discovery: aws.neptune.cluster_logging
    as: cluster
    item: cluster
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'NEPTUNE cluster: Private Networking Enforced'
  severity: high
  rule_id: aws.neptune.cluster.private_networking_enforced
  for_each:
    discovery: aws.neptune.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.is_public
    op: equals
    value: false
- title: 'NEPTUNE instance: Iam Or Managed Identity Auth Enabled If Supported'
  severity: high
  rule_id: aws.neptune.instance.iam_or_managed_identity_auth_enabled_if_supported
  for_each:
    discovery: aws.neptune.instances
    as: instance
    item: instance
  conditions:
    var: instance.is_public
    op: equals
    value: false
- title: 'NEPTUNE instance: Deletion Protection Enabled'
  severity: medium
  rule_id: aws.neptune.instance.deletion_protection_enabled
  for_each:
    discovery: aws.neptune.instances
    as: instance
    item: instance
  conditions:
    var: instance.compliant
    op: equals
    value: true
- title: 'NEPTUNE cluster: Encryption At Rest Cmek Configured'
  severity: high
  rule_id: aws.neptune.cluster.encryption_at_rest_cmek_configured
  for_each:
    discovery: aws.neptune.cluster_encryption
    as: cluster
    item: cluster
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'NEPTUNE cluster: Neptune Minor Version Auto Upgrade Enabled'
  severity: low
  rule_id: aws.neptune.cluster.neptune_minor_version_auto_upgrade_enabled
  for_each:
    discovery: aws.neptune.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.versioning_enabled
    op: equals
    value: true
- title: 'NEPTUNE instance: Encryption At Rest Enabled'
  severity: high
  rule_id: aws.neptune.instance.encryption_at_rest_enabled
  for_each:
    discovery: aws.neptune.instance_encryption
    as: instance
    item: instance
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'NEPTUNE cluster: Snapshot Encrypted'
  severity: high
  rule_id: aws.neptune.cluster.snapshot_encrypted
  for_each:
    discovery: aws.neptune.cluster_encryption
    as: cluster
    item: cluster
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'NEPTUNE cluster: Neptune Multi Az Configured'
  severity: medium
  rule_id: aws.neptune.cluster.neptune_multi_az_configured
  for_each:
    discovery: aws.neptune.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.compliant
    op: equals
    value: true
- title: 'NEPTUNE instance: Public Access Disabled'
  severity: high
  rule_id: aws.neptune.instance.public_access_disabled
  for_each:
    discovery: aws.neptune.instances
    as: instance
    item: instance
  conditions:
    var: instance.is_public
    op: equals
    value: false
- title: 'NEPTUNE cluster: Copy Tags To Snapshots Configured'
  severity: medium
  rule_id: aws.neptune.cluster.copy_tags_to_snapshots_configured
  for_each:
    discovery: aws.neptune.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.versioning_enabled
    op: equals
    value: true
- title: 'NEPTUNE cluster: Audit Logging Enabled'
  severity: medium
  rule_id: aws.neptune.cluster.audit_logging_enabled
  for_each:
    discovery: aws.neptune.cluster_logging
    as: cluster
    item: cluster
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'NEPTUNE cluster: Require Tls In Transit Configured'
  severity: high
  rule_id: aws.neptune.cluster.require_tls_in_transit_configured
  for_each:
    discovery: aws.neptune.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.in_vpc
    op: equals
    value: true
- title: 'NEPTUNE cluster: Encryption In Transit Enforced'
  severity: high
  rule_id: aws.neptune.cluster.encryption_in_transit_enforced
  for_each:
    discovery: aws.neptune.cluster_encryption
    as: cluster
    item: cluster
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
