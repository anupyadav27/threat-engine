version: '1.0'
provider: aws
service: config
discovery:
- discovery_id: aws.config.describe_configuration_aggregators
  calls:
  - action: describe_configuration_aggregators
    save_as: describe_configuration_aggregators_response
  emit:
    items_for: '{{ describe_configuration_aggregators_response.ConfigurationAggregators
      }}'
    as: resource
    item:
      configuration_aggregator_name: '{{ resource.ConfigurationAggregatorName }}'
      configuration_aggregator_arn: '{{ resource.ConfigurationAggregatorArn }}'
      account_aggregation_sources: '{{ resource.AccountAggregationSources }}'
      organization_aggregation_source: '{{ resource.OrganizationAggregationSource
        }}'
      creation_time: '{{ resource.CreationTime }}'
      last_updated_time: '{{ resource.LastUpdatedTime }}'
      created_by: '{{ resource.CreatedBy }}'
      aggregator_filters: '{{ resource.AggregatorFilters }}'
- discovery_id: aws.config.describe_config_rules
  calls:
  - action: describe_config_rules
    save_as: describe_config_rules_response
  emit:
    items_for: '{{ describe_config_rules_response.ConfigRules }}'
    as: resource
    item:
      config_rule_name: '{{ resource.ConfigRuleName }}'
      config_rule_arn: '{{ resource.ConfigRuleArn }}'
      config_rule_id: '{{ resource.ConfigRuleId }}'
      description: '{{ resource.Description }}'
      scope: '{{ resource.Scope }}'
      source: '{{ resource.Source }}'
      input_parameters: '{{ resource.InputParameters }}'
      maximum_execution_frequency: '{{ resource.MaximumExecutionFrequency }}'
      config_rule_state: '{{ resource.ConfigRuleState }}'
      created_by: '{{ resource.CreatedBy }}'
- discovery_id: aws.config.describe_delivery_channels
  calls:
  - action: describe_delivery_channels
    save_as: describe_delivery_channels_response
  emit:
    items_for: '{{ describe_delivery_channels_response.DeliveryChannels }}'
    as: resource
    item:
      name: '{{ resource.name }}'
      s3_bucket_name: '{{ resource.s3BucketName }}'
      s3_key_prefix: '{{ resource.s3KeyPrefix }}'
      s3_kms_key_arn: '{{ resource.s3KmsKeyArn }}'
      sns_topic_arn: '{{ resource.snsTopicARN }}'
      config_snapshot_delivery_properties: '{{ resource.configSnapshotDeliveryProperties
        }}'
- discovery_id: aws.config.describe_configuration_recorder_status
  calls:
  - action: describe_configuration_recorder_status
    save_as: describe_configuration_recorder_status_response
  emit:
    items_for: '{{ describe_configuration_recorder_status_response.ConfigurationRecordersStatus
      }}'
    as: resource
    item:
      arn: '{{ resource.arn }}'
      name: '{{ resource.name }}'
      last_start_time: '{{ resource.lastStartTime }}'
      last_stop_time: '{{ resource.lastStopTime }}'
      recording: '{{ resource.recording }}'
      last_status: '{{ resource.lastStatus }}'
      last_error_code: '{{ resource.lastErrorCode }}'
      last_error_message: '{{ resource.lastErrorMessage }}'
      last_status_change_time: '{{ resource.lastStatusChangeTime }}'
      service_principal: '{{ resource.servicePrincipal }}'
- discovery_id: aws.config.describe_aggregation_authorizations
  calls:
  - action: describe_aggregation_authorizations
    save_as: describe_aggregation_authorizations_response
  emit:
    items_for: '{{ describe_aggregation_authorizations_response.AggregationAuthorizations
      }}'
    as: resource
    item:
      aggregation_authorization_arn: '{{ resource.AggregationAuthorizationArn }}'
      authorized_account_id: '{{ resource.AuthorizedAccountId }}'
      authorized_aws_region: '{{ resource.AuthorizedAwsRegion }}'
      creation_time: '{{ resource.CreationTime }}'
- discovery_id: aws.config.describe_remediation_configurations
  calls:
  - action: describe_remediation_configurations
    save_as: describe_remediation_configurations_response
    params:
      ConfigRuleNames: '{{ item.config_rule_name }}'
    on_error: continue
  for_each: aws.config.describe_config_rules
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      config_rule_name: '{{ describe_remediation_configurations_response.RemediationConfigurations.ConfigRuleName
        }}'
      target_type: '{{ describe_remediation_configurations_response.RemediationConfigurations.TargetType
        }}'
      target_id: '{{ describe_remediation_configurations_response.RemediationConfigurations.TargetId
        }}'
      target_version: '{{ describe_remediation_configurations_response.RemediationConfigurations.TargetVersion
        }}'
      parameters: '{{ describe_remediation_configurations_response.RemediationConfigurations.Parameters
        }}'
checks:
- rule_id: aws.config.configuration_aggregator.configuration_present_and_valid
  for_each: aws.config.describe_configuration_aggregators
  conditions:
    all:
    - var: item.configuration_aggregator_name
      op: exists
    - var: item.configuration_aggregator_arn
      op: exists
- rule_id: aws.config.remediation_configuration.manual_runbooks_enabled
  for_each: aws.config.describe_remediation_configurations
  conditions:
    var: item.automatic
    op: equals
    value: false
- rule_id: aws.config.configrule.remediation_rule_remediation_targets_bound_configured
  for_each: aws.config.describe_remediation_configurations
  conditions:
    var: item.target_type
    op: equals
    value: SSM_DOCUMENT
- rule_id: aws.config.aggregation_authorization.certificate_not_expired_or_revoked_valid
  for_each: aws.config.describe_config_rules
  conditions:
    var: item.config_rule_state
    op: equals
    value: ACTIVE
- rule_id: aws.config.remediation_configuration.auto_remediation_enabled_for_high
  for_each: aws.config.describe_remediation_configurations
  conditions:
    var: item.automatic
    op: equals
    value: true
- rule_id: aws.config.configrule.config_rule_evidence_export_configured
  for_each: aws.config.describe_config_rules
  conditions:
    all:
    - var: item.config_rule_state
      op: equals
      value: ACTIVE
    - var: item.config_rule_name
      op: exists
- rule_id: aws.config.configuration_aggregator.configuration_auto_enroll_new_accounts_configured
  for_each: aws.config.describe_configuration_aggregators
  conditions:
    var: item.organization_aggregation_source
    op: exists
- rule_id: aws.config.deliverychannel.kms_encryption_enabled
  for_each: aws.config.describe_delivery_channels
  conditions:
    var: item.s3_kms_key_arn
    op: exists
- rule_id: aws.config.resource.config_recorder_all_regions_enabled
  for_each: aws.config.describe_configuration_recorder_status
  conditions:
    var: item.recording
    op: equals
    value: true
- rule_id: aws.config.deliverychannel.destination_access_least_privilege
  for_each: aws.config.describe_delivery_channels
  conditions:
    all:
    - var: item.sns_topic_arn
      op: exists
    - var: item.s3_bucket_name
      op: exists
- rule_id: aws.config.configrule.config_rule_reporting_dashboards_enabled
  for_each: aws.config.describe_config_rules
  conditions:
    var: item.config_rule_state
    op: equals
    value: ACTIVE
- rule_id: aws.config.recorder.config_all_regions_enabled
  for_each: aws.config.describe_configuration_recorder_status
  conditions:
    var: item.recording
    op: equals
    value: true
- rule_id: aws.config.configrule.rule_config_rules_enabled
  for_each: aws.config.describe_config_rules
  conditions:
    var: item.config_rule_state
    op: equals
    value: ACTIVE
- rule_id: aws.config.aggregation_authorization.config_trusts_least_privilege
  for_each: aws.config.describe_aggregation_authorizations
  conditions:
    all:
    - var: item.authorized_account_id
      op: exists
    - var: item.authorized_aws_region
      op: exists
- rule_id: aws.config.configuration_aggregator.configuration_org_aggregator_enabled
  for_each: aws.config.describe_configuration_aggregators
  conditions:
    var: item.organization_aggregation_source
    op: exists
- rule_id: aws.config.resource.config_lambda_config_recording_enabled
  for_each: aws.config.describe_configuration_recorder_status
  conditions:
    var: item.recording
    op: equals
    value: true
- rule_id: aws.config.configrule.config_rule_critical_resources_drift_detection_enabled
  for_each: aws.config.describe_config_rules
  conditions:
    all:
    - var: item.config_rule_state
      op: equals
      value: ACTIVE
    - var: item.evaluation_modes
      op: contains
      value: DETECT_DRIFT
- rule_id: aws.config.configuration_recorder.configuration_config_recorder_enabled
  for_each: aws.config.describe_configuration_recorder_status
  conditions:
    var: item.recording
    op: equals
    value: true
- rule_id: aws.config.aggregation_authorization.config_target_accounts_correct_configured
  for_each: aws.config.describe_aggregation_authorizations
  conditions:
    all:
    - var: item.aggregation_authorization_arn
      op: exists
    - var: item.authorized_account_id
      op: exists
    - var: item.authorized_aws_region
      op: exists
