version: '1.0'
provider: aws
service: config
discovery:
- discovery_id: aws.config.remediation_configurations
  calls:
  - client: config
    action: describe_configuration_recorders
    save_as: remediation_configuration_list
    on_error: continue
    fields:
    - Configs
  emit:
    items_for: remediation_configuration_list[]
    as: remediation_configuration
    item:
      id: '{{ remediation_configuration.Id }}'
      name: '{{ remediation_configuration.Name }}'
- discovery_id: aws.config.remediation_configuration_encryption
  for_each: aws.config.remediation_configurations
  calls:
  - client: config
    action: describe_configuration_recorders
    params:
      Remediation_configurationId: '{{ item.id }}'
    save_as: encryption
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      encryption_enabled: '{{ encryption.Encrypted if encryption.Encrypted is defined
        else false }}'
- discovery_id: aws.config.deliverychannels
  for_each: aws.config.deliverychannel
  calls:
  - client: config
    action: describe_delivery_channel_status
    save_as: deliverychannels
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.config.deliverychannel_encryption
  calls:
  - client: config
    action: list_aggregate_discovered_resources
    save_as: deliverychannel_encryption
    on_error: continue
  emit:
    items_for: deliverychannel_encryption[]
    as: deliverychannel_encryption
    item:
      id: '{{ deliverychannel_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.config.configuration_recorders
  for_each: aws.config.configuration_recorder
  calls:
  - client: config
    action: describe_configuration_recorders
    save_as: configuration_recorders
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.config.configuration_aggregators
  for_each: aws.config.configuration_aggregator
  calls:
  - client: config
    action: describe_configuration_aggregators
    save_as: configuration_aggregators
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.config.aggregation_authorizations
  for_each: aws.config.aggregation_authorization
  calls:
  - client: config
    action: describe_aggregation_authorizations
    save_as: aggregation_authorizations
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.config.recorders
  for_each: aws.config.recorder
  calls:
  - client: config
    action: describe_aggregate_compliance_by_config_rules
    save_as: recorders
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.config.resources
  for_each: aws.config.resource
  calls:
  - client: config
    action: describe_aggregate_compliance_by_config_rules
    save_as: resources
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.config.configrules
  for_each: aws.config.configrule
  calls:
  - client: config
    action: describe_config_rules
    save_as: configrules
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
checks:
- title: 'CONFIG configuration aggregator: Configuration Present And Valid'
  severity: medium
  rule_id: aws.config.configuration_aggregator.configuration_present_and_valid
  for_each:
    discovery: aws.config.configuration_aggregators
    as: configuration_aggregator
    item: configuration_aggregator
  conditions:
    var: configuration_aggregator.compliant
    op: equals
    value: true
- title: 'CONFIG remediation configuration: Manual Runbooks Enabled'
  severity: medium
  rule_id: aws.config.remediation_configuration.manual_runbooks_enabled
  for_each:
    discovery: aws.config.remediation_configurations
    as: remediation_configuration
    item: remediation_configuration
  conditions:
    var: remediation_configuration.compliant
    op: equals
    value: true
- title: 'CONFIG configrule: Remediation Rule Remediation Targets Bound Configured'
  severity: medium
  rule_id: aws.config.configrule.remediation_rule_remediation_targets_bound_configured
  for_each:
    discovery: aws.config.configrules
    as: configrule
    item: configrule
  conditions:
    var: configrule.compliant
    op: equals
    value: true
- title: 'CONFIG aggregation authorization: Certificate Not Expired Or Revoked Valid'
  severity: medium
  rule_id: aws.config.aggregation_authorization.certificate_not_expired_or_revoked_valid
  for_each:
    discovery: aws.config.aggregation_authorizations
    as: aggregation_authorization
    item: aggregation_authorization
  conditions:
    var: aggregation_authorization.compliant
    op: equals
    value: true
- title: 'CONFIG remediation configuration: Auto Remediation Enabled For High'
  severity: medium
  rule_id: aws.config.remediation_configuration.auto_remediation_enabled_for_high
  for_each:
    discovery: aws.config.remediation_configurations
    as: remediation_configuration
    item: remediation_configuration
  conditions:
    var: remediation_configuration.compliant
    op: equals
    value: true
- title: 'CONFIG configrule: Config Rule Evidence Export Configured'
  severity: medium
  rule_id: aws.config.configrule.config_rule_evidence_export_configured
  for_each:
    discovery: aws.config.configrules
    as: configrule
    item: configrule
  conditions:
    var: configrule.compliant
    op: equals
    value: true
- title: 'CONFIG configuration aggregator: Configuration Auto Enroll New Accounts
    Configured'
  severity: medium
  rule_id: aws.config.configuration_aggregator.configuration_auto_enroll_new_accounts_configured
  for_each:
    discovery: aws.config.configuration_aggregators
    as: configuration_aggregator
    item: configuration_aggregator
  conditions:
    var: configuration_aggregator.compliant
    op: equals
    value: true
- title: 'CONFIG configrule: Alerts Configured'
  severity: medium
  rule_id: aws.config.configrule.alerts_configured
  for_each:
    discovery: aws.config.configrules
    as: configrule
    item: configrule
  conditions:
    var: configrule.monitoring_enabled
    op: equals
    value: true
- title: 'CONFIG deliverychannel: Kms Encryption Enabled'
  severity: high
  rule_id: aws.config.deliverychannel.kms_encryption_enabled
  for_each:
    discovery: aws.config.deliverychannel_encryption
    as: deliverychannel
    item: deliverychannel
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'CONFIG resource: Config Recorder All Regions Enabled'
  severity: medium
  rule_id: aws.config.resource.config_recorder_all_regions_enabled
  for_each:
    discovery: aws.config.resources
    as: resource
    item: resource
  conditions:
    var: resource.compliant
    op: equals
    value: true
- title: 'CONFIG deliverychannel: Destination Access Least Privilege'
  severity: high
  rule_id: aws.config.deliverychannel.destination_access_least_privilege
  for_each:
    discovery: aws.config.deliverychannels
    as: deliverychannel
    item: deliverychannel
  conditions:
    var: deliverychannel.is_public
    op: equals
    value: false
- title: 'CONFIG configrule: Config Rule Reporting Dashboards Enabled'
  severity: medium
  rule_id: aws.config.configrule.config_rule_reporting_dashboards_enabled
  for_each:
    discovery: aws.config.configrules
    as: configrule
    item: configrule
  conditions:
    var: configrule.compliant
    op: equals
    value: true
- title: 'CONFIG recorder: Config All Regions Enabled'
  severity: medium
  rule_id: aws.config.recorder.config_all_regions_enabled
  for_each:
    discovery: aws.config.recorders
    as: recorder
    item: recorder
  conditions:
    var: recorder.compliant
    op: equals
    value: true
- title: 'CONFIG configuration recorder: Configuration Global Resource Types Tracked
    Configured'
  severity: medium
  rule_id: aws.config.configuration_recorder.configuration_global_resource_types_tracked_configured
  for_each:
    discovery: aws.config.configuration_recorders
    as: configuration_recorder
    item: configuration_recorder
  conditions:
    var: configuration_recorder.compliant
    op: equals
    value: true
- title: 'CONFIG configrule: Rule Config Rules Enabled'
  severity: medium
  rule_id: aws.config.configrule.rule_config_rules_enabled
  for_each:
    discovery: aws.config.configrules
    as: configrule
    item: configrule
  conditions:
    var: configrule.compliant
    op: equals
    value: true
- title: 'CONFIG configuration recorder: Configuration Secure Destination Configured'
  severity: medium
  rule_id: aws.config.configuration_recorder.configuration_secure_destination_configured
  for_each:
    discovery: aws.config.configuration_recorders
    as: configuration_recorder
    item: configuration_recorder
  conditions:
    var: configuration_recorder.compliant
    op: equals
    value: true
- title: 'CONFIG aggregation authorization: Config Trusts Least Privilege'
  severity: high
  rule_id: aws.config.aggregation_authorization.config_trusts_least_privilege
  for_each:
    discovery: aws.config.aggregation_authorizations
    as: aggregation_authorization
    item: aggregation_authorization
  conditions:
    var: aggregation_authorization.is_public
    op: equals
    value: false
- title: 'CONFIG configuration aggregator: Configuration Org Aggregator Enabled'
  severity: medium
  rule_id: aws.config.configuration_aggregator.configuration_org_aggregator_enabled
  for_each:
    discovery: aws.config.configuration_aggregators
    as: configuration_aggregator
    item: configuration_aggregator
  conditions:
    var: configuration_aggregator.compliant
    op: equals
    value: true
- title: 'CONFIG resource: Config Lambda Config Recording Enabled'
  severity: medium
  rule_id: aws.config.resource.config_lambda_config_recording_enabled
  for_each:
    discovery: aws.config.resources
    as: resource
    item: resource
  conditions:
    var: resource.compliant
    op: equals
    value: true
- title: 'CONFIG configrule: Config Rule Critical Resources Drift Detection Enabled'
  severity: medium
  rule_id: aws.config.configrule.config_rule_critical_resources_drift_detection_enabled
  for_each:
    discovery: aws.config.configrules
    as: configrule
    item: configrule
  conditions:
    var: configrule.compliant
    op: equals
    value: true
- title: 'CONFIG configuration recorder: Configuration Config Recorder Enabled'
  severity: medium
  rule_id: aws.config.configuration_recorder.configuration_config_recorder_enabled
  for_each:
    discovery: aws.config.configuration_recorders
    as: configuration_recorder
    item: configuration_recorder
  conditions:
    var: configuration_recorder.compliant
    op: equals
    value: true
- title: 'CONFIG aggregation authorization: Config Target Accounts Correct Configured'
  severity: medium
  rule_id: aws.config.aggregation_authorization.config_target_accounts_correct_configured
  for_each:
    discovery: aws.config.aggregation_authorizations
    as: aggregation_authorization
    item: aggregation_authorization
  conditions:
    var: aggregation_authorization.compliant
    op: equals
    value: true
- title: 'CONFIG configrule: Config Rule Required Rules Present'
  severity: medium
  rule_id: aws.config.configrule.config_rule_required_rules_present
  for_each:
    discovery: aws.config.configrules
    as: configrule
    item: configrule
  conditions:
    var: configrule.compliant
    op: equals
    value: true
