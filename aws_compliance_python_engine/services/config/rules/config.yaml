version: '1.0'
provider: aws
service: config
services:
  client: config
  module: boto3.client
discovery:
- discovery_id: aws.config.describe_config_rules
  calls:
  - action: describe_config_rules
    save_as: response
  emit:
    item:
      ConfigRuleName: '{{ response.ConfigRules.ConfigRuleName }}'
      ConfigRuleArn: '{{ response.ConfigRules.ConfigRuleArn }}'
      ConfigRuleId: '{{ response.ConfigRules.ConfigRuleId }}'
      Description: '{{ response.ConfigRules.Description }}'
      Scope: '{{ response.ConfigRules.Scope }}'
      Source: '{{ response.ConfigRules.Source }}'
      InputParameters: '{{ response.ConfigRules.InputParameters }}'
      MaximumExecutionFrequency: '{{ response.ConfigRules.MaximumExecutionFrequency
        }}'
      ConfigRuleState: '{{ response.ConfigRules.ConfigRuleState }}'
      CreatedBy: '{{ response.ConfigRules.CreatedBy }}'
      EvaluationModes: '{{ response.ConfigRules.EvaluationModes }}'
- discovery_id: aws.config.describe_configuration_aggregators
  calls:
  - action: describe_configuration_aggregators
    save_as: response
  emit:
    item:
      ConfigurationAggregatorName: '{{ response.ConfigurationAggregators.ConfigurationAggregatorName
        }}'
      ConfigurationAggregatorArn: '{{ response.ConfigurationAggregators.ConfigurationAggregatorArn
        }}'
      AccountAggregationSources: '{{ response.ConfigurationAggregators.AccountAggregationSources
        }}'
      OrganizationAggregationSource: '{{ response.ConfigurationAggregators.OrganizationAggregationSource
        }}'
      CreationTime: '{{ response.ConfigurationAggregators.CreationTime }}'
      LastUpdatedTime: '{{ response.ConfigurationAggregators.LastUpdatedTime }}'
      CreatedBy: '{{ response.ConfigurationAggregators.CreatedBy }}'
      AggregatorFilters: '{{ response.ConfigurationAggregators.AggregatorFilters }}'
- discovery_id: aws.config.describe_configuration_recorder_status
  calls:
  - action: describe_configuration_recorder_status
    save_as: response
  emit:
    item:
      arn: '{{ response.ConfigurationRecordersStatus.arn }}'
      name: '{{ response.ConfigurationRecordersStatus.name }}'
      lastStartTime: '{{ response.ConfigurationRecordersStatus.lastStartTime }}'
      lastStopTime: '{{ response.ConfigurationRecordersStatus.lastStopTime }}'
      recording: '{{ response.ConfigurationRecordersStatus.recording }}'
      lastStatus: '{{ response.ConfigurationRecordersStatus.lastStatus }}'
      lastErrorCode: '{{ response.ConfigurationRecordersStatus.lastErrorCode }}'
      lastErrorMessage: '{{ response.ConfigurationRecordersStatus.lastErrorMessage
        }}'
      lastStatusChangeTime: '{{ response.ConfigurationRecordersStatus.lastStatusChangeTime
        }}'
      servicePrincipal: '{{ response.ConfigurationRecordersStatus.servicePrincipal
        }}'
- discovery_id: aws.config.describe_delivery_channels
  calls:
  - action: describe_delivery_channels
    save_as: response
  emit:
    item:
      name: '{{ response.DeliveryChannels.name }}'
      s3BucketName: '{{ response.DeliveryChannels.s3BucketName }}'
      s3KeyPrefix: '{{ response.DeliveryChannels.s3KeyPrefix }}'
      s3KmsKeyArn: '{{ response.DeliveryChannels.s3KmsKeyArn }}'
      snsTopicARN: '{{ response.DeliveryChannels.snsTopicARN }}'
      configSnapshotDeliveryProperties: '{{ response.DeliveryChannels.configSnapshotDeliveryProperties
        }}'
- discovery_id: aws.config.describe_remediation_configurations
  calls:
  - action: describe_remediation_configurations
    save_as: response
  emit:
    item:
      ConfigRuleName: '{{ response.RemediationConfigurations.ConfigRuleName }}'
      TargetType: '{{ response.RemediationConfigurations.TargetType }}'
      TargetId: '{{ response.RemediationConfigurations.TargetId }}'
      TargetVersion: '{{ response.RemediationConfigurations.TargetVersion }}'
      Parameters: '{{ response.RemediationConfigurations.Parameters }}'
      ResourceType: '{{ response.RemediationConfigurations.ResourceType }}'
      Automatic: '{{ response.RemediationConfigurations.Automatic }}'
      ExecutionControls: '{{ response.RemediationConfigurations.ExecutionControls
        }}'
      MaximumAutomaticAttempts: '{{ response.RemediationConfigurations.MaximumAutomaticAttempts
        }}'
      RetryAttemptSeconds: '{{ response.RemediationConfigurations.RetryAttemptSeconds
        }}'
      Arn: '{{ response.RemediationConfigurations.Arn }}'
      CreatedByService: '{{ response.RemediationConfigurations.CreatedByService }}'
checks:
- rule_id: aws.config.remediation_configuration.manual_runbooks_enabled
  for_each: aws.config.describe_remediation_configurations
  conditions:
    var: item.Automatic
    op: equals
    value: false
- rule_id: aws.config.configrule.remediation_rule_remediation_targets_bound_configured
  for_each: aws.config.describe_remediation_configurations
  conditions:
    var: item.TargetType
    op: equals
    value: SSM_DOCUMENT
- rule_id: aws.config.aggregation_authorization.certificate_not_expired_or_revoked_valid
  for_each: aws.config.describe_config_rules
  conditions:
    var: item.ConfigRuleState
    op: equals
    value: ACTIVE
- rule_id: aws.config.remediation_configuration.auto_remediation_enabled_for_high
  for_each: aws.config.describe_remediation_configurations
  conditions:
    var: item.Automatic
    op: equals
    value: true
- rule_id: aws.config.configuration_aggregator.configuration_auto_enroll_new_accounts_configured
  for_each: aws.config.describe_configuration_aggregators
  conditions:
    var: item.OrganizationAggregationSource
    op: exists
- rule_id: aws.config.deliverychannel.kms_encryption_enabled
  for_each: aws.config.describe_delivery_channels
  conditions:
    var: item.s3KmsKeyArn
    op: exists
- rule_id: aws.config.resource.config_recorder_all_regions_enabled
  for_each: aws.config.describe_configuration_recorder_status
  conditions:
    var: item.recording
    op: equals
    value: true
- rule_id: aws.config.configrule.config_rule_reporting_dashboards_enabled
  for_each: aws.config.describe_config_rules
  conditions:
    var: item.ConfigRuleState
    op: equals
    value: ACTIVE
- rule_id: aws.config.recorder.config_all_regions_enabled
  for_each: aws.config.describe_configuration_recorder_status
  conditions:
    var: item.recording
    op: equals
    value: true
- rule_id: aws.config.configrule.rule_config_rules_enabled
  for_each: aws.config.describe_config_rules
  conditions:
    var: item.ConfigRuleState
    op: equals
    value: ACTIVE
- rule_id: aws.config.configuration_aggregator.configuration_org_aggregator_enabled
  for_each: aws.config.describe_configuration_aggregators
  conditions:
    var: item.OrganizationAggregationSource
    op: exists
- rule_id: aws.config.resource.config_lambda_config_recording_enabled
  for_each: aws.config.describe_configuration_recorder_status
  conditions:
    var: item.recording
    op: equals
    value: true
- rule_id: aws.config.configuration_recorder.configuration_config_recorder_enabled
  for_each: aws.config.describe_configuration_recorder_status
  conditions:
    var: item.recording
    op: equals
    value: true
