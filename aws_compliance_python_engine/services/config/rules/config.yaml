version: '1.0'
provider: aws
service: config
services:
  client: config
  module: boto3.client
discovery:
- discovery_id: aws.config.get_compliance_details_by_resource
  calls:
  - action: get_compliance_details_by_resource
    save_as: response
  emit:
    item:
      EvaluationResultIdentifier: '{{ response.EvaluationResults.EvaluationResultIdentifier
        }}'
      ComplianceType: '{{ response.EvaluationResults.ComplianceType }}'
      ResultRecordedTime: '{{ response.EvaluationResults.ResultRecordedTime }}'
      ConfigRuleInvokedTime: '{{ response.EvaluationResults.ConfigRuleInvokedTime
        }}'
      Annotation: '{{ response.EvaluationResults.Annotation }}'
      ResultToken: '{{ response.EvaluationResults.ResultToken }}'
- discovery_id: aws.config.describe_remediation_configurations
  calls:
  - action: describe_remediation_configurations
    save_as: response
  emit:
    item:
      ConfigRuleName: '{{ response.RemediationConfigurations.ConfigRuleName }}'
      TargetType: '{{ response.RemediationConfigurations.TargetType }}'
      TargetId: '{{ response.RemediationConfigurations.TargetId }}'
      TargetVersion: '{{ response.RemediationConfigurations.TargetVersion }}'
      Parameters: '{{ response.RemediationConfigurations.Parameters }}'
      ResourceType: '{{ response.RemediationConfigurations.ResourceType }}'
      Automatic: '{{ response.RemediationConfigurations.Automatic }}'
      ExecutionControls: '{{ response.RemediationConfigurations.ExecutionControls
        }}'
      MaximumAutomaticAttempts: '{{ response.RemediationConfigurations.MaximumAutomaticAttempts
        }}'
      RetryAttemptSeconds: '{{ response.RemediationConfigurations.RetryAttemptSeconds
        }}'
      Arn: '{{ response.RemediationConfigurations.Arn }}'
      CreatedByService: '{{ response.RemediationConfigurations.CreatedByService }}'
      RemediationConfigurations: '{{ resource.RemediationConfigurations }}'
- discovery_id: aws.config.describe_aggregation_authorizations
  calls:
  - action: describe_aggregation_authorizations
    save_as: response
  emit:
    item:
      AggregationAuthorizationArn: '{{ response.AggregationAuthorizations.AggregationAuthorizationArn
        }}'
      AuthorizedAccountId: '{{ response.AggregationAuthorizations.AuthorizedAccountId
        }}'
      AuthorizedAwsRegion: '{{ response.AggregationAuthorizations.AuthorizedAwsRegion
        }}'
      CreationTime: '{{ response.AggregationAuthorizations.CreationTime }}'
      AggregationAuthorizations: '{{ resource.AggregationAuthorizations }}'
- discovery_id: aws.config.describe_config_rules
  calls:
  - action: describe_config_rules
    save_as: response
  emit:
    item:
      ConfigRuleName: '{{ response.ConfigRules.ConfigRuleName }}'
      ConfigRuleArn: '{{ response.ConfigRules.ConfigRuleArn }}'
      ConfigRuleId: '{{ response.ConfigRules.ConfigRuleId }}'
      Description: '{{ response.ConfigRules.Description }}'
      Scope: '{{ response.ConfigRules.Scope }}'
      Source: '{{ response.ConfigRules.Source }}'
      InputParameters: '{{ response.ConfigRules.InputParameters }}'
      MaximumExecutionFrequency: '{{ response.ConfigRules.MaximumExecutionFrequency
        }}'
      ConfigRuleState: '{{ response.ConfigRules.ConfigRuleState }}'
      CreatedBy: '{{ response.ConfigRules.CreatedBy }}'
      EvaluationModes: '{{ response.ConfigRules.EvaluationModes }}'
      ConfigRules: '{{ resource.ConfigRules }}'
- discovery_id: aws.config.describe_configuration_aggregators
  calls:
  - action: describe_configuration_aggregators
    save_as: response
  emit:
    item:
      ConfigurationAggregatorName: '{{ response.ConfigurationAggregators.ConfigurationAggregatorName
        }}'
      ConfigurationAggregatorArn: '{{ response.ConfigurationAggregators.ConfigurationAggregatorArn
        }}'
      AccountAggregationSources: '{{ response.ConfigurationAggregators.AccountAggregationSources
        }}'
      OrganizationAggregationSource: '{{ response.ConfigurationAggregators.OrganizationAggregationSource
        }}'
      CreationTime: '{{ response.ConfigurationAggregators.CreationTime }}'
      LastUpdatedTime: '{{ response.ConfigurationAggregators.LastUpdatedTime }}'
      CreatedBy: '{{ response.ConfigurationAggregators.CreatedBy }}'
      AggregatorFilters: '{{ response.ConfigurationAggregators.AggregatorFilters }}'
      ConfigurationAggregators: '{{ resource.ConfigurationAggregators }}'
- discovery_id: aws.config.describe_config_rule_evaluation_status
  calls:
  - action: describe_config_rule_evaluation_status
    save_as: response
  emit:
    item:
      ConfigRuleName: '{{ response.ConfigRulesEvaluationStatus.ConfigRuleName }}'
      ConfigRuleArn: '{{ response.ConfigRulesEvaluationStatus.ConfigRuleArn }}'
      ConfigRuleId: '{{ response.ConfigRulesEvaluationStatus.ConfigRuleId }}'
      LastSuccessfulInvocationTime: '{{ response.ConfigRulesEvaluationStatus.LastSuccessfulInvocationTime
        }}'
      LastFailedInvocationTime: '{{ response.ConfigRulesEvaluationStatus.LastFailedInvocationTime
        }}'
      LastSuccessfulEvaluationTime: '{{ response.ConfigRulesEvaluationStatus.LastSuccessfulEvaluationTime
        }}'
      LastFailedEvaluationTime: '{{ response.ConfigRulesEvaluationStatus.LastFailedEvaluationTime
        }}'
      FirstActivatedTime: '{{ response.ConfigRulesEvaluationStatus.FirstActivatedTime
        }}'
      LastDeactivatedTime: '{{ response.ConfigRulesEvaluationStatus.LastDeactivatedTime
        }}'
      LastErrorCode: '{{ response.ConfigRulesEvaluationStatus.LastErrorCode }}'
      LastErrorMessage: '{{ response.ConfigRulesEvaluationStatus.LastErrorMessage
        }}'
      FirstEvaluationStarted: '{{ response.ConfigRulesEvaluationStatus.FirstEvaluationStarted
        }}'
      LastDebugLogDeliveryStatus: '{{ response.ConfigRulesEvaluationStatus.LastDebugLogDeliveryStatus
        }}'
      LastDebugLogDeliveryStatusReason: '{{ response.ConfigRulesEvaluationStatus.LastDebugLogDeliveryStatusReason
        }}'
      LastDebugLogDeliveryTime: '{{ response.ConfigRulesEvaluationStatus.LastDebugLogDeliveryTime
        }}'
      ConfigRulesEvaluationStatus: '{{ resource.ConfigRulesEvaluationStatus }}'
- discovery_id: aws.config.describe_delivery_channels
  calls:
  - action: describe_delivery_channels
    save_as: response
  emit:
    item:
      name: '{{ response.DeliveryChannels.name }}'
      s3BucketName: '{{ response.DeliveryChannels.s3BucketName }}'
      s3KeyPrefix: '{{ response.DeliveryChannels.s3KeyPrefix }}'
      s3KmsKeyArn: '{{ response.DeliveryChannels.s3KmsKeyArn }}'
      snsTopicARN: '{{ response.DeliveryChannels.snsTopicARN }}'
      configSnapshotDeliveryProperties: '{{ response.DeliveryChannels.configSnapshotDeliveryProperties
        }}'
- discovery_id: aws.config.describe_configuration_recorders
  calls:
  - action: describe_configuration_recorders
    save_as: response
  emit:
    item:
      arn: '{{ response.ConfigurationRecorders.arn }}'
      name: '{{ response.ConfigurationRecorders.name }}'
      roleARN: '{{ response.ConfigurationRecorders.roleARN }}'
      recordingGroup: '{{ response.ConfigurationRecorders.recordingGroup }}'
      recordingMode: '{{ response.ConfigurationRecorders.recordingMode }}'
      recordingScope: '{{ response.ConfigurationRecorders.recordingScope }}'
      servicePrincipal: '{{ response.ConfigurationRecorders.servicePrincipal }}'
      ConfigurationRecorders: '{{ resource.ConfigurationRecorders }}'
- discovery_id: aws.config.describe_configuration_recorder_status
  calls:
  - action: describe_configuration_recorder_status
    save_as: response
  emit:
    item:
      arn: '{{ response.ConfigurationRecordersStatus.arn }}'
      name: '{{ response.ConfigurationRecordersStatus.name }}'
      lastStartTime: '{{ response.ConfigurationRecordersStatus.lastStartTime }}'
      lastStopTime: '{{ response.ConfigurationRecordersStatus.lastStopTime }}'
      recording: '{{ response.ConfigurationRecordersStatus.recording }}'
      lastStatus: '{{ response.ConfigurationRecordersStatus.lastStatus }}'
      lastErrorCode: '{{ response.ConfigurationRecordersStatus.lastErrorCode }}'
      lastErrorMessage: '{{ response.ConfigurationRecordersStatus.lastErrorMessage
        }}'
      lastStatusChangeTime: '{{ response.ConfigurationRecordersStatus.lastStatusChangeTime
        }}'
      servicePrincipal: '{{ response.ConfigurationRecordersStatus.servicePrincipal
        }}'
      ConfigurationRecordersStatus: '{{ resource.ConfigurationRecordersStatus }}'
checks:
- rule_id: aws.config.configuration_aggregator.configuration_present_and_valid
  for_each: aws.config.get_compliance_details_by_resource
  conditions:
    var: item.ComplianceType
    op: equals
    value: COMPLIANT
- rule_id: aws.config.remediation_configuration.manual_runbooks_enabled
  for_each: aws.config.describe_remediation_configurations
  conditions:
    var: item.RemediationConfigurations
    op: not_equals
    value: 'null'
- rule_id: aws.config.configrule.remediation_rule_remediation_targets_bound_configured
  for_each: aws.config.get_compliance_details_by_resource
  conditions:
    var: item.ComplianceType
    op: equals
    value: NON_COMPLIANT
- rule_id: aws.config.aggregation_authorization.certificate_not_expired_or_revoked_valid
  for_each: aws.config.describe_aggregation_authorizations
  conditions:
    var: item.AggregationAuthorizationArn
    op: not_equals
    value: 'null'
- rule_id: aws.config.remediation_configuration.auto_remediation_enabled_for_high
  for_each: aws.config.describe_remediation_configurations
  conditions:
    var: item.RemediationConfigurations
    op: not_equals
    value: 'null'
- rule_id: aws.config.configrule.config_rule_evidence_export_configured
  for_each: aws.config.describe_config_rules
  conditions:
    var: item.ConfigRuleState
    op: equals
    value: ACTIVE
- rule_id: aws.config.configuration_aggregator.configuration_auto_enroll_new_accounts_configured
  for_each: aws.config.describe_configuration_aggregators
  conditions:
    var: item.ConfigurationAggregators
    op: not_equals
    value: 'null'
- rule_id: aws.config.configrule.alerts_configured
  for_each: aws.config.describe_config_rule_evaluation_status
  conditions:
    var: item.ConfigRulesEvaluationStatus
    op: not_equals
    value: 'null'
- rule_id: aws.config.deliverychannel.kms_encryption_enabled
  for_each: aws.config.describe_delivery_channels
  conditions:
    var: item.s3KmsKeyArn
    op: not_equals
    value: 'null'
- rule_id: aws.config.resource.config_recorder_all_regions_enabled
  for_each: aws.config.describe_configuration_recorders
  conditions:
    var: item.ConfigurationRecorders
    op: contains
    value: enabled
- rule_id: aws.config.deliverychannel.destination_access_least_privilege
  for_each: aws.config.describe_config_rules
  conditions:
    var: item.ConfigRules
    op: not_equals
    value: 'null'
- rule_id: aws.config.configrule.config_rule_reporting_dashboards_enabled
  for_each: aws.config.describe_config_rule_evaluation_status
  conditions:
    var: item.ConfigRulesEvaluationStatus
    op: equals
    value: COMPLIANT
- rule_id: aws.config.recorder.config_all_regions_enabled
  for_each: aws.config.describe_configuration_recorders
  conditions:
    var: item.ConfigurationRecorders
    op: contains
    value: ConfigAllRegionsEnabled
- rule_id: aws.config.configuration_recorder.configuration_global_resource_types_tracked_configured
  for_each: aws.config.describe_configuration_recorders
  conditions:
    var: item.ConfigurationRecorders
    op: contains
    value: global
- rule_id: aws.config.configrule.rule_config_rules_enabled
  for_each: aws.config.describe_config_rule_evaluation_status
  conditions:
    var: item.ConfigRulesEvaluationStatus
    op: equals
    value: COMPLIANT
- rule_id: aws.config.configuration_recorder.configuration_secure_destination_configured
  for_each: aws.config.describe_configuration_recorder_status
  conditions:
    var: item.ConfigurationRecordersStatus
    op: not_equals
    value: 'null'
- rule_id: aws.config.aggregation_authorization.config_trusts_least_privilege
  for_each: aws.config.describe_aggregation_authorizations
  conditions:
    var: item.AggregationAuthorizations
    op: not_equals
    value: 'null'
- rule_id: aws.config.configuration_aggregator.configuration_org_aggregator_enabled
  for_each: aws.config.describe_configuration_aggregators
  conditions:
    var: item.ConfigurationAggregators
    op: not_equals
    value: 'null'
- rule_id: aws.config.resource.config_lambda_config_recording_enabled
  for_each: aws.config.describe_configuration_recorders
  conditions:
    var: item.ConfigurationRecorders
    op: contains
    value: Config Lambda
- rule_id: aws.config.configrule.config_rule_critical_resources_drift_detection_enabled
  for_each: aws.config.describe_config_rules
  conditions:
    var: item.ConfigRuleState
    op: equals
    value: ACTIVE
- rule_id: aws.config.configuration_recorder.configuration_config_recorder_enabled
  for_each: aws.config.describe_configuration_recorder_status
  conditions:
    var: item.ConfigurationRecordersStatus
    op: equals
    value: COMPLIANT
- rule_id: aws.config.aggregation_authorization.config_target_accounts_correct_configured
  for_each: aws.config.describe_aggregation_authorizations
  conditions:
    var: item.AggregationAuthorizations
    op: not_equals
    value: 'null'
- rule_id: aws.config.configrule.config_rule_required_rules_present
  for_each: aws.config.describe_config_rules
  conditions:
    var: item.ConfigRules
    op: contains
    value: required_rule_name
