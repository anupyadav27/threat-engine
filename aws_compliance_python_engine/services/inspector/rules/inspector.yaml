version: '1.0'
provider: aws
service: inspector
services:
  client: inspector
  module: boto3.client
discovery:
- discovery_id: aws.inspector.list_assessment_runs
  calls:
  - action: list_assessment_runs
    save_as: response
- discovery_id: aws.inspector.list_assessment_targets
  calls:
  - action: list_assessment_targets
    save_as: response
- discovery_id: aws.inspector.list_event_subscriptions
  calls:
  - action: list_event_subscriptions
    save_as: response
  emit:
    items_for: '{{ response.subscriptions }}'
    as: resource
    item:
      resourceArn: '{{ resource.resourceArn }}'
      topicArn: '{{ resource.topicArn }}'
      eventSubscriptions: '{{ resource.eventSubscriptions }}'
- discovery_id: aws.inspector.describe_assessment_runs
  calls:
  - action: describe_assessment_runs
    save_as: response
    params:
      assessmentRunArns: '{{ item.assessmentRunArns }}'
  on_error: continue
  for_each: aws.inspector.list_assessment_runs
  emit:
    item:
      arn: '{{ response.assessmentRuns.arn }}'
      name: '{{ response.assessmentRuns.name }}'
      assessmentTemplateArn: '{{ response.assessmentRuns.assessmentTemplateArn }}'
      state: '{{ response.assessmentRuns.state }}'
      durationInSeconds: '{{ response.assessmentRuns.durationInSeconds }}'
      rulesPackageArns: '{{ response.assessmentRuns.rulesPackageArns }}'
      userAttributesForFindings: '{{ response.assessmentRuns.userAttributesForFindings
        }}'
      createdAt: '{{ response.assessmentRuns.createdAt }}'
      startedAt: '{{ response.assessmentRuns.startedAt }}'
      completedAt: '{{ response.assessmentRuns.completedAt }}'
      stateChangedAt: '{{ response.assessmentRuns.stateChangedAt }}'
      dataCollected: '{{ response.assessmentRuns.dataCollected }}'
      stateChanges: '{{ response.assessmentRuns.stateChanges }}'
      notifications: '{{ response.assessmentRuns.notifications }}'
      findingCounts: '{{ response.assessmentRuns.findingCounts }}'
- discovery_id: aws.inspector.describe_assessment_targets
  calls:
  - action: describe_assessment_targets
    save_as: response
    params:
      assessmentTargetArns: '{{ item.assessmentTargetArns }}'
  on_error: continue
  for_each: aws.inspector.list_assessment_targets
  emit:
    item:
      arn: '{{ response.assessmentTargets.arn }}'
      name: '{{ response.assessmentTargets.name }}'
      resourceGroupArn: '{{ response.assessmentTargets.resourceGroupArn }}'
      createdAt: '{{ response.assessmentTargets.createdAt }}'
      updatedAt: '{{ response.assessmentTargets.updatedAt }}'
checks:
- rule_id: aws.inspector.resource.inspector_is_enabled
  for_each: aws.inspector.describe_assessment_runs
  conditions:
    var: item.state
    op: equals
    value: ENABLED
- rule_id: aws.inspector.assessment.policy_store_encrypted
  for_each: aws.inspector.describe_assessment_runs
  conditions:
    var: item.state
    op: equals
    value: ENABLED
- rule_id: aws.inspector.assessment.scope_includes_all_asset_groups_configured
  for_each: aws.inspector.describe_assessment_targets
  conditions:
    var: item.resourceGroupArn
    op: exists
- rule_id: aws.inspector.finding.alert_destinations_configured
  for_each: aws.inspector.list_event_subscriptions
  conditions:
    var: item.topicArn
    op: exists
