version: '1.0'
provider: aws
service: cloudtrail
services:
  client: cloudtrail
  module: boto3.client
discovery:
- discovery_id: aws.cloudtrail.describe_trails
  calls:
  - action: describe_trails
    save_as: response
  emit:
    item:
      Name: '{{ response.trailList.Name }}'
      S3BucketName: '{{ response.trailList.S3BucketName }}'
      S3KeyPrefix: '{{ response.trailList.S3KeyPrefix }}'
      SnsTopicName: '{{ response.trailList.SnsTopicName }}'
      SnsTopicARN: '{{ response.trailList.SnsTopicARN }}'
      IncludeGlobalServiceEvents: '{{ response.trailList.IncludeGlobalServiceEvents
        }}'
      IsMultiRegionTrail: '{{ response.trailList.IsMultiRegionTrail }}'
      HomeRegion: '{{ response.trailList.HomeRegion }}'
      TrailARN: '{{ response.trailList.TrailARN }}'
      LogFileValidationEnabled: '{{ response.trailList.LogFileValidationEnabled }}'
      CloudWatchLogsLogGroupArn: '{{ response.trailList.CloudWatchLogsLogGroupArn
        }}'
      CloudWatchLogsRoleArn: '{{ response.trailList.CloudWatchLogsRoleArn }}'
      KmsKeyId: '{{ response.trailList.KmsKeyId }}'
      HasCustomEventSelectors: '{{ response.trailList.HasCustomEventSelectors }}'
      HasInsightSelectors: '{{ response.trailList.HasInsightSelectors }}'
      IsOrganizationTrail: '{{ response.trailList.IsOrganizationTrail }}'
- discovery_id: aws.cloudtrail.list_event_data_stores
  calls:
  - action: list_event_data_stores
    save_as: response
  emit:
    items_for: '{{ response.EventDataStores }}'
    as: resource
    item:
      EventDataStoreArn: '{{ resource.EventDataStoreArn }}'
      Name: '{{ resource.Name }}'
      TerminationProtectionEnabled: '{{ resource.TerminationProtectionEnabled }}'
      Status: '{{ resource.Status }}'
      AdvancedEventSelectors: '{{ resource.AdvancedEventSelectors }}'
      MultiRegionEnabled: '{{ resource.MultiRegionEnabled }}'
      OrganizationEnabled: '{{ resource.OrganizationEnabled }}'
      RetentionPeriod: '{{ resource.RetentionPeriod }}'
      CreatedTimestamp: '{{ resource.CreatedTimestamp }}'
      UpdatedTimestamp: '{{ resource.UpdatedTimestamp }}'
- discovery_id: aws.cloudtrail.get_event_selectors
  calls:
  - action: get_event_selectors
    save_as: response
  emit:
    item:
      ReadWriteType: '{{ response.EventSelectors.ReadWriteType }}'
      IncludeManagementEvents: '{{ response.EventSelectors.IncludeManagementEvents
        }}'
      DataResources: '{{ response.EventSelectors.DataResources }}'
      ExcludeManagementEventSources: '{{ response.EventSelectors.ExcludeManagementEventSources
        }}'
checks:
- rule_id: aws.cloudtrail.trail.alerts_for_anomalies_configured
  for_each: aws.cloudtrail.describe_trails
  conditions:
    var: item.HasInsightSelectors
    op: equals
    value: true
- rule_id: aws.cloudtrail.trail.flow_logging_enabled
  for_each: aws.cloudtrail.describe_trails
  conditions:
    var: item.HasInsightSelectors
    op: equals
    value: true
- rule_id: aws.cloudtrail.resource.cloudwatch_logging_enabled
  for_each: aws.cloudtrail.describe_trails
  conditions:
    var: item.CloudWatchLogsLogGroupArn
    op: exists
- rule_id: aws.cloudtrail.bucket.is_not_publicly_accessible_configured
  for_each: aws.cloudtrail.describe_trails
  conditions:
    var: item.S3BucketName
    op: exists
- rule_id: aws.cloudtrail.logs.s3_bucket_access_logging_enabled
  for_each: aws.cloudtrail.describe_trails
  conditions:
    var: item.LogFileValidationEnabled
    op: equals
    value: true
- rule_id: aws.cloudtrail.trail.retention_days_minimum
  for_each: aws.cloudtrail.list_event_data_stores
  conditions:
    var: item.RetentionPeriod
    op: gte
    value: 90
- rule_id: aws.cloudtrail.resource.trail_cloudtrail_log_file_validation_enabled
  for_each: aws.cloudtrail.describe_trails
  conditions:
    var: item.LogFileValidationEnabled
    op: equals
    value: true
- rule_id: aws.cloudtrail.resource.trail_cloudtrail_multi_region_enabled
  for_each: aws.cloudtrail.describe_trails
  conditions:
    var: item.IsMultiRegionTrail
    op: equals
    value: true
- rule_id: aws.cloudtrail.trail.cloudtrail_trail_ids_ips_enabled_if_supported
  for_each: aws.cloudtrail.describe_trails
  conditions:
    var: item.HasInsightSelectors
    op: equals
    value: true
- rule_id: aws.cloudtrail.resource.kms_encryption_enabled
  for_each: aws.cloudtrail.describe_trails
  conditions:
    var: item.KmsKeyId
    op: exists
- rule_id: aws.cloudtrail.kms.encryption_enabled
  for_each: aws.cloudtrail.describe_trails
  conditions:
    var: item.KmsKeyId
    op: exists
- rule_id: aws.cloudtrail.s3.trail_cloudtrail_dataevents_read_enabled
  for_each: aws.cloudtrail.get_event_selectors
  conditions:
    var: item.ReadWriteType
    op: equals
    value: ReadOnly
- rule_id: aws.cloudtrail.resource.trail_cloudtrail_s3_dataevents_read_enabled
  for_each: aws.cloudtrail.get_event_selectors
  conditions:
    var: item.ReadWriteType
    op: equals
    value: ReadOnly
- rule_id: aws.cloudtrail.bucket.access_logging_enabled
  for_each: aws.cloudtrail.describe_trails
  conditions:
    var: item.LogFileValidationEnabled
    op: equals
    value: true
- rule_id: aws.cloudtrail.logs.s3_bucket_is_not_publicly_accessible_configured
  for_each: aws.cloudtrail.describe_trails
  conditions:
    var: item.S3BucketName
    op: exists
- rule_id: aws.cloudtrail.s3.trail_cloudtrail_dataevents_write_enabled
  for_each: aws.cloudtrail.get_event_selectors
  conditions:
    var: item.ReadWriteType
    op: equals
    value: WriteOnly
- rule_id: aws.cloudtrail.log.file_validation_enabled
  for_each: aws.cloudtrail.describe_trails
  conditions:
    var: item.LogFileValidationEnabled
    op: equals
    value: true
- rule_id: aws.cloudtrail.multi.trail_cloudtrail_region_enabled
  for_each: aws.cloudtrail.describe_trails
  conditions:
    var: item.IsMultiRegionTrail
    op: equals
    value: true
