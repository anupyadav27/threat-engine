version: 1.0
provider: aws
service: kms
discovery:
  discovery_id: aws.kms.keys
  calls:
    - client: kms
      action: list_keys
      paginate: true
  fields:
    - name: KeyId
      save_as: key_id
  emit:
    items_for:
      as: resource
      item: key_id
checks:
  - title: Encrypted Storage Enabled
    severity: high
    rule_id: aws.kms.key_storage.encrypted_storage_enabled
    assertion_id: secrets_key_mgmt.secret_storage.encrypted_storage_enabled
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement encrypted storage enabled for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
  - title: Access Controlled
    severity: high
    rule_id: aws.kms.key_storage.access_controlled
    assertion_id: secrets_key_mgmt.secret_storage.access_controlled
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement access controlled for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
  - title: Automatic Rotation Enabled
    severity: high
    rule_id: aws.kms.key_rotation.automatic_rotation_enabled
    assertion_id: secrets_key_mgmt.key_rotation.automatic_rotation_enabled
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement automatic rotation enabled for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
  - title: Manual Rotation Scheduled
    severity: high
    rule_id: aws.kms.key_rotation.manual_rotation_scheduled
    assertion_id: secrets_key_mgmt.key_rotation.manual_rotation_scheduled
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement manual rotation scheduled for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
  - title: Hsm Protection Enabled
    severity: high
    rule_id: aws.kms.key_protection.hsm_protection_enabled
    assertion_id: secrets_key_mgmt.key_protection.hsm_protection_enabled
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement hsm protection enabled for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
  - title: Hsm Protection Enabled
    severity: high
    rule_id: aws.kms.key_policies.hsm_protection_enabled
    assertion_id: secrets_key_mgmt.key_protection.hsm_protection_enabled
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement hsm protection enabled for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
  - title: Hsm Protection Enabled
    severity: high
    rule_id: aws.kms.hsm_protection.hsm_protection_enabled
    assertion_id: secrets_key_mgmt.key_protection.hsm_protection_enabled
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement hsm protection enabled for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
  - title: Key Access Logged
    severity: high
    rule_id: aws.kms.key_protection.key_access_logged
    assertion_id: secrets_key_mgmt.key_protection.key_access_logged
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement key access logged for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
  - title: Key Access Logged
    severity: high
    rule_id: aws.kms.key_policies.key_access_logged
    assertion_id: secrets_key_mgmt.key_protection.key_access_logged
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement key access logged for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
  - title: Key Access Logged
    severity: high
    rule_id: aws.kms.hsm_protection.key_access_logged
    assertion_id: secrets_key_mgmt.key_protection.key_access_logged
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement key access logged for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
  - title: Secure Injection Enabled
    severity: high
    rule_id: aws.kms.key_usage.secure_injection_enabled
    assertion_id: secrets_key_mgmt.secret_retrieval.secure_injection_enabled
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement secure injection enabled for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
  - title: Workload Identity Used
    severity: high
    rule_id: aws.kms.key_usage.workload_identity_used
    assertion_id: secrets_key_mgmt.secret_retrieval.workload_identity_used
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement workload identity used for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
  - title: Kms Configured
    severity: low
    rule_id: aws.kms.customer_managed_keys.kms_configured
    assertion_id: crypto_data_protection.key_management.kms_configured
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement kms configured for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
  - title: Key Policies Enforced
    severity: low
    rule_id: aws.kms.customer_managed_keys.key_policies_enforced
    assertion_id: crypto_data_protection.key_management.key_policies_enforced
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement key policies enforced for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
  - title: Algorithm Standards Enforced
    severity: low
    rule_id: aws.kms.crypto_policies.algorithm_standards_enforced
    assertion_id: crypto_data_protection.crypto_policies.algorithm_standards_enforced
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement algorithm standards enforced for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
  - title: Algorithm Standards Enforced
    severity: low
    rule_id: aws.kms.import_key_material.algorithm_standards_enforced
    assertion_id: crypto_data_protection.crypto_policies.algorithm_standards_enforced
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement algorithm standards enforced for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
  - title: Compliance Standards Met
    severity: low
    rule_id: aws.kms.crypto_policies.compliance_standards_met
    assertion_id: crypto_data_protection.crypto_policies.compliance_standards_met
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement compliance standards met for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
  - title: Compliance Standards Met
    severity: low
    rule_id: aws.kms.import_key_material.compliance_standards_met
    assertion_id: crypto_data_protection.crypto_policies.compliance_standards_met
    for_each:
      as: resource
      item: key_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement compliance standards met for kms"
    references:
      - "https://docs.aws.amazon.com/kms/"
