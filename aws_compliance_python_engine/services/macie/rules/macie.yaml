version: '1.0'
provider: aws
service: macie
services:
  client: macie
  module: boto3.client
discovery:
- discovery_id: aws.macie.get_classification_export_configuration
  calls:
  - action: get_classification_export_configuration
    save_as: response
  emit:
    item:
      s3Destination: '{{ response.configuration.s3Destination }}'
      configuration: '{{ resource.configuration }}'
- discovery_id: aws.macie.get_reveal_configuration
  calls:
  - action: get_reveal_configuration
    save_as: response
  emit:
    item:
      kmsKeyId: '{{ response.configuration.kmsKeyId }}'
      status: '{{ response.configuration.status }}'
- discovery_id: aws.macie.describe_buckets
  calls:
  - action: describe_buckets
    save_as: response
  emit:
    item:
      accountId: '{{ response.buckets.accountId }}'
      allowsUnencryptedObjectUploads: '{{ response.buckets.allowsUnencryptedObjectUploads
        }}'
      automatedDiscoveryMonitoringStatus: '{{ response.buckets.automatedDiscoveryMonitoringStatus
        }}'
      bucketArn: '{{ response.buckets.bucketArn }}'
      bucketCreatedAt: '{{ response.buckets.bucketCreatedAt }}'
      bucketName: '{{ response.buckets.bucketName }}'
      classifiableObjectCount: '{{ response.buckets.classifiableObjectCount }}'
      classifiableSizeInBytes: '{{ response.buckets.classifiableSizeInBytes }}'
      errorCode: '{{ response.buckets.errorCode }}'
      errorMessage: '{{ response.buckets.errorMessage }}'
      jobDetails: '{{ response.buckets.jobDetails }}'
      lastAutomatedDiscoveryTime: '{{ response.buckets.lastAutomatedDiscoveryTime
        }}'
      lastUpdated: '{{ response.buckets.lastUpdated }}'
      objectCount: '{{ response.buckets.objectCount }}'
      objectCountByEncryptionType: '{{ response.buckets.objectCountByEncryptionType
        }}'
      publicAccess: '{{ response.buckets.publicAccess }}'
      region: '{{ response.buckets.region }}'
      replicationDetails: '{{ response.buckets.replicationDetails }}'
      sensitivityScore: '{{ response.buckets.sensitivityScore }}'
      serverSideEncryption: '{{ response.buckets.serverSideEncryption }}'
      sharedAccess: '{{ response.buckets.sharedAccess }}'
      sizeInBytes: '{{ response.buckets.sizeInBytes }}'
      sizeInBytesCompressed: '{{ response.buckets.sizeInBytesCompressed }}'
      tags: '{{ response.buckets.tags }}'
      unclassifiableObjectCount: '{{ response.buckets.unclassifiableObjectCount }}'
      unclassifiableObjectSizeInBytes: '{{ response.buckets.unclassifiableObjectSizeInBytes
        }}'
      versioning: '{{ response.buckets.versioning }}'
- discovery_id: aws.macie.get_findings_publication_configuration
  calls:
  - action: get_findings_publication_configuration
    save_as: response
  emit:
    item:
      publishClassificationFindings: '{{ response.securityHubConfiguration.publishClassificationFindings
        }}'
      publishPolicyFindings: '{{ response.securityHubConfiguration.publishPolicyFindings
        }}'
      securityHubConfiguration: '{{ resource.securityHubConfiguration }}'
checks:
- rule_id: aws.macie.findings.retention_days_minimum
  for_each: aws.macie.get_classification_export_configuration
  conditions:
    var: item.configuration
    op: not_equals
    value: 'null'
- rule_id: aws.macie.custom_data_identifier.macie_auto_classification_enabled_if_supported
  for_each: aws.macie.get_reveal_configuration
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.macie.custom_data_identifier.policy_blocks_public_for_sensitive_configured
  for_each: aws.macie.describe_buckets
  conditions:
    var: item.publicAccess
    op: equals
    value: 'null'
- rule_id: aws.macie.findings.macie_logs_centralized_and_encrypted
  for_each: aws.macie.get_reveal_configuration
  conditions:
    var: item.kmsKeyId
    op: not_equals
    value: 'null'
- rule_id: aws.macie.custom_data_identifier.macie_required_sensitivity_tags_present
  for_each: aws.macie.describe_buckets
  conditions:
    var: item.tags
    op: not_empty
- rule_id: aws.macie.findings.macie_export_destinations_private_configured
  for_each: aws.macie.describe_buckets
  conditions:
    var: item.publicAccess
    op: equals
    value: 'null'
- rule_id: aws.macie.findings.rbac_least_privilege
  for_each: aws.macie.describe_buckets
  conditions:
    var: item.publicAccess
    op: not_equals
    value: 'null'
- rule_id: aws.macie.classification_job.macie_auto_classification_enabled_if_supported
  for_each: aws.macie.get_reveal_configuration
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.macie.findings.integrations_authenticated_configured
  for_each: aws.macie.get_findings_publication_configuration
  conditions:
    var: item.securityHubConfiguration
    op: not_equals
    value: 'null'
- rule_id: aws.macie.classification_job.macie_required_sensitivity_tags_present
  for_each: aws.macie.describe_buckets
  conditions:
    var: item.tags
    op: not_empty
- rule_id: aws.macie.findings.macie_reports_storage_encrypted
  for_each: aws.macie.describe_buckets
  conditions:
    var: item.serverSideEncryption
    op: equals
    value: 'TRUE'
- rule_id: aws.macie.classification_job.policy_blocks_public_for_sensitive_configured
  for_each: aws.macie.describe_buckets
  conditions:
    var: item.publicAccess
    op: not_equals
    value: PUBLIC
- rule_id: aws.macie.findings.alert_destinations_configured
  for_each: aws.macie.describe_buckets
  conditions:
    var: item.automatedDiscoveryMonitoringStatus
    op: equals
    value: MONITORED
