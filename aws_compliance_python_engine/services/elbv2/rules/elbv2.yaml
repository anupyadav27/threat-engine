version: '1.0'
provider: aws
service: elbv2
discovery:
- discovery_id: aws.elbv2.targetgroups
  calls:
  - client: elbv2
    action: describe_load_balancers
    save_as: targetgroup_list
    on_error: continue
    fields:
    - Elbv2s
  emit:
    items_for: targetgroup_list[]
    as: targetgroup
    item:
      id: '{{ targetgroup.Id }}'
      name: '{{ targetgroup.Name }}'
- discovery_id: aws.elbv2.targetgroup_logging
  for_each: aws.elbv2.targetgroups
  calls:
  - client: elbv2
    action: describe_account_limits
    params:
      TargetgroupId: '{{ item.id }}'
    save_as: logging
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      logging_enabled: '{{ logging.LoggingEnabled is defined if logging else false
        }}'
- discovery_id: aws.elbv2.isinmultipleazs
  for_each: aws.elbv2.isinmultipleaz
  calls:
  - client: elbv2
    action: describe_account_limits
    save_as: isinmultipleazs
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elbv2.alb_https_redirects
  for_each: aws.elbv2.alb_https_redirect
  calls:
  - client: elbv2
    action: describe_account_limits
    save_as: alb_https_redirects
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elbv2.groups
  for_each: aws.elbv2.group
  calls:
  - client: elbv2
    action: describe_account_limits
    save_as: groups
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elbv2.wafaclattacheds
  for_each: aws.elbv2.wafaclattached
  calls:
  - client: elbv2
    action: describe_account_limits
    save_as: wafaclattacheds
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elbv2.resource_logging
  calls:
  - client: elbv2
    action: describe_load_balancers
    save_as: resource_logging
    on_error: continue
  emit:
    items_for: resource_logging[]
    as: resource_logging
    item:
      id: '{{ resource_logging.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elbv2.insecure_ssl_cipherss
  for_each: aws.elbv2.insecure_ssl_cipher
  calls:
  - client: elbv2
    action: describe_account_limits
    save_as: insecure_ssl_cipherss
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elbv2.loadbalancer_logging
  calls:
  - client: elbv2
    action: describe_load_balancer_attributes
    save_as: loadbalancer_logging
    on_error: continue
  emit:
    items_for: loadbalancer_logging[]
    as: loadbalancer_logging
    item:
      id: '{{ loadbalancer_logging.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elbv2.internetfacings
  for_each: aws.elbv2.internetfacing
  calls:
  - client: elbv2
    action: describe_account_limits
    save_as: internetfacings
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elbv2.loadbalancers
  for_each: aws.elbv2.loadbalancer
  calls:
  - client: elbv2
    action: describe_load_balancers
    save_as: loadbalancers
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elbv2.deletion_protections
  for_each: aws.elbv2.deletion_protection
  calls:
  - client: elbv2
    action: describe_account_limits
    save_as: deletion_protections
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elbv2.listeners
  for_each: aws.elbv2.listener
  calls:
  - client: elbv2
    action: describe_listeners
    save_as: listeners
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elbv2.logging_logging
  calls:
  - client: elbv2
    action: list_logging_logging
    save_as: logging_logging
    on_error: continue
  emit:
    items_for: logging_logging[]
    as: logging_logging
    item:
      id: '{{ logging_logging.Id }}'
      compliant: '{{ true }}'
checks:
- title: 'ELBV2 listener: Cipher Policy Secure Configured'
  severity: high
  rule_id: aws.elbv2.listener.cipher_policy_secure_configured
  for_each:
    discovery: aws.elbv2.listeners
    as: listener
    item: listener
  conditions:
    var: listener.is_public
    op: equals
    value: false
- title: 'ELBV2 isinmultipleaz: Elbv2 Is In Multiple Az Configured'
  severity: medium
  rule_id: aws.elbv2.isinmultipleaz.elbv2_is_in_multiple_az_configured
  for_each:
    discovery: aws.elbv2.isinmultipleazs
    as: isinmultipleaz
    item: isinmultipleaz
  conditions:
    var: isinmultipleaz.compliant
    op: equals
    value: true
- title: 'ELBV2 loadbalancer: Waf Attached If Supported'
  severity: medium
  rule_id: aws.elbv2.loadbalancer.waf_attached_if_supported
  for_each:
    discovery: aws.elbv2.loadbalancers
    as: loadbalancer
    item: loadbalancer
  conditions:
    var: loadbalancer.compliant
    op: equals
    value: true
- title: 'ELBV2 internetfacing: Elbv2 Internet Facing Configured'
  severity: medium
  rule_id: aws.elbv2.internetfacing.elbv2_internet_facing_configured
  for_each:
    discovery: aws.elbv2.internetfacings
    as: internetfacing
    item: internetfacing
  conditions:
    var: internetfacing.compliant
    op: equals
    value: true
- title: 'ELBV2 listener: Tls Min 1 2 Configured'
  severity: high
  rule_id: aws.elbv2.listener.tls_min_1_2_configured
  for_each:
    discovery: aws.elbv2.listeners
    as: listener
    item: listener
  conditions:
    var: listener.in_vpc
    op: equals
    value: true
- title: 'ELBV2 deletion protection: Deletion Protection Configured'
  severity: medium
  rule_id: aws.elbv2.deletion_protection.deletion_protection_configured
  for_each:
    discovery: aws.elbv2.deletion_protections
    as: deletion_protection
    item: deletion_protection
  conditions:
    var: deletion_protection.compliant
    op: equals
    value: true
- title: 'ELBV2 group: Security Check Health Check Enabled'
  severity: medium
  rule_id: aws.elbv2.group.security_check_health_check_enabled
  for_each:
    discovery: aws.elbv2.groups
    as: group
    item: group
  conditions:
    var: group.compliant
    op: equals
    value: true
- title: 'ELBV2 loadbalancer: Valid Certificate Enabled'
  severity: medium
  rule_id: aws.elbv2.loadbalancer.valid_certificate_enabled
  for_each:
    discovery: aws.elbv2.loadbalancers
    as: loadbalancer
    item: loadbalancer
  conditions:
    var: loadbalancer.compliant
    op: equals
    value: true
- title: 'ELBV2 targetgroup: Health Checks Tls If Supported Configured'
  severity: high
  rule_id: aws.elbv2.targetgroup.health_checks_tls_if_supported_configured
  for_each:
    discovery: aws.elbv2.targetgroups
    as: targetgroup
    item: targetgroup
  conditions:
    var: targetgroup.in_vpc
    op: equals
    value: true
- title: 'ELBV2 targetgroup: Elbv2 Targets In Private Subnets Configured'
  severity: high
  rule_id: aws.elbv2.targetgroup.elbv2_targets_in_private_subnets_configured
  for_each:
    discovery: aws.elbv2.targetgroups
    as: targetgroup
    item: targetgroup
  conditions:
    var: targetgroup.in_vpc
    op: equals
    value: true
- title: 'ELBV2 resource: Logging Enabled'
  severity: medium
  rule_id: aws.elbv2.resource.logging_enabled
  for_each:
    discovery: aws.elbv2.resource_logging
    as: resource
    item: resource
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'ELBV2 loadbalancer: Deletion Protection Enabled'
  severity: medium
  rule_id: aws.elbv2.loadbalancer.deletion_protection_enabled
  for_each:
    discovery: aws.elbv2.loadbalancers
    as: loadbalancer
    item: loadbalancer
  conditions:
    var: loadbalancer.compliant
    op: equals
    value: true
- title: 'ELBV2 logging: Access Logging Enabled'
  severity: medium
  rule_id: aws.elbv2.logging.access_logging_enabled
  for_each:
    discovery: aws.elbv2.logging_logging
    as: logging
    item: logging
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'ELBV2 insecure ssl ciphers: Insecure Ssl Ciphers Configured'
  severity: high
  rule_id: aws.elbv2.insecure_ssl_ciphers.insecure_ssl_ciphers_configured
  for_each:
    discovery: aws.elbv2.insecure_ssl_cipherss
    as: insecure_ssl_ciphers
    item: insecure_ssl_ciphers
  conditions:
    var: insecure_ssl_ciphers.in_vpc
    op: equals
    value: true
- title: 'ELBV2 wafaclattached: Waf Acl Enabled'
  severity: medium
  rule_id: aws.elbv2.wafaclattached.waf_acl_enabled
  for_each:
    discovery: aws.elbv2.wafaclattacheds
    as: wafaclattached
    item: wafaclattached
  conditions:
    var: wafaclattached.compliant
    op: equals
    value: true
- title: 'ELBV2 loadbalancer: Access Logs Enabled'
  severity: medium
  rule_id: aws.elbv2.loadbalancer.access_logs_enabled
  for_each:
    discovery: aws.elbv2.loadbalancer_logging
    as: loadbalancer
    item: loadbalancer
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'ELBV2 loadbalancer: Listener Tls Min 1 2 Configured'
  severity: high
  rule_id: aws.elbv2.loadbalancer.listener_tls_min_1_2_configured
  for_each:
    discovery: aws.elbv2.loadbalancers
    as: loadbalancer
    item: loadbalancer
  conditions:
    var: loadbalancer.in_vpc
    op: equals
    value: true
- title: 'ELBV2 alb https redirect: Elbv2 Alb Https Redirect Configured'
  severity: medium
  rule_id: aws.elbv2.alb_https_redirect.elbv2_alb_https_redirect_configured
  for_each:
    discovery: aws.elbv2.alb_https_redirects
    as: alb_https_redirect
    item: alb_https_redirect
  conditions:
    var: alb_https_redirect.compliant
    op: equals
    value: true
