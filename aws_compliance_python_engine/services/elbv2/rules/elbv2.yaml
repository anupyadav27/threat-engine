version: '1.0'
provider: aws
service: elbv2
services:
  client: elbv2
  module: boto3.client
discovery:
- discovery_id: aws.elbv2.describe_listeners
  calls:
  - action: describe_listeners
    save_as: response
  emit:
    item:
      ListenerArn: '{{ response.Listeners.ListenerArn }}'
      LoadBalancerArn: '{{ response.Listeners.LoadBalancerArn }}'
      Port: '{{ response.Listeners.Port }}'
      Protocol: '{{ response.Listeners.Protocol }}'
      Certificates: '{{ response.Listeners.Certificates }}'
      SslPolicy: '{{ response.Listeners.SslPolicy }}'
      DefaultActions: '{{ response.Listeners.DefaultActions }}'
      AlpnPolicy: '{{ response.Listeners.AlpnPolicy }}'
      MutualAuthentication: '{{ response.Listeners.MutualAuthentication }}'
- discovery_id: aws.elbv2.describe_load_balancers
  calls:
  - action: describe_load_balancers
    save_as: response
  emit:
    item:
      LoadBalancerArn: '{{ response.LoadBalancers.LoadBalancerArn }}'
      DNSName: '{{ response.LoadBalancers.DNSName }}'
      CanonicalHostedZoneId: '{{ response.LoadBalancers.CanonicalHostedZoneId }}'
      CreatedTime: '{{ response.LoadBalancers.CreatedTime }}'
      LoadBalancerName: '{{ response.LoadBalancers.LoadBalancerName }}'
      Scheme: '{{ response.LoadBalancers.Scheme }}'
      VpcId: '{{ response.LoadBalancers.VpcId }}'
      State: '{{ response.LoadBalancers.State }}'
      Type: '{{ response.LoadBalancers.Type }}'
      AvailabilityZones: '{{ response.LoadBalancers.AvailabilityZones }}'
      SecurityGroups: '{{ response.LoadBalancers.SecurityGroups }}'
      IpAddressType: '{{ response.LoadBalancers.IpAddressType }}'
      CustomerOwnedIpv4Pool: '{{ response.LoadBalancers.CustomerOwnedIpv4Pool }}'
      EnforceSecurityGroupInboundRulesOnPrivateLinkTraffic: '{{ response.LoadBalancers.EnforceSecurityGroupInboundRulesOnPrivateLinkTraffic
        }}'
      EnablePrefixForIpv6SourceNat: '{{ response.LoadBalancers.EnablePrefixForIpv6SourceNat
        }}'
      IpamPools: '{{ response.LoadBalancers.IpamPools }}'
- discovery_id: aws.elbv2.describe_target_groups
  calls:
  - action: describe_target_groups
    save_as: response
  emit:
    item:
      TargetGroupArn: '{{ response.TargetGroups.TargetGroupArn }}'
      TargetGroupName: '{{ response.TargetGroups.TargetGroupName }}'
      Protocol: '{{ response.TargetGroups.Protocol }}'
      Port: '{{ response.TargetGroups.Port }}'
      VpcId: '{{ response.TargetGroups.VpcId }}'
      HealthCheckProtocol: '{{ response.TargetGroups.HealthCheckProtocol }}'
      HealthCheckPort: '{{ response.TargetGroups.HealthCheckPort }}'
      HealthCheckEnabled: '{{ response.TargetGroups.HealthCheckEnabled }}'
      HealthCheckIntervalSeconds: '{{ response.TargetGroups.HealthCheckIntervalSeconds
        }}'
      HealthCheckTimeoutSeconds: '{{ response.TargetGroups.HealthCheckTimeoutSeconds
        }}'
      HealthyThresholdCount: '{{ response.TargetGroups.HealthyThresholdCount }}'
      UnhealthyThresholdCount: '{{ response.TargetGroups.UnhealthyThresholdCount }}'
      HealthCheckPath: '{{ response.TargetGroups.HealthCheckPath }}'
      Matcher: '{{ response.TargetGroups.Matcher }}'
      LoadBalancerArns: '{{ response.TargetGroups.LoadBalancerArns }}'
      TargetType: '{{ response.TargetGroups.TargetType }}'
      ProtocolVersion: '{{ response.TargetGroups.ProtocolVersion }}'
      IpAddressType: '{{ response.TargetGroups.IpAddressType }}'
      TargetControlPort: '{{ response.TargetGroups.TargetControlPort }}'
- discovery_id: aws.elbv2.describe_tags
  calls:
  - action: describe_tags
    save_as: response
  emit:
    item:
      ResourceArn: '{{ response.TagDescriptions.ResourceArn }}'
      Tags: '{{ response.TagDescriptions.Tags }}'
checks:
- rule_id: aws.elbv2.listener.cipher_policy_secure_configured
  for_each: aws.elbv2.describe_listeners
  conditions:
    var: item.SslPolicy
    op: equals
    value: ELBSecurityPolicy-TLS-1-2-2017-01
- rule_id: aws.elbv2.isinmultipleaz.elbv2_is_in_multiple_az_configured
  for_each: aws.elbv2.describe_load_balancers
  conditions:
    var: item.AvailabilityZones
    op: gt
    value: 1
- rule_id: aws.elbv2.listener.tls_min_1_2_configured
  for_each: aws.elbv2.describe_listeners
  conditions:
    var: item.SslPolicy
    op: equals
    value: ELBSecurityPolicy-TLS-1-2-2017-01
- rule_id: aws.elbv2.group.security_check_health_check_enabled
  for_each: aws.elbv2.describe_target_groups
  conditions:
    var: item.HealthCheckEnabled
    op: equals
    value: true
- rule_id: aws.elbv2.targetgroup.health_checks_tls_if_supported_configured
  for_each: aws.elbv2.describe_target_groups
  conditions:
    var: item.HealthCheckProtocol
    op: equals
    value: HTTPS
- rule_id: aws.elbv2.insecure_ssl_ciphers.insecure_ssl_ciphers_configured
  for_each: aws.elbv2.describe_listeners
  conditions:
    var: item.SslPolicy
    op: equals
    value: ELBSecurityPolicy-2016-08
- rule_id: aws.elbv2.wafaclattached.waf_acl_enabled
  for_each: aws.elbv2.describe_tags
  conditions:
    var: item.ResourceArn
    op: exists
- rule_id: aws.elbv2.loadbalancer.listener_tls_min_1_2_configured
  for_each: aws.elbv2.describe_listeners
  conditions:
    var: item.SslPolicy
    op: equals
    value: ELBSecurityPolicy-TLS-1-2-2017-01
