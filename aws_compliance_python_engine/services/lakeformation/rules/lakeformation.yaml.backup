version: '1.0'
provider: aws
service: lakeformation
discovery:
- discovery_id: aws.lakeformation.get_data_lake_settings
  calls:
  - action: get_data_lake_settings
    save_as: get_data_lake_settings_response
  emit:
    items_for: '{{ get_data_lake_settings_response.DataLakeSettings }}'
    as: resource
    item:
      data_lake_admins: '{{ resource.DataLakeAdmins }}'
      read_only_admins: '{{ resource.ReadOnlyAdmins }}'
      create_database_default_permissions: '{{ resource.CreateDatabaseDefaultPermissions
        }}'
      create_table_default_permissions: '{{ resource.CreateTableDefaultPermissions
        }}'
      parameters: '{{ resource.Parameters }}'
      trusted_resource_owners: '{{ resource.TrustedResourceOwners }}'
      allow_external_data_filtering: '{{ resource.AllowExternalDataFiltering }}'
      allow_full_table_external_data_access: '{{ resource.AllowFullTableExternalDataAccess
        }}'
      external_data_filtering_allow_list: '{{ resource.ExternalDataFilteringAllowList
        }}'
      authorized_session_tag_value_list: '{{ resource.AuthorizedSessionTagValueList
        }}'
checks:
- rule_id: aws.lakeformation.data_lake_settings.rbac_least_privilege
  for_each: aws.lakeformation.get_data_lake_settings
  conditions:
    all:
    - var: item.data_lake_admins
      op: equals
      value: []
    - var: item.read_only_admins
      op: equals
      value: []
    - var: item.create_database_default_permissions
      op: equals
      value: []
    - var: item.create_table_default_permissions
      op: equals
      value: []
    - var: item.allow_external_data_filtering
      op: equals
      value: false
    - var: item.allow_full_table_external_data_access
      op: equals
      value: false
- rule_id: aws.lakeformation.data_lake_settings.change_audit_logging_enabled
  for_each: aws.lakeformation.get_data_lake_settings
  conditions:
    var: item.allow_external_data_filtering
    op: equals
    value: true
- rule_id: aws.lakeformation.data_lake_settings.mfa_required
  for_each: aws.lakeformation.get_data_lake_settings
  conditions:
    var: item.parameters
    op: contains
    value: MFA_REQUIRED
