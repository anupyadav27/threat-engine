version: '1.0'
provider: aws
service: s3
discovery:
# Root discovery - list all buckets
- discovery_id: aws.s3.list_buckets
  calls:
  - action: list_buckets
    save_as: list_buckets_response
  emit:
    items_for: '{{ list_buckets_response.Buckets }}'
    as: bucket
    item:
      name: '{{ bucket.Name }}'
      creation_date: '{{ bucket.CreationDate }}'

# All other discoveries depend on list_buckets
- discovery_id: aws.s3.get_bucket_encryption
  for_each: aws.s3.list_buckets
  calls:
  - action: get_bucket_encryption
    params:
      Bucket: '{{ item.name }}'
    save_as: get_bucket_encryption_response
    on_error: continue
  emit:
    item:
      bucket_name: '{{ item.name }}'
      encryption_rules: '{{ get_bucket_encryption_response.ServerSideEncryptionConfiguration.Rules }}'

- discovery_id: aws.s3.get_public_access_block
  for_each: aws.s3.list_buckets
  calls:
  - action: get_public_access_block
    params:
      Bucket: '{{ item.name }}'
    save_as: get_public_access_block_response
    on_error: continue
  emit:
    item:
      name: '{{ item.name }}'
      block_public_acls: '{{ get_public_access_block_response.PublicAccessBlockConfiguration.BlockPublicAcls }}'
      ignore_public_acls: '{{ get_public_access_block_response.PublicAccessBlockConfiguration.IgnorePublicAcls }}'
      block_public_policy: '{{ get_public_access_block_response.PublicAccessBlockConfiguration.BlockPublicPolicy }}'
      restrict_public_buckets: '{{ get_public_access_block_response.PublicAccessBlockConfiguration.RestrictPublicBuckets }}'

checks:
- rule_id: aws.s3.bucket.encryption_enabled
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.encryption_rules
    op: exists

- rule_id: aws.s3.bucket.block_public_access_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    all:
    - var: item.block_public_acls
      op: equals
      value: true
    - var: item.ignore_public_acls
      op: equals
      value: true
    - var: item.block_public_policy
      op: equals
      value: true
    - var: item.restrict_public_buckets
      op: equals
      value: true
