version: '1.0'
provider: aws
service: s3
discovery:
- discovery_id: aws.s3.get_bucket_abac
  calls:
  - action: get_bucket_abac
    save_as: get_bucket_abac_response
    params:
      Bucket: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.s3.PARENT_DISCOVERY
  emit:
    item:
      status: '{{ item.Status }}'
- discovery_id: aws.s3.get_bucket_encryption
  calls:
  - action: get_bucket_encryption
    save_as: get_bucket_encryption_response
    params:
      Bucket: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.s3.PARENT_DISCOVERY
  emit:
    item:
      rules: '{{ item.Rules }}'
- discovery_id: aws.s3.get_bucket_notification_configuration
  calls:
  - action: get_bucket_notification_configuration
    save_as: get_bucket_notification_configuration_response
    params:
      Bucket: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.s3.PARENT_DISCOVERY
  emit:
    item:
      id: '{{ item.Id }}'
      topic_arn: '{{ item.TopicArn }}'
      events: '{{ item.Events }}'
      filter: '{{ item.Filter }}'
- discovery_id: aws.s3.get_bucket_logging
  calls:
  - action: get_bucket_logging
    save_as: get_bucket_logging_response
    params:
      Bucket: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.s3.PARENT_DISCOVERY
  emit:
    item:
      target_bucket: '{{ item.TargetBucket }}'
      target_grants: '{{ item.TargetGrants }}'
      target_prefix: '{{ item.TargetPrefix }}'
      target_object_key_format: '{{ item.TargetObjectKeyFormat }}'
- discovery_id: aws.s3.get_bucket_website
  calls:
  - action: get_bucket_website
    save_as: get_bucket_website_response
    params:
      Bucket: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.s3.PARENT_DISCOVERY
  emit:
    item:
      condition: '{{ item.Condition }}'
      redirect: '{{ item.Redirect }}'
- discovery_id: aws.s3.get_bucket_policy_status
  calls:
  - action: get_bucket_policy_status
    save_as: get_bucket_policy_status_response
    params:
      Bucket: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.s3.PARENT_DISCOVERY
  emit:
    item:
      is_public: '{{ item.IsPublic }}'
- discovery_id: aws.s3.get_public_access_block
  calls:
  - action: get_public_access_block
    save_as: get_public_access_block_response
    params:
      Bucket: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.s3.PARENT_DISCOVERY
  emit:
    item:
      block_public_acls: '{{ item.BlockPublicAcls }}'
      ignore_public_acls: '{{ item.IgnorePublicAcls }}'
      block_public_policy: '{{ item.BlockPublicPolicy }}'
      restrict_public_buckets: '{{ item.RestrictPublicBuckets }}'
- discovery_id: aws.s3.get_object_lock_configuration
  calls:
  - action: get_object_lock_configuration
    save_as: get_object_lock_configuration_response
    params:
      Bucket: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.s3.PARENT_DISCOVERY
  emit:
    item:
      object_lock_enabled: '{{ item.ObjectLockEnabled }}'
      rule: '{{ item.Rule }}'
- discovery_id: aws.s3.get_bucket_inventory_configuration
  calls:
  - action: get_bucket_inventory_configuration
    save_as: get_bucket_inventory_configuration_response
    params:
      Bucket: '{{ item.FIELD_NAME }}'
      Id: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.s3.PARENT_DISCOVERY
  emit:
    item:
      destination: '{{ item.Destination }}'
      is_enabled: '{{ item.IsEnabled }}'
      filter: '{{ item.Filter }}'
      id: '{{ item.Id }}'
      included_object_versions: '{{ item.IncludedObjectVersions }}'
      optional_fields: '{{ item.OptionalFields }}'
      schedule: '{{ item.Schedule }}'
- discovery_id: aws.s3.create_session
  calls:
  - action: create_session
    save_as: create_session_response
    params:
      Bucket: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.s3.PARENT_DISCOVERY
  emit:
    item:
      access_key_id: '{{ item.AccessKeyId }}'
      secret_access_key: '{{ item.SecretAccessKey }}'
      session_token: '{{ item.SessionToken }}'
      expiration: '{{ item.Expiration }}'
- discovery_id: aws.s3.get_bucket_replication
  calls:
  - action: get_bucket_replication
    save_as: get_bucket_replication_response
    params:
      Bucket: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.s3.PARENT_DISCOVERY
  emit:
    item:
      role: '{{ item.Role }}'
      rules: '{{ item.Rules }}'
checks:
- rule_id: aws.s3.macie_classification_jobs_status.macie_classification_jobs_status_configured
  for_each: aws.s3.get_bucket_abac
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.s3.bucket.encryption_enabled
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.s3.bucket.object_versioning_configured
  for_each: aws.s3.get_bucket_abac
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: aws.s3.bucket.key_rotation_enabled
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.s3.bucket_notification.bucket_destination_least_privilege
  for_each: aws.s3.get_bucket_notification_configuration
  conditions:
    all:
    - var: item.events
      op: equals
      value:
      - s3:ObjectCreated:*
      - s3:ObjectRemoved:*
    - var: item.topic_arn
      op: exists
- rule_id: aws.s3.bucket.object_level_write_logging_enabled
  for_each: aws.s3.get_bucket_logging
  conditions:
    all:
    - var: item.target_bucket
      op: exists
    - var: item.target_prefix
      op: exists
- rule_id: aws.s3.bucket_notification.bucket_destination_encrypted
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.s3.bucket.cmk_cmek_key_configured
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.s3.website_https_only.website_https_only_configured
  for_each: aws.s3.get_bucket_website
  conditions:
    var: item.redirect
    op: exists
- rule_id: aws.s3.bucketpolicy.no_public_principals_configured
  for_each: aws.s3.get_bucket_policy_status
  conditions:
    var: item.is_public
    op: equals
    value: false
- rule_id: aws.s3.bucket.require_tls_in_transit_configured
  for_each: aws.s3.get_bucket_policy_status
  conditions:
    var: item.is_public
    op: equals
    value: false
- rule_id: aws.s3.bucketpolicy.bucket_deny_insecure_transport_configured
  for_each: aws.s3.get_bucket_policy_status
  conditions:
    var: item.is_public
    op: equals
    value: false
- rule_id: aws.s3.bucket.s3_encrypted_at_rest
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.s3.bucketpolicy.bucket_deny_unencrypted_puts
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.s3.bucket.block_public_access_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    all:
    - var: item.block_public_acls
      op: equals
      value: true
    - var: item.ignore_public_acls
      op: equals
      value: true
    - var: item.block_public_policy
      op: equals
      value: true
    - var: item.restrict_public_buckets
      op: equals
      value: true
- rule_id: aws.s3.object.lock_or_immutability_enabled_if_supported
  for_each: aws.s3.get_object_lock_configuration
  conditions:
    all:
    - var: item.object_lock_enabled
      op: equals
      value: Enabled
    - var: item.rule
      op: exists
- rule_id: aws.s3.bucket.schedule_defined_min_frequency_configured
  for_each: aws.s3.get_bucket_inventory_configuration
  conditions:
    var: item.schedule
    op: equals
    value: Daily
- rule_id: aws.s3.account.level_public_access_blocks_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    all:
    - var: item.block_public_acls
      op: equals
      value: true
    - var: item.ignore_public_acls
      op: equals
      value: true
    - var: item.block_public_policy
      op: equals
      value: true
    - var: item.restrict_public_buckets
      op: equals
      value: true
- rule_id: aws.s3.bucket.policy_public_write_access_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    all:
    - var: item.block_public_acls
      op: equals
      value: true
    - var: item.ignore_public_acls
      op: equals
      value: true
    - var: item.block_public_policy
      op: equals
      value: true
    - var: item.restrict_public_buckets
      op: equals
      value: true
- rule_id: aws.s3.bucket.public_access_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    all:
    - var: item.block_public_acls
      op: equals
      value: true
    - var: item.ignore_public_acls
      op: equals
      value: true
    - var: item.block_public_policy
      op: equals
      value: true
    - var: item.restrict_public_buckets
      op: equals
      value: true
- rule_id: aws.s3.bucket.lifecycle_enabled
  for_each: aws.s3.get_bucket_abac
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: aws.s3.bucket_encryption.bucket_at_rest_cmek_enabled
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.s3.bucket.block_public_access_enabled
  for_each: aws.s3.get_public_access_block
  conditions:
    all:
    - var: item.block_public_acls
      op: equals
      value: true
    - var: item.ignore_public_acls
      op: equals
      value: true
    - var: item.block_public_policy
      op: equals
      value: true
    - var: item.restrict_public_buckets
      op: equals
      value: true
- rule_id: aws.s3.replication.encryption_in_transit_tls_required
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.s3.lifecycle_configuration.bucket_enforced_on_sensitive_datasets_configured
  for_each: aws.s3.get_bucket_abac
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: aws.s3.lifecycle_configuration.versioning_enabled_if_supported
  for_each: aws.s3.get_bucket_abac
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: aws.s3.bucket.metrics_enabled
  for_each: aws.s3.get_bucket_inventory_configuration
  conditions:
    var: item.is_enabled
    op: equals
    value: true
- rule_id: aws.s3.bucket.immutable_or_worm_enabled_if_supported
  for_each: aws.s3.get_object_lock_configuration
  conditions:
    var: item.object_lock_enabled
    op: equals
    value: Enabled
- rule_id: aws.s3.bucket.versioning_enabled
  for_each: aws.s3.get_bucket_abac
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: aws.s3.bucket.access_logging_enabled
  for_each: aws.s3.get_bucket_logging
  conditions:
    var: item.target_bucket
    op: exists
- rule_id: aws.s3.bucket.retention_days_minimum
  for_each: aws.s3.create_session
  conditions:
    var: item.expiration
    op: gte
    value: 1
- rule_id: aws.s3.lifecycle_configuration.policies_configured
  for_each: aws.s3.get_bucket_abac
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: aws.s3.bucket.server_access_logging_enabled
  for_each: aws.s3.get_bucket_logging
  conditions:
    var: item.target_bucket
    op: exists
- rule_id: aws.s3.bucket_encryption.in_transit_tls_min_1_2_configured
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.s3.bucket.key_policy_least_privilege
  for_each: aws.s3.get_bucket_policy_status
  conditions:
    var: item.is_public
    op: equals
    value: false
- rule_id: aws.s3.bucket.encryption_at_rest_enabled
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.s3.bucket.default_encryption_configured
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.s3.intelligent_tiering.protected_from_public_override_configured
  for_each: aws.s3.get_bucket_abac
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.s3.replication.auth_roles_least_privilege
  for_each: aws.s3.get_bucket_replication
  conditions:
    var: item.role
    op: exists
- rule_id: aws.s3.replication.lag_monitoring_alerts_enabled
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.s3.object.encryption_at_rest_enabled
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.s3.intelligent_tiering.policies_configured
  for_each: aws.s3.get_bucket_abac
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.s3.bucket.cmk_cmek_configured
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.s3.bucket.kms_encryption_configured
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.s3.bucketpolicy.bucket_no_wildcards_on_actions_or_principals_configured
  for_each: aws.s3.get_bucket_policy_status
  conditions:
    var: item.is_public
    op: equals
    value: false
- rule_id: aws.s3.bucket.immutability_or_object_lock_if_supported
  for_each: aws.s3.get_object_lock_configuration
  conditions:
    var: item.object_lock_enabled
    op: equals
    value: Enabled
- rule_id: aws.s3.intelligent_tiering.bucket_enforced_on_sensitive_datasets_configured
  for_each: aws.s3.get_bucket_abac
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.s3.object.not_publicly_readable_configured
  for_each: aws.s3.get_bucket_policy_status
  conditions:
    var: item.is_public
    op: equals
    value: false
- rule_id: aws.s3.bucket.public_read_prohibited_configured
  for_each: aws.s3.get_bucket_policy_status
  conditions:
    var: item.is_public
    op: equals
    value: false
- rule_id: aws.s3.lifecycle_configuration.protected_from_public_override_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    all:
    - var: item.block_public_acls
      op: equals
      value: true
    - var: item.ignore_public_acls
      op: equals
      value: true
    - var: item.block_public_policy
      op: equals
      value: true
    - var: item.restrict_public_buckets
      op: equals
      value: true
- rule_id: aws.s3.lifecycle_configuration.certificate_expiration_rules_configured
  for_each: aws.s3.get_bucket_abac
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: aws.s3.bucket.lifecycle_policy_configured
  for_each: aws.s3.get_bucket_abac
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: aws.s3.bucket.secure_transport_policy_configured
  for_each: aws.s3.get_bucket_abac
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.s3.bucket_notification.bucket_cross_account_destinations_restricted
  for_each: aws.s3.get_bucket_notification_configuration
  conditions:
    var: item.topic_arn
    op: exists
- rule_id: aws.s3.bucket.replication_enabled
  for_each: aws.s3.get_bucket_abac
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.s3.bucket.encryption_in_transit_tls_min_1_2_configured
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.rules
    op: exists
- rule_id: aws.s3.bucket.encryption_at_rest_cmek_configured
  for_each: aws.s3.get_bucket_encryption
  conditions:
    var: item.rules
    op: exists
