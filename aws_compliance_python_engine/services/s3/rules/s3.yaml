version: '1.0'
provider: aws
service: s3
discovery:
- discovery_id: aws.s3.buckets
  calls:
  - client: s3
    action: list_buckets
    save_as: buckets_list
    fields:
    - Buckets[]
  emit:
    items_for: buckets_list[]
    as: bucket
    item:
      id: '{{ bucket.Name }}'
      name: '{{ bucket.Name }}'
      creation_date: '{{ bucket.CreationDate }}'
- discovery_id: aws.s3.bucket_encryption
  for_each: aws.s3.buckets
  calls:
  - client: s3
    action: get_bucket_encryption
    params:
      Bucket: '{{ item.name }}'
    save_as: encryption
    on_error: continue
    fields:
    - ServerSideEncryptionConfiguration.Rules[]
  emit:
    item:
      bucket: '{{ item.name }}'
      encryption_enabled: '{{ encryption.ServerSideEncryptionConfiguration.Rules |
        length > 0 }}'
      sse_algorithm: '{{ encryption.ServerSideEncryptionConfiguration.Rules[0].ApplyServerSideEncryptionByDefault.SSEAlgorithm
        if encryption.ServerSideEncryptionConfiguration.Rules else null }}'
      kms_key_id: '{{ encryption.ServerSideEncryptionConfiguration.Rules[0].ApplyServerSideEncryptionByDefault.KMSMasterKeyID
        if encryption.ServerSideEncryptionConfiguration.Rules else null }}'
- discovery_id: aws.s3.bucket_versioning
  for_each: aws.s3.buckets
  calls:
  - client: s3
    action: get_bucket_versioning
    params:
      Bucket: '{{ item.name }}'
    save_as: versioning
  emit:
    item:
      bucket: '{{ item.name }}'
      status: '{{ versioning.Status }}'
      versioning_enabled: '{{ versioning.Status == "Enabled" }}'
      mfa_delete: '{{ versioning.MFADelete }}'
- discovery_id: aws.s3.bucket_logging
  for_each: aws.s3.buckets
  calls:
  - client: s3
    action: get_bucket_logging
    params:
      Bucket: '{{ item.name }}'
    save_as: logging
  emit:
    item:
      bucket: '{{ item.name }}'
      logging_enabled: '{{ logging.LoggingEnabled is defined }}'
      target_bucket: '{{ logging.LoggingEnabled.TargetBucket if logging.LoggingEnabled
        else null }}'
      target_prefix: '{{ logging.LoggingEnabled.TargetPrefix if logging.LoggingEnabled
        else null }}'
- discovery_id: aws.s3.public_access_block
  for_each: aws.s3.buckets
  calls:
  - client: s3
    action: get_public_access_block
    params:
      Bucket: '{{ item.name }}'
    save_as: public_access
    on_error: continue
  emit:
    item:
      bucket: '{{ item.name }}'
      block_public_acls: '{{ public_access.PublicAccessBlockConfiguration.BlockPublicAcls
        if public_access.PublicAccessBlockConfiguration else false }}'
      ignore_public_acls: '{{ public_access.PublicAccessBlockConfiguration.IgnorePublicAcls
        if public_access.PublicAccessBlockConfiguration else false }}'
      block_public_policy: '{{ public_access.PublicAccessBlockConfiguration.BlockPublicPolicy
        if public_access.PublicAccessBlockConfiguration else false }}'
      restrict_public_buckets: '{{ public_access.PublicAccessBlockConfiguration.RestrictPublicBuckets
        if public_access.PublicAccessBlockConfiguration else false }}'
- discovery_id: aws.s3.bucket_policy
  for_each: aws.s3.buckets
  calls:
  - client: s3
    action: get_bucket_policy
    params:
      Bucket: '{{ item.name }}'
    save_as: policy
    on_error: continue
  emit:
    item:
      bucket: '{{ item.name }}'
      has_policy: '{{ policy.Policy is defined }}'
      policy_text: '{{ policy.Policy if policy.Policy else null }}'
- discovery_id: aws.s3.bucket_lifecycle
  for_each: aws.s3.buckets
  calls:
  - client: s3
    action: get_bucket_lifecycle_configuration
    params:
      Bucket: '{{ item.name }}'
    save_as: lifecycle
    on_error: continue
    fields:
    - Rules[]
  emit:
    item:
      bucket: '{{ item.name }}'
      lifecycle_enabled: '{{ lifecycle.Rules | length > 0 if lifecycle.Rules else
        false }}'
      rules_count: '{{ lifecycle.Rules | length if lifecycle.Rules else 0 }}'
- discovery_id: aws.s3.bucket_object_lock
  for_each: aws.s3.buckets
  calls:
  - client: s3
    action: get_object_lock_configuration
    params:
      Bucket: '{{ item.name }}'
    save_as: object_lock
    on_error: continue
  emit:
    item:
      bucket: '{{ item.name }}'
      object_lock_enabled: '{{ object_lock.ObjectLockConfiguration.ObjectLockEnabled
        == "Enabled" if object_lock.ObjectLockConfiguration else false }}'
      retention_mode: '{{ object_lock.ObjectLockConfiguration.Rule.DefaultRetention.Mode
        if object_lock.ObjectLockConfiguration.Rule else null }}'
- discovery_id: aws.s3.bucket_acl
  for_each: aws.s3.buckets
  calls:
  - client: s3
    action: get_bucket_acl
    params:
      Bucket: '{{ item.name }}'
    save_as: acl
    fields:
    - Grants[]
  emit:
    item:
      bucket: '{{ item.name }}'
      grants_count: '{{ acl.Grants | length }}'
      owner: '{{ acl.Owner.ID }}'
- discovery_id: aws.s3.bucket_replication
  for_each: aws.s3.buckets
  calls:
  - client: s3
    action: get_bucket_replication
    params:
      Bucket: '{{ item.name }}'
    save_as: replication
    on_error: continue
    fields:
    - ReplicationConfiguration.Rules[]
  emit:
    item:
      bucket: '{{ item.name }}'
      replication_enabled: '{{ replication.ReplicationConfiguration.Rules | length
        > 0 if replication.ReplicationConfiguration.Rules else false }}'
- discovery_id: aws.s3.account_public_access_block
  calls:
  - client: s3control
    action: get_public_access_block
    params:
      AccountId: '{{ account_id }}'
    save_as: account_public_access
    on_error: continue
    fields:
    - PublicAccessBlockConfiguration
  emit:
    item:
      block_public_acls: '{{ account_public_access.PublicAccessBlockConfiguration.BlockPublicAcls
        if account_public_access.PublicAccessBlockConfiguration else false }}'
      ignore_public_acls: '{{ account_public_access.PublicAccessBlockConfiguration.IgnorePublicAcls
        if account_public_access.PublicAccessBlockConfiguration else false }}'
      block_public_policy: '{{ account_public_access.PublicAccessBlockConfiguration.BlockPublicPolicy
        if account_public_access.PublicAccessBlockConfiguration else false }}'
      restrict_public_buckets: '{{ account_public_access.PublicAccessBlockConfiguration.RestrictPublicBuckets
        if account_public_access.PublicAccessBlockConfiguration else false }}'
- discovery_id: aws.s3.bucket_notification
  for_each: aws.s3.buckets
  calls:
  - client: s3
    action: get_bucket_notification_configuration
    params:
      Bucket: '{{ item.name }}'
    save_as: notification
    on_error: continue
  emit:
    item:
      bucket: '{{ item.name }}'
      has_notifications: '{{ (notification.TopicConfigurations | length > 0) or (notification.QueueConfigurations
        | length > 0) or (notification.LambdaFunctionConfigurations | length > 0)
        }}'
      has_secure_destination: '{{ true }}'
checks:
- title: S3 Bucket Encryption at Rest Enabled
  severity: high
  rule_id: aws.s3.bucket.encryption_at_rest_enabled
  for_each:
    discovery: aws.s3.bucket_encryption
    as: encryption
    item: bucket
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: S3 Bucket Default Encryption Configured
  severity: high
  rule_id: aws.s3.bucket.default_encryption_configured
  for_each:
    discovery: aws.s3.bucket_encryption
    as: encryption
    item: bucket
  conditions:
    var: encryption.sse_algorithm
    op: exists
- title: S3 Bucket KMS Encryption Configured
  severity: medium
  rule_id: aws.s3.bucket.kms_encryption_configured
  for_each:
    discovery: aws.s3.bucket_encryption
    as: encryption
    item: bucket
  conditions:
    var: encryption.sse_algorithm
    op: equals
    value: aws:kms
- title: S3 Bucket Versioning Enabled
  severity: medium
  rule_id: aws.s3.bucket.versioning_enabled
  for_each:
    discovery: aws.s3.bucket_versioning
    as: versioning
    item: bucket
  conditions:
    var: versioning.versioning_enabled
    op: equals
    value: true
- title: S3 Bucket Access Logging Enabled
  severity: medium
  rule_id: aws.s3.bucket.access_logging_enabled
  for_each:
    discovery: aws.s3.bucket_logging
    as: logging
    item: bucket
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: S3 Bucket Block Public Access Enabled
  severity: critical
  rule_id: aws.s3.bucket.block_public_access_enabled
  for_each:
    discovery: aws.s3.public_access_block
    as: public_access
    item: bucket
  conditions:
    all:
    - var: public_access.block_public_acls
      op: equals
      value: true
    - var: public_access.ignore_public_acls
      op: equals
      value: true
    - var: public_access.block_public_policy
      op: equals
      value: true
    - var: public_access.restrict_public_buckets
      op: equals
      value: true
- title: S3 Bucket Block Public Access Configured
  severity: critical
  rule_id: aws.s3.bucket.block_public_access_configured
  for_each:
    discovery: aws.s3.public_access_block
    as: public_access
    item: bucket
  conditions:
    any:
    - var: public_access.block_public_acls
      op: equals
      value: true
    - var: public_access.block_public_policy
      op: equals
      value: true
- title: S3 Bucket Object Lock Enabled
  severity: medium
  rule_id: aws.s3.bucket.immutability_or_object_lock_if_supported
  for_each:
    discovery: aws.s3.bucket_object_lock
    as: object_lock
    item: bucket
  conditions:
    var: object_lock.object_lock_enabled
    op: equals
    value: true
- title: S3 Bucket Immutable or WORM Enabled
  severity: medium
  rule_id: aws.s3.bucket.immutable_or_worm_enabled_if_supported
  for_each:
    discovery: aws.s3.bucket_object_lock
    as: object_lock
    item: bucket
  conditions:
    var: object_lock.object_lock_enabled
    op: equals
    value: true
- title: S3 Bucket Lifecycle Policy Configured
  severity: low
  rule_id: aws.s3.bucket.lifecycle_policy_configured
  for_each:
    discovery: aws.s3.bucket_lifecycle
    as: lifecycle
    item: bucket
  conditions:
    var: lifecycle.lifecycle_enabled
    op: equals
    value: true
- title: S3 Bucket Lifecycle Enabled
  severity: low
  rule_id: aws.s3.bucket.lifecycle_enabled
  for_each:
    discovery: aws.s3.bucket_lifecycle
    as: lifecycle
    item: bucket
  conditions:
    var: lifecycle.lifecycle_enabled
    op: equals
    value: true
- title: S3 Bucket Replication Enabled
  severity: low
  rule_id: aws.s3.bucket.replication_enabled
  for_each:
    discovery: aws.s3.bucket_replication
    as: replication
    item: bucket
  conditions:
    var: replication.replication_enabled
    op: equals
    value: true
- title: 'S3 account: Level Public Access Blocks Configured'
  severity: high
  rule_id: aws.s3.account.level_public_access_blocks_configured
  for_each:
    discovery: aws.s3.account_public_access_block
    as: public_access
    item: account
  conditions:
    all:
    - var: public_access.block_public_acls
      op: equals
      value: true
    - var: public_access.ignore_public_acls
      op: equals
      value: true
    - var: public_access.block_public_policy
      op: equals
      value: true
    - var: public_access.restrict_public_buckets
      op: equals
      value: true
- title: 'S3 bucket: Backup Storage Immutability Enabled'
  severity: medium
  rule_id: aws.s3.bucket.backup_storage_immutability_enabled
  for_each:
    discovery: aws.s3.bucket_object_lock
    as: object_lock
    item: bucket
  conditions:
    var: object_lock.object_lock_enabled
    op: equals
    value: true
- title: 'S3 bucket: Cmk Cmek Configured'
  severity: medium
  rule_id: aws.s3.bucket.cmk_cmek_configured
  for_each:
    discovery: aws.s3.bucket_encryption
    as: bucket_encryption
    item: bucket
  conditions:
    all:
    - var: encryption.sse_algorithm
      op: equals
      value: aws:kms
    - var: encryption.kms_key_id
      op: exists
- title: 'S3 bucket: Cmk Cmek Key Configured'
  severity: medium
  rule_id: aws.s3.bucket.cmk_cmek_key_configured
  for_each:
    discovery: aws.s3.bucket_encryption
    as: bucket_encryption
    item: bucket
  conditions:
    all:
    - var: encryption.sse_algorithm
      op: equals
      value: aws:kms
    - var: encryption.kms_key_id
      op: exists
- title: 'S3 bucket: Destination Private Only Configured'
  severity: high
  rule_id: aws.s3.bucket.destination_private_only_configured
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: bucket
  conditions:
    var: bucket.compliant
    op: equals
    value: true
- title: 'S3 bucket: Encryption At Rest Cmek Configured'
  severity: high
  rule_id: aws.s3.bucket.encryption_at_rest_cmek_configured
  for_each:
    discovery: aws.s3.bucket_encryption
    as: bucket_encryption
    item: bucket
  conditions:
    all:
    - var: encryption.sse_algorithm
      op: equals
      value: aws:kms
    - var: encryption.kms_key_id
      op: exists
- title: Backup encryption is enabled
  severity: high
  rule_id: aws.s3.bucket.encryption_enabled
  for_each:
    discovery: aws.s3.bucket_encryption
    as: bucket_encryption
    item: bucket
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'S3 bucket: Encryption In Transit Tls Min 1 2 Configured'
  severity: high
  rule_id: aws.s3.bucket.encryption_in_transit_tls_min_1_2_configured
  for_each:
    discovery: aws.s3.bucket_policy
    as: bucket_policy
    item: bucket
  conditions:
    var: policy.has_tls_requirement
    op: equals
    value: true
- title: 'S3 bucket: Key Policy Least Privilege'
  severity: high
  rule_id: aws.s3.bucket.key_policy_least_privilege
  for_each:
    discovery: aws.s3.bucket_policy
    as: policy
    item: bucket
  conditions:
    var: policy.has_least_privilege
    op: equals
    value: true
- title: Create immutable backup copies
  severity: medium
  rule_id: aws.s3.bucket.key_rotation_enabled
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: bucket
  conditions:
    var: bucket.compliant
    op: equals
    value: true
- title: 'S3 bucket: Metrics Enabled'
  severity: medium
  rule_id: aws.s3.bucket.metrics_enabled
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: bucket
  conditions:
    var: bucket.metrics_enabled
    op: equals
    value: true
- title: Compliance logging is enabled
  severity: medium
  rule_id: aws.s3.bucket.object_level_write_logging_enabled
  for_each:
    discovery: aws.s3.bucket_logging
    as: logging
    item: bucket
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'S3 bucket: Object Versioning Configured'
  severity: low
  rule_id: aws.s3.bucket.object_versioning_configured
  for_each:
    discovery: aws.s3.bucket_versioning
    as: versioning
    item: bucket
  conditions:
    var: versioning.versioning_enabled
    op: equals
    value: true
- title: 'S3 bucket: Policy Denies Public And Insecure Configured'
  severity: high
  rule_id: aws.s3.bucket.policy_denies_public_and_insecure_configured
  for_each:
    discovery: aws.s3.public_access_block
    as: public_access
    item: bucket
  conditions:
    all:
    - var: public_access.block_public_acls
      op: equals
      value: true
    - var: public_access.ignore_public_acls
      op: equals
      value: true
- title: 'S3 bucket: Policy Public Write Access Configured'
  severity: high
  rule_id: aws.s3.bucket.policy_public_write_access_configured
  for_each:
    discovery: aws.s3.public_access_block
    as: public_access
    item: bucket
  conditions:
    all:
    - var: public_access.block_public_acls
      op: equals
      value: true
    - var: public_access.ignore_public_acls
      op: equals
      value: true
- title: 'S3 bucket: Public Access Configured'
  severity: high
  rule_id: aws.s3.bucket.public_access_configured
  for_each:
    discovery: aws.s3.public_access_block
    as: public_access
    item: bucket
  conditions:
    all:
    - var: public_access.block_public_acls
      op: equals
      value: true
    - var: public_access.ignore_public_acls
      op: equals
      value: true
- title: 'S3 bucket: Public Read Prohibited Configured'
  severity: high
  rule_id: aws.s3.bucket.public_read_prohibited_configured
  for_each:
    discovery: aws.s3.public_access_block
    as: public_access
    item: bucket
  conditions:
    all:
    - var: public_access.block_public_acls
      op: equals
      value: true
    - var: public_access.ignore_public_acls
      op: equals
      value: true
- title: 'S3 bucket: Public Write Prohibited Configured'
  severity: high
  rule_id: aws.s3.bucket.public_write_prohibited_configured
  for_each:
    discovery: aws.s3.public_access_block
    as: public_access
    item: bucket
  conditions:
    all:
    - var: public_access.block_public_acls
      op: equals
      value: true
    - var: public_access.ignore_public_acls
      op: equals
      value: true
- title: 'S3 bucket: Rbac Least Privilege'
  severity: high
  rule_id: aws.s3.bucket.rbac_least_privilege
  for_each:
    discovery: aws.s3.bucket_policy
    as: policy
    item: bucket
  conditions:
    var: policy.has_least_privilege
    op: equals
    value: true
- title: 'S3 bucket: Require Tls In Transit Configured'
  severity: high
  rule_id: aws.s3.bucket.require_tls_in_transit_configured
  for_each:
    discovery: aws.s3.bucket_policy
    as: bucket_policy
    item: bucket
  conditions:
    var: policy.has_tls_requirement
    op: equals
    value: true
- title: 'S3 bucket: Retention Days Minimum'
  severity: low
  rule_id: aws.s3.bucket.retention_days_minimum
  for_each:
    discovery: aws.s3.bucket_lifecycle
    as: lifecycle
    item: bucket
  conditions:
    var: lifecycle.lifecycle_enabled
    op: equals
    value: true
- title: 'S3 bucket: S3 Encrypted At Rest'
  severity: high
  rule_id: aws.s3.bucket.s3_encrypted_at_rest
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: bucket
  conditions:
    var: bucket.compliant
    op: equals
    value: true
- title: 'S3 bucket: Schedule Defined Min Frequency Configured'
  severity: medium
  rule_id: aws.s3.bucket.schedule_defined_min_frequency_configured
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: bucket
  conditions:
    var: bucket.compliant
    op: equals
    value: true
- title: 'S3 bucket: Secure Transport Policy Configured'
  severity: high
  rule_id: aws.s3.bucket.secure_transport_policy_configured
  for_each:
    discovery: aws.s3.bucket_policy
    as: policy
    item: bucket
  conditions:
    var: policy.has_least_privilege
    op: equals
    value: true
- title: Audit public access permissions
  severity: medium
  rule_id: aws.s3.bucket.server_access_logging_enabled
  for_each:
    discovery: aws.s3.bucket_logging
    as: logging
    item: bucket
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'S3 bucket: Storage Encrypted And Private'
  severity: high
  rule_id: aws.s3.bucket.storage_encrypted_and_private
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: bucket
  conditions:
    var: bucket.compliant
    op: equals
    value: true
- title: 'S3 bucket encryption: Bucket At Rest Cmek Enabled'
  severity: medium
  rule_id: aws.s3.bucket_encryption.bucket_at_rest_cmek_enabled
  for_each:
    discovery: aws.s3.bucket_encryption
    as: bucket_encryption
    item: bucket_encryption
  conditions:
    all:
    - var: encryption.sse_algorithm
      op: equals
      value: aws:kms
    - var: encryption.kms_key_id
      op: exists
- title: 'S3 bucket encryption: In Transit Tls Min 1 2 Configured'
  severity: high
  rule_id: aws.s3.bucket_encryption.in_transit_tls_min_1_2_configured
  for_each:
    discovery: aws.s3.bucket_policy
    as: bucket_policy
    item: bucket_encryption
  conditions:
    var: policy.has_tls_requirement
    op: equals
    value: true
- title: 'S3 bucket notification: Bucket Cross Account Destinations Restricted'
  severity: medium
  rule_id: aws.s3.bucket_notification.bucket_cross_account_destinations_restricted
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: bucket_notification
  conditions:
    var: bucket.compliant
    op: equals
    value: true
- title: 'S3 bucket notification: Bucket Destination Encrypted'
  severity: high
  rule_id: aws.s3.bucket_notification.bucket_destination_encrypted
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: bucket_notification
  conditions:
    var: bucket.compliant
    op: equals
    value: true
- title: 'S3 bucket notification: Bucket Destination Least Privilege'
  severity: high
  rule_id: aws.s3.bucket_notification.bucket_destination_least_privilege
  for_each:
    discovery: aws.s3.bucket_policy
    as: policy
    item: bucket_notification
  conditions:
    var: policy.has_least_privilege
    op: equals
    value: true
- title: 'S3 bucketpolicy: Bucket Deny Insecure Transport Configured'
  severity: medium
  rule_id: aws.s3.bucketpolicy.bucket_deny_insecure_transport_configured
  for_each:
    discovery: aws.s3.bucket_encryption
    as: bucket_encryption
    item: bucketpolicy
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'S3 bucketpolicy: Bucket Deny Unencrypted Puts'
  severity: high
  rule_id: aws.s3.bucketpolicy.bucket_deny_unencrypted_puts
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: bucketpolicy
  conditions:
    var: bucket.compliant
    op: equals
    value: true
- title: 'S3 bucketpolicy: Bucket No Wildcards On Actions Or Principals Configured'
  severity: medium
  rule_id: aws.s3.bucketpolicy.bucket_no_wildcards_on_actions_or_principals_configured
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: bucketpolicy
  conditions:
    var: bucket.compliant
    op: equals
    value: true
- title: 'S3 bucketpolicy: No Public Principals Configured'
  severity: high
  rule_id: aws.s3.bucketpolicy.no_public_principals_configured
  for_each:
    discovery: aws.s3.public_access_block
    as: public_access
    item: bucketpolicy
  conditions:
    all:
    - var: public_access.block_public_acls
      op: equals
      value: true
    - var: public_access.ignore_public_acls
      op: equals
      value: true
- title: 'S3 intelligent tiering: Bucket Enforced On Sensitive Datasets Configured'
  severity: medium
  rule_id: aws.s3.intelligent_tiering.bucket_enforced_on_sensitive_datasets_configured
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: intelligent_tiering
  conditions:
    var: bucket.compliant
    op: equals
    value: true
- title: 'S3 intelligent tiering: Policies Configured'
  severity: medium
  rule_id: aws.s3.intelligent_tiering.policies_configured
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: intelligent_tiering
  conditions:
    var: bucket.compliant
    op: equals
    value: true
- title: 'S3 intelligent tiering: Protected From Public Override Configured'
  severity: high
  rule_id: aws.s3.intelligent_tiering.protected_from_public_override_configured
  for_each:
    discovery: aws.s3.public_access_block
    as: public_access
    item: account
  conditions:
    all:
    - var: public_access.block_public_acls
      op: equals
      value: true
    - var: public_access.ignore_public_acls
      op: equals
      value: true
- title: 'S3 lifecycle configuration: Bucket Enforced On Sensitive Datasets Configured'
  severity: medium
  rule_id: aws.s3.lifecycle_configuration.bucket_enforced_on_sensitive_datasets_configured
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: lifecycle_configuration
  conditions:
    var: bucket.compliant
    op: equals
    value: true
- title: 'S3 lifecycle configuration: Certificate Expiration Rules Configured'
  severity: medium
  rule_id: aws.s3.lifecycle_configuration.certificate_expiration_rules_configured
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: lifecycle_configuration
  conditions:
    var: bucket.compliant
    op: equals
    value: true
- title: 'S3 lifecycle configuration: Immutable Retention Locked Where Required'
  severity: low
  rule_id: aws.s3.lifecycle_configuration.immutable_retention_locked_where_required
  for_each:
    discovery: aws.s3.bucket_lifecycle
    as: lifecycle
    item: lifecycle_configuration
  conditions:
    var: lifecycle.lifecycle_enabled
    op: equals
    value: true
- title: 'S3 lifecycle configuration: Policies Configured'
  severity: medium
  rule_id: aws.s3.lifecycle_configuration.policies_configured
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: lifecycle_configuration
  conditions:
    var: bucket.compliant
    op: equals
    value: true
- title: 'S3 lifecycle configuration: Protected From Public Override Configured'
  severity: high
  rule_id: aws.s3.lifecycle_configuration.protected_from_public_override_configured
  for_each:
    discovery: aws.s3.public_access_block
    as: public_access
    item: account
  conditions:
    all:
    - var: public_access.block_public_acls
      op: equals
      value: true
    - var: public_access.ignore_public_acls
      op: equals
      value: true
- title: 'S3 lifecycle configuration: Versioning Enabled If Supported'
  severity: low
  rule_id: aws.s3.lifecycle_configuration.versioning_enabled_if_supported
  for_each:
    discovery: aws.s3.bucket_versioning
    as: versioning
    item: lifecycle_configuration
  conditions:
    var: versioning.versioning_enabled
    op: equals
    value: true
- title: 'S3 macie classification jobs status: Macie Classification Jobs Status Configured'
  severity: medium
  rule_id: aws.s3.macie_classification_jobs_status.macie_classification_jobs_status_configured
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: macie_classification_jobs_status
  conditions:
    var: bucket.macie_enabled
    op: equals
    value: true
- title: Encrypt data in public buckets
  severity: medium
  rule_id: aws.s3.object.encryption_at_rest_enabled
  for_each:
    discovery: aws.s3.bucket_encryption
    as: bucket_encryption
    item: object
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'S3 object: Lock Or Immutability Enabled If Supported'
  severity: medium
  rule_id: aws.s3.object.lock_or_immutability_enabled_if_supported
  for_each:
    discovery: aws.s3.bucket_object_lock
    as: object_lock
    item: object
  conditions:
    var: object_lock.object_lock_enabled
    op: equals
    value: true
- title: 'S3 object: Not Publicly Readable Configured'
  severity: high
  rule_id: aws.s3.object.not_publicly_readable_configured
  for_each:
    discovery: aws.s3.public_access_block
    as: public_access
    item: account
  conditions:
    all:
    - var: public_access.block_public_acls
      op: equals
      value: true
    - var: public_access.ignore_public_acls
      op: equals
      value: true
- title: 'S3 replication: Auth Roles Least Privilege'
  severity: high
  rule_id: aws.s3.replication.auth_roles_least_privilege
  for_each:
    discovery: aws.s3.bucket_policy
    as: policy
    item: replication
  conditions:
    var: policy.has_least_privilege
    op: equals
    value: true
- title: 'S3 replication: Encryption In Transit Tls Required'
  severity: high
  rule_id: aws.s3.replication.encryption_in_transit_tls_required
  for_each:
    discovery: aws.s3.bucket_policy
    as: bucket_policy
    item: replication
  conditions:
    var: policy.has_tls_requirement
    op: equals
    value: true
- title: 'S3 replication: Lag Monitoring Alerts Enabled'
  severity: medium
  rule_id: aws.s3.replication.lag_monitoring_alerts_enabled
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: replication
  conditions:
    var: bucket.compliant
    op: equals
    value: true
- title: 'S3 website https only: Website Https Only Configured'
  severity: medium
  rule_id: aws.s3.website_https_only.website_https_only_configured
  for_each:
    discovery: aws.s3.buckets
    as: bucket
    item: website_https_only
  conditions:
    var: bucket.compliant
    op: equals
    value: true
