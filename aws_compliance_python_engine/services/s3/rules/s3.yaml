version: '1.0'
provider: aws
service: s3
services:
  client: s3
  module: boto3.client
discovery:
- discovery_id: aws.s3.list_buckets
  calls:
  - action: list_buckets
    save_as: response
  emit:
    items_for: '{{ response.Buckets }}'
    as: resource
    item:
      Name: '{{ resource.Name }}'
      CreationDate: '{{ resource.CreationDate }}'
      BucketRegion: '{{ resource.BucketRegion }}'
      BucketArn: '{{ resource.BucketArn }}'
- discovery_id: aws.s3.get_bucket_abac
  calls:
  - action: get_bucket_abac
    save_as: response
  emit:
    item:
      Status: '{{ response.AbacStatus.Status }}'
- discovery_id: aws.s3.complete_multipart_upload
  calls:
  - action: complete_multipart_upload
    save_as: response
  emit:
    item:
      BucketKeyEnabled: '{{ response.BucketKeyEnabled }}'
      SSEKMSKeyId: '{{ response.SSEKMSKeyId }}'
      ServerSideEncryption: '{{ response.ServerSideEncryption }}'
- discovery_id: aws.s3.get_public_access_block
  calls:
  - action: get_public_access_block
    save_as: response
  emit:
    item:
      BlockPublicAcls: '{{ response.PublicAccessBlockConfiguration.BlockPublicAcls
        }}'
      IgnorePublicAcls: '{{ response.PublicAccessBlockConfiguration.IgnorePublicAcls
        }}'
      BlockPublicPolicy: '{{ response.PublicAccessBlockConfiguration.BlockPublicPolicy
        }}'
      RestrictPublicBuckets: '{{ response.PublicAccessBlockConfiguration.RestrictPublicBuckets
        }}'
      PublicAccessBlockConfiguration: '{{ resource.PublicAccessBlockConfiguration
        }}'
- discovery_id: aws.s3.get_bucket_policy
  calls:
  - action: get_bucket_policy
    save_as: response
  emit:
    item:
      Policy: '{{ response.Policy }}'
- discovery_id: aws.s3.get_bucket_logging
  calls:
  - action: get_bucket_logging
    save_as: response
  emit:
    item:
      TargetBucket: '{{ response.LoggingEnabled.TargetBucket }}'
      TargetGrants: '{{ response.LoggingEnabled.TargetGrants }}'
      TargetPrefix: '{{ response.LoggingEnabled.TargetPrefix }}'
      TargetObjectKeyFormat: '{{ response.LoggingEnabled.TargetObjectKeyFormat }}'
      LoggingEnabled: '{{ resource.LoggingEnabled }}'
- discovery_id: aws.s3.get_object_lock_configuration
  calls:
  - action: get_object_lock_configuration
    save_as: response
  emit:
    item:
      ObjectLockEnabled: '{{ response.ObjectLockConfiguration.ObjectLockEnabled }}'
      Rule: '{{ response.ObjectLockConfiguration.Rule }}'
      ObjectLockConfiguration: '{{ resource.ObjectLockConfiguration }}'
- discovery_id: aws.s3.get_bucket_inventory_configuration
  calls:
  - action: get_bucket_inventory_configuration
    save_as: response
  emit:
    item:
      Destination: '{{ response.InventoryConfiguration.Destination }}'
      IsEnabled: '{{ response.InventoryConfiguration.IsEnabled }}'
      Filter: '{{ response.InventoryConfiguration.Filter }}'
      Id: '{{ response.InventoryConfiguration.Id }}'
      IncludedObjectVersions: '{{ response.InventoryConfiguration.IncludedObjectVersions
        }}'
      OptionalFields: '{{ response.InventoryConfiguration.OptionalFields }}'
      Schedule: '{{ response.InventoryConfiguration.Schedule }}'
- discovery_id: aws.s3.get_bucket_replication
  calls:
  - action: get_bucket_replication
    save_as: response
  emit:
    item:
      Role: '{{ response.ReplicationConfiguration.Role }}'
      Rules: '{{ response.ReplicationConfiguration.Rules }}'
      ReplicationConfiguration: '{{ resource.ReplicationConfiguration }}'
- discovery_id: aws.s3.get_bucket_metrics_configuration
  calls:
  - action: get_bucket_metrics_configuration
    save_as: response
  emit:
    item:
      Id: '{{ response.MetricsConfiguration.Id }}'
      Filter: '{{ response.MetricsConfiguration.Filter }}'
      MetricsConfiguration: '{{ resource.MetricsConfiguration }}'
- discovery_id: aws.s3.get_object
  calls:
  - action: get_object
    save_as: response
  emit:
    item:
      ReplicationStatus: '{{ response.ReplicationStatus }}'
- discovery_id: aws.s3.get_bucket_intelligent_tiering_configuration
  calls:
  - action: get_bucket_intelligent_tiering_configuration
    save_as: response
  emit:
    item:
      Id: '{{ response.IntelligentTieringConfiguration.Id }}'
      Filter: '{{ response.IntelligentTieringConfiguration.Filter }}'
      Status: '{{ response.IntelligentTieringConfiguration.Status }}'
      Tierings: '{{ response.IntelligentTieringConfiguration.Tierings }}'
      IntelligentTieringConfiguration: '{{ resource.IntelligentTieringConfiguration
        }}'
- discovery_id: aws.s3.get_bucket_policy_status
  calls:
  - action: get_bucket_policy_status
    save_as: response
  emit:
    item:
      IsPublic: '{{ response.PolicyStatus.IsPublic }}'
- discovery_id: aws.s3.get_bucket_cors
  calls:
  - action: get_bucket_cors
    save_as: response
  emit:
    item:
      ID: '{{ response.CORSRules.ID }}'
      AllowedHeaders: '{{ response.CORSRules.AllowedHeaders }}'
      AllowedMethods: '{{ response.CORSRules.AllowedMethods }}'
      AllowedOrigins: '{{ response.CORSRules.AllowedOrigins }}'
      ExposeHeaders: '{{ response.CORSRules.ExposeHeaders }}'
      MaxAgeSeconds: '{{ response.CORSRules.MaxAgeSeconds }}'
      Rule: '{{ resource.Rule }}'
      Rules: '{{ resource.Rules }}'
checks:
- rule_id: aws.s3.macie_classification_jobs_status.macie_classification_jobs_status_configured
  for_each: aws.s3.get_bucket_abac
  conditions:
    var: item.Status
    op: equals
    value: Enabled
- rule_id: aws.s3.bucket.encryption_enabled
  for_each: aws.s3.complete_multipart_upload
  conditions:
    var: item.ServerSideEncryption
    op: equals
    value: AES-256
- rule_id: aws.s3.bucket.object_versioning_configured
  for_each: aws.s3.get_bucket_abac
  conditions:
    var: item.Status
    op: equals
    value: Enabled
- rule_id: aws.s3.bucket.destination_private_only_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    var: item.PublicAccessBlockConfiguration
    op: equals
    value: 'true'
- rule_id: aws.s3.bucket.key_rotation_enabled
  for_each: aws.s3.complete_multipart_upload
  conditions:
    var: item.BucketKeyEnabled
    op: equals
    value: 'true'
- rule_id: aws.s3.bucket_notification.bucket_destination_least_privilege
  for_each: aws.s3.get_bucket_policy
  conditions:
    var: item.Policy
    op: not_equals
    value: 'null'
- rule_id: aws.s3.bucket.object_level_write_logging_enabled
  for_each: aws.s3.get_bucket_logging
  conditions:
    var: item.LoggingEnabled
    op: equals
    value: 'true'
- rule_id: aws.s3.bucket_notification.bucket_destination_encrypted
  for_each: aws.s3.complete_multipart_upload
  conditions:
    var: item.ServerSideEncryption
    op: equals
    value: AES256
- rule_id: aws.s3.bucket.cmk_cmek_key_configured
  for_each: aws.s3.complete_multipart_upload
  conditions:
    var: item.SSEKMSKeyId
    op: not_equals
    value: 'null'
- rule_id: aws.s3.website_https_only.website_https_only_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    var: item.PublicAccessBlockConfiguration
    op: not_equals
    value: 'null'
- rule_id: aws.s3.bucketpolicy.no_public_principals_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    var: item.BlockPublicPolicy
    op: equals
    value: 'false'
- rule_id: aws.s3.bucket.require_tls_in_transit_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    var: item.PublicAccessBlockConfiguration
    op: not_equals
    value: 'null'
- rule_id: aws.s3.bucketpolicy.bucket_deny_insecure_transport_configured
  for_each: aws.s3.complete_multipart_upload
  conditions:
    var: item.ServerSideEncryption
    op: equals
    value: AES-256
- rule_id: aws.s3.bucket.s3_encrypted_at_rest
  for_each: aws.s3.complete_multipart_upload
  conditions:
    var: item.ServerSideEncryption
    op: equals
    value: AES256
- rule_id: aws.s3.bucketpolicy.bucket_deny_unencrypted_puts
  for_each: aws.s3.complete_multipart_upload
  conditions:
    var: item.BucketKeyEnabled
    op: equals
    value: 'false'
- rule_id: aws.s3.bucket.block_public_access_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    var: item.BlockPublicAcls
    op: equals
    value: 'true'
- rule_id: aws.s3.object.lock_or_immutability_enabled_if_supported
  for_each: aws.s3.get_object_lock_configuration
  conditions:
    var: item.ObjectLockEnabled
    op: equals
    value: 'true'
- rule_id: aws.s3.bucket.schedule_defined_min_frequency_configured
  for_each: aws.s3.get_bucket_inventory_configuration
  conditions:
    var: item.Schedule
    op: not_equals
    value: 'null'
- rule_id: aws.s3.account.level_public_access_blocks_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    var: item.BlockPublicAcls
    op: equals
    value: 'true'
- rule_id: aws.s3.bucket.policy_public_write_access_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    var: item.PublicAccessBlockConfiguration
    op: not_equals
    value: 'null'
- rule_id: aws.s3.bucket.storage_encrypted_and_private
  for_each: aws.s3.complete_multipart_upload
  conditions:
    var: item.ServerSideEncryption
    op: equals
    value: AES256
- rule_id: aws.s3.bucket.public_access_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    var: item.PublicAccessBlockConfiguration
    op: not_equals
    value: 'null'
- rule_id: aws.s3.bucket.lifecycle_enabled
  for_each: aws.s3.get_bucket_inventory_configuration
  conditions:
    var: item.IsEnabled
    op: equals
    value: 'true'
- rule_id: aws.s3.bucket_encryption.bucket_at_rest_cmek_enabled
  for_each: aws.s3.complete_multipart_upload
  conditions:
    var: item.ServerSideEncryption
    op: equals
    value: aws:kms
- rule_id: aws.s3.bucket.block_public_access_enabled
  for_each: aws.s3.get_public_access_block
  conditions:
    var: item.BlockPublicAcls
    op: equals
    value: 'true'
- rule_id: aws.s3.replication.encryption_in_transit_tls_required
  for_each: aws.s3.get_bucket_policy
  conditions:
    var: item.Policy
    op: contains
    value: '{"Condition":{"Bool":{"aws:SecureTransport":"false"}}}'
- rule_id: aws.s3.bucket.rbac_least_privilege
  for_each: aws.s3.get_bucket_policy
  conditions:
    var: item.Policy
    op: not_equals
    value: 'null'
- rule_id: aws.s3.lifecycle_configuration.bucket_enforced_on_sensitive_datasets_configured
  for_each: aws.s3.get_bucket_replication
  conditions:
    var: item.ReplicationConfiguration
    op: not_equals
    value: 'null'
- rule_id: aws.s3.lifecycle_configuration.versioning_enabled_if_supported
  for_each: aws.s3.get_bucket_inventory_configuration
  conditions:
    var: item.IsEnabled
    op: equals
    value: 'true'
- rule_id: aws.s3.bucket.metrics_enabled
  for_each: aws.s3.get_bucket_metrics_configuration
  conditions:
    var: item.MetricsConfiguration
    op: not_equals
    value: 'null'
- rule_id: aws.s3.lifecycle_configuration.immutable_retention_locked_where_required
  for_each: aws.s3.get_object_lock_configuration
  conditions:
    var: item.ObjectLockConfiguration
    op: not_equals
    value: 'null'
- rule_id: aws.s3.bucket.immutable_or_worm_enabled_if_supported
  for_each: aws.s3.get_object_lock_configuration
  conditions:
    var: item.ObjectLockEnabled
    op: equals
    value: 'true'
- rule_id: aws.s3.bucket.versioning_enabled
  for_each: aws.s3.get_bucket_inventory_configuration
  conditions:
    var: item.IsEnabled
    op: equals
    value: 'true'
- rule_id: aws.s3.bucket.access_logging_enabled
  for_each: aws.s3.get_bucket_logging
  conditions:
    var: item.LoggingEnabled
    op: equals
    value: 'true'
- rule_id: aws.s3.lifecycle_configuration.policies_configured
  for_each: aws.s3.get_bucket_replication
  conditions:
    var: item.ReplicationConfiguration
    op: not_equals
    value: 'null'
- rule_id: aws.s3.bucket.server_access_logging_enabled
  for_each: aws.s3.get_bucket_logging
  conditions:
    var: item.LoggingEnabled
    op: equals
    value: 'true'
- rule_id: aws.s3.bucket_encryption.in_transit_tls_min_1_2_configured
  for_each: aws.s3.complete_multipart_upload
  conditions:
    var: item.ServerSideEncryption
    op: equals
    value: AES256
- rule_id: aws.s3.bucket.key_policy_least_privilege
  for_each: aws.s3.get_bucket_policy
  conditions:
    var: item.Policy
    op: not_equals
    value: 'null'
- rule_id: aws.s3.bucket.encryption_at_rest_enabled
  for_each: aws.s3.complete_multipart_upload
  conditions:
    var: item.ServerSideEncryption
    op: equals
    value: AES256
- rule_id: aws.s3.bucket.default_encryption_configured
  for_each: aws.s3.complete_multipart_upload
  conditions:
    var: item.ServerSideEncryption
    op: equals
    value: AES256
- rule_id: aws.s3.bucket.public_write_prohibited_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    var: item.PublicAccessBlockConfiguration
    op: not_equals
    value: 'null'
- rule_id: aws.s3.intelligent_tiering.protected_from_public_override_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    var: item.PublicAccessBlockConfiguration
    op: equals
    value: 'null'
- rule_id: aws.s3.replication.auth_roles_least_privilege
  for_each: aws.s3.get_bucket_policy
  conditions:
    var: item.Policy
    op: not_equals
    value: 'null'
- rule_id: aws.s3.bucket.policy_denies_public_and_insecure_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    var: item.BlockPublicAcls
    op: equals
    value: 'false'
- rule_id: aws.s3.replication.lag_monitoring_alerts_enabled
  for_each: aws.s3.get_object
  conditions:
    var: item.ReplicationStatus
    op: equals
    value: Enabled
- rule_id: aws.s3.object.encryption_at_rest_enabled
  for_each: aws.s3.complete_multipart_upload
  conditions:
    var: item.ServerSideEncryption
    op: equals
    value: AES-256
- rule_id: aws.s3.intelligent_tiering.policies_configured
  for_each: aws.s3.get_bucket_intelligent_tiering_configuration
  conditions:
    var: item.IntelligentTieringConfiguration
    op: not_equals
    value: 'null'
- rule_id: aws.s3.bucket.cmk_cmek_configured
  for_each: aws.s3.complete_multipart_upload
  conditions:
    var: item.ServerSideEncryption
    op: equals
    value: aws:kms
- rule_id: aws.s3.bucket.kms_encryption_configured
  for_each: aws.s3.complete_multipart_upload
  conditions:
    var: item.ServerSideEncryption
    op: equals
    value: aws:kms
- rule_id: aws.s3.bucketpolicy.bucket_no_wildcards_on_actions_or_principals_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    var: item.PublicAccessBlockConfiguration
    op: not_equals
    value: 'null'
- rule_id: aws.s3.bucket.immutability_or_object_lock_if_supported
  for_each: aws.s3.get_object_lock_configuration
  conditions:
    var: item.ObjectLockEnabled
    op: equals
    value: 'true'
- rule_id: aws.s3.intelligent_tiering.bucket_enforced_on_sensitive_datasets_configured
  for_each: aws.s3.get_bucket_intelligent_tiering_configuration
  conditions:
    var: item.IntelligentTieringConfiguration
    op: equals
    value: 'true'
- rule_id: aws.s3.object.not_publicly_readable_configured
  for_each: aws.s3.get_bucket_policy_status
  conditions:
    var: item.IsPublic
    op: equals
    value: 'false'
- rule_id: aws.s3.bucket.public_read_prohibited_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    var: item.PublicAccessBlockConfiguration
    op: not_equals
    value: 'null'
- rule_id: aws.s3.lifecycle_configuration.protected_from_public_override_configured
  for_each: aws.s3.get_public_access_block
  conditions:
    var: item.PublicAccessBlockConfiguration
    op: equals
    value: 'null'
- rule_id: aws.s3.lifecycle_configuration.certificate_expiration_rules_configured
  for_each: aws.s3.get_bucket_cors
  conditions:
    var: item.Rules
    op: not_equals
    value: 'null'
- rule_id: aws.s3.bucket.lifecycle_policy_configured
  for_each: aws.s3.get_bucket_cors
  conditions:
    var: item.Rule
    op: not_equals
    value: 'null'
- rule_id: aws.s3.bucket.secure_transport_policy_configured
  for_each: aws.s3.get_bucket_policy
  conditions:
    var: item.Policy
    op: contains
    value: SecureTransport
- rule_id: aws.s3.bucket.backup_storage_immutability_enabled
  for_each: aws.s3.get_object_lock_configuration
  conditions:
    var: item.ObjectLockEnabled
    op: equals
    value: 'true'
- rule_id: aws.s3.bucket_notification.bucket_cross_account_destinations_restricted
  for_each: aws.s3.get_bucket_logging
  conditions:
    var: item.TargetBucket
    op: not_equals
    value: 'null'
- rule_id: aws.s3.bucket.replication_enabled
  for_each: aws.s3.get_bucket_replication
  conditions:
    var: item.ReplicationConfiguration
    op: not_equals
    value: 'null'
- rule_id: aws.s3.bucket.encryption_in_transit_tls_min_1_2_configured
  for_each: aws.s3.get_bucket_policy
  conditions:
    var: item.Policy
    op: contains
    value: '{"Effect":"Deny","Principal":"*","Action":"s3:*","Condition":{"Bool":{"aws:SecureTransport":"false"}}}'
- rule_id: aws.s3.bucket.encryption_at_rest_cmek_configured
  for_each: aws.s3.complete_multipart_upload
  conditions:
    var: item.ServerSideEncryption
    op: equals
    value: aws:kms
- rule_id: aws.s3.bucket.retention_days_minimum
  for_each: aws.s3.list_buckets
  conditions:
    var: item.Name
    op: exists
