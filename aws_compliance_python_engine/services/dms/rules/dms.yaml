version: '1.0'
provider: aws
service: dms
services:
  client: dms
  module: boto3.client
discovery:
- discovery_id: aws.dms.describe_replication_instances
  calls:
  - action: describe_replication_instances
    save_as: response
  emit:
    item:
      ReplicationInstanceIdentifier: '{{ response.ReplicationInstances.ReplicationInstanceIdentifier
        }}'
      ReplicationInstanceClass: '{{ response.ReplicationInstances.ReplicationInstanceClass
        }}'
      ReplicationInstanceStatus: '{{ response.ReplicationInstances.ReplicationInstanceStatus
        }}'
      AllocatedStorage: '{{ response.ReplicationInstances.AllocatedStorage }}'
      InstanceCreateTime: '{{ response.ReplicationInstances.InstanceCreateTime }}'
      VpcSecurityGroups: '{{ response.ReplicationInstances.VpcSecurityGroups }}'
      AvailabilityZone: '{{ response.ReplicationInstances.AvailabilityZone }}'
      ReplicationSubnetGroup: '{{ response.ReplicationInstances.ReplicationSubnetGroup
        }}'
      PreferredMaintenanceWindow: '{{ response.ReplicationInstances.PreferredMaintenanceWindow
        }}'
      PendingModifiedValues: '{{ response.ReplicationInstances.PendingModifiedValues
        }}'
      MultiAZ: '{{ response.ReplicationInstances.MultiAZ }}'
      EngineVersion: '{{ response.ReplicationInstances.EngineVersion }}'
      AutoMinorVersionUpgrade: '{{ response.ReplicationInstances.AutoMinorVersionUpgrade
        }}'
      KmsKeyId: '{{ response.ReplicationInstances.KmsKeyId }}'
      ReplicationInstanceArn: '{{ response.ReplicationInstances.ReplicationInstanceArn
        }}'
      ReplicationInstancePublicIpAddress: '{{ response.ReplicationInstances.ReplicationInstancePublicIpAddress
        }}'
      ReplicationInstancePrivateIpAddress: '{{ response.ReplicationInstances.ReplicationInstancePrivateIpAddress
        }}'
      ReplicationInstancePublicIpAddresses: '{{ response.ReplicationInstances.ReplicationInstancePublicIpAddresses
        }}'
      ReplicationInstancePrivateIpAddresses: '{{ response.ReplicationInstances.ReplicationInstancePrivateIpAddresses
        }}'
      ReplicationInstanceIpv6Addresses: '{{ response.ReplicationInstances.ReplicationInstanceIpv6Addresses
        }}'
      PubliclyAccessible: '{{ response.ReplicationInstances.PubliclyAccessible }}'
      SecondaryAvailabilityZone: '{{ response.ReplicationInstances.SecondaryAvailabilityZone
        }}'
      FreeUntil: '{{ response.ReplicationInstances.FreeUntil }}'
      DnsNameServers: '{{ response.ReplicationInstances.DnsNameServers }}'
      NetworkType: '{{ response.ReplicationInstances.NetworkType }}'
      KerberosAuthenticationSettings: '{{ response.ReplicationInstances.KerberosAuthenticationSettings
        }}'
- discovery_id: aws.dms.describe_event_subscriptions
  calls:
  - action: describe_event_subscriptions
    save_as: response
  emit:
    item:
      CustomerAwsId: '{{ response.EventSubscriptionsList.CustomerAwsId }}'
      CustSubscriptionId: '{{ response.EventSubscriptionsList.CustSubscriptionId }}'
      SnsTopicArn: '{{ response.EventSubscriptionsList.SnsTopicArn }}'
      Status: '{{ response.EventSubscriptionsList.Status }}'
      SubscriptionCreationTime: '{{ response.EventSubscriptionsList.SubscriptionCreationTime
        }}'
      SourceType: '{{ response.EventSubscriptionsList.SourceType }}'
      SourceIdsList: '{{ response.EventSubscriptionsList.SourceIdsList }}'
      EventCategoriesList: '{{ response.EventSubscriptionsList.EventCategoriesList
        }}'
      Enabled: '{{ response.EventSubscriptionsList.Enabled }}'
- discovery_id: aws.dms.describe_instance_profiles
  calls:
  - action: describe_instance_profiles
    save_as: response
  emit:
    item:
      InstanceProfileArn: '{{ response.InstanceProfiles.InstanceProfileArn }}'
      AvailabilityZone: '{{ response.InstanceProfiles.AvailabilityZone }}'
      KmsKeyArn: '{{ response.InstanceProfiles.KmsKeyArn }}'
      PubliclyAccessible: '{{ response.InstanceProfiles.PubliclyAccessible }}'
      NetworkType: '{{ response.InstanceProfiles.NetworkType }}'
      InstanceProfileName: '{{ response.InstanceProfiles.InstanceProfileName }}'
      Description: '{{ response.InstanceProfiles.Description }}'
      InstanceProfileCreationTime: '{{ response.InstanceProfiles.InstanceProfileCreationTime
        }}'
      SubnetGroupIdentifier: '{{ response.InstanceProfiles.SubnetGroupIdentifier }}'
      VpcSecurityGroups: '{{ response.InstanceProfiles.VpcSecurityGroups }}'
- discovery_id: aws.dms.describe_endpoints
  calls:
  - action: describe_endpoints
    save_as: response
  emit:
    item:
      EndpointIdentifier: '{{ response.Endpoints.EndpointIdentifier }}'
      EndpointType: '{{ response.Endpoints.EndpointType }}'
      EngineName: '{{ response.Endpoints.EngineName }}'
      EngineDisplayName: '{{ response.Endpoints.EngineDisplayName }}'
      Username: '{{ response.Endpoints.Username }}'
      ServerName: '{{ response.Endpoints.ServerName }}'
      Port: '{{ response.Endpoints.Port }}'
      DatabaseName: '{{ response.Endpoints.DatabaseName }}'
      ExtraConnectionAttributes: '{{ response.Endpoints.ExtraConnectionAttributes
        }}'
      Status: '{{ response.Endpoints.Status }}'
      KmsKeyId: '{{ response.Endpoints.KmsKeyId }}'
      EndpointArn: '{{ response.Endpoints.EndpointArn }}'
      CertificateArn: '{{ response.Endpoints.CertificateArn }}'
      SslMode: '{{ response.Endpoints.SslMode }}'
      ServiceAccessRoleArn: '{{ response.Endpoints.ServiceAccessRoleArn }}'
      ExternalTableDefinition: '{{ response.Endpoints.ExternalTableDefinition }}'
      ExternalId: '{{ response.Endpoints.ExternalId }}'
      IsReadOnly: '{{ response.Endpoints.IsReadOnly }}'
      DynamoDbSettings: '{{ response.Endpoints.DynamoDbSettings }}'
      S3Settings: '{{ response.Endpoints.S3Settings }}'
      DmsTransferSettings: '{{ response.Endpoints.DmsTransferSettings }}'
      MongoDbSettings: '{{ response.Endpoints.MongoDbSettings }}'
      KinesisSettings: '{{ response.Endpoints.KinesisSettings }}'
      KafkaSettings: '{{ response.Endpoints.KafkaSettings }}'
      ElasticsearchSettings: '{{ response.Endpoints.ElasticsearchSettings }}'
      NeptuneSettings: '{{ response.Endpoints.NeptuneSettings }}'
      RedshiftSettings: '{{ response.Endpoints.RedshiftSettings }}'
      PostgreSQLSettings: '{{ response.Endpoints.PostgreSQLSettings }}'
      MySQLSettings: '{{ response.Endpoints.MySQLSettings }}'
      OracleSettings: '{{ response.Endpoints.OracleSettings }}'
      SybaseSettings: '{{ response.Endpoints.SybaseSettings }}'
      MicrosoftSQLServerSettings: '{{ response.Endpoints.MicrosoftSQLServerSettings
        }}'
      IBMDb2Settings: '{{ response.Endpoints.IBMDb2Settings }}'
      DocDbSettings: '{{ response.Endpoints.DocDbSettings }}'
      RedisSettings: '{{ response.Endpoints.RedisSettings }}'
      GcpMySQLSettings: '{{ response.Endpoints.GcpMySQLSettings }}'
      TimestreamSettings: '{{ response.Endpoints.TimestreamSettings }}'
      LakehouseSettings: '{{ response.Endpoints.LakehouseSettings }}'
checks:
- rule_id: aws.dms.instance.dms_multi_az_enabled
  for_each: aws.dms.describe_replication_instances
  conditions:
    var: item.MultiAZ
    op: equals
    value: 'true'
- rule_id: aws.dms.resource.replication_task_target_logging_enabled
  for_each: aws.dms.describe_event_subscriptions
  conditions:
    var: item.Enabled
    op: equals
    value: true
- rule_id: aws.dms.resource.replication_task_source_logging_enabled
  for_each: aws.dms.describe_event_subscriptions
  conditions:
    var: item.Enabled
    op: equals
    value: true
- rule_id: aws.dms.instance.no_public_access_configured
  for_each: aws.dms.describe_instance_profiles
  conditions:
    var: item.PubliclyAccessible
    op: equals
    value: 'false'
- rule_id: aws.dms.resource.endpoint_redis_in_transit_encryption_enabled
  for_each: aws.dms.describe_endpoints
  conditions:
    var: item.RedisSettings
    op: equals
    value: true
