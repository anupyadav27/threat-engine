version: '1.0'
provider: aws
service: dms
discovery:
- discovery_id: aws.dms.describe_replication_instances
  calls:
  - action: describe_replication_instances
    save_as: describe_replication_instances_response
  emit:
    items_for: '{{ describe_replication_instances_response.ReplicationInstances }}'
    as: resource
    item:
      replication_instance_identifier: '{{ resource.ReplicationInstanceIdentifier
        }}'
      replication_instance_class: '{{ resource.ReplicationInstanceClass }}'
      replication_instance_status: '{{ resource.ReplicationInstanceStatus }}'
      allocated_storage: '{{ resource.AllocatedStorage }}'
      instance_create_time: '{{ resource.InstanceCreateTime }}'
      vpc_security_groups: '{{ resource.VpcSecurityGroups }}'
      availability_zone: '{{ resource.AvailabilityZone }}'
      replication_subnet_group: '{{ resource.ReplicationSubnetGroup }}'
      preferred_maintenance_window: '{{ resource.PreferredMaintenanceWindow }}'
      pending_modified_values: '{{ resource.PendingModifiedValues }}'
- discovery_id: aws.dms.describe_connections
  calls:
  - action: describe_connections
    save_as: describe_connections_response
  emit:
    items_for: '{{ describe_connections_response.Connections }}'
    as: resource
    item:
      replication_instance_arn: '{{ resource.ReplicationInstanceArn }}'
      endpoint_arn: '{{ resource.EndpointArn }}'
      status: '{{ resource.Status }}'
      last_failure_message: '{{ resource.LastFailureMessage }}'
      endpoint_identifier: '{{ resource.EndpointIdentifier }}'
      replication_instance_identifier: '{{ resource.ReplicationInstanceIdentifier
        }}'
- discovery_id: aws.dms.create_instance_profile
  calls:
  - action: create_instance_profile
    save_as: create_instance_profile_response
  emit:
    items_for: '{{ create_instance_profile_response.InstanceProfile }}'
    as: resource
    item:
      instance_profile_arn: '{{ resource.InstanceProfileArn }}'
      availability_zone: '{{ resource.AvailabilityZone }}'
      kms_key_arn: '{{ resource.KmsKeyArn }}'
      publicly_accessible: '{{ resource.PubliclyAccessible }}'
      network_type: '{{ resource.NetworkType }}'
      instance_profile_name: '{{ resource.InstanceProfileName }}'
      description: '{{ resource.Description }}'
      instance_profile_creation_time: '{{ resource.InstanceProfileCreationTime }}'
      subnet_group_identifier: '{{ resource.SubnetGroupIdentifier }}'
      vpc_security_groups: '{{ resource.VpcSecurityGroups }}'
- discovery_id: aws.dms.describe_endpoints
  calls:
  - action: describe_endpoints
    save_as: describe_endpoints_response
  emit:
    items_for: '{{ describe_endpoints_response.Endpoints }}'
    as: resource
    item:
      endpoint_identifier: '{{ resource.EndpointIdentifier }}'
      endpoint_type: '{{ resource.EndpointType }}'
      engine_name: '{{ resource.EngineName }}'
      engine_display_name: '{{ resource.EngineDisplayName }}'
      username: '{{ resource.Username }}'
      server_name: '{{ resource.ServerName }}'
      port: '{{ resource.Port }}'
      database_name: '{{ resource.DatabaseName }}'
      extra_connection_attributes: '{{ resource.ExtraConnectionAttributes }}'
      status: '{{ resource.Status }}'
checks:
- rule_id: aws.dms.instance.dms_multi_az_enabled
  for_each: aws.dms.describe_replication_instances
  conditions:
    var: item.multi_az
    op: equals
    value: true
- rule_id: aws.dms.resource.replication_task_target_logging_enabled
  for_each: aws.dms.describe_connections
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.dms.resource.replication_task_source_logging_enabled
  for_each: aws.dms.describe_connections
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.dms.instance.no_public_access_configured
  for_each: aws.dms.create_instance_profile
  conditions:
    var: item.publicly_accessible
    op: equals
    value: false
- rule_id: aws.dms.resource.endpoint_redis_in_transit_encryption_enabled
  for_each: aws.dms.describe_endpoints
  conditions:
    var: item.ssl_mode
    op: equals
    value: require
