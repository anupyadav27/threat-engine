version: '1.0'
provider: aws
service: directconnect
services:
  client: directconnect
  module: boto3.client
discovery:
- discovery_id: aws.directconnect.describe_connections
  calls:
  - action: describe_connections
    save_as: response
  emit:
    item:
      ownerAccount: '{{ response.connections.ownerAccount }}'
      connectionId: '{{ response.connections.connectionId }}'
      connectionName: '{{ response.connections.connectionName }}'
      connectionState: '{{ response.connections.connectionState }}'
      region: '{{ response.connections.region }}'
      location: '{{ response.connections.location }}'
      bandwidth: '{{ response.connections.bandwidth }}'
      vlan: '{{ response.connections.vlan }}'
      partnerName: '{{ response.connections.partnerName }}'
      loaIssueTime: '{{ response.connections.loaIssueTime }}'
      lagId: '{{ response.connections.lagId }}'
      awsDevice: '{{ response.connections.awsDevice }}'
      jumboFrameCapable: '{{ response.connections.jumboFrameCapable }}'
      awsDeviceV2: '{{ response.connections.awsDeviceV2 }}'
      awsLogicalDeviceId: '{{ response.connections.awsLogicalDeviceId }}'
      hasLogicalRedundancy: '{{ response.connections.hasLogicalRedundancy }}'
      tags: '{{ response.connections.tags }}'
      providerName: '{{ response.connections.providerName }}'
      macSecCapable: '{{ response.connections.macSecCapable }}'
      portEncryptionStatus: '{{ response.connections.portEncryptionStatus }}'
      encryptionMode: '{{ response.connections.encryptionMode }}'
      macSecKeys: '{{ response.connections.macSecKeys }}'
      partnerInterconnectMacSecCapable: '{{ response.connections.partnerInterconnectMacSecCapable
        }}'
checks:
- rule_id: aws.directconnect.connection_redundancy.directconnect_connection_redundancy_configured
  for_each: aws.directconnect.describe_connections
  conditions:
    var: item.hasLogicalRedundancy
    op: equals
    value: 'yes'
- rule_id: aws.directconnect.connection.tunnel_health_monitoring_enabled
  for_each: aws.directconnect.describe_connections
  conditions:
    var: item.connectionState
    op: not_equals
    value: down
- rule_id: aws.directconnect.virtual_interface_redundancy.directconnect_virtual_interface_redundancy_configured
  for_each: aws.directconnect.describe_connections
  conditions:
    var: item.hasLogicalRedundancy
    op: equals
    value: 'yes'
- rule_id: aws.directconnect.connection.pre_shared_keys_key_rotation_policy_configured
  for_each: aws.directconnect.describe_connections
  conditions:
    var: item.macSecKeys
    op: not_equals
    value: 'null'
- rule_id: aws.directconnect.connection.ike_phase_encryption_strong_configured
  for_each: aws.directconnect.describe_connections
  conditions:
    var: item.portEncryptionStatus
    op: equals
    value: enabled
