version: '1.0'
provider: aws
service: directconnect
discovery:
- discovery_id: aws.directconnect.virtual_interface_redundancys
  calls:
  - client: directconnect
    action: describe_connection
    save_as: virtual_interface_redundancy_list
    on_error: continue
    fields:
    - Directconnects
  emit:
    items_for: virtual_interface_redundancy_list[]
    as: virtual_interface_redundancy
    item:
      id: '{{ virtual_interface_redundancy.Id }}'
      name: '{{ virtual_interface_redundancy.Name }}'
- discovery_id: aws.directconnect.virtual_interface_redundancy_encryption
  for_each: aws.directconnect.virtual_interface_redundancys
  calls:
  - client: directconnect
    action: describe_connection
    params:
      Virtual_interface_redundancyId: '{{ item.id }}'
    save_as: encryption
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      encryption_enabled: '{{ encryption.Encrypted if encryption.Encrypted is defined
        else false }}'
- discovery_id: aws.directconnect.connections
  for_each: aws.directconnect.connection
  calls:
  - client: directconnect
    action: describe_connection
    save_as: connections
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.directconnect.connection_redundancys
  for_each: aws.directconnect.connection_redundancy
  calls:
  - client: directconnect
    action: describe_connection_loa
    save_as: connection_redundancys
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.directconnect.connection_encryption
  calls:
  - client: directconnect
    action: list_virtual_interface_test_history
    save_as: connection_encryption
    on_error: continue
  emit:
    items_for: connection_encryption[]
    as: connection_encryption
    item:
      id: '{{ connection_encryption.Id }}'
      compliant: '{{ true }}'
checks:
- title: 'DIRECTCONNECT connection redundancy: Directconnect Connection Redundancy
    Configured'
  severity: medium
  rule_id: aws.directconnect.connection_redundancy.directconnect_connection_redundancy_configured
  for_each:
    discovery: aws.directconnect.connection_redundancys
    as: connection_redundancy
    item: connection_redundancy
  conditions:
    var: connection_redundancy.compliant
    op: equals
    value: true
- title: 'DIRECTCONNECT connection: Tunnel Health Monitoring Enabled'
  severity: medium
  rule_id: aws.directconnect.connection.tunnel_health_monitoring_enabled
  for_each:
    discovery: aws.directconnect.connections
    as: connection
    item: connection
  conditions:
    var: connection.monitoring_enabled
    op: equals
    value: true
- title: 'DIRECTCONNECT virtual interface redundancy: Directconnect Virtual Interface
    Redundancy Configured'
  severity: medium
  rule_id: aws.directconnect.virtual_interface_redundancy.directconnect_virtual_interface_redundancy_configured
  for_each:
    discovery: aws.directconnect.virtual_interface_redundancys
    as: virtual_interface_redundancy
    item: virtual_interface_redundancy
  conditions:
    var: virtual_interface_redundancy.compliant
    op: equals
    value: true
- title: 'DIRECTCONNECT connection: Pre Shared Keys Key Rotation Policy Configured'
  severity: high
  rule_id: aws.directconnect.connection.pre_shared_keys_key_rotation_policy_configured
  for_each:
    discovery: aws.directconnect.connections
    as: connection
    item: connection
  conditions:
    var: connection.is_public
    op: equals
    value: false
- title: 'DIRECTCONNECT connection: Ike Phase Encryption Strong Configured'
  severity: high
  rule_id: aws.directconnect.connection.ike_phase_encryption_strong_configured
  for_each:
    discovery: aws.directconnect.connection_encryption
    as: connection
    item: connection
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
