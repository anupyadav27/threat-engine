version: '1.0'
provider: aws
service: networkfirewall
discovery:
- discovery_id: aws.networkfirewall.ins
  calls:
  - client: networkfirewall
    action: list_networkfirewalls
    save_as: in_list
    on_error: continue
    fields:
    - Networkfirewalls
  emit:
    items_for: in_list[]
    as: in
    item:
      id: '{{ in.Id }}'
      name: '{{ in.Name }}'
- discovery_id: aws.networkfirewall.in_logging
  for_each: aws.networkfirewall.ins
  calls:
  - client: networkfirewall
    action: describe_in_logging
    params:
      InId: '{{ item.id }}'
    save_as: logging
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      logging_enabled: '{{ logging.LoggingEnabled is defined if logging else false
        }}'
- discovery_id: aws.networkfirewall.resource_logging
  calls:
  - client: networkfirewall
    action: describe_load_balancers
    save_as: resource_logging
    on_error: continue
  emit:
    items_for: resource_logging[]
    as: resource_logging
    item:
      id: '{{ resource_logging.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.networkfirewall.firewalls
  for_each: aws.networkfirewall.firewall
  calls:
  - client: networkfirewall
    action: describe_firewalls
    save_as: firewalls
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.networkfirewall.firewall_logging
  calls:
  - client: networkfirewall
    action: list_firewall_logging
    save_as: firewall_logging
    on_error: continue
  emit:
    items_for: firewall_logging[]
    as: firewall_logging
    item:
      id: '{{ firewall_logging.Id }}'
      compliant: '{{ true }}'
checks:
- title: Intrusion detection system is enabled
  severity: high
  rule_id: aws.networkfirewall.firewall.logging_enabled
  for_each:
    discovery: aws.networkfirewall.firewall_logging
    as: firewall
    item: firewall
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'NETWORKFIREWALL firewall: Networkfirewall Multi Az Deployment Enabled'
  severity: high
  rule_id: aws.networkfirewall.firewall.networkfirewall_multi_az_deployment_enabled
  for_each:
    discovery: aws.networkfirewall.firewalls
    as: firewall
    item: firewall
  conditions:
    var: firewall.in_vpc
    op: equals
    value: true
- title: 'NETWORKFIREWALL firewall: Rule Groups Enabled'
  severity: medium
  rule_id: aws.networkfirewall.firewall.rule_groups_enabled
  for_each:
    discovery: aws.networkfirewall.firewalls
    as: firewall
    item: firewall
  conditions:
    var: firewall.in_vpc
    op: equals
    value: true
- title: 'NETWORKFIREWALL resource: Logging Enabled'
  severity: medium
  rule_id: aws.networkfirewall.resource.logging_enabled
  for_each:
    discovery: aws.networkfirewall.resource_logging
    as: resource
    item: resource
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'NETWORKFIREWALL firewall: Networkfirewall No Permit Any Configured'
  severity: high
  rule_id: aws.networkfirewall.firewall.networkfirewall_no_permit_any_configured
  for_each:
    discovery: aws.networkfirewall.firewalls
    as: firewall
    item: firewall
  conditions:
    var: firewall.in_vpc
    op: equals
    value: true
- title: 'NETWORKFIREWALL in: All Vpc Configured'
  severity: high
  rule_id: aws.networkfirewall.in.all_vpc_configured
  for_each:
    discovery: aws.networkfirewall.ins
    as: in
    item: in
  conditions:
    var: in.in_vpc
    op: equals
    value: true
