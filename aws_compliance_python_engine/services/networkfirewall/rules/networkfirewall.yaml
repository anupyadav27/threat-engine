# NETWORKFIREWALL Service - Logic Only
# Metadata (titles, severity, descriptions) in: metadata/checks/networkfirewall_metadata.yaml

version: '1.0'
provider: aws
service: networkfirewall
discovery:
- discovery_id: aws.networkfirewall.ins
  calls:
  - action: list_networkfirewalls
    fields:
    - Networkfirewalls
  emit:
    items_for: list_networkfirewalls_response[]
    item:
      id: '{{ in.Id }}'
      name: '{{ in.Name }}'
- discovery_id: aws.networkfirewall.in_logging
  for_each: aws.networkfirewall.ins
  calls:
  - action: describe_in_logging
    params:
      InId: '{{ item.id }}'
  emit:
    item:
      resource_id: '{{ item.id }}'
      logging_enabled: '{{ describe_in_logging_response.LoggingEnabled is defined
        if describe_in_logging_response else false }}'
- discovery_id: aws.networkfirewall.resource_logging
  calls:
  - action: describe_load_balancers
  emit:
    items_for: describe_load_balancers_response[]
    item:
      id: '{{ describe_load_balancers_response.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.networkfirewall.firewalls
  for_each: aws.networkfirewall.firewall
  calls:
  - action: describe_firewalls
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.networkfirewall.firewall_logging
  calls:
  - action: list_firewall_logging
  emit:
    items_for: list_firewall_logging_response[]
    item:
      id: '{{ list_firewall_logging_response.Id }}'
      compliant: '{{ true }}'
checks:
- rule_id: aws.networkfirewall.firewall.logging_enabled
  for_each: aws.networkfirewall.firewall_logging
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- rule_id: aws.networkfirewall.firewall.networkfirewall_multi_az_deployment_enabled
  for_each: aws.networkfirewall.firewalls
  conditions:
    var: item.in_vpc
    op: equals
    value: true
- rule_id: aws.networkfirewall.firewall.rule_groups_enabled
  for_each: aws.networkfirewall.firewalls
  conditions:
    var: item.in_vpc
    op: equals
    value: true
- rule_id: aws.networkfirewall.resource.logging_enabled
  for_each: aws.networkfirewall.resource_logging
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- rule_id: aws.networkfirewall.firewall.networkfirewall_no_permit_any_configured
  for_each: aws.networkfirewall.firewalls
  conditions:
    var: item.in_vpc
    op: equals
    value: true
- rule_id: aws.networkfirewall.in.all_vpc_configured
  for_each: aws.networkfirewall.ins
  conditions:
    var: item.in_vpc
    op: equals
    value: true
