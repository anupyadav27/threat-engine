version: '1.0'
provider: aws
service: eventbridge
services:
  client: eventbridge
  module: boto3.client
discovery:
- discovery_id: aws.eventbridge.list_archives
  calls:
  - action: list_archives
    save_as: response
  emit:
    items_for: '{{ response.Archives }}'
    as: resource
    item:
      ArchiveName: '{{ resource.ArchiveName }}'
      EventSourceArn: '{{ resource.EventSourceArn }}'
      State: '{{ resource.State }}'
      StateReason: '{{ resource.StateReason }}'
      RetentionDays: '{{ resource.RetentionDays }}'
      SizeBytes: '{{ resource.SizeBytes }}'
      EventCount: '{{ resource.EventCount }}'
      CreationTime: '{{ resource.CreationTime }}'
- discovery_id: aws.eventbridge.list_rules
  calls:
  - action: list_rules
    save_as: response
  emit:
    items_for: '{{ response.Rules }}'
    as: resource
    item:
      Name: '{{ resource.Name }}'
      Arn: '{{ resource.Arn }}'
      EventPattern: '{{ resource.EventPattern }}'
      State: '{{ resource.State }}'
      Description: '{{ resource.Description }}'
      ScheduleExpression: '{{ resource.ScheduleExpression }}'
      RoleArn: '{{ resource.RoleArn }}'
      ManagedBy: '{{ resource.ManagedBy }}'
      EventBusName: '{{ resource.EventBusName }}'
- discovery_id: aws.eventbridge.list_endpoints
  calls:
  - action: list_endpoints
    save_as: response
  emit:
    items_for: '{{ response.Endpoints }}'
    as: resource
    item:
      Name: '{{ resource.Name }}'
      Description: '{{ resource.Description }}'
      Arn: '{{ resource.Arn }}'
      RoutingConfig: '{{ resource.RoutingConfig }}'
      ReplicationConfig: '{{ resource.ReplicationConfig }}'
      EventBuses: '{{ resource.EventBuses }}'
      RoleArn: '{{ resource.RoleArn }}'
      EndpointId: '{{ resource.EndpointId }}'
      EndpointUrl: '{{ resource.EndpointUrl }}'
      State: '{{ resource.State }}'
      StateReason: '{{ resource.StateReason }}'
      CreationTime: '{{ resource.CreationTime }}'
      LastModifiedTime: '{{ resource.LastModifiedTime }}'
- discovery_id: aws.eventbridge.list_event_buses
  calls:
  - action: list_event_buses
    save_as: response
  emit:
    items_for: '{{ response.EventBuses }}'
    as: resource
    item:
      Name: '{{ resource.Name }}'
      Arn: '{{ resource.Arn }}'
      Description: '{{ resource.Description }}'
      Policy: '{{ resource.Policy }}'
      CreationTime: '{{ resource.CreationTime }}'
      LastModifiedTime: '{{ resource.LastModifiedTime }}'
      EventBusArn: '{{ resource.EventBusArn }}'
- discovery_id: aws.eventbridge.list_connections
  calls:
  - action: list_connections
    save_as: response
  emit:
    items_for: '{{ response.Connections }}'
    as: resource
    item:
      ConnectionArn: '{{ resource.ConnectionArn }}'
      Name: '{{ resource.Name }}'
      ConnectionState: '{{ resource.ConnectionState }}'
      StateReason: '{{ resource.StateReason }}'
      AuthorizationType: '{{ resource.AuthorizationType }}'
      CreationTime: '{{ resource.CreationTime }}'
      LastModifiedTime: '{{ resource.LastModifiedTime }}'
      LastAuthorizedTime: '{{ resource.LastAuthorizedTime }}'
- discovery_id: aws.eventbridge.describe_event_bus
  calls:
  - action: describe_event_bus
    save_as: response
  emit:
    item:
      Arn: '{{ response.DeadLetterConfig.Arn }}'
      KmsKeyIdentifier: '{{ resource.KmsKeyIdentifier }}'
checks:
- rule_id: aws.eventbridge.rule.oncall_contacts_verified
  for_each: aws.eventbridge.list_archives
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.eventbridge.eventbus.oncall_contacts_verified
  for_each: aws.eventbridge.list_rules
  conditions:
    var: item.EventBusName
    op: not_equals
    value: 'null'
- rule_id: aws.eventbridge.rule.execution_roles_least_privilege
  for_each: aws.eventbridge.list_endpoints
  conditions:
    var: item.RoleArn
    op: not_equals
    value: 'null'
- rule_id: aws.eventbridge.eventbus.change_audit_logging_enabled
  for_each: aws.eventbridge.list_event_buses
  conditions:
    var: item.EventBusArn
    op: not_equals
    value: 'null'
- rule_id: aws.eventbridge.eventbus.policy_exists_for_critical_severity_configured
  for_each: aws.eventbridge.list_event_buses
  conditions:
    var: item.Policy
    op: not_equals
    value: 'null'
- rule_id: aws.eventbridge.eventbus.message_encryption_in_transit_configured
  for_each: aws.eventbridge.list_event_buses
  conditions:
    var: item.EventBusArn
    op: not_equals
    value: 'null'
- rule_id: aws.eventbridge.rule.no_public_webhooks_configured
  for_each: aws.eventbridge.list_event_buses
  conditions:
    var: item.Policy
    op: not_equals
    value: 'null'
- rule_id: aws.eventbridge.rule.message_encryption_in_transit_configured
  for_each: aws.eventbridge.list_archives
  conditions:
    var: item.State
    op: not_equals
    value: DISABLED
- rule_id: aws.eventbridge.rule.private_networking_enforced
  for_each: aws.eventbridge.list_archives
  conditions:
    var: item.State
    op: not_equals
    value: ENABLED
- rule_id: aws.eventbridge.rule.eventbridge_logs_and_metrics_enabled
  for_each: aws.eventbridge.list_archives
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.eventbridge.rule.eventbridge_destinations_configured
  for_each: aws.eventbridge.list_event_buses
  conditions:
    var: item.EventBusArn
    op: not_equals
    value: 'null'
- rule_id: aws.eventbridge.resource.global_endpoint_event_replication_enabled
  for_each: aws.eventbridge.list_archives
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.eventbridge.eventbus.endpoints_authenticated_configured
  for_each: aws.eventbridge.list_connections
  conditions:
    var: item.AuthorizationType
    op: equals
    value: BASIC
- rule_id: aws.eventbridge.rule.eventbridge_artifacts_private_and_encrypted
  for_each: aws.eventbridge.list_archives
  conditions:
    var: item.State
    op: not_equals
    value: DISABLED
- rule_id: aws.eventbridge.eventbus.no_public_webhooks_configured
  for_each: aws.eventbridge.list_event_buses
  conditions:
    var: item.EventBusArn
    op: not_equals
    value: 'null'
- rule_id: aws.eventbridge.eventbus.eventbridge_destinations_configured
  for_each: aws.eventbridge.list_event_buses
  conditions:
    var: item.EventBusArn
    op: not_equals
    value: 'null'
- rule_id: aws.eventbridge.rule.kms_encryption_enabled
  for_each: aws.eventbridge.describe_event_bus
  conditions:
    var: item.KmsKeyIdentifier
    op: not_equals
    value: 'null'
- rule_id: aws.eventbridge.rule.policy_exists_for_critical_severity_configured
  for_each: aws.eventbridge.list_event_buses
  conditions:
    var: item.Policy
    op: not_equals
    value: 'null'
- rule_id: aws.eventbridge.rule.change_audit_logging_enabled
  for_each: aws.eventbridge.list_archives
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.eventbridge.rule.endpoints_authenticated_configured
  for_each: aws.eventbridge.list_connections
  conditions:
    var: item.AuthorizationType
    op: equals
    value: BASIC
