version: '1.0'
provider: aws
service: elb
services:
  client: elb
  module: boto3.client
discovery:
- discovery_id: aws.elb.describe_load_balancer_policies
  calls:
  - action: describe_load_balancer_policies
    save_as: response
  emit:
    item:
      PolicyName: '{{ response.PolicyDescriptions.PolicyName }}'
      PolicyTypeName: '{{ response.PolicyDescriptions.PolicyTypeName }}'
      PolicyAttributeDescriptions: '{{ response.PolicyDescriptions.PolicyAttributeDescriptions
        }}'
- discovery_id: aws.elb.describe_load_balancers
  calls:
  - action: describe_load_balancers
    save_as: response
  emit:
    item:
      LoadBalancerName: '{{ response.LoadBalancerDescriptions.LoadBalancerName }}'
      DNSName: '{{ response.LoadBalancerDescriptions.DNSName }}'
      CanonicalHostedZoneName: '{{ response.LoadBalancerDescriptions.CanonicalHostedZoneName
        }}'
      CanonicalHostedZoneNameID: '{{ response.LoadBalancerDescriptions.CanonicalHostedZoneNameID
        }}'
      ListenerDescriptions: '{{ response.LoadBalancerDescriptions.ListenerDescriptions
        }}'
      Policies: '{{ response.LoadBalancerDescriptions.Policies }}'
      BackendServerDescriptions: '{{ response.LoadBalancerDescriptions.BackendServerDescriptions
        }}'
      AvailabilityZones: '{{ response.LoadBalancerDescriptions.AvailabilityZones }}'
      Subnets: '{{ response.LoadBalancerDescriptions.Subnets }}'
      VPCId: '{{ response.LoadBalancerDescriptions.VPCId }}'
      Instances: '{{ response.LoadBalancerDescriptions.Instances }}'
      HealthCheck: '{{ response.LoadBalancerDescriptions.HealthCheck }}'
      SourceSecurityGroup: '{{ response.LoadBalancerDescriptions.SourceSecurityGroup
        }}'
      SecurityGroups: '{{ response.LoadBalancerDescriptions.SecurityGroups }}'
      CreatedTime: '{{ response.LoadBalancerDescriptions.CreatedTime }}'
      Scheme: '{{ response.LoadBalancerDescriptions.Scheme }}'
- discovery_id: aws.elb.describe_load_balancer_attributes
  calls:
  - action: describe_load_balancer_attributes
    save_as: response
    params:
      LoadBalancerName: '{{ item.LoadBalancerName }}'
  on_error: continue
  for_each: aws.elb.describe_load_balancers
  emit:
    item:
      CrossZoneLoadBalancing: '{{ response.LoadBalancerAttributes.CrossZoneLoadBalancing
        }}'
      AccessLog: '{{ response.LoadBalancerAttributes.AccessLog }}'
      ConnectionDraining: '{{ response.LoadBalancerAttributes.ConnectionDraining }}'
      ConnectionSettings: '{{ response.LoadBalancerAttributes.ConnectionSettings }}'
      AdditionalAttributes: '{{ response.LoadBalancerAttributes.AdditionalAttributes
        }}'
checks:
- rule_id: aws.elb.loadbalancer.listener_loadbalancer_secure_listener_protocols_configured
  for_each: aws.elb.describe_load_balancers
  conditions:
    var: item.ListenerDescriptions
    op: contains
    value: HTTPS
- rule_id: aws.elb.loadbalancer.access_logs_enabled
  for_each: aws.elb.describe_load_balancer_attributes
  conditions:
    var: item.AccessLog
    op: equals
    value: true
- rule_id: aws.elb.ssllisteners.ssl_listeners_configured
  for_each: aws.elb.describe_load_balancers
  conditions:
    var: item.ListenerDescriptions
    op: exists
- rule_id: aws.elb.resource.logging_enabled
  for_each: aws.elb.describe_load_balancer_attributes
  conditions:
    var: item.AccessLog
    op: equals
    value: true
- rule_id: aws.elb.insecure_ssl_ciphers.insecure_ssl_ciphers_configured
  for_each: aws.elb.describe_load_balancer_policies
  conditions:
    var: item.PolicyAttributeDescriptions
    op: contains
    value: ELBSecurityPolicy-2016-08
- rule_id: aws.elb.desync.elb_mitigation_mode_configured
  for_each: aws.elb.describe_load_balancer_attributes
  conditions:
    var: item.AdditionalAttributes
    op: contains
    value: desync_mitigation_mode
- rule_id: aws.elb.isinmultipleaz.elb_is_in_multiple_az_configured
  for_each: aws.elb.describe_load_balancers
  conditions:
    var: item.AvailabilityZones
    op: gt
    value: 1
- rule_id: aws.elb.loadbalancer.waf_attached_if_supported
  for_each: aws.elb.describe_load_balancer_attributes
  conditions:
    var: item.AdditionalAttributes
    op: contains
    value: waf:enabled
- rule_id: aws.elb.logging.access_logging_enabled
  for_each: aws.elb.describe_load_balancer_attributes
  conditions:
    var: item.AccessLog
    op: equals
    value: true
- rule_id: aws.elb.loadbalancer.valid_certificate_enabled
  for_each: aws.elb.describe_load_balancers
  conditions:
    var: item.ListenerDescriptions
    op: exists
- rule_id: aws.elb.loadbalancer.listener_tls_min_1_2_configured
  for_each: aws.elb.describe_load_balancers
  conditions:
    var: item.ListenerDescriptions
    op: contains
    value: TLSv1.2
- rule_id: aws.elb.listener.ssl_tls_enforced
  for_each: aws.elb.describe_load_balancer_policies
  conditions:
    var: item.PolicyName
    op: contains
    value: ELBSecurityPolicy
