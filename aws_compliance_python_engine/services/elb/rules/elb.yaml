version: '1.0'
provider: aws
service: elb
discovery:
- discovery_id: aws.elb.insecure_ssl_cipherss
  calls:
  - client: elb
    action: describe_load_balancers
    save_as: insecure_ssl_ciphers_list
    on_error: continue
    fields:
    - Elbs
  emit:
    items_for: insecure_ssl_ciphers_list[]
    as: insecure_ssl_ciphers
    item:
      id: '{{ insecure_ssl_ciphers.Id }}'
      name: '{{ insecure_ssl_ciphers.Name }}'
- discovery_id: aws.elb.insecure_ssl_ciphers_logging
  for_each: aws.elb.insecure_ssl_cipherss
  calls:
  - client: elb
    action: describe_account_limits
    params:
      Insecure_ssl_ciphersId: '{{ item.id }}'
    save_as: logging
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      logging_enabled: '{{ logging.LoggingEnabled is defined if logging else false
        }}'
- discovery_id: aws.elb.loadbalancer_logging
  calls:
  - client: elb
    action: describe_load_balancer_attributes
    save_as: loadbalancer_logging
    on_error: continue
  emit:
    items_for: loadbalancer_logging[]
    as: loadbalancer_logging
    item:
      id: '{{ loadbalancer_logging.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elb.listeners
  for_each: aws.elb.listener
  calls:
  - client: elb
    action: describe_account_limits
    save_as: listeners
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elb.resource_logging
  calls:
  - client: elb
    action: describe_load_balancers
    save_as: resource_logging
    on_error: continue
  emit:
    items_for: resource_logging[]
    as: resource_logging
    item:
      id: '{{ resource_logging.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elb.logging_logging
  calls:
  - client: elb
    action: list_logging_logging
    save_as: logging_logging
    on_error: continue
  emit:
    items_for: logging_logging[]
    as: logging_logging
    item:
      id: '{{ logging_logging.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elb.desyncs
  for_each: aws.elb.desync
  calls:
  - client: elb
    action: describe_account_limits
    save_as: desyncs
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elb.internetfacings
  for_each: aws.elb.internetfacing
  calls:
  - client: elb
    action: describe_account_limits
    save_as: internetfacings
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elb.isinmultipleazs
  for_each: aws.elb.isinmultipleaz
  calls:
  - client: elb
    action: describe_account_limits
    save_as: isinmultipleazs
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elb.ssllistenerss
  for_each: aws.elb.ssllistener
  calls:
  - client: elb
    action: describe_account_limits
    save_as: ssllistenerss
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.elb.loadbalancers
  for_each: aws.elb.loadbalancer
  calls:
  - client: elb
    action: describe_load_balancers
    save_as: loadbalancers
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
checks:
- title: 'ELB loadbalancer: Listener Loadbalancer Secure Listener Protocols Configured'
  severity: medium
  rule_id: aws.elb.loadbalancer.listener_loadbalancer_secure_listener_protocols_configured
  for_each:
    discovery: aws.elb.loadbalancers
    as: loadbalancer
    item: loadbalancer
  conditions:
    var: loadbalancer.compliant
    op: equals
    value: true
- title: 'ELB loadbalancer: Access Logs Enabled'
  severity: medium
  rule_id: aws.elb.loadbalancer.access_logs_enabled
  for_each:
    discovery: aws.elb.loadbalancer_logging
    as: loadbalancer
    item: loadbalancer
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'ELB ssllisteners: Ssl Listeners Configured'
  severity: high
  rule_id: aws.elb.ssllisteners.ssl_listeners_configured
  for_each:
    discovery: aws.elb.ssllistenerss
    as: ssllisteners
    item: ssllisteners
  conditions:
    var: ssllisteners.in_vpc
    op: equals
    value: true
- title: 'ELB resource: Logging Enabled'
  severity: medium
  rule_id: aws.elb.resource.logging_enabled
  for_each:
    discovery: aws.elb.resource_logging
    as: resource
    item: resource
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'ELB internetfacing: Elb Internet Facing Configured'
  severity: medium
  rule_id: aws.elb.internetfacing.elb_internet_facing_configured
  for_each:
    discovery: aws.elb.internetfacings
    as: internetfacing
    item: internetfacing
  conditions:
    var: internetfacing.compliant
    op: equals
    value: true
- title: 'ELB insecure ssl ciphers: Insecure Ssl Ciphers Configured'
  severity: high
  rule_id: aws.elb.insecure_ssl_ciphers.insecure_ssl_ciphers_configured
  for_each:
    discovery: aws.elb.insecure_ssl_cipherss
    as: insecure_ssl_ciphers
    item: insecure_ssl_ciphers
  conditions:
    var: insecure_ssl_ciphers.in_vpc
    op: equals
    value: true
- title: 'ELB desync: Elb Mitigation Mode Configured'
  severity: medium
  rule_id: aws.elb.desync.elb_mitigation_mode_configured
  for_each:
    discovery: aws.elb.desyncs
    as: desync
    item: desync
  conditions:
    var: desync.compliant
    op: equals
    value: true
- title: 'ELB isinmultipleaz: Elb Is In Multiple Az Configured'
  severity: medium
  rule_id: aws.elb.isinmultipleaz.elb_is_in_multiple_az_configured
  for_each:
    discovery: aws.elb.isinmultipleazs
    as: isinmultipleaz
    item: isinmultipleaz
  conditions:
    var: isinmultipleaz.compliant
    op: equals
    value: true
- title: 'ELB loadbalancer: Waf Attached If Supported'
  severity: medium
  rule_id: aws.elb.loadbalancer.waf_attached_if_supported
  for_each:
    discovery: aws.elb.loadbalancers
    as: loadbalancer
    item: loadbalancer
  conditions:
    var: loadbalancer.compliant
    op: equals
    value: true
- title: 'ELB logging: Access Logging Enabled'
  severity: medium
  rule_id: aws.elb.logging.access_logging_enabled
  for_each:
    discovery: aws.elb.logging_logging
    as: logging
    item: logging
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'ELB loadbalancer: Valid Certificate Enabled'
  severity: medium
  rule_id: aws.elb.loadbalancer.valid_certificate_enabled
  for_each:
    discovery: aws.elb.loadbalancers
    as: loadbalancer
    item: loadbalancer
  conditions:
    var: loadbalancer.compliant
    op: equals
    value: true
- title: 'ELB loadbalancer: Listener Tls Min 1 2 Configured'
  severity: high
  rule_id: aws.elb.loadbalancer.listener_tls_min_1_2_configured
  for_each:
    discovery: aws.elb.loadbalancers
    as: loadbalancer
    item: loadbalancer
  conditions:
    var: loadbalancer.in_vpc
    op: equals
    value: true
- title: 'ELB listener: Ssl Tls Enforced'
  severity: high
  rule_id: aws.elb.listener.ssl_tls_enforced
  for_each:
    discovery: aws.elb.listeners
    as: listener
    item: listener
  conditions:
    var: listener.in_vpc
    op: equals
    value: true
