version: '1.0'
provider: aws
service: xray
discovery:
- discovery_id: aws.xray.traces
  calls:
  - client: xray
    action: get_service_graph
    save_as: trace_list
    on_error: continue
    fields:
    - Xrays
  emit:
    items_for: trace_list[]
    as: trace
    item:
      id: '{{ trace.Id }}'
      name: '{{ trace.Name }}'
- discovery_id: aws.xray.trace_encryption
  for_each: aws.xray.traces
  calls:
  - client: xray
    action: get_service_graph
    params:
      TraceId: '{{ item.id }}'
    save_as: encryption
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      encryption_enabled: '{{ encryption.Encrypted if encryption.Encrypted is defined
        else false }}'
- discovery_id: aws.xray.samplingrules
  for_each: aws.xray.samplingrule
  calls:
  - client: xray
    action: get_sampling_rules
    save_as: samplingrules
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.xray.samplingrule_encryption
  calls:
  - client: xray
    action: list_resource_policies
    save_as: samplingrule_encryption
    on_error: continue
  emit:
    items_for: samplingrule_encryption[]
    as: samplingrule_encryption
    item:
      id: '{{ samplingrule_encryption.Id }}'
      compliant: '{{ true }}'
checks:
- title: 'XRAY trace: Xray Store Encrypted'
  severity: high
  rule_id: aws.xray.trace.xray_store_encrypted
  for_each:
    discovery: aws.xray.trace_encryption
    as: trace
    item: trace
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'XRAY samplingrule: Xray Rules Present'
  severity: medium
  rule_id: aws.xray.samplingrule.xray_rules_present
  for_each:
    discovery: aws.xray.samplingrules
    as: samplingrule
    item: samplingrule
  conditions:
    var: samplingrule.compliant
    op: equals
    value: true
- title: 'XRAY samplingrule: Xray Storage Encrypted'
  severity: high
  rule_id: aws.xray.samplingrule.xray_storage_encrypted
  for_each:
    discovery: aws.xray.samplingrule_encryption
    as: samplingrule
    item: samplingrule
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'XRAY trace: Retention Days Minimum'
  severity: low
  rule_id: aws.xray.trace.retention_days_minimum
  for_each:
    discovery: aws.xray.traces
    as: trace
    item: trace
  conditions:
    var: trace.compliant
    op: equals
    value: true
- title: 'XRAY trace: Rbac Least Privilege'
  severity: high
  rule_id: aws.xray.trace.rbac_least_privilege
  for_each:
    discovery: aws.xray.traces
    as: trace
    item: trace
  conditions:
    var: trace.is_public
    op: equals
    value: false
- title: 'XRAY samplingrule: Rbac Least Privilege'
  severity: high
  rule_id: aws.xray.samplingrule.rbac_least_privilege
  for_each:
    discovery: aws.xray.samplingrules
    as: samplingrule
    item: samplingrule
  conditions:
    var: samplingrule.is_public
    op: equals
    value: false
