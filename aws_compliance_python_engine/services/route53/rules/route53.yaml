version: '1.0'
provider: aws
service: route53
discovery:
- discovery_id: aws.route53.healthchecks
  calls:
  - client: route53
    action: list_hosted_zones
    save_as: healthcheck_list
    on_error: continue
    fields:
    - Route53s
  emit:
    items_for: healthcheck_list[]
    as: healthcheck
    item:
      id: '{{ healthcheck.Id }}'
      name: '{{ healthcheck.Name }}'
- discovery_id: aws.route53.healthcheck_encryption
  for_each: aws.route53.healthchecks
  calls:
  - client: route53
    action: list_hosted_zones
    params:
      HealthcheckId: '{{ item.id }}'
    save_as: encryption
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      encryption_enabled: '{{ encryption.Encrypted if encryption.Encrypted is defined
        else false }}'
- discovery_id: aws.route53.healthcheck_logging
  for_each: aws.route53.healthchecks
  calls:
  - client: route53
    action: list_health_checks
    params:
      HealthcheckId: '{{ item.id }}'
    save_as: logging
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      logging_enabled: '{{ logging.LoggingEnabled is defined if logging else false
        }}'
- discovery_id: aws.route53.trafficpolicys
  for_each: aws.route53.trafficpolicy
  calls:
  - client: route53
    action: list_traffic_policies
    save_as: trafficpolicys
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.route53.resource_logging
  calls:
  - client: route53
    action: list_cidr_blocks
    save_as: resource_logging
    on_error: continue
  emit:
    items_for: resource_logging[]
    as: resource_logging
    item:
      id: '{{ resource_logging.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.route53.trafficpolicy_encryption
  calls:
  - client: route53
    action: list_cidr_blocks
    save_as: trafficpolicy_encryption
    on_error: continue
  emit:
    items_for: trafficpolicy_encryption[]
    as: trafficpolicy_encryption
    item:
      id: '{{ trafficpolicy_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.route53.hostedzones
  for_each: aws.route53.hostedzone
  calls:
  - client: route53
    action: list_hosted_zones
    save_as: hostedzones
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.route53.hostedzone_encryption
  calls:
  - client: route53
    action: list_cidr_blocks
    save_as: hostedzone_encryption
    on_error: continue
  emit:
    items_for: hostedzone_encryption[]
    as: hostedzone_encryption
    item:
      id: '{{ hostedzone_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.route53.recordsets
  for_each: aws.route53.recordset
  calls:
  - client: route53
    action: list_resource_record_sets
    save_as: recordsets
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.route53.hostedzone_logging
  calls:
  - client: route53
    action: list_cidr_blocks
    save_as: hostedzone_logging
    on_error: continue
  emit:
    items_for: hostedzone_logging[]
    as: hostedzone_logging
    item:
      id: '{{ hostedzone_logging.Id }}'
      compliant: '{{ true }}'
checks:
- title: 'ROUTE53 recordset: No Rfc1918 In Public Zones Configured'
  severity: high
  rule_id: aws.route53.recordset.no_rfc1918_in_public_zones_configured
  for_each:
    discovery: aws.route53.recordsets
    as: recordset
    item: recordset
  conditions:
    var: recordset.is_public
    op: equals
    value: false
- title: DNS monitoring and logging is enabled
  severity: medium
  rule_id: aws.route53.hostedzone.query_logging_enabled
  for_each:
    discovery: aws.route53.hostedzone_logging
    as: hostedzone
    item: hostedzone
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'ROUTE53 trafficpolicy: Security Check Health Checks Required For Failover
    Configured'
  severity: medium
  rule_id: aws.route53.trafficpolicy.security_check_health_checks_required_for_failover_configured
  for_each:
    discovery: aws.route53.trafficpolicys
    as: trafficpolicy
    item: trafficpolicy
  conditions:
    var: trafficpolicy.is_public
    op: equals
    value: false
- title: 'ROUTE53 healthcheck: Alerts Configured'
  severity: medium
  rule_id: aws.route53.healthcheck.alerts_configured
  for_each:
    discovery: aws.route53.healthchecks
    as: healthcheck
    item: healthcheck
  conditions:
    var: healthcheck.monitoring_enabled
    op: equals
    value: true
- title: 'ROUTE53 recordset: Route53 Caa Records Present For Root And Wildcard Configured'
  severity: medium
  rule_id: aws.route53.recordset.route53_caa_records_present_for_root_and_wildcard_configured
  for_each:
    discovery: aws.route53.recordsets
    as: recordset
    item: recordset
  conditions:
    var: recordset.compliant
    op: equals
    value: true
- title: 'ROUTE53 healthcheck: Route53 No Plaintext Credentials In Url Configured'
  severity: medium
  rule_id: aws.route53.healthcheck.route53_no_plaintext_credentials_in_url_configured
  for_each:
    discovery: aws.route53.healthchecks
    as: healthcheck
    item: healthcheck
  conditions:
    var: healthcheck.compliant
    op: equals
    value: true
- title: 'ROUTE53 hostedzone: Route53 Zone Transfer Restricted Or Tsig Required'
  severity: medium
  rule_id: aws.route53.hostedzone.route53_zone_transfer_restricted_or_tsig_required
  for_each:
    discovery: aws.route53.hostedzones
    as: hostedzone
    item: hostedzone
  conditions:
    var: hostedzone.compliant
    op: equals
    value: true
- title: 'ROUTE53 hostedzone: Route53 Cross Account Sharing Restricted'
  severity: medium
  rule_id: aws.route53.hostedzone.route53_cross_account_sharing_restricted
  for_each:
    discovery: aws.route53.hostedzones
    as: hostedzone
    item: hostedzone
  conditions:
    var: hostedzone.compliant
    op: equals
    value: true
- title: 'ROUTE53 hostedzone: Route53 Dnssec Enabled If Supported'
  severity: medium
  rule_id: aws.route53.hostedzone.route53_dnssec_enabled_if_supported
  for_each:
    discovery: aws.route53.hostedzone_encryption
    as: hostedzone
    item: hostedzone
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'ROUTE53 healthcheck: Https Or Tls Used Configured'
  severity: high
  rule_id: aws.route53.healthcheck.https_or_tls_used_configured
  for_each:
    discovery: aws.route53.healthchecks
    as: healthcheck
    item: healthcheck
  conditions:
    var: healthcheck.in_vpc
    op: equals
    value: true
- title: 'ROUTE53 resource: Public Hosted Zones Cloudwatch Logging Enabled'
  severity: medium
  rule_id: aws.route53.resource.public_hosted_zones_cloudwatch_logging_enabled
  for_each:
    discovery: aws.route53.resource_logging
    as: resource
    item: resource
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'ROUTE53 recordset: Route53 Alias Targets In Approved Services Configured'
  severity: medium
  rule_id: aws.route53.recordset.route53_alias_targets_in_approved_services_configured
  for_each:
    discovery: aws.route53.recordsets
    as: recordset
    item: recordset
  conditions:
    var: recordset.compliant
    op: equals
    value: true
- title: 'ROUTE53 recordset: Route53 Dmarc Record Present When Mx Configured'
  severity: medium
  rule_id: aws.route53.recordset.route53_dmarc_record_present_when_mx_configured
  for_each:
    discovery: aws.route53.recordsets
    as: recordset
    item: recordset
  conditions:
    var: recordset.compliant
    op: equals
    value: true
- title: 'ROUTE53 trafficpolicy: Policy Documents Encrypted And Private'
  severity: high
  rule_id: aws.route53.trafficpolicy.policy_documents_encrypted_and_private
  for_each:
    discovery: aws.route53.trafficpolicy_encryption
    as: trafficpolicy
    item: trafficpolicy
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'ROUTE53 recordset: Route53 No Broad Wildcards Sensitive Zones Configured'
  severity: medium
  rule_id: aws.route53.recordset.route53_no_broad_wildcards_sensitive_zones_configured
  for_each:
    discovery: aws.route53.recordsets
    as: recordset
    item: recordset
  conditions:
    var: recordset.compliant
    op: equals
    value: true
- title: 'ROUTE53 trafficpolicy: Route53 Targets Approved Domains Only Configured'
  severity: medium
  rule_id: aws.route53.trafficpolicy.route53_targets_approved_domains_only_configured
  for_each:
    discovery: aws.route53.trafficpolicys
    as: trafficpolicy
    item: trafficpolicy
  conditions:
    var: trafficpolicy.is_public
    op: equals
    value: false
