version: '1.0'
provider: aws
service: route53
services:
  client: route53
  module: boto3.client
discovery:
- discovery_id: aws.route53.list_cidr_collections
  calls:
  - action: list_cidr_collections
    save_as: response
  emit:
    items_for: '{{ response.CidrCollections }}'
    as: resource
    item:
      Arn: '{{ resource.Arn }}'
      Id: '{{ resource.Id }}'
      Name: '{{ resource.Name }}'
      Version: '{{ resource.Version }}'
- discovery_id: aws.route53.list_health_checks
  calls:
  - action: list_health_checks
    save_as: response
  emit:
    items_for: '{{ response.HealthChecks }}'
    as: resource
    item:
      Id: '{{ resource.Id }}'
      CallerReference: '{{ resource.CallerReference }}'
      LinkedService: '{{ resource.LinkedService }}'
      HealthCheckConfig: '{{ resource.HealthCheckConfig }}'
      HealthCheckVersion: '{{ resource.HealthCheckVersion }}'
      CloudWatchAlarmConfiguration: '{{ resource.CloudWatchAlarmConfiguration }}'
- discovery_id: aws.route53.list_query_logging_configs
  calls:
  - action: list_query_logging_configs
    save_as: response
  emit:
    items_for: '{{ response.QueryLoggingConfigs }}'
    as: resource
    item:
      Id: '{{ resource.Id }}'
      HostedZoneId: '{{ resource.HostedZoneId }}'
      CloudWatchLogsLogGroupArn: '{{ resource.CloudWatchLogsLogGroupArn }}'
- discovery_id: aws.route53.activate_key_signing_key
  calls:
  - action: activate_key_signing_key
    save_as: response
    params:
      HostedZoneId: '{{ item.HostedZoneId }}'
      Name: '{{ item.Name }}'
  on_error: continue
  for_each: aws.route53.list_query_logging_configs
  emit:
    item:
      Id: '{{ response.ChangeInfo.Id }}'
      Status: '{{ response.ChangeInfo.Status }}'
      SubmittedAt: '{{ response.ChangeInfo.SubmittedAt }}'
      Comment: '{{ response.ChangeInfo.Comment }}'
- discovery_id: aws.route53.list_resource_record_sets
  calls:
  - action: list_resource_record_sets
    save_as: response
    params:
      HostedZoneId: '{{ item.HostedZoneId }}'
  on_error: continue
  for_each: aws.route53.list_query_logging_configs
  emit:
    items_for: '{{ response.ResourceRecordSets }}'
    as: resource
    item:
      Name: '{{ resource.Name }}'
      Type: '{{ resource.Type }}'
      SetIdentifier: '{{ resource.SetIdentifier }}'
      Weight: '{{ resource.Weight }}'
      Region: '{{ resource.Region }}'
      GeoLocation: '{{ resource.GeoLocation }}'
      Failover: '{{ resource.Failover }}'
      MultiValueAnswer: '{{ resource.MultiValueAnswer }}'
      TTL: '{{ resource.TTL }}'
      ResourceRecords: '{{ resource.ResourceRecords }}'
      AliasTarget: '{{ resource.AliasTarget }}'
      HealthCheckId: '{{ resource.HealthCheckId }}'
      TrafficPolicyInstanceId: '{{ resource.TrafficPolicyInstanceId }}'
      CidrRoutingConfig: '{{ resource.CidrRoutingConfig }}'
      GeoProximityLocation: '{{ resource.GeoProximityLocation }}'
checks:
- rule_id: aws.route53.recordset.no_rfc1918_in_public_zones_configured
  for_each: aws.route53.list_resource_record_sets
  conditions:
    var: item.ResourceRecords
    op: contains
    value:
    - 10.0.0.0/8
    - 172.16.0.0/12
    - 192.168.0.0/16
- rule_id: aws.route53.hostedzone.query_logging_enabled
  for_each: aws.route53.list_query_logging_configs
  conditions:
    var: item.CloudWatchLogsLogGroupArn
    op: exists
- rule_id: aws.route53.trafficpolicy.security_check_health_checks_required_for_failover_configured
  for_each: aws.route53.list_resource_record_sets
  conditions:
    var: item.HealthCheckId
    op: exists
- rule_id: aws.route53.healthcheck.alerts_configured
  for_each: aws.route53.list_health_checks
  conditions:
    var: item.CloudWatchAlarmConfiguration
    op: exists
- rule_id: aws.route53.healthcheck.route53_no_plaintext_credentials_in_url_configured
  for_each: aws.route53.list_health_checks
  conditions:
    var: item.HealthCheckConfig
    op: contains
    value: NO_PLAINTEXT_CREDENTIALS
- rule_id: aws.route53.hostedzone.route53_cross_account_sharing_restricted
  for_each: aws.route53.list_health_checks
  conditions:
    var: item.LinkedService
    op: equals
- rule_id: aws.route53.hostedzone.route53_dnssec_enabled_if_supported
  for_each: aws.route53.activate_key_signing_key
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.route53.healthcheck.https_or_tls_used_configured
  for_each: aws.route53.list_health_checks
  conditions:
    var: item.HealthCheckConfig
    op: contains
    value: HTTPS
- rule_id: aws.route53.resource.public_hosted_zones_cloudwatch_logging_enabled
  for_each: aws.route53.list_query_logging_configs
  conditions:
    var: item.CloudWatchLogsLogGroupArn
    op: exists
- rule_id: aws.route53.recordset.route53_alias_targets_in_approved_services_configured
  for_each: aws.route53.list_resource_record_sets
  conditions:
    var: item.AliasTarget
    op: contains
    value:
    - approved-service-1
    - approved-service-2
- rule_id: aws.route53.trafficpolicy.route53_targets_approved_domains_only_configured
  for_each: aws.route53.list_cidr_collections
  conditions:
    var: item.Name
    op: contains
    value: approved-domain.com
