version: '1.0'
provider: aws
service: transfer
discovery:
- discovery_id: aws.transfer.describe_security_policy
  calls:
  - action: describe_security_policy
    save_as: describe_security_policy_response
    params:
      SecurityPolicyName: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.transfer.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      fips: '{{ describe_security_policy_response.SecurityPolicy.Fips }}'
      security_policy_name: '{{ describe_security_policy_response.SecurityPolicy.SecurityPolicyName
        }}'
      ssh_ciphers: '{{ describe_security_policy_response.SecurityPolicy.SshCiphers
        }}'
      ssh_kexs: '{{ describe_security_policy_response.SecurityPolicy.SshKexs }}'
      ssh_macs: '{{ describe_security_policy_response.SecurityPolicy.SshMacs }}'
checks:
- rule_id: aws.transfer.resource.server_in_transit_encryption_enabled
  for_each: aws.transfer.describe_security_policy
  conditions:
    all:
    - var: item.protocols
      op: contains
      value: TLS
    - var: item.security_policy_name
      op: exists
