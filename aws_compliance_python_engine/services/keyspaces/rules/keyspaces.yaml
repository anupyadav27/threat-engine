version: '1.0'
provider: aws
service: keyspaces
services:
  client: keyspaces
  module: boto3.client
discovery:
- discovery_id: aws.keyspaces.list_keyspaces
  calls:
  - action: list_keyspaces
    save_as: response
  emit:
    items_for: '{{ response.keyspaces }}'
    as: resource
    item:
      keyspaceName: '{{ resource.keyspaceName }}'
      resourceArn: '{{ resource.resourceArn }}'
      replicationStrategy: '{{ resource.replicationStrategy }}'
      replicationRegions: '{{ resource.replicationRegions }}'
- discovery_id: aws.keyspaces.list_tables
  calls:
  - action: list_tables
    save_as: response
    params:
      keyspaceName: '{{ item.keyspaceName }}'
  for_each: aws.keyspaces.list_keyspaces
  on_error: continue
  emit:
    items_for: '{{ response.tables }}'
    as: resource
    item:
      keyspaceName: '{{ resource.keyspaceName }}'
      tableName: '{{ resource.tableName }}'
      resourceArn: '{{ resource.resourceArn }}'
- discovery_id: aws.keyspaces.get_table
  calls:
  - action: get_table
    save_as: response
    params:
      keyspaceName: '{{ item.keyspaceName }}'
      tableName: '{{ item.tableName }}'
  for_each: aws.keyspaces.list_tables
  on_error: continue
  emit:
    item:
      region: '{{ response.replicaSpecifications.region }}'
      status: '{{ response.replicaSpecifications.status }}'
      capacitySpecification: '{{ response.replicaSpecifications.capacitySpecification
        }}'
      encryptionSpecification: '{{ resource.encryptionSpecification }}'
checks:
- rule_id: aws.keyspaces.resource.keyspace_security_configuration_configured
  for_each: aws.keyspaces.get_table
  conditions:
    var: item.encryptionSpecification
    op: not_equals
    value: 'null'
- rule_id: aws.keyspaces.resource.keyspace_encryption_at_rest_and_in_transit_configured
  for_each: aws.keyspaces.get_table
  conditions:
    var: item.encryptionSpecification
    op: equals
    value: 'true'
