version: '1.0'
provider: aws
service: batch
discovery:
- discovery_id: aws.batch.describe_compute_environments
  calls:
  - action: describe_compute_environments
    save_as: describe_compute_environments_response
  emit:
    items_for: '{{ describe_compute_environments_response.computeEnvironments }}'
    as: resource
    item:
      compute_environment_name: '{{ resource.computeEnvironmentName }}'
      compute_environment_arn: '{{ resource.computeEnvironmentArn }}'
      unmanagedv_cpus: '{{ resource.unmanagedvCpus }}'
      ecs_cluster_arn: '{{ resource.ecsClusterArn }}'
      tags: '{{ resource.tags }}'
      type: '{{ resource.type }}'
      state: '{{ resource.state }}'
      status: '{{ resource.status }}'
      status_reason: '{{ resource.statusReason }}'
      compute_resources: '{{ resource.computeResources }}'
- discovery_id: aws.batch.describe_job_queues
  calls:
  - action: describe_job_queues
    save_as: describe_job_queues_response
  emit:
    items_for: '{{ describe_job_queues_response.jobQueues }}'
    as: resource
    item:
      job_queue_name: '{{ resource.jobQueueName }}'
      job_queue_arn: '{{ resource.jobQueueArn }}'
      state: '{{ resource.state }}'
      scheduling_policy_arn: '{{ resource.schedulingPolicyArn }}'
      status: '{{ resource.status }}'
      status_reason: '{{ resource.statusReason }}'
      priority: '{{ resource.priority }}'
      compute_environment_order: '{{ resource.computeEnvironmentOrder }}'
      service_environment_order: '{{ resource.serviceEnvironmentOrder }}'
      job_queue_type: '{{ resource.jobQueueType }}'
checks:
- rule_id: aws.batch.jobqueue.volumes_encrypted
  for_each: aws.batch.describe_compute_environments
  conditions:
    all:
    - var: item.state
      op: equals
      value: ENABLED
    - var: item.state
      op: equals
      value: ENABLED
- rule_id: aws.batch.compute_environment.volumes_encrypted
  for_each: aws.batch.describe_compute_environments
  conditions:
    all:
    - var: item.status
      op: equals
      value: ACTIVE
    - var: item.compute_resources
      op: exists
- rule_id: aws.batch.jobqueue.no_public_ip_assigned_configured
  for_each: aws.batch.describe_compute_environments
  conditions:
    var: item.compute_resources
    op: equals
    value:
      assignPublicIp: DISABLED
- rule_id: aws.batch.compute_environment.instance_profile_least_privilege
  for_each: aws.batch.describe_compute_environments
  conditions:
    all:
    - var: item.service_role
      op: exists
    - var: item.tags
      op: exists
- rule_id: aws.batch.compute_environment.batch_uses_approved_launch_template_configured
  for_each: aws.batch.describe_compute_environments
  conditions:
    all:
    - var: item.state
      op: equals
      value: ENABLED
    - var: item.status
      op: equals
      value: VALID
    - var: item.compute_resources
      op: exists
- rule_id: aws.batch.jobqueue.instance_profile_least_privilege
  for_each: aws.batch.describe_job_queues
  conditions:
    all:
    - var: item.state
      op: equals
      value: ENABLED
    - var: item.status
      op: equals
      value: ACTIVE
    - var: item.compute_environment_order
      op: exists
- rule_id: aws.batch.compute_environment.no_public_ip_assigned_configured
  for_each: aws.batch.describe_compute_environments
  conditions:
    var: item.compute_resources
    op: contains
    value:
      assignPublicIp: DISABLED
- rule_id: aws.batch.jobqueue.batch_uses_approved_launch_template_configured
  for_each: aws.batch.describe_job_queues
  conditions:
    all:
    - var: item.state
      op: equals
      value: ENABLED
    - var: item.compute_environment_order
      op: exists
