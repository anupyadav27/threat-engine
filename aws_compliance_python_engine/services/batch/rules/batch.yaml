version: '1.0'
provider: aws
service: batch
services:
  client: batch
  module: boto3.client
discovery:
- discovery_id: aws.batch.describe_compute_environments
  calls:
  - action: describe_compute_environments
    save_as: response
  emit:
    item:
      computeEnvironmentName: '{{ response.computeEnvironments.computeEnvironmentName
        }}'
      computeEnvironmentArn: '{{ response.computeEnvironments.computeEnvironmentArn
        }}'
      unmanagedvCpus: '{{ response.computeEnvironments.unmanagedvCpus }}'
      ecsClusterArn: '{{ response.computeEnvironments.ecsClusterArn }}'
      tags: '{{ response.computeEnvironments.tags }}'
      type: '{{ response.computeEnvironments.type }}'
      state: '{{ response.computeEnvironments.state }}'
      status: '{{ response.computeEnvironments.status }}'
      statusReason: '{{ response.computeEnvironments.statusReason }}'
      computeResources: '{{ response.computeEnvironments.computeResources }}'
      serviceRole: '{{ response.computeEnvironments.serviceRole }}'
      updatePolicy: '{{ response.computeEnvironments.updatePolicy }}'
      eksConfiguration: '{{ response.computeEnvironments.eksConfiguration }}'
      containerOrchestrationType: '{{ response.computeEnvironments.containerOrchestrationType
        }}'
      uuid: '{{ response.computeEnvironments.uuid }}'
      context: '{{ response.computeEnvironments.context }}'
checks:
- rule_id: aws.batch.jobqueue.no_public_ip_assigned_configured
  for_each: aws.batch.describe_compute_environments
  conditions:
    var: item.computeResources
    op: equals
    value:
      assignPublicIp: DISABLED
- rule_id: aws.batch.compute_environment.no_public_ip_assigned_configured
  for_each: aws.batch.describe_compute_environments
  conditions:
    var: item.computeResources
    op: contains
    value:
      assignPublicIp: DISABLED
