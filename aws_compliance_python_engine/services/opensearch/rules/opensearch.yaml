version: '1.0'
provider: aws
service: opensearch
services:
  client: opensearch
  module: boto3.client
discovery:
- discovery_id: aws.opensearch.list_domain_names
  calls:
  - action: list_domain_names
    save_as: response
  emit:
    items_for: '{{ response.DomainNames }}'
    as: resource
    item:
      DomainName: '{{ resource.DomainName }}'
      EngineType: '{{ resource.EngineType }}'
- discovery_id: aws.opensearch.describe_domain
  calls:
  - action: describe_domain
    save_as: response
    params:
      DomainName: '{{ item.DomainName }}'
  for_each: aws.opensearch.list_domain_names
  on_error: continue
  emit:
    item:
      DomainId: '{{ response.DomainStatus.DomainId }}'
      DomainName: '{{ response.DomainStatus.DomainName }}'
      ARN: '{{ response.DomainStatus.ARN }}'
      Created: '{{ response.DomainStatus.Created }}'
      Deleted: '{{ response.DomainStatus.Deleted }}'
      Endpoint: '{{ response.DomainStatus.Endpoint }}'
      EndpointV2: '{{ response.DomainStatus.EndpointV2 }}'
      Endpoints: '{{ response.DomainStatus.Endpoints }}'
      DomainEndpointV2HostedZoneId: '{{ response.DomainStatus.DomainEndpointV2HostedZoneId
        }}'
      Processing: '{{ response.DomainStatus.Processing }}'
      UpgradeProcessing: '{{ response.DomainStatus.UpgradeProcessing }}'
      EngineVersion: '{{ response.DomainStatus.EngineVersion }}'
      ClusterConfig: '{{ response.DomainStatus.ClusterConfig }}'
      EBSOptions: '{{ response.DomainStatus.EBSOptions }}'
      AccessPolicies: '{{ response.DomainStatus.AccessPolicies }}'
      IPAddressType: '{{ response.DomainStatus.IPAddressType }}'
      SnapshotOptions: '{{ response.DomainStatus.SnapshotOptions }}'
      VPCOptions: '{{ response.DomainStatus.VPCOptions }}'
      CognitoOptions: '{{ response.DomainStatus.CognitoOptions }}'
      EncryptionAtRestOptions: '{{ response.DomainStatus.EncryptionAtRestOptions }}'
      NodeToNodeEncryptionOptions: '{{ response.DomainStatus.NodeToNodeEncryptionOptions
        }}'
      AdvancedOptions: '{{ response.DomainStatus.AdvancedOptions }}'
      LogPublishingOptions: '{{ response.DomainStatus.LogPublishingOptions }}'
      ServiceSoftwareOptions: '{{ response.DomainStatus.ServiceSoftwareOptions }}'
      DomainEndpointOptions: '{{ response.DomainStatus.DomainEndpointOptions }}'
      AdvancedSecurityOptions: '{{ response.DomainStatus.AdvancedSecurityOptions }}'
      IdentityCenterOptions: '{{ response.DomainStatus.IdentityCenterOptions }}'
      AutoTuneOptions: '{{ response.DomainStatus.AutoTuneOptions }}'
      ChangeProgressDetails: '{{ response.DomainStatus.ChangeProgressDetails }}'
      OffPeakWindowOptions: '{{ response.DomainStatus.OffPeakWindowOptions }}'
      SoftwareUpdateOptions: '{{ response.DomainStatus.SoftwareUpdateOptions }}'
      DomainProcessingStatus: '{{ response.DomainStatus.DomainProcessingStatus }}'
      ModifyingProperties: '{{ response.DomainStatus.ModifyingProperties }}'
      AIMLOptions: '{{ response.DomainStatus.AIMLOptions }}'
      AdvancedSecurityEnabled: '{{ resource.AdvancedSecurityEnabled }}'
      DataNodeCount: '{{ resource.DataNodeCount }}'
      DedicatedMaster: '{{ resource.DedicatedMaster }}'
      EncryptionEnabled: '{{ resource.EncryptionEnabled }}'
checks:
- rule_id: aws.opensearch.service.domains_encryption_at_rest_enabled
  for_each: aws.opensearch.describe_domain
  conditions:
    var: item.EncryptionEnabled
    op: equals
    value: 'true'
- rule_id: aws.opensearch.service.opensearch_domains_https_communications_enforced
  for_each: aws.opensearch.describe_domain
  conditions:
    var: item.AdvancedSecurityEnabled
    op: equals
    value: 'true'
- rule_id: aws.opensearch.service.domains_node_to_node_encryption_enabled
  for_each: aws.opensearch.describe_domain
  conditions:
    var: item.NodeToNodeEncryptionOptions
    op: equals
    value: 'true'
- rule_id: aws.opensearch.service.domains_not_publicly_accessible_configured
  for_each: aws.opensearch.describe_domain
  conditions:
    var: item.AccessPolicies
    op: not_equals
    value: 'null'
- rule_id: aws.opensearch.service.domains_fault_tolerant_data_nodes_configured
  for_each: aws.opensearch.describe_domain
  conditions:
    var: item.DataNodeCount
    op: greater_than
    value: '1'
- rule_id: aws.opensearch.service.domains_audit_logging_enabled
  for_each: aws.opensearch.describe_domain
  conditions:
    var: item.LogPublishingOptions
    op: not_equals
    value: 'null'
- rule_id: aws.opensearch.service.domains_access_control_enabled
  for_each: aws.opensearch.describe_domain
  conditions:
    var: item.AccessPolicies
    op: not_equals
    value: 'null'
- rule_id: aws.opensearch.service.domains_cloudwatch_logging_enabled
  for_each: aws.opensearch.describe_domain
  conditions:
    var: item.LogPublishingOptions
    op: not_equals
    value: 'null'
- rule_id: aws.opensearch.service.domains_internal_user_database_enabled
  for_each: aws.opensearch.describe_domain
  conditions:
    var: item.AdvancedSecurityEnabled
    op: equals
    value: 'true'
- rule_id: aws.opensearch.service.domains_fault_tolerant_master_nodes_configured
  for_each: aws.opensearch.describe_domain
  conditions:
    var: item.DedicatedMaster
    op: equals
    value: 'true'
