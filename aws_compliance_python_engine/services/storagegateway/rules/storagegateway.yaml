version: '1.0'
provider: aws
service: storagegateway
services:
  client: storagegateway
  module: boto3.client
discovery:
- discovery_id: aws.storagegateway.describe_tape_archives
  calls:
  - action: describe_tape_archives
    save_as: response
  emit:
    item:
      TapeARN: '{{ response.TapeArchives.TapeARN }}'
      TapeBarcode: '{{ response.TapeArchives.TapeBarcode }}'
      TapeCreatedDate: '{{ response.TapeArchives.TapeCreatedDate }}'
      TapeSizeInBytes: '{{ response.TapeArchives.TapeSizeInBytes }}'
      CompletionTime: '{{ response.TapeArchives.CompletionTime }}'
      RetrievedTo: '{{ response.TapeArchives.RetrievedTo }}'
      TapeStatus: '{{ response.TapeArchives.TapeStatus }}'
      TapeUsedInBytes: '{{ response.TapeArchives.TapeUsedInBytes }}'
      KMSKey: '{{ response.TapeArchives.KMSKey }}'
      PoolId: '{{ response.TapeArchives.PoolId }}'
      Worm: '{{ response.TapeArchives.Worm }}'
      RetentionStartDate: '{{ response.TapeArchives.RetentionStartDate }}'
      PoolEntryDate: '{{ response.TapeArchives.PoolEntryDate }}'
- discovery_id: aws.storagegateway.list_gateways
  calls:
  - action: list_gateways
    save_as: response
  emit:
    items_for: '{{ response.Gateways }}'
    as: resource
    item:
      GatewayId: '{{ resource.GatewayId }}'
      GatewayARN: '{{ resource.GatewayARN }}'
      GatewayType: '{{ resource.GatewayType }}'
      GatewayOperationalState: '{{ resource.GatewayOperationalState }}'
      GatewayName: '{{ resource.GatewayName }}'
      Ec2InstanceId: '{{ resource.Ec2InstanceId }}'
      Ec2InstanceRegion: '{{ resource.Ec2InstanceRegion }}'
      HostEnvironment: '{{ resource.HostEnvironment }}'
      HostEnvironmentId: '{{ resource.HostEnvironmentId }}'
      DeprecationDate: '{{ resource.DeprecationDate }}'
      SoftwareVersion: '{{ resource.SoftwareVersion }}'
- discovery_id: aws.storagegateway.describe_cache
  calls:
  - action: describe_cache
    save_as: response
    params:
      GatewayARN: '{{ item.GatewayARN }}'
  on_error: continue
  for_each: aws.storagegateway.list_gateways
- discovery_id: aws.storagegateway.describe_file_system_associations
  calls:
  - action: describe_file_system_associations
    save_as: response
  emit:
    item:
      FileSystemAssociationARN: '{{ response.FileSystemAssociationInfoList.FileSystemAssociationARN
        }}'
      LocationARN: '{{ response.FileSystemAssociationInfoList.LocationARN }}'
      FileSystemAssociationStatus: '{{ response.FileSystemAssociationInfoList.FileSystemAssociationStatus
        }}'
      AuditDestinationARN: '{{ response.FileSystemAssociationInfoList.AuditDestinationARN
        }}'
      GatewayARN: '{{ response.FileSystemAssociationInfoList.GatewayARN }}'
      Tags: '{{ response.FileSystemAssociationInfoList.Tags }}'
      CacheAttributes: '{{ response.FileSystemAssociationInfoList.CacheAttributes
        }}'
      EndpointNetworkConfiguration: '{{ response.FileSystemAssociationInfoList.EndpointNetworkConfiguration
        }}'
      FileSystemAssociationStatusDetails: '{{ response.FileSystemAssociationInfoList.FileSystemAssociationStatusDetails
        }}'
- discovery_id: aws.storagegateway.describe_nfs_file_shares
  calls:
  - action: describe_nfs_file_shares
    save_as: response
  emit:
    item:
      NFSFileShareDefaults: '{{ response.NFSFileShareInfoList.NFSFileShareDefaults
        }}'
      FileShareARN: '{{ response.NFSFileShareInfoList.FileShareARN }}'
      FileShareId: '{{ response.NFSFileShareInfoList.FileShareId }}'
      FileShareStatus: '{{ response.NFSFileShareInfoList.FileShareStatus }}'
      GatewayARN: '{{ response.NFSFileShareInfoList.GatewayARN }}'
      EncryptionType: '{{ response.NFSFileShareInfoList.EncryptionType }}'
      KMSEncrypted: '{{ response.NFSFileShareInfoList.KMSEncrypted }}'
      KMSKey: '{{ response.NFSFileShareInfoList.KMSKey }}'
      Path: '{{ response.NFSFileShareInfoList.Path }}'
      Role: '{{ response.NFSFileShareInfoList.Role }}'
      LocationARN: '{{ response.NFSFileShareInfoList.LocationARN }}'
      DefaultStorageClass: '{{ response.NFSFileShareInfoList.DefaultStorageClass }}'
      ObjectACL: '{{ response.NFSFileShareInfoList.ObjectACL }}'
      ClientList: '{{ response.NFSFileShareInfoList.ClientList }}'
      Squash: '{{ response.NFSFileShareInfoList.Squash }}'
      ReadOnly: '{{ response.NFSFileShareInfoList.ReadOnly }}'
      GuessMIMETypeEnabled: '{{ response.NFSFileShareInfoList.GuessMIMETypeEnabled
        }}'
      RequesterPays: '{{ response.NFSFileShareInfoList.RequesterPays }}'
      Tags: '{{ response.NFSFileShareInfoList.Tags }}'
      FileShareName: '{{ response.NFSFileShareInfoList.FileShareName }}'
      CacheAttributes: '{{ response.NFSFileShareInfoList.CacheAttributes }}'
      NotificationPolicy: '{{ response.NFSFileShareInfoList.NotificationPolicy }}'
      VPCEndpointDNSName: '{{ response.NFSFileShareInfoList.VPCEndpointDNSName }}'
      BucketRegion: '{{ response.NFSFileShareInfoList.BucketRegion }}'
      AuditDestinationARN: '{{ response.NFSFileShareInfoList.AuditDestinationARN }}'
checks:
- rule_id: aws.storagegateway.volume.snapshots_encrypted
  for_each: aws.storagegateway.describe_tape_archives
  conditions:
    var: item.KMSKey
    op: exists
- rule_id: aws.storagegateway.volume.kms_key_policy_least_privilege
  for_each: aws.storagegateway.describe_tape_archives
  conditions:
    var: item.KMSKey
    op: exists
- rule_id: aws.storagegateway.volume.encryption_at_rest_enabled
  for_each: aws.storagegateway.describe_tape_archives
  conditions:
    var: item.KMSKey
    op: exists
- rule_id: aws.storagegateway.volume.snapshots_enabled
  for_each: aws.storagegateway.describe_cachedi_scsi_volumes
  conditions:
    var: item.source_snapshot_id
    op: exists
- rule_id: aws.storagegateway.gateway.kms_key_policy_least_privilege
  for_each: aws.storagegateway.describe_tape_archives
  conditions:
    var: item.KMSKey
    op: exists
- rule_id: aws.storagegateway.volume.storagegateway_cmk_cmek_configured
  for_each: aws.storagegateway.describe_tape_archives
  conditions:
    var: item.KMSKey
    op: exists
- rule_id: aws.storagegateway.resource.fileshare_encryption_enabled
  for_each: aws.storagegateway.describe_nfs_file_shares
  conditions:
    var: item.KMSEncrypted
    op: equals
    value: true
- rule_id: aws.storagegateway.volume.private_network_only_configured
  for_each: aws.storagegateway.describe_file_system_associations
  conditions:
    var: item.EndpointNetworkConfiguration
    op: exists
