version: '1.0'
provider: aws
service: storagegateway
services:
  client: storagegateway
  module: boto3.client
discovery:
- discovery_id: aws.storagegateway.describe_n_f_s_file_shares
  calls:
  - action: describe_nfs_file_shares
    save_as: response
  emit:
    item:
      NFSFileShareDefaults: '{{ response.NFSFileShareInfoList.NFSFileShareDefaults
        }}'
      FileShareARN: '{{ response.NFSFileShareInfoList.FileShareARN }}'
      FileShareId: '{{ response.NFSFileShareInfoList.FileShareId }}'
      FileShareStatus: '{{ response.NFSFileShareInfoList.FileShareStatus }}'
      GatewayARN: '{{ response.NFSFileShareInfoList.GatewayARN }}'
      EncryptionType: '{{ response.NFSFileShareInfoList.EncryptionType }}'
      KMSEncrypted: '{{ response.NFSFileShareInfoList.KMSEncrypted }}'
      KMSKey: '{{ response.NFSFileShareInfoList.KMSKey }}'
      Path: '{{ response.NFSFileShareInfoList.Path }}'
      Role: '{{ response.NFSFileShareInfoList.Role }}'
      LocationARN: '{{ response.NFSFileShareInfoList.LocationARN }}'
      DefaultStorageClass: '{{ response.NFSFileShareInfoList.DefaultStorageClass }}'
      ObjectACL: '{{ response.NFSFileShareInfoList.ObjectACL }}'
      ClientList: '{{ response.NFSFileShareInfoList.ClientList }}'
      Squash: '{{ response.NFSFileShareInfoList.Squash }}'
      ReadOnly: '{{ response.NFSFileShareInfoList.ReadOnly }}'
      GuessMIMETypeEnabled: '{{ response.NFSFileShareInfoList.GuessMIMETypeEnabled
        }}'
      RequesterPays: '{{ response.NFSFileShareInfoList.RequesterPays }}'
      Tags: '{{ response.NFSFileShareInfoList.Tags }}'
      FileShareName: '{{ response.NFSFileShareInfoList.FileShareName }}'
      CacheAttributes: '{{ response.NFSFileShareInfoList.CacheAttributes }}'
      NotificationPolicy: '{{ response.NFSFileShareInfoList.NotificationPolicy }}'
      VPCEndpointDNSName: '{{ response.NFSFileShareInfoList.VPCEndpointDNSName }}'
      BucketRegion: '{{ response.NFSFileShareInfoList.BucketRegion }}'
      AuditDestinationARN: '{{ response.NFSFileShareInfoList.AuditDestinationARN }}'
- discovery_id: aws.storagegateway.list_gateways
  calls:
  - action: list_gateways
    save_as: response
  emit:
    items_for: '{{ response.Gateways }}'
    as: resource
    item:
      GatewayId: '{{ resource.GatewayId }}'
      GatewayARN: '{{ resource.GatewayARN }}'
      GatewayType: '{{ resource.GatewayType }}'
      GatewayOperationalState: '{{ resource.GatewayOperationalState }}'
      GatewayName: '{{ resource.GatewayName }}'
      Ec2InstanceId: '{{ resource.Ec2InstanceId }}'
      Ec2InstanceRegion: '{{ resource.Ec2InstanceRegion }}'
      HostEnvironment: '{{ resource.HostEnvironment }}'
      HostEnvironmentId: '{{ resource.HostEnvironmentId }}'
      DeprecationDate: '{{ resource.DeprecationDate }}'
      SoftwareVersion: '{{ resource.SoftwareVersion }}'
- discovery_id: aws.storagegateway.describe_cachedi_s_c_s_i_volumes
  calls:
  - action: describe_cachedi_scsi_volumes
    save_as: response
  emit:
    item:
      VolumeARN: '{{ response.CachediSCSIVolumes.VolumeARN }}'
      VolumeId: '{{ response.CachediSCSIVolumes.VolumeId }}'
      VolumeType: '{{ response.CachediSCSIVolumes.VolumeType }}'
      VolumeStatus: '{{ response.CachediSCSIVolumes.VolumeStatus }}'
      VolumeAttachmentStatus: '{{ response.CachediSCSIVolumes.VolumeAttachmentStatus
        }}'
      VolumeSizeInBytes: '{{ response.CachediSCSIVolumes.VolumeSizeInBytes }}'
      VolumeProgress: '{{ response.CachediSCSIVolumes.VolumeProgress }}'
      SourceSnapshotId: '{{ response.CachediSCSIVolumes.SourceSnapshotId }}'
      VolumeiSCSIAttributes: '{{ response.CachediSCSIVolumes.VolumeiSCSIAttributes
        }}'
      CreatedDate: '{{ response.CachediSCSIVolumes.CreatedDate }}'
      VolumeUsedInBytes: '{{ response.CachediSCSIVolumes.VolumeUsedInBytes }}'
      KMSKey: '{{ response.CachediSCSIVolumes.KMSKey }}'
      TargetName: '{{ response.CachediSCSIVolumes.TargetName }}'
- discovery_id: aws.storagegateway.describe_file_system_associations
  calls:
  - action: describe_file_system_associations
    save_as: response
  emit:
    item:
      FileSystemAssociationARN: '{{ response.FileSystemAssociationInfoList.FileSystemAssociationARN
        }}'
      LocationARN: '{{ response.FileSystemAssociationInfoList.LocationARN }}'
      FileSystemAssociationStatus: '{{ response.FileSystemAssociationInfoList.FileSystemAssociationStatus
        }}'
      AuditDestinationARN: '{{ response.FileSystemAssociationInfoList.AuditDestinationARN
        }}'
      GatewayARN: '{{ response.FileSystemAssociationInfoList.GatewayARN }}'
      Tags: '{{ response.FileSystemAssociationInfoList.Tags }}'
      CacheAttributes: '{{ response.FileSystemAssociationInfoList.CacheAttributes
        }}'
      EndpointNetworkConfiguration: '{{ response.FileSystemAssociationInfoList.EndpointNetworkConfiguration
        }}'
      FileSystemAssociationStatusDetails: '{{ response.FileSystemAssociationInfoList.FileSystemAssociationStatusDetails
        }}'
checks:
- rule_id: aws.storagegateway.volume.snapshots_encrypted
  for_each: aws.storagegateway.describe_n_f_s_file_shares
  conditions:
    var: item.KMSEncrypted
    op: equals
    value: 'true'
- rule_id: aws.storagegateway.volume.kms_key_policy_least_privilege
  for_each: aws.storagegateway.describe_n_f_s_file_shares
  conditions:
    var: item.KMSEncrypted
    op: equals
    value: 'true'
- rule_id: aws.storagegateway.gateway.snapshots_enabled
  for_each: aws.storagegateway.list_gateways
  conditions:
    var: item.GatewayOperationalState
    op: equals
    value: IN_PROGRESS
- rule_id: aws.storagegateway.volume.encryption_at_rest_enabled
  for_each: aws.storagegateway.describe_n_f_s_file_shares
  conditions:
    var: item.KMSEncrypted
    op: equals
    value: 'true'
- rule_id: aws.storagegateway.volume.snapshots_enabled
  for_each: aws.storagegateway.describe_cachedi_s_c_s_i_volumes
  conditions:
    var: item.VolumeStatus
    op: equals
    value: ACTIVE
- rule_id: aws.storagegateway.gateway.private_network_only_configured
  for_each: aws.storagegateway.describe_file_system_associations
  conditions:
    var: item.EndpointNetworkConfiguration
    op: not_equals
    value: 'null'
- rule_id: aws.storagegateway.gateway.kms_key_policy_least_privilege
  for_each: aws.storagegateway.describe_n_f_s_file_shares
  conditions:
    var: item.KMSEncrypted
    op: equals
    value: 'true'
- rule_id: aws.storagegateway.volume.storagegateway_cmk_cmek_configured
  for_each: aws.storagegateway.describe_n_f_s_file_shares
  conditions:
    var: item.KMSEncrypted
    op: equals
    value: 'true'
- rule_id: aws.storagegateway.resource.fileshare_encryption_enabled
  for_each: aws.storagegateway.describe_n_f_s_file_shares
  conditions:
    var: item.KMSEncrypted
    op: equals
    value: 'true'
- rule_id: aws.storagegateway.gateway.encryption_at_rest_enabled
  for_each: aws.storagegateway.describe_n_f_s_file_shares
  conditions:
    var: item.KMSEncrypted
    op: equals
    value: 'true'
- rule_id: aws.storagegateway.volume.private_network_only_configured
  for_each: aws.storagegateway.describe_file_system_associations
  conditions:
    var: item.EndpointNetworkConfiguration
    op: equals
    value: Private
