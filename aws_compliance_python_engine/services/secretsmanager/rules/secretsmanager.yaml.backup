version: '1.0'
provider: aws
service: secretsmanager
discovery:
- discovery_id: aws.secretsmanager.list_secrets
  calls:
  - action: list_secrets
    save_as: list_secrets_response
  emit:
    items_for: '{{ list_secrets_response.SecretList }}'
    as: resource
    item:
      arn: '{{ resource.ARN }}'
      name: '{{ resource.Name }}'
      type: '{{ resource.Type }}'
      description: '{{ resource.Description }}'
      kms_key_id: '{{ resource.KmsKeyId }}'
      rotation_enabled: '{{ resource.RotationEnabled }}'
      rotation_lambda_arn: '{{ resource.RotationLambdaARN }}'
      rotation_rules: '{{ resource.RotationRules }}'
      external_secret_rotation_metadata: '{{ resource.ExternalSecretRotationMetadata
        }}'
      external_secret_rotation_role_arn: '{{ resource.ExternalSecretRotationRoleArn
        }}'
checks:
- rule_id: aws.secretsmanager.resource.secret_rotation_enabled
  for_each: aws.secretsmanager.list_secrets
  conditions:
    var: item.rotation_enabled
    op: equals
    value: true
- rule_id: aws.secretsmanager.secret.kms_encryption_enabled
  for_each: aws.secretsmanager.list_secrets
  conditions:
    var: item.kms_key_id
    op: exists
- rule_id: aws.secretsmanager.automatic.rotation_enabled
  for_each: aws.secretsmanager.list_secrets
  conditions:
    var: item.rotation_enabled
    op: equals
    value: true
- rule_id: aws.secretsmanager.secret.kms_key_configured
  for_each: aws.secretsmanager.list_secrets
  conditions:
    var: item.kms_key_id
    op: exists
- rule_id: aws.secretsmanager.secret.rotation_enabled_for_rotatable_secrets
  for_each: aws.secretsmanager.list_secrets
  conditions:
    var: item.rotation_enabled
    op: equals
    value: true
- rule_id: aws.secretsmanager.secret.rotation_enabled_for_rotatable_s
  for_each: aws.secretsmanager.list_secrets
  conditions:
    var: item.rotation_enabled
    op: equals
    value: true
- rule_id: aws.secretsmanager.secret.rotation_configured_if_applicable
  for_each: aws.secretsmanager.list_secrets
  conditions:
    var: item.rotation_enabled
    op: equals
    value: true
