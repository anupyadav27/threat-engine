version: '1.0'
provider: aws
service: codebuild
discovery:
- discovery_id: aws.codebuild.retry_build
  calls:
  - action: retry_build
    save_as: retry_build_response
  emit:
    items_for: '{{ retry_build_response.build }}'
    as: resource
    item:
      id: '{{ resource.id }}'
      arn: '{{ resource.arn }}'
      build_number: '{{ resource.buildNumber }}'
      start_time: '{{ resource.startTime }}'
      end_time: '{{ resource.endTime }}'
      current_phase: '{{ resource.currentPhase }}'
      build_status: '{{ resource.buildStatus }}'
      source_version: '{{ resource.sourceVersion }}'
      resolved_source_version: '{{ resource.resolvedSourceVersion }}'
      project_name: '{{ resource.projectName }}'
- discovery_id: aws.codebuild.batch_get_fleets
  calls:
  - action: batch_get_fleets
    save_as: batch_get_fleets_response
    params:
      names: '{{ item.id }}'
    on_error: continue
  for_each: aws.codebuild.retry_build
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      arn: '{{ batch_get_fleets_response.fleets.arn }}'
      name: '{{ batch_get_fleets_response.fleets.name }}'
      id: '{{ batch_get_fleets_response.fleets.id }}'
      created: '{{ batch_get_fleets_response.fleets.created }}'
      last_modified: '{{ batch_get_fleets_response.fleets.lastModified }}'
checks:
- rule_id: aws.codebuild.resource.codebuild_project_envvar_awscred_configured
  for_each: aws.codebuild.retry_build
  conditions:
    var: item.environment
    op: exists
- rule_id: aws.codebuild.user.codebuild_controlled_buildspec_configured
  for_each: aws.codebuild.retry_build
  conditions:
    all:
    - var: item.source
      op: exists
    - var: item.secondary_sources
      op: exists
- rule_id: aws.codebuild.resource.project_logging_enabled
  for_each: aws.codebuild.retry_build
  conditions:
    var: item.logs
    op: exists
- rule_id: aws.codebuild.group.codebuild_export_encrypted
  for_each: aws.codebuild.retry_build
  conditions:
    var: item.encryption_key
    op: exists
- rule_id: aws.codebuild.resource.codebuild_project_s3_logs_encrypted
  for_each: aws.codebuild.retry_build
  conditions:
    var: item.encryption_key
    op: exists
- rule_id: aws.codebuild.project.codebuild_older_90_days_configured
  for_each: aws.codebuild.batch_get_fleets
  conditions:
    var: item.last_modified
    op: lte
    value: '2023-07-01T00:00:00Z'
- rule_id: aws.codebuild.resource.codebuild_project_source_repo_url_configured
  for_each: aws.codebuild.retry_build
  conditions:
    var: item.source
    op: exists
- rule_id: aws.codebuild.projectartifact.encryption_enabled
  for_each: aws.codebuild.retry_build
  conditions:
    var: item.encryption_key
    op: exists
