# COSTEXPLORER Service - Logic Only
# Metadata (titles, severity, descriptions) in: metadata/checks/costexplorer_metadata.yaml

version: '1.0'
provider: aws
service: costexplorer
discovery:
- discovery_id: aws.costexplorer.costcategorys
  calls:
  - action: list_costexplorers
    fields:
    - Costexplorers
  emit:
    items_for: list_costexplorers_response[]
    item:
      id: '{{ costcategory.Id }}'
      name: '{{ costcategory.Name }}'
- discovery_id: aws.costexplorer.costcategory_encryption
  for_each: aws.costexplorer.costcategorys
  calls:
  - action: list_costexplorers
    params:
      CostcategoryId: '{{ item.id }}'
  emit:
    item:
      resource_id: '{{ item.id }}'
      encryption_enabled: '{{ list_costexplorers_response.Encrypted if list_costexplorers_response.Encrypted
        is defined else false }}'
- discovery_id: aws.costexplorer.cost_allocation_tags
  for_each: aws.costexplorer.cost_allocation_tag
  calls:
  - action: describe_cost_allocation_tags
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.costexplorer.anomalydetectors
  for_each: aws.costexplorer.anomalydetector
  calls:
  - action: describe_anomalydetectors
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
checks:
- rule_id: aws.costexplorer.costcategory.billing_admins_mfa_required
  for_each: aws.costexplorer.costcategorys
  conditions:
    var: item.compliant
    op: equals
    value: true
- rule_id: aws.costexplorer.cost_allocation_tag.costexplorer_required_cost_tags_present
  for_each: aws.costexplorer.cost_allocation_tags
  conditions:
    var: item.compliant
    op: equals
    value: true
- rule_id: aws.costexplorer.anomalydetector.costexplorer_detectors_enabled
  for_each: aws.costexplorer.anomalydetectors
  conditions:
    var: item.compliant
    op: equals
    value: true
- rule_id: aws.costexplorer.cost_allocation_tag.untagged_resource_alerts_enabled
  for_each: aws.costexplorer.cost_allocation_tags
  conditions:
    var: item.monitoring_enabled
    op: equals
    value: true
- rule_id: aws.costexplorer.anomalydetector.costexplorer_severity_thresholds_configured
  for_each: aws.costexplorer.anomalydetectors
  conditions:
    var: item.compliant
    op: equals
    value: true
- rule_id: aws.costexplorer.cost_allocation_tag.cost_tag_policy_enforced
  for_each: aws.costexplorer.cost_allocation_tags
  conditions:
    var: item.is_public
    op: equals
    value: false
- rule_id: aws.costexplorer.costcategory.billing_console_rbac_least_privilege
  for_each: aws.costexplorer.costcategorys
  conditions:
    var: item.is_public
    op: equals
    value: false
- rule_id: aws.costexplorer.anomalydetector.alert_destinations_configured
  for_each: aws.costexplorer.anomalydetectors
  conditions:
    var: item.monitoring_enabled
    op: equals
    value: true
- rule_id: aws.costexplorer.costcategory.costexplorer_cost_export_destinations_least_privilege
  for_each: aws.costexplorer.costcategorys
  conditions:
    var: item.is_public
    op: equals
    value: false
- rule_id: aws.costexplorer.costcategory.costexplorer_cost_data_exports_private_and_encrypted
  for_each: aws.costexplorer.costcategory_encryption
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
