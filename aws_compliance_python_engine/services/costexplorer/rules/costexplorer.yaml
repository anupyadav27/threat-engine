version: '1.0'
provider: aws
service: costexplorer
discovery:
- discovery_id: aws.costexplorer.costcategorys
  calls:
  - client: costexplorer
    action: list_costexplorers
    save_as: costcategory_list
    on_error: continue
    fields:
    - Costexplorers
  emit:
    items_for: costcategory_list[]
    as: costcategory
    item:
      id: '{{ costcategory.Id }}'
      name: '{{ costcategory.Name }}'
- discovery_id: aws.costexplorer.costcategory_encryption
  for_each: aws.costexplorer.costcategorys
  calls:
  - client: costexplorer
    action: list_costexplorers
    params:
      CostcategoryId: '{{ item.id }}'
    save_as: encryption
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      encryption_enabled: '{{ encryption.Encrypted if encryption.Encrypted is defined else false }}'
- discovery_id: aws.costexplorer.cost_allocation_tags
  for_each: aws.costexplorer.cost_allocation_tag
  calls:
  - client: costexplorer
    action: describe_cost_allocation_tags
    save_as: cost_allocation_tags
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.costexplorer.anomalydetectors
  for_each: aws.costexplorer.anomalydetector
  calls:
  - client: costexplorer
    action: describe_anomalydetectors
    save_as: anomalydetectors
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
checks:
- title: 'COSTEXPLORER costcategory: Billing Admins Mfa Required'
  severity: critical
  rule_id: aws.costexplorer.costcategory.billing_admins_mfa_required
  for_each:
    discovery: aws.costexplorer.costcategorys
    as: costcategory
    item: costcategory
  conditions:
    var: costcategory.compliant
    op: equals
    value: true
  remediation: "Configure costexplorer costcategory for compliance:\n\nRequirement: Multi-Factor Authentication\n\nDescription:\
    \ Checks that AWS COSTEXPLORER costcategory requires multi-factor authentication (MFA) for access, combining something\
    \ you know (password) with something you have (token/device). MFA significantly reduces account compromise risk from phishing,\
    \ credential stuffing, and password reuse attacks.\n\nSteps:\n1. Open COSTEXPLORER console\n2. Select the costcategory\n\
    3. Review security configuration\n4. Apply required settings per organizational policy\n5. Verify compliance\n6. Save\
    \ changes\n\nGeneral Security Recommendations:\n\u2022 Follow AWS Well-Architected Framework\n\u2022 Implement defense\
    \ in depth\n\u2022 Enable logging and monitoring\n\u2022 Use encryption where applicable\n\u2022 Regular security audits"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
- title: 'COSTEXPLORER cost allocation tag: Costexplorer Required Cost Tags Present'
  severity: medium
  rule_id: aws.costexplorer.cost_allocation_tag.costexplorer_required_cost_tags_present
  for_each:
    discovery: aws.costexplorer.cost_allocation_tags
    as: cost_allocation_tag
    item: cost_allocation_tag
  conditions:
    var: cost_allocation_tag.compliant
    op: equals
    value: true
  remediation: "Configure costexplorer cost_allocation_tag for compliance:\n\nRequirement: Costexplorer Required Cost Tags\
    \ Present\n\nDescription: Verifies security configuration for AWS COSTEXPLORER cost allocation tag to ensure alignment\
    \ with AWS security best practices and compliance requirements. Proper configuration reduces security risks, maintains\
    \ defense in depth, and supports overall security posture.\n\nSteps:\n1. Open COSTEXPLORER console\n2. Select the cost_allocation_tag\n\
    3. Review security configuration\n4. Apply required settings per organizational policy\n5. Verify compliance\n6. Save\
    \ changes\n\nGeneral Security Recommendations:\n\u2022 Follow AWS Well-Architected Framework\n\u2022 Implement defense\
    \ in depth\n\u2022 Enable logging and monitoring\n\u2022 Use encryption where applicable\n\u2022 Regular security audits"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
- title: 'COSTEXPLORER anomalydetector: Costexplorer Detectors Enabled'
  severity: medium
  rule_id: aws.costexplorer.anomalydetector.costexplorer_detectors_enabled
  for_each:
    discovery: aws.costexplorer.anomalydetectors
    as: anomalydetector
    item: anomalydetector
  conditions:
    var: anomalydetector.compliant
    op: equals
    value: true
  remediation: "Configure costexplorer anomalydetector for compliance:\n\nRequirement: Costexplorer Detectors Enabled\n\n\
    Description: Verifies security configuration for AWS COSTEXPLORER anomalydetector to ensure alignment with AWS security\
    \ best practices and compliance requirements. Proper configuration reduces security risks, maintains defense in depth,\
    \ and supports overall security posture.\n\nSteps:\n1. Open COSTEXPLORER console\n2. Select the anomalydetector\n3. Review\
    \ security configuration\n4. Apply required settings per organizational policy\n5. Verify compliance\n6. Save changes\n\
    \nGeneral Security Recommendations:\n\u2022 Follow AWS Well-Architected Framework\n\u2022 Implement defense in depth\n\
    \u2022 Enable logging and monitoring\n\u2022 Use encryption where applicable\n\u2022 Regular security audits"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
- title: 'COSTEXPLORER cost allocation tag: Untagged Resource Alerts Enabled'
  severity: medium
  rule_id: aws.costexplorer.cost_allocation_tag.untagged_resource_alerts_enabled
  for_each:
    discovery: aws.costexplorer.cost_allocation_tags
    as: cost_allocation_tag
    item: cost_allocation_tag
  conditions:
    var: cost_allocation_tag.monitoring_enabled
    op: equals
    value: true
  remediation: "Enable monitoring for costexplorer cost_allocation_tag:\n\n1. Open CloudWatch console\n2. Create alarm for\
    \ cost_allocation_tag\n3. Configure metrics to monitor\n4. Set alarm thresholds\n5. Configure SNS notifications\n6. Enable\
    \ detailed monitoring (if available)\n7. Create dashboard for visualization\n\nMonitoring Best Practices:\n\u2022 Monitor\
    \ security-relevant metrics\n\u2022 Set up automated alerting\n\u2022 Integrate with SIEM/SOC\n\u2022 Regular review of\
    \ metrics\n\u2022 Implement automated remediation"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
- title: 'COSTEXPLORER anomalydetector: Costexplorer Severity Thresholds Configured'
  severity: medium
  rule_id: aws.costexplorer.anomalydetector.costexplorer_severity_thresholds_configured
  for_each:
    discovery: aws.costexplorer.anomalydetectors
    as: anomalydetector
    item: anomalydetector
  conditions:
    var: anomalydetector.compliant
    op: equals
    value: true
  remediation: "Configure costexplorer anomalydetector for compliance:\n\nRequirement: Costexplorer Severity Thresholds Configuration\n\
    \nDescription: Verifies security configuration for AWS COSTEXPLORER anomalydetector to ensure alignment with AWS security\
    \ best practices and compliance requirements. Proper configuration reduces security risks, maintains defense in depth,\
    \ and supports overall security posture.\n\nSteps:\n1. Open COSTEXPLORER console\n2. Select the anomalydetector\n3. Review\
    \ security configuration\n4. Apply required settings per organizational policy\n5. Verify compliance\n6. Save changes\n\
    \nGeneral Security Recommendations:\n\u2022 Follow AWS Well-Architected Framework\n\u2022 Implement defense in depth\n\
    \u2022 Enable logging and monitoring\n\u2022 Use encryption where applicable\n\u2022 Regular security audits"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
- title: 'COSTEXPLORER cost allocation tag: Cost Tag Policy Enforced'
  severity: high
  rule_id: aws.costexplorer.cost_allocation_tag.cost_tag_policy_enforced
  for_each:
    discovery: aws.costexplorer.cost_allocation_tags
    as: cost_allocation_tag
    item: cost_allocation_tag
  conditions:
    var: cost_allocation_tag.is_public
    op: equals
    value: false
  remediation: "Restrict public access for costexplorer cost_allocation_tag:\n\n1. Open COSTEXPLORER console\n2. Select the\
    \ cost_allocation_tag\n3. Go to Permissions/Access Control\n4. Review current permissions:\n   - Remove public access\
    \ grants\n   - Remove wildcard (*) principals\n   - Implement least privilege\n5. Update resource policy or IAM policies\n\
    6. Enable resource-level access control\n7. Save changes\n\nSecurity Recommendations:\n\u2022 Use IAM roles instead of\
    \ access keys\n\u2022 Implement condition keys for additional security\n\u2022 Enable MFA for sensitive operations\n\u2022\
    \ Regularly audit access permissions\n\u2022 Use AWS Organizations SCPs for guardrails"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
- title: 'COSTEXPLORER costcategory: Billing Console Rbac Least Privilege'
  severity: high
  rule_id: aws.costexplorer.costcategory.billing_console_rbac_least_privilege
  for_each:
    discovery: aws.costexplorer.costcategorys
    as: costcategory
    item: costcategory
  conditions:
    var: costcategory.is_public
    op: equals
    value: false
  remediation: "Restrict public access for costexplorer costcategory:\n\n1. Open COSTEXPLORER console\n2. Select the costcategory\n\
    3. Go to Permissions/Access Control\n4. Review current permissions:\n   - Remove public access grants\n   - Remove wildcard\
    \ (*) principals\n   - Implement least privilege\n5. Update resource policy or IAM policies\n6. Enable resource-level\
    \ access control\n7. Save changes\n\nSecurity Recommendations:\n\u2022 Use IAM roles instead of access keys\n\u2022 Implement\
    \ condition keys for additional security\n\u2022 Enable MFA for sensitive operations\n\u2022 Regularly audit access permissions\n\
    \u2022 Use AWS Organizations SCPs for guardrails"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
- title: 'COSTEXPLORER anomalydetector: Alert Destinations Configured'
  severity: medium
  rule_id: aws.costexplorer.anomalydetector.alert_destinations_configured
  for_each:
    discovery: aws.costexplorer.anomalydetectors
    as: anomalydetector
    item: anomalydetector
  conditions:
    var: anomalydetector.monitoring_enabled
    op: equals
    value: true
  remediation: "Enable monitoring for costexplorer anomalydetector:\n\n1. Open CloudWatch console\n2. Create alarm for anomalydetector\n\
    3. Configure metrics to monitor\n4. Set alarm thresholds\n5. Configure SNS notifications\n6. Enable detailed monitoring\
    \ (if available)\n7. Create dashboard for visualization\n\nMonitoring Best Practices:\n\u2022 Monitor security-relevant\
    \ metrics\n\u2022 Set up automated alerting\n\u2022 Integrate with SIEM/SOC\n\u2022 Regular review of metrics\n\u2022\
    \ Implement automated remediation"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
- title: 'COSTEXPLORER costcategory: Costexplorer Cost Export Destinations Least Privilege'
  severity: high
  rule_id: aws.costexplorer.costcategory.costexplorer_cost_export_destinations_least_privilege
  for_each:
    discovery: aws.costexplorer.costcategorys
    as: costcategory
    item: costcategory
  conditions:
    var: costcategory.is_public
    op: equals
    value: false
  remediation: "Restrict public access for costexplorer costcategory:\n\n1. Open COSTEXPLORER console\n2. Select the costcategory\n\
    3. Go to Permissions/Access Control\n4. Review current permissions:\n   - Remove public access grants\n   - Remove wildcard\
    \ (*) principals\n   - Implement least privilege\n5. Update resource policy or IAM policies\n6. Enable resource-level\
    \ access control\n7. Save changes\n\nSecurity Recommendations:\n\u2022 Use IAM roles instead of access keys\n\u2022 Implement\
    \ condition keys for additional security\n\u2022 Enable MFA for sensitive operations\n\u2022 Regularly audit access permissions\n\
    \u2022 Use AWS Organizations SCPs for guardrails"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
- title: 'COSTEXPLORER costcategory: Costexplorer Cost Data Exports Private And Encrypted'
  severity: high
  rule_id: aws.costexplorer.costcategory.costexplorer_cost_data_exports_private_and_encrypted
  for_each:
    discovery: aws.costexplorer.costcategory_encryption
    as: costcategory
    item: costcategory
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
  remediation: "Enable encryption for costexplorer costcategory:\n\n1. Open COSTEXPLORER console\n2. Select the costcategory\n\
    3. Navigate to Properties/Configuration > Encryption\n4. Enable encryption\n5. Choose encryption key:\n   - AWS managed\
    \ key (default)\n   - Customer managed key (KMS) for enhanced control\n6. Save changes\n\nAWS CLI:\naws costexplorer modify-costcategory\
    \ --costcategory-id <id> --encrypted --kms-key-id <key-id>\n\nSecurity Best Practices:\n\u2022 Use customer-managed KMS\
    \ keys for sensitive data\n\u2022 Enable automatic key rotation\n\u2022 Implement proper key access policies\n\u2022 Audit\
    \ key usage regularly"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
