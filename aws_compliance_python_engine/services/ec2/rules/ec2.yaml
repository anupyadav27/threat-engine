version: 1.0
provider: aws
service: ec2
discovery:
  discovery_id: aws.ec2.instances
  calls:
    - client: ec2
      action: describe_instances
      paginate: true
  fields:
    - name: InstanceId
      save_as: instance_id
  emit:
    items_for:
      as: resource
      item: instance_id
checks:
  - title: Default Encryption Enabled
    severity: high
    rule_id: aws.ec2.volume_encryption.default_encryption_enabled
    assertion_id: crypto_data_protection.encryption_at_rest.default_encryption_enabled
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement default encryption enabled for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Customer Managed Keys Used Buckets
    severity: high
    rule_id: aws.ec2.volume_encryption.customer_managed_keys_used_buckets
    assertion_id: crypto_data_protection.encryption_at_rest.customer_managed_keys_used_buckets
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement customer managed keys used buckets for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Customer Managed Keys Used Databases
    severity: high
    rule_id: aws.ec2.volume_encryption.customer_managed_keys_used_databases
    assertion_id: crypto_data_protection.encryption_at_rest.customer_managed_keys_used_databases
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement customer managed keys used databases for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Customer Managed Keys Used Disks
    severity: high
    rule_id: aws.ec2.volume_encryption.customer_managed_keys_used_disks
    assertion_id: crypto_data_protection.encryption_at_rest.customer_managed_keys_used_disks
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement customer managed keys used disks for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Database Encryption Enabled
    severity: high
    rule_id: aws.ec2.volume_encryption.database_encryption_enabled
    assertion_id: crypto_data_protection.encryption_at_rest.database_encryption_enabled
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement database encryption enabled for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Volume Encryption Enabled
    severity: high
    rule_id: aws.ec2.volume_encryption.volume_encryption_enabled
    assertion_id: crypto_data_protection.encryption_at_rest.volume_encryption_enabled
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement volume encryption enabled for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Kms Configured
    severity: low
    rule_id: aws.ec2.kms_encryption.kms_configured
    assertion_id: crypto_data_protection.key_management.kms_configured
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement kms configured for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Key Policies Enforced
    severity: low
    rule_id: aws.ec2.kms_encryption.key_policies_enforced
    assertion_id: crypto_data_protection.key_management.key_policies_enforced
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement key policies enforced for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Deny All Default
    severity: low
    rule_id: aws.ec2.security_groups_deny_all_default.deny_all_default
    assertion_id: network_perimeter.firewall_rules.deny_all_default
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement deny all default for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Ssh Rdp Restricted
    severity: low
    rule_id: aws.ec2.security_groups_deny_all_default.ssh_rdp_restricted
    assertion_id: network_perimeter.firewall_rules.ssh_rdp_restricted
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement ssh rdp restricted for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Waf Enabled
    severity: low
    rule_id: aws.ec2.security_groups_deny_all_default.waf_enabled
    assertion_id: network_perimeter.firewall_rules.waf_enabled
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement waf enabled for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Waf Enabled At Edge
    severity: low
    rule_id: aws.ec2.security_groups_deny_all_default.waf_enabled_at_edge
    assertion_id: network_perimeter.firewall_rules.waf_enabled_at_edge
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement waf enabled at edge for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Egress Filtering Enabled
    severity: low
    rule_id: aws.ec2.security_groups_deny_all_default.egress_filtering_enabled
    assertion_id: network_perimeter.firewall_rules.egress_filtering_enabled
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement egress filtering enabled for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Baseline Configuration Applied
    severity: low
    rule_id: aws.ec2.os_hardening.baseline_configuration_applied
    assertion_id: compute_host_security.os_hardening.baseline_configuration_applied
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement baseline configuration applied for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Baseline Configuration Applied
    severity: low
    rule_id: aws.ec2.launch_template_hardening.baseline_configuration_applied
    assertion_id: compute_host_security.os_hardening.baseline_configuration_applied
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement baseline configuration applied for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Baseline Configuration Applied
    severity: low
    rule_id: aws.ec2.ami_hardening.baseline_configuration_applied
    assertion_id: compute_host_security.os_hardening.baseline_configuration_applied
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement baseline configuration applied for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Unnecessary Services Disabled
    severity: low
    rule_id: aws.ec2.os_hardening.unnecessary_services_disabled
    assertion_id: compute_host_security.os_hardening.unnecessary_services_disabled
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement unnecessary services disabled for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Unnecessary Services Disabled
    severity: low
    rule_id: aws.ec2.launch_template_hardening.unnecessary_services_disabled
    assertion_id: compute_host_security.os_hardening.unnecessary_services_disabled
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement unnecessary services disabled for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Unnecessary Services Disabled
    severity: low
    rule_id: aws.ec2.ami_hardening.unnecessary_services_disabled
    assertion_id: compute_host_security.os_hardening.unnecessary_services_disabled
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement unnecessary services disabled for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Antimalware Enabled
    severity: low
    rule_id: aws.ec2.endpoint_protection.antimalware_enabled
    assertion_id: compute_host_security.endpoint_protection.antimalware_enabled
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement antimalware enabled for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Intrusion Detection Enabled
    severity: low
    rule_id: aws.ec2.endpoint_protection.intrusion_detection_enabled
    assertion_id: compute_host_security.endpoint_protection.intrusion_detection_enabled
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement intrusion detection enabled for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Supported Versions Used
    severity: low
    rule_id: aws.ec2.version_management.supported_versions_used
    assertion_id: platform_surfaces_versions.version_management.supported_versions_used
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement supported versions used for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Version Monitoring Enabled
    severity: low
    rule_id: aws.ec2.version_management.version_monitoring_enabled
    assertion_id: platform_surfaces_versions.version_management.version_monitoring_enabled
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement version monitoring enabled for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Deprecation Notices Monitored
    severity: low
    rule_id: aws.ec2.deprecation_management.deprecation_notices_monitored
    assertion_id: platform_surfaces_versions.deprecation_mgmt.deprecation_notices_monitored
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement deprecation notices monitored for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
  - title: Migration Planning Enabled
    severity: low
    rule_id: aws.ec2.deprecation_management.migration_planning_enabled
    assertion_id: platform_surfaces_versions.deprecation_mgmt.migration_planning_enabled
    for_each:
      as: resource
      item: instance_id
    conditions:
      - field: resource.compliant
        operator: equals
        value: true
    remediation: "Implement migration planning enabled for ec2"
    references:
      - "https://docs.aws.amazon.com/ec2/"
