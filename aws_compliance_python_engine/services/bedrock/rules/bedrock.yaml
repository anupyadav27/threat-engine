version: '1.0'
provider: aws
service: bedrock
services:
  client: bedrock
  module: boto3.client
discovery:
- discovery_id: aws.bedrock.get_model_invocation_logging_configuration
  calls:
  - action: get_model_invocation_logging_configuration
    save_as: response
  emit:
    item:
      cloudWatchConfig: '{{ response.loggingConfig.cloudWatchConfig }}'
      s3Config: '{{ response.loggingConfig.s3Config }}'
      textDataDeliveryEnabled: '{{ response.loggingConfig.textDataDeliveryEnabled
        }}'
      imageDataDeliveryEnabled: '{{ response.loggingConfig.imageDataDeliveryEnabled
        }}'
      embeddingDataDeliveryEnabled: '{{ response.loggingConfig.embeddingDataDeliveryEnabled
        }}'
      videoDataDeliveryEnabled: '{{ response.loggingConfig.videoDataDeliveryEnabled
        }}'
- discovery_id: aws.bedrock.list_custom_model_deployments
  calls:
  - action: list_custom_model_deployments
    save_as: response
  emit:
    items_for: '{{ response.modelDeploymentSummaries }}'
    as: resource
    item:
      customModelDeploymentArn: '{{ resource.customModelDeploymentArn }}'
      customModelDeploymentName: '{{ resource.customModelDeploymentName }}'
      modelArn: '{{ resource.modelArn }}'
      createdAt: '{{ resource.createdAt }}'
      status: '{{ resource.status }}'
      lastUpdatedAt: '{{ resource.lastUpdatedAt }}'
      failureMessage: '{{ resource.failureMessage }}'
- discovery_id: aws.bedrock.list_model_copy_jobs
  calls:
  - action: list_model_copy_jobs
    save_as: response
  emit:
    items_for: '{{ response.modelCopyJobSummaries }}'
    as: resource
    item:
      jobArn: '{{ resource.jobArn }}'
      status: '{{ resource.status }}'
      creationTime: '{{ resource.creationTime }}'
      targetModelArn: '{{ resource.targetModelArn }}'
      targetModelName: '{{ resource.targetModelName }}'
      sourceAccountId: '{{ resource.sourceAccountId }}'
      sourceModelArn: '{{ resource.sourceModelArn }}'
      targetModelKmsKeyArn: '{{ resource.targetModelKmsKeyArn }}'
      targetModelTags: '{{ resource.targetModelTags }}'
      failureMessage: '{{ resource.failureMessage }}'
      sourceModelName: '{{ resource.sourceModelName }}'
- discovery_id: aws.bedrock.batch_delete_evaluation_job
  calls:
  - action: batch_delete_evaluation_job
    save_as: response
  emit:
    item:
      jobIdentifier: '{{ response.errors.jobIdentifier }}'
      code: '{{ response.errors.code }}'
      message: '{{ response.errors.message }}'
- discovery_id: aws.bedrock.get_guardrail
  calls:
  - action: get_guardrail
    save_as: response
- discovery_id: aws.bedrock.get_model_customization_job
  calls:
  - action: get_model_customization_job
    save_as: response
    params:
      jobIdentifier: '{{ item.jobIdentifier }}'
  on_error: continue
  for_each: aws.bedrock.batch_delete_evaluation_job
  emit:
    item:
      validationLoss: '{{ response.validationMetrics.validationLoss }}'
checks:
- rule_id: aws.bedrock.model.bedrock_artifact_encrypted_at_rest
  for_each: aws.bedrock.list_custom_model_deployments
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.bedrock.model.bedrock_kms_cmk_used_configured
  for_each: aws.bedrock.list_model_copy_jobs
  conditions:
    var: item.targetModelKmsKeyArn
    op: exists
- rule_id: aws.bedrock.model.bedrock_image_scan_passed_configured
  for_each: aws.bedrock.get_model_invocation_logging_configuration
  conditions:
    var: item.imageDataDeliveryEnabled
    op: equals
    value: true
- rule_id: aws.bedrock.model.kms_encryption_enabled
  for_each: aws.bedrock.list_model_copy_jobs
  conditions:
    var: item.targetModelKmsKeyArn
    op: exists
