version: '1.0'
provider: aws
service: bedrock
services:
  client: bedrock
  module: boto3.client
discovery:
- discovery_id: aws.bedrock.get_model_invocation_logging_configuration
  calls:
  - action: get_model_invocation_logging_configuration
    save_as: response
  emit:
    item:
      cloudWatchConfig: '{{ response.loggingConfig.cloudWatchConfig }}'
      s3Config: '{{ response.loggingConfig.s3Config }}'
      textDataDeliveryEnabled: '{{ response.loggingConfig.textDataDeliveryEnabled
        }}'
      imageDataDeliveryEnabled: '{{ response.loggingConfig.imageDataDeliveryEnabled
        }}'
      embeddingDataDeliveryEnabled: '{{ response.loggingConfig.embeddingDataDeliveryEnabled
        }}'
      videoDataDeliveryEnabled: '{{ response.loggingConfig.videoDataDeliveryEnabled
        }}'
      loggingConfig: '{{ resource.loggingConfig }}'
- discovery_id: aws.bedrock.get_custom_model
  calls:
  - action: get_custom_model
    save_as: response
  emit:
    item:
      validationLoss: '{{ response.validationMetrics.validationLoss }}'
      modelKmsKeyArn: '{{ resource.modelKmsKeyArn }}'
- discovery_id: aws.bedrock.list_provisioned_model_throughputs
  calls:
  - action: list_provisioned_model_throughputs
    save_as: response
  emit:
    items_for: '{{ response.provisionedModelSummaries }}'
    as: resource
    item:
      provisionedModelName: '{{ resource.provisionedModelName }}'
      provisionedModelArn: '{{ resource.provisionedModelArn }}'
      modelArn: '{{ resource.modelArn }}'
      desiredModelArn: '{{ resource.desiredModelArn }}'
      foundationModelArn: '{{ resource.foundationModelArn }}'
      modelUnits: '{{ resource.modelUnits }}'
      desiredModelUnits: '{{ resource.desiredModelUnits }}'
      status: '{{ resource.status }}'
      commitmentDuration: '{{ resource.commitmentDuration }}'
      commitmentExpirationTime: '{{ resource.commitmentExpirationTime }}'
      creationTime: '{{ resource.creationTime }}'
      lastModifiedTime: '{{ resource.lastModifiedTime }}'
checks:
- rule_id: aws.bedrock.resource.model_invocation_logging_enabled
  for_each: aws.bedrock.get_model_invocation_logging_configuration
  conditions:
    var: item.loggingConfig
    op: not_equals
    value: 'null'
- rule_id: aws.bedrock.model.bedrock_artifact_encrypted_at_rest
  for_each: aws.bedrock.get_custom_model
  conditions:
    var: item.modelKmsKeyArn
    op: not_equals
    value: 'null'
- rule_id: aws.bedrock.model.bedrock_package_approved_configured
  for_each: aws.bedrock.list_provisioned_model_throughputs
  conditions:
    var: item.provisionedModelArn
    op: exists
- rule_id: aws.bedrock.model.execution_role_least_privilege
  for_each: aws.bedrock.list_provisioned_model_throughputs
  conditions:
    var: item.provisionedModelArn
    op: not_equals
    value: 'null'
- rule_id: aws.bedrock.model.bedrock_kms_cmk_used_configured
  for_each: aws.bedrock.get_custom_model
  conditions:
    var: item.modelKmsKeyArn
    op: not_equals
    value: 'null'
- rule_id: aws.bedrock.model.bedrock_image_scan_passed_configured
  for_each: aws.bedrock.get_custom_model
  conditions:
    var: item.modelKmsKeyArn
    op: not_equals
    value: 'null'
- rule_id: aws.bedrock.resource.model_invocation_logs_encryption_enabled
  for_each: aws.bedrock.get_custom_model
  conditions:
    var: item.modelKmsKeyArn
    op: not_equals
    value: 'null'
- rule_id: aws.bedrock.model.kms_encryption_enabled
  for_each: aws.bedrock.get_custom_model
  conditions:
    var: item.modelKmsKeyArn
    op: not_equals
    value: 'null'
