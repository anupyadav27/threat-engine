version: '1.0'
provider: aws
service: efs
discovery:
- discovery_id: aws.efs.describe_file_systems
  calls:
  - action: describe_file_systems
    save_as: describe_file_systems_response
  emit:
    items_for: '{{ describe_file_systems_response.FileSystems }}'
    as: resource
    item:
      owner_id: '{{ resource.OwnerId }}'
      creation_token: '{{ resource.CreationToken }}'
      file_system_id: '{{ resource.FileSystemId }}'
      file_system_arn: '{{ resource.FileSystemArn }}'
      creation_time: '{{ resource.CreationTime }}'
      life_cycle_state: '{{ resource.LifeCycleState }}'
      name: '{{ resource.Name }}'
      number_of_mount_targets: '{{ resource.NumberOfMountTargets }}'
      size_in_bytes: '{{ resource.SizeInBytes }}'
      performance_mode: '{{ resource.PerformanceMode }}'
- discovery_id: aws.efs.describe_access_points
  calls:
  - action: describe_access_points
    save_as: describe_access_points_response
  emit:
    items_for: '{{ describe_access_points_response.AccessPoints }}'
    as: resource
    item:
      client_token: '{{ resource.ClientToken }}'
      name: '{{ resource.Name }}'
      tags: '{{ resource.Tags }}'
      access_point_id: '{{ resource.AccessPointId }}'
      access_point_arn: '{{ resource.AccessPointArn }}'
      file_system_id: '{{ resource.FileSystemId }}'
      posix_user: '{{ resource.PosixUser }}'
      root_directory: '{{ resource.RootDirectory }}'
      owner_id: '{{ resource.OwnerId }}'
      life_cycle_state: '{{ resource.LifeCycleState }}'
- discovery_id: aws.efs.describe_mount_targets
  calls:
  - action: describe_mount_targets
    save_as: describe_mount_targets_response
  emit:
    items_for: '{{ describe_mount_targets_response.MountTargets }}'
    as: resource
    item:
      owner_id: '{{ resource.OwnerId }}'
      mount_target_id: '{{ resource.MountTargetId }}'
      file_system_id: '{{ resource.FileSystemId }}'
      subnet_id: '{{ resource.SubnetId }}'
      life_cycle_state: '{{ resource.LifeCycleState }}'
      ip_address: '{{ resource.IpAddress }}'
      ipv6_address: '{{ resource.Ipv6Address }}'
      network_interface_id: '{{ resource.NetworkInterfaceId }}'
      availability_zone_id: '{{ resource.AvailabilityZoneId }}'
      availability_zone_name: '{{ resource.AvailabilityZoneName }}'
- discovery_id: aws.efs.create_replication_configuration
  calls:
  - action: create_replication_configuration
    save_as: create_replication_configuration_response
    params:
      SourceFileSystemId: '{{ item.file_system_id }}'
      Destinations: '{{ item.id }}'
    on_error: continue
  for_each: aws.efs.describe_file_systems
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      status: '{{ create_replication_configuration_response.Destinations.Status }}'
      file_system_id: '{{ create_replication_configuration_response.Destinations.FileSystemId
        }}'
      region: '{{ create_replication_configuration_response.Destinations.Region }}'
      last_replicated_timestamp: '{{ create_replication_configuration_response.Destinations.LastReplicatedTimestamp
        }}'
      owner_id: '{{ create_replication_configuration_response.Destinations.OwnerId
        }}'
checks:
- rule_id: aws.efs.not_publicly_accessible.not_publicly_accessible_configured
  for_each: aws.efs.describe_file_systems
  conditions:
    var: item.number_of_mount_targets
    op: equals
    value: 0
- rule_id: aws.efs.user.identity_and_root_directory_enforced
  for_each: aws.efs.describe_access_points
  conditions:
    all:
    - var: item.posix_user
      op: exists
    - var: item.root_directory
      op: exists
- rule_id: aws.efs.filesystem.encryption_at_rest_enabled
  for_each: aws.efs.describe_file_systems
  conditions:
    var: item.encrypted
    op: equals
    value: true
- rule_id: aws.efs.have.backup_enabled
  for_each: aws.efs.create_replication_configuration
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.efs.filesystem.snapshots_enabled
  for_each: aws.efs.create_replication_configuration
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.efs.resource.backup_enabled
  for_each: aws.efs.create_replication_configuration
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.efs.resource.multi_az_enabled
  for_each: aws.efs.describe_file_systems
  conditions:
    var: item.availability_zone_name
    op: exists
- rule_id: aws.efs.resource.encryption_at_rest_enabled
  for_each: aws.efs.describe_file_systems
  conditions:
    var: item.encrypted
    op: equals
    value: true
- rule_id: aws.efs.encryption.at_rest_enabled
  for_each: aws.efs.describe_file_systems
  conditions:
    var: item.encrypted
    op: equals
    value: true
- rule_id: aws.efs.filesystem.kms_key_policy_least_privilege
  for_each: aws.efs.describe_file_systems
  conditions:
    all:
    - var: item.encrypted
      op: equals
      value: true
    - var: item.kms_key_id
      op: exists
- rule_id: aws.efs.filesystem.private_network_only_configured
  for_each: aws.efs.describe_mount_targets
  conditions:
    all:
    - var: item.subnet_id
      op: exists
    - var: item.vpc_id
      op: exists
