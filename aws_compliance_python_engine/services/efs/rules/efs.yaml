version: '1.0'
provider: aws
service: efs
services:
  client: efs
  module: boto3.client
discovery:
- discovery_id: aws.efs.describe_file_systems
  calls:
  - action: describe_file_systems
    save_as: response
  emit:
    item:
      OwnerId: '{{ response.FileSystems.OwnerId }}'
      CreationToken: '{{ response.FileSystems.CreationToken }}'
      FileSystemId: '{{ response.FileSystems.FileSystemId }}'
      FileSystemArn: '{{ response.FileSystems.FileSystemArn }}'
      CreationTime: '{{ response.FileSystems.CreationTime }}'
      LifeCycleState: '{{ response.FileSystems.LifeCycleState }}'
      Name: '{{ response.FileSystems.Name }}'
      NumberOfMountTargets: '{{ response.FileSystems.NumberOfMountTargets }}'
      SizeInBytes: '{{ response.FileSystems.SizeInBytes }}'
      PerformanceMode: '{{ response.FileSystems.PerformanceMode }}'
      Encrypted: '{{ response.FileSystems.Encrypted }}'
      KmsKeyId: '{{ response.FileSystems.KmsKeyId }}'
      ThroughputMode: '{{ response.FileSystems.ThroughputMode }}'
      ProvisionedThroughputInMibps: '{{ response.FileSystems.ProvisionedThroughputInMibps
        }}'
      AvailabilityZoneName: '{{ response.FileSystems.AvailabilityZoneName }}'
      AvailabilityZoneId: '{{ response.FileSystems.AvailabilityZoneId }}'
      Tags: '{{ response.FileSystems.Tags }}'
      FileSystemProtection: '{{ response.FileSystems.FileSystemProtection }}'
- discovery_id: aws.efs.describe_access_points
  calls:
  - action: describe_access_points
    save_as: response
  emit:
    item:
      ClientToken: '{{ response.AccessPoints.ClientToken }}'
      Name: '{{ response.AccessPoints.Name }}'
      Tags: '{{ response.AccessPoints.Tags }}'
      AccessPointId: '{{ response.AccessPoints.AccessPointId }}'
      AccessPointArn: '{{ response.AccessPoints.AccessPointArn }}'
      FileSystemId: '{{ response.AccessPoints.FileSystemId }}'
      PosixUser: '{{ response.AccessPoints.PosixUser }}'
      RootDirectory: '{{ response.AccessPoints.RootDirectory }}'
      OwnerId: '{{ response.AccessPoints.OwnerId }}'
      LifeCycleState: '{{ response.AccessPoints.LifeCycleState }}'
- discovery_id: aws.efs.describe_backup_policy
  calls:
  - action: describe_backup_policy
    save_as: response
  emit:
    item:
      Status: '{{ response.BackupPolicy.Status }}'
      BackupPolicy: '{{ resource.BackupPolicy }}'
- discovery_id: aws.efs.describe_mount_targets
  calls:
  - action: describe_mount_targets
    save_as: response
  emit:
    item:
      OwnerId: '{{ response.MountTargets.OwnerId }}'
      MountTargetId: '{{ response.MountTargets.MountTargetId }}'
      FileSystemId: '{{ response.MountTargets.FileSystemId }}'
      SubnetId: '{{ response.MountTargets.SubnetId }}'
      LifeCycleState: '{{ response.MountTargets.LifeCycleState }}'
      IpAddress: '{{ response.MountTargets.IpAddress }}'
      Ipv6Address: '{{ response.MountTargets.Ipv6Address }}'
      NetworkInterfaceId: '{{ response.MountTargets.NetworkInterfaceId }}'
      AvailabilityZoneId: '{{ response.MountTargets.AvailabilityZoneId }}'
      AvailabilityZoneName: '{{ response.MountTargets.AvailabilityZoneName }}'
      VpcId: '{{ response.MountTargets.VpcId }}'
checks:
- rule_id: aws.efs.not_publicly_accessible.not_publicly_accessible_configured
  for_each: aws.efs.describe_file_systems
  conditions:
    var: item.FileSystemArn
    op: not_equals
    value: 'null'
- rule_id: aws.efs.user.identity_and_root_directory_enforced
  for_each: aws.efs.describe_access_points
  conditions:
    var: item.RootDirectory
    op: not_equals
    value: 'null'
- rule_id: aws.efs.filesystem.encryption_at_rest_enabled
  for_each: aws.efs.describe_file_systems
  conditions:
    var: item.Encrypted
    op: equals
    value: 'true'
- rule_id: aws.efs.have.backup_enabled
  for_each: aws.efs.describe_backup_policy
  conditions:
    var: item.BackupPolicy
    op: not_equals
    value: 'null'
- rule_id: aws.efs.filesystem.snapshots_enabled
  for_each: aws.efs.describe_file_systems
  conditions:
    var: item.FileSystemProtection
    op: equals
    value: ENABLED
- rule_id: aws.efs.resource.backup_enabled
  for_each: aws.efs.describe_backup_policy
  conditions:
    var: item.BackupPolicy
    op: not_equals
    value: 'null'
- rule_id: aws.efs.resource.multi_az_enabled
  for_each: aws.efs.describe_file_systems
  conditions:
    var: item.NumberOfMountTargets
    op: greater_than
    value: 1
- rule_id: aws.efs.resource.encryption_at_rest_enabled
  for_each: aws.efs.describe_file_systems
  conditions:
    var: item.Encrypted
    op: equals
    value: 'true'
- rule_id: aws.efs.encryption.at_rest_enabled
  for_each: aws.efs.describe_file_systems
  conditions:
    var: item.Encrypted
    op: equals
    value: 'true'
- rule_id: aws.efs.filesystem.kms_key_policy_least_privilege
  for_each: aws.efs.describe_file_systems
  conditions:
    var: item.Encrypted
    op: equals
    value: 'true'
- rule_id: aws.efs.filesystem.private_network_only_configured
  for_each: aws.efs.describe_mount_targets
  conditions:
    var: item.VpcId
    op: not_equals
    value: 'null'
