version: '1.0'
provider: aws
service: efs
services:
  client: efs
  module: boto3.client
discovery:
- discovery_id: aws.efs.describe_file_systems
  calls:
  - action: describe_file_systems
    save_as: response
  emit:
    item:
      OwnerId: '{{ response.FileSystems.OwnerId }}'
      CreationToken: '{{ response.FileSystems.CreationToken }}'
      FileSystemId: '{{ response.FileSystems.FileSystemId }}'
      FileSystemArn: '{{ response.FileSystems.FileSystemArn }}'
      CreationTime: '{{ response.FileSystems.CreationTime }}'
      LifeCycleState: '{{ response.FileSystems.LifeCycleState }}'
      Name: '{{ response.FileSystems.Name }}'
      NumberOfMountTargets: '{{ response.FileSystems.NumberOfMountTargets }}'
      SizeInBytes: '{{ response.FileSystems.SizeInBytes }}'
      PerformanceMode: '{{ response.FileSystems.PerformanceMode }}'
      Encrypted: '{{ response.FileSystems.Encrypted }}'
      KmsKeyId: '{{ response.FileSystems.KmsKeyId }}'
      ThroughputMode: '{{ response.FileSystems.ThroughputMode }}'
      ProvisionedThroughputInMibps: '{{ response.FileSystems.ProvisionedThroughputInMibps
        }}'
      AvailabilityZoneName: '{{ response.FileSystems.AvailabilityZoneName }}'
      AvailabilityZoneId: '{{ response.FileSystems.AvailabilityZoneId }}'
      Tags: '{{ response.FileSystems.Tags }}'
      FileSystemProtection: '{{ response.FileSystems.FileSystemProtection }}'
- discovery_id: aws.efs.describe_replication_configurations
  calls:
  - action: describe_replication_configurations
    save_as: response
  emit:
    item:
      SourceFileSystemId: '{{ response.Replications.SourceFileSystemId }}'
      SourceFileSystemRegion: '{{ response.Replications.SourceFileSystemRegion }}'
      SourceFileSystemArn: '{{ response.Replications.SourceFileSystemArn }}'
      OriginalSourceFileSystemArn: '{{ response.Replications.OriginalSourceFileSystemArn
        }}'
      CreationTime: '{{ response.Replications.CreationTime }}'
      Destinations: '{{ response.Replications.Destinations }}'
      SourceFileSystemOwnerId: '{{ response.Replications.SourceFileSystemOwnerId }}'
- discovery_id: aws.efs.create_replication_configuration
  calls:
  - action: create_replication_configuration
    save_as: response
    params:
      SourceFileSystemId: '{{ item.SourceFileSystemId }}'
      Destinations: '{{ item.Destinations }}'
  on_error: continue
  for_each: aws.efs.describe_replication_configurations
  emit:
    item:
      Status: '{{ response.Destinations.Status }}'
      FileSystemId: '{{ response.Destinations.FileSystemId }}'
      Region: '{{ response.Destinations.Region }}'
      LastReplicatedTimestamp: '{{ response.Destinations.LastReplicatedTimestamp }}'
      OwnerId: '{{ response.Destinations.OwnerId }}'
      StatusMessage: '{{ response.Destinations.StatusMessage }}'
      RoleArn: '{{ response.Destinations.RoleArn }}'
checks:
- rule_id: aws.efs.not_publicly_accessible.not_publicly_accessible_configured
  for_each: aws.efs.describe_file_systems
  conditions:
    var: item.NumberOfMountTargets
    op: equals
    value: 0
- rule_id: aws.efs.filesystem.encryption_at_rest_enabled
  for_each: aws.efs.describe_file_systems
  conditions:
    var: item.Encrypted
    op: equals
    value: true
- rule_id: aws.efs.have.backup_enabled
  for_each: aws.efs.create_replication_configuration
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.efs.filesystem.snapshots_enabled
  for_each: aws.efs.create_replication_configuration
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.efs.resource.backup_enabled
  for_each: aws.efs.create_replication_configuration
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.efs.resource.multi_az_enabled
  for_each: aws.efs.describe_file_systems
  conditions:
    var: item.Name
    op: exists
- rule_id: aws.efs.resource.encryption_at_rest_enabled
  for_each: aws.efs.describe_file_systems
  conditions:
    var: item.Encrypted
    op: equals
    value: true
- rule_id: aws.efs.encryption.at_rest_enabled
  for_each: aws.efs.describe_file_systems
  conditions:
    var: item.Encrypted
    op: equals
    value: true
