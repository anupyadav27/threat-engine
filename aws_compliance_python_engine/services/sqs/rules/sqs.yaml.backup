version: '1.0'
provider: aws
service: sqs
discovery:
- discovery_id: aws.sqs.list_message_move_tasks
  calls:
  - action: list_message_move_tasks
    save_as: list_message_move_tasks_response
    params:
      SourceArn: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.sqs.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      task_handle: '{{ list_message_move_tasks_response.Results.TaskHandle }}'
      status: '{{ list_message_move_tasks_response.Results.Status }}'
      source_arn: '{{ list_message_move_tasks_response.Results.SourceArn }}'
      destination_arn: '{{ list_message_move_tasks_response.Results.DestinationArn
        }}'
      max_number_of_messages_per_second: '{{ list_message_move_tasks_response.Results.MaxNumberOfMessagesPerSecond
        }}'
- discovery_id: aws.sqs.receive_message
  calls:
  - action: receive_message
    save_as: receive_message_response
    params:
      QueueUrl: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.sqs.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      message_id: '{{ receive_message_response.Messages.MessageId }}'
      receipt_handle: '{{ receive_message_response.Messages.ReceiptHandle }}'
      md5_of_body: '{{ receive_message_response.Messages.MD5OfBody }}'
      body: '{{ receive_message_response.Messages.Body }}'
      attributes: '{{ receive_message_response.Messages.Attributes }}'
checks:
- rule_id: aws.sqs.queue.private_network_only_if_supported
  for_each: aws.sqs.list_message_move_tasks
  conditions:
    var: item.status
    op: equals
    value: ACTIVE
- rule_id: aws.sqs.queue.cross_account_send_receive_restricted
  for_each: aws.sqs.list_message_move_tasks
  conditions:
    all:
    - var: item.source_arn
      op: exists
    - var: item.destination_arn
      op: exists
- rule_id: aws.sqs.queues_not_publicly_accessible.queues_not_publicly_accessible_configured
  for_each: aws.sqs.receive_message
  conditions:
    var: item.attributes
    op: contains
    value: Policy
- rule_id: aws.sqs.queue.auth_required
  for_each: aws.sqs.receive_message
  conditions:
    var: item.message_attributes
    op: exists
- rule_id: aws.sqs.resource.queues_server_side_encryption_enabled
  for_each: aws.sqs.receive_message
  conditions:
    var: item.attributes
    op: contains
    value: SqsManagedSseEnabled
