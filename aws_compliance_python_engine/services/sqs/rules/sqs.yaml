version: '1.0'
provider: aws
service: sqs
discovery:
- discovery_id: aws.sqs.queues_not_publicly_accessibles
  calls:
  - client: sqs
    action: list_queues
    save_as: queues_not_publicly_accessible_list
    on_error: continue
    fields:
    - QueueUrls
  emit:
    items_for: queues_not_publicly_accessible_list[]
    as: queues_not_publicly_accessible
    item:
      id: '{{ queues_not_publicly_accessible.QueueUrl }}'
      name: '{{ queues_not_publicly_accessible.QueueUrl }}'
- discovery_id: aws.sqs.queues_not_publicly_accessible_encryption
  for_each: aws.sqs.queues_not_publicly_accessibles
  calls:
  - client: sqs
    action: list_queues
    params:
      Queues_not_publicly_accessibleId: '{{ item.id }}'
    save_as: encryption
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      encryption_enabled: '{{ encryption.Encrypted if encryption.Encrypted is defined
        else false }}'
- discovery_id: aws.sqs.queues
  for_each: aws.sqs.queue
  calls:
  - client: sqs
    action: list_queues
    save_as: queues
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.sqs.resource_encryption
  calls:
  - client: sqs
    action: list_dead_letter_source_queues
    save_as: resource_encryption
    on_error: continue
  emit:
    items_for: resource_encryption[]
    as: resource_encryption
    item:
      id: '{{ resource_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.sqs.queue_encryption
  calls:
  - client: sqs
    action: list_dead_letter_source_queues
    save_as: queue_encryption
    on_error: continue
  emit:
    items_for: queue_encryption[]
    as: queue_encryption
    item:
      id: '{{ queue_encryption.Id }}'
      compliant: '{{ true }}'
checks:
- title: 'SQS queue: Private Network Only If Supported'
  severity: high
  rule_id: aws.sqs.queue.private_network_only_if_supported
  for_each:
    discovery: aws.sqs.queues
    as: queue
    item: queue
  conditions:
    var: queue.is_public
    op: equals
    value: false
- title: 'SQS queue: Cross Account Send Receive Restricted'
  severity: medium
  rule_id: aws.sqs.queue.cross_account_send_receive_restricted
  for_each:
    discovery: aws.sqs.queues
    as: queue
    item: queue
  conditions:
    var: queue.compliant
    op: equals
    value: true
- title: 'SQS queues not publicly accessible: Queues Not Publicly Accessible Configured'
  severity: high
  rule_id: aws.sqs.queues_not_publicly_accessible.queues_not_publicly_accessible_configured
  for_each:
    discovery: aws.sqs.queues_not_publicly_accessibles
    as: queues_not_publicly_accessible
    item: queues_not_publicly_accessible
  conditions:
    var: queues_not_publicly_accessible.is_public
    op: equals
    value: false
- title: 'SQS queue: Encryption At Rest Enabled'
  severity: high
  rule_id: aws.sqs.queue.encryption_at_rest_enabled
  for_each:
    discovery: aws.sqs.queue_encryption
    as: queue
    item: queue
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'SQS queue: Auth Required'
  severity: medium
  rule_id: aws.sqs.queue.auth_required
  for_each:
    discovery: aws.sqs.queues
    as: queue
    item: queue
  conditions:
    var: queue.compliant
    op: equals
    value: true
- title: 'SQS resource: Queues Server Side Encryption Enabled'
  severity: high
  rule_id: aws.sqs.resource.queues_server_side_encryption_enabled
  for_each:
    discovery: aws.sqs.resource_encryption
    as: resource
    item: resource
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
