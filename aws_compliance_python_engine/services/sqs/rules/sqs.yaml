version: '1.0'
provider: aws
service: sqs
services:
  client: sqs
  module: boto3.client
discovery:
- discovery_id: aws.sqs.get_queue_url
  calls:
  - action: get_queue_url
    save_as: response
- discovery_id: aws.sqs.list_message_move_tasks
  calls:
  - action: list_message_move_tasks
    save_as: response
  emit:
    items_for: '{{ response.Results }}'
    as: resource
    item:
      TaskHandle: '{{ resource.TaskHandle }}'
      Status: '{{ resource.Status }}'
      SourceArn: '{{ resource.SourceArn }}'
      DestinationArn: '{{ resource.DestinationArn }}'
      MaxNumberOfMessagesPerSecond: '{{ resource.MaxNumberOfMessagesPerSecond }}'
      ApproximateNumberOfMessagesMoved: '{{ resource.ApproximateNumberOfMessagesMoved
        }}'
      ApproximateNumberOfMessagesToMove: '{{ resource.ApproximateNumberOfMessagesToMove
        }}'
      FailureReason: '{{ resource.FailureReason }}'
      StartedTimestamp: '{{ resource.StartedTimestamp }}'
- discovery_id: aws.sqs.receive_message
  calls:
  - action: receive_message
    save_as: response
    params:
      QueueUrl: '{{ item.QueueUrl }}'
  on_error: continue
  for_each: aws.sqs.get_queue_url
  emit:
    item:
      MessageId: '{{ response.Messages.MessageId }}'
      ReceiptHandle: '{{ response.Messages.ReceiptHandle }}'
      MD5OfBody: '{{ response.Messages.MD5OfBody }}'
      Body: '{{ response.Messages.Body }}'
      Attributes: '{{ response.Messages.Attributes }}'
      MD5OfMessageAttributes: '{{ response.Messages.MD5OfMessageAttributes }}'
      MessageAttributes: '{{ response.Messages.MessageAttributes }}'
checks:
- rule_id: aws.sqs.queue.private_network_only_if_supported
  for_each: aws.sqs.list_message_move_tasks
  conditions:
    var: item.Status
    op: equals
    value: ACTIVE
- rule_id: aws.sqs.queues_not_publicly_accessible.queues_not_publicly_accessible_configured
  for_each: aws.sqs.receive_message
  conditions:
    var: item.Attributes
    op: contains
    value: Policy
- rule_id: aws.sqs.queue.auth_required
  for_each: aws.sqs.receive_message
  conditions:
    var: item.Attributes
    op: exists
- rule_id: aws.sqs.resource.queues_server_side_encryption_enabled
  for_each: aws.sqs.receive_message
  conditions:
    var: item.Attributes
    op: contains
    value: SqsManagedSseEnabled
