version: '1.0'
provider: aws
service: codeartifact
discovery:
- discovery_id: aws.codeartifact.associate_external_connection
  calls:
  - action: associate_external_connection
    save_as: associate_external_connection_response
    params:
      domain: '{{ item.FIELD_NAME }}'
      repository: '{{ item.FIELD_NAME }}'
      externalConnection: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.codeartifact.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      name: '{{ associate_external_connection_response.repository.name }}'
      administrator_account: '{{ associate_external_connection_response.repository.administratorAccount
        }}'
      domain_name: '{{ associate_external_connection_response.repository.domainName
        }}'
      domain_owner: '{{ associate_external_connection_response.repository.domainOwner
        }}'
      arn: '{{ associate_external_connection_response.repository.arn }}'
checks:
- rule_id: aws.codeartifact.resource.packages_external_public_publishing_disabled
  for_each: aws.codeartifact.associate_external_connection
  conditions:
    var: item.external_connections
    op: equals
    value: []
