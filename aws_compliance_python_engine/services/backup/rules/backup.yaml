version: '1.0'
provider: aws
service: backup
services:
  client: backup
  module: boto3.client
discovery:
- discovery_id: aws.backup.list_backup_job_summaries
  calls:
  - action: list_backup_job_summaries
    save_as: response
  emit:
    items_for: '{{ response.BackupJobSummaries }}'
    as: resource
    item:
      Region: '{{ resource.Region }}'
      AccountId: '{{ resource.AccountId }}'
      State: '{{ resource.State }}'
      ResourceType: '{{ resource.ResourceType }}'
      MessageCategory: '{{ resource.MessageCategory }}'
      Count: '{{ resource.Count }}'
      StartTime: '{{ resource.StartTime }}'
      EndTime: '{{ resource.EndTime }}'
- discovery_id: aws.backup.list_backup_jobs
  calls:
  - action: list_backup_jobs
    save_as: response
  emit:
    items_for: '{{ response.BackupJobs }}'
    as: resource
    item:
      AccountId: '{{ resource.AccountId }}'
      BackupJobId: '{{ resource.BackupJobId }}'
      BackupVaultName: '{{ resource.BackupVaultName }}'
      BackupVaultArn: '{{ resource.BackupVaultArn }}'
      VaultType: '{{ resource.VaultType }}'
      VaultLockState: '{{ resource.VaultLockState }}'
      RecoveryPointArn: '{{ resource.RecoveryPointArn }}'
      RecoveryPointLifecycle: '{{ resource.RecoveryPointLifecycle }}'
      EncryptionKeyArn: '{{ resource.EncryptionKeyArn }}'
      IsEncrypted: '{{ resource.IsEncrypted }}'
      ResourceArn: '{{ resource.ResourceArn }}'
      CreationDate: '{{ resource.CreationDate }}'
      CompletionDate: '{{ resource.CompletionDate }}'
      State: '{{ resource.State }}'
      StatusMessage: '{{ resource.StatusMessage }}'
      PercentDone: '{{ resource.PercentDone }}'
      BackupSizeInBytes: '{{ resource.BackupSizeInBytes }}'
      IamRoleArn: '{{ resource.IamRoleArn }}'
      CreatedBy: '{{ resource.CreatedBy }}'
      ExpectedCompletionDate: '{{ resource.ExpectedCompletionDate }}'
      StartBy: '{{ resource.StartBy }}'
      ResourceType: '{{ resource.ResourceType }}'
      BytesTransferred: '{{ resource.BytesTransferred }}'
      BackupOptions: '{{ resource.BackupOptions }}'
      BackupType: '{{ resource.BackupType }}'
      ParentJobId: '{{ resource.ParentJobId }}'
      IsParent: '{{ resource.IsParent }}'
      ResourceName: '{{ resource.ResourceName }}'
      InitiationDate: '{{ resource.InitiationDate }}'
      MessageCategory: '{{ resource.MessageCategory }}'
- discovery_id: aws.backup.list_backup_plans
  calls:
  - action: list_backup_plans
    save_as: response
  emit:
    items_for: '{{ response.BackupPlansList }}'
    as: resource
    item:
      BackupPlanArn: '{{ resource.BackupPlanArn }}'
      BackupPlanId: '{{ resource.BackupPlanId }}'
      CreationDate: '{{ resource.CreationDate }}'
      DeletionDate: '{{ resource.DeletionDate }}'
      VersionId: '{{ resource.VersionId }}'
      BackupPlanName: '{{ resource.BackupPlanName }}'
      CreatorRequestId: '{{ resource.CreatorRequestId }}'
      LastExecutionDate: '{{ resource.LastExecutionDate }}'
      AdvancedBackupSettings: '{{ resource.AdvancedBackupSettings }}'
- discovery_id: aws.backup.list_backup_vaults
  calls:
  - action: list_backup_vaults
    save_as: response
  emit:
    items_for: '{{ response.BackupVaultList }}'
    as: resource
    item:
      BackupVaultName: '{{ resource.BackupVaultName }}'
      BackupVaultArn: '{{ resource.BackupVaultArn }}'
      VaultType: '{{ resource.VaultType }}'
      VaultState: '{{ resource.VaultState }}'
      CreationDate: '{{ resource.CreationDate }}'
      EncryptionKeyArn: '{{ resource.EncryptionKeyArn }}'
      CreatorRequestId: '{{ resource.CreatorRequestId }}'
      NumberOfRecoveryPoints: '{{ resource.NumberOfRecoveryPoints }}'
      Locked: '{{ resource.Locked }}'
      MinRetentionDays: '{{ resource.MinRetentionDays }}'
      MaxRetentionDays: '{{ resource.MaxRetentionDays }}'
      LockDate: '{{ resource.LockDate }}'
      EncryptionKeyType: '{{ resource.EncryptionKeyType }}'
- discovery_id: aws.backup.list_report_jobs
  calls:
  - action: list_report_jobs
    save_as: response
  emit:
    items_for: '{{ response.ReportJobs }}'
    as: resource
    item:
      ReportJobId: '{{ resource.ReportJobId }}'
      ReportPlanArn: '{{ resource.ReportPlanArn }}'
      ReportTemplate: '{{ resource.ReportTemplate }}'
      CreationTime: '{{ resource.CreationTime }}'
      CompletionTime: '{{ resource.CompletionTime }}'
      Status: '{{ resource.Status }}'
      StatusMessage: '{{ resource.StatusMessage }}'
      ReportDestination: '{{ resource.ReportDestination }}'
- discovery_id: aws.backup.list_scan_jobs
  calls:
  - action: list_scan_jobs
    save_as: response
  emit:
    items_for: '{{ response.ScanJobs }}'
    as: resource
    item:
      AccountId: '{{ resource.AccountId }}'
      BackupVaultArn: '{{ resource.BackupVaultArn }}'
      BackupVaultName: '{{ resource.BackupVaultName }}'
      CompletionDate: '{{ resource.CompletionDate }}'
      CreatedBy: '{{ resource.CreatedBy }}'
      CreationDate: '{{ resource.CreationDate }}'
      IamRoleArn: '{{ resource.IamRoleArn }}'
      MalwareScanner: '{{ resource.MalwareScanner }}'
      RecoveryPointArn: '{{ resource.RecoveryPointArn }}'
      ResourceArn: '{{ resource.ResourceArn }}'
      ResourceName: '{{ resource.ResourceName }}'
      ResourceType: '{{ resource.ResourceType }}'
      ScanBaseRecoveryPointArn: '{{ resource.ScanBaseRecoveryPointArn }}'
      ScanId: '{{ resource.ScanId }}'
      ScanJobId: '{{ resource.ScanJobId }}'
      ScanMode: '{{ resource.ScanMode }}'
      ScanResult: '{{ resource.ScanResult }}'
      ScannerRoleArn: '{{ resource.ScannerRoleArn }}'
      State: '{{ resource.State }}'
      StatusMessage: '{{ resource.StatusMessage }}'
- discovery_id: aws.backup.describe_backup_vault
  calls:
  - action: describe_backup_vault
    save_as: response
    params:
      BackupVaultName: '{{ item.BackupVaultName }}'
  on_error: continue
  for_each: aws.backup.list_scan_jobs
  emit:
    item:
      MpaSessionArn: '{{ response.LatestMpaApprovalTeamUpdate.MpaSessionArn }}'
      Status: '{{ response.LatestMpaApprovalTeamUpdate.Status }}'
      StatusMessage: '{{ response.LatestMpaApprovalTeamUpdate.StatusMessage }}'
      InitiationDate: '{{ response.LatestMpaApprovalTeamUpdate.InitiationDate }}'
      ExpiryDate: '{{ response.LatestMpaApprovalTeamUpdate.ExpiryDate }}'
checks:
- rule_id: aws.backup.backupplan.failed_jobs_alerting_enabled
  for_each: aws.backup.list_backup_job_summaries
  conditions:
    var: item.State
    op: equals
    value: FAILED
- rule_id: aws.backup.restorejob.role_least_privilege
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.IamRoleArn
    op: exists
- rule_id: aws.backup.resource.vault_encryption_enabled
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.IsEncrypted
    op: equals
    value: true
- rule_id: aws.backup.restorejob.backup_logs_and_artifacts_encrypted
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.IsEncrypted
    op: equals
    value: true
- rule_id: aws.backup.backupplan.lag_monitoring_alerts_enabled
  for_each: aws.backup.list_backup_plans
  conditions:
    var: item.AdvancedBackupSettings
    op: exists
- rule_id: aws.backup.backupplan.backup_cross_region_replication_encrypted
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.IsEncrypted
    op: equals
    value: true
- rule_id: aws.backup.restorejob.from_encrypted_backups_only
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.IsEncrypted
    op: equals
    value: true
- rule_id: aws.backup.backupplan.backup_retention_minimum_configured
  for_each: aws.backup.list_backup_vaults
  conditions:
    var: item.MinRetentionDays
    op: gte
    value: 1
- rule_id: aws.backup.backupjob.alert_destinations_configured
  for_each: aws.backup.list_report_jobs
  conditions:
    var: item.ReportDestination
    op: exists
- rule_id: aws.backup.backupvault.key_rotation_enabled
  for_each: aws.backup.list_backup_vaults
  conditions:
    var: item.EncryptionKeyType
    op: equals
    value: ENABLED
- rule_id: aws.backup.backupplan.no_public_access_to_backup_vault_configured
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.VaultLockState
    op: equals
    value: LOCKED
- rule_id: aws.backup.resource.backup_vaults_encrypted
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.IsEncrypted
    op: equals
    value: true
- rule_id: aws.backup.backupvault.backup_cross_region_replication_enabled
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.VaultType
    op: equals
    value: CROSS_REGION
- rule_id: aws.backup.backupplan.unprotected_assets_alerting_enabled
  for_each: aws.backup.list_backup_plans
  conditions:
    var: item.AdvancedBackupSettings
    op: exists
- rule_id: aws.backup.backupplan.backup_admins_mfa_required
  for_each: aws.backup.describe_backup_vault
  conditions:
    var: item.MpaSessionArn
    op: exists
- rule_id: aws.backup.resource.backup_recovery_point_encrypted
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.IsEncrypted
    op: equals
    value: true
- rule_id: aws.backup.recoverypoint.backup_volumes_encrypted
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.IsEncrypted
    op: equals
    value: true
- rule_id: aws.backup.backupplan.policy_assignment_complete
  for_each: aws.backup.list_backup_plans
  conditions:
    var: item.AdvancedBackupSettings
    op: exists
- rule_id: aws.backup.backupplan.retention_days_minimum
  for_each: aws.backup.list_backup_vaults
  conditions:
    var: item.MinRetentionDays
    op: gte
    value: 1
- rule_id: aws.backup.backupvault.encryption_at_rest_enabled
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.IsEncrypted
    op: equals
    value: true
- rule_id: aws.backup.recoverypoint.agent_to_service_tls_required
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.IsEncrypted
    op: equals
    value: true
- rule_id: aws.backup.resource.encryption_enabled
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.IsEncrypted
    op: equals
    value: true
- rule_id: aws.backup.backupvault.encryption_in_transit_tls_min_1_2_configured
  for_each: aws.backup.list_backup_vaults
  conditions:
    var: item.EncryptionKeyType
    op: equals
    value: KMS
- rule_id: aws.backup.backupvault.cmk_cmek_key_configured
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.EncryptionKeyArn
    op: exists
- rule_id: aws.backup.backupplan.encryption_in_transit_tls_required
  for_each: aws.backup.list_backup_jobs
  conditions:
    var: item.IsEncrypted
    op: equals
    value: true
