version: '1.0'
provider: aws
service: ecs
discovery:
- discovery_id: aws.ecs.task_definitions_logging_block_modes
  calls:
  - client: ecs
    action: list_clusters
    save_as: task_definitions_logging_block_mode_list
    on_error: continue
    fields:
    - Ecss
  emit:
    items_for: task_definitions_logging_block_mode_list[]
    as: task_definitions_logging_block_mode
    item:
      id: '{{ task_definitions_logging_block_mode.Id }}'
      name: '{{ task_definitions_logging_block_mode.Name }}'
- discovery_id: aws.ecs.task_definitions_logging_block_mode_logging
  for_each: aws.ecs.task_definitions_logging_block_modes
  calls:
  - client: ecs
    action: describe_capacity_providers
    params:
      Task_definitions_logging_block_modeId: '{{ item.id }}'
    save_as: logging
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      logging_enabled: '{{ logging.LoggingEnabled is defined if logging else false
        }}'
- discovery_id: aws.ecs.resources
  for_each: aws.ecs.resource
  calls:
  - client: ecs
    action: describe_capacity_providers
    save_as: resources
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.ecs.container_instances
  for_each: aws.ecs.container_instance
  calls:
  - client: ecs
    action: describe_container_instances
    save_as: container_instances
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.ecs.resource_logging
  calls:
  - client: ecs
    action: list_account_settings
    save_as: resource_logging
    on_error: continue
  emit:
    items_for: resource_logging[]
    as: resource_logging
    item:
      id: '{{ resource_logging.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.ecs.task_definition_image_source_verifications
  for_each: aws.ecs.task_definition_image_source_verification
  calls:
  - client: ecs
    action: describe_capacity_providers
    save_as: task_definition_image_source_verifications
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
checks:
- title: 'ECS container instance: Container Read Only Root Filesystem Configured'
  severity: medium
  rule_id: aws.ecs.container_instance.container_read_only_root_filesystem_configured
  for_each:
    discovery: aws.ecs.container_instances
    as: container_instance
    item: container_instance
  conditions:
    var: container_instance.compliant
    op: equals
    value: true
- title: 'ECS container instance: No Privileged Containers Configured'
  severity: high
  rule_id: aws.ecs.container_instance.no_privileged_containers_configured
  for_each:
    discovery: aws.ecs.container_instances
    as: container_instance
    item: container_instance
  conditions:
    var: container_instance.compliant
    op: equals
    value: true
- title: 'ECS task definition image source verification: Task Ecs Task Definition
    Image Source Verification Configured'
  severity: medium
  rule_id: aws.ecs.task_definition_image_source_verification.task_ecs_task_definition_image_source_verification_configured
  for_each:
    discovery: aws.ecs.task_definition_image_source_verifications
    as: task_definition_image_source_verification
    item: task_definition_image_source_verification
  conditions:
    var: task_definition_image_source_verification.compliant
    op: equals
    value: true
- title: 'ECS resource: Task Sets Assign Public Ip Disabled'
  severity: high
  rule_id: aws.ecs.resource.task_sets_assign_public_ip_disabled
  for_each:
    discovery: aws.ecs.resources
    as: resource
    item: resource
  conditions:
    var: resource.is_public
    op: equals
    value: false
- title: 'ECS resource: Task Definition Logging Enabled'
  severity: medium
  rule_id: aws.ecs.resource.task_definition_logging_enabled
  for_each:
    discovery: aws.ecs.resource_logging
    as: resource
    item: resource
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'ECS container instance: Container Env No Plaintext Secrets Configured'
  severity: medium
  rule_id: aws.ecs.container_instance.container_env_no_plaintext_secrets_configured
  for_each:
    discovery: aws.ecs.container_instances
    as: container_instance
    item: container_instance
  conditions:
    var: container_instance.compliant
    op: equals
    value: true
- title: 'ECS task definitions logging block mode: Task Definitions Logging Block
    Mode Configured'
  severity: medium
  rule_id: aws.ecs.task_definitions_logging_block_mode.task_definitions_logging_block_mode_configured
  for_each:
    discovery: aws.ecs.task_definitions_logging_block_mode_logging
    as: task_definitions_logging_block_mode
    item: task_definitions_logging_block_mode
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'ECS resource: Task Definitions Logging Enabled'
  severity: medium
  rule_id: aws.ecs.resource.task_definitions_logging_enabled
  for_each:
    discovery: aws.ecs.resource_logging
    as: resource
    item: resource
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
