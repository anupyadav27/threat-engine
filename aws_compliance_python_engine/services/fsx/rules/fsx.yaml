version: '1.0'
provider: aws
service: fsx
services:
  client: fsx
  module: boto3.client
discovery:
- discovery_id: aws.fsx.create_backup
  calls:
  - action: create_backup
    save_as: response
  emit:
    item:
      BackupId: '{{ response.Backup.BackupId }}'
      Lifecycle: '{{ response.Backup.Lifecycle }}'
      FailureDetails: '{{ response.Backup.FailureDetails }}'
      Type: '{{ response.Backup.Type }}'
      ProgressPercent: '{{ response.Backup.ProgressPercent }}'
      CreationTime: '{{ response.Backup.CreationTime }}'
      KmsKeyId: '{{ response.Backup.KmsKeyId }}'
      ResourceARN: '{{ response.Backup.ResourceARN }}'
      Tags: '{{ response.Backup.Tags }}'
      FileSystem: '{{ response.Backup.FileSystem }}'
      DirectoryInformation: '{{ response.Backup.DirectoryInformation }}'
      OwnerId: '{{ response.Backup.OwnerId }}'
      SourceBackupId: '{{ response.Backup.SourceBackupId }}'
      SourceBackupRegion: '{{ response.Backup.SourceBackupRegion }}'
      ResourceType: '{{ response.Backup.ResourceType }}'
      Volume: '{{ response.Backup.Volume }}'
      SizeInBytes: '{{ response.Backup.SizeInBytes }}'
- discovery_id: aws.fsx.describe_file_caches
  calls:
  - action: describe_file_caches
    save_as: response
  emit:
    item:
      OwnerId: '{{ response.FileCaches.OwnerId }}'
      CreationTime: '{{ response.FileCaches.CreationTime }}'
      FileCacheId: '{{ response.FileCaches.FileCacheId }}'
      FileCacheType: '{{ response.FileCaches.FileCacheType }}'
      FileCacheTypeVersion: '{{ response.FileCaches.FileCacheTypeVersion }}'
      Lifecycle: '{{ response.FileCaches.Lifecycle }}'
      FailureDetails: '{{ response.FileCaches.FailureDetails }}'
      StorageCapacity: '{{ response.FileCaches.StorageCapacity }}'
      VpcId: '{{ response.FileCaches.VpcId }}'
      SubnetIds: '{{ response.FileCaches.SubnetIds }}'
      NetworkInterfaceIds: '{{ response.FileCaches.NetworkInterfaceIds }}'
      DNSName: '{{ response.FileCaches.DNSName }}'
      KmsKeyId: '{{ response.FileCaches.KmsKeyId }}'
      ResourceARN: '{{ response.FileCaches.ResourceARN }}'
      LustreConfiguration: '{{ response.FileCaches.LustreConfiguration }}'
      DataRepositoryAssociationIds: '{{ response.FileCaches.DataRepositoryAssociationIds
        }}'
checks:
- rule_id: aws.fsx.resource.backup_enabled
  for_each: aws.fsx.create_backup
  conditions:
    var: item.Lifecycle
    op: equals
    value: AVAILABLE
- rule_id: aws.fsx.filesystem.kms_key_policy_least_privilege
  for_each: aws.fsx.create_backup
  conditions:
    var: item.KmsKeyId
    op: exists
- rule_id: aws.fsx.resource.fsx_windows_file_system_multi_az_enabled
  for_each: aws.fsx.describe_file_caches
  conditions:
    var: item.SubnetIds
    op: gt
    value: 1
- rule_id: aws.fsx.resource.file_system_copy_tags_to_backups_enabled
  for_each: aws.fsx.create_backup
  conditions:
    var: item.Tags
    op: exists
- rule_id: aws.fsx.filesystem.encryption_at_rest_enabled
  for_each: aws.fsx.create_backup
  conditions:
    var: item.KmsKeyId
    op: exists
- rule_id: aws.fsx.filesystem.snapshots_enabled
  for_each: aws.fsx.create_backup
  conditions:
    var: item.Lifecycle
    op: equals
    value: AVAILABLE
- rule_id: aws.fsx.resource.file_system_copy_tags_to_volumes_enabled
  for_each: aws.fsx.create_backup
  conditions:
    var: item.Tags
    op: exists
