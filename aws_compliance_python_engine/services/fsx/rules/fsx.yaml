version: '1.0'
provider: aws
service: fsx
discovery:
- discovery_id: aws.fsx.filesystems
  calls:
  - client: fsx
    action: list_tags_for_resource
    save_as: filesystem_list
    on_error: continue
    fields:
    - Fsxs
  emit:
    items_for: filesystem_list[]
    as: filesystem
    item:
      id: '{{ filesystem.Id }}'
      name: '{{ filesystem.Name }}'
- discovery_id: aws.fsx.filesystem_encryption
  for_each: aws.fsx.filesystems
  calls:
  - client: fsx
    action: list_tags_for_resource
    params:
      FilesystemId: '{{ item.id }}'
    save_as: encryption
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      encryption_enabled: '{{ encryption.Encrypted if encryption.Encrypted is defined
        else false }}'
- discovery_id: aws.fsx.resources
  for_each: aws.fsx.resource
  calls:
  - client: fsx
    action: describe_backups
    save_as: resources
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
checks:
- title: 'FSX resource: Backup Enabled'
  severity: medium
  rule_id: aws.fsx.resource.backup_enabled
  for_each:
    discovery: aws.fsx.resources
    as: resource
    item: resource
  conditions:
    var: resource.versioning_enabled
    op: equals
    value: true
- title: 'FSX filesystem: Kms Key Policy Least Privilege'
  severity: high
  rule_id: aws.fsx.filesystem.kms_key_policy_least_privilege
  for_each:
    discovery: aws.fsx.filesystem_encryption
    as: filesystem
    item: filesystem
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'FSX resource: Fsx Windows File System Multi Az Enabled'
  severity: medium
  rule_id: aws.fsx.resource.fsx_windows_file_system_multi_az_enabled
  for_each:
    discovery: aws.fsx.resources
    as: resource
    item: resource
  conditions:
    var: resource.compliant
    op: equals
    value: true
- title: 'FSX resource: File System Copy Tags To Backups Enabled'
  severity: medium
  rule_id: aws.fsx.resource.file_system_copy_tags_to_backups_enabled
  for_each:
    discovery: aws.fsx.resources
    as: resource
    item: resource
  conditions:
    var: resource.versioning_enabled
    op: equals
    value: true
- title: 'FSX filesystem: Private Network Only Configured'
  severity: high
  rule_id: aws.fsx.filesystem.private_network_only_configured
  for_each:
    discovery: aws.fsx.filesystems
    as: filesystem
    item: filesystem
  conditions:
    var: filesystem.is_public
    op: equals
    value: false
- title: 'FSX filesystem: Encryption At Rest Enabled'
  severity: high
  rule_id: aws.fsx.filesystem.encryption_at_rest_enabled
  for_each:
    discovery: aws.fsx.filesystem_encryption
    as: filesystem
    item: filesystem
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'FSX filesystem: Snapshots Enabled'
  severity: medium
  rule_id: aws.fsx.filesystem.snapshots_enabled
  for_each:
    discovery: aws.fsx.filesystems
    as: filesystem
    item: filesystem
  conditions:
    var: filesystem.versioning_enabled
    op: equals
    value: true
- title: 'FSX resource: File System Copy Tags To Volumes Enabled'
  severity: medium
  rule_id: aws.fsx.resource.file_system_copy_tags_to_volumes_enabled
  for_each:
    discovery: aws.fsx.resources
    as: resource
    item: resource
  conditions:
    var: resource.compliant
    op: equals
    value: true
