version: '1.0'
provider: aws
service: fsx
discovery:
- discovery_id: aws.fsx.filesystems
  calls:
  - client: fsx
    action: list_tags_for_resource
    save_as: filesystem_list
    on_error: continue
    fields:
    - Fsxs
  emit:
    items_for: filesystem_list[]
    as: filesystem
    item:
      id: '{{ filesystem.Id }}'
      name: '{{ filesystem.Name }}'
- discovery_id: aws.fsx.filesystem_encryption
  for_each: aws.fsx.filesystems
  calls:
  - client: fsx
    action: list_tags_for_resource
    params:
      FilesystemId: '{{ item.id }}'
    save_as: encryption
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      encryption_enabled: '{{ encryption.Encrypted if encryption.Encrypted is defined else false }}'
- discovery_id: aws.fsx.resources
  for_each: aws.fsx.resource
  calls:
  - client: fsx
    action: describe_backups
    save_as: resources
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
checks:
- title: 'FSX resource: Backup Enabled'
  severity: medium
  rule_id: aws.fsx.resource.backup_enabled
  for_each:
    discovery: aws.fsx.resources
    as: resource
    item: resource
  conditions:
    var: resource.versioning_enabled
    op: equals
    value: true
  remediation: "Enable versioning for fsx resource:\n\n1. Open FSX console\n2. Select the resource\n3. Go to Properties >\
    \ Versioning\n4. Enable versioning\n5. Configure retention policies\n6. Set up lifecycle rules (optional)\n7. Save changes\n\
    \nBenefits:\n\u2022 Protection against accidental deletion\n\u2022 Ability to recover from ransomware\n\u2022 Audit trail\
    \ of changes\n\u2022 Point-in-time recovery"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
- title: 'FSX filesystem: Kms Key Policy Least Privilege'
  severity: high
  rule_id: aws.fsx.filesystem.kms_key_policy_least_privilege
  for_each:
    discovery: aws.fsx.filesystem_encryption
    as: filesystem
    item: filesystem
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
  remediation: "Enable encryption for fsx filesystem:\n\n1. Open FSX console\n2. Select the filesystem\n3. Navigate to Properties/Configuration\
    \ > Encryption\n4. Enable encryption\n5. Choose encryption key:\n   - AWS managed key (default)\n   - Customer managed\
    \ key (KMS) for enhanced control\n6. Save changes\n\nAWS CLI:\naws fsx modify-filesystem --filesystem-id <id> --encrypted\
    \ --kms-key-id <key-id>\n\nSecurity Best Practices:\n\u2022 Use customer-managed KMS keys for sensitive data\n\u2022 Enable\
    \ automatic key rotation\n\u2022 Implement proper key access policies\n\u2022 Audit key usage regularly"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
- title: 'FSX resource: Fsx Windows File System Multi Az Enabled'
  severity: medium
  rule_id: aws.fsx.resource.fsx_windows_file_system_multi_az_enabled
  for_each:
    discovery: aws.fsx.resources
    as: resource
    item: resource
  conditions:
    var: resource.compliant
    op: equals
    value: true
  remediation: "Configure fsx resource for compliance:\n\nRequirement: Fsx Windows File System Multi Az Enabled\n\nDescription:\
    \ Verifies security configuration for AWS FSX resource to ensure alignment with AWS security best practices and compliance\
    \ requirements. Proper configuration reduces security risks, maintains defense in depth, and supports overall security\
    \ posture.\n\nSteps:\n1. Open FSX console\n2. Select the resource\n3. Review security configuration\n4. Apply required\
    \ settings per organizational policy\n5. Verify compliance\n6. Save changes\n\nGeneral Security Recommendations:\n\u2022\
    \ Follow AWS Well-Architected Framework\n\u2022 Implement defense in depth\n\u2022 Enable logging and monitoring\n\u2022\
    \ Use encryption where applicable\n\u2022 Regular security audits"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
- title: 'FSX resource: File System Copy Tags To Backups Enabled'
  severity: medium
  rule_id: aws.fsx.resource.file_system_copy_tags_to_backups_enabled
  for_each:
    discovery: aws.fsx.resources
    as: resource
    item: resource
  conditions:
    var: resource.versioning_enabled
    op: equals
    value: true
  remediation: "Enable versioning for fsx resource:\n\n1. Open FSX console\n2. Select the resource\n3. Go to Properties >\
    \ Versioning\n4. Enable versioning\n5. Configure retention policies\n6. Set up lifecycle rules (optional)\n7. Save changes\n\
    \nBenefits:\n\u2022 Protection against accidental deletion\n\u2022 Ability to recover from ransomware\n\u2022 Audit trail\
    \ of changes\n\u2022 Point-in-time recovery"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
- title: 'FSX filesystem: Private Network Only Configured'
  severity: high
  rule_id: aws.fsx.filesystem.private_network_only_configured
  for_each:
    discovery: aws.fsx.filesystems
    as: filesystem
    item: filesystem
  conditions:
    var: filesystem.is_public
    op: equals
    value: false
  remediation: "Restrict public access for fsx filesystem:\n\n1. Open FSX console\n2. Select the filesystem\n3. Go to Permissions/Access\
    \ Control\n4. Review current permissions:\n   - Remove public access grants\n   - Remove wildcard (*) principals\n   -\
    \ Implement least privilege\n5. Update resource policy or IAM policies\n6. Enable resource-level access control\n7. Save\
    \ changes\n\nSecurity Recommendations:\n\u2022 Use IAM roles instead of access keys\n\u2022 Implement condition keys for\
    \ additional security\n\u2022 Enable MFA for sensitive operations\n\u2022 Regularly audit access permissions\n\u2022 Use\
    \ AWS Organizations SCPs for guardrails"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
- title: 'FSX filesystem: Encryption At Rest Enabled'
  severity: high
  rule_id: aws.fsx.filesystem.encryption_at_rest_enabled
  for_each:
    discovery: aws.fsx.filesystem_encryption
    as: filesystem
    item: filesystem
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
  remediation: "Enable encryption for fsx filesystem:\n\n1. Open FSX console\n2. Select the filesystem\n3. Navigate to Properties/Configuration\
    \ > Encryption\n4. Enable encryption\n5. Choose encryption key:\n   - AWS managed key (default)\n   - Customer managed\
    \ key (KMS) for enhanced control\n6. Save changes\n\nAWS CLI:\naws fsx modify-filesystem --filesystem-id <id> --encrypted\
    \ --kms-key-id <key-id>\n\nSecurity Best Practices:\n\u2022 Use customer-managed KMS keys for sensitive data\n\u2022 Enable\
    \ automatic key rotation\n\u2022 Implement proper key access policies\n\u2022 Audit key usage regularly"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
- title: 'FSX filesystem: Snapshots Enabled'
  severity: medium
  rule_id: aws.fsx.filesystem.snapshots_enabled
  for_each:
    discovery: aws.fsx.filesystems
    as: filesystem
    item: filesystem
  conditions:
    var: filesystem.versioning_enabled
    op: equals
    value: true
  remediation: "Enable versioning for fsx filesystem:\n\n1. Open FSX console\n2. Select the filesystem\n3. Go to Properties\
    \ > Versioning\n4. Enable versioning\n5. Configure retention policies\n6. Set up lifecycle rules (optional)\n7. Save changes\n\
    \nBenefits:\n\u2022 Protection against accidental deletion\n\u2022 Ability to recover from ransomware\n\u2022 Audit trail\
    \ of changes\n\u2022 Point-in-time recovery"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
- title: 'FSX resource: File System Copy Tags To Volumes Enabled'
  severity: medium
  rule_id: aws.fsx.resource.file_system_copy_tags_to_volumes_enabled
  for_each:
    discovery: aws.fsx.resources
    as: resource
    item: resource
  conditions:
    var: resource.compliant
    op: equals
    value: true
  remediation: "Configure fsx resource for compliance:\n\nRequirement: File System Copy Tags To Volumes Enabled\n\nDescription:\
    \ Verifies security configuration for AWS FSX resource to ensure alignment with AWS security best practices and compliance\
    \ requirements. Proper configuration reduces security risks, maintains defense in depth, and supports overall security\
    \ posture.\n\nSteps:\n1. Open FSX console\n2. Select the resource\n3. Review security configuration\n4. Apply required\
    \ settings per organizational policy\n5. Verify compliance\n6. Save changes\n\nGeneral Security Recommendations:\n\u2022\
    \ Follow AWS Well-Architected Framework\n\u2022 Implement defense in depth\n\u2022 Enable logging and monitoring\n\u2022\
    \ Use encryption where applicable\n\u2022 Regular security audits"
  references:
  - https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html
