version: '1.0'
provider: aws
service: acm
discovery:
- discovery_id: aws.acm.list_certificates
  calls:
  - action: list_certificates
    save_as: list_certificates_response
  emit:
    items_for: '{{ list_certificates_response.CertificateSummaryList }}'
    as: resource
    item:
      certificate_arn: '{{ resource.CertificateArn }}'
      domain_name: '{{ resource.DomainName }}'
      subject_alternative_name_summaries: '{{ resource.SubjectAlternativeNameSummaries
        }}'
      has_additional_subject_alternative_names: '{{ resource.HasAdditionalSubjectAlternativeNames
        }}'
      status: '{{ resource.Status }}'
      type: '{{ resource.Type }}'
      key_algorithm: '{{ resource.KeyAlgorithm }}'
      key_usages: '{{ resource.KeyUsages }}'
      extended_key_usages: '{{ resource.ExtendedKeyUsages }}'
      export_option: '{{ resource.ExportOption }}'
- discovery_id: aws.acm.get_account_configuration
  calls:
  - action: get_account_configuration
    save_as: get_account_configuration_response
  emit:
    items_for: '{{ get_account_configuration_response.ExpiryEvents }}'
    as: resource
    item:
      days_before_expiry: '{{ resource.DaysBeforeExpiry }}'
- discovery_id: aws.acm.describe_certificate
  calls:
  - action: describe_certificate
    save_as: describe_certificate_response
    params:
      CertificateArn: '{{ item.certificate_arn }}'
    on_error: continue
  for_each: aws.acm.list_certificates
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      certificate_arn: '{{ describe_certificate_response.Certificate.CertificateArn
        }}'
      domain_name: '{{ describe_certificate_response.Certificate.DomainName }}'
      subject_alternative_names: '{{ describe_certificate_response.Certificate.SubjectAlternativeNames
        }}'
      managed_by: '{{ describe_certificate_response.Certificate.ManagedBy }}'
      domain_validation_options: '{{ describe_certificate_response.Certificate.DomainValidationOptions
        }}'
checks:
- rule_id: aws.acm.privateca.ca_certificate_crl_or_ocsp_configured
  for_each: aws.acm.list_certificates
  conditions:
    all:
    - var: item.status
      op: equals
      value: ISSUED
    - var: item.in_use
      op: equals
      value: true
- rule_id: aws.acm.certificate.key_length_minimum
  for_each: aws.acm.list_certificates
  conditions:
    var: item.key_algorithm
    op: contains
    value: '2048'
- rule_id: aws.acm.privateca.ca_certificate_path_length_constraints_configured
  for_each: aws.acm.list_certificates
  conditions:
    all:
    - var: item.status
      op: equals
      value: ISSUED
    - var: item.type
      op: equals
      value: PRIVATE
- rule_id: aws.acm.privateca.ca_key_in_hsm_enabled_if_supported
  for_each: aws.acm.list_certificates
  conditions:
    var: item.export_option
    op: equals
    value: ENABLED
- rule_id: aws.acm.certificate.expiration_monitored
  for_each: aws.acm.get_account_configuration
  conditions:
    var: item.days_before_expiry
    op: exists
- rule_id: aws.acm.privateca.ca_access_rbac_least_privilege
  for_each: aws.acm.list_certificates
  conditions:
    all:
    - var: item.status
      op: equals
      value: ISSUED
    - var: item.in_use
      op: equals
      value: true
- rule_id: aws.acm.certificate.mtls_required_for_internal_services_if_supported
  for_each: aws.acm.list_certificates
  conditions:
    all:
    - var: item.in_use
      op: equals
      value: true
    - var: item.status
      op: equals
      value: ISSUED
    - var: item.key_usages
      op: contains
      value: TLS_WEB_SERVER_AUTHENTICATION
    - var: item.extended_key_usages
      op: contains
      value: TLS_WEB_SERVER_AUTHENTICATION
- rule_id: aws.acm.certificate.trusted_issuer_verified
  for_each: aws.acm.describe_certificate
  conditions:
    var: item.issuer
    op: equals
    value: Amazon
- rule_id: aws.acm.privateca.key_length_minimum
  for_each: aws.acm.list_certificates
  conditions:
    var: item.key_algorithm
    op: contains
    value: '2048'
- rule_id: aws.acm.privateca.ca_certificate_trusted_issuer_verified
  for_each: aws.acm.describe_certificate
  conditions:
    all:
    - var: item.status
      op: equals
      value: ISSUED
    - var: item.issuer
      op: exists
- rule_id: aws.acm.certificate.tls_min_1_2_enforced
  for_each: aws.acm.list_certificates
  conditions:
    var: item.status
    op: equals
    value: ISSUED
- rule_id: aws.acm.privateca.ca_certificate_valid
  for_each: aws.acm.list_certificates
  conditions:
    all:
    - var: item.status
      op: equals
      value: ISSUED
    - var: item.not_after
      op: gt
      value: current_date
