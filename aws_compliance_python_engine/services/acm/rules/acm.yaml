version: '1.0'
provider: aws
service: acm
services:
  client: acm
  module: boto3.client
discovery:
- discovery_id: aws.acm.list_certificates
  calls:
  - action: list_certificates
    save_as: response
  emit:
    items_for: '{{ response.CertificateSummaryList }}'
    as: resource
    item:
      CertificateArn: '{{ resource.CertificateArn }}'
      DomainName: '{{ resource.DomainName }}'
      SubjectAlternativeNameSummaries: '{{ resource.SubjectAlternativeNameSummaries
        }}'
      HasAdditionalSubjectAlternativeNames: '{{ resource.HasAdditionalSubjectAlternativeNames
        }}'
      Status: '{{ resource.Status }}'
      Type: '{{ resource.Type }}'
      KeyAlgorithm: '{{ resource.KeyAlgorithm }}'
      KeyUsages: '{{ resource.KeyUsages }}'
      ExtendedKeyUsages: '{{ resource.ExtendedKeyUsages }}'
      ExportOption: '{{ resource.ExportOption }}'
      InUse: '{{ resource.InUse }}'
      Exported: '{{ resource.Exported }}'
      RenewalEligibility: '{{ resource.RenewalEligibility }}'
      NotBefore: '{{ resource.NotBefore }}'
      NotAfter: '{{ resource.NotAfter }}'
      CreatedAt: '{{ resource.CreatedAt }}'
      IssuedAt: '{{ resource.IssuedAt }}'
      ImportedAt: '{{ resource.ImportedAt }}'
      RevokedAt: '{{ resource.RevokedAt }}'
      ManagedBy: '{{ resource.ManagedBy }}'
- discovery_id: aws.acm.describe_certificate
  calls:
  - action: describe_certificate
    save_as: response
    params:
      CertificateArn: '{{ item.CertificateArn }}'
  for_each: aws.acm.list_certificates
  on_error: continue
  emit:
    item:
      CertificateArn: '{{ response.Certificate.CertificateArn }}'
      DomainName: '{{ response.Certificate.DomainName }}'
      SubjectAlternativeNames: '{{ response.Certificate.SubjectAlternativeNames }}'
      ManagedBy: '{{ response.Certificate.ManagedBy }}'
      DomainValidationOptions: '{{ response.Certificate.DomainValidationOptions }}'
      Serial: '{{ response.Certificate.Serial }}'
      Subject: '{{ response.Certificate.Subject }}'
      Issuer: '{{ response.Certificate.Issuer }}'
      CreatedAt: '{{ response.Certificate.CreatedAt }}'
      IssuedAt: '{{ response.Certificate.IssuedAt }}'
      ImportedAt: '{{ response.Certificate.ImportedAt }}'
      Status: '{{ response.Certificate.Status }}'
      RevokedAt: '{{ response.Certificate.RevokedAt }}'
      RevocationReason: '{{ response.Certificate.RevocationReason }}'
      NotBefore: '{{ response.Certificate.NotBefore }}'
      NotAfter: '{{ response.Certificate.NotAfter }}'
      KeyAlgorithm: '{{ response.Certificate.KeyAlgorithm }}'
      SignatureAlgorithm: '{{ response.Certificate.SignatureAlgorithm }}'
      InUseBy: '{{ response.Certificate.InUseBy }}'
      FailureReason: '{{ response.Certificate.FailureReason }}'
      Type: '{{ response.Certificate.Type }}'
      RenewalSummary: '{{ response.Certificate.RenewalSummary }}'
      KeyUsages: '{{ response.Certificate.KeyUsages }}'
      ExtendedKeyUsages: '{{ response.Certificate.ExtendedKeyUsages }}'
      CertificateAuthorityArn: '{{ response.Certificate.CertificateAuthorityArn }}'
      RenewalEligibility: '{{ response.Certificate.RenewalEligibility }}'
      Options: '{{ response.Certificate.Options }}'
      Certificate: '{{ resource.Certificate }}'
checks:
- rule_id: aws.acm.privateca.ca_certificate_crl_or_ocsp_configured
  for_each: aws.acm.describe_certificate
  conditions:
    var: item.Certificate
    op: not_equals
    value: 'null'
- rule_id: aws.acm.certificate.key_length_minimum
  for_each: aws.acm.list_certificates
  conditions:
    var: item.KeyAlgorithm
    op: equals
    value: RSA_2048
- rule_id: aws.acm.privateca.ca_certificate_path_length_constraints_configured
  for_each: aws.acm.describe_certificate
  conditions:
    var: item.SubjectAlternativeNames
    op: less_than_or_equal
    value: 5
- rule_id: aws.acm.privateca.ca_key_in_hsm_enabled_if_supported
  for_each: aws.acm.list_certificates
  conditions:
    var: item.ExportOption
    op: equals
    value: ENABLED
- rule_id: aws.acm.privateca.ca_access_rbac_least_privilege
  for_each: aws.acm.list_certificates
  conditions:
    var: item.CertificateArn
    op: not_equals
    value: 'null'
- rule_id: aws.acm.certificate.mtls_required_for_internal_services_if_supported
  for_each: aws.acm.list_certificates
  conditions:
    var: item.Status
    op: equals
    value: ISSUED
- rule_id: aws.acm.certificate.trusted_issuer_verified
  for_each: aws.acm.describe_certificate
  conditions:
    var: item.Issuer
    op: not_equals
    value: 'null'
- rule_id: aws.acm.privateca.ca_certificate_trusted_issuer_verified
  for_each: aws.acm.describe_certificate
  conditions:
    var: item.Issuer
    op: equals
    value: 'null'
- rule_id: aws.acm.certificate.tls_min_1_2_enforced
  for_each: aws.acm.list_certificates
  conditions:
    var: item.KeyAlgorithm
    op: equals
    value: RSA_2048
- rule_id: aws.acm.certificate.valid
  for_each: aws.acm.list_certificates
  conditions:
    var: item.Status
    op: equals
    value: ISSUED
- rule_id: aws.acm.privateca.ca_certificate_valid
  for_each: aws.acm.list_certificates
  conditions:
    var: item.Status
    op: equals
    value: ISSUED
- rule_id: aws.acm.certificate.expiration_monitored
  for_each: aws.acm.list_certificates
  conditions:
    var: item.NotAfter
    op: lte
- rule_id: aws.acm.certificates.certificate_expiration_monitored
  for_each: aws.acm.list_certificates
  conditions:
    var: item.NotAfter
    op: lte
- rule_id: aws.acm.privateca.key_length_minimum
  for_each: aws.acm.list_certificates
  conditions:
    var: item.KeyAlgorithm
    op: in
    value:
    - RSA_2048
    - RSA_3072
    - RSA_4096
    - EC_prime256v1
    - EC_secp384r1
