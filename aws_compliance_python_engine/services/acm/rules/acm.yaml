version: '1.0'
provider: aws
service: acm
discovery:
- discovery_id: aws.acm.certificates
  calls:
  - client: acm
    action: list_certificates
    save_as: certificate_list
    on_error: continue
    fields:
    - Acms
  emit:
    items_for: certificate_list[]
    as: certificate
    item:
      id: '{{ certificate.Id }}'
      name: '{{ certificate.Name }}'
- discovery_id: aws.acm.privatecas
  for_each: aws.acm.privateca
  calls:
  - client: acm
    action: describe_certificate
    save_as: privatecas
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.acm.certificatess
  for_each: aws.acm.certificate
  calls:
  - client: acm
    action: describe_certificate
    save_as: certificatess
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
checks:
- title: 'ACM privateca: Ca Certificate Crl Or Ocsp Configured'
  severity: medium
  rule_id: aws.acm.privateca.ca_certificate_crl_or_ocsp_configured
  for_each:
    discovery: aws.acm.privatecas
    as: privateca
    item: privateca
  conditions:
    var: privateca.in_vpc
    op: equals
    value: true
- title: 'ACM certificate: Key Length Minimum'
  severity: medium
  rule_id: aws.acm.certificate.key_length_minimum
  for_each:
    discovery: aws.acm.certificates
    as: certificate
    item: certificate
  conditions:
    var: certificate.compliant
    op: equals
    value: true
- title: 'ACM privateca: Ca Certificate Path Length Constraints Configured'
  severity: medium
  rule_id: aws.acm.privateca.ca_certificate_path_length_constraints_configured
  for_each:
    discovery: aws.acm.privatecas
    as: privateca
    item: privateca
  conditions:
    var: privateca.in_vpc
    op: equals
    value: true
- title: 'ACM privateca: Ca Key In Hsm Enabled If Supported'
  severity: medium
  rule_id: aws.acm.privateca.ca_key_in_hsm_enabled_if_supported
  for_each:
    discovery: aws.acm.privatecas
    as: privateca
    item: privateca
  conditions:
    var: privateca.in_vpc
    op: equals
    value: true
- title: 'ACM certificate: Expiration Monitored'
  severity: medium
  rule_id: aws.acm.certificate.expiration_monitored
  for_each:
    discovery: aws.acm.certificates
    as: certificate
    item: certificate
  conditions:
    var: certificate.monitoring_enabled
    op: equals
    value: true
- title: 'ACM privateca: Ca Access Rbac Least Privilege'
  severity: high
  rule_id: aws.acm.privateca.ca_access_rbac_least_privilege
  for_each:
    discovery: aws.acm.privatecas
    as: privateca
    item: privateca
  conditions:
    var: privateca.is_public
    op: equals
    value: false
- title: 'ACM certificate: Mtls Required For Internal Services If Supported'
  severity: high
  rule_id: aws.acm.certificate.mtls_required_for_internal_services_if_supported
  for_each:
    discovery: aws.acm.certificates
    as: certificate
    item: certificate
  conditions:
    var: certificate.in_vpc
    op: equals
    value: true
- title: 'ACM certificate: Trusted Issuer Verified'
  severity: medium
  rule_id: aws.acm.certificate.trusted_issuer_verified
  for_each:
    discovery: aws.acm.certificates
    as: certificate
    item: certificate
  conditions:
    var: certificate.compliant
    op: equals
    value: true
- title: 'ACM certificates: Certificate Expiration Monitored'
  severity: medium
  rule_id: aws.acm.certificates.certificate_expiration_monitored
  for_each:
    discovery: aws.acm.certificatess
    as: certificates
    item: certificates
  conditions:
    var: certificates.monitoring_enabled
    op: equals
    value: true
- title: 'ACM privateca: Key Length Minimum'
  severity: medium
  rule_id: aws.acm.privateca.key_length_minimum
  for_each:
    discovery: aws.acm.privatecas
    as: privateca
    item: privateca
  conditions:
    var: privateca.in_vpc
    op: equals
    value: true
- title: 'ACM privateca: Ca Certificate Trusted Issuer Verified'
  severity: medium
  rule_id: aws.acm.privateca.ca_certificate_trusted_issuer_verified
  for_each:
    discovery: aws.acm.privatecas
    as: privateca
    item: privateca
  conditions:
    var: privateca.in_vpc
    op: equals
    value: true
- title: 'ACM certificate: Tls Min 1 2 Enforced'
  severity: high
  rule_id: aws.acm.certificate.tls_min_1_2_enforced
  for_each:
    discovery: aws.acm.certificates
    as: certificate
    item: certificate
  conditions:
    var: certificate.in_vpc
    op: equals
    value: true
- title: 'ACM certificate: Valid'
  severity: medium
  rule_id: aws.acm.certificate.valid
  for_each:
    discovery: aws.acm.certificates
    as: certificate
    item: certificate
  conditions:
    var: certificate.compliant
    op: equals
    value: true
- title: 'ACM privateca: Ca Certificate Valid'
  severity: medium
  rule_id: aws.acm.privateca.ca_certificate_valid
  for_each:
    discovery: aws.acm.privatecas
    as: privateca
    item: privateca
  conditions:
    var: privateca.in_vpc
    op: equals
    value: true
