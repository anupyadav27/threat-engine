version: '1.0'
provider: aws
service: acm
services:
  client: acm
  module: boto3.client
discovery:
- discovery_id: aws.acm.list_certificates
  calls:
  - action: list_certificates
    save_as: response
  emit:
    items_for: '{{ response.CertificateSummaryList }}'
    as: resource
    item:
      certificate_arn: '{{ resource.CertificateArn }}'
      domain_name: '{{ resource.DomainName }}'
      subject_alternative_name_summaries: '{{ resource.SubjectAlternativeNameSummaries
        }}'
      has_additional_subject_alternative_names: '{{ resource.HasAdditionalSubjectAlternativeNames
        }}'
      status: '{{ resource.Status }}'
      type: '{{ resource.Type }}'
      key_algorithm: '{{ resource.KeyAlgorithm }}'
      key_usages: '{{ resource.KeyUsages }}'
      extended_key_usages: '{{ resource.ExtendedKeyUsages }}'
      export_option: '{{ resource.ExportOption }}'
      in_use: '{{ resource.InUse }}'
      exported: '{{ resource.Exported }}'
      renewal_eligibility: '{{ resource.RenewalEligibility }}'
      not_before: '{{ resource.NotBefore }}'
      not_after: '{{ resource.NotAfter }}'
      created_at: '{{ resource.CreatedAt }}'
      issued_at: '{{ resource.IssuedAt }}'
      imported_at: '{{ resource.ImportedAt }}'
      revoked_at: '{{ resource.RevokedAt }}'
      managed_by: '{{ resource.ManagedBy }}'
- discovery_id: aws.acm.describe_certificate
  calls:
  - action: describe_certificate
    save_as: response
    params:
      CertificateArn: '{{ item.certificate_arn }}'
  for_each: aws.acm.list_certificates
  on_error: continue
  emit:
    item:
      certificate: '{{ response.Certificate }}'
      certificate_arn: '{{ response.Certificate.CertificateArn }}'
      domain_name: '{{ response.Certificate.DomainName }}'
      subject_alternative_names: '{{ response.Certificate.SubjectAlternativeNames
        }}'
      managed_by: '{{ response.Certificate.ManagedBy }}'
      domain_validation_options: '{{ response.Certificate.DomainValidationOptions
        }}'
      serial: '{{ response.Certificate.Serial }}'
      subject: '{{ response.Certificate.Subject }}'
      issuer: '{{ response.Certificate.Issuer }}'
      created_at: '{{ response.Certificate.CreatedAt }}'
      issued_at: '{{ response.Certificate.IssuedAt }}'
      imported_at: '{{ response.Certificate.ImportedAt }}'
      status: '{{ response.Certificate.Status }}'
      revoked_at: '{{ response.Certificate.RevokedAt }}'
      revocation_reason: '{{ response.Certificate.RevocationReason }}'
      not_before: '{{ response.Certificate.NotBefore }}'
      not_after: '{{ response.Certificate.NotAfter }}'
      key_algorithm: '{{ response.Certificate.KeyAlgorithm }}'
      signature_algorithm: '{{ response.Certificate.SignatureAlgorithm }}'
      in_use_by: '{{ response.Certificate.InUseBy }}'
      failure_reason: '{{ response.Certificate.FailureReason }}'
      type: '{{ response.Certificate.Type }}'
      renewal_summary: '{{ response.Certificate.RenewalSummary }}'
      key_usages: '{{ response.Certificate.KeyUsages }}'
      extended_key_usages: '{{ response.Certificate.ExtendedKeyUsages }}'
      certificate_authority_arn: '{{ response.Certificate.CertificateAuthorityArn
        }}'
      renewal_eligibility: '{{ response.Certificate.RenewalEligibility }}'
      options: '{{ response.Certificate.Options }}'
- discovery_id: aws.acm.get_account_configuration
  calls:
  - action: get_account_configuration
    save_as: response
  emit:
    item:
      expiry_events: '{{ response.ExpiryEvents }}'
      days_before_expiry: '{{ response.ExpiryEvents.DaysBeforeExpiry }}'
- discovery_id: aws.acm.get_certificate
  calls:
  - action: get_certificate
    save_as: response
    params:
      CertificateArn: '{{ item.certificate_arn }}'
  for_each: aws.acm.list_certificates
  on_error: continue
  emit:
    item:
      certificate: '{{ response.Certificate }}'
      certificate_chain: '{{ response.CertificateChain }}'
- discovery_id: aws.acm.list_tags_for_certificate
  calls:
  - action: list_tags_for_certificate
    save_as: response
    params:
      CertificateArn: '{{ item.certificate_arn }}'
  for_each: aws.acm.list_certificates
  on_error: continue
  emit:
    items_for: '{{ response.Tags }}'
    as: resource
    item:
      key: '{{ resource.Key }}'
      value: '{{ resource.Value }}'
checks:
- rule_id: aws.acm.privateca.ca_certificate_crl_or_ocsp_configured
  for_each: aws.acm.list_certificates
  conditions:
    var: item.Status
    op: exists
- rule_id: aws.acm.certificate.key_length_minimum
  for_each: aws.acm.list_certificates
  conditions:
    var: item.KeyAlgorithm
    op: contains
    value: '2048'
- rule_id: aws.acm.privateca.ca_certificate_path_length_constraints_configured
  for_each: aws.acm.list_certificates
  conditions:
    var: item.Status
    op: exists
- rule_id: aws.acm.privateca.ca_key_in_hsm_enabled_if_supported
  for_each: aws.acm.list_certificates
  conditions:
    var: item.Encryption
    op: equals
    value: enabled
- rule_id: aws.acm.certificate.expiration_monitored
  for_each: aws.acm.list_certificates
  conditions:
    var: item.NotAfter
    op: exists
- rule_id: aws.acm.privateca.ca_access_rbac_least_privilege
  for_each: aws.acm.list_certificates
  conditions:
    var: item.Status
    op: exists
- rule_id: aws.acm.certificate.mtls_required_for_internal_services_if_supported
  for_each: aws.acm.list_certificates
  conditions:
    var: item.Status
    op: equals
    value: ISSUED
- rule_id: aws.acm.certificate.trusted_issuer_verified
  for_each: aws.acm.describe_certificate
  conditions:
    var: item.Issuer
    op: equals
    value: Amazon
- rule_id: aws.acm.certificates.certificate_expiration_monitored
  for_each: aws.acm.list_certificates
  conditions:
    var: item.NotAfter
    op: exists
- rule_id: aws.acm.privateca.key_length_minimum
  for_each: aws.acm.list_certificates
  conditions:
    var: item.KeyAlgorithm
    op: contains
    value: '2048'
- rule_id: aws.acm.privateca.ca_certificate_trusted_issuer_verified
  for_each: aws.acm.describe_certificate
  conditions:
    var: item.Issuer
    op: equals
    value: Amazon
- rule_id: aws.acm.certificate.tls_min_1_2_enforced
  for_each: aws.acm.list_certificates
  conditions:
    var: item.Status
    op: equals
    value: ISSUED
- rule_id: aws.acm.certificate.valid
  for_each: aws.acm.list_certificates
  conditions:
    var: item.Status
    op: exists
- rule_id: aws.acm.privateca.ca_certificate_valid
  for_each: aws.acm.list_certificates
  conditions:
    var: item.Status
    op: exists
