version: '1.0'
provider: aws
service: quicksight
services:
  client: quicksight
  module: boto3.client
discovery:
- discovery_id: aws.quicksight.describe_dashboard
  calls:
  - action: describe_dashboard
    save_as: response
  emit:
    item:
      DashboardId: '{{ response.Dashboard.DashboardId }}'
      Arn: '{{ response.Dashboard.Arn }}'
      Name: '{{ response.Dashboard.Name }}'
      Version: '{{ response.Dashboard.Version }}'
      CreatedTime: '{{ response.Dashboard.CreatedTime }}'
      LastPublishedTime: '{{ response.Dashboard.LastPublishedTime }}'
      LastUpdatedTime: '{{ response.Dashboard.LastUpdatedTime }}'
      LinkEntities: '{{ response.Dashboard.LinkEntities }}'
      IsEnabled: '{{ resource.IsEnabled }}'
      DashboardPublishOptions: '{{ resource.DashboardPublishOptions }}'
      PublicSharingEnabled: '{{ resource.PublicSharingEnabled }}'
      Dashboard: '{{ resource.Dashboard }}'
- discovery_id: aws.quicksight.describe_user
  calls:
  - action: describe_user
    save_as: response
  emit:
    item:
      Arn: '{{ response.User.Arn }}'
      UserName: '{{ response.User.UserName }}'
      Email: '{{ response.User.Email }}'
      Role: '{{ response.User.Role }}'
      IdentityType: '{{ response.User.IdentityType }}'
      Active: '{{ response.User.Active }}'
      PrincipalId: '{{ response.User.PrincipalId }}'
      CustomPermissionsName: '{{ response.User.CustomPermissionsName }}'
      ExternalLoginFederationProviderType: '{{ response.User.ExternalLoginFederationProviderType
        }}'
      ExternalLoginFederationProviderUrl: '{{ response.User.ExternalLoginFederationProviderUrl
        }}'
      ExternalLoginId: '{{ response.User.ExternalLoginId }}'
      User: '{{ resource.User }}'
- discovery_id: aws.quicksight.describe_group
  calls:
  - action: describe_group
    save_as: response
  emit:
    item:
      Arn: '{{ response.Group.Arn }}'
      GroupName: '{{ response.Group.GroupName }}'
      Description: '{{ response.Group.Description }}'
      PrincipalId: '{{ response.Group.PrincipalId }}'
      Group: '{{ resource.Group }}'
- discovery_id: aws.quicksight.describe_data_set
  calls:
  - action: describe_data_set
    save_as: response
  emit:
    item:
      Arn: '{{ response.DataSet.Arn }}'
      DataSetId: '{{ response.DataSet.DataSetId }}'
      Name: '{{ response.DataSet.Name }}'
      CreatedTime: '{{ response.DataSet.CreatedTime }}'
      LastUpdatedTime: '{{ response.DataSet.LastUpdatedTime }}'
      PhysicalTableMap: '{{ response.DataSet.PhysicalTableMap }}'
      LogicalTableMap: '{{ response.DataSet.LogicalTableMap }}'
      OutputColumns: '{{ response.DataSet.OutputColumns }}'
      ImportMode: '{{ response.DataSet.ImportMode }}'
      ConsumedSpiceCapacityInBytes: '{{ response.DataSet.ConsumedSpiceCapacityInBytes
        }}'
      ColumnGroups: '{{ response.DataSet.ColumnGroups }}'
      FieldFolders: '{{ response.DataSet.FieldFolders }}'
      RowLevelPermissionDataSet: '{{ response.DataSet.RowLevelPermissionDataSet }}'
      RowLevelPermissionTagConfiguration: '{{ response.DataSet.RowLevelPermissionTagConfiguration
        }}'
      ColumnLevelPermissionRules: '{{ response.DataSet.ColumnLevelPermissionRules
        }}'
      DataSetUsageConfiguration: '{{ response.DataSet.DataSetUsageConfiguration }}'
      DatasetParameters: '{{ response.DataSet.DatasetParameters }}'
      PerformanceConfiguration: '{{ response.DataSet.PerformanceConfiguration }}'
      UseAs: '{{ response.DataSet.UseAs }}'
      DataPrepConfiguration: '{{ response.DataSet.DataPrepConfiguration }}'
      SemanticModelConfiguration: '{{ response.DataSet.SemanticModelConfiguration
        }}'
      Enabled: '{{ resource.Enabled }}'
      Permissions: '{{ resource.Permissions }}'
      RowLevelPermissionTagConfigurationApplied: '{{ resource.RowLevelPermissionTagConfigurationApplied
        }}'
checks:
- rule_id: aws.quicksight.dataset.public_sharing_disabled
  for_each: aws.quicksight.describe_dashboard
  conditions:
    var: item.PublicSharingEnabled
    op: equals
    value: 'false'
- rule_id: aws.quicksight.dashboard.logs_retention_days_minimum
  for_each: aws.quicksight.describe_dashboard
  conditions:
    var: item.Dashboard
    op: not_equals
    value: 'null'
- rule_id: aws.quicksight.user.quicksight_sso_required
  for_each: aws.quicksight.describe_user
  conditions:
    var: item.User
    op: not_equals
    value: 'null'
- rule_id: aws.quicksight.dashboard.quicksight_sharing_restricted_to_org_configured
  for_each: aws.quicksight.describe_dashboard
  conditions:
    var: item.PublicSharingEnabled
    op: equals
    value: 'false'
- rule_id: aws.quicksight.group.roles_minimal_configured
  for_each: aws.quicksight.describe_group
  conditions:
    var: item.Group
    op: not_equals
    value: 'null'
- rule_id: aws.quicksight.dataset.encryption_at_rest_enabled
  for_each: aws.quicksight.describe_data_set
  conditions:
    var: item.Enabled
    op: equals
    value: 'true'
- rule_id: aws.quicksight.dashboard.admin_activity_logging_enabled
  for_each: aws.quicksight.describe_dashboard
  conditions:
    var: item.IsEnabled
    op: equals
    value: 'true'
- rule_id: aws.quicksight.dataset.row_level_security_enabled
  for_each: aws.quicksight.describe_data_set
  conditions:
    var: item.RowLevelPermissionTagConfigurationApplied
    op: equals
    value: 'true'
- rule_id: aws.quicksight.dataset.access_policies_least_privilege
  for_each: aws.quicksight.describe_data_set
  conditions:
    var: item.Permissions
    op: not_equals
    value: 'null'
- rule_id: aws.quicksight.group.quicksight_external_sharing_restricted
  for_each: aws.quicksight.describe_dashboard
  conditions:
    var: item.PublicSharingEnabled
    op: equals
    value: 'false'
- rule_id: aws.quicksight.dashboard.quicksight_export_controls_enabled
  for_each: aws.quicksight.describe_dashboard
  conditions:
    var: item.DashboardPublishOptions
    op: equals
    value: Enabled
- rule_id: aws.quicksight.dashboard.public_embeds_disabled
  for_each: aws.quicksight.describe_dashboard
  conditions:
    var: item.PublicSharingEnabled
    op: equals
    value: 'false'
- rule_id: aws.quicksight.dashboard.query_access_logging_enabled
  for_each: aws.quicksight.describe_dashboard
  conditions:
    var: item.IsEnabled
    op: equals
    value: 'true'
- rule_id: aws.quicksight.dashboard.quicksight_sso_required
  for_each: aws.quicksight.describe_dashboard
  conditions:
    var: item.DashboardPublishOptions
    op: equals
    value: SSO_REQUIRED
- rule_id: aws.quicksight.user.external_access_reviewed_configured
  for_each: aws.quicksight.describe_dashboard
  conditions:
    var: item.PublicSharingEnabled
    op: equals
    value: 'false'
- rule_id: aws.quicksight.user.roles_minimal_configured
  for_each: aws.quicksight.describe_user
  conditions:
    var: item.User
    op: not_equals
    value: 'null'
