version: '1.0'
provider: aws
service: workspaces
services:
  client: workspaces
  module: boto3.client
discovery:
- discovery_id: aws.workspaces.describe_workspace_directories
  calls:
  - action: describe_workspace_directories
    save_as: response
  emit:
    item:
      DirectoryId: '{{ response.Directories.DirectoryId }}'
      Alias: '{{ response.Directories.Alias }}'
      DirectoryName: '{{ response.Directories.DirectoryName }}'
      RegistrationCode: '{{ response.Directories.RegistrationCode }}'
      SubnetIds: '{{ response.Directories.SubnetIds }}'
      DnsIpAddresses: '{{ response.Directories.DnsIpAddresses }}'
      DnsIpv6Addresses: '{{ response.Directories.DnsIpv6Addresses }}'
      CustomerUserName: '{{ response.Directories.CustomerUserName }}'
      IamRoleId: '{{ response.Directories.IamRoleId }}'
      DirectoryType: '{{ response.Directories.DirectoryType }}'
      WorkspaceSecurityGroupId: '{{ response.Directories.WorkspaceSecurityGroupId
        }}'
      State: '{{ response.Directories.State }}'
      WorkspaceCreationProperties: '{{ response.Directories.WorkspaceCreationProperties
        }}'
      ipGroupIds: '{{ response.Directories.ipGroupIds }}'
      WorkspaceAccessProperties: '{{ response.Directories.WorkspaceAccessProperties
        }}'
      Tenancy: '{{ response.Directories.Tenancy }}'
      SelfservicePermissions: '{{ response.Directories.SelfservicePermissions }}'
      SamlProperties: '{{ response.Directories.SamlProperties }}'
      CertificateBasedAuthProperties: '{{ response.Directories.CertificateBasedAuthProperties
        }}'
      EndpointEncryptionMode: '{{ response.Directories.EndpointEncryptionMode }}'
      MicrosoftEntraConfig: '{{ response.Directories.MicrosoftEntraConfig }}'
      WorkspaceDirectoryName: '{{ response.Directories.WorkspaceDirectoryName }}'
      WorkspaceDirectoryDescription: '{{ response.Directories.WorkspaceDirectoryDescription
        }}'
      UserIdentityType: '{{ response.Directories.UserIdentityType }}'
      WorkspaceType: '{{ response.Directories.WorkspaceType }}'
      IDCConfig: '{{ response.Directories.IDCConfig }}'
      ActiveDirectoryConfig: '{{ response.Directories.ActiveDirectoryConfig }}'
      StreamingProperties: '{{ response.Directories.StreamingProperties }}'
      ErrorMessage: '{{ response.Directories.ErrorMessage }}'
- discovery_id: aws.workspaces.describe_workspaces
  calls:
  - action: describe_workspaces
    save_as: response
  emit:
    item:
      WorkspaceId: '{{ response.Workspaces.WorkspaceId }}'
      DirectoryId: '{{ response.Workspaces.DirectoryId }}'
      UserName: '{{ response.Workspaces.UserName }}'
      IpAddress: '{{ response.Workspaces.IpAddress }}'
      Ipv6Address: '{{ response.Workspaces.Ipv6Address }}'
      State: '{{ response.Workspaces.State }}'
      BundleId: '{{ response.Workspaces.BundleId }}'
      SubnetId: '{{ response.Workspaces.SubnetId }}'
      ErrorMessage: '{{ response.Workspaces.ErrorMessage }}'
      ErrorCode: '{{ response.Workspaces.ErrorCode }}'
      ComputerName: '{{ response.Workspaces.ComputerName }}'
      VolumeEncryptionKey: '{{ response.Workspaces.VolumeEncryptionKey }}'
      UserVolumeEncryptionEnabled: '{{ response.Workspaces.UserVolumeEncryptionEnabled
        }}'
      RootVolumeEncryptionEnabled: '{{ response.Workspaces.RootVolumeEncryptionEnabled
        }}'
      WorkspaceName: '{{ response.Workspaces.WorkspaceName }}'
      WorkspaceProperties: '{{ response.Workspaces.WorkspaceProperties }}'
      ModificationStates: '{{ response.Workspaces.ModificationStates }}'
      RelatedWorkspaces: '{{ response.Workspaces.RelatedWorkspaces }}'
      DataReplicationSettings: '{{ response.Workspaces.DataReplicationSettings }}'
      StandbyWorkspacesProperties: '{{ response.Workspaces.StandbyWorkspacesProperties
        }}'
checks:
- rule_id: aws.workspaces.resource.directory_check_web_access_disabled
  for_each: aws.workspaces.describe_workspace_directories
  conditions:
    var: item.WorkspaceAccessProperties
    op: not_equals
    value: 'null'
- rule_id: aws.workspaces.restapi.public_access_restricted
  for_each: aws.workspaces.describe_workspace_directories
  conditions:
    var: item.WorkspaceAccessProperties
    op: not_equals
    value: 'null'
- rule_id: aws.workspaces.volume.encryption_enabled
  for_each: aws.workspaces.describe_workspaces
  conditions:
    var: item.UserVolumeEncryptionEnabled
    op: equals
    value: 'true'
- rule_id: aws.workspaces.resource.workspaces_directory_enable_maintenance_mode_configured
  for_each: aws.workspaces.describe_workspace_directories
  conditions:
    var: item.WorkspaceDirectoryName
    op: not_equals
    value: 'null'
