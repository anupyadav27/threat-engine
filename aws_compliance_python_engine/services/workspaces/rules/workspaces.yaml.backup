version: '1.0'
provider: aws
service: workspaces
discovery:
- discovery_id: aws.workspaces.describe_workspace_directories
  calls:
  - action: describe_workspace_directories
    save_as: describe_workspace_directories_response
  emit:
    items_for: '{{ describe_workspace_directories_response.Directories }}'
    as: resource
    item:
      directory_id: '{{ resource.DirectoryId }}'
      alias: '{{ resource.Alias }}'
      directory_name: '{{ resource.DirectoryName }}'
      registration_code: '{{ resource.RegistrationCode }}'
      subnet_ids: '{{ resource.SubnetIds }}'
      dns_ip_addresses: '{{ resource.DnsIpAddresses }}'
      dns_ipv6_addresses: '{{ resource.DnsIpv6Addresses }}'
      customer_user_name: '{{ resource.CustomerUserName }}'
      iam_role_id: '{{ resource.IamRoleId }}'
      directory_type: '{{ resource.DirectoryType }}'
- discovery_id: aws.workspaces.describe_workspaces
  calls:
  - action: describe_workspaces
    save_as: describe_workspaces_response
  emit:
    items_for: '{{ describe_workspaces_response.Workspaces }}'
    as: resource
    item:
      workspace_id: '{{ resource.WorkspaceId }}'
      directory_id: '{{ resource.DirectoryId }}'
      user_name: '{{ resource.UserName }}'
      ip_address: '{{ resource.IpAddress }}'
      ipv6_address: '{{ resource.Ipv6Address }}'
      state: '{{ resource.State }}'
      bundle_id: '{{ resource.BundleId }}'
      subnet_id: '{{ resource.SubnetId }}'
      error_message: '{{ resource.ErrorMessage }}'
      error_code: '{{ resource.ErrorCode }}'
- discovery_id: aws.workspaces.describe_applications
  calls:
  - action: describe_applications
    save_as: describe_applications_response
  emit:
    items_for: '{{ describe_applications_response.Applications }}'
    as: resource
    item:
      application_id: '{{ resource.ApplicationId }}'
      created: '{{ resource.Created }}'
      description: '{{ resource.Description }}'
      license_type: '{{ resource.LicenseType }}'
      name: '{{ resource.Name }}'
      owner: '{{ resource.Owner }}'
      state: '{{ resource.State }}'
      supported_compute_type_names: '{{ resource.SupportedComputeTypeNames }}'
      supported_operating_system_names: '{{ resource.SupportedOperatingSystemNames
        }}'
checks:
- rule_id: aws.workspaces.resource.directory_check_web_access_disabled
  for_each: aws.workspaces.describe_workspace_directories
  conditions:
    var: item.workspace_access_properties
    op: equals
    value:
      DeviceTypeWeb: DISABLED
- rule_id: aws.workspaces.restapi.public_access_restricted
  for_each: aws.workspaces.describe_workspace_directories
  conditions:
    var: item.workspace_access_properties
    op: equals
    value:
      DeviceTypeWindows: DENY
      DeviceTypeOsx: DENY
      DeviceTypeWeb: DENY
      DeviceTypeIos: DENY
      DeviceTypeAndroid: DENY
      DeviceTypeChromeOs: DENY
      DeviceTypeZeroClient: DENY
      DeviceTypeLinux: DENY
- rule_id: aws.workspaces.volume.encryption_enabled
  for_each: aws.workspaces.describe_workspaces
  conditions:
    all:
    - var: item.user_volume_encryption_enabled
      op: equals
      value: true
    - var: item.root_volume_encryption_enabled
      op: equals
      value: true
- rule_id: aws.workspaces.resource.workspaces_directory_enable_maintenance_mode_configured
  for_each: aws.workspaces.describe_applications
  conditions:
    var: item.state
    op: equals
    value: ENABLED
