version: '1.0'
provider: aws
service: ebs
services:
  client: ebs
  module: boto3.client
discovery:
- discovery_id: aws.ebs.list_changed_blocks
  calls:
  - action: list_changed_blocks
    save_as: response
  emit:
    items_for: '{{ response.ChangedBlocks }}'
    as: resource
    item:
      BlockIndex: '{{ resource.BlockIndex }}'
      FirstBlockToken: '{{ resource.FirstBlockToken }}'
      SecondBlockToken: '{{ resource.SecondBlockToken }}'
- discovery_id: aws.ebs.list_snapshot_blocks
  calls:
  - action: list_snapshot_blocks
    save_as: response
    params:
      SnapshotId: '{{ item.SnapshotId }}'
  on_error: continue
  for_each: aws.ebs.start_snapshot
  emit:
    items_for: '{{ response.Blocks }}'
    as: resource
    item:
      BlockIndex: '{{ resource.BlockIndex }}'
      BlockToken: '{{ resource.BlockToken }}'
- discovery_id: aws.ebs.start_snapshot
  calls:
  - action: start_snapshot
    save_as: response
    params:
      VolumeSize: '{{ item.VolumeSize }}'
  on_error: continue
  for_each: aws.ebs.list_snapshot_blocks
  emit:
    item:
      Key: '{{ response.Tags.Key }}'
      Value: '{{ response.Tags.Value }}'
checks:
- rule_id: aws.ebs.volume.snapshots_not_public_configured
  for_each: aws.ebs.list_snapshot_blocks
  conditions:
    var: item.BlockToken
    op: exists
- rule_id: aws.ebs.volume.backup_configured
  for_each: aws.ebs.start_snapshot
  conditions:
    var: item.Key
    op: exists
- rule_id: aws.ebs.volume.snapshots_encrypted
  for_each: aws.ebs.start_snapshot
  conditions:
    var: item.Key
    op: exists
- rule_id: aws.ebs.snapshot.ebs_cmk_cmek_configured
  for_each: aws.ebs.start_snapshot
  conditions:
    var: item.Key
    op: exists
- rule_id: aws.ebs.volume.ebs_cmk_cmek_configured
  for_each: aws.ebs.start_snapshot
  conditions:
    var: item.Key
    op: exists
- rule_id: aws.ebs.snapshot.not_public_configured
  for_each: aws.ebs.list_changed_blocks
  conditions:
    var: item.BlockIndex
    op: exists
- rule_id: aws.ebs.snapshot.encryption_at_rest_enabled
  for_each: aws.ebs.start_snapshot
  conditions:
    var: item.Key
    op: exists
- rule_id: aws.ebs.snapshot.ebs_s_encrypted
  for_each: aws.ebs.start_snapshot
  conditions:
    var: item.Key
    op: equals
    value: Encrypted
- rule_id: aws.ebs.snapshot.s_not_public_configured
  for_each: aws.ebs.list_snapshot_blocks
  conditions:
    var: item.BlockToken
    op: exists
- rule_id: aws.ebs.snapshot.snapshots_not_public_configured
  for_each: aws.ebs.list_snapshot_blocks
  conditions:
    var: item.BlockToken
    op: equals
    value: []
- rule_id: aws.ebs.snapshot.snapshots_encrypted
  for_each: aws.ebs.start_snapshot
  conditions:
    var: item.Key
    op: equals
    value: Encrypted
- rule_id: aws.ebs.snapshot.ebs_cross_region_copy_encrypted
  for_each: aws.ebs.start_snapshot
  conditions:
    var: item.Key
    op: exists
