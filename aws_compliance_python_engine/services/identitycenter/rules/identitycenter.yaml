version: '1.0'
provider: aws
service: identitycenter
services:
  client: identitycenter
  module: boto3.client
discovery:
- discovery_id: aws.identitycenter.list_accounts
  calls:
  - action: list_accounts
    save_as: response
  emit:
    items_for: '{{ response.accountList }}'
    as: resource
    item:
      accountId: '{{ resource.accountId }}'
      accountName: '{{ resource.accountName }}'
      emailAddress: '{{ resource.emailAddress }}'
      roleName: '{{ resource.roleName }}'
- discovery_id: aws.identitycenter.list_account_roles
  calls:
  - action: list_account_roles
    save_as: response
    params:
      accountId: '{{ item.accountId }}'
  for_each: aws.identitycenter.list_accounts
  on_error: continue
  emit:
    items_for: '{{ response.roleList }}'
    as: resource
    item:
      roleName: '{{ resource.roleName }}'
      accountId: '{{ resource.accountId }}'
- discovery_id: aws.identitycenter.get_role_credentials
  calls:
  - action: get_role_credentials
    save_as: response
    params:
      roleName: '{{ item.roleName }}'
      accountId: '{{ item.accountId }}'
  for_each: aws.identitycenter.list_account_roles
  on_error: continue
  emit:
    item:
      accessKeyId: '{{ response.roleCredentials.accessKeyId }}'
      secretAccessKey: '{{ response.roleCredentials.secretAccessKey }}'
      sessionToken: '{{ response.roleCredentials.sessionToken }}'
      expiration: '{{ response.roleCredentials.expiration }}'
      roleCredentials: '{{ resource.roleCredentials }}'
checks:
- rule_id: aws.identitycenter.permissionset.identitycenter_trust_principals_allowlist_only_configured
  for_each: aws.identitycenter.list_accounts
  conditions:
    var: item.roleName
    op: not_equals
    value: 'null'
- rule_id: aws.identitycenter.permissionset.max_session_duration_configured
  for_each: aws.identitycenter.get_role_credentials
  conditions:
    var: item.expiration
    op: greater_than
    value: '0'
- rule_id: aws.identitycenter.permissionset.scopes_or_roles_least_privilege
  for_each: aws.identitycenter.get_role_credentials
  conditions:
    var: item.roleCredentials
    op: not_equals
    value: 'null'
- rule_id: aws.identitycenter.permissionset.identitycenter_workload_identity_federation_used_if_supported
  for_each: aws.identitycenter.get_role_credentials
  conditions:
    var: item.roleCredentials
    op: not_equals
    value: 'null'
- rule_id: aws.identitycenter.permissionset.identitycenter_no_inline_policies_configured
  for_each: aws.identitycenter.get_role_credentials
  conditions:
    var: item.roleCredentials
    op: not_equals
    value: 'null'
- rule_id: aws.identitycenter.permissionset.keys_not_used_or_rotated_90_days_or_less_configured
  for_each: aws.identitycenter.get_role_credentials
  conditions:
    var: item.expiration
    op: less_than
    value: '90'
- rule_id: aws.identitycenter.user.console_password_present_only_if_required
  for_each: aws.identitycenter.get_role_credentials
  conditions:
    var: item.roleCredentials
    op: not_equals
    value: 'null'
- rule_id: aws.identitycenter.user.access_keys_rotated_90_days_or_less_when_present
  for_each: aws.identitycenter.get_role_credentials
  conditions:
    var: item.expiration
    op: less_than
    value: '90'
- rule_id: aws.identitycenter.permissionset.session_duration_reasonable_if_applicable_configured
  for_each: aws.identitycenter.get_role_credentials
  conditions:
    var: item.expiration
    op: greater_than
    value: '3600'
- rule_id: aws.identitycenter.user.identitycenter_no_inline_policies_enabled
  for_each: aws.identitycenter.get_role_credentials
  conditions:
    var: item.roleCredentials
    op: not_equals
    value: 'null'
- rule_id: aws.identitycenter.group.identitycenter_membership_review_enabled_if_supported
  for_each: aws.identitycenter.get_role_credentials
  conditions:
    var: item.roleCredentials
    op: not_equals
    value: 'null'
- rule_id: aws.identitycenter.group.identitycenter_external_sharing_restricted_if_supported
  for_each: aws.identitycenter.list_accounts
  conditions:
    var: item.accountId
    op: not_equals
    value: 'null'
- rule_id: aws.identitycenter.user.identitycenter_inactive_90_days_disabled
  for_each: aws.identitycenter.get_role_credentials
  conditions:
    var: item.expiration
    op: less_than
    value: '90'
- rule_id: aws.identitycenter.group.identitycenter_attached_policies_not_admin_star_configured
  for_each: aws.identitycenter.get_role_credentials
  conditions:
    var: item.roleCredentials
    op: not_equals
    value: 'null'
- rule_id: aws.identitycenter.group.identitycenter_no_inline_policies_configured
  for_each: aws.identitycenter.get_role_credentials
  conditions:
    var: item.roleCredentials
    op: not_equals
    value: 'null'
- rule_id: aws.identitycenter.user.mfa_required
  for_each: aws.identitycenter.get_role_credentials
  conditions:
    var: item.roleCredentials
    op: not_equals
    value: 'null'
- rule_id: aws.identitycenter.permissionset.identitycenter_trust_external_id_or_audience_required
  for_each: aws.identitycenter.list_accounts
  conditions:
    var: item.roleName
    op: not_equals
    value: 'null'
- rule_id: aws.identitycenter.permissionset.identitycenter_attached_policies_not_admin_star_configured
  for_each: aws.identitycenter.list_accounts
  conditions:
    var: item.roleName
    op: not_equals
    value: '*'
- rule_id: aws.identitycenter.permissionset.no_user_managed_long_lived_keys_configured
  for_each: aws.identitycenter.get_role_credentials
  conditions:
    var: item.accessKeyId
    op: not_equals
    value: 'null'
