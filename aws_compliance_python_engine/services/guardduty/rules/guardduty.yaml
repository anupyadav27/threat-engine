version: '1.0'
provider: aws
service: guardduty
discovery:
- discovery_id: aws.guardduty.iss
  calls:
  - client: guardduty
    action: list_detectors
    save_as: is_list
    on_error: continue
    fields:
    - Guarddutys
  emit:
    items_for: is_list[]
    as: is
    item:
      id: '{{ is.Id }}'
      name: '{{ is.Name }}'
- discovery_id: aws.guardduty.is_encryption
  for_each: aws.guardduty.iss
  calls:
  - client: guardduty
    action: list_detectors
    params:
      IsId: '{{ item.id }}'
    save_as: encryption
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      encryption_enabled: '{{ encryption.Encrypted if encryption.Encrypted is defined
        else false }}'
- discovery_id: aws.guardduty.is_logging
  for_each: aws.guardduty.iss
  calls:
  - client: guardduty
    action: describe_malware_scans
    params:
      IsId: '{{ item.id }}'
    save_as: logging
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      logging_enabled: '{{ logging.LoggingEnabled is defined if logging else false
        }}'
- discovery_id: aws.guardduty.resources
  for_each: aws.guardduty.resource
  calls:
  - client: guardduty
    action: describe_malware_scans
    save_as: resources
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.guardduty.custom_identifier_encryption
  calls:
  - client: guardduty
    action: list_coverage
    save_as: custom_identifier_encryption
    on_error: continue
  emit:
    items_for: custom_identifier_encryption[]
    as: custom_identifier_encryption
    item:
      id: '{{ custom_identifier_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.guardduty.findings
  for_each: aws.guardduty.finding
  calls:
  - client: guardduty
    action: describe_malware_scans
    save_as: findings
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.guardduty.centrally_manageds
  for_each: aws.guardduty.centrally_managed
  calls:
  - client: guardduty
    action: describe_malware_scans
    save_as: centrally_manageds
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.guardduty.ipsets
  for_each: aws.guardduty.ipset
  calls:
  - client: guardduty
    action: describe_malware_scans
    save_as: ipsets
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.guardduty.nos
  for_each: aws.guardduty.no
  calls:
  - client: guardduty
    action: describe_malware_scans
    save_as: nos
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.guardduty.resource_logging
  calls:
  - client: guardduty
    action: list_coverage
    save_as: resource_logging
    on_error: continue
  emit:
    items_for: resource_logging[]
    as: resource_logging
    item:
      id: '{{ resource_logging.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.guardduty.finding_encryption
  calls:
  - client: guardduty
    action: list_coverage
    save_as: finding_encryption
    on_error: continue
  emit:
    items_for: finding_encryption[]
    as: finding_encryption
    item:
      id: '{{ finding_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.guardduty.custom_identifiers
  for_each: aws.guardduty.custom_identifier
  calls:
  - client: guardduty
    action: describe_malware_scans
    save_as: custom_identifiers
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.guardduty.no_high_severity_findingss
  for_each: aws.guardduty.no_high_severity_finding
  calls:
  - client: guardduty
    action: describe_malware_scans
    save_as: no_high_severity_findingss
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.guardduty.detectors
  for_each: aws.guardduty.detector
  calls:
  - client: guardduty
    action: describe_malware_scans
    save_as: detectors
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.guardduty.detector_encryption
  calls:
  - client: guardduty
    action: list_coverage
    save_as: detector_encryption
    on_error: continue
  emit:
    items_for: detector_encryption[]
    as: detector_encryption
    item:
      id: '{{ detector_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.guardduty.ipset_encryption
  calls:
  - client: guardduty
    action: list_coverage
    save_as: ipset_encryption
    on_error: continue
  emit:
    items_for: ipset_encryption[]
    as: ipset_encryption
    item:
      id: '{{ ipset_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.guardduty.resource_encryption
  calls:
  - client: guardduty
    action: list_coverage
    save_as: resource_encryption
    on_error: continue
  emit:
    items_for: resource_encryption[]
    as: resource_encryption
    item:
      id: '{{ resource_encryption.Id }}'
      compliant: '{{ true }}'
checks:
- title: 'GUARDDUTY resource: Security Center Enabled'
  severity: medium
  rule_id: aws.guardduty.resource.security_center_enabled
  for_each:
    discovery: aws.guardduty.resources
    as: resource
    item: resource
  conditions:
    var: resource.compliant
    op: equals
    value: true
- title: 'GUARDDUTY finding: Guardduty Finding Archival Export Encrypted'
  severity: high
  rule_id: aws.guardduty.finding.guardduty_finding_archival_export_encrypted
  for_each:
    discovery: aws.guardduty.finding_encryption
    as: finding
    item: finding
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'GUARDDUTY no: Guardduty Finding High Severity Findings Configured'
  severity: medium
  rule_id: aws.guardduty.no.guardduty_finding_high_severity_findings_configured
  for_each:
    discovery: aws.guardduty.nos
    as: 'no'
    item: 'no'
  conditions:
    var: no.compliant
    op: equals
    value: true
- title: 'GUARDDUTY resource: Guardduty Vulnerability Assessment Enabled'
  severity: medium
  rule_id: aws.guardduty.resource.guardduty_vulnerability_assessment_enabled
  for_each:
    discovery: aws.guardduty.resource_encryption
    as: resource
    item: resource
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'GUARDDUTY finding: Guardduty Finding Export Destinations Private Configured'
  severity: high
  rule_id: aws.guardduty.finding.guardduty_finding_export_destinations_private_configured
  for_each:
    discovery: aws.guardduty.findings
    as: finding
    item: finding
  conditions:
    var: finding.in_vpc
    op: equals
    value: true
- title: 'GUARDDUTY ipset: Guardduty Storage Encrypted'
  severity: high
  rule_id: aws.guardduty.ipset.guardduty_storage_encrypted
  for_each:
    discovery: aws.guardduty.ipset_encryption
    as: ipset
    item: ipset
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'GUARDDUTY finding: Guardduty Finding Suppression Rules Documented And Scoped
    Configured'
  severity: medium
  rule_id: aws.guardduty.finding.guardduty_finding_suppression_rules_documented_and_scoped_configured
  for_each:
    discovery: aws.guardduty.findings
    as: finding
    item: finding
  conditions:
    var: finding.compliant
    op: equals
    value: true
- title: 'GUARDDUTY finding: Rbac Least Privilege'
  severity: high
  rule_id: aws.guardduty.finding.rbac_least_privilege
  for_each:
    discovery: aws.guardduty.findings
    as: finding
    item: finding
  conditions:
    var: finding.is_public
    op: equals
    value: false
- title: 'GUARDDUTY detector: Guardduty Detector Enabled In All Regions'
  severity: medium
  rule_id: aws.guardduty.detector.guardduty_detector_enabled_in_all_regions
  for_each:
    discovery: aws.guardduty.detectors
    as: detector
    item: detector
  conditions:
    var: detector.compliant
    op: equals
    value: true
- title: 'GUARDDUTY ipset: Guardduty Detector Used By Detectors Configured'
  severity: medium
  rule_id: aws.guardduty.ipset.guardduty_detector_used_by_detectors_configured
  for_each:
    discovery: aws.guardduty.ipsets
    as: ipset
    item: ipset
  conditions:
    var: ipset.compliant
    op: equals
    value: true
- title: 'GUARDDUTY detector: Guardduty Detector S Enabled'
  severity: medium
  rule_id: aws.guardduty.detector.guardduty_detector_s_enabled
  for_each:
    discovery: aws.guardduty.detectors
    as: detector
    item: detector
  conditions:
    var: detector.compliant
    op: equals
    value: true
- title: 'GUARDDUTY finding: Guardduty Finding Reports Storage Encrypted'
  severity: high
  rule_id: aws.guardduty.finding.guardduty_finding_reports_storage_encrypted
  for_each:
    discovery: aws.guardduty.finding_encryption
    as: finding
    item: finding
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'GUARDDUTY detector: Guardduty Detectors Enabled'
  severity: medium
  rule_id: aws.guardduty.detector.guardduty_detectors_enabled
  for_each:
    discovery: aws.guardduty.detectors
    as: detector
    item: detector
  conditions:
    var: detector.compliant
    op: equals
    value: true
- title: 'GUARDDUTY resource: Eks Audit Log Enabled'
  severity: medium
  rule_id: aws.guardduty.resource.eks_audit_log_enabled
  for_each:
    discovery: aws.guardduty.resource_logging
    as: resource
    item: resource
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'GUARDDUTY is: Guardduty Enabled'
  severity: medium
  rule_id: aws.guardduty.is.guardduty_enabled
  for_each:
    discovery: aws.guardduty.iss
    as: is
    item: is
  conditions:
    var: is.compliant
    op: equals
    value: true
- title: 'GUARDDUTY custom identifier: Guardduty Storage Encrypted'
  severity: high
  rule_id: aws.guardduty.custom_identifier.guardduty_storage_encrypted
  for_each:
    discovery: aws.guardduty.custom_identifier_encryption
    as: custom_identifier
    item: custom_identifier
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'GUARDDUTY detector: Finding Detector Finding Export Encrypted Destination'
  severity: high
  rule_id: aws.guardduty.detector.finding_detector_finding_export_encrypted_destination
  for_each:
    discovery: aws.guardduty.detector_encryption
    as: detector
    item: detector
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'GUARDDUTY detector: Guardduty Detector Destinations Encrypted'
  severity: high
  rule_id: aws.guardduty.detector.guardduty_detector_destinations_encrypted
  for_each:
    discovery: aws.guardduty.detector_encryption
    as: detector
    item: detector
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'GUARDDUTY finding: Alert Destinations Configured'
  severity: medium
  rule_id: aws.guardduty.finding.alert_destinations_configured
  for_each:
    discovery: aws.guardduty.findings
    as: finding
    item: finding
  conditions:
    var: finding.monitoring_enabled
    op: equals
    value: true
- title: 'GUARDDUTY custom identifier: Guardduty Source Trusted Configured'
  severity: medium
  rule_id: aws.guardduty.custom_identifier.guardduty_source_trusted_configured
  for_each:
    discovery: aws.guardduty.custom_identifiers
    as: custom_identifier
    item: custom_identifier
  conditions:
    var: custom_identifier.compliant
    op: equals
    value: true
- title: 'GUARDDUTY centrally managed: Guardduty Centrally Managed Configured'
  severity: medium
  rule_id: aws.guardduty.centrally_managed.guardduty_centrally_managed_configured
  for_each:
    discovery: aws.guardduty.centrally_manageds
    as: centrally_managed
    item: centrally_managed
  conditions:
    var: centrally_managed.compliant
    op: equals
    value: true
- title: 'GUARDDUTY ipset: Guardduty Sources Trusted Configured'
  severity: medium
  rule_id: aws.guardduty.ipset.guardduty_sources_trusted_configured
  for_each:
    discovery: aws.guardduty.ipsets
    as: ipset
    item: ipset
  conditions:
    var: ipset.compliant
    op: equals
    value: true
- title: 'GUARDDUTY resource: Guardduty Enabled'
  severity: medium
  rule_id: aws.guardduty.resource.guardduty_enabled
  for_each:
    discovery: aws.guardduty.resources
    as: resource
    item: resource
  conditions:
    var: resource.compliant
    op: equals
    value: true
- title: 'GUARDDUTY no high severity findings: Guardduty Finding No High Severity
    Findings Configured'
  severity: medium
  rule_id: aws.guardduty.no_high_severity_findings.guardduty_finding_no_high_severity_findings_configured
  for_each:
    discovery: aws.guardduty.no_high_severity_findingss
    as: no_high_severity_findings
    item: no_high_severity_findings
  conditions:
    var: no_high_severity_findings.compliant
    op: equals
    value: true
