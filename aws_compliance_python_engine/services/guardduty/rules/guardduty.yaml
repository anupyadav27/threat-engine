version: '1.0'
provider: aws
service: guardduty
services:
  client: guardduty
  module: boto3.client
discovery:
- discovery_id: aws.guardduty.describe_organization_configuration
  calls:
  - action: describe_organization_configuration
    save_as: response
    params:
      DetectorId: '{{ item.DetectorId }}'
  on_error: continue
  for_each: aws.guardduty.get_malware_scan
  emit:
    item:
      Name: '{{ response.Features.Name }}'
      AutoEnable: '{{ response.Features.AutoEnable }}'
      AdditionalConfiguration: '{{ response.Features.AdditionalConfiguration }}'
- discovery_id: aws.guardduty.describe_publishing_destination
  calls:
  - action: describe_publishing_destination
    save_as: response
    params:
      DetectorId: '{{ item.DetectorId }}'
      DestinationId: '{{ item.DestinationId }}'
  on_error: continue
  for_each: aws.guardduty.get_malware_scan
  emit:
    item:
      DestinationArn: '{{ response.DestinationProperties.DestinationArn }}'
      KmsKeyArn: '{{ response.DestinationProperties.KmsKeyArn }}'
- discovery_id: aws.guardduty.get_detector
  calls:
  - action: get_detector
    save_as: response
    params:
      DetectorId: '{{ item.DetectorId }}'
  on_error: continue
  for_each: aws.guardduty.get_malware_scan
  emit:
    item:
      Name: '{{ response.Features.Name }}'
      Status: '{{ response.Features.Status }}'
      UpdatedAt: '{{ response.Features.UpdatedAt }}'
      AdditionalConfiguration: '{{ response.Features.AdditionalConfiguration }}'
- discovery_id: aws.guardduty.get_findings
  calls:
  - action: get_findings
    save_as: response
    params:
      DetectorId: '{{ item.DetectorId }}'
      FindingIds: '{{ item.FindingIds }}'
  on_error: continue
  for_each: aws.guardduty.get_malware_scan
  emit:
    item:
      AccountId: '{{ response.Findings.AccountId }}'
      Arn: '{{ response.Findings.Arn }}'
      Confidence: '{{ response.Findings.Confidence }}'
      CreatedAt: '{{ response.Findings.CreatedAt }}'
      Description: '{{ response.Findings.Description }}'
      Id: '{{ response.Findings.Id }}'
      Partition: '{{ response.Findings.Partition }}'
      Region: '{{ response.Findings.Region }}'
      Resource: '{{ response.Findings.Resource }}'
      SchemaVersion: '{{ response.Findings.SchemaVersion }}'
      Service: '{{ response.Findings.Service }}'
      Severity: '{{ response.Findings.Severity }}'
      Title: '{{ response.Findings.Title }}'
      Type: '{{ response.Findings.Type }}'
      UpdatedAt: '{{ response.Findings.UpdatedAt }}'
      AssociatedAttackSequenceArn: '{{ response.Findings.AssociatedAttackSequenceArn
        }}'
- discovery_id: aws.guardduty.get_malware_scan
  calls:
  - action: get_malware_scan
    save_as: response
    params:
      ScanId: '{{ item.ScanId }}'
  on_error: continue
  for_each: aws.guardduty.list_malware_scans
  emit:
    item:
      ScannedResourceArn: '{{ response.ScannedResources.ScannedResourceArn }}'
      ScannedResourceType: '{{ response.ScannedResources.ScannedResourceType }}'
      ScannedResourceStatus: '{{ response.ScannedResources.ScannedResourceStatus }}'
      ScanStatusReason: '{{ response.ScannedResources.ScanStatusReason }}'
      ResourceDetails: '{{ response.ScannedResources.ResourceDetails }}'
- discovery_id: aws.guardduty.list_findings
  calls:
  - action: list_findings
    save_as: response
    params:
      DetectorId: '{{ item.DetectorId }}'
  on_error: continue
  for_each: aws.guardduty.get_malware_scan
- discovery_id: aws.guardduty.list_publishing_destinations
  calls:
  - action: list_publishing_destinations
    save_as: response
    params:
      DetectorId: '{{ item.DetectorId }}'
  on_error: continue
  for_each: aws.guardduty.get_malware_scan
  emit:
    items_for: '{{ response.Destinations }}'
    as: resource
    item:
      DestinationId: '{{ resource.DestinationId }}'
      DestinationType: '{{ resource.DestinationType }}'
      Status: '{{ resource.Status }}'
checks:
- rule_id: aws.guardduty.resource.security_center_enabled
  for_each: aws.guardduty.describe_organization_configuration
  conditions:
    var: item.AutoEnable
    op: equals
    value: true
- rule_id: aws.guardduty.finding.guardduty_finding_archival_export_encrypted
  for_each: aws.guardduty.describe_publishing_destination
  conditions:
    var: item.KmsKeyArn
    op: exists
- rule_id: aws.guardduty.no.guardduty_finding_high_severity_findings_configured
  for_each: aws.guardduty.get_findings
  conditions:
    var: item.count_by_severity
    op: gt
    value: 0
- rule_id: aws.guardduty.resource.guardduty_vulnerability_assessment_enabled
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.guardduty.ipset.guardduty_storage_encrypted
  for_each: aws.guardduty.describe_publishing_destination
  conditions:
    var: item.KmsKeyArn
    op: exists
- rule_id: aws.guardduty.detector.guardduty_detector_enabled_in_all_regions
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.guardduty.detector.guardduty_detector_s_enabled
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.guardduty.finding.guardduty_finding_reports_storage_encrypted
  for_each: aws.guardduty.describe_publishing_destination
  conditions:
    var: item.KmsKeyArn
    op: exists
- rule_id: aws.guardduty.detector.guardduty_detectors_enabled
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.guardduty.resource.eks_audit_log_enabled
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.guardduty.is.guardduty_enabled
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.guardduty.custom_identifier.guardduty_storage_encrypted
  for_each: aws.guardduty.describe_publishing_destination
  conditions:
    var: item.KmsKeyArn
    op: exists
- rule_id: aws.guardduty.detector.finding_detector_finding_export_encrypted_destination
  for_each: aws.guardduty.describe_publishing_destination
  conditions:
    var: item.KmsKeyArn
    op: exists
- rule_id: aws.guardduty.detector.guardduty_detector_destinations_encrypted
  for_each: aws.guardduty.describe_publishing_destination
  conditions:
    var: item.KmsKeyArn
    op: exists
- rule_id: aws.guardduty.finding.alert_destinations_configured
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.guardduty.ipset.guardduty_sources_trusted_configured
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.Status
    op: equals
    value: ACTIVE
- rule_id: aws.guardduty.resource.guardduty_enabled
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.guardduty.no_high_severity_findings.guardduty_finding_no_high_severity_findings_configured
  for_each: aws.guardduty.get_findings
  conditions:
    var: item.count_by_severity
    op: equals
    value:
      HIGH: 0
