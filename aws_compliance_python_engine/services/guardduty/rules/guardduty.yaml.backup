version: '1.0'
provider: aws
service: guardduty
discovery:
- discovery_id: aws.guardduty.describe_organization_configuration
  calls:
  - action: describe_organization_configuration
    save_as: describe_organization_configuration_response
    params:
      DetectorId: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.guardduty.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      name: '{{ describe_organization_configuration_response.Features.Name }}'
      auto_enable: '{{ describe_organization_configuration_response.Features.AutoEnable
        }}'
      additional_configuration: '{{ describe_organization_configuration_response.Features.AdditionalConfiguration
        }}'
- discovery_id: aws.guardduty.describe_publishing_destination
  calls:
  - action: describe_publishing_destination
    save_as: describe_publishing_destination_response
    params:
      DetectorId: '{{ item.FIELD_NAME }}'
      DestinationId: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.guardduty.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      destination_arn: '{{ describe_publishing_destination_response.DestinationProperties.DestinationArn
        }}'
      kms_key_arn: '{{ describe_publishing_destination_response.DestinationProperties.KmsKeyArn
        }}'
- discovery_id: aws.guardduty.get_findings_statistics
  calls:
  - action: get_findings_statistics
    save_as: get_findings_statistics_response
    params:
      DetectorId: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.guardduty.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      count_by_severity: '{{ get_findings_statistics_response.FindingStatistics.CountBySeverity
        }}'
      grouped_by_account: '{{ get_findings_statistics_response.FindingStatistics.GroupedByAccount
        }}'
      grouped_by_date: '{{ get_findings_statistics_response.FindingStatistics.GroupedByDate
        }}'
      grouped_by_finding_type: '{{ get_findings_statistics_response.FindingStatistics.GroupedByFindingType
        }}'
      grouped_by_resource: '{{ get_findings_statistics_response.FindingStatistics.GroupedByResource
        }}'
- discovery_id: aws.guardduty.get_detector
  calls:
  - action: get_detector
    save_as: get_detector_response
    params:
      DetectorId: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.guardduty.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      name: '{{ get_detector_response.Features.Name }}'
      status: '{{ get_detector_response.Features.Status }}'
      updated_at: '{{ get_detector_response.Features.UpdatedAt }}'
      additional_configuration: '{{ get_detector_response.Features.AdditionalConfiguration
        }}'
- discovery_id: aws.guardduty.list_publishing_destinations
  calls:
  - action: list_publishing_destinations
    save_as: list_publishing_destinations_response
    params:
      DetectorId: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.guardduty.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      destination_id: '{{ list_publishing_destinations_response.Destinations.DestinationId
        }}'
      destination_type: '{{ list_publishing_destinations_response.Destinations.DestinationType
        }}'
      status: '{{ list_publishing_destinations_response.Destinations.Status }}'
checks:
- rule_id: aws.guardduty.resource.security_center_enabled
  for_each: aws.guardduty.describe_organization_configuration
  conditions:
    var: item.auto_enable
    op: equals
    value: true
- rule_id: aws.guardduty.finding.guardduty_finding_archival_export_encrypted
  for_each: aws.guardduty.describe_publishing_destination
  conditions:
    var: item.kms_key_arn
    op: exists
- rule_id: aws.guardduty.no.guardduty_finding_high_severity_findings_configured
  for_each: aws.guardduty.get_findings_statistics
  conditions:
    var: item.count_by_severity
    op: gt
    value: 0
- rule_id: aws.guardduty.resource.guardduty_vulnerability_assessment_enabled
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.guardduty.finding.guardduty_finding_export_destinations_private_configured
  for_each: aws.guardduty.list_publishing_destinations
  conditions:
    all:
    - var: item.status
      op: equals
      value: ACTIVE
    - var: item.destination_type
      op: equals
      value: S3
- rule_id: aws.guardduty.ipset.guardduty_storage_encrypted
  for_each: aws.guardduty.describe_publishing_destination
  conditions:
    var: item.kms_key_arn
    op: exists
- rule_id: aws.guardduty.detector.guardduty_detector_enabled_in_all_regions
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.guardduty.ipset.guardduty_detector_used_by_detectors_configured
  for_each: aws.guardduty.get_detector
  conditions:
    all:
    - var: item.status
      op: equals
      value: ENABLED
    - var: item.additional_configuration
      op: exists
- rule_id: aws.guardduty.detector.guardduty_detector_s_enabled
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.guardduty.finding.guardduty_finding_reports_storage_encrypted
  for_each: aws.guardduty.describe_publishing_destination
  conditions:
    var: item.kms_key_arn
    op: exists
- rule_id: aws.guardduty.detector.guardduty_detectors_enabled
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.guardduty.resource.eks_audit_log_enabled
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.guardduty.is.guardduty_enabled
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.guardduty.custom_identifier.guardduty_storage_encrypted
  for_each: aws.guardduty.describe_publishing_destination
  conditions:
    var: item.kms_key_arn
    op: exists
- rule_id: aws.guardduty.detector.finding_detector_finding_export_encrypted_destination
  for_each: aws.guardduty.describe_publishing_destination
  conditions:
    var: item.kms_key_arn
    op: exists
- rule_id: aws.guardduty.detector.guardduty_detector_destinations_encrypted
  for_each: aws.guardduty.describe_publishing_destination
  conditions:
    var: item.kms_key_arn
    op: exists
- rule_id: aws.guardduty.finding.alert_destinations_configured
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.guardduty.ipset.guardduty_sources_trusted_configured
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.status
    op: equals
    value: ACTIVE
- rule_id: aws.guardduty.resource.guardduty_enabled
  for_each: aws.guardduty.get_detector
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.guardduty.no_high_severity_findings.guardduty_finding_no_high_severity_findings_configured
  for_each: aws.guardduty.get_findings_statistics
  conditions:
    var: item.count_by_severity
    op: equals
    value:
      HIGH: 0
