version: '1.0'
provider: aws
service: rds
discovery:
- discovery_id: aws.rds.describe_db_security_groups
  calls:
  - action: describe_db_security_groups
    save_as: describe_db_security_groups_response
  emit:
    items_for: '{{ describe_db_security_groups_response.DBSecurityGroups }}'
    as: resource
    item:
      owner_id: '{{ resource.OwnerId }}'
      db_security_group_name: '{{ resource.DBSecurityGroupName }}'
      db_security_group_description: '{{ resource.DBSecurityGroupDescription }}'
      vpc_id: '{{ resource.VpcId }}'
      ec2_security_groups: '{{ resource.EC2SecurityGroups }}'
      ip_ranges: '{{ resource.IPRanges }}'
      db_security_group_arn: '{{ resource.DBSecurityGroupArn }}'
- discovery_id: aws.rds.describe_db_cluster_automated_backups
  calls:
  - action: describe_db_cluster_automated_backups
    save_as: describe_db_cluster_automated_backups_response
  emit:
    items_for: '{{ describe_db_cluster_automated_backups_response.DBClusterAutomatedBackups
      }}'
    as: resource
    item:
      engine: '{{ resource.Engine }}'
      vpc_id: '{{ resource.VpcId }}'
      db_cluster_automated_backups_arn: '{{ resource.DBClusterAutomatedBackupsArn
        }}'
      db_cluster_identifier: '{{ resource.DBClusterIdentifier }}'
      restore_window: '{{ resource.RestoreWindow }}'
      master_username: '{{ resource.MasterUsername }}'
      db_cluster_resource_id: '{{ resource.DbClusterResourceId }}'
      region: '{{ resource.Region }}'
      license_model: '{{ resource.LicenseModel }}'
      status: '{{ resource.Status }}'
- discovery_id: aws.rds.describe_db_clusters
  calls:
  - action: describe_db_clusters
    save_as: describe_db_clusters_response
  emit:
    items_for: '{{ describe_db_clusters_response.DBClusters }}'
    as: resource
    item:
      allocated_storage: '{{ resource.AllocatedStorage }}'
      availability_zones: '{{ resource.AvailabilityZones }}'
      backup_retention_period: '{{ resource.BackupRetentionPeriod }}'
      character_set_name: '{{ resource.CharacterSetName }}'
      database_name: '{{ resource.DatabaseName }}'
      db_cluster_identifier: '{{ resource.DBClusterIdentifier }}'
      db_cluster_parameter_group: '{{ resource.DBClusterParameterGroup }}'
      db_subnet_group: '{{ resource.DBSubnetGroup }}'
      status: '{{ resource.Status }}'
      percent_progress: '{{ resource.PercentProgress }}'
- discovery_id: aws.rds.describe_option_groups
  calls:
  - action: describe_option_groups
    save_as: describe_option_groups_response
  emit:
    items_for: '{{ describe_option_groups_response.OptionGroupsList }}'
    as: resource
    item:
      option_group_name: '{{ resource.OptionGroupName }}'
      option_group_description: '{{ resource.OptionGroupDescription }}'
      engine_name: '{{ resource.EngineName }}'
      major_engine_version: '{{ resource.MajorEngineVersion }}'
      options: '{{ resource.Options }}'
      allows_vpc_and_non_vpc_instance_memberships: '{{ resource.AllowsVpcAndNonVpcInstanceMemberships
        }}'
      vpc_id: '{{ resource.VpcId }}'
      option_group_arn: '{{ resource.OptionGroupArn }}'
      source_option_group: '{{ resource.SourceOptionGroup }}'
      source_account_id: '{{ resource.SourceAccountId }}'
- discovery_id: aws.rds.delete_db_instance_automated_backup
  calls:
  - action: delete_db_instance_automated_backup
    save_as: delete_db_instance_automated_backup_response
  emit:
    items_for: '{{ delete_db_instance_automated_backup_response.DBInstanceAutomatedBackup
      }}'
    as: resource
    item:
      db_instance_arn: '{{ resource.DBInstanceArn }}'
      dbi_resource_id: '{{ resource.DbiResourceId }}'
      region: '{{ resource.Region }}'
      db_instance_identifier: '{{ resource.DBInstanceIdentifier }}'
      restore_window: '{{ resource.RestoreWindow }}'
      allocated_storage: '{{ resource.AllocatedStorage }}'
      status: '{{ resource.Status }}'
      port: '{{ resource.Port }}'
      availability_zone: '{{ resource.AvailabilityZone }}'
      vpc_id: '{{ resource.VpcId }}'
- discovery_id: aws.rds.describe_db_instances
  calls:
  - action: describe_db_instances
    save_as: describe_db_instances_response
  emit:
    items_for: '{{ describe_db_instances_response.DBInstances }}'
    as: resource
    item:
      db_instance_identifier: '{{ resource.DBInstanceIdentifier }}'
      db_instance_class: '{{ resource.DBInstanceClass }}'
      engine: '{{ resource.Engine }}'
      db_instance_status: '{{ resource.DBInstanceStatus }}'
      master_username: '{{ resource.MasterUsername }}'
      db_name: '{{ resource.DBName }}'
      endpoint: '{{ resource.Endpoint }}'
      allocated_storage: '{{ resource.AllocatedStorage }}'
      instance_create_time: '{{ resource.InstanceCreateTime }}'
      preferred_backup_window: '{{ resource.PreferredBackupWindow }}'
- discovery_id: aws.rds.describe_reserved_db_instances
  calls:
  - action: describe_reserved_db_instances
    save_as: describe_reserved_db_instances_response
  emit:
    items_for: '{{ describe_reserved_db_instances_response.ReservedDBInstances }}'
    as: resource
    item:
      reserved_db_instance_id: '{{ resource.ReservedDBInstanceId }}'
      reserved_db_instances_offering_id: '{{ resource.ReservedDBInstancesOfferingId
        }}'
      db_instance_class: '{{ resource.DBInstanceClass }}'
      start_time: '{{ resource.StartTime }}'
      duration: '{{ resource.Duration }}'
      fixed_price: '{{ resource.FixedPrice }}'
      usage_price: '{{ resource.UsagePrice }}'
      currency_code: '{{ resource.CurrencyCode }}'
      db_instance_count: '{{ resource.DBInstanceCount }}'
      product_description: '{{ resource.ProductDescription }}'
- discovery_id: aws.rds.describe_db_proxies
  calls:
  - action: describe_db_proxies
    save_as: describe_db_proxies_response
  emit:
    items_for: '{{ describe_db_proxies_response.DBProxies }}'
    as: resource
    item:
      db_proxy_name: '{{ resource.DBProxyName }}'
      db_proxy_arn: '{{ resource.DBProxyArn }}'
      status: '{{ resource.Status }}'
      engine_family: '{{ resource.EngineFamily }}'
      vpc_id: '{{ resource.VpcId }}'
      vpc_security_group_ids: '{{ resource.VpcSecurityGroupIds }}'
      vpc_subnet_ids: '{{ resource.VpcSubnetIds }}'
      default_auth_scheme: '{{ resource.DefaultAuthScheme }}'
      auth: '{{ resource.Auth }}'
      role_arn: '{{ resource.RoleArn }}'
- discovery_id: aws.rds.describe_db_subnet_groups
  calls:
  - action: describe_db_subnet_groups
    save_as: describe_db_subnet_groups_response
  emit:
    items_for: '{{ describe_db_subnet_groups_response.DBSubnetGroups }}'
    as: resource
    item:
      db_subnet_group_name: '{{ resource.DBSubnetGroupName }}'
      db_subnet_group_description: '{{ resource.DBSubnetGroupDescription }}'
      vpc_id: '{{ resource.VpcId }}'
      subnet_group_status: '{{ resource.SubnetGroupStatus }}'
      subnets: '{{ resource.Subnets }}'
      db_subnet_group_arn: '{{ resource.DBSubnetGroupArn }}'
      supported_network_types: '{{ resource.SupportedNetworkTypes }}'
- discovery_id: aws.rds.describe_blue_green_deployments
  calls:
  - action: describe_blue_green_deployments
    save_as: describe_blue_green_deployments_response
  emit:
    items_for: '{{ describe_blue_green_deployments_response.BlueGreenDeployments }}'
    as: resource
    item:
      blue_green_deployment_identifier: '{{ resource.BlueGreenDeploymentIdentifier
        }}'
      blue_green_deployment_name: '{{ resource.BlueGreenDeploymentName }}'
      source: '{{ resource.Source }}'
      target: '{{ resource.Target }}'
      switchover_details: '{{ resource.SwitchoverDetails }}'
      tasks: '{{ resource.Tasks }}'
      status: '{{ resource.Status }}'
      status_details: '{{ resource.StatusDetails }}'
      create_time: '{{ resource.CreateTime }}'
      delete_time: '{{ resource.DeleteTime }}'
- discovery_id: aws.rds.describe_db_snapshot_attributes
  calls:
  - action: describe_db_snapshot_attributes
    save_as: describe_db_snapshot_attributes_response
    params:
      DBSnapshotIdentifier: '{{ item.id }}'
    on_error: continue
  for_each: aws.rds.describe_db_security_groups
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      db_snapshot_identifier: '{{ describe_db_snapshot_attributes_response.DBSnapshotAttributesResult.DBSnapshotIdentifier
        }}'
      db_snapshot_attributes: '{{ describe_db_snapshot_attributes_response.DBSnapshotAttributesResult.DBSnapshotAttributes
        }}'
- discovery_id: aws.rds.describe_orderable_db_instance_options
  calls:
  - action: describe_orderable_db_instance_options
    save_as: describe_orderable_db_instance_options_response
    params:
      Engine: '{{ item.engine }}'
    on_error: continue
  for_each: aws.rds.describe_db_cluster_automated_backups
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      engine: '{{ describe_orderable_db_instance_options_response.OrderableDBInstanceOptions.Engine
        }}'
      engine_version: '{{ describe_orderable_db_instance_options_response.OrderableDBInstanceOptions.EngineVersion
        }}'
      db_instance_class: '{{ describe_orderable_db_instance_options_response.OrderableDBInstanceOptions.DBInstanceClass
        }}'
      license_model: '{{ describe_orderable_db_instance_options_response.OrderableDBInstanceOptions.LicenseModel
        }}'
      availability_zone_group: '{{ describe_orderable_db_instance_options_response.OrderableDBInstanceOptions.AvailabilityZoneGroup
        }}'
- discovery_id: aws.rds.describe_db_cluster_snapshot_attributes
  calls:
  - action: describe_db_cluster_snapshot_attributes
    save_as: describe_db_cluster_snapshot_attributes_response
    params:
      DBClusterSnapshotIdentifier: '{{ item.id }}'
    on_error: continue
  for_each: aws.rds.describe_db_security_groups
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      db_cluster_snapshot_identifier: '{{ describe_db_cluster_snapshot_attributes_response.DBClusterSnapshotAttributesResult.DBClusterSnapshotIdentifier
        }}'
      db_cluster_snapshot_attributes: '{{ describe_db_cluster_snapshot_attributes_response.DBClusterSnapshotAttributesResult.DBClusterSnapshotAttributes
        }}'
checks:
- rule_id: aws.rds.securitygroup.security_egress_restricted
  for_each: aws.rds.describe_db_security_groups
  conditions:
    var: item.ip_ranges
    op: equals
    value: []
- rule_id: aws.rds.instance.storage_encrypted
  for_each: aws.rds.describe_db_cluster_automated_backups
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.rds.instance.public_access_disabled
  for_each: aws.rds.describe_db_clusters
  conditions:
    var: item.publicly_accessible
    op: equals
    value: false
- rule_id: aws.rds.securitygroup.security_only_required_ports_open_restricted
  for_each: aws.rds.describe_db_security_groups
  conditions:
    var: item.ip_ranges
    op: equals
    value: []
- rule_id: aws.rds.snapshot.not_publicly_shared_configured
  for_each: aws.rds.describe_db_snapshot_attributes
  conditions:
    var: item.db_snapshot_attributes
    op: equals
    value: []
- rule_id: aws.rds.cluster.public_access_disabled
  for_each: aws.rds.describe_db_clusters
  conditions:
    var: item.publicly_accessible
    op: equals
    value: false
- rule_id: aws.rds.optiongroup.insecure_extensions_not_enabled
  for_each: aws.rds.describe_option_groups
  conditions:
    var: item.options
    op: equals
    value: []
- rule_id: aws.rds.resource.dynamodb_table_encryption_enabled
  for_each: aws.rds.describe_db_cluster_automated_backups
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.rds.instance.iam_authentication_enabled
  for_each: aws.rds.delete_db_instance_automated_backup
  conditions:
    var: item.iam_database_authentication_enabled
    op: equals
    value: true
- rule_id: aws.rds.instance.auto_minor_version_upgrade_configured
  for_each: aws.rds.describe_db_clusters
  conditions:
    var: item.auto_minor_version_upgrade
    op: equals
    value: true
- rule_id: aws.rds.instance.backup_encrypted
  for_each: aws.rds.describe_db_cluster_automated_backups
  conditions:
    all:
    - var: item.backup_retention_period
      op: gt
      value: 0
    - var: item.storage_encrypted
      op: equals
      value: true
- rule_id: aws.rds.instance.enhanced_monitoring_enabled
  for_each: aws.rds.describe_orderable_db_instance_options
  conditions:
    var: item.supports_enhanced_monitoring
    op: equals
    value: true
- rule_id: aws.rds.instance.encryption_at_rest_enabled
  for_each: aws.rds.describe_db_cluster_automated_backups
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.rds.instance.integration_cloudwatch_logs_configured
  for_each: aws.rds.delete_db_instance_automated_backup
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.rds.dbuser.approved_list_of_superusers_only_configured
  for_each: aws.rds.delete_db_instance_automated_backup
  conditions:
    any:
    - var: item.master_username
      op: equals
      value:
      - admin
      - superuser
- rule_id: aws.rds.instance.performance_insights_enabled
  for_each: aws.rds.delete_db_instance_automated_backup
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.rds.dbuser.no_unused_or_default_superusers_configured
  for_each: aws.rds.describe_db_instances
  conditions:
    all:
    - var: item.master_username
      op: not_equals
      value: admin
    - var: item.db_instance_status
      op: equals
      value: available
- rule_id: aws.rds.instance.security_configuration_review_configured
  for_each: aws.rds.describe_db_instances
  conditions:
    all:
    - var: item.db_instance_status
      op: equals
      value: available
    - var: item.backup_retention_period
      op: gte
      value: 7
    - var: item.vpc_security_groups
      op: exists
    - var: item.storage_encrypted
      op: equals
      value: true
- rule_id: aws.rds.instance.deletion_protection_enabled
  for_each: aws.rds.describe_db_clusters
  conditions:
    var: item.deletion_protection
    op: equals
    value: true
- rule_id: aws.rds.snapshots.public_access_configured
  for_each: aws.rds.describe_db_snapshot_attributes
  conditions:
    var: item.db_snapshot_attributes
    op: equals
    value: []
- rule_id: aws.rds.cluster.encryption_at_rest_cmek_configured
  for_each: aws.rds.describe_db_cluster_automated_backups
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.rds.backup_retention_period.backup_retention_period_configured
  for_each: aws.rds.delete_db_instance_automated_backup
  conditions:
    var: item.backup_retention_period
    op: gt
    value: 0
- rule_id: aws.rds.instance.backup_enabled
  for_each: aws.rds.delete_db_instance_automated_backup
  conditions:
    var: item.backup_retention_period
    op: gt
    value: 0
- rule_id: aws.rds.cluster.multi_az_configured
  for_each: aws.rds.describe_db_clusters
  conditions:
    var: item.multi_az
    op: equals
    value: true
- rule_id: aws.rds.reserved_instance.billing_admins_mfa_required
  for_each: aws.rds.delete_db_instance_automated_backup
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.rds.snapshot.encryption_at_rest_enabled
  for_each: aws.rds.describe_db_cluster_automated_backups
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.rds.snapshot.cross_account_sharing_restricted
  for_each: aws.rds.describe_db_snapshot_attributes
  conditions:
    var: item.db_snapshot_attributes
    op: equals
    value: []
- rule_id: aws.rds.reserved_instance.purchase_permissions_restricted
  for_each: aws.rds.describe_reserved_db_instances
  conditions:
    var: item.state
    op: equals
    value: ACTIVE
- rule_id: aws.rds.clustersnapshot.not_publicly_shared_configured
  for_each: aws.rds.describe_db_cluster_snapshot_attributes
  conditions:
    var: item.db_cluster_snapshot_attributes
    op: equals
    value: []
- rule_id: aws.rds.snapshot.storage_encrypted
  for_each: aws.rds.describe_db_cluster_automated_backups
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.rds.reserved_instance.instance_approval_workflow_required
  for_each: aws.rds.describe_reserved_db_instances
  conditions:
    var: item.state
    op: equals
    value: active
- rule_id: aws.rds.resource.snapshots_encrypted
  for_each: aws.rds.describe_db_cluster_automated_backups
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.rds.cluster.audit_logging_enabled
  for_each: aws.rds.describe_db_proxies
  conditions:
    var: item.debug_logging
    op: equals
    value: true
- rule_id: aws.rds.cluster.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.rds.delete_db_instance_automated_backup
  conditions:
    var: item.iam_database_authentication_enabled
    op: equals
    value: true
- rule_id: aws.rds.cluster.storage_encrypted
  for_each: aws.rds.describe_db_cluster_automated_backups
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.rds.securitygroup.security_no_0_ingress_on_db_ports_configured
  for_each: aws.rds.describe_db_security_groups
  conditions:
    var: item.ip_ranges
    op: equals
    value: []
- rule_id: aws.rds.cluster.deletion_protection_enabled
  for_each: aws.rds.describe_db_clusters
  conditions:
    var: item.deletion_protection
    op: equals
    value: true
- rule_id: aws.rds.instance.no_public_access_configured
  for_each: aws.rds.describe_db_clusters
  conditions:
    var: item.publicly_accessible
    op: equals
    value: false
- rule_id: aws.rds.parametergroup.audit_logging_enabled
  for_each: aws.rds.describe_db_proxies
  conditions:
    var: item.debug_logging
    op: equals
    value: true
- rule_id: aws.rds.optiongroup.only_approved_extensions_enabled
  for_each: aws.rds.describe_option_groups
  conditions:
    var: item.options
    op: equals
    value:
    - approved_extension_1
    - approved_extension_2
- rule_id: aws.rds.snapshot.cross_region_copy_encrypted
  for_each: aws.rds.describe_db_cluster_automated_backups
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.rds.cluster.encryption_at_rest_enabled
  for_each: aws.rds.describe_db_cluster_automated_backups
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.rds.subnetgroup.private_subnets_only_configured
  for_each: aws.rds.describe_db_subnet_groups
  conditions:
    all:
    - var: item.subnet_group_status
      op: equals
      value: Complete
    - var: item.vpc_id
      op: exists
- rule_id: aws.rds.clustersnapshot.snapshot_cross_account_sharing_restricted
  for_each: aws.rds.describe_db_cluster_snapshot_attributes
  conditions:
    var: item.db_cluster_snapshot_attributes
    op: equals
    value: []
- rule_id: aws.rds.dbuser.iam_auth_preferred_configured
  for_each: aws.rds.delete_db_instance_automated_backup
  conditions:
    var: item.iam_database_authentication_enabled
    op: equals
    value: true
- rule_id: aws.rds.parametergroup.require_ssl_configured
  for_each: aws.rds.describe_db_proxies
  conditions:
    var: item.require_tls
    op: equals
    value: true
- rule_id: aws.rds.cluster.require_tls_in_transit_configured
  for_each: aws.rds.describe_db_proxies
  conditions:
    var: item.require_tls
    op: equals
    value: true
- rule_id: aws.rds.instance.multi_az_configured
  for_each: aws.rds.describe_db_clusters
  conditions:
    var: item.multi_az
    op: equals
    value: true
- rule_id: aws.rds.cluster.copy_tags_to_snapshots_configured
  for_each: aws.rds.describe_blue_green_deployments
  conditions:
    var: item.tag_list
    op: exists
- rule_id: aws.rds.clustersnapshot.snapshot_cross_region_copy_encrypted
  for_each: aws.rds.describe_db_cluster_automated_backups
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.rds.instance.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.rds.delete_db_instance_automated_backup
  conditions:
    var: item.iam_database_authentication_enabled
    op: equals
    value: true
- rule_id: aws.rds.instance.inside_vpc_configured
  for_each: aws.rds.delete_db_instance_automated_backup
  conditions:
    var: item.vpc_id
    op: exists
- rule_id: aws.rds.instance.deletion_protection_configured
  for_each: aws.rds.describe_db_clusters
  conditions:
    var: item.deletion_protection
    op: equals
    value: true
- rule_id: aws.rds.instance.require_tls_in_transit_configured
  for_each: aws.rds.describe_db_proxies
  conditions:
    var: item.require_tls
    op: equals
    value: true
- rule_id: aws.rds.clustersnapshot.encryption_at_rest_enabled
  for_each: aws.rds.describe_db_cluster_automated_backups
  conditions:
    var: item.storage_encrypted
    op: equals
    value: true
- rule_id: aws.rds.snapshot.not_public_configured
  for_each: aws.rds.describe_db_snapshot_attributes
  conditions:
    var: item.db_snapshot_attributes
    op: contains
    value: restore
- rule_id: aws.rds.instance.transport_encrypted
  for_each: aws.rds.describe_db_proxies
  conditions:
    var: item.require_tls
    op: equals
    value: true
- rule_id: aws.rds.cluster.integration_cloudwatch_logs_configured
  for_each: aws.rds.delete_db_instance_automated_backup
  conditions:
    var: item.status
    op: equals
    value: ACTIVE
- rule_id: aws.rds.instance.copy_tags_to_snapshots_configured
  for_each: aws.rds.describe_blue_green_deployments
  conditions:
    var: item.tag_list
    op: exists
- rule_id: aws.rds.snapshots_public_access.snapshots_public_access_configured
  for_each: aws.rds.describe_db_snapshot_attributes
  conditions:
    var: item.db_snapshot_attributes
    op: contains
    value: all
