version: '1.0'
provider: aws
service: vpcflowlogs
services:
  client: vpcflowlogs
  module: boto3.client
discovery:
- discovery_id: aws.vpcflowlogs.describe_flow_logs
  calls:
  - action: describe_flow_logs
    save_as: response
  emit:
    item:
      CreationTime: '{{ response.FlowLogs.CreationTime }}'
      DeliverLogsErrorMessage: '{{ response.FlowLogs.DeliverLogsErrorMessage }}'
      DeliverLogsPermissionArn: '{{ response.FlowLogs.DeliverLogsPermissionArn }}'
      DeliverCrossAccountRole: '{{ response.FlowLogs.DeliverCrossAccountRole }}'
      DeliverLogsStatus: '{{ response.FlowLogs.DeliverLogsStatus }}'
      FlowLogId: '{{ response.FlowLogs.FlowLogId }}'
      FlowLogStatus: '{{ response.FlowLogs.FlowLogStatus }}'
      LogGroupName: '{{ response.FlowLogs.LogGroupName }}'
      ResourceId: '{{ response.FlowLogs.ResourceId }}'
      TrafficType: '{{ response.FlowLogs.TrafficType }}'
      LogDestinationType: '{{ response.FlowLogs.LogDestinationType }}'
      LogDestination: '{{ response.FlowLogs.LogDestination }}'
      LogFormat: '{{ response.FlowLogs.LogFormat }}'
      Tags: '{{ response.FlowLogs.Tags }}'
      MaxAggregationInterval: '{{ response.FlowLogs.MaxAggregationInterval }}'
      DestinationOptions: '{{ response.FlowLogs.DestinationOptions }}'
checks:
- rule_id: aws.vpcflowlogs.flowlog.alerts_for_anomalies_configured
  for_each: aws.vpcflowlogs.describe_flow_logs
  conditions:
    var: item.FlowLogStatus
    op: equals
    value: available
- rule_id: aws.vpcflowlogs.flowlog.log_s_enabled
  for_each: aws.vpcflowlogs.describe_flow_logs
  conditions:
    var: item.FlowLogStatus
    op: equals
    value: active
- rule_id: aws.vpcflowlogs.flowlog.log_ids_ips_enabled_if_supported
  for_each: aws.vpcflowlogs.describe_flow_logs
  conditions:
    var: item.FlowLogStatus
    op: equals
    value: active
- rule_id: aws.vpcflowlogs.flowlog.alert_destinations_configured
  for_each: aws.vpcflowlogs.describe_flow_logs
  conditions:
    var: item.LogDestinationType
    op: in
    value:
    - cloud-watch-logs
    - s3
