version: '1.0'
provider: aws
service: vpcflowlogs
discovery:
- discovery_id: aws.vpcflowlogs.describe_flow_logs
  calls:
  - action: describe_flow_logs
    save_as: describe_flow_logs_response
  emit:
    items_for: '{{ describe_flow_logs_response.FlowLogs }}'
    as: resource
    item:
      creation_time: '{{ resource.CreationTime }}'
      deliver_logs_error_message: '{{ resource.DeliverLogsErrorMessage }}'
      deliver_logs_permission_arn: '{{ resource.DeliverLogsPermissionArn }}'
      deliver_cross_account_role: '{{ resource.DeliverCrossAccountRole }}'
      deliver_logs_status: '{{ resource.DeliverLogsStatus }}'
      flow_log_id: '{{ resource.FlowLogId }}'
      flow_log_status: '{{ resource.FlowLogStatus }}'
      log_group_name: '{{ resource.LogGroupName }}'
      resource_id: '{{ resource.ResourceId }}'
      traffic_type: '{{ resource.TrafficType }}'
checks:
- rule_id: aws.vpcflowlogs.flowlog.alerts_for_anomalies_configured
  for_each: aws.vpcflowlogs.describe_flow_logs
  conditions:
    all:
    - var: item.flow_log_status
      op: equals
      value: ACTIVE
    - var: item.deliver_logs_status
      op: equals
      value: SUCCESS
    - var: item.log_destination_type
      op: equals
      value: cloud-watch-logs
- rule_id: aws.vpcflowlogs.flowlog.log_s_enabled
  for_each: aws.vpcflowlogs.describe_flow_logs
  conditions:
    var: item.flow_log_status
    op: equals
    value: ACTIVE
- rule_id: aws.vpcflowlogs.flowlog.alert_destinations_configured
  for_each: aws.vpcflowlogs.describe_flow_logs
  conditions:
    var: item.log_destination
    op: exists
- rule_id: aws.vpcflowlogs.flowlog.log_ids_ips_enabled_if_supported
  for_each: aws.vpcflowlogs.describe_flow_logs
  conditions:
    all:
    - var: item.flow_log_status
      op: equals
      value: ACTIVE
    - var: item.log_destination_type
      op: equals
      value: cloud-watch-logs
    - var: item.log_format
      op: contains
      value: ${version} ${account-id} ${interface-id} ${srcaddr} ${dstaddr} ${srcport}
        ${dstport} ${protocol} ${packets} ${bytes} ${start} ${end} ${action} ${log-status}
