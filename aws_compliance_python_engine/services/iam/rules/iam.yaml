version: '1.0'
provider: aws
service: iam
services:
  client: iam
  module: boto3.client
discovery:
- discovery_id: aws.iam.get_account_authorization_details
  calls:
  - action: get_account_authorization_details
    save_as: response
  emit:
    item:
      path: '{{ resource.Path }}'
      user_name: '{{ resource.UserName }}'
      user_id: '{{ resource.UserId }}'
      arn: '{{ resource.Arn }}'
      create_date: '{{ resource.CreateDate }}'
      user_policy_list: '{{ resource.UserPolicyList }}'
      group_list: '{{ resource.GroupList }}'
      attached_managed_policies: '{{ resource.AttachedManagedPolicies }}'
      permissions_boundary: '{{ resource.PermissionsBoundary }}'
      tags: '{{ resource.Tags }}'
    items_for: '{{ response.UserDetailList }}'
    as: resource
- discovery_id: aws.iam.get_account_password_policy
  calls:
  - action: get_account_password_policy
    save_as: response
  emit:
    item:
      minimum_password_length: '{{ response.PasswordPolicy.MinimumPasswordLength }}'
      require_symbols: '{{ response.PasswordPolicy.RequireSymbols }}'
      require_numbers: '{{ response.PasswordPolicy.RequireNumbers }}'
      require_uppercase_characters: '{{ response.PasswordPolicy.RequireUppercaseCharacters
        }}'
      require_lowercase_characters: '{{ response.PasswordPolicy.RequireLowercaseCharacters
        }}'
      allow_users_to_change_password: '{{ response.PasswordPolicy.AllowUsersToChangePassword
        }}'
      expire_passwords: '{{ response.PasswordPolicy.ExpirePasswords }}'
      max_password_age: '{{ response.PasswordPolicy.MaxPasswordAge }}'
      password_reuse_prevention: '{{ response.PasswordPolicy.PasswordReusePrevention
        }}'
      hard_expiry: '{{ response.PasswordPolicy.HardExpiry }}'
- discovery_id: aws.iam.get_user
  calls:
  - action: get_user
    save_as: response
  emit:
    item:
      path: '{{ response.User.Path }}'
      user_name: '{{ response.User.UserName }}'
      user_id: '{{ response.User.UserId }}'
      arn: '{{ response.User.Arn }}'
      create_date: '{{ response.User.CreateDate }}'
      password_last_used: '{{ response.User.PasswordLastUsed }}'
      permissions_boundary: '{{ response.User.PermissionsBoundary }}'
      tags: '{{ response.User.Tags }}'
- discovery_id: aws.iam.list_access_keys
  calls:
  - action: list_access_keys
    save_as: response
  emit:
    items_for: '{{ response.AccessKeyMetadata }}'
    as: resource
    item:
      user_name: '{{ resource.UserName }}'
      access_key_id: '{{ resource.AccessKeyId }}'
      status: '{{ resource.Status }}'
      create_date: '{{ resource.CreateDate }}'
- discovery_id: aws.iam.list_delegation_requests
  calls:
  - action: list_delegation_requests
    save_as: response
  emit:
    items_for: '{{ response.DelegationRequests }}'
    as: resource
    item:
      delegation_request_id: '{{ resource.DelegationRequestId }}'
      owner_account_id: '{{ resource.OwnerAccountId }}'
      description: '{{ resource.Description }}'
      request_message: '{{ resource.RequestMessage }}'
      permissions: '{{ resource.Permissions }}'
      permission_policy: '{{ resource.PermissionPolicy }}'
      role_permission_restriction_arns: '{{ resource.RolePermissionRestrictionArns
        }}'
      owner_id: '{{ resource.OwnerId }}'
      approver_id: '{{ resource.ApproverId }}'
      state: '{{ resource.State }}'
      requestor_id: '{{ resource.RequestorId }}'
      requestor_name: '{{ resource.RequestorName }}'
      create_date: '{{ resource.CreateDate }}'
      session_duration: '{{ resource.SessionDuration }}'
      redirect_url: '{{ resource.RedirectUrl }}'
      notes: '{{ resource.Notes }}'
      rejection_reason: '{{ resource.RejectionReason }}'
      only_send_by_owner: '{{ resource.OnlySendByOwner }}'
      updated_time: '{{ resource.UpdatedTime }}'
- discovery_id: aws.iam.list_instance_profiles
  calls:
  - action: list_instance_profiles
    save_as: response
  emit:
    items_for: '{{ response.InstanceProfiles }}'
    as: resource
    item:
      path: '{{ resource.Path }}'
      instance_profile_name: '{{ resource.InstanceProfileName }}'
      instance_profile_id: '{{ resource.InstanceProfileId }}'
      arn: '{{ resource.Arn }}'
      create_date: '{{ resource.CreateDate }}'
      roles: '{{ resource.Roles }}'
      tags: '{{ resource.Tags }}'
- discovery_id: aws.iam.list_mfa_devices
  calls:
  - action: list_mfa_devices
    save_as: response
  emit:
    items_for: '{{ response.MFADevices }}'
    as: resource
    item:
      user_name: '{{ resource.UserName }}'
      serial_number: '{{ resource.SerialNumber }}'
      enable_date: '{{ resource.EnableDate }}'
- discovery_id: aws.iam.list_policies
  calls:
  - action: list_policies
    save_as: response
  emit:
    items_for: '{{ response.Policies }}'
    as: resource
    item:
      policy_name: '{{ resource.PolicyName }}'
      policy_id: '{{ resource.PolicyId }}'
      arn: '{{ resource.Arn }}'
      path: '{{ resource.Path }}'
      default_version_id: '{{ resource.DefaultVersionId }}'
      attachment_count: '{{ resource.AttachmentCount }}'
      permissions_boundary_usage_count: '{{ resource.PermissionsBoundaryUsageCount
        }}'
      is_attachable: '{{ resource.IsAttachable }}'
      description: '{{ resource.Description }}'
      create_date: '{{ resource.CreateDate }}'
      update_date: '{{ resource.UpdateDate }}'
      tags: '{{ resource.Tags }}'
- discovery_id: aws.iam.list_roles
  calls:
  - action: list_roles
    save_as: response
  emit:
    items_for: '{{ response.Roles }}'
    as: resource
    item:
      path: '{{ resource.Path }}'
      role_name: '{{ resource.RoleName }}'
      role_id: '{{ resource.RoleId }}'
      arn: '{{ resource.Arn }}'
      create_date: '{{ resource.CreateDate }}'
      assume_role_policy_document: '{{ resource.AssumeRolePolicyDocument }}'
      description: '{{ resource.Description }}'
      max_session_duration: '{{ resource.MaxSessionDuration }}'
      permissions_boundary: '{{ resource.PermissionsBoundary }}'
      tags: '{{ resource.Tags }}'
      role_last_used: '{{ resource.RoleLastUsed }}'
- discovery_id: aws.iam.list_saml_providers
  calls:
  - action: list_saml_providers
    save_as: response
  emit:
    items_for: '{{ response.SAMLProviderList }}'
    as: resource
    item:
      arn: '{{ resource.Arn }}'
      valid_until: '{{ resource.ValidUntil }}'
      create_date: '{{ resource.CreateDate }}'
- discovery_id: aws.iam.list_server_certificates
  calls:
  - action: list_server_certificates
    save_as: response
  emit:
    items_for: '{{ response.ServerCertificateMetadataList }}'
    as: resource
    item:
      path: '{{ resource.Path }}'
      server_certificate_name: '{{ resource.ServerCertificateName }}'
      server_certificate_id: '{{ resource.ServerCertificateId }}'
      arn: '{{ resource.Arn }}'
      upload_date: '{{ resource.UploadDate }}'
      expiration: '{{ resource.Expiration }}'
- discovery_id: aws.iam.get_access_key_last_used
  calls:
  - action: get_access_key_last_used
    save_as: response
    params:
      AccessKeyId: '{{ item.AccessKeyId }}'
  on_error: continue
  for_each: aws.iam.list_access_keys
  emit:
    item:
      user_name: '{{ response.UserName }}'
      last_used_date: '{{ response.AccessKeyLastUsed.LastUsedDate }}'
      service_name: '{{ response.AccessKeyLastUsed.ServiceName }}'
      region: '{{ response.AccessKeyLastUsed.Region }}'
- discovery_id: aws.iam.get_saml_provider
  calls:
  - action: get_saml_provider
    save_as: response
    params:
      SAMLProviderArn: '{{ item.arn }}'
  emit:
    item:
      saml_metadata_document: '{{ response.SAMLMetadataDocument }}'
      create_date: '{{ response.CreateDate }}'
      valid_until: '{{ response.ValidUntil }}'
    items_for: '{{ response.Tags }}'
    as: resource
  for_each: aws.iam.list_saml_providers
checks:
- rule_id: aws.iam.password.policy_lowercase_configured
  conditions:
    var: item.require_lowercase_characters
    op: equals
    value: true
  for_each: aws.iam.get_account_password_policy
- rule_id: aws.iam.instanceprofile.no_instance_profile_with_admin_star_configured
  conditions:
    var: item.roles
    op: contains
    value: Admin
  for_each: aws.iam.list_instance_profiles
- rule_id: aws.iam.password.policy_minimum_length_14_configured
  conditions:
    var: item.minimum_password_length
    op: gte
    value: 14
  for_each: aws.iam.get_account_password_policy
- rule_id: aws.iam.role.session_duration_reasonable_if_applicable_configured
  conditions:
    var: item.max_session_duration
    op: lte
    value: 3600
  for_each: aws.iam.list_roles
- rule_id: aws.iam.user.inactive_90_days_disabled
  conditions:
    var: item.password_last_used
    op: lte
    value: 90 days ago
  for_each: aws.iam.get_user
- rule_id: aws.iam.policy.conditions_used_if_applicable_configured
  conditions:
    var: item.document
    op: exists
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.user.no_inline_policies_enabled
  conditions:
    var: item.user_policy_list
    op: equals
    value: []
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.policy.no_full_access_to_cloudtrail_configured
  conditions:
    var: item.policy_name
    op: contains
    value: FullAccess
  for_each: aws.iam.list_policies
- rule_id: aws.iam.policy.reuse_24_configured
  conditions:
    var: item.password_reuse_prevention
    op: gte
    value: 24
  for_each: aws.iam.get_account_password_policy
- rule_id: aws.iam.user.console_access_unused_configured
  conditions:
    var: item.password_last_used
    op: exists
  for_each: aws.iam.get_user
- rule_id: aws.iam.role.attached_policies_not_admin_star_configured
  conditions:
    var: item.attached_managed_policies
    op: not_contains
    value: arn:aws:iam::aws:policy/AdministratorAccess
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.samlprovider.idp_metadata_signed_configured
  conditions:
    var: item.key_id
    op: exists
  for_each: aws.iam.get_saml_provider
- rule_id: aws.iam.policy.no_wildcard_admin_actions_configured
  conditions:
    var: item.document
    op: contains
    value: '*'
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.resource.access_analyzer_external_all_regions_configured
  conditions:
    var: item.region
    op: exists
  for_each: aws.iam.get_access_key_last_used
- rule_id: aws.iam.customer.attached_policy_no_administrative_privileges_configured
  conditions:
    var: item.attached_managed_policies
    op: equals
    value: []
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.password.policy_reuse_24_configured
  conditions:
    var: item.password_reuse_prevention
    op: equals
    value: 24
  for_each: aws.iam.get_account_password_policy
- rule_id: aws.iam.policy.attached_only_to_group_or_roles_configured
  conditions:
    var: item.attachment_count
    op: equals
    value: 0
  for_each: aws.iam.list_policies
- rule_id: aws.iam.certificate.expiration_removal_monitored
  conditions:
    var: item.expiration
    op: exists
  for_each: aws.iam.list_server_certificates
- rule_id: aws.iam.user.access_keys_rotated_90_days_or_less_when_present
  conditions:
    var: item.create_date
    op: lte
    value: 90
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.user.single_active_access_key_audit_configured
  conditions:
    var: item.status
    op: equals
    value: ACTIVE
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.resource.root_mfa_enabled
  conditions:
    var: item.status
    op: equals
    value: ENABLED
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.no.root_access_key_configured
  conditions:
    var: item.status
    op: equals
    value: INACTIVE
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.rotate.access_key_90_days_configured
  conditions:
    var: item.create_date
    op: lte
    value: 90
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.policy.no_full_admin_privileges_enabled
  conditions:
    var: item.attached_managed_policies
    op: equals
    value: []
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.group.has_users_configured
  conditions:
    var: item.group_list
    op: exists
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.policy.minimum_length_14_configured
  conditions:
    var: item.minimum_password_length
    op: gte
    value: 14
  for_each: aws.iam.get_account_password_policy
- rule_id: aws.iam.password.policy_uppercase_configured
  conditions:
    var: item.require_uppercase_characters
    op: equals
    value: true
  for_each: aws.iam.get_account_password_policy
- rule_id: aws.iam.instanceprofile.role_enabled
  conditions:
    var: item.roles
    op: exists
  for_each: aws.iam.list_instance_profiles
- rule_id: aws.iam.role.no_user_managed_long_lived_keys_configured
  conditions:
    var: item.status
    op: equals
    value: INACTIVE
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.samlprovider.assertion_lifetime_configured
  conditions:
    var: item.valid_until
    op: exists
  for_each: aws.iam.list_saml_providers
- rule_id: aws.iam.access_analyzer_active_status_all_regions.access_analyzer_active_status_all_regions_configured
  conditions:
    var: item.status
    op: equals
    value: ACTIVE
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.managedpolicy.no_policy_allows_without_constraints_configured
  conditions:
    var: item.attachment_count
    op: equals
    value: 0
  for_each: aws.iam.list_policies
- rule_id: aws.iam.user.single_active_access_key_configured
  conditions:
    var: item.status
    op: equals
    value: Active
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.role.no_inline_policies_configured
  conditions:
    var: item.user_policy_list
    op: equals
    value: []
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.managedpolicy.policy_no_wildcard_admin_actions_configured
  conditions:
    var: item.document
    op: contains
    value: '*'
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.oidcprovider.certificate_issuer_https_and_matches_discovery_verified
  conditions:
    var: item.arn
    op: contains
    value: https://
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.group.attached_policies_not_admin_star_configured
  conditions:
    var: item.policy_name
    op: not_contains
    value:
    - AdministratorAccess
  for_each: aws.iam.list_policies
- rule_id: aws.iam.key.rotation_90_days_configured
  conditions:
    var: item.create_date
    op: lte
    value: 90
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.root.hardware_mfa_enabled
  conditions:
    var: item.status
    op: equals
    value: ENABLED
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.resource.root_hardware_mfa_enabled
  conditions:
    var: item.serial_number
    op: exists
  for_each: aws.iam.list_mfa_devices
- rule_id: aws.iam.aws.attached_policy_no_administrative_privileges_configured
  conditions:
    var: item.attached_managed_policies
    op: equals
    value: []
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.group.external_sharing_restricted_if_supported
  conditions:
    var: item.policy_name
    op: exists
  for_each: aws.iam.list_policies
- rule_id: aws.iam.oidcprovider.token_lifetime_configured
  conditions:
    var: item.session_duration
    op: lte
    value: 3600
  for_each: aws.iam.list_delegation_requests
- rule_id: aws.iam.timestream_access_control_and_mfa_enforcement.timestream_access_control_mfa_enforcement_configured
  conditions:
    var: item.status
    op: equals
    value: Enabled
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.samlprovider.certificates_certificate_valid
  conditions:
    var: item.valid_until
    op: gt
    value: '2023-10-01T00:00:00Z'
  for_each: aws.iam.list_saml_providers
- rule_id: aws.iam.managedpolicy.policy_conditions_used_if_applicable_configured
  conditions:
    var: item.permissions_boundary
    op: exists
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.role.awssupport_access_policy_attachment_configured
  conditions:
    var: item.attached_managed_policies
    op: contains
    value:
    - PolicyName: AWSSupportAccess
      PolicyArn: arn:aws:iam::aws:policy/AWSSupportAccess
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.policy.workflow_storage_encrypted
  conditions:
    var: item.attachment_count
    op: gt
    value: 0
  for_each: aws.iam.list_policies
- rule_id: aws.iam.key.monitored
  conditions:
    var: item.status
    op: equals
    value: ACTIVE
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.policy.policy_enabled
  conditions:
    var: item.is_attachable
    op: equals
    value: true
  for_each: aws.iam.list_policies
- rule_id: aws.iam.user.console_password_present_only_if_required
  conditions:
    var: item.password_last_used
    op: exists
  for_each: aws.iam.get_user
- rule_id: aws.iam.managedpolicy.policy_resource_constraints_present
  conditions:
    var: item.permissions_boundary
    op: exists
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.group.membership_review_enabled_if_supported
  conditions:
    var: item.group_list
    op: exists
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.root.mfa_enabled
  conditions:
    var: item.status
    op: equals
    value: ENABLED
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.policy.resource_constraints_present
  conditions:
    var: item.permissions_boundary
    op: exists
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.password.policy_symbol_configured
  conditions:
    var: item.require_symbols
    op: equals
    value: true
  for_each: aws.iam.get_account_password_policy
- rule_id: aws.iam.samlprovider.audience_restriction_configured
  conditions:
    var: item.arn
    op: exists
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.inline.policy_no_administrative_privileges_configured
  conditions:
    var: item.user_policy_list
    op: equals
    value: []
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.role.trust_external_id_or_audience_required
  conditions:
    var: item.assume_role_policy_document
    op: exists
  for_each: aws.iam.list_roles
- rule_id: aws.iam.group.no_inline_policies_configured
  conditions:
    var: item.user_policy_list
    op: equals
    value: []
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.role.max_session_duration_configured
  conditions:
    var: item.max_session_duration
    op: lte
    value: 3600
  for_each: aws.iam.list_roles
- rule_id: aws.iam.user.hardware_mfa_enabled
  conditions:
    var: item.status
    op: equals
    value: ENABLED
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.oidcprovider.allowed_client_ids_audiences_restricted
  conditions:
    var: item.arn
    op: exists
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.user.no_inline_policies_configured
  conditions:
    var: item.user_policy_list
    op: equals
    value: []
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.user.in_group_configured
  conditions:
    var: item.group_list
    op: exists
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.role.trust_principals_allowlist_only_configured
  conditions:
    var: item.assume_role_policy_document
    op: contains
    value:
    - AllowlistPrincipalArn1
    - AllowlistPrincipalArn2
  for_each: aws.iam.list_roles
- rule_id: aws.iam.instanceprofile.no_admin_star_policies_configured
  conditions:
    var: item.attached_managed_policies
    op: equals
    value: []
  for_each: aws.iam.get_account_authorization_details
- rule_id: aws.iam.policy.no_policies_without_constraints_configured
  conditions:
    var: item.permissions_boundary
    op: exists
  for_each: aws.iam.get_account_authorization_details
