version: '1.0'
provider: aws
service: iam
discovery:
- discovery_id: aws.iam.get_account_password_policy
  calls:
  - action: get_account_password_policy
    save_as: get_account_password_policy_response
  emit:
    items_for: '{{ get_account_password_policy_response.PasswordPolicy }}'
    as: resource
    item:
      minimum_password_length: '{{ resource.MinimumPasswordLength }}'
      require_symbols: '{{ resource.RequireSymbols }}'
      require_numbers: '{{ resource.RequireNumbers }}'
      require_uppercase_characters: '{{ resource.RequireUppercaseCharacters }}'
      require_lowercase_characters: '{{ resource.RequireLowercaseCharacters }}'
      allow_users_to_change_password: '{{ resource.AllowUsersToChangePassword }}'
      expire_passwords: '{{ resource.ExpirePasswords }}'
      max_password_age: '{{ resource.MaxPasswordAge }}'
      password_reuse_prevention: '{{ resource.PasswordReusePrevention }}'
      hard_expiry: '{{ resource.HardExpiry }}'
- discovery_id: aws.iam.list_instance_profiles
  calls:
  - action: list_instance_profiles
    save_as: list_instance_profiles_response
  emit:
    items_for: '{{ list_instance_profiles_response.InstanceProfiles }}'
    as: resource
    item:
      path: '{{ resource.Path }}'
      instance_profile_name: '{{ resource.InstanceProfileName }}'
      instance_profile_id: '{{ resource.InstanceProfileId }}'
      arn: '{{ resource.Arn }}'
      create_date: '{{ resource.CreateDate }}'
      roles: '{{ resource.Roles }}'
      tags: '{{ resource.Tags }}'
- discovery_id: aws.iam.get_account_authorization_details
  calls:
  - action: get_account_authorization_details
    save_as: get_account_authorization_details_response
  emit:
    items_for: '{{ get_account_authorization_details_response.UserDetailList }}'
    as: resource
    item:
      path: '{{ resource.Path }}'
      user_name: '{{ resource.UserName }}'
      user_id: '{{ resource.UserId }}'
      arn: '{{ resource.Arn }}'
      create_date: '{{ resource.CreateDate }}'
      user_policy_list: '{{ resource.UserPolicyList }}'
      group_list: '{{ resource.GroupList }}'
      attached_managed_policies: '{{ resource.AttachedManagedPolicies }}'
      permissions_boundary: '{{ resource.PermissionsBoundary }}'
      tags: '{{ resource.Tags }}'
- discovery_id: aws.iam.list_roles
  calls:
  - action: list_roles
    save_as: list_roles_response
  emit:
    items_for: '{{ list_roles_response.Roles }}'
    as: resource
    item:
      path: '{{ resource.Path }}'
      role_name: '{{ resource.RoleName }}'
      role_id: '{{ resource.RoleId }}'
      arn: '{{ resource.Arn }}'
      create_date: '{{ resource.CreateDate }}'
      assume_role_policy_document: '{{ resource.AssumeRolePolicyDocument }}'
      description: '{{ resource.Description }}'
      max_session_duration: '{{ resource.MaxSessionDuration }}'
      permissions_boundary: '{{ resource.PermissionsBoundary }}'
      tags: '{{ resource.Tags }}'
- discovery_id: aws.iam.get_user
  calls:
  - action: get_user
    save_as: get_user_response
  emit:
    items_for: '{{ get_user_response.User }}'
    as: resource
    item:
      path: '{{ resource.Path }}'
      user_name: '{{ resource.UserName }}'
      user_id: '{{ resource.UserId }}'
      arn: '{{ resource.Arn }}'
      create_date: '{{ resource.CreateDate }}'
      password_last_used: '{{ resource.PasswordLastUsed }}'
      permissions_boundary: '{{ resource.PermissionsBoundary }}'
      tags: '{{ resource.Tags }}'
- discovery_id: aws.iam.list_policies
  calls:
  - action: list_policies
    save_as: list_policies_response
  emit:
    items_for: '{{ list_policies_response.Policies }}'
    as: resource
    item:
      policy_name: '{{ resource.PolicyName }}'
      policy_id: '{{ resource.PolicyId }}'
      arn: '{{ resource.Arn }}'
      path: '{{ resource.Path }}'
      default_version_id: '{{ resource.DefaultVersionId }}'
      attachment_count: '{{ resource.AttachmentCount }}'
      permissions_boundary_usage_count: '{{ resource.PermissionsBoundaryUsageCount
        }}'
      is_attachable: '{{ resource.IsAttachable }}'
      description: '{{ resource.Description }}'
      create_date: '{{ resource.CreateDate }}'
- discovery_id: aws.iam.list_server_certificates
  calls:
  - action: list_server_certificates
    save_as: list_server_certificates_response
  emit:
    items_for: '{{ list_server_certificates_response.ServerCertificateMetadataList
      }}'
    as: resource
    item:
      path: '{{ resource.Path }}'
      server_certificate_name: '{{ resource.ServerCertificateName }}'
      server_certificate_id: '{{ resource.ServerCertificateId }}'
      arn: '{{ resource.Arn }}'
      upload_date: '{{ resource.UploadDate }}'
      expiration: '{{ resource.Expiration }}'
- discovery_id: aws.iam.create_access_key
  calls:
  - action: create_access_key
    save_as: create_access_key_response
  emit:
    items_for: '{{ create_access_key_response.AccessKey }}'
    as: resource
    item:
      user_name: '{{ resource.UserName }}'
      access_key_id: '{{ resource.AccessKeyId }}'
      status: '{{ resource.Status }}'
      secret_access_key: '{{ resource.SecretAccessKey }}'
      create_date: '{{ resource.CreateDate }}'
- discovery_id: aws.iam.list_saml_providers
  calls:
  - action: list_saml_providers
    save_as: list_saml_providers_response
  emit:
    items_for: '{{ list_saml_providers_response.SAMLProviderList }}'
    as: resource
    item:
      arn: '{{ resource.Arn }}'
      valid_until: '{{ resource.ValidUntil }}'
      create_date: '{{ resource.CreateDate }}'
- discovery_id: aws.iam.list_mfa_devices
  calls:
  - action: list_mfa_devices
    save_as: list_mfa_devices_response
  emit:
    items_for: '{{ list_mfa_devices_response.MFADevices }}'
    as: resource
    item:
      user_name: '{{ resource.UserName }}'
      serial_number: '{{ resource.SerialNumber }}'
      enable_date: '{{ resource.EnableDate }}'
- discovery_id: aws.iam.list_delegation_requests
  calls:
  - action: list_delegation_requests
    save_as: list_delegation_requests_response
  emit:
    items_for: '{{ list_delegation_requests_response.DelegationRequests }}'
    as: resource
    item:
      delegation_request_id: '{{ resource.DelegationRequestId }}'
      owner_account_id: '{{ resource.OwnerAccountId }}'
      description: '{{ resource.Description }}'
      request_message: '{{ resource.RequestMessage }}'
      permissions: '{{ resource.Permissions }}'
      permission_policy: '{{ resource.PermissionPolicy }}'
      role_permission_restriction_arns: '{{ resource.RolePermissionRestrictionArns
        }}'
      owner_id: '{{ resource.OwnerId }}'
      approver_id: '{{ resource.ApproverId }}'
      state: '{{ resource.State }}'
- discovery_id: aws.iam.create_policy_version
  calls:
  - action: create_policy_version
    save_as: create_policy_version_response
    params:
      PolicyArn: '{{ item.arn }}'
      PolicyDocument: '{{ item.id }}'
    on_error: continue
  for_each: aws.iam.list_instance_profiles
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      document: '{{ create_policy_version_response.PolicyVersion.Document }}'
      version_id: '{{ create_policy_version_response.PolicyVersion.VersionId }}'
      is_default_version: '{{ create_policy_version_response.PolicyVersion.IsDefaultVersion
        }}'
      create_date: '{{ create_policy_version_response.PolicyVersion.CreateDate }}'
- discovery_id: aws.iam.get_saml_provider
  calls:
  - action: get_saml_provider
    save_as: get_saml_provider_response
    params:
      SAMLProviderArn: '{{ item.arn }}'
    on_error: continue
  for_each: aws.iam.list_instance_profiles
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      key_id: '{{ get_saml_provider_response.PrivateKeyList.KeyId }}'
      timestamp: '{{ get_saml_provider_response.PrivateKeyList.Timestamp }}'
- discovery_id: aws.iam.get_access_key_last_used
  calls:
  - action: get_access_key_last_used
    save_as: get_access_key_last_used_response
    params:
      AccessKeyId: '{{ item.access_key_id }}'
    on_error: continue
  for_each: aws.iam.create_access_key
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      last_used_date: '{{ get_access_key_last_used_response.AccessKeyLastUsed.LastUsedDate
        }}'
      service_name: '{{ get_access_key_last_used_response.AccessKeyLastUsed.ServiceName
        }}'
      region: '{{ get_access_key_last_used_response.AccessKeyLastUsed.Region }}'
checks:
- rule_id: aws.iam.password.policy_lowercase_configured
  for_each: aws.iam.get_account_password_policy
  conditions:
    var: item.require_lowercase_characters
    op: equals
    value: true
- rule_id: aws.iam.instanceprofile.no_instance_profile_with_admin_star_configured
  for_each: aws.iam.list_instance_profiles
  conditions:
    var: item.roles
    op: contains
    value: Admin
- rule_id: aws.iam.policy.security_check_full_admin_privileges_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    all:
    - var: item.user_policy_list
      op: equals
      value: []
    - var: item.attached_managed_policies
      op: equals
      value: []
- rule_id: aws.iam.password.policy_minimum_length_14_configured
  for_each: aws.iam.get_account_password_policy
  conditions:
    var: item.minimum_password_length
    op: gte
    value: 14
- rule_id: aws.iam.role.session_duration_reasonable_if_applicable_configured
  for_each: aws.iam.list_roles
  conditions:
    var: item.max_session_duration
    op: lte
    value: 3600
- rule_id: aws.iam.user.inactive_90_days_disabled
  for_each: aws.iam.get_user
  conditions:
    var: item.password_last_used
    op: lte
    value: 90 days ago
- rule_id: aws.iam.policy.conditions_used_if_applicable_configured
  for_each: aws.iam.create_policy_version
  conditions:
    var: item.document
    op: exists
- rule_id: aws.iam.user.no_inline_policies_enabled
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.user_policy_list
    op: equals
    value: []
- rule_id: aws.iam.role.scopes_or_s_least_privilege
  for_each: aws.iam.get_account_authorization_details
  conditions:
    all:
    - var: item.permissions_boundary
      op: exists
    - var: item.attached_managed_policies
      op: equals
      value: []
    - var: item.user_policy_list
      op: equals
      value: []
- rule_id: aws.iam.policy.no_full_access_to_cloudtrail_configured
  for_each: aws.iam.list_policies
  conditions:
    var: item.policy_name
    op: contains
    value: FullAccess
- rule_id: aws.iam.policy.versioning_and_change_audit_enabled
  for_each: aws.iam.create_policy_version
  conditions:
    all:
    - var: item.is_default_version
      op: equals
      value: true
    - var: item.create_date
      op: exists
- rule_id: aws.iam.policy.reuse_24_configured
  for_each: aws.iam.get_account_password_policy
  conditions:
    var: item.password_reuse_prevention
    op: gte
    value: 24
- rule_id: aws.iam.user.console_access_unused_configured
  for_each: aws.iam.get_user
  conditions:
    var: item.password_last_used
    op: exists
- rule_id: aws.iam.role.attached_policies_not_admin_star_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.attached_managed_policies
    op: contains
    value:
    - PolicyName: AdministratorAccess
      PolicyArn: arn:aws:iam::aws:policy/AdministratorAccess
- rule_id: aws.iam.samlprovider.idp_metadata_signed_configured
  for_each: aws.iam.get_saml_provider
  conditions:
    var: item.key_id
    op: exists
- rule_id: aws.iam.policy.no_wildcard_admin_actions_configured
  for_each: aws.iam.create_policy_version
  conditions:
    var: item.document
    op: contains
    value: '*'
- rule_id: aws.iam.resource.access_analyzer_external_all_regions_configured
  for_each: aws.iam.get_access_key_last_used
  conditions:
    var: item.region
    op: exists
- rule_id: aws.iam.policy.least_privilege_audit_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    all:
    - var: item.user_policy_list
      op: equals
      value: []
    - var: item.attached_managed_policies
      op: equals
      value: []
- rule_id: aws.iam.certificate.expired_removal_monitored
  for_each: aws.iam.list_server_certificates
  conditions:
    all:
    - var: item.expiration
      op: exists
    - var: item.upload_date
      op: exists
- rule_id: aws.iam.role.keys_not_used_or_rotated_90_days_or_less_configured
  for_each: aws.iam.create_access_key
  conditions:
    all:
    - var: item.create_date
      op: lte
      value: 90
    - var: item.status
      op: equals
      value: ACTIVE
- rule_id: aws.iam.customer.attached_policy_no_administrative_privileges_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.attached_managed_policies
    op: equals
    value: []
- rule_id: aws.iam.password.policy_reuse_24_configured
  for_each: aws.iam.get_account_password_policy
  conditions:
    var: item.password_reuse_prevention
    op: equals
    value: 24
- rule_id: aws.iam.policy.no_action_star_on_resource_star_configured
  for_each: aws.iam.create_policy_version
  conditions:
    all:
    - var: item.document
      op: contains
      value: '"Action": "*"'
    - var: item.document
      op: contains
      value: '"Resource": "*"'
- rule_id: aws.iam.policy.attached_only_to_group_or_roles_configured
  for_each: aws.iam.list_policies
  conditions:
    var: item.attachment_count
    op: equals
    value: 0
- rule_id: aws.iam.certificate.expiration_removal_monitored
  for_each: aws.iam.list_server_certificates
  conditions:
    var: item.expiration
    op: exists
- rule_id: aws.iam.managedpolicy.editors_rbac_least_privilege
  for_each: aws.iam.get_account_authorization_details
  conditions:
    all:
    - var: item.attached_managed_policies
      op: equals
      value: []
    - var: item.user_policy_list
      op: equals
      value: []
- rule_id: aws.iam.user.access_keys_rotated_90_days_or_less_when_present
  for_each: aws.iam.create_access_key
  conditions:
    var: item.create_date
    op: lte
    value: 90
- rule_id: aws.iam.support.role_created_configured
  for_each: aws.iam.list_roles
  conditions:
    all:
    - var: item.assume_role_policy_document
      op: exists
    - var: item.max_session_duration
      op: gte
      value: 3600
    - var: item.permissions_boundary
      op: exists
- rule_id: aws.iam.user.single_active_access_key_audit_configured
  for_each: aws.iam.create_access_key
  conditions:
    var: item.status
    op: equals
    value: ACTIVE
- rule_id: aws.iam.policy.allows_privilege_escalation_configured
  for_each: aws.iam.create_policy_version
  conditions:
    all:
    - var: item.document
      op: exists
    - var: item.is_default_version
      op: equals
      value: true
- rule_id: aws.iam.resource.root_mfa_enabled
  for_each: aws.iam.create_access_key
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.iam.no.root_access_key_configured
  for_each: aws.iam.create_access_key
  conditions:
    var: item.status
    op: equals
    value: INACTIVE
- rule_id: aws.iam.user.policy_elastic_disaster_recovery_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    any:
    - var: item.user_policy_list
      op: exists
    - var: item.attached_managed_policies
      op: exists
- rule_id: aws.iam.rotate.access_key_90_days_configured
  for_each: aws.iam.create_access_key
  conditions:
    var: item.create_date
    op: lte
    value: 90
- rule_id: aws.iam.policy.no_full_admin_privileges_enabled
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.attached_managed_policies
    op: equals
    value: []
- rule_id: aws.iam.policy.no_administrative_privileges_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    all:
    - var: item.attached_managed_policies
      op: equals
      value: []
    - var: item.user_policy_list
      op: equals
      value: []
- rule_id: aws.iam.group.has_users_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.group_list
    op: exists
- rule_id: aws.iam.policy.minimum_length_14_configured
  for_each: aws.iam.get_account_password_policy
  conditions:
    var: item.minimum_password_length
    op: gte
    value: 14
- rule_id: aws.iam.password.policy_uppercase_configured
  for_each: aws.iam.get_account_password_policy
  conditions:
    var: item.require_uppercase_characters
    op: equals
    value: true
- rule_id: aws.iam.instanceprofile.role_enabled
  for_each: aws.iam.list_instance_profiles
  conditions:
    var: item.roles
    op: exists
- rule_id: aws.iam.user.password_policy_complex_configured
  for_each: aws.iam.get_account_password_policy
  conditions:
    all:
    - var: item.minimum_password_length
      op: gte
      value: 8
    - var: item.require_symbols
      op: equals
      value: true
    - var: item.require_numbers
      op: equals
      value: true
    - var: item.require_uppercase_characters
      op: equals
      value: true
    - var: item.require_lowercase_characters
      op: equals
      value: true
- rule_id: aws.iam.role.no_user_managed_long_lived_keys_configured
  for_each: aws.iam.create_access_key
  conditions:
    var: item.status
    op: equals
    value: INACTIVE
- rule_id: aws.iam.policy.execution_roles_least_privilege
  for_each: aws.iam.get_account_authorization_details
  conditions:
    all:
    - var: item.permissions_boundary
      op: exists
    - var: item.attached_managed_policies
      op: equals
      value: []
- rule_id: aws.iam.samlprovider.assertion_lifetime_configured
  for_each: aws.iam.list_saml_providers
  conditions:
    var: item.valid_until
    op: exists
- rule_id: aws.iam.policy.monitored
  for_each: aws.iam.list_policies
  conditions:
    all:
    - var: item.attachment_count
      op: gt
      value: 0
    - var: item.is_attachable
      op: equals
      value: true
- rule_id: aws.iam.access_analyzer_active_status_all_regions.access_analyzer_active_status_all_regions_configured
  for_each: aws.iam.create_access_key
  conditions:
    var: item.status
    op: equals
    value: ACTIVE
- rule_id: aws.iam.managedpolicy.no_policy_allows_without_constraints_configured
  for_each: aws.iam.list_policies
  conditions:
    var: item.attachment_count
    op: equals
    value: 0
- rule_id: aws.iam.policy.awscloudshell_full_access_restriction_configured
  for_each: aws.iam.list_policies
  conditions:
    all:
    - var: item.policy_name
      op: equals
      value: AWSCloudShellFullAccess
    - var: item.attachment_count
      op: equals
      value: 0
- rule_id: aws.iam.user.single_active_access_key_configured
  for_each: aws.iam.create_access_key
  conditions:
    var: item.status
    op: equals
    value: Active
- rule_id: aws.iam.role.no_inline_policies_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.user_policy_list
    op: equals
    value: []
- rule_id: aws.iam.managedpolicy.versioning_and_change_audit_enabled
  for_each: aws.iam.create_policy_version
  conditions:
    all:
    - var: item.is_default_version
      op: equals
      value: true
    - var: item.create_date
      op: exists
- rule_id: aws.iam.managedpolicy.policy_no_wildcard_admin_actions_configured
  for_each: aws.iam.create_policy_version
  conditions:
    var: item.document
    op: contains
    value: '*'
- rule_id: aws.iam.oidcprovider.certificate_issuer_https_and_matches_discovery_verified
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.arn
    op: contains
    value: https://
- rule_id: aws.iam.group.attached_policies_not_admin_star_configured
  for_each: aws.iam.list_policies
  conditions:
    var: item.policy_name
    op: not_contains
    value:
    - AdministratorAccess
- rule_id: aws.iam.key.rotation_90_days_configured
  for_each: aws.iam.create_access_key
  conditions:
    var: item.create_date
    op: lte
    value: 90
- rule_id: aws.iam.root.hardware_mfa_enabled
  for_each: aws.iam.create_access_key
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.iam.resource.root_hardware_mfa_enabled
  for_each: aws.iam.list_mfa_devices
  conditions:
    var: item.serial_number
    op: exists
- rule_id: aws.iam.managedpolicy.policy_no_action_star_on_resource_star_configured
  for_each: aws.iam.create_policy_version
  conditions:
    all:
    - var: item.document
      op: contains
      value: '"Action": "*"'
    - var: item.document
      op: contains
      value: '"Resource": "*"'
- rule_id: aws.iam.aws.attached_policy_no_administrative_privileges_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.attached_managed_policies
    op: equals
    value: []
- rule_id: aws.iam.group.external_sharing_restricted_if_supported
  for_each: aws.iam.list_policies
  conditions:
    var: item.policy_name
    op: exists
- rule_id: aws.iam.oidcprovider.token_lifetime_configured
  for_each: aws.iam.list_delegation_requests
  conditions:
    var: item.session_duration
    op: lte
    value: 3600
- rule_id: aws.iam.timestream_access_control_and_mfa_enforcement.timestream_access_control_mfa_enforcement_configured
  for_each: aws.iam.create_access_key
  conditions:
    var: item.status
    op: equals
    value: Enabled
- rule_id: aws.iam.samlprovider.certificates_certificate_valid
  for_each: aws.iam.list_saml_providers
  conditions:
    var: item.valid_until
    op: gt
    value: '2023-10-01T00:00:00Z'
- rule_id: aws.iam.managedpolicy.policy_conditions_used_if_applicable_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.permissions_boundary
    op: exists
- rule_id: aws.iam.role.awssupport_access_policy_attachment_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.attached_managed_policies
    op: contains
    value:
    - PolicyName: AWSSupportAccess
      PolicyArn: arn:aws:iam::aws:policy/AWSSupportAccess
- rule_id: aws.iam.password.policy_number_configured
  for_each: aws.iam.get_account_password_policy
  conditions:
    all:
    - var: item.minimum_password_length
      op: gte
      value: 8
    - var: item.require_symbols
      op: equals
      value: true
    - var: item.require_numbers
      op: equals
      value: true
    - var: item.require_uppercase_characters
      op: equals
      value: true
    - var: item.require_lowercase_characters
      op: equals
      value: true
    - var: item.expire_passwords
      op: equals
      value: true
    - var: item.password_reuse_prevention
      op: gte
      value: 5
- rule_id: aws.iam.role.least_privilege
  for_each: aws.iam.get_account_authorization_details
  conditions:
    all:
    - var: item.permissions_boundary
      op: exists
    - var: item.attached_managed_policies
      op: equals
      value: []
    - var: item.user_policy_list
      op: equals
      value: []
- rule_id: aws.iam.policy.workflow_storage_encrypted
  for_each: aws.iam.list_policies
  conditions:
    var: item.attachment_count
    op: gt
    value: 0
- rule_id: aws.iam.no_guest_accounts_with_permissions.no_guest_accounts_with_permissions_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    all:
    - var: item.user_policy_list
      op: equals
      value: []
    - var: item.group_list
      op: equals
      value: []
    - var: item.attached_managed_policies
      op: equals
      value: []
- rule_id: aws.iam.key.monitored
  for_each: aws.iam.create_access_key
  conditions:
    var: item.status
    op: equals
    value: ACTIVE
- rule_id: aws.iam.policy.policy_enabled
  for_each: aws.iam.list_policies
  conditions:
    var: item.is_attachable
    op: equals
    value: true
- rule_id: aws.iam.user.console_password_present_only_if_required
  for_each: aws.iam.get_user
  conditions:
    var: item.password_last_used
    op: exists
- rule_id: aws.iam.managedpolicy.policy_resource_constraints_present
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.permissions_boundary
    op: exists
- rule_id: aws.iam.group.membership_review_enabled_if_supported
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.group_list
    op: exists
- rule_id: aws.iam.root.mfa_enabled
  for_each: aws.iam.create_access_key
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.iam.policy.resource_constraints_present
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.permissions_boundary
    op: exists
- rule_id: aws.iam.password.policy_symbol_configured
  for_each: aws.iam.get_account_password_policy
  conditions:
    var: item.require_symbols
    op: equals
    value: true
- rule_id: aws.iam.role.workload_identity_federation_used_if_supported
  for_each: aws.iam.list_roles
  conditions:
    all:
    - var: item.assume_role_policy_document
      op: exists
    - var: item.arn
      op: exists
- rule_id: aws.iam.samlprovider.audience_restriction_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.arn
    op: exists
- rule_id: aws.iam.inline.policy_no_administrative_privileges_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.user_policy_list
    op: equals
    value: []
- rule_id: aws.iam.role.trust_external_id_or_audience_required
  for_each: aws.iam.list_roles
  conditions:
    var: item.assume_role_policy_document
    op: exists
- rule_id: aws.iam.group.no_inline_policies_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.user_policy_list
    op: equals
    value: []
- rule_id: aws.iam.policy.expires_passwords_within_90_days_or_less_configured
  for_each: aws.iam.get_account_password_policy
  conditions:
    all:
    - var: item.expire_passwords
      op: equals
      value: true
    - var: item.max_password_age
      op: lte
      value: 90
- rule_id: aws.iam.role.max_session_duration_configured
  for_each: aws.iam.list_roles
  conditions:
    var: item.max_session_duration
    op: lte
    value: 3600
- rule_id: aws.iam.policy.overly_permissive_configured
  for_each: aws.iam.list_policies
  conditions:
    any:
    - var: item.attachment_count
      op: equals
      value: 0
    - var: item.is_attachable
      op: equals
      value: false
- rule_id: aws.iam.user.hardware_mfa_enabled
  for_each: aws.iam.create_access_key
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.iam.policy.awscloudshellfullaccess_attachment_configured
  for_each: aws.iam.list_policies
  conditions:
    all:
    - var: item.attachment_count
      op: gt
      value: 0
    - var: item.policy_name
      op: equals
      value: AWSCloudShellFullAccess
- rule_id: aws.iam.oidcprovider.allowed_client_ids_audiences_restricted
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.arn
    op: exists
- rule_id: aws.iam.policy.editors_rbac_least_privilege
  for_each: aws.iam.list_policies
  conditions:
    all:
    - var: item.attachment_count
      op: equals
      value: 0
    - var: item.is_attachable
      op: equals
      value: false
- rule_id: aws.iam.user.no_inline_policies_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.user_policy_list
    op: equals
    value: []
- rule_id: aws.iam.user.in_group_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.group_list
    op: exists
- rule_id: aws.iam.role.trust_principals_allowlist_only_configured
  for_each: aws.iam.list_roles
  conditions:
    var: item.assume_role_policy_document
    op: contains
    value:
    - AllowlistPrincipalArn1
    - AllowlistPrincipalArn2
- rule_id: aws.iam.instanceprofile.no_admin_star_policies_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.attached_managed_policies
    op: equals
    value: []
- rule_id: aws.iam.role.creation_monitored
  for_each: aws.iam.list_roles
  conditions:
    all:
    - var: item.create_date
      op: exists
    - var: item.assume_role_policy_document
      op: exists
    - var: item.tags
      op: exists
- rule_id: aws.iam.policy.no_policies_without_constraints_configured
  for_each: aws.iam.get_account_authorization_details
  conditions:
    var: item.permissions_boundary
    op: exists
