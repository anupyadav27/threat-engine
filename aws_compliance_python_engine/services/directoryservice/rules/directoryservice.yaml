version: '1.0'
provider: aws
service: directoryservice
services:
  client: directoryservice
  module: boto3.client
discovery:
- discovery_id: aws.directoryservice.list_a_d_assessments
  calls:
  - action: list_ad_assessments
    save_as: response
  emit:
    items_for: '{{ response.Assessments }}'
    as: resource
    item:
      AssessmentId: '{{ resource.AssessmentId }}'
      DirectoryId: '{{ resource.DirectoryId }}'
      DnsName: '{{ resource.DnsName }}'
      StartTime: '{{ resource.StartTime }}'
      LastUpdateDateTime: '{{ resource.LastUpdateDateTime }}'
      Status: '{{ resource.Status }}'
      CustomerDnsIps: '{{ resource.CustomerDnsIps }}'
      ReportType: '{{ resource.ReportType }}'
- discovery_id: aws.directoryservice.describe_client_authentication_settings
  calls:
  - action: describe_client_authentication_settings
    save_as: response
    params:
      DirectoryId: '{{ item.DirectoryId }}'
  for_each: aws.directoryservice.list_a_d_assessments
  on_error: continue
  emit:
    item:
      Type: '{{ response.ClientAuthenticationSettingsInfo.Type }}'
      Status: '{{ response.ClientAuthenticationSettingsInfo.Status }}'
      LastUpdatedDateTime: '{{ response.ClientAuthenticationSettingsInfo.LastUpdatedDateTime
        }}'
      ClientAuthenticationSettingsInfo: '{{ resource.ClientAuthenticationSettingsInfo
        }}'
- discovery_id: aws.directoryservice.list_log_subscriptions
  calls:
  - action: list_log_subscriptions
    save_as: response
  emit:
    items_for: '{{ response.LogSubscriptions }}'
    as: resource
    item:
      DirectoryId: '{{ resource.DirectoryId }}'
      LogGroupName: '{{ resource.LogGroupName }}'
      SubscriptionCreatedDateTime: '{{ resource.SubscriptionCreatedDateTime }}'
checks:
- rule_id: aws.directoryservice.resource.supported_mfa_radius_enabled
  for_each: aws.directoryservice.describe_client_authentication_settings
  conditions:
    var: item.ClientAuthenticationSettingsInfo
    op: not_equals
    value: 'null'
- rule_id: aws.directoryservice.resource.directoryservice_directory_log_forwarding_enabled
  for_each: aws.directoryservice.list_log_subscriptions
  conditions:
    var: item.LogGroupName
    op: not_equals
    value: 'null'
