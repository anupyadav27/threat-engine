version: '1.0'
provider: aws
service: detective
services:
  client: detective
  module: boto3.client
discovery:
- discovery_id: aws.detective.list_invitations
  calls:
  - action: list_invitations
    save_as: response
  emit:
    items_for: '{{ response.Invitations }}'
    as: resource
    item:
      AccountId: '{{ resource.AccountId }}'
      EmailAddress: '{{ resource.EmailAddress }}'
      GraphArn: '{{ resource.GraphArn }}'
      MasterId: '{{ resource.MasterId }}'
      AdministratorId: '{{ resource.AdministratorId }}'
      Status: '{{ resource.Status }}'
      DisabledReason: '{{ resource.DisabledReason }}'
      InvitedTime: '{{ resource.InvitedTime }}'
      UpdatedTime: '{{ resource.UpdatedTime }}'
      VolumeUsageInBytes: '{{ resource.VolumeUsageInBytes }}'
      VolumeUsageUpdatedTime: '{{ resource.VolumeUsageUpdatedTime }}'
      PercentOfGraphUtilization: '{{ resource.PercentOfGraphUtilization }}'
      PercentOfGraphUtilizationUpdatedTime: '{{ resource.PercentOfGraphUtilizationUpdatedTime
        }}'
      InvitationType: '{{ resource.InvitationType }}'
      VolumeUsageByDatasourcePackage: '{{ resource.VolumeUsageByDatasourcePackage
        }}'
      DatasourcePackageIngestStates: '{{ resource.DatasourcePackageIngestStates }}'
- discovery_id: aws.detective.list_graphs
  calls:
  - action: list_graphs
    save_as: response
  emit:
    items_for: '{{ response.GraphList }}'
    as: resource
    item:
      Arn: '{{ resource.Arn }}'
      CreatedTime: '{{ resource.CreatedTime }}'
- discovery_id: aws.detective.describe_organization_configuration
  calls:
  - action: describe_organization_configuration
    save_as: response
    params:
      GraphArn: '{{ item.Arn }}'
  for_each: aws.detective.list_graphs
  on_error: continue
  emit:
    item:
      AutoEnable: '{{ response.AutoEnable }}'
checks:
- rule_id: aws.detective.member.detective_enabled_in_all_regions
  for_each: aws.detective.list_invitations
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.detective.graph.detective_finding_export_encrypted_destination
  for_each: aws.detective.list_invitations
  conditions:
    var: item.GraphArn
    op: not_equals
    value: 'null'
- rule_id: aws.detective.graph.detective_enabled_in_all_regions
  for_each: aws.detective.describe_organization_configuration
  conditions:
    var: item.AutoEnable
    op: equals
    value: 'true'
- rule_id: aws.detective.member.detective_finding_export_encrypted_destination
  for_each: aws.detective.list_invitations
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
