version: '1.0'
provider: aws
service: lambda
discovery:
- discovery_id: aws.lambda.list_functions
  calls:
  - action: list_functions
    save_as: list_functions_response
  emit:
    items_for: '{{ list_functions_response.Functions }}'
    as: resource
    item:
      function_name: '{{ resource.FunctionName }}'
      function_arn: '{{ resource.FunctionArn }}'
      runtime: '{{ resource.Runtime }}'
      role: '{{ resource.Role }}'
      handler: '{{ resource.Handler }}'
      code_size: '{{ resource.CodeSize }}'
      description: '{{ resource.Description }}'
      timeout: '{{ resource.Timeout }}'
      memory_size: '{{ resource.MemorySize }}'
      last_modified: '{{ resource.LastModified }}'
- discovery_id: aws.lambda.get_account_settings
  calls:
  - action: get_account_settings
    save_as: get_account_settings_response
  emit:
    items_for: '{{ get_account_settings_response.AccountLimit }}'
    as: resource
    item:
      total_code_size: '{{ resource.TotalCodeSize }}'
      code_size_unzipped: '{{ resource.CodeSizeUnzipped }}'
      code_size_zipped: '{{ resource.CodeSizeZipped }}'
      concurrent_executions: '{{ resource.ConcurrentExecutions }}'
      unreserved_concurrent_executions: '{{ resource.UnreservedConcurrentExecutions
        }}'
- discovery_id: aws.lambda.list_event_source_mappings
  calls:
  - action: list_event_source_mappings
    save_as: list_event_source_mappings_response
  emit:
    items_for: '{{ list_event_source_mappings_response.EventSourceMappings }}'
    as: resource
    item:
      uuid: '{{ resource.UUID }}'
      starting_position: '{{ resource.StartingPosition }}'
      starting_position_timestamp: '{{ resource.StartingPositionTimestamp }}'
      batch_size: '{{ resource.BatchSize }}'
      maximum_batching_window_in_seconds: '{{ resource.MaximumBatchingWindowInSeconds
        }}'
      parallelization_factor: '{{ resource.ParallelizationFactor }}'
      event_source_arn: '{{ resource.EventSourceArn }}'
      filter_criteria: '{{ resource.FilterCriteria }}'
      function_arn: '{{ resource.FunctionArn }}'
      last_modified: '{{ resource.LastModified }}'
- discovery_id: aws.lambda.list_code_signing_configs
  calls:
  - action: list_code_signing_configs
    save_as: list_code_signing_configs_response
  emit:
    items_for: '{{ list_code_signing_configs_response.CodeSigningConfigs }}'
    as: resource
    item:
      code_signing_config_id: '{{ resource.CodeSigningConfigId }}'
      code_signing_config_arn: '{{ resource.CodeSigningConfigArn }}'
      description: '{{ resource.Description }}'
      allowed_publishers: '{{ resource.AllowedPublishers }}'
      code_signing_policies: '{{ resource.CodeSigningPolicies }}'
      last_modified: '{{ resource.LastModified }}'
- discovery_id: aws.lambda.create_function_url_config
  calls:
  - action: create_function_url_config
    save_as: create_function_url_config_response
    params:
      FunctionName: '{{ item.function_name }}'
      AuthType: '{{ item.api_id }}'
    on_error: continue
  for_each: aws.lambda.list_functions
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      allow_credentials: '{{ create_function_url_config_response.Cors.AllowCredentials
        }}'
      allow_headers: '{{ create_function_url_config_response.Cors.AllowHeaders }}'
      allow_methods: '{{ create_function_url_config_response.Cors.AllowMethods }}'
      allow_origins: '{{ create_function_url_config_response.Cors.AllowOrigins }}'
      expose_headers: '{{ create_function_url_config_response.Cors.ExposeHeaders }}'
- discovery_id: aws.lambda.list_function_url_configs
  calls:
  - action: list_function_url_configs
    save_as: list_function_url_configs_response
    params:
      FunctionName: '{{ item.function_name }}'
    on_error: continue
  for_each: aws.lambda.list_functions
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      function_url: '{{ list_function_url_configs_response.FunctionUrlConfigs.FunctionUrl
        }}'
      function_arn: '{{ list_function_url_configs_response.FunctionUrlConfigs.FunctionArn
        }}'
      creation_time: '{{ list_function_url_configs_response.FunctionUrlConfigs.CreationTime
        }}'
      last_modified_time: '{{ list_function_url_configs_response.FunctionUrlConfigs.LastModifiedTime
        }}'
      cors: '{{ list_function_url_configs_response.FunctionUrlConfigs.Cors }}'
checks:
- rule_id: aws.lambda.function.execution_role_existence_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.role
    op: exists
- rule_id: aws.lambda.function.runtime_support_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.runtime
    op: contains
    value:
    - nodejs14.x
    - python3.8
    - java11
    - go1.x
    - ruby2.7
    - provided.al2
- rule_id: aws.lambda.function.vpc_private_networking_enabled
  for_each: aws.lambda.list_functions
  conditions:
    var: item.vpc_config
    op: exists
- rule_id: aws.lambda.function.env_no_plaintext_secrets_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.environment
    op: equals
    value: []
- rule_id: aws.lambda.function.restrict_public_access_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.vpc_config
    op: exists
- rule_id: aws.lambda.function.execution_roles_least_privilege
  for_each: aws.lambda.list_functions
  conditions:
    var: item.role
    op: exists
- rule_id: aws.lambda.function.environment_variables_kms_encryption_enabled
  for_each: aws.lambda.list_functions
  conditions:
    var: item.environment
    op: exists
- rule_id: aws.lambda.function.logging_and_tracing_enabled
  for_each: aws.lambda.list_functions
  conditions:
    all:
    - var: item.role
      op: exists
    - var: item.environment
      op: exists
- rule_id: aws.lambda.function.url_cors_policy_configured
  for_each: aws.lambda.create_function_url_config
  conditions:
    all:
    - var: item.allow_credentials
      op: equals
      value: true
    - var: item.allow_headers
      op: exists
    - var: item.allow_methods
      op: exists
    - var: item.allow_origins
      op: exists
    - var: item.expose_headers
      op: exists
    - var: item.max_age
      op: exists
- rule_id: aws.lambda.function.dead_letter_queue_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.dead_letter_config
    op: exists
- rule_id: aws.lambda.function.outputs_encrypted
  for_each: aws.lambda.list_functions
  conditions:
    var: item.environment
    op: exists
- rule_id: aws.lambda.function.vpc_multi_az_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.vpc_config
    op: exists
- rule_id: aws.lambda.function.unique_iam_role_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.role
    op: exists
- rule_id: aws.lambda.function.execution_role_no_admin_privileges_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.role
    op: not_contains
    value: AdministratorAccess
- rule_id: aws.lambda.function.reserved_concurrency_configured
  for_each: aws.lambda.get_account_settings
  conditions:
    var: item.unreserved_concurrent_executions
    op: gt
    value: 0
- rule_id: aws.lambda.function.cloudwatch_lambda_insights_enabled
  for_each: aws.lambda.list_event_source_mappings
  conditions:
    var: item.state
    op: equals
    value: ENABLED
- rule_id: aws.lambda.function.not_publicly_accessible_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.vpc_config
    op: exists
- rule_id: aws.lambda.function.inside_vpc_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.vpc_config
    op: exists
- rule_id: aws.lambda.function.code_signing_config_present
  for_each: aws.lambda.list_code_signing_configs
  conditions:
    var: item.code_signing_config_id
    op: exists
- rule_id: aws.lambda.provisioned_concurrency.execution_role_least_privilege
  for_each: aws.lambda.list_functions
  conditions:
    var: item.role
    op: exists
- rule_id: aws.lambda.layer.version_immutable_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.version
    op: exists
- rule_id: aws.lambda.function.invoke_api_operations_cloudtrail_logging_enabled
  for_each: aws.lambda.list_event_source_mappings
  conditions:
    var: item.state
    op: equals
    value: ENABLED
- rule_id: aws.lambda.function.change_audit_logging_enabled
  for_each: aws.lambda.list_event_source_mappings
  conditions:
    var: item.state
    op: equals
    value: ENABLED
- rule_id: aws.lambda.function.url_authentication_configured
  for_each: aws.lambda.list_function_url_configs
  conditions:
    var: item.auth_type
    op: equals
    value: AWS_IAM
- rule_id: aws.lambda.function.remediation_roles_least_privilege
  for_each: aws.lambda.list_functions
  conditions:
    var: item.role
    op: exists
- rule_id: aws.lambda.layer.source_trusted_configured
  for_each: aws.lambda.list_code_signing_configs
  conditions:
    all:
    - var: item.allowed_publishers
      op: exists
    - var: item.code_signing_policies
      op: exists
- rule_id: aws.lambda.function.url_public_configured
  for_each: aws.lambda.list_function_url_configs
  conditions:
    var: item.auth_type
    op: equals
    value: AWS_IAM
- rule_id: aws.lambda.event_source_mapping.permissions_least_privilege
  for_each: aws.lambda.list_event_source_mappings
  conditions:
    all:
    - var: item.state
      op: equals
      value: ENABLED
    - var: item.function_arn
      op: exists
- rule_id: aws.lambda.function.artifacts_encrypted_and_private
  for_each: aws.lambda.list_code_signing_configs
  conditions:
    all:
    - var: item.code_signing_config_id
      op: exists
    - var: item.allowed_publishers
      op: not_equals
      value: []
- rule_id: aws.lambda.function.role_least_privilege
  for_each: aws.lambda.list_functions
  conditions:
    var: item.role
    op: exists
- rule_id: aws.lambda.function.policies_present_for_sensitive_fields_configured
  for_each: aws.lambda.list_code_signing_configs
  conditions:
    all:
    - var: item.code_signing_policies
      op: exists
    - var: item.allowed_publishers
      op: exists
- rule_id: aws.lambda.function.jobs_private_networking_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.vpc_config
    op: exists
- rule_id: aws.lambda.event_source_mapping.source_authenticated_configured
  for_each: aws.lambda.list_event_source_mappings
  conditions:
    all:
    - var: item.state
      op: equals
      value: ENABLED
    - var: item.destination_config
      op: exists
- rule_id: aws.lambda.function.resource_policy_cross_account_access_configured
  for_each: aws.lambda.list_event_source_mappings
  conditions:
    var: item.function_arn
    op: exists
