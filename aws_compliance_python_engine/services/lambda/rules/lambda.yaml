version: '1.0'
provider: aws
service: lambda
services:
  client: lambda
  module: boto3.client
discovery:
- discovery_id: aws.lambda.get_account_settings
  calls:
  - action: get_account_settings
    save_as: response
  emit:
    item:
      TotalCodeSize: '{{ response.AccountLimit.TotalCodeSize }}'
      CodeSizeUnzipped: '{{ response.AccountLimit.CodeSizeUnzipped }}'
      CodeSizeZipped: '{{ response.AccountLimit.CodeSizeZipped }}'
      ConcurrentExecutions: '{{ response.AccountLimit.ConcurrentExecutions }}'
      UnreservedConcurrentExecutions: '{{ response.AccountLimit.UnreservedConcurrentExecutions
        }}'
- discovery_id: aws.lambda.list_code_signing_configs
  calls:
  - action: list_code_signing_configs
    save_as: response
  emit:
    items_for: '{{ response.CodeSigningConfigs }}'
    as: resource
    item:
      CodeSigningConfigId: '{{ resource.CodeSigningConfigId }}'
      CodeSigningConfigArn: '{{ resource.CodeSigningConfigArn }}'
      Description: '{{ resource.Description }}'
      AllowedPublishers: '{{ resource.AllowedPublishers }}'
      CodeSigningPolicies: '{{ resource.CodeSigningPolicies }}'
      LastModified: '{{ resource.LastModified }}'
- discovery_id: aws.lambda.list_event_source_mappings
  calls:
  - action: list_event_source_mappings
    save_as: response
  emit:
    items_for: '{{ response.EventSourceMappings }}'
    as: resource
    item:
      UUID: '{{ resource.UUID }}'
      StartingPosition: '{{ resource.StartingPosition }}'
      StartingPositionTimestamp: '{{ resource.StartingPositionTimestamp }}'
      BatchSize: '{{ resource.BatchSize }}'
      MaximumBatchingWindowInSeconds: '{{ resource.MaximumBatchingWindowInSeconds
        }}'
      ParallelizationFactor: '{{ resource.ParallelizationFactor }}'
      EventSourceArn: '{{ resource.EventSourceArn }}'
      FilterCriteria: '{{ resource.FilterCriteria }}'
      FunctionArn: '{{ resource.FunctionArn }}'
      LastModified: '{{ resource.LastModified }}'
      LastProcessingResult: '{{ resource.LastProcessingResult }}'
      State: '{{ resource.State }}'
      StateTransitionReason: '{{ resource.StateTransitionReason }}'
      DestinationConfig: '{{ resource.DestinationConfig }}'
      Topics: '{{ resource.Topics }}'
      Queues: '{{ resource.Queues }}'
      SourceAccessConfigurations: '{{ resource.SourceAccessConfigurations }}'
      SelfManagedEventSource: '{{ resource.SelfManagedEventSource }}'
      MaximumRecordAgeInSeconds: '{{ resource.MaximumRecordAgeInSeconds }}'
      BisectBatchOnFunctionError: '{{ resource.BisectBatchOnFunctionError }}'
      MaximumRetryAttempts: '{{ resource.MaximumRetryAttempts }}'
      TumblingWindowInSeconds: '{{ resource.TumblingWindowInSeconds }}'
      FunctionResponseTypes: '{{ resource.FunctionResponseTypes }}'
      AmazonManagedKafkaEventSourceConfig: '{{ resource.AmazonManagedKafkaEventSourceConfig
        }}'
      SelfManagedKafkaEventSourceConfig: '{{ resource.SelfManagedKafkaEventSourceConfig
        }}'
      ScalingConfig: '{{ resource.ScalingConfig }}'
      DocumentDBEventSourceConfig: '{{ resource.DocumentDBEventSourceConfig }}'
      KMSKeyArn: '{{ resource.KMSKeyArn }}'
      FilterCriteriaError: '{{ resource.FilterCriteriaError }}'
      EventSourceMappingArn: '{{ resource.EventSourceMappingArn }}'
      MetricsConfig: '{{ resource.MetricsConfig }}'
      ProvisionedPollerConfig: '{{ resource.ProvisionedPollerConfig }}'
- discovery_id: aws.lambda.list_functions
  calls:
  - action: list_functions
    save_as: response
  emit:
    items_for: '{{ response.Functions }}'
    as: resource
    item:
      FunctionName: '{{ resource.FunctionName }}'
      FunctionArn: '{{ resource.FunctionArn }}'
      Runtime: '{{ resource.Runtime }}'
      Role: '{{ resource.Role }}'
      Handler: '{{ resource.Handler }}'
      CodeSize: '{{ resource.CodeSize }}'
      Description: '{{ resource.Description }}'
      Timeout: '{{ resource.Timeout }}'
      MemorySize: '{{ resource.MemorySize }}'
      LastModified: '{{ resource.LastModified }}'
      CodeSha256: '{{ resource.CodeSha256 }}'
      Version: '{{ resource.Version }}'
      VpcConfig: '{{ resource.VpcConfig }}'
      DeadLetterConfig: '{{ resource.DeadLetterConfig }}'
      Environment: '{{ resource.Environment }}'
      KMSKeyArn: '{{ resource.KMSKeyArn }}'
      TracingConfig: '{{ resource.TracingConfig }}'
      MasterArn: '{{ resource.MasterArn }}'
      RevisionId: '{{ resource.RevisionId }}'
      Layers: '{{ resource.Layers }}'
      State: '{{ resource.State }}'
      StateReason: '{{ resource.StateReason }}'
      StateReasonCode: '{{ resource.StateReasonCode }}'
      LastUpdateStatus: '{{ resource.LastUpdateStatus }}'
      LastUpdateStatusReason: '{{ resource.LastUpdateStatusReason }}'
      LastUpdateStatusReasonCode: '{{ resource.LastUpdateStatusReasonCode }}'
      FileSystemConfigs: '{{ resource.FileSystemConfigs }}'
      PackageType: '{{ resource.PackageType }}'
      ImageConfigResponse: '{{ resource.ImageConfigResponse }}'
      SigningProfileVersionArn: '{{ resource.SigningProfileVersionArn }}'
      SigningJobArn: '{{ resource.SigningJobArn }}'
      Architectures: '{{ resource.Architectures }}'
      EphemeralStorage: '{{ resource.EphemeralStorage }}'
      SnapStart: '{{ resource.SnapStart }}'
      RuntimeVersionConfig: '{{ resource.RuntimeVersionConfig }}'
      LoggingConfig: '{{ resource.LoggingConfig }}'
      TenancyConfig: '{{ resource.TenancyConfig }}'
- discovery_id: aws.lambda.list_function_url_configs
  calls:
  - action: list_function_url_configs
    save_as: response
    params:
      FunctionName: '{{ item.FunctionName }}'
  on_error: continue
  for_each: aws.lambda.list_functions
  emit:
    items_for: '{{ response.FunctionUrlConfigs }}'
    as: resource
    item:
      FunctionUrl: '{{ resource.FunctionUrl }}'
      FunctionArn: '{{ resource.FunctionArn }}'
      CreationTime: '{{ resource.CreationTime }}'
      LastModifiedTime: '{{ resource.LastModifiedTime }}'
      Cors: '{{ resource.Cors }}'
      AuthType: '{{ resource.AuthType }}'
      InvokeMode: '{{ resource.InvokeMode }}'
checks:
- rule_id: aws.lambda.function.execution_role_existence_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.Role
    op: exists
- rule_id: aws.lambda.function.runtime_support_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.Runtime
    op: contains
    value:
    - nodejs14.x
    - python3.8
    - java11
    - go1.x
    - ruby2.7
    - provided.al2
- rule_id: aws.lambda.function.vpc_private_networking_enabled
  for_each: aws.lambda.list_functions
  conditions:
    var: item.VpcConfig
    op: exists
- rule_id: aws.lambda.function.env_no_plaintext_secrets_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.Environment
    op: equals
    value: []
- rule_id: aws.lambda.function.restrict_public_access_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.VpcConfig
    op: exists
- rule_id: aws.lambda.function.execution_roles_least_privilege
  for_each: aws.lambda.list_functions
  conditions:
    var: item.Role
    op: exists
- rule_id: aws.lambda.function.environment_variables_kms_encryption_enabled
  for_each: aws.lambda.list_functions
  conditions:
    var: item.Environment
    op: exists
- rule_id: aws.lambda.function.dead_letter_queue_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.DeadLetterConfig
    op: exists
- rule_id: aws.lambda.function.outputs_encrypted
  for_each: aws.lambda.list_functions
  conditions:
    var: item.Environment
    op: exists
- rule_id: aws.lambda.function.vpc_multi_az_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.VpcConfig
    op: exists
- rule_id: aws.lambda.function.unique_iam_role_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.Role
    op: exists
- rule_id: aws.lambda.function.execution_role_no_admin_privileges_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.Role
    op: not_contains
    value: AdministratorAccess
- rule_id: aws.lambda.function.reserved_concurrency_configured
  for_each: aws.lambda.get_account_settings
  conditions:
    var: item.UnreservedConcurrentExecutions
    op: gt
    value: 0
- rule_id: aws.lambda.function.cloudwatch_lambda_insights_enabled
  for_each: aws.lambda.list_event_source_mappings
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.lambda.function.not_publicly_accessible_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.VpcConfig
    op: exists
- rule_id: aws.lambda.function.inside_vpc_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.VpcConfig
    op: exists
- rule_id: aws.lambda.function.code_signing_config_present
  for_each: aws.lambda.list_code_signing_configs
  conditions:
    var: item.CodeSigningConfigId
    op: exists
- rule_id: aws.lambda.provisioned_concurrency.execution_role_least_privilege
  for_each: aws.lambda.list_functions
  conditions:
    var: item.Role
    op: exists
- rule_id: aws.lambda.layer.version_immutable_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.Version
    op: exists
- rule_id: aws.lambda.function.invoke_api_operations_cloudtrail_logging_enabled
  for_each: aws.lambda.list_event_source_mappings
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.lambda.function.change_audit_logging_enabled
  for_each: aws.lambda.list_event_source_mappings
  conditions:
    var: item.State
    op: equals
    value: ENABLED
- rule_id: aws.lambda.function.url_authentication_configured
  for_each: aws.lambda.list_function_url_configs
  conditions:
    var: item.AuthType
    op: equals
    value: AWS_IAM
- rule_id: aws.lambda.function.remediation_roles_least_privilege
  for_each: aws.lambda.list_functions
  conditions:
    var: item.Role
    op: exists
- rule_id: aws.lambda.function.url_public_configured
  for_each: aws.lambda.list_function_url_configs
  conditions:
    var: item.AuthType
    op: equals
    value: AWS_IAM
- rule_id: aws.lambda.function.role_least_privilege
  for_each: aws.lambda.list_functions
  conditions:
    var: item.Role
    op: exists
- rule_id: aws.lambda.function.jobs_private_networking_configured
  for_each: aws.lambda.list_functions
  conditions:
    var: item.VpcConfig
    op: exists
- rule_id: aws.lambda.function.resource_policy_cross_account_access_configured
  for_each: aws.lambda.list_event_source_mappings
  conditions:
    var: item.FunctionArn
    op: exists
