version: '1.0'
provider: aws
service: lambda
discovery:
- discovery_id: aws.lambda.provisioned_concurrencys
  calls:
  - client: lambda
    action: list_functions
    save_as: provisioned_concurrency_list
    on_error: continue
    fields:
    - Functions
  emit:
    items_for: provisioned_concurrency_list[]
    as: provisioned_concurrency
    item:
      id: '{{ provisioned_concurrency.FunctionArn }}'
      name: '{{ provisioned_concurrency.FunctionName }}'
- discovery_id: aws.lambda.provisioned_concurrency_encryption
  for_each: aws.lambda.provisioned_concurrencys
  calls:
  - client: lambda
    action: list_functions
    params:
      Provisioned_concurrencyId: '{{ item.id }}'
    save_as: encryption
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      encryption_enabled: '{{ encryption.Encrypted if encryption.Encrypted is defined
        else false }}'
- discovery_id: aws.lambda.provisioned_concurrency_logging
  for_each: aws.lambda.provisioned_concurrencys
  calls:
  - client: lambda
    action: describe_provisioned_concurrency_logging
    params:
      Provisioned_concurrencyId: '{{ item.id }}'
    save_as: logging
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      logging_enabled: '{{ logging.LoggingEnabled is defined if logging else false
        }}'
- discovery_id: aws.lambda.layers
  for_each: aws.lambda.layer
  calls:
  - client: lambda
    action: describe_layers
    save_as: layers
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.lambda.event_source_mappings
  for_each: aws.lambda.event_source_mapping
  calls:
  - client: lambda
    action: describe_event_source_mappings
    save_as: event_source_mappings
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.lambda.versions
  for_each: aws.lambda.version
  calls:
  - client: lambda
    action: describe_versions
    save_as: versions
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.lambda.functions
  for_each: aws.lambda.function
  calls:
  - client: lambda
    action: describe_functions
    save_as: functions
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.lambda.function_logging
  calls:
  - client: lambda
    action: list_aliases
    save_as: function_logging
    on_error: continue
  emit:
    items_for: function_logging[]
    as: function_logging
    item:
      id: '{{ function_logging.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.lambda.function_encryption
  calls:
  - client: lambda
    action: list_aliases
    save_as: function_encryption
    on_error: continue
  emit:
    items_for: function_encryption[]
    as: function_encryption
    item:
      id: '{{ function_encryption.Id }}'
      compliant: '{{ true }}'
checks:
- title: 'LAMBDA function: Execution Role Existence Configured'
  severity: high
  rule_id: aws.lambda.function.execution_role_existence_configured
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.compliant
    op: equals
    value: true
- title: 'LAMBDA function: Runtime Support Configured'
  severity: medium
  rule_id: aws.lambda.function.runtime_support_configured
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.compliant
    op: equals
    value: true
- title: 'LAMBDA function: Vpc Private Networking Enabled'
  severity: high
  rule_id: aws.lambda.function.vpc_private_networking_enabled
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.is_public
    op: equals
    value: false
- title: 'LAMBDA function: Env No Plaintext Secrets Configured'
  severity: medium
  rule_id: aws.lambda.function.env_no_plaintext_secrets_configured
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.compliant
    op: equals
    value: true
- title: 'LAMBDA function: Restrict Public Access Configured'
  severity: high
  rule_id: aws.lambda.function.restrict_public_access_configured
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.is_public
    op: equals
    value: false
- title: 'LAMBDA function: Execution Roles Least Privilege'
  severity: high
  rule_id: aws.lambda.function.execution_roles_least_privilege
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.is_public
    op: equals
    value: false
- title: 'LAMBDA version: Published And Immutable Configured'
  severity: medium
  rule_id: aws.lambda.version.published_and_immutable_configured
  for_each:
    discovery: aws.lambda.versions
    as: version
    item: version
  conditions:
    var: version.versioning_enabled
    op: equals
    value: true
- title: Environment variables are encrypted in serverless functions
  severity: high
  rule_id: aws.lambda.function.environment_variables_kms_encryption_enabled
  for_each:
    discovery: aws.lambda.function_encryption
    as: function
    item: function
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'LAMBDA function: Logging And Tracing Enabled'
  severity: medium
  rule_id: aws.lambda.function.logging_and_tracing_enabled
  for_each:
    discovery: aws.lambda.function_logging
    as: function
    item: function
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'LAMBDA function: Url Cors Policy Configured'
  severity: high
  rule_id: aws.lambda.function.url_cors_policy_configured
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.is_public
    op: equals
    value: false
- title: 'LAMBDA function: Dead Letter Queue Configured'
  severity: medium
  rule_id: aws.lambda.function.dead_letter_queue_configured
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.compliant
    op: equals
    value: true
- title: 'LAMBDA function: Outputs Encrypted'
  severity: high
  rule_id: aws.lambda.function.outputs_encrypted
  for_each:
    discovery: aws.lambda.function_encryption
    as: function
    item: function
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'LAMBDA function: Vpc Multi Az Configured'
  severity: high
  rule_id: aws.lambda.function.vpc_multi_az_configured
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.in_vpc
    op: equals
    value: true
- title: 'LAMBDA function: Unique Iam Role Configured'
  severity: high
  rule_id: aws.lambda.function.unique_iam_role_configured
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.is_public
    op: equals
    value: false
- title: 'LAMBDA function: Execution Role No Admin Privileges Configured'
  severity: high
  rule_id: aws.lambda.function.execution_role_no_admin_privileges_configured
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.compliant
    op: equals
    value: true
- title: 'LAMBDA function: Reserved Concurrency Configured'
  severity: medium
  rule_id: aws.lambda.function.reserved_concurrency_configured
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.compliant
    op: equals
    value: true
- title: 'LAMBDA function: Cloudwatch Lambda Insights Enabled'
  severity: medium
  rule_id: aws.lambda.function.cloudwatch_lambda_insights_enabled
  for_each:
    discovery: aws.lambda.function_logging
    as: function
    item: function
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'LAMBDA function: Not Publicly Accessible Configured'
  severity: high
  rule_id: aws.lambda.function.not_publicly_accessible_configured
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.is_public
    op: equals
    value: false
- title: 'LAMBDA function: Inside Vpc Configured'
  severity: high
  rule_id: aws.lambda.function.inside_vpc_configured
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.in_vpc
    op: equals
    value: true
- title: 'LAMBDA function: Code Signing Config Present'
  severity: medium
  rule_id: aws.lambda.function.code_signing_config_present
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.compliant
    op: equals
    value: true
- title: 'LAMBDA provisioned concurrency: Execution Role Least Privilege'
  severity: high
  rule_id: aws.lambda.provisioned_concurrency.execution_role_least_privilege
  for_each:
    discovery: aws.lambda.provisioned_concurrencys
    as: provisioned_concurrency
    item: provisioned_concurrency
  conditions:
    var: provisioned_concurrency.is_public
    op: equals
    value: false
- title: 'LAMBDA layer: Version Immutable Configured'
  severity: low
  rule_id: aws.lambda.layer.version_immutable_configured
  for_each:
    discovery: aws.lambda.layers
    as: layer
    item: layer
  conditions:
    var: layer.versioning_enabled
    op: equals
    value: true
- title: 'LAMBDA function: Invoke Api Operations Cloudtrail Logging Enabled'
  severity: medium
  rule_id: aws.lambda.function.invoke_api_operations_cloudtrail_logging_enabled
  for_each:
    discovery: aws.lambda.function_logging
    as: function
    item: function
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: Audit secret access by functions
  severity: medium
  rule_id: aws.lambda.function.change_audit_logging_enabled
  for_each:
    discovery: aws.lambda.function_logging
    as: function
    item: function
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'LAMBDA function: Url Authentication Configured'
  severity: critical
  rule_id: aws.lambda.function.url_authentication_configured
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.compliant
    op: equals
    value: true
- title: 'LAMBDA version: Rollforward Rollback Controls Present'
  severity: medium
  rule_id: aws.lambda.version.rollforward_rollback_controls_present
  for_each:
    discovery: aws.lambda.versions
    as: version
    item: version
  conditions:
    var: version.versioning_enabled
    op: equals
    value: true
- title: 'LAMBDA function: Remediation Roles Least Privilege'
  severity: high
  rule_id: aws.lambda.function.remediation_roles_least_privilege
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.is_public
    op: equals
    value: false
- title: 'LAMBDA layer: Source Trusted Configured'
  severity: medium
  rule_id: aws.lambda.layer.source_trusted_configured
  for_each:
    discovery: aws.lambda.layers
    as: layer
    item: layer
  conditions:
    var: layer.compliant
    op: equals
    value: true
- title: 'LAMBDA function: Url Public Configured'
  severity: high
  rule_id: aws.lambda.function.url_public_configured
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.is_public
    op: equals
    value: false
- title: 'LAMBDA event source mapping: Permissions Least Privilege'
  severity: high
  rule_id: aws.lambda.event_source_mapping.permissions_least_privilege
  for_each:
    discovery: aws.lambda.event_source_mappings
    as: event_source_mapping
    item: event_source_mapping
  conditions:
    var: event_source_mapping.is_public
    op: equals
    value: false
- title: 'LAMBDA function: Artifacts Encrypted And Private'
  severity: high
  rule_id: aws.lambda.function.artifacts_encrypted_and_private
  for_each:
    discovery: aws.lambda.function_encryption
    as: function
    item: function
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'LAMBDA function: Role Least Privilege'
  severity: high
  rule_id: aws.lambda.function.role_least_privilege
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.is_public
    op: equals
    value: false
- title: 'LAMBDA function: Policies Present For Sensitive Fields Configured'
  severity: medium
  rule_id: aws.lambda.function.policies_present_for_sensitive_fields_configured
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.compliant
    op: equals
    value: true
- title: 'LAMBDA function: Jobs Private Networking Configured'
  severity: high
  rule_id: aws.lambda.function.jobs_private_networking_configured
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.is_public
    op: equals
    value: false
- title: 'LAMBDA event source mapping: Source Authenticated Configured'
  severity: medium
  rule_id: aws.lambda.event_source_mapping.source_authenticated_configured
  for_each:
    discovery: aws.lambda.event_source_mappings
    as: event_source_mapping
    item: event_source_mapping
  conditions:
    var: event_source_mapping.compliant
    op: equals
    value: true
- title: 'LAMBDA function: Resource Policy Cross Account Access Configured'
  severity: high
  rule_id: aws.lambda.function.resource_policy_cross_account_access_configured
  for_each:
    discovery: aws.lambda.functions
    as: function
    item: function
  conditions:
    var: function.is_public
    op: equals
    value: false
