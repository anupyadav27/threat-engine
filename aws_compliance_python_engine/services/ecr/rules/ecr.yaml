version: '1.0'
provider: aws
service: ecr
services:
  client: ecr
  module: boto3.client
discovery:
- discovery_id: aws.ecr.delete_signing_configuration
  calls:
  - action: delete_signing_configuration
    save_as: response
  emit:
    item:
      rules: '{{ response.signingConfiguration.rules }}'
- discovery_id: aws.ecr.describe_repositories
  calls:
  - action: describe_repositories
    save_as: response
  emit:
    item:
      repositoryArn: '{{ response.repositories.repositoryArn }}'
      registryId: '{{ response.repositories.registryId }}'
      repositoryName: '{{ response.repositories.repositoryName }}'
      repositoryUri: '{{ response.repositories.repositoryUri }}'
      createdAt: '{{ response.repositories.createdAt }}'
      imageTagMutability: '{{ response.repositories.imageTagMutability }}'
      imageTagMutabilityExclusionFilters: '{{ response.repositories.imageTagMutabilityExclusionFilters
        }}'
      imageScanningConfiguration: '{{ response.repositories.imageScanningConfiguration
        }}'
      encryptionConfiguration: '{{ response.repositories.encryptionConfiguration }}'
- discovery_id: aws.ecr.describe_repository_creation_templates
  calls:
  - action: describe_repository_creation_templates
    save_as: response
  emit:
    item:
      prefix: '{{ response.repositoryCreationTemplates.prefix }}'
      description: '{{ response.repositoryCreationTemplates.description }}'
      encryptionConfiguration: '{{ response.repositoryCreationTemplates.encryptionConfiguration
        }}'
      resourceTags: '{{ response.repositoryCreationTemplates.resourceTags }}'
      imageTagMutability: '{{ response.repositoryCreationTemplates.imageTagMutability
        }}'
      imageTagMutabilityExclusionFilters: '{{ response.repositoryCreationTemplates.imageTagMutabilityExclusionFilters
        }}'
      repositoryPolicy: '{{ response.repositoryCreationTemplates.repositoryPolicy
        }}'
      lifecyclePolicy: '{{ response.repositoryCreationTemplates.lifecyclePolicy }}'
      appliedFor: '{{ response.repositoryCreationTemplates.appliedFor }}'
      customRoleArn: '{{ response.repositoryCreationTemplates.customRoleArn }}'
      createdAt: '{{ response.repositoryCreationTemplates.createdAt }}'
      updatedAt: '{{ response.repositoryCreationTemplates.updatedAt }}'
- discovery_id: aws.ecr.batch_get_repository_scanning_configuration
  calls:
  - action: batch_get_repository_scanning_configuration
    save_as: response
  emit:
    item:
      repositoryArn: '{{ response.scanningConfigurations.repositoryArn }}'
      repositoryName: '{{ response.scanningConfigurations.repositoryName }}'
      scanOnPush: '{{ response.scanningConfigurations.scanOnPush }}'
      scanFrequency: '{{ response.scanningConfigurations.scanFrequency }}'
      appliedScanFilters: '{{ response.scanningConfigurations.appliedScanFilters }}'
checks:
- rule_id: aws.ecr.imagescan.ecr_results_export_destination_encrypted
  for_each: aws.ecr.describe_repositories
  conditions:
    var: item.encryptionConfiguration
    op: exists
- rule_id: aws.ecr.resource.ecr_image_scan_on_push_enabled
  for_each: aws.ecr.batch_get_repository_scanning_configuration
  conditions:
    var: item.scanOnPush
    op: equals
    value: true
- rule_id: aws.ecr.resource.repository_encryption_enabled
  for_each: aws.ecr.describe_repositories
  conditions:
    var: item.encryptionConfiguration
    op: exists
- rule_id: aws.ecr.replication_configuration.ecr_cross_region_encrypted
  for_each: aws.ecr.describe_repositories
  conditions:
    var: item.encryptionConfiguration
    op: exists
- rule_id: aws.ecr.resource.ecr_repository_scan_on_push_enabled
  for_each: aws.ecr.batch_get_repository_scanning_configuration
  conditions:
    var: item.scanOnPush
    op: equals
    value: true
- rule_id: aws.ecr.repositories_not_publicly_accessible.repositories_not_publicly_accessible_configured
  for_each: aws.ecr.describe_repository_creation_templates
  conditions:
    var: item.repositoryPolicy
    op: exists
- rule_id: aws.ecr.lifecyclepolicy.policy_storage_encrypted
  for_each: aws.ecr.describe_repositories
  conditions:
    var: item.encryptionConfiguration
    op: exists
- rule_id: aws.ecr.repository_policy.no_public_pull_push_configured
  for_each: aws.ecr.describe_repository_creation_templates
  conditions:
    var: item.repositoryPolicy
    op: equals
    value: []
- rule_id: aws.ecr.lifecyclepolicy.ecr_unused_or_old_tags_expire_configured
  for_each: aws.ecr.describe_repository_creation_templates
  conditions:
    var: item.lifecyclePolicy
    op: exists
- rule_id: aws.ecr.repository_policy.ecr_no_wildcard_admin_configured
  for_each: aws.ecr.describe_repository_creation_templates
  conditions:
    var: item.repositoryPolicy
    op: exists
- rule_id: aws.ecr.repository.immutable_tags_or_signing_enforced
  for_each: aws.ecr.describe_repositories
  conditions:
    var: item.imageTagMutability
    op: equals
    value: IMMUTABLE
- rule_id: aws.ecr.imagescan.scope_includes_all_asset_groups_configured
  for_each: aws.ecr.batch_get_repository_scanning_configuration
  conditions:
    var: item.scanOnPush
    op: equals
    value: true
- rule_id: aws.ecr.repository.ecr_image_scanning_enabled
  for_each: aws.ecr.describe_repositories
  conditions:
    var: item.imageScanningConfiguration
    op: equals
    value:
      scanOnPush: true
- rule_id: aws.ecr.replication_configuration.ecr_destinations_least_privilege
  for_each: aws.ecr.delete_signing_configuration
  conditions:
    var: item.rules
    op: exists
