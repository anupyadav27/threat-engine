version: '1.0'
provider: aws
service: ecr
discovery:
- discovery_id: aws.ecr.imagescans
  calls:
  - client: ecr
    action: describe_repositories
    save_as: imagescan_list
    on_error: continue
    fields:
    - Ecrs
  emit:
    items_for: imagescan_list[]
    as: imagescan
    item:
      id: '{{ imagescan.Id }}'
      name: '{{ imagescan.Name }}'
- discovery_id: aws.ecr.imagescan_encryption
  for_each: aws.ecr.imagescans
  calls:
  - client: ecr
    action: describe_repositories
    params:
      ImagescanId: '{{ item.id }}'
    save_as: encryption
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      encryption_enabled: '{{ encryption.Encrypted if encryption.Encrypted is defined
        else false }}'
- discovery_id: aws.ecr.replication_configuration_encryption
  calls:
  - client: ecr
    action: list_images
    save_as: replication_configuration_encryption
    on_error: continue
  emit:
    items_for: replication_configuration_encryption[]
    as: replication_configuration_encryption
    item:
      id: '{{ replication_configuration_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.ecr.repositories_not_publicly_accessibles
  for_each: aws.ecr.repositories_not_publicly_accessible
  calls:
  - client: ecr
    action: describe_image_replication_status
    save_as: repositories_not_publicly_accessibles
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.ecr.resources
  for_each: aws.ecr.resource
  calls:
  - client: ecr
    action: describe_image_replication_status
    save_as: resources
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.ecr.repository_policys
  for_each: aws.ecr.repository_policy
  calls:
  - client: ecr
    action: describe_image_replication_status
    save_as: repository_policys
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.ecr.resource_encryption
  calls:
  - client: ecr
    action: list_images
    save_as: resource_encryption
    on_error: continue
  emit:
    items_for: resource_encryption[]
    as: resource_encryption
    item:
      id: '{{ resource_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.ecr.lifecyclepolicys
  for_each: aws.ecr.lifecyclepolicy
  calls:
  - client: ecr
    action: describe_image_replication_status
    save_as: lifecyclepolicys
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.ecr.lifecyclepolicy_encryption
  calls:
  - client: ecr
    action: list_images
    save_as: lifecyclepolicy_encryption
    on_error: continue
  emit:
    items_for: lifecyclepolicy_encryption[]
    as: lifecyclepolicy_encryption
    item:
      id: '{{ lifecyclepolicy_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.ecr.replication_configurations
  for_each: aws.ecr.replication_configuration
  calls:
  - client: ecr
    action: describe_image_replication_status
    save_as: replication_configurations
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.ecr.repositorys
  for_each: aws.ecr.repository
  calls:
  - client: ecr
    action: describe_image_replication_status
    save_as: repositorys
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
checks:
- title: 'ECR imagescan: Ecr Results Export Destination Encrypted'
  severity: high
  rule_id: aws.ecr.imagescan.ecr_results_export_destination_encrypted
  for_each:
    discovery: aws.ecr.imagescan_encryption
    as: imagescan
    item: imagescan
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'ECR resource: Ecr Image Scan On Push Enabled'
  severity: medium
  rule_id: aws.ecr.resource.ecr_image_scan_on_push_enabled
  for_each:
    discovery: aws.ecr.resources
    as: resource
    item: resource
  conditions:
    var: resource.compliant
    op: equals
    value: true
- title: 'ECR imagescan: Ecr Agents Or Scanners Deployed Configured'
  severity: medium
  rule_id: aws.ecr.imagescan.ecr_agents_or_scanners_deployed_configured
  for_each:
    discovery: aws.ecr.imagescans
    as: imagescan
    item: imagescan
  conditions:
    var: imagescan.compliant
    op: equals
    value: true
- title: 'ECR resource: Repository Encryption Enabled'
  severity: high
  rule_id: aws.ecr.resource.repository_encryption_enabled
  for_each:
    discovery: aws.ecr.resource_encryption
    as: resource
    item: resource
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'ECR replication configuration: Ecr Cross Region Encrypted'
  severity: high
  rule_id: aws.ecr.replication_configuration.ecr_cross_region_encrypted
  for_each:
    discovery: aws.ecr.replication_configuration_encryption
    as: replication_configuration
    item: replication_configuration
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'ECR resource: Ecr Repository Scan On Push Enabled'
  severity: medium
  rule_id: aws.ecr.resource.ecr_repository_scan_on_push_enabled
  for_each:
    discovery: aws.ecr.resources
    as: resource
    item: resource
  conditions:
    var: resource.compliant
    op: equals
    value: true
- title: 'ECR repository: Repo Private Or Access Restricted'
  severity: high
  rule_id: aws.ecr.repository.repo_private_or_access_restricted
  for_each:
    discovery: aws.ecr.repositorys
    as: repository
    item: repository
  conditions:
    var: repository.is_public
    op: equals
    value: false
- title: 'ECR repositories not publicly accessible: Repositories Not Publicly Accessible
    Configured'
  severity: high
  rule_id: aws.ecr.repositories_not_publicly_accessible.repositories_not_publicly_accessible_configured
  for_each:
    discovery: aws.ecr.repositories_not_publicly_accessibles
    as: repositories_not_publicly_accessible
    item: repositories_not_publicly_accessible
  conditions:
    var: repositories_not_publicly_accessible.is_public
    op: equals
    value: false
- title: 'ECR lifecyclepolicy: Policy Storage Encrypted'
  severity: high
  rule_id: aws.ecr.lifecyclepolicy.policy_storage_encrypted
  for_each:
    discovery: aws.ecr.lifecyclepolicy_encryption
    as: lifecyclepolicy
    item: lifecyclepolicy
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'ECR repository policy: No Public Pull Push Configured'
  severity: high
  rule_id: aws.ecr.repository_policy.no_public_pull_push_configured
  for_each:
    discovery: aws.ecr.repository_policys
    as: repository_policy
    item: repository_policy
  conditions:
    var: repository_policy.is_public
    op: equals
    value: false
- title: 'ECR lifecyclepolicy: Ecr Unused Or Old Tags Expire Configured'
  severity: medium
  rule_id: aws.ecr.lifecyclepolicy.ecr_unused_or_old_tags_expire_configured
  for_each:
    discovery: aws.ecr.lifecyclepolicys
    as: lifecyclepolicy
    item: lifecyclepolicy
  conditions:
    var: lifecyclepolicy.is_public
    op: equals
    value: false
- title: 'ECR repository policy: Ecr No Wildcard Admin Configured'
  severity: medium
  rule_id: aws.ecr.repository_policy.ecr_no_wildcard_admin_configured
  for_each:
    discovery: aws.ecr.repository_policys
    as: repository_policy
    item: repository_policy
  conditions:
    var: repository_policy.is_public
    op: equals
    value: false
- title: 'ECR repository: Immutable Tags Or Signing Enforced'
  severity: medium
  rule_id: aws.ecr.repository.immutable_tags_or_signing_enforced
  for_each:
    discovery: aws.ecr.repositorys
    as: repository
    item: repository
  conditions:
    var: repository.compliant
    op: equals
    value: true
- title: 'ECR imagescan: Scope Includes All Asset Groups Configured'
  severity: medium
  rule_id: aws.ecr.imagescan.scope_includes_all_asset_groups_configured
  for_each:
    discovery: aws.ecr.imagescan_encryption
    as: imagescan
    item: imagescan
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'ECR repository: Ecr Image Scanning Enabled'
  severity: medium
  rule_id: aws.ecr.repository.ecr_image_scanning_enabled
  for_each:
    discovery: aws.ecr.repositorys
    as: repository
    item: repository
  conditions:
    var: repository.compliant
    op: equals
    value: true
- title: 'ECR replication configuration: Ecr Destinations Least Privilege'
  severity: high
  rule_id: aws.ecr.replication_configuration.ecr_destinations_least_privilege
  for_each:
    discovery: aws.ecr.replication_configurations
    as: replication_configuration
    item: replication_configuration
  conditions:
    var: replication_configuration.is_public
    op: equals
    value: false
