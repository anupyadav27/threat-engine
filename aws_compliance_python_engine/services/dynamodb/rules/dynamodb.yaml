version: '1.0'
provider: aws
service: dynamodb
discovery:
- discovery_id: aws.dynamodb.globaltables
  calls:
  - client: dynamodb
    action: list_tables
    save_as: globaltable_list
    on_error: continue
    fields:
    - Dynamodbs
  emit:
    items_for: globaltable_list[]
    as: globaltable
    item:
      id: '{{ globaltable.Id }}'
      name: '{{ globaltable.Name }}'
- discovery_id: aws.dynamodb.globaltable_encryption
  for_each: aws.dynamodb.globaltables
  calls:
  - client: dynamodb
    action: list_tables
    params:
      GlobaltableId: '{{ item.id }}'
    save_as: encryption
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      encryption_enabled: '{{ encryption.Encrypted if encryption.Encrypted is defined
        else false }}'
- discovery_id: aws.dynamodb.resource_encryption
  calls:
  - client: dynamodb
    action: list_backups
    save_as: resource_encryption
    on_error: continue
  emit:
    items_for: resource_encryption[]
    as: resource_encryption
    item:
      id: '{{ resource_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.dynamodb.tables_encryption
  calls:
  - client: dynamodb
    action: list_backups
    save_as: tables_encryption
    on_error: continue
  emit:
    items_for: tables_encryption[]
    as: tables_encryption
    item:
      id: '{{ tables_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.dynamodb.streams
  for_each: aws.dynamodb.stream
  calls:
  - client: dynamodb
    action: describe_backup
    save_as: streams
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.dynamodb.resources
  for_each: aws.dynamodb.resource
  calls:
  - client: dynamodb
    action: describe_backup
    save_as: resources
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.dynamodb.table_encryption
  calls:
  - client: dynamodb
    action: list_backups
    save_as: table_encryption
    on_error: continue
  emit:
    items_for: table_encryption[]
    as: table_encryption
    item:
      id: '{{ table_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.dynamodb.tabless
  for_each: aws.dynamodb.table
  calls:
  - client: dynamodb
    action: describe_backup
    save_as: tabless
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.dynamodb.stream_encryption
  calls:
  - client: dynamodb
    action: list_backups
    save_as: stream_encryption
    on_error: continue
  emit:
    items_for: stream_encryption[]
    as: stream_encryption
    item:
      id: '{{ stream_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.dynamodb.tables
  for_each: aws.dynamodb.table
  calls:
  - client: dynamodb
    action: describe_backup
    save_as: tables
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.dynamodb.cluster_encryption
  calls:
  - client: dynamodb
    action: list_backups
    save_as: cluster_encryption
    on_error: continue
  emit:
    items_for: cluster_encryption[]
    as: cluster_encryption
    item:
      id: '{{ cluster_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.dynamodb.clusters
  for_each: aws.dynamodb.cluster
  calls:
  - client: dynamodb
    action: describe_backup
    save_as: clusters
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.dynamodb.table_protected_by_backup_plans
  for_each: aws.dynamodb.table_protected_by_backup_plan
  calls:
  - client: dynamodb
    action: describe_backup
    save_as: table_protected_by_backup_plans
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.dynamodb.accelerator_encryption
  calls:
  - client: dynamodb
    action: list_backups
    save_as: accelerator_encryption
    on_error: continue
  emit:
    items_for: accelerator_encryption[]
    as: accelerator_encryption
    item:
      id: '{{ accelerator_encryption.Id }}'
      compliant: '{{ true }}'
checks:
- title: 'DYNAMODB tables: Table Pitr Enabled'
  severity: medium
  rule_id: aws.dynamodb.tables.table_pitr_enabled
  for_each:
    discovery: aws.dynamodb.tabless
    as: tables
    item: tables
  conditions:
    var: tables.compliant
    op: equals
    value: true
- title: 'DYNAMODB globaltable: Encryption At Rest All Regions Configured'
  severity: high
  rule_id: aws.dynamodb.globaltable.encryption_at_rest_all_regions_configured
  for_each:
    discovery: aws.dynamodb.globaltable_encryption
    as: globaltable
    item: globaltable
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'DYNAMODB cluster: In Transit Encryption Enabled'
  severity: high
  rule_id: aws.dynamodb.cluster.in_transit_encryption_enabled
  for_each:
    discovery: aws.dynamodb.cluster_encryption
    as: cluster
    item: cluster
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'DYNAMODB table: Private Network Only If Supported'
  severity: high
  rule_id: aws.dynamodb.table.private_network_only_if_supported
  for_each:
    discovery: aws.dynamodb.tables
    as: table
    item: table
  conditions:
    var: table.is_public
    op: equals
    value: false
- title: 'DYNAMODB table: Rbac Least Privilege'
  severity: high
  rule_id: aws.dynamodb.table.rbac_least_privilege
  for_each:
    discovery: aws.dynamodb.tables
    as: table
    item: table
  conditions:
    var: table.is_public
    op: equals
    value: false
- title: 'DYNAMODB stream: Private Network Only If Supported'
  severity: high
  rule_id: aws.dynamodb.stream.private_network_only_if_supported
  for_each:
    discovery: aws.dynamodb.streams
    as: stream
    item: stream
  conditions:
    var: stream.is_public
    op: equals
    value: false
- title: 'DYNAMODB resource: Dynamodb Pitr Enabled'
  severity: medium
  rule_id: aws.dynamodb.resource.dynamodb_pitr_enabled
  for_each:
    discovery: aws.dynamodb.resources
    as: resource
    item: resource
  conditions:
    var: resource.compliant
    op: equals
    value: true
- title: 'DYNAMODB cluster: Encryption Enabled'
  severity: high
  rule_id: aws.dynamodb.cluster.encryption_enabled
  for_each:
    discovery: aws.dynamodb.cluster_encryption
    as: cluster
    item: cluster
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'DYNAMODB table: Encryption At Rest Enabled'
  severity: high
  rule_id: aws.dynamodb.table.encryption_at_rest_enabled
  for_each:
    discovery: aws.dynamodb.table_encryption
    as: table
    item: table
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'DYNAMODB globaltable: Table Pitr Enabled If Supported'
  severity: medium
  rule_id: aws.dynamodb.globaltable.table_pitr_enabled_if_supported
  for_each:
    discovery: aws.dynamodb.globaltables
    as: globaltable
    item: globaltable
  conditions:
    var: globaltable.compliant
    op: equals
    value: true
- title: 'DYNAMODB cluster: Dynamodb Multi Az Configured'
  severity: medium
  rule_id: aws.dynamodb.cluster.dynamodb_multi_az_configured
  for_each:
    discovery: aws.dynamodb.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.compliant
    op: equals
    value: true
- title: 'DYNAMODB resource: Tables Kms Cmk Encryption Enabled'
  severity: high
  rule_id: aws.dynamodb.resource.tables_kms_cmk_encryption_enabled
  for_each:
    discovery: aws.dynamodb.resource_encryption
    as: resource
    item: resource
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'DYNAMODB stream: Consumer Auth Required'
  severity: medium
  rule_id: aws.dynamodb.stream.consumer_auth_required
  for_each:
    discovery: aws.dynamodb.streams
    as: stream
    item: stream
  conditions:
    var: stream.compliant
    op: equals
    value: true
- title: 'DYNAMODB table protected by backup plan: Table Protected By Backup Plan
    Configured'
  severity: medium
  rule_id: aws.dynamodb.table_protected_by_backup_plan.table_protected_by_backup_plan_configured
  for_each:
    discovery: aws.dynamodb.table_protected_by_backup_plans
    as: table_protected_by_backup_plan
    item: table_protected_by_backup_plan
  conditions:
    var: table_protected_by_backup_plan.versioning_enabled
    op: equals
    value: true
- title: 'DYNAMODB resource: Encryption Enabled'
  severity: high
  rule_id: aws.dynamodb.resource.encryption_enabled
  for_each:
    discovery: aws.dynamodb.resource_encryption
    as: resource
    item: resource
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'DYNAMODB resource: Dynamodb Autoscaling Enabled'
  severity: medium
  rule_id: aws.dynamodb.resource.dynamodb_autoscaling_enabled
  for_each:
    discovery: aws.dynamodb.resources
    as: resource
    item: resource
  conditions:
    var: resource.compliant
    op: equals
    value: true
- title: 'DYNAMODB tables: Kms Cmk Encryption Enabled'
  severity: high
  rule_id: aws.dynamodb.tables.kms_cmk_encryption_enabled
  for_each:
    discovery: aws.dynamodb.tables_encryption
    as: tables
    item: tables
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'DYNAMODB stream: Encryption At Rest Enabled'
  severity: high
  rule_id: aws.dynamodb.stream.encryption_at_rest_enabled
  for_each:
    discovery: aws.dynamodb.stream_encryption
    as: stream
    item: stream
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'DYNAMODB resource: Global Tables Enabled'
  severity: medium
  rule_id: aws.dynamodb.resource.global_tables_enabled
  for_each:
    discovery: aws.dynamodb.resources
    as: resource
    item: resource
  conditions:
    var: resource.compliant
    op: equals
    value: true
- title: 'DYNAMODB accelerator: Cluster Encryption Enabled'
  severity: high
  rule_id: aws.dynamodb.accelerator.cluster_encryption_enabled
  for_each:
    discovery: aws.dynamodb.accelerator_encryption
    as: accelerator
    item: accelerator
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'DYNAMODB globaltable: Cross Region Replication Encrypted'
  severity: high
  rule_id: aws.dynamodb.globaltable.cross_region_replication_encrypted
  for_each:
    discovery: aws.dynamodb.globaltable_encryption
    as: globaltable
    item: globaltable
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'DYNAMODB resource: Backup Enabled'
  severity: medium
  rule_id: aws.dynamodb.resource.backup_enabled
  for_each:
    discovery: aws.dynamodb.resources
    as: resource
    item: resource
  conditions:
    var: resource.versioning_enabled
    op: equals
    value: true
