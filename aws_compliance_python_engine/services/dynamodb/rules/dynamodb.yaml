version: '1.0'
provider: aws
service: dynamodb
discovery:
- discovery_id: aws.dynamodb.list_backups
  calls:
  - action: list_backups
    save_as: list_backups_response
  emit:
    items_for: '{{ list_backups_response.BackupSummaries }}'
    as: resource
    item:
      table_name: '{{ resource.TableName }}'
      table_id: '{{ resource.TableId }}'
      table_arn: '{{ resource.TableArn }}'
      backup_arn: '{{ resource.BackupArn }}'
      backup_name: '{{ resource.BackupName }}'
      backup_creation_date_time: '{{ resource.BackupCreationDateTime }}'
      backup_expiry_date_time: '{{ resource.BackupExpiryDateTime }}'
      backup_status: '{{ resource.BackupStatus }}'
      backup_type: '{{ resource.BackupType }}'
      backup_size_bytes: '{{ resource.BackupSizeBytes }}'
- discovery_id: aws.dynamodb.list_global_tables
  calls:
  - action: list_global_tables
    save_as: list_global_tables_response
  emit:
    items_for: '{{ list_global_tables_response.GlobalTables }}'
    as: resource
    item:
      global_table_name: '{{ resource.GlobalTableName }}'
      replication_group: '{{ resource.ReplicationGroup }}'
- discovery_id: aws.dynamodb.describe_continuous_backups
  calls:
  - action: describe_continuous_backups
    save_as: describe_continuous_backups_response
    params:
      TableName: '{{ item.table_name }}'
    on_error: continue
  for_each: aws.dynamodb.list_backups
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      continuous_backups_status: '{{ describe_continuous_backups_response.ContinuousBackupsDescription.ContinuousBackupsStatus
        }}'
      point_in_time_recovery_description: '{{ describe_continuous_backups_response.ContinuousBackupsDescription.PointInTimeRecoveryDescription
        }}'
- discovery_id: aws.dynamodb.create_global_table
  calls:
  - action: create_global_table
    save_as: create_global_table_response
    params:
      GlobalTableName: '{{ item.table_name }}'
      ReplicationGroup: '{{ item.api_id }}'
    on_error: continue
  for_each: aws.dynamodb.list_backups
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      replication_group: '{{ create_global_table_response.GlobalTableDescription.ReplicationGroup
        }}'
      global_table_arn: '{{ create_global_table_response.GlobalTableDescription.GlobalTableArn
        }}'
      creation_date_time: '{{ create_global_table_response.GlobalTableDescription.CreationDateTime
        }}'
      global_table_status: '{{ create_global_table_response.GlobalTableDescription.GlobalTableStatus
        }}'
      global_table_name: '{{ create_global_table_response.GlobalTableDescription.GlobalTableName
        }}'
- discovery_id: aws.dynamodb.create_table
  calls:
  - action: create_table
    save_as: create_table_response
    params:
      AttributeDefinitions: '{{ item.api_id }}'
      TableName: '{{ item.table_name }}'
      KeySchema: '{{ item.api_id }}'
    on_error: continue
  for_each: aws.dynamodb.list_backups
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      attribute_definitions: '{{ create_table_response.TableDescription.AttributeDefinitions
        }}'
      table_name: '{{ create_table_response.TableDescription.TableName }}'
      key_schema: '{{ create_table_response.TableDescription.KeySchema }}'
      table_status: '{{ create_table_response.TableDescription.TableStatus }}'
      creation_date_time: '{{ create_table_response.TableDescription.CreationDateTime
        }}'
- discovery_id: aws.dynamodb.batch_get_item
  calls:
  - action: batch_get_item
    save_as: batch_get_item_response
    params:
      RequestItems: '{{ item.api_id }}'
    on_error: continue
  for_each: aws.dynamodb.list_backups
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      table_name: '{{ batch_get_item_response.ConsumedCapacity.TableName }}'
      capacity_units: '{{ batch_get_item_response.ConsumedCapacity.CapacityUnits }}'
      read_capacity_units: '{{ batch_get_item_response.ConsumedCapacity.ReadCapacityUnits
        }}'
      write_capacity_units: '{{ batch_get_item_response.ConsumedCapacity.WriteCapacityUnits
        }}'
      table: '{{ batch_get_item_response.ConsumedCapacity.Table }}'
- discovery_id: aws.dynamodb.describe_export
  calls:
  - action: describe_export
    save_as: describe_export_response
    params:
      ExportArn: '{{ item.api_id }}'
    on_error: continue
  for_each: aws.dynamodb.list_backups
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      export_arn: '{{ describe_export_response.ExportDescription.ExportArn }}'
      export_status: '{{ describe_export_response.ExportDescription.ExportStatus }}'
      start_time: '{{ describe_export_response.ExportDescription.StartTime }}'
      end_time: '{{ describe_export_response.ExportDescription.EndTime }}'
      export_manifest: '{{ describe_export_response.ExportDescription.ExportManifest
        }}'
- discovery_id: aws.dynamodb.describe_global_table_settings
  calls:
  - action: describe_global_table_settings
    save_as: describe_global_table_settings_response
    params:
      GlobalTableName: '{{ item.table_name }}'
    on_error: continue
  for_each: aws.dynamodb.list_backups
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      region_name: '{{ describe_global_table_settings_response.ReplicaSettings.RegionName
        }}'
      replica_status: '{{ describe_global_table_settings_response.ReplicaSettings.ReplicaStatus
        }}'
      replica_billing_mode_summary: '{{ describe_global_table_settings_response.ReplicaSettings.ReplicaBillingModeSummary
        }}'
      replica_provisioned_read_capacity_units: '{{ describe_global_table_settings_response.ReplicaSettings.ReplicaProvisionedReadCapacityUnits
        }}'
      replica_provisioned_read_capacity_auto_scaling_settings: '{{ describe_global_table_settings_response.ReplicaSettings.ReplicaProvisionedReadCapacityAutoScalingSettings
        }}'
checks:
- rule_id: aws.dynamodb.tables.table_pitr_enabled
  for_each: aws.dynamodb.describe_continuous_backups
  conditions:
    var: item.continuous_backups_status
    op: equals
    value: ENABLED
- rule_id: aws.dynamodb.globaltable.encryption_at_rest_all_regions_configured
  for_each: aws.dynamodb.create_global_table
  conditions:
    var: item.global_table_status
    op: equals
    value: ACTIVE
- rule_id: aws.dynamodb.cluster.in_transit_encryption_enabled
  for_each: aws.dynamodb.create_table
  conditions:
    var: item.table_status
    op: equals
    value: ACTIVE
- rule_id: aws.dynamodb.table.private_network_only_if_supported
  for_each: aws.dynamodb.list_backups
  conditions:
    var: item.table_arn
    op: exists
- rule_id: aws.dynamodb.table.rbac_least_privilege
  for_each: aws.dynamodb.batch_get_item
  conditions:
    all:
    - var: item.read_capacity_units
      op: gte
      value: 1
    - var: item.write_capacity_units
      op: gte
      value: 1
- rule_id: aws.dynamodb.stream.private_network_only_if_supported
  for_each: aws.dynamodb.create_table
  conditions:
    all:
    - var: item.stream_specification
      op: exists
    - var: item.table_status
      op: equals
      value: ACTIVE
- rule_id: aws.dynamodb.resource.dynamodb_pitr_enabled
  for_each: aws.dynamodb.describe_continuous_backups
  conditions:
    var: item.continuous_backups_status
    op: equals
    value: ENABLED
- rule_id: aws.dynamodb.cluster.encryption_enabled
  for_each: aws.dynamodb.describe_export
  conditions:
    var: item.s3_sse_algorithm
    op: exists
- rule_id: aws.dynamodb.table.encryption_at_rest_enabled
  for_each: aws.dynamodb.describe_export
  conditions:
    var: item.s3_sse_algorithm
    op: exists
- rule_id: aws.dynamodb.globaltable.table_pitr_enabled_if_supported
  for_each: aws.dynamodb.describe_continuous_backups
  conditions:
    var: item.continuous_backups_status
    op: equals
    value: ENABLED
- rule_id: aws.dynamodb.cluster.dynamodb_multi_az_configured
  for_each: aws.dynamodb.list_global_tables
  conditions:
    var: item.replication_group
    op: exists
- rule_id: aws.dynamodb.resource.tables_kms_cmk_encryption_enabled
  for_each: aws.dynamodb.describe_export
  conditions:
    var: item.s3_sse_kms_key_id
    op: exists
- rule_id: aws.dynamodb.stream.consumer_auth_required
  for_each: aws.dynamodb.create_table
  conditions:
    all:
    - var: item.stream_specification
      op: exists
    - var: item.stream_specification
      op: equals
      value:
        StreamEnabled: true
- rule_id: aws.dynamodb.table_protected_by_backup_plan.table_protected_by_backup_plan_configured
  for_each: aws.dynamodb.describe_continuous_backups
  conditions:
    all:
    - var: item.continuous_backups_status
      op: equals
      value: ENABLED
    - var: item.point_in_time_recovery_description
      op: exists
- rule_id: aws.dynamodb.resource.encryption_enabled
  for_each: aws.dynamodb.describe_export
  conditions:
    var: item.s3_sse_algorithm
    op: exists
- rule_id: aws.dynamodb.resource.dynamodb_autoscaling_enabled
  for_each: aws.dynamodb.describe_global_table_settings
  conditions:
    all:
    - var: item.replica_provisioned_read_capacity_auto_scaling_settings
      op: exists
    - var: item.replica_provisioned_write_capacity_auto_scaling_settings
      op: exists
- rule_id: aws.dynamodb.tables.kms_cmk_encryption_enabled
  for_each: aws.dynamodb.describe_export
  conditions:
    var: item.s3_sse_kms_key_id
    op: exists
- rule_id: aws.dynamodb.stream.encryption_at_rest_enabled
  for_each: aws.dynamodb.create_table
  conditions:
    var: item.stream_specification
    op: exists
- rule_id: aws.dynamodb.resource.global_tables_enabled
  for_each: aws.dynamodb.list_global_tables
  conditions:
    var: item.replication_group
    op: exists
- rule_id: aws.dynamodb.accelerator.cluster_encryption_enabled
  for_each: aws.dynamodb.describe_export
  conditions:
    var: item.s3_sse_algorithm
    op: exists
- rule_id: aws.dynamodb.globaltable.cross_region_replication_encrypted
  for_each: aws.dynamodb.describe_export
  conditions:
    var: item.s3_sse_algorithm
    op: equals
    value: aws:kms
- rule_id: aws.dynamodb.resource.backup_enabled
  for_each: aws.dynamodb.describe_continuous_backups
  conditions:
    all:
    - var: item.continuous_backups_status
      op: equals
      value: ENABLED
    - var: item.point_in_time_recovery_description
      op: exists
