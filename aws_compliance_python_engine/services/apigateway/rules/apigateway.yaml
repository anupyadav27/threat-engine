version: '1.0'
provider: aws
service: apigateway
services:
  client: apigateway
  module: boto3.client
discovery:
- discovery_id: aws.apigateway.get_account
  calls:
  - action: get_account
    save_as: response
- discovery_id: aws.apigateway.get_domain_names
  calls:
  - action: get_domain_names
    save_as: response
  emit:
    item:
      domainName: '{{ response.items.domainName }}'
      domainNameId: '{{ response.items.domainNameId }}'
      domainNameArn: '{{ response.items.domainNameArn }}'
      certificateName: '{{ response.items.certificateName }}'
      certificateArn: '{{ response.items.certificateArn }}'
      certificateUploadDate: '{{ response.items.certificateUploadDate }}'
      regionalDomainName: '{{ response.items.regionalDomainName }}'
      regionalHostedZoneId: '{{ response.items.regionalHostedZoneId }}'
      regionalCertificateName: '{{ response.items.regionalCertificateName }}'
      regionalCertificateArn: '{{ response.items.regionalCertificateArn }}'
      distributionDomainName: '{{ response.items.distributionDomainName }}'
      distributionHostedZoneId: '{{ response.items.distributionHostedZoneId }}'
      endpointConfiguration: '{{ response.items.endpointConfiguration }}'
      domainNameStatus: '{{ response.items.domainNameStatus }}'
      domainNameStatusMessage: '{{ response.items.domainNameStatusMessage }}'
      securityPolicy: '{{ response.items.securityPolicy }}'
      endpointAccessMode: '{{ response.items.endpointAccessMode }}'
      tags: '{{ response.items.tags }}'
      mutualTlsAuthentication: '{{ response.items.mutualTlsAuthentication }}'
      ownershipVerificationCertificateArn: '{{ response.items.ownershipVerificationCertificateArn
        }}'
      managementPolicy: '{{ response.items.managementPolicy }}'
      policy: '{{ response.items.policy }}'
      routingMode: '{{ response.items.routingMode }}'
- discovery_id: aws.apigateway.get_usage_plans
  calls:
  - action: get_usage_plans
    save_as: response
  emit:
    item:
      id: '{{ response.items.id }}'
      name: '{{ response.items.name }}'
      description: '{{ response.items.description }}'
      apiStages: '{{ response.items.apiStages }}'
      throttle: '{{ response.items.throttle }}'
      quota: '{{ response.items.quota }}'
      productCode: '{{ response.items.productCode }}'
      tags: '{{ response.items.tags }}'
- discovery_id: aws.apigateway.get_api_key
  calls:
  - action: get_api_key
    save_as: response
- discovery_id: aws.apigateway.get_authorizer
  calls:
  - action: get_authorizer
    save_as: response
    params:
      restApiId: '{{ item.restApiId }}'
      authorizerId: '{{ item.authorizerId }}'
  on_error: continue
  for_each: aws.apigateway.get_base_path_mapping
- discovery_id: aws.apigateway.get_client_certificate
  calls:
  - action: get_client_certificate
    save_as: response
    params:
      clientCertificateId: '{{ item.clientCertificateId }}'
  on_error: continue
  for_each: aws.apigateway.get_client_certificates
- discovery_id: aws.apigateway.get_domain_name
  calls:
  - action: get_domain_name
    save_as: response
    params:
      domainName: '{{ item.domainName }}'
  on_error: continue
  for_each: aws.apigateway.get_domain_names
  emit:
    item:
      types: '{{ response.endpointConfiguration.types }}'
      ipAddressType: '{{ response.endpointConfiguration.ipAddressType }}'
      vpcEndpointIds: '{{ response.endpointConfiguration.vpcEndpointIds }}'
- discovery_id: aws.apigateway.get_request_validator
  calls:
  - action: get_request_validator
    save_as: response
    params:
      restApiId: '{{ item.restApiId }}'
      requestValidatorId: '{{ item.requestValidatorId }}'
  on_error: continue
  for_each: aws.apigateway.get_base_path_mapping
- discovery_id: aws.apigateway.get_resource
  calls:
  - action: get_resource
    save_as: response
    params:
      restApiId: '{{ item.restApiId }}'
      resourceId: '{{ item.id }}'
  on_error: continue
  for_each: aws.apigateway.get_base_path_mapping
- discovery_id: aws.apigateway.get_rest_api
  calls:
  - action: get_rest_api
    save_as: response
    params:
      restApiId: '{{ item.restApiId }}'
  on_error: continue
  for_each: aws.apigateway.get_base_path_mapping
- discovery_id: aws.apigateway.get_stage
  calls:
  - action: get_stage
    save_as: response
    params:
      restApiId: '{{ item.restApiId }}'
      stageName: '{{ item.stageName }}'
  on_error: continue
  for_each: aws.apigateway.get_base_path_mapping
  emit:
    item:
      format: '{{ response.accessLogSettings.format }}'
      destinationArn: '{{ response.accessLogSettings.destinationArn }}'
- discovery_id: aws.apigateway.get_usage
  calls:
  - action: get_usage
    save_as: response
    params:
      usagePlanId: '{{ item.usagePlanId }}'
      startDate: '{{ item.startDate }}'
      endDate: '{{ item.endDate }}'
  on_error: continue
  for_each: aws.apigateway.get_vpc_links
- discovery_id: aws.apigateway.update_usage
  calls:
  - action: update_usage
    save_as: response
    params:
      usagePlanId: '{{ item.usagePlanId }}'
      keyId: '{{ item.id }}'
  on_error: continue
  for_each: aws.apigateway.get_usage
checks:
- rule_id: aws.apigateway.usageplan.api_stage_rate_limit_configured
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.throttle
    op: exists
- rule_id: aws.apigateway.resource.authorization_enabled
  for_each: aws.apigateway.get_authorizers
  conditions:
    var: item.auth_type
    op: equals
    value: AWS_IAM
- rule_id: aws.apigateway.usageplan.api_quota_limit_configured
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.quota
    op: exists
- rule_id: aws.apigateway.authorizer.cache_ttl_configured
  for_each: aws.apigateway.get_authorizers
  conditions:
    var: item.authorizer_result_ttl_in_seconds
    op: gt
    value: 0
- rule_id: aws.apigateway.stage.logging_enabled
  for_each: aws.apigateway.get_stages
  conditions:
    var: item.access_log_settings
    op: exists
- rule_id: aws.apigateway.throttle.api_stage_overrides_bounded
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.throttle
    op: exists
- rule_id: aws.apigateway.restapi.waf_enabled
  for_each: aws.apigateway.get_stages
  conditions:
    var: item.web_acl_arn
    op: exists
- rule_id: aws.apigateway.resource.restapi_cache_encrypted
  for_each: aws.apigateway.get_stages
  conditions:
    var: item.cache_cluster_enabled
    op: equals
    value: true
- rule_id: aws.apigateway.v2api.waf_enabled
  for_each: aws.apigateway.get_stages
  conditions:
    var: item.web_acl_arn
    op: exists
- rule_id: aws.apigateway.v2api.authz_policies_enforced
  for_each: aws.apigateway.get_domain_names
  conditions:
    var: item.policy
    op: exists
- rule_id: aws.apigateway.authorizer.tls_min_1_2_enforced
  for_each: aws.apigateway.get_domain_names
  conditions:
    var: item.securityPolicy
    op: equals
    value: TLS_1_2
- rule_id: aws.apigateway.stage.api_logs_retention_days_minimum
  for_each: aws.apigateway.get_stages
  conditions:
    var: item.access_log_settings
    op: gte
    value: 90
- rule_id: aws.apigateway.stage.api_access_log_sink_configured
  for_each: aws.apigateway.get_stages
  conditions:
    var: item.access_log_settings
    op: exists
- rule_id: aws.apigateway.resource.api_gateway_https_required
  for_each: aws.apigateway.get_domain_names
  conditions:
    var: item.securityPolicy
    op: equals
    value: TLS_1_2
- rule_id: aws.apigateway.usageplan.api_rate_limits_configured
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.throttle
    op: exists
- rule_id: aws.apigateway.usageplan.api_stage_throttle_overrides_bounded
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.throttle
    op: exists
- rule_id: aws.apigateway.apikey.scopes_least_privilege
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.stage_keys
    op: equals
    value: []
- rule_id: aws.apigateway.usageplan.api_stage_burst_limit_configured
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.throttle
    op: exists
- rule_id: aws.apigateway.stage.api_access_log_fields_identity_configured
  for_each: aws.apigateway.get_stages
  conditions:
    var: item.access_log_settings
    op: exists
- rule_id: aws.apigateway.requestvalidator.api_parameters_validation_enabled
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.validate_request_parameters
    op: equals
    value: true
- rule_id: aws.apigateway.stage.throttling_enabled
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.throttle
    op: exists
- rule_id: aws.apigateway.restapi.tracing_enabled
  for_each: aws.apigateway.get_stages
  conditions:
    var: item.tracing_enabled
    op: equals
    value: true
- rule_id: aws.apigateway.v2api.private_networking_enforced
  for_each: aws.apigateway.get_domain_names
  conditions:
    var: item.endpointConfiguration
    op: equals
    value: PRIVATE
- rule_id: aws.apigateway.throttle.api_stage_rate_limit_configured
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.throttle
    op: exists
- rule_id: aws.apigateway.apikey.key_expiration_required
  for_each: aws.apigateway.get_client_certificates
  conditions:
    var: item.expiration_date
    op: exists
- rule_id: aws.apigateway.usageplan.api_keys_required
  for_each: aws.apigateway.get_rest_apis
  conditions:
    var: item.api_key_source
    op: equals
    value: HEADER
- rule_id: aws.apigateway.restapi.public_access_restricted
  for_each: aws.apigateway.get_rest_apis
  conditions:
    var: item.disable_execute_api_endpoint
    op: equals
    value: true
- rule_id: aws.apigateway.requestvalidator.api_request_body_size_limit_configured
  for_each: aws.apigateway.get_rest_apis
  conditions:
    var: item.minimum_compression_size
    op: gt
    value: 0
- rule_id: aws.apigateway.stage.api_access_logging_enabled
  for_each: aws.apigateway.get_stages
  conditions:
    var: item.access_log_settings
    op: exists
- rule_id: aws.apigateway.throttle.api_quota_limit_configured
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.quota
    op: exists
- rule_id: aws.apigateway.restapi.authn_required
  for_each: aws.apigateway.get_domain_names
  conditions:
    var: item.securityPolicy
    op: exists
- rule_id: aws.apigateway.usageplan.api_quota_limits_configured
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.quota
    op: exists
- rule_id: aws.apigateway.restapi.private_networking_enforced
  for_each: aws.apigateway.get_domain_names
  conditions:
    var: item.endpointConfiguration
    op: equals
    value:
      types:
      - PRIVATE
- rule_id: aws.apigateway.stage.usage_plan_for_api_keys_required
  for_each: aws.apigateway.get_rest_apis
  conditions:
    var: item.api_key_source
    op: equals
    value: HEADER
- rule_id: aws.apigateway.throttle.api_stage_burst_limit_configured
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.throttle
    op: exists
- rule_id: aws.apigateway.resource.api_resource_attached_enabled
  for_each: aws.apigateway.get_resources
  conditions:
    var: item.resource_methods
    op: exists
- rule_id: aws.apigateway.restapi.logging_enabled
  for_each: aws.apigateway.get_stages
  conditions:
    var: item.access_log_settings
    op: exists
