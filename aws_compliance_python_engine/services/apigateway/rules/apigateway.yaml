version: '1.0'
provider: aws
service: apigateway
services:
  client: apigateway
  module: boto3.client
discovery:
- discovery_id: aws.apigateway.get_api_keys
  calls:
  - action: get_api_keys
    save_as: response
  emit:
    item:
      id: '{{ response.items.id }}'
      value: '{{ response.items.value }}'
      name: '{{ response.items.name }}'
      customerId: '{{ response.items.customerId }}'
      description: '{{ response.items.description }}'
      enabled: '{{ response.items.enabled }}'
      createdDate: '{{ response.items.createdDate }}'
      lastUpdatedDate: '{{ response.items.lastUpdatedDate }}'
      stageKeys: '{{ response.items.stageKeys }}'
      tags: '{{ response.items.tags }}'
- discovery_id: aws.apigateway.get_method
  calls:
  - action: get_method
    save_as: response
  emit:
    item:
      apiKeyRequired: '{{ response.apiKeyRequired }}'
      authorizationScopes: '{{ response.authorizationScopes }}'
- discovery_id: aws.apigateway.get_usage_plans
  calls:
  - action: get_usage_plans
    save_as: response
  emit:
    item:
      id: '{{ response.items.id }}'
      name: '{{ response.items.name }}'
      description: '{{ response.items.description }}'
      apiStages: '{{ response.items.apiStages }}'
      throttle: '{{ response.items.throttle }}'
      quota: '{{ response.items.quota }}'
      productCode: '{{ response.items.productCode }}'
      tags: '{{ response.items.tags }}'
- discovery_id: aws.apigateway.create_authorizer
  calls:
  - action: create_authorizer
    save_as: response
  emit:
    item:
      authorizerResultTtlInSeconds: '{{ response.authorizerResultTtlInSeconds }}'
- discovery_id: aws.apigateway.create_stage
  calls:
  - action: create_stage
    save_as: response
  emit:
    item:
      format: '{{ response.accessLogSettings.format }}'
      destinationArn: '{{ response.accessLogSettings.destinationArn }}'
      accessLogSettings: '{{ resource.accessLogSettings }}'
      tracingEnabled: '{{ resource.tracingEnabled }}'
- discovery_id: aws.apigateway.create_model
  calls:
  - action: create_model
    save_as: response
  emit:
    item:
      contentType: '{{ response.contentType }}'
- discovery_id: aws.apigateway.get_domain_names
  calls:
  - action: get_domain_names
    save_as: response
  emit:
    item:
      domainName: '{{ response.items.domainName }}'
      domainNameId: '{{ response.items.domainNameId }}'
      domainNameArn: '{{ response.items.domainNameArn }}'
      certificateName: '{{ response.items.certificateName }}'
      certificateArn: '{{ response.items.certificateArn }}'
      certificateUploadDate: '{{ response.items.certificateUploadDate }}'
      regionalDomainName: '{{ response.items.regionalDomainName }}'
      regionalHostedZoneId: '{{ response.items.regionalHostedZoneId }}'
      regionalCertificateName: '{{ response.items.regionalCertificateName }}'
      regionalCertificateArn: '{{ response.items.regionalCertificateArn }}'
      distributionDomainName: '{{ response.items.distributionDomainName }}'
      distributionHostedZoneId: '{{ response.items.distributionHostedZoneId }}'
      endpointConfiguration: '{{ response.items.endpointConfiguration }}'
      domainNameStatus: '{{ response.items.domainNameStatus }}'
      domainNameStatusMessage: '{{ response.items.domainNameStatusMessage }}'
      securityPolicy: '{{ response.items.securityPolicy }}'
      endpointAccessMode: '{{ response.items.endpointAccessMode }}'
      tags: '{{ response.items.tags }}'
      mutualTlsAuthentication: '{{ response.items.mutualTlsAuthentication }}'
      ownershipVerificationCertificateArn: '{{ response.items.ownershipVerificationCertificateArn
        }}'
      managementPolicy: '{{ response.items.managementPolicy }}'
      policy: '{{ response.items.policy }}'
      routingMode: '{{ response.items.routingMode }}'
- discovery_id: aws.apigateway.create_request_validator
  calls:
  - action: create_request_validator
    save_as: response
  emit:
    item:
      validateRequestBody: '{{ response.validateRequestBody }}'
      validateRequestParameters: '{{ response.validateRequestParameters }}'
- discovery_id: aws.apigateway.get_sdk_type
  calls:
  - action: get_sdk_type
    save_as: response
  emit:
    item:
      name: '{{ response.configurationProperties.name }}'
      friendlyName: '{{ response.configurationProperties.friendlyName }}'
      description: '{{ response.configurationProperties.description }}'
      required: '{{ response.configurationProperties.required }}'
      defaultValue: '{{ response.configurationProperties.defaultValue }}'
checks:
- rule_id: aws.apigateway.usageplan.api_stage_rate_limit_configured
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.apigateway.resource.authorization_enabled
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.apigateway.apikey.key_rotation_policy_configured
  for_each: aws.apigateway.get_method
  conditions:
    var: item.apiKeyRequired
    op: equals
    value: 'true'
- rule_id: aws.apigateway.usageplan.api_quota_limit_configured
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.quota
    op: not_equals
    value: 'null'
- rule_id: aws.apigateway.authorizer.cache_ttl_configured
  for_each: aws.apigateway.create_authorizer
  conditions:
    var: item.authorizerResultTtlInSeconds
    op: not_equals
    value: 'null'
- rule_id: aws.apigateway.requestvalidator.api_required_security_headers_enforced
  for_each: aws.apigateway.get_method
  conditions:
    var: item.apiKeyRequired
    op: equals
    value: 'true'
- rule_id: aws.apigateway.stage.logging_enabled
  for_each: aws.apigateway.create_stage
  conditions:
    var: item.accessLogSettings
    op: not_equals
    value: 'null'
- rule_id: aws.apigateway.requestvalidator.api_content_type_whitelist_enforced
  for_each: aws.apigateway.create_model
  conditions:
    var: item.contentType
    op: in
    value: 'null'
- rule_id: aws.apigateway.throttle.api_stage_overrides_bounded
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.throttle
    op: not_equals
    value: 'null'
- rule_id: aws.apigateway.requestvalidator.api_request_schema_validation_enabled
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.apigateway.restapi.waf_enabled
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.apigateway.resource.restapi_cache_encrypted
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.apigateway.v2api.waf_enabled
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.apigateway.throttle.api_usage_plan_for_keys_required
  for_each: aws.apigateway.get_method
  conditions:
    var: item.apiKeyRequired
    op: equals
    value: 'true'
- rule_id: aws.apigateway.v2api.authz_policies_enforced
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.apigateway.authorizer.tls_min_1_2_enforced
  for_each: aws.apigateway.get_domain_names
  conditions:
    var: item.mutualTlsAuthentication
    op: equals
    value: 'true'
- rule_id: aws.apigateway.stage.api_logs_retention_days_minimum
  for_each: aws.apigateway.create_stage
  conditions:
    var: item.accessLogSettings
    op: not_equals
    value: 'null'
- rule_id: aws.apigateway.stage.api_access_log_sink_configured
  for_each: aws.apigateway.create_stage
  conditions:
    var: item.accessLogSettings
    op: not_equals
    value: 'null'
- rule_id: aws.apigateway.resource.api_gateway_https_required
  for_each: aws.apigateway.get_domain_names
  conditions:
    var: item.endpointConfiguration
    op: contains
    value: HTTPS
- rule_id: aws.apigateway.usageplan.api_rate_limits_configured
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.apigateway.usageplan.api_stage_throttle_overrides_bounded
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.throttle
    op: not_equals
    value: 'null'
- rule_id: aws.apigateway.apikey.scopes_least_privilege
  for_each: aws.apigateway.get_method
  conditions:
    var: item.authorizationScopes
    op: not_equals
    value: 'null'
- rule_id: aws.apigateway.usageplan.api_stage_burst_limit_configured
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.apigateway.stage.api_access_log_fields_identity_configured
  for_each: aws.apigateway.create_stage
  conditions:
    var: item.accessLogSettings
    op: not_equals
    value: 'null'
- rule_id: aws.apigateway.requestvalidator.api_parameters_validation_enabled
  for_each: aws.apigateway.create_request_validator
  conditions:
    var: item.validateRequestParameters
    op: equals
    value: 'true'
- rule_id: aws.apigateway.stage.throttling_enabled
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.apigateway.authorizer.api_token_audience_restricted
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.apigateway.restapi.tracing_enabled
  for_each: aws.apigateway.create_stage
  conditions:
    var: item.tracingEnabled
    op: equals
    value: 'true'
- rule_id: aws.apigateway.v2api.private_networking_enforced
  for_each: aws.apigateway.get_domain_names
  conditions:
    var: item.endpointAccessMode
    op: equals
    value: STRICT
- rule_id: aws.apigateway.throttle.api_stage_rate_limit_configured
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.throttle
    op: not_equals
    value: 'null'
- rule_id: aws.apigateway.apikey.key_expiration_required
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.apigateway.usageplan.api_keys_required
  for_each: aws.apigateway.get_method
  conditions:
    var: item.apiKeyRequired
    op: equals
    value: 'true'
- rule_id: aws.apigateway.restapi.authz_policies_enforced
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.apigateway.restapi.public_access_restricted
  for_each: aws.apigateway.get_domain_names
  conditions:
    var: item.endpointAccessMode
    op: not_equals
    value: BASIC
- rule_id: aws.apigateway.requestvalidator.api_request_body_size_limit_configured
  for_each: aws.apigateway.create_request_validator
  conditions:
    var: item.validateRequestBody
    op: not_equals
    value: 'null'
- rule_id: aws.apigateway.resource.restapi_logging_enabled
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.apigateway.stage.api_execution_logging_level_minimum_error_configured
  for_each: aws.apigateway.create_stage
  conditions:
    var: item.accessLogSettings
    op: not_equals
    value: 'null'
- rule_id: aws.apigateway.stage.api_access_logging_enabled
  for_each: aws.apigateway.create_stage
  conditions:
    var: item.accessLogSettings
    op: not_equals
    value: 'null'
- rule_id: aws.apigateway.throttle.api_quota_limit_configured
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.quota
    op: not_equals
    value: 'null'
- rule_id: aws.apigateway.restapi.authn_required
  for_each: aws.apigateway.get_sdk_type
  conditions:
    var: item.required
    op: equals
    value: 'true'
- rule_id: aws.apigateway.v2api.authn_required
  for_each: aws.apigateway.get_method
  conditions:
    var: item.apiKeyRequired
    op: equals
    value: 'true'
- rule_id: aws.apigateway.usageplan.api_quota_limits_configured
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.quota
    op: not_equals
    value: 'null'
- rule_id: aws.apigateway.certificate.certificate_enabled
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.apigateway.restapi.private_networking_enforced
  for_each: aws.apigateway.get_domain_names
  conditions:
    var: item.endpointAccessMode
    op: not_equals
    value: BASIC
- rule_id: aws.apigateway.requestvalidator.api_response_schema_validation_enabled
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.apigateway.stage.usage_plan_for_api_keys_required
  for_each: aws.apigateway.get_method
  conditions:
    var: item.apiKeyRequired
    op: equals
    value: 'true'
- rule_id: aws.apigateway.throttle.api_stage_burst_limit_configured
  for_each: aws.apigateway.get_usage_plans
  conditions:
    var: item.throttle
    op: not_equals
    value: 'null'
- rule_id: aws.apigateway.resource.api_resource_attached_enabled
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.apigateway.restapi.logging_enabled
  for_each: aws.apigateway.get_api_keys
  conditions:
    var: item.enabled
    op: equals
    value: true
