version: '1.0'
provider: aws
service: autoscaling
discovery:
- discovery_id: aws.autoscaling.describe_auto_scaling_groups
  calls:
  - action: describe_auto_scaling_groups
    save_as: describe_auto_scaling_groups_response
  emit:
    items_for: '{{ describe_auto_scaling_groups_response.AutoScalingGroups }}'
    as: resource
    item:
      auto_scaling_group_name: '{{ resource.AutoScalingGroupName }}'
      auto_scaling_group_arn: '{{ resource.AutoScalingGroupARN }}'
      launch_configuration_name: '{{ resource.LaunchConfigurationName }}'
      launch_template: '{{ resource.LaunchTemplate }}'
      mixed_instances_policy: '{{ resource.MixedInstancesPolicy }}'
      min_size: '{{ resource.MinSize }}'
      max_size: '{{ resource.MaxSize }}'
      desired_capacity: '{{ resource.DesiredCapacity }}'
      predicted_capacity: '{{ resource.PredictedCapacity }}'
      default_cooldown: '{{ resource.DefaultCooldown }}'
- discovery_id: aws.autoscaling.describe_policies
  calls:
  - action: describe_policies
    save_as: describe_policies_response
  emit:
    items_for: '{{ describe_policies_response.ScalingPolicies }}'
    as: resource
    item:
      auto_scaling_group_name: '{{ resource.AutoScalingGroupName }}'
      policy_name: '{{ resource.PolicyName }}'
      policy_arn: '{{ resource.PolicyARN }}'
      policy_type: '{{ resource.PolicyType }}'
      adjustment_type: '{{ resource.AdjustmentType }}'
      min_adjustment_step: '{{ resource.MinAdjustmentStep }}'
      min_adjustment_magnitude: '{{ resource.MinAdjustmentMagnitude }}'
      scaling_adjustment: '{{ resource.ScalingAdjustment }}'
      cooldown: '{{ resource.Cooldown }}'
      step_adjustments: '{{ resource.StepAdjustments }}'
checks:
- rule_id: aws.autoscaling.group.autoscaling_multiple_az_configured
  for_each: aws.autoscaling.describe_auto_scaling_groups
  conditions:
    var: item.availability_zones
    op: gt
    value: 1
- rule_id: aws.autoscaling.group.autoscaling_capacity_rebalance_enabled
  for_each: aws.autoscaling.describe_policies
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.autoscaling.group.security_check_health_check_enabled
  for_each: aws.autoscaling.describe_auto_scaling_groups
  conditions:
    var: item.health_check_type
    op: equals
    value: ELB
