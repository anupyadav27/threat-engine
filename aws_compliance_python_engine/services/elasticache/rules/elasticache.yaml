version: '1.0'
provider: aws
service: elasticache
services:
  client: elasticache
  module: boto3.client
discovery:
- discovery_id: aws.elasticache.describe_cache_clusters
  calls:
  - action: describe_cache_clusters
    save_as: response
  emit:
    item:
      CacheClusterId: '{{ response.CacheClusters.CacheClusterId }}'
      ConfigurationEndpoint: '{{ response.CacheClusters.ConfigurationEndpoint }}'
      ClientDownloadLandingPage: '{{ response.CacheClusters.ClientDownloadLandingPage
        }}'
      CacheNodeType: '{{ response.CacheClusters.CacheNodeType }}'
      Engine: '{{ response.CacheClusters.Engine }}'
      EngineVersion: '{{ response.CacheClusters.EngineVersion }}'
      CacheClusterStatus: '{{ response.CacheClusters.CacheClusterStatus }}'
      NumCacheNodes: '{{ response.CacheClusters.NumCacheNodes }}'
      PreferredAvailabilityZone: '{{ response.CacheClusters.PreferredAvailabilityZone
        }}'
      PreferredOutpostArn: '{{ response.CacheClusters.PreferredOutpostArn }}'
      CacheClusterCreateTime: '{{ response.CacheClusters.CacheClusterCreateTime }}'
      PreferredMaintenanceWindow: '{{ response.CacheClusters.PreferredMaintenanceWindow
        }}'
      PendingModifiedValues: '{{ response.CacheClusters.PendingModifiedValues }}'
      NotificationConfiguration: '{{ response.CacheClusters.NotificationConfiguration
        }}'
      CacheSecurityGroups: '{{ response.CacheClusters.CacheSecurityGroups }}'
      CacheParameterGroup: '{{ response.CacheClusters.CacheParameterGroup }}'
      CacheSubnetGroupName: '{{ response.CacheClusters.CacheSubnetGroupName }}'
      CacheNodes: '{{ response.CacheClusters.CacheNodes }}'
      AutoMinorVersionUpgrade: '{{ response.CacheClusters.AutoMinorVersionUpgrade
        }}'
      SecurityGroups: '{{ response.CacheClusters.SecurityGroups }}'
      ReplicationGroupId: '{{ response.CacheClusters.ReplicationGroupId }}'
      SnapshotRetentionLimit: '{{ response.CacheClusters.SnapshotRetentionLimit }}'
      SnapshotWindow: '{{ response.CacheClusters.SnapshotWindow }}'
      AuthTokenEnabled: '{{ response.CacheClusters.AuthTokenEnabled }}'
      AuthTokenLastModifiedDate: '{{ response.CacheClusters.AuthTokenLastModifiedDate
        }}'
      TransitEncryptionEnabled: '{{ response.CacheClusters.TransitEncryptionEnabled
        }}'
      AtRestEncryptionEnabled: '{{ response.CacheClusters.AtRestEncryptionEnabled
        }}'
      ARN: '{{ response.CacheClusters.ARN }}'
      ReplicationGroupLogDeliveryEnabled: '{{ response.CacheClusters.ReplicationGroupLogDeliveryEnabled
        }}'
      LogDeliveryConfigurations: '{{ response.CacheClusters.LogDeliveryConfigurations
        }}'
      NetworkType: '{{ response.CacheClusters.NetworkType }}'
      IpDiscovery: '{{ response.CacheClusters.IpDiscovery }}'
      TransitEncryptionMode: '{{ response.CacheClusters.TransitEncryptionMode }}'
- discovery_id: aws.elasticache.describe_global_replication_groups
  calls:
  - action: describe_global_replication_groups
    save_as: response
  emit:
    item:
      GlobalReplicationGroupId: '{{ response.GlobalReplicationGroups.GlobalReplicationGroupId
        }}'
      GlobalReplicationGroupDescription: '{{ response.GlobalReplicationGroups.GlobalReplicationGroupDescription
        }}'
      Status: '{{ response.GlobalReplicationGroups.Status }}'
      CacheNodeType: '{{ response.GlobalReplicationGroups.CacheNodeType }}'
      Engine: '{{ response.GlobalReplicationGroups.Engine }}'
      EngineVersion: '{{ response.GlobalReplicationGroups.EngineVersion }}'
      Members: '{{ response.GlobalReplicationGroups.Members }}'
      ClusterEnabled: '{{ response.GlobalReplicationGroups.ClusterEnabled }}'
      GlobalNodeGroups: '{{ response.GlobalReplicationGroups.GlobalNodeGroups }}'
      AuthTokenEnabled: '{{ response.GlobalReplicationGroups.AuthTokenEnabled }}'
      TransitEncryptionEnabled: '{{ response.GlobalReplicationGroups.TransitEncryptionEnabled
        }}'
      AtRestEncryptionEnabled: '{{ response.GlobalReplicationGroups.AtRestEncryptionEnabled
        }}'
      ARN: '{{ response.GlobalReplicationGroups.ARN }}'
- discovery_id: aws.elasticache.describe_replication_groups
  calls:
  - action: describe_replication_groups
    save_as: response
  emit:
    item:
      ReplicationGroupId: '{{ response.ReplicationGroups.ReplicationGroupId }}'
      Description: '{{ response.ReplicationGroups.Description }}'
      GlobalReplicationGroupInfo: '{{ response.ReplicationGroups.GlobalReplicationGroupInfo
        }}'
      Status: '{{ response.ReplicationGroups.Status }}'
      PendingModifiedValues: '{{ response.ReplicationGroups.PendingModifiedValues
        }}'
      MemberClusters: '{{ response.ReplicationGroups.MemberClusters }}'
      NodeGroups: '{{ response.ReplicationGroups.NodeGroups }}'
      SnapshottingClusterId: '{{ response.ReplicationGroups.SnapshottingClusterId
        }}'
      AutomaticFailover: '{{ response.ReplicationGroups.AutomaticFailover }}'
      MultiAZ: '{{ response.ReplicationGroups.MultiAZ }}'
      ConfigurationEndpoint: '{{ response.ReplicationGroups.ConfigurationEndpoint
        }}'
      SnapshotRetentionLimit: '{{ response.ReplicationGroups.SnapshotRetentionLimit
        }}'
      SnapshotWindow: '{{ response.ReplicationGroups.SnapshotWindow }}'
      ClusterEnabled: '{{ response.ReplicationGroups.ClusterEnabled }}'
      CacheNodeType: '{{ response.ReplicationGroups.CacheNodeType }}'
      AuthTokenEnabled: '{{ response.ReplicationGroups.AuthTokenEnabled }}'
      AuthTokenLastModifiedDate: '{{ response.ReplicationGroups.AuthTokenLastModifiedDate
        }}'
      TransitEncryptionEnabled: '{{ response.ReplicationGroups.TransitEncryptionEnabled
        }}'
      AtRestEncryptionEnabled: '{{ response.ReplicationGroups.AtRestEncryptionEnabled
        }}'
      MemberClustersOutpostArns: '{{ response.ReplicationGroups.MemberClustersOutpostArns
        }}'
      KmsKeyId: '{{ response.ReplicationGroups.KmsKeyId }}'
      ARN: '{{ response.ReplicationGroups.ARN }}'
      UserGroupIds: '{{ response.ReplicationGroups.UserGroupIds }}'
      LogDeliveryConfigurations: '{{ response.ReplicationGroups.LogDeliveryConfigurations
        }}'
      ReplicationGroupCreateTime: '{{ response.ReplicationGroups.ReplicationGroupCreateTime
        }}'
      DataTiering: '{{ response.ReplicationGroups.DataTiering }}'
      AutoMinorVersionUpgrade: '{{ response.ReplicationGroups.AutoMinorVersionUpgrade
        }}'
      NetworkType: '{{ response.ReplicationGroups.NetworkType }}'
      IpDiscovery: '{{ response.ReplicationGroups.IpDiscovery }}'
      TransitEncryptionMode: '{{ response.ReplicationGroups.TransitEncryptionMode
        }}'
      ClusterMode: '{{ response.ReplicationGroups.ClusterMode }}'
      Engine: '{{ response.ReplicationGroups.Engine }}'
- discovery_id: aws.elasticache.describe_service_updates
  calls:
  - action: describe_service_updates
    save_as: response
  emit:
    item:
      ServiceUpdateName: '{{ response.ServiceUpdates.ServiceUpdateName }}'
      ServiceUpdateReleaseDate: '{{ response.ServiceUpdates.ServiceUpdateReleaseDate
        }}'
      ServiceUpdateEndDate: '{{ response.ServiceUpdates.ServiceUpdateEndDate }}'
      ServiceUpdateSeverity: '{{ response.ServiceUpdates.ServiceUpdateSeverity }}'
      ServiceUpdateRecommendedApplyByDate: '{{ response.ServiceUpdates.ServiceUpdateRecommendedApplyByDate
        }}'
      ServiceUpdateStatus: '{{ response.ServiceUpdates.ServiceUpdateStatus }}'
      ServiceUpdateDescription: '{{ response.ServiceUpdates.ServiceUpdateDescription
        }}'
      ServiceUpdateType: '{{ response.ServiceUpdates.ServiceUpdateType }}'
      Engine: '{{ response.ServiceUpdates.Engine }}'
      EngineVersion: '{{ response.ServiceUpdates.EngineVersion }}'
      AutoUpdateAfterRecommendedApplyByDate: '{{ response.ServiceUpdates.AutoUpdateAfterRecommendedApplyByDate
        }}'
      EstimatedUpdateTime: '{{ response.ServiceUpdates.EstimatedUpdateTime }}'
checks:
- rule_id: aws.elasticache.cluster.require_tls_in_transit_configured
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.TransitEncryptionEnabled
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.encryption_at_rest_cmek_configured
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.AtRestEncryptionEnabled
    op: equals
    value: true
- rule_id: aws.elasticache.node.public_access_disabled
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.CacheSecurityGroups
    op: equals
    value: []
- rule_id: aws.elasticache.cluster.elasticache_automatic_failover_enabled
  for_each: aws.elasticache.describe_replication_groups
  conditions:
    var: item.AutomaticFailover
    op: equals
    value: ENABLED
- rule_id: aws.elasticache.node.deletion_protection_enabled
  for_each: aws.elasticache.describe_global_replication_groups
  conditions:
    var: item.ClusterEnabled
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.rest_encryption_enabled
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.AtRestEncryptionEnabled
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.deletion_protection_enabled
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.CacheClusterStatus
    op: equals
    value: ENABLED
- rule_id: aws.elasticache.cluster.elasticache_minor_version_auto_upgrade_enabled
  for_each: aws.elasticache.describe_service_updates
  conditions:
    var: item.AutoUpdateAfterRecommendedApplyByDate
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.audit_logging_enabled
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.AuthTokenEnabled
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.public_access_disabled
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.ConfigurationEndpoint
    op: exists
- rule_id: aws.elasticache.node.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.AuthTokenEnabled
    op: equals
    value: true
- rule_id: aws.elasticache.node.require_tls_in_transit_configured
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.TransitEncryptionEnabled
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.in_transit_encryption_enabled
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.TransitEncryptionEnabled
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.AuthTokenEnabled
    op: equals
    value: true
- rule_id: aws.elasticache.node.encryption_at_rest_enabled
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.AtRestEncryptionEnabled
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.encryption_at_rest_enabled
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.AtRestEncryptionEnabled
    op: equals
    value: true
- rule_id: aws.elasticache.cluster.elasticache_multi_az_enabled
  for_each: aws.elasticache.describe_replication_groups
  conditions:
    var: item.MultiAZ
    op: equals
    value: true
- rule_id: aws.elasticache.backupretention.backup_retention_configured
  for_each: aws.elasticache.describe_cache_clusters
  conditions:
    var: item.SnapshotRetentionLimit
    op: gt
    value: 0
