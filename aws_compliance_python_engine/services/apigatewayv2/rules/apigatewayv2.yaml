version: '1.0'
provider: aws
service: apigatewayv2
services:
  client: apigatewayv2
  module: boto3.client
discovery:
- discovery_id: aws.apigatewayv2.get_route
  calls:
  - action: get_route
    save_as: response
    params:
      ApiId: '{{ item.ApiId }}'
      RouteId: '{{ item.RouteId }}'
  on_error: continue
  for_each: aws.apigatewayv2.get_apis
- discovery_id: aws.apigatewayv2.get_stage
  calls:
  - action: get_stage
    save_as: response
    params:
      StageName: '{{ item.StageName }}'
      ApiId: '{{ item.ApiId }}'
  on_error: continue
  for_each: aws.apigatewayv2.get_stages
  emit:
    item:
      DestinationArn: '{{ response.AccessLogSettings.DestinationArn }}'
      Format: '{{ response.AccessLogSettings.Format }}'
checks:
- rule_id: aws.apigatewayv2.stage.api_quota_limit_configured
  for_each: aws.apigatewayv2.get_stages
  conditions:
    var: item.route_settings
    op: exists
- rule_id: aws.apigatewayv2.stage.api_usage_plan_required_for_api_keys
  for_each: aws.apigatewayv2.get_routes
  conditions:
    var: item.api_key_required
    op: equals
    value: true
- rule_id: aws.apigatewayv2.stage.api_burst_limit_configured
  for_each: aws.apigatewayv2.get_stages
  conditions:
    var: item.route_settings
    op: exists
- rule_id: aws.apigatewayv2.resource.api_access_logging_enabled
  for_each: aws.apigatewayv2.get_stages
  conditions:
    var: item.access_log_settings
    op: exists
- rule_id: aws.apigatewayv2.stage.api_logs_retention_days_minimum
  for_each: aws.apigatewayv2.get_stages
  conditions:
    var: item.access_log_settings
    op: exists
- rule_id: aws.apigatewayv2.stage.api_access_logging_enabled
  for_each: aws.apigatewayv2.get_stages
  conditions:
    var: item.access_log_settings
    op: exists
- rule_id: aws.apigatewayv2.stage.api_access_log_sink_configured
  for_each: aws.apigatewayv2.get_stages
  conditions:
    var: item.access_log_settings
    op: exists
- rule_id: aws.apigatewayv2.stage.api_execution_logging_level_minimum_error_configured
  for_each: aws.apigatewayv2.get_stages
  conditions:
    var: item.access_log_settings
    op: exists
- rule_id: aws.apigatewayv2.api.access_logging_enabled
  for_each: aws.apigatewayv2.get_stages
  conditions:
    var: item.access_log_settings
    op: exists
- rule_id: aws.apigatewayv2.stage.api_rate_limit_configured
  for_each: aws.apigatewayv2.get_stages
  conditions:
    var: item.route_settings
    op: exists
- rule_id: aws.apigatewayv2.stage.api_throttle_overrides_bounded
  for_each: aws.apigatewayv2.get_stages
  conditions:
    var: item.route_settings
    op: exists
- rule_id: aws.apigatewayv2.stage.api_access_log_fields_identity_configured
  for_each: aws.apigatewayv2.get_stages
  conditions:
    var: item.access_log_settings
    op: exists
