version: '1.0'
provider: aws
service: redshift
discovery:
- discovery_id: aws.redshift.describe_hsm_configurations
  calls:
  - action: describe_hsm_configurations
    save_as: describe_hsm_configurations_response
  emit:
    items_for: '{{ describe_hsm_configurations_response.HsmConfigurations }}'
    as: resource
    item:
      hsm_configuration_identifier: '{{ resource.HsmConfigurationIdentifier }}'
      description: '{{ resource.Description }}'
      hsm_ip_address: '{{ resource.HsmIpAddress }}'
      hsm_partition_name: '{{ resource.HsmPartitionName }}'
      tags: '{{ resource.Tags }}'
- discovery_id: aws.redshift.describe_cluster_security_groups
  calls:
  - action: describe_cluster_security_groups
    save_as: describe_cluster_security_groups_response
  emit:
    items_for: '{{ describe_cluster_security_groups_response.ClusterSecurityGroups
      }}'
    as: resource
    item:
      cluster_security_group_name: '{{ resource.ClusterSecurityGroupName }}'
      description: '{{ resource.Description }}'
      ec2_security_groups: '{{ resource.EC2SecurityGroups }}'
      ip_ranges: '{{ resource.IPRanges }}'
      tags: '{{ resource.Tags }}'
- discovery_id: aws.redshift.describe_clusters
  calls:
  - action: describe_clusters
    save_as: describe_clusters_response
  emit:
    items_for: '{{ describe_clusters_response.Clusters }}'
    as: resource
    item:
      cluster_identifier: '{{ resource.ClusterIdentifier }}'
      node_type: '{{ resource.NodeType }}'
      cluster_status: '{{ resource.ClusterStatus }}'
      cluster_availability_status: '{{ resource.ClusterAvailabilityStatus }}'
      modify_status: '{{ resource.ModifyStatus }}'
      master_username: '{{ resource.MasterUsername }}'
      db_name: '{{ resource.DBName }}'
      endpoint: '{{ resource.Endpoint }}'
      cluster_create_time: '{{ resource.ClusterCreateTime }}'
      automated_snapshot_retention_period: '{{ resource.AutomatedSnapshotRetentionPeriod
        }}'
- discovery_id: aws.redshift.describe_endpoint_access
  calls:
  - action: describe_endpoint_access
    save_as: describe_endpoint_access_response
  emit:
    items_for: '{{ describe_endpoint_access_response.EndpointAccessList }}'
    as: resource
    item:
      cluster_identifier: '{{ resource.ClusterIdentifier }}'
      resource_owner: '{{ resource.ResourceOwner }}'
      subnet_group_name: '{{ resource.SubnetGroupName }}'
      endpoint_status: '{{ resource.EndpointStatus }}'
      endpoint_name: '{{ resource.EndpointName }}'
      endpoint_create_time: '{{ resource.EndpointCreateTime }}'
      port: '{{ resource.Port }}'
      address: '{{ resource.Address }}'
      vpc_security_groups: '{{ resource.VpcSecurityGroups }}'
      vpc_endpoint: '{{ resource.VpcEndpoint }}'
- discovery_id: aws.redshift.describe_event_subscriptions
  calls:
  - action: describe_event_subscriptions
    save_as: describe_event_subscriptions_response
  emit:
    items_for: '{{ describe_event_subscriptions_response.EventSubscriptionsList }}'
    as: resource
    item:
      customer_aws_id: '{{ resource.CustomerAwsId }}'
      cust_subscription_id: '{{ resource.CustSubscriptionId }}'
      sns_topic_arn: '{{ resource.SnsTopicArn }}'
      status: '{{ resource.Status }}'
      subscription_creation_time: '{{ resource.SubscriptionCreationTime }}'
      source_type: '{{ resource.SourceType }}'
      source_ids_list: '{{ resource.SourceIdsList }}'
      event_categories_list: '{{ resource.EventCategoriesList }}'
      severity: '{{ resource.Severity }}'
      enabled: '{{ resource.Enabled }}'
- discovery_id: aws.redshift.describe_hsm_client_certificates
  calls:
  - action: describe_hsm_client_certificates
    save_as: describe_hsm_client_certificates_response
  emit:
    items_for: '{{ describe_hsm_client_certificates_response.HsmClientCertificates
      }}'
    as: resource
    item:
      hsm_client_certificate_identifier: '{{ resource.HsmClientCertificateIdentifier
        }}'
      hsm_client_certificate_public_key: '{{ resource.HsmClientCertificatePublicKey
        }}'
      tags: '{{ resource.Tags }}'
- discovery_id: aws.redshift.describe_endpoint_authorization
  calls:
  - action: describe_endpoint_authorization
    save_as: describe_endpoint_authorization_response
  emit:
    items_for: '{{ describe_endpoint_authorization_response.EndpointAuthorizationList
      }}'
    as: resource
    item:
      grantor: '{{ resource.Grantor }}'
      grantee: '{{ resource.Grantee }}'
      cluster_identifier: '{{ resource.ClusterIdentifier }}'
      authorize_time: '{{ resource.AuthorizeTime }}'
      cluster_status: '{{ resource.ClusterStatus }}'
      status: '{{ resource.Status }}'
      allowed_all_vp_cs: '{{ resource.AllowedAllVPCs }}'
      allowed_vp_cs: '{{ resource.AllowedVPCs }}'
      endpoint_count: '{{ resource.EndpointCount }}'
- discovery_id: aws.redshift.describe_cluster_snapshots
  calls:
  - action: describe_cluster_snapshots
    save_as: describe_cluster_snapshots_response
  emit:
    items_for: '{{ describe_cluster_snapshots_response.Snapshots }}'
    as: resource
    item:
      snapshot_identifier: '{{ resource.SnapshotIdentifier }}'
      cluster_identifier: '{{ resource.ClusterIdentifier }}'
      snapshot_create_time: '{{ resource.SnapshotCreateTime }}'
      status: '{{ resource.Status }}'
      port: '{{ resource.Port }}'
      availability_zone: '{{ resource.AvailabilityZone }}'
      cluster_create_time: '{{ resource.ClusterCreateTime }}'
      master_username: '{{ resource.MasterUsername }}'
      cluster_version: '{{ resource.ClusterVersion }}'
      engine_full_version: '{{ resource.EngineFullVersion }}'
- discovery_id: aws.redshift.describe_cluster_subnet_groups
  calls:
  - action: describe_cluster_subnet_groups
    save_as: describe_cluster_subnet_groups_response
  emit:
    items_for: '{{ describe_cluster_subnet_groups_response.ClusterSubnetGroups }}'
    as: resource
    item:
      cluster_subnet_group_name: '{{ resource.ClusterSubnetGroupName }}'
      description: '{{ resource.Description }}'
      vpc_id: '{{ resource.VpcId }}'
      subnet_group_status: '{{ resource.SubnetGroupStatus }}'
      subnets: '{{ resource.Subnets }}'
      tags: '{{ resource.Tags }}'
      supported_cluster_ip_address_types: '{{ resource.SupportedClusterIpAddressTypes
        }}'
- discovery_id: aws.redshift.describe_data_shares
  calls:
  - action: describe_data_shares
    save_as: describe_data_shares_response
  emit:
    items_for: '{{ describe_data_shares_response.DataShares }}'
    as: resource
    item:
      data_share_arn: '{{ resource.DataShareArn }}'
      producer_arn: '{{ resource.ProducerArn }}'
      allow_publicly_accessible_consumers: '{{ resource.AllowPubliclyAccessibleConsumers
        }}'
      data_share_associations: '{{ resource.DataShareAssociations }}'
      managed_by: '{{ resource.ManagedBy }}'
      data_share_type: '{{ resource.DataShareType }}'
- discovery_id: aws.redshift.describe_authentication_profiles
  calls:
  - action: describe_authentication_profiles
    save_as: describe_authentication_profiles_response
  emit:
    items_for: '{{ describe_authentication_profiles_response.AuthenticationProfiles
      }}'
    as: resource
    item:
      authentication_profile_name: '{{ resource.AuthenticationProfileName }}'
      authentication_profile_content: '{{ resource.AuthenticationProfileContent }}'
- discovery_id: aws.redshift.describe_cluster_parameter_groups
  calls:
  - action: describe_cluster_parameter_groups
    save_as: describe_cluster_parameter_groups_response
  emit:
    items_for: '{{ describe_cluster_parameter_groups_response.ParameterGroups }}'
    as: resource
    item:
      parameter_group_name: '{{ resource.ParameterGroupName }}'
      parameter_group_family: '{{ resource.ParameterGroupFamily }}'
      description: '{{ resource.Description }}'
      tags: '{{ resource.Tags }}'
- discovery_id: aws.redshift.describe_cluster_parameters
  calls:
  - action: describe_cluster_parameters
    save_as: describe_cluster_parameters_response
    params:
      ParameterGroupName: '{{ item.parameter_group_name }}'
    on_error: continue
  for_each: aws.redshift.describe_cluster_parameter_groups
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      parameter_name: '{{ describe_cluster_parameters_response.Parameters.ParameterName
        }}'
      parameter_value: '{{ describe_cluster_parameters_response.Parameters.ParameterValue
        }}'
      description: '{{ describe_cluster_parameters_response.Parameters.Description
        }}'
      source: '{{ describe_cluster_parameters_response.Parameters.Source }}'
      data_type: '{{ describe_cluster_parameters_response.Parameters.DataType }}'
checks:
- rule_id: aws.redshift.hsm_configuration.redshift_configuration_present
  for_each: aws.redshift.describe_hsm_configurations
  conditions:
    var: item.hsm_configuration_identifier
    op: exists
- rule_id: aws.redshift.hsm_configuration.keys_in_hsm_only_configured
  for_each: aws.redshift.describe_hsm_configurations
  conditions:
    var: item.hsm_configuration_identifier
    op: exists
- rule_id: aws.redshift.securitygroup.security_only_required_ports_open_restricted
  for_each: aws.redshift.describe_cluster_security_groups
  conditions:
    var: item.ip_ranges
    op: equals
    value: []
- rule_id: aws.redshift.parametergroup.audit_logging_enabled
  for_each: aws.redshift.describe_cluster_parameters
  conditions:
    all:
    - var: item.parameter_name
      op: equals
      value: enable_user_activity_logging
    - var: item.parameter_value
      op: equals
      value: 'true'
- rule_id: aws.redshift.cluster.admin_access_least_privilege
  for_each: aws.redshift.describe_clusters
  conditions:
    all:
    - var: item.cluster_security_groups
      op: equals
      value: []
    - var: item.vpc_security_groups
      op: equals
      value: []
- rule_id: aws.redshift.endpointaccess.tls_required
  for_each: aws.redshift.describe_endpoint_access
  conditions:
    var: item.endpoint_status
    op: equals
    value: ACTIVE
- rule_id: aws.redshift.endpointaccess.access_allowed_cidrs_minimized_configured
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.vpc_security_groups
    op: equals
    value: []
- rule_id: aws.redshift.event_subscription.redshift_destination_encrypted
  for_each: aws.redshift.describe_event_subscriptions
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.redshift.event_subscription.redshift_cross_account_sharing_restricted
  for_each: aws.redshift.describe_event_subscriptions
  conditions:
    all:
    - var: item.status
      op: equals
      value: ENABLED
    - var: item.customer_aws_id
      op: equals
      value: your_account_id
- rule_id: aws.redshift.hsm_client_certificate.key_length_minimum
  for_each: aws.redshift.describe_hsm_client_certificates
  conditions:
    var: item.hsm_client_certificate_public_key
    op: contains
    value: '2048'
- rule_id: aws.redshift.parametergroup.require_ssl_configured
  for_each: aws.redshift.describe_cluster_parameters
  conditions:
    all:
    - var: item.parameter_name
      op: equals
      value: require_ssl
    - var: item.parameter_value
      op: equals
      value: 'true'
- rule_id: aws.redshift.hsm_configuration.only_approved_hsm_endpoints_configured
  for_each: aws.redshift.describe_hsm_configurations
  conditions:
    var: item.hsm_ip_address
    op: contains
    value:
    - approved_endpoint_1
    - approved_endpoint_2
- rule_id: aws.redshift.endpoint_authorization.no_anonymous_access_configured
  for_each: aws.redshift.describe_endpoint_authorization
  conditions:
    var: item.allowed_all_vp_cs
    op: equals
    value: false
- rule_id: aws.redshift.user.redshift_approved_list_of_supers_only_configured
  for_each: aws.redshift.describe_cluster_snapshots
  conditions:
    var: item.master_username
    op: contains
    value:
    - approved_superuser1
    - approved_superuser2
- rule_id: aws.redshift.cluster.in_transit_encryption_enabled
  for_each: aws.redshift.describe_cluster_snapshots
  conditions:
    var: item.cluster_version
    op: gte
    value: '1.2'
- rule_id: aws.redshift.resource.backup_enabled
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.automated_snapshot_retention_period
    op: gt
    value: 0
- rule_id: aws.redshift.securitygroup.security_no_0_configured
  for_each: aws.redshift.describe_cluster_security_groups
  conditions:
    var: item.ip_ranges
    op: equals
    value: []
- rule_id: aws.redshift.cluster.enhanced_vpc_routing_configured
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.cluster_status
    op: equals
    value: ENABLED
- rule_id: aws.redshift.cluster.automated_snapshot_configured
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.automated_snapshot_retention_period
    op: gt
    value: 0
- rule_id: aws.redshift.subnetgroup.redshift_private_subnets_only_configured
  for_each: aws.redshift.describe_cluster_subnet_groups
  conditions:
    all:
    - var: item.subnet_group_status
      op: equals
      value: Complete
    - var: item.supported_cluster_ip_address_types
      op: equals
      value:
      - PRIVATE
- rule_id: aws.redshift.cluster.deletion_protection_enabled
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.cluster_status
    op: equals
    value: ENABLED
- rule_id: aws.redshift.cluster.multi_az_enabled
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.cluster_availability_status
    op: equals
    value: ENABLED
- rule_id: aws.redshift.cluster.minor_version_auto_upgrade_enabled
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.cluster_status
    op: equals
    value: ENABLED
- rule_id: aws.redshift.endpoint_authorization.rbac_least_privilege
  for_each: aws.redshift.describe_endpoint_authorization
  conditions:
    all:
    - var: item.status
      op: equals
      value: AUTHORIZED
    - var: item.allowed_vp_cs
      op: equals
      value: []
    - var: item.allowed_all_vp_cs
      op: equals
      value: false
- rule_id: aws.redshift.cluster.private_networking_enforced
  for_each: aws.redshift.describe_clusters
  conditions:
    all:
    - var: item.cluster_subnet_group_name
      op: exists
    - var: item.vpc_security_groups
      op: equals
      value: []
- rule_id: aws.redshift.hsm_client_certificate.certificate_trusted_issuer_verified
  for_each: aws.redshift.describe_hsm_client_certificates
  conditions:
    var: item.hsm_client_certificate_identifier
    op: exists
- rule_id: aws.redshift.cluster.tls_min_1_2_enforced
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.cluster_parameter_groups
    op: contains
    value: tls_min_1_2
- rule_id: aws.redshift.securitygroup.security_egress_restricted
  for_each: aws.redshift.describe_cluster_security_groups
  conditions:
    var: item.ip_ranges
    op: equals
    value: []
- rule_id: aws.redshift.securitygroup.security_no_0_ingress_configured
  for_each: aws.redshift.describe_cluster_security_groups
  conditions:
    var: item.ip_ranges
    op: equals
    value: []
- rule_id: aws.redshift.securitygroup.security_no_0_ingress_on_db_ports_configured
  for_each: aws.redshift.describe_cluster_security_groups
  conditions:
    var: item.ip_ranges
    op: equals
    value: []
- rule_id: aws.redshift.cluster.public_access_configured
  for_each: aws.redshift.describe_data_shares
  conditions:
    var: item.allow_publicly_accessible_consumers
    op: equals
    value: false
- rule_id: aws.redshift.user.iam_auth_preferred_configured
  for_each: aws.redshift.describe_authentication_profiles
  conditions:
    var: item.authentication_profile_name
    op: exists
- rule_id: aws.redshift.cluster.encryption_at_rest_cmek_configured
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.cluster_status
    op: equals
    value: ENABLED
- rule_id: aws.redshift.cluster.maintenance_settings_configured
  for_each: aws.redshift.describe_clusters
  conditions:
    all:
    - var: item.maintenance_track_name
      op: exists
    - var: item.cluster_status
      op: equals
      value: available
- rule_id: aws.redshift.snapshot.encryption_at_rest_enabled
  for_each: aws.redshift.describe_cluster_snapshots
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.redshift.snapshot.redshift_cross_account_sharing_restricted
  for_each: aws.redshift.describe_data_shares
  conditions:
    var: item.allow_publicly_accessible_consumers
    op: equals
    value: false
- rule_id: aws.redshift.snapshot.not_publicly_shared_configured
  for_each: aws.redshift.describe_data_shares
  conditions:
    var: item.allow_publicly_accessible_consumers
    op: equals
    value: false
- rule_id: aws.redshift.event_subscription.redshift_destination_least_privilege
  for_each: aws.redshift.describe_event_subscriptions
  conditions:
    all:
    - var: item.status
      op: equals
      value: ACTIVE
    - var: item.enabled
      op: equals
      value: true
- rule_id: aws.redshift.parametergroup.tls_required
  for_each: aws.redshift.describe_cluster_parameters
  conditions:
    all:
    - var: item.parameter_name
      op: equals
      value: require_ssl
    - var: item.parameter_value
      op: equals
      value: 'true'
- rule_id: aws.redshift.parametergroup.redshift_insecure_features_disabled_if_applicable_configured
  for_each: aws.redshift.describe_cluster_parameter_groups
  conditions:
    var: item.parameter_group_name
    op: exists
- rule_id: aws.redshift.cluster.audit_logging_configured
  for_each: aws.redshift.describe_event_subscriptions
  conditions:
    var: item.enabled
    op: equals
    value: true
- rule_id: aws.redshift.cluster.encryption_at_rest_enabled
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.cluster_status
    op: equals
    value: ENABLED
- rule_id: aws.redshift.user.redshift_no_unused_or_default_supers_configured
  for_each: aws.redshift.describe_clusters
  conditions:
    all:
    - var: item.master_username
      op: equals
      value: awsuser
    - var: item.cluster_status
      op: equals
      value: available
- rule_id: aws.redshift.snapshot.redshift_cross_region_copy_encrypted
  for_each: aws.redshift.describe_cluster_snapshots
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.redshift.parametergroup.logging_enabled
  for_each: aws.redshift.describe_cluster_parameters
  conditions:
    all:
    - var: item.parameter_name
      op: equals
      value: enable_user_activity_logging
    - var: item.parameter_value
      op: equals
      value: 'true'
- rule_id: aws.redshift.endpointaccess.access_private_only_configured
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.vpc_security_groups
    op: equals
    value: []
- rule_id: aws.redshift.securitygroup.security_only_required_ports
  for_each: aws.redshift.describe_cluster_security_groups
  conditions:
    var: item.ip_ranges
    op: equals
    value: []
- rule_id: aws.redshift.snapshot.kms_key_policy_least_privilege
  for_each: aws.redshift.describe_cluster_snapshots
  conditions:
    var: item.kms_key_id
    op: exists
- rule_id: aws.redshift.cluster.automatic_upgrades_configured
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.cluster_status
    op: equals
    value: AVAILABLE
- rule_id: aws.redshift.hsm_client_certificate.certificate_valid
  for_each: aws.redshift.describe_hsm_client_certificates
  conditions:
    var: item.hsm_client_certificate_identifier
    op: exists
