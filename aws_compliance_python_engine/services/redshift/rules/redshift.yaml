version: '1.0'
provider: aws
service: redshift
discovery:
- discovery_id: aws.redshift.securitygroups
  calls:
  - client: redshift
    action: describe_clusters
    save_as: securitygroup_list
    on_error: continue
    fields:
    - Redshifts
  emit:
    items_for: securitygroup_list[]
    as: securitygroup
    item:
      id: '{{ securitygroup.Id }}'
      name: '{{ securitygroup.Name }}'
- discovery_id: aws.redshift.securitygroup_encryption
  for_each: aws.redshift.securitygroups
  calls:
  - client: redshift
    action: describe_clusters
    params:
      SecuritygroupId: '{{ item.id }}'
    save_as: encryption
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      encryption_enabled: '{{ encryption.Encrypted if encryption.Encrypted is defined
        else false }}'
- discovery_id: aws.redshift.securitygroup_logging
  for_each: aws.redshift.securitygroups
  calls:
  - client: redshift
    action: describe_account_attributes
    params:
      SecuritygroupId: '{{ item.id }}'
    save_as: logging
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      logging_enabled: '{{ logging.LoggingEnabled is defined if logging else false
        }}'
- discovery_id: aws.redshift.event_subscriptions
  for_each: aws.redshift.event_subscription
  calls:
  - client: redshift
    action: describe_event_subscriptions
    save_as: event_subscriptions
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.redshift.users
  for_each: aws.redshift.user
  calls:
  - client: redshift
    action: describe_account_attributes
    save_as: users
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.redshift.parametergroups
  for_each: aws.redshift.parametergroup
  calls:
  - client: redshift
    action: describe_account_attributes
    save_as: parametergroups
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.redshift.snapshot_encryption
  calls:
  - client: redshift
    action: list_recommendations
    save_as: snapshot_encryption
    on_error: continue
  emit:
    items_for: snapshot_encryption[]
    as: snapshot_encryption
    item:
      id: '{{ snapshot_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.redshift.resources
  for_each: aws.redshift.resource
  calls:
  - client: redshift
    action: describe_account_attributes
    save_as: resources
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.redshift.subnetgroups
  for_each: aws.redshift.subnetgroup
  calls:
  - client: redshift
    action: describe_account_attributes
    save_as: subnetgroups
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.redshift.clusters
  for_each: aws.redshift.cluster
  calls:
  - client: redshift
    action: describe_clusters
    save_as: clusters
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.redshift.endpoint_authorizations
  for_each: aws.redshift.endpoint_authorization
  calls:
  - client: redshift
    action: describe_account_attributes
    save_as: endpoint_authorizations
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.redshift.endpointaccesss
  for_each: aws.redshift.endpointacce
  calls:
  - client: redshift
    action: describe_account_attributes
    save_as: endpointaccesss
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.redshift.hsm_client_certificates
  for_each: aws.redshift.hsm_client_certificate
  calls:
  - client: redshift
    action: describe_hsm_client_certificates
    save_as: hsm_client_certificates
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.redshift.cluster_logging
  calls:
  - client: redshift
    action: list_recommendations
    save_as: cluster_logging
    on_error: continue
  emit:
    items_for: cluster_logging[]
    as: cluster_logging
    item:
      id: '{{ cluster_logging.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.redshift.hsm_configurations
  for_each: aws.redshift.hsm_configuration
  calls:
  - client: redshift
    action: describe_hsm_configurations
    save_as: hsm_configurations
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.redshift.event_subscription_encryption
  calls:
  - client: redshift
    action: list_recommendations
    save_as: event_subscription_encryption
    on_error: continue
  emit:
    items_for: event_subscription_encryption[]
    as: event_subscription_encryption
    item:
      id: '{{ event_subscription_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.redshift.snapshots
  for_each: aws.redshift.snapshot
  calls:
  - client: redshift
    action: describe_snapshot_schedules
    save_as: snapshots
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
- discovery_id: aws.redshift.cluster_encryption
  calls:
  - client: redshift
    action: list_recommendations
    save_as: cluster_encryption
    on_error: continue
  emit:
    items_for: cluster_encryption[]
    as: cluster_encryption
    item:
      id: '{{ cluster_encryption.Id }}'
      compliant: '{{ true }}'
- discovery_id: aws.redshift.parametergroup_logging
  calls:
  - client: redshift
    action: list_recommendations
    save_as: parametergroup_logging
    on_error: continue
  emit:
    items_for: parametergroup_logging[]
    as: parametergroup_logging
    item:
      id: '{{ parametergroup_logging.Id }}'
      compliant: '{{ true }}'
checks:
- title: 'REDSHIFT hsm configuration: Redshift Configuration Present'
  severity: medium
  rule_id: aws.redshift.hsm_configuration.redshift_configuration_present
  for_each:
    discovery: aws.redshift.hsm_configurations
    as: hsm_configuration
    item: hsm_configuration
  conditions:
    var: hsm_configuration.compliant
    op: equals
    value: true
- title: 'REDSHIFT hsm configuration: Keys In Hsm Only Configured'
  severity: medium
  rule_id: aws.redshift.hsm_configuration.keys_in_hsm_only_configured
  for_each:
    discovery: aws.redshift.hsm_configurations
    as: hsm_configuration
    item: hsm_configuration
  conditions:
    var: hsm_configuration.compliant
    op: equals
    value: true
- title: 'REDSHIFT securitygroup: Security Only Required Ports Open Restricted'
  severity: medium
  rule_id: aws.redshift.securitygroup.security_only_required_ports_open_restricted
  for_each:
    discovery: aws.redshift.securitygroups
    as: securitygroup
    item: securitygroup
  conditions:
    var: securitygroup.compliant
    op: equals
    value: true
- title: 'REDSHIFT parametergroup: Audit Logging Enabled'
  severity: medium
  rule_id: aws.redshift.parametergroup.audit_logging_enabled
  for_each:
    discovery: aws.redshift.parametergroup_logging
    as: parametergroup
    item: parametergroup
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'REDSHIFT cluster: Admin Access Least Privilege'
  severity: high
  rule_id: aws.redshift.cluster.admin_access_least_privilege
  for_each:
    discovery: aws.redshift.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.is_public
    op: equals
    value: false
- title: 'REDSHIFT endpointaccess: Tls Required'
  severity: high
  rule_id: aws.redshift.endpointaccess.tls_required
  for_each:
    discovery: aws.redshift.endpointaccesss
    as: endpointaccess
    item: endpointaccess
  conditions:
    var: endpointaccess.is_public
    op: equals
    value: false
- title: 'REDSHIFT endpointaccess: Access Allowed Cidrs Minimized Configured'
  severity: medium
  rule_id: aws.redshift.endpointaccess.access_allowed_cidrs_minimized_configured
  for_each:
    discovery: aws.redshift.endpointaccesss
    as: endpointaccess
    item: endpointaccess
  conditions:
    var: endpointaccess.is_public
    op: equals
    value: false
- title: 'REDSHIFT event subscription: Redshift Destination Encrypted'
  severity: high
  rule_id: aws.redshift.event_subscription.redshift_destination_encrypted
  for_each:
    discovery: aws.redshift.event_subscription_encryption
    as: event_subscription
    item: event_subscription
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'REDSHIFT event subscription: Redshift Cross Account Sharing Restricted'
  severity: medium
  rule_id: aws.redshift.event_subscription.redshift_cross_account_sharing_restricted
  for_each:
    discovery: aws.redshift.event_subscriptions
    as: event_subscription
    item: event_subscription
  conditions:
    var: event_subscription.compliant
    op: equals
    value: true
- title: 'REDSHIFT cluster: Audit Logging Enabled'
  severity: medium
  rule_id: aws.redshift.cluster.audit_logging_enabled
  for_each:
    discovery: aws.redshift.cluster_logging
    as: cluster
    item: cluster
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'REDSHIFT hsm client certificate: Key Length Minimum'
  severity: medium
  rule_id: aws.redshift.hsm_client_certificate.key_length_minimum
  for_each:
    discovery: aws.redshift.hsm_client_certificates
    as: hsm_client_certificate
    item: hsm_client_certificate
  conditions:
    var: hsm_client_certificate.compliant
    op: equals
    value: true
- title: 'REDSHIFT parametergroup: Require Ssl Configured'
  severity: high
  rule_id: aws.redshift.parametergroup.require_ssl_configured
  for_each:
    discovery: aws.redshift.parametergroups
    as: parametergroup
    item: parametergroup
  conditions:
    var: parametergroup.in_vpc
    op: equals
    value: true
- title: 'REDSHIFT hsm configuration: Only Approved Hsm Endpoints Configured'
  severity: medium
  rule_id: aws.redshift.hsm_configuration.only_approved_hsm_endpoints_configured
  for_each:
    discovery: aws.redshift.hsm_configurations
    as: hsm_configuration
    item: hsm_configuration
  conditions:
    var: hsm_configuration.compliant
    op: equals
    value: true
- title: 'REDSHIFT endpoint authorization: No Anonymous Access Configured'
  severity: medium
  rule_id: aws.redshift.endpoint_authorization.no_anonymous_access_configured
  for_each:
    discovery: aws.redshift.endpoint_authorizations
    as: endpoint_authorization
    item: endpoint_authorization
  conditions:
    var: endpoint_authorization.is_public
    op: equals
    value: false
- title: 'REDSHIFT user: Redshift Approved List Of Supers Only Configured'
  severity: medium
  rule_id: aws.redshift.user.redshift_approved_list_of_supers_only_configured
  for_each:
    discovery: aws.redshift.users
    as: user
    item: user
  conditions:
    var: user.compliant
    op: equals
    value: true
- title: Data warehouse encryption is enabled
  severity: high
  rule_id: aws.redshift.cluster.in_transit_encryption_enabled
  for_each:
    discovery: aws.redshift.cluster_encryption
    as: cluster
    item: cluster
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'REDSHIFT resource: Backup Enabled'
  severity: medium
  rule_id: aws.redshift.resource.backup_enabled
  for_each:
    discovery: aws.redshift.resources
    as: resource
    item: resource
  conditions:
    var: resource.versioning_enabled
    op: equals
    value: true
- title: 'REDSHIFT securitygroup: Security No 0 Configured'
  severity: medium
  rule_id: aws.redshift.securitygroup.security_no_0_configured
  for_each:
    discovery: aws.redshift.securitygroups
    as: securitygroup
    item: securitygroup
  conditions:
    var: securitygroup.compliant
    op: equals
    value: true
- title: 'REDSHIFT cluster: Enhanced Vpc Routing Configured'
  severity: high
  rule_id: aws.redshift.cluster.enhanced_vpc_routing_configured
  for_each:
    discovery: aws.redshift.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.in_vpc
    op: equals
    value: true
- title: 'REDSHIFT cluster: Automated Snapshot Configured'
  severity: medium
  rule_id: aws.redshift.cluster.automated_snapshot_configured
  for_each:
    discovery: aws.redshift.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.versioning_enabled
    op: equals
    value: true
- title: 'REDSHIFT subnetgroup: Redshift Private Subnets Only Configured'
  severity: high
  rule_id: aws.redshift.subnetgroup.redshift_private_subnets_only_configured
  for_each:
    discovery: aws.redshift.subnetgroups
    as: subnetgroup
    item: subnetgroup
  conditions:
    var: subnetgroup.in_vpc
    op: equals
    value: true
- title: 'REDSHIFT cluster: Deletion Protection Enabled'
  severity: medium
  rule_id: aws.redshift.cluster.deletion_protection_enabled
  for_each:
    discovery: aws.redshift.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.compliant
    op: equals
    value: true
- title: 'REDSHIFT cluster: Multi Az Enabled'
  severity: medium
  rule_id: aws.redshift.cluster.multi_az_enabled
  for_each:
    discovery: aws.redshift.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.compliant
    op: equals
    value: true
- title: 'REDSHIFT cluster: Minor Version Auto Upgrade Enabled'
  severity: low
  rule_id: aws.redshift.cluster.minor_version_auto_upgrade_enabled
  for_each:
    discovery: aws.redshift.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.versioning_enabled
    op: equals
    value: true
- title: 'REDSHIFT endpoint authorization: Rbac Least Privilege'
  severity: high
  rule_id: aws.redshift.endpoint_authorization.rbac_least_privilege
  for_each:
    discovery: aws.redshift.endpoint_authorizations
    as: endpoint_authorization
    item: endpoint_authorization
  conditions:
    var: endpoint_authorization.is_public
    op: equals
    value: false
- title: 'REDSHIFT cluster: Private Networking Enforced'
  severity: high
  rule_id: aws.redshift.cluster.private_networking_enforced
  for_each:
    discovery: aws.redshift.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.is_public
    op: equals
    value: false
- title: 'REDSHIFT hsm client certificate: Certificate Trusted Issuer Verified'
  severity: medium
  rule_id: aws.redshift.hsm_client_certificate.certificate_trusted_issuer_verified
  for_each:
    discovery: aws.redshift.hsm_client_certificates
    as: hsm_client_certificate
    item: hsm_client_certificate
  conditions:
    var: hsm_client_certificate.compliant
    op: equals
    value: true
- title: 'REDSHIFT cluster: Tls Min 1 2 Enforced'
  severity: high
  rule_id: aws.redshift.cluster.tls_min_1_2_enforced
  for_each:
    discovery: aws.redshift.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.in_vpc
    op: equals
    value: true
- title: 'REDSHIFT securitygroup: Security Egress Restricted'
  severity: medium
  rule_id: aws.redshift.securitygroup.security_egress_restricted
  for_each:
    discovery: aws.redshift.securitygroups
    as: securitygroup
    item: securitygroup
  conditions:
    var: securitygroup.compliant
    op: equals
    value: true
- title: 'REDSHIFT securitygroup: Security No 0 Ingress Configured'
  severity: medium
  rule_id: aws.redshift.securitygroup.security_no_0_ingress_configured
  for_each:
    discovery: aws.redshift.securitygroups
    as: securitygroup
    item: securitygroup
  conditions:
    var: securitygroup.compliant
    op: equals
    value: true
- title: 'REDSHIFT securitygroup: Security No 0 Ingress On Db Ports Configured'
  severity: medium
  rule_id: aws.redshift.securitygroup.security_no_0_ingress_on_db_ports_configured
  for_each:
    discovery: aws.redshift.securitygroups
    as: securitygroup
    item: securitygroup
  conditions:
    var: securitygroup.compliant
    op: equals
    value: true
- title: 'REDSHIFT cluster: Public Access Configured'
  severity: high
  rule_id: aws.redshift.cluster.public_access_configured
  for_each:
    discovery: aws.redshift.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.is_public
    op: equals
    value: false
- title: 'REDSHIFT user: Iam Auth Preferred Configured'
  severity: high
  rule_id: aws.redshift.user.iam_auth_preferred_configured
  for_each:
    discovery: aws.redshift.users
    as: user
    item: user
  conditions:
    var: user.is_public
    op: equals
    value: false
- title: 'REDSHIFT cluster: Encryption At Rest Cmek Configured'
  severity: high
  rule_id: aws.redshift.cluster.encryption_at_rest_cmek_configured
  for_each:
    discovery: aws.redshift.cluster_encryption
    as: cluster
    item: cluster
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'REDSHIFT cluster: Maintenance Settings Configured'
  severity: medium
  rule_id: aws.redshift.cluster.maintenance_settings_configured
  for_each:
    discovery: aws.redshift.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.compliant
    op: equals
    value: true
- title: 'REDSHIFT snapshot: Encryption At Rest Enabled'
  severity: high
  rule_id: aws.redshift.snapshot.encryption_at_rest_enabled
  for_each:
    discovery: aws.redshift.snapshot_encryption
    as: snapshot
    item: snapshot
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'REDSHIFT snapshot: Redshift Cross Account Sharing Restricted'
  severity: medium
  rule_id: aws.redshift.snapshot.redshift_cross_account_sharing_restricted
  for_each:
    discovery: aws.redshift.snapshots
    as: snapshot
    item: snapshot
  conditions:
    var: snapshot.versioning_enabled
    op: equals
    value: true
- title: 'REDSHIFT snapshot: Not Publicly Shared Configured'
  severity: high
  rule_id: aws.redshift.snapshot.not_publicly_shared_configured
  for_each:
    discovery: aws.redshift.snapshots
    as: snapshot
    item: snapshot
  conditions:
    var: snapshot.is_public
    op: equals
    value: false
- title: 'REDSHIFT event subscription: Redshift Destination Least Privilege'
  severity: high
  rule_id: aws.redshift.event_subscription.redshift_destination_least_privilege
  for_each:
    discovery: aws.redshift.event_subscriptions
    as: event_subscription
    item: event_subscription
  conditions:
    var: event_subscription.is_public
    op: equals
    value: false
- title: 'REDSHIFT parametergroup: Tls Required'
  severity: high
  rule_id: aws.redshift.parametergroup.tls_required
  for_each:
    discovery: aws.redshift.parametergroups
    as: parametergroup
    item: parametergroup
  conditions:
    var: parametergroup.in_vpc
    op: equals
    value: true
- title: 'REDSHIFT parametergroup: Redshift Insecure Features Disabled If Applicable
    Configured'
  severity: medium
  rule_id: aws.redshift.parametergroup.redshift_insecure_features_disabled_if_applicable_configured
  for_each:
    discovery: aws.redshift.parametergroups
    as: parametergroup
    item: parametergroup
  conditions:
    var: parametergroup.compliant
    op: equals
    value: true
- title: 'REDSHIFT cluster: Audit Logging Configured'
  severity: medium
  rule_id: aws.redshift.cluster.audit_logging_configured
  for_each:
    discovery: aws.redshift.cluster_logging
    as: cluster
    item: cluster
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'REDSHIFT cluster: Encryption At Rest Enabled'
  severity: high
  rule_id: aws.redshift.cluster.encryption_at_rest_enabled
  for_each:
    discovery: aws.redshift.cluster_encryption
    as: cluster
    item: cluster
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'REDSHIFT user: Redshift No Unused Or Default Supers Configured'
  severity: medium
  rule_id: aws.redshift.user.redshift_no_unused_or_default_supers_configured
  for_each:
    discovery: aws.redshift.users
    as: user
    item: user
  conditions:
    var: user.compliant
    op: equals
    value: true
- title: 'REDSHIFT snapshot: Redshift Cross Region Copy Encrypted'
  severity: high
  rule_id: aws.redshift.snapshot.redshift_cross_region_copy_encrypted
  for_each:
    discovery: aws.redshift.snapshot_encryption
    as: snapshot
    item: snapshot
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'REDSHIFT parametergroup: Logging Enabled'
  severity: medium
  rule_id: aws.redshift.parametergroup.logging_enabled
  for_each:
    discovery: aws.redshift.parametergroup_logging
    as: parametergroup
    item: parametergroup
  conditions:
    var: logging.logging_enabled
    op: equals
    value: true
- title: 'REDSHIFT endpointaccess: Access Private Only Configured'
  severity: high
  rule_id: aws.redshift.endpointaccess.access_private_only_configured
  for_each:
    discovery: aws.redshift.endpointaccesss
    as: endpointaccess
    item: endpointaccess
  conditions:
    var: endpointaccess.is_public
    op: equals
    value: false
- title: 'REDSHIFT securitygroup: Security Only Required Ports'
  severity: medium
  rule_id: aws.redshift.securitygroup.security_only_required_ports
  for_each:
    discovery: aws.redshift.securitygroups
    as: securitygroup
    item: securitygroup
  conditions:
    var: securitygroup.compliant
    op: equals
    value: true
- title: 'REDSHIFT snapshot: Kms Key Policy Least Privilege'
  severity: high
  rule_id: aws.redshift.snapshot.kms_key_policy_least_privilege
  for_each:
    discovery: aws.redshift.snapshot_encryption
    as: snapshot
    item: snapshot
  conditions:
    var: encryption.encryption_enabled
    op: equals
    value: true
- title: 'REDSHIFT cluster: Automatic Upgrades Configured'
  severity: medium
  rule_id: aws.redshift.cluster.automatic_upgrades_configured
  for_each:
    discovery: aws.redshift.clusters
    as: cluster
    item: cluster
  conditions:
    var: cluster.compliant
    op: equals
    value: true
- title: 'REDSHIFT hsm client certificate: Certificate Valid'
  severity: medium
  rule_id: aws.redshift.hsm_client_certificate.certificate_valid
  for_each:
    discovery: aws.redshift.hsm_client_certificates
    as: hsm_client_certificate
    item: hsm_client_certificate
  conditions:
    var: hsm_client_certificate.compliant
    op: equals
    value: true
