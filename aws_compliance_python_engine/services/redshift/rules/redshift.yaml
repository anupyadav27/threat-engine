version: '1.0'
provider: aws
service: redshift
services:
  client: redshift
  module: boto3.client
discovery:
- discovery_id: aws.redshift.describe_authentication_profiles
  calls:
  - action: describe_authentication_profiles
    save_as: response
  emit:
    item:
      AuthenticationProfileName: '{{ response.AuthenticationProfiles.AuthenticationProfileName
        }}'
      AuthenticationProfileContent: '{{ response.AuthenticationProfiles.AuthenticationProfileContent
        }}'
- discovery_id: aws.redshift.describe_cluster_parameter_groups
  calls:
  - action: describe_cluster_parameter_groups
    save_as: response
  emit:
    item:
      ParameterGroupName: '{{ response.ParameterGroups.ParameterGroupName }}'
      ParameterGroupFamily: '{{ response.ParameterGroups.ParameterGroupFamily }}'
      Description: '{{ response.ParameterGroups.Description }}'
      Tags: '{{ response.ParameterGroups.Tags }}'
- discovery_id: aws.redshift.describe_cluster_security_groups
  calls:
  - action: describe_cluster_security_groups
    save_as: response
  emit:
    item:
      ClusterSecurityGroupName: '{{ response.ClusterSecurityGroups.ClusterSecurityGroupName
        }}'
      Description: '{{ response.ClusterSecurityGroups.Description }}'
      EC2SecurityGroups: '{{ response.ClusterSecurityGroups.EC2SecurityGroups }}'
      IPRanges: '{{ response.ClusterSecurityGroups.IPRanges }}'
      Tags: '{{ response.ClusterSecurityGroups.Tags }}'
- discovery_id: aws.redshift.describe_cluster_snapshots
  calls:
  - action: describe_cluster_snapshots
    save_as: response
  emit:
    item:
      SnapshotIdentifier: '{{ response.Snapshots.SnapshotIdentifier }}'
      ClusterIdentifier: '{{ response.Snapshots.ClusterIdentifier }}'
      SnapshotCreateTime: '{{ response.Snapshots.SnapshotCreateTime }}'
      Status: '{{ response.Snapshots.Status }}'
      Port: '{{ response.Snapshots.Port }}'
      AvailabilityZone: '{{ response.Snapshots.AvailabilityZone }}'
      ClusterCreateTime: '{{ response.Snapshots.ClusterCreateTime }}'
      MasterUsername: '{{ response.Snapshots.MasterUsername }}'
      ClusterVersion: '{{ response.Snapshots.ClusterVersion }}'
      EngineFullVersion: '{{ response.Snapshots.EngineFullVersion }}'
      SnapshotType: '{{ response.Snapshots.SnapshotType }}'
      NodeType: '{{ response.Snapshots.NodeType }}'
      NumberOfNodes: '{{ response.Snapshots.NumberOfNodes }}'
      DBName: '{{ response.Snapshots.DBName }}'
      VpcId: '{{ response.Snapshots.VpcId }}'
      Encrypted: '{{ response.Snapshots.Encrypted }}'
      KmsKeyId: '{{ response.Snapshots.KmsKeyId }}'
      EncryptedWithHSM: '{{ response.Snapshots.EncryptedWithHSM }}'
      AccountsWithRestoreAccess: '{{ response.Snapshots.AccountsWithRestoreAccess
        }}'
      OwnerAccount: '{{ response.Snapshots.OwnerAccount }}'
      TotalBackupSizeInMegaBytes: '{{ response.Snapshots.TotalBackupSizeInMegaBytes
        }}'
      ActualIncrementalBackupSizeInMegaBytes: '{{ response.Snapshots.ActualIncrementalBackupSizeInMegaBytes
        }}'
      BackupProgressInMegaBytes: '{{ response.Snapshots.BackupProgressInMegaBytes
        }}'
      CurrentBackupRateInMegaBytesPerSecond: '{{ response.Snapshots.CurrentBackupRateInMegaBytesPerSecond
        }}'
      EstimatedSecondsToCompletion: '{{ response.Snapshots.EstimatedSecondsToCompletion
        }}'
      ElapsedTimeInSeconds: '{{ response.Snapshots.ElapsedTimeInSeconds }}'
      SourceRegion: '{{ response.Snapshots.SourceRegion }}'
      Tags: '{{ response.Snapshots.Tags }}'
      RestorableNodeTypes: '{{ response.Snapshots.RestorableNodeTypes }}'
      EnhancedVpcRouting: '{{ response.Snapshots.EnhancedVpcRouting }}'
      MaintenanceTrackName: '{{ response.Snapshots.MaintenanceTrackName }}'
      ManualSnapshotRetentionPeriod: '{{ response.Snapshots.ManualSnapshotRetentionPeriod
        }}'
      ManualSnapshotRemainingDays: '{{ response.Snapshots.ManualSnapshotRemainingDays
        }}'
      SnapshotRetentionStartTime: '{{ response.Snapshots.SnapshotRetentionStartTime
        }}'
      MasterPasswordSecretArn: '{{ response.Snapshots.MasterPasswordSecretArn }}'
      MasterPasswordSecretKmsKeyId: '{{ response.Snapshots.MasterPasswordSecretKmsKeyId
        }}'
      SnapshotArn: '{{ response.Snapshots.SnapshotArn }}'
- discovery_id: aws.redshift.describe_clusters
  calls:
  - action: describe_clusters
    save_as: response
  emit:
    item:
      ClusterIdentifier: '{{ response.Clusters.ClusterIdentifier }}'
      NodeType: '{{ response.Clusters.NodeType }}'
      ClusterStatus: '{{ response.Clusters.ClusterStatus }}'
      ClusterAvailabilityStatus: '{{ response.Clusters.ClusterAvailabilityStatus }}'
      ModifyStatus: '{{ response.Clusters.ModifyStatus }}'
      MasterUsername: '{{ response.Clusters.MasterUsername }}'
      DBName: '{{ response.Clusters.DBName }}'
      Endpoint: '{{ response.Clusters.Endpoint }}'
      ClusterCreateTime: '{{ response.Clusters.ClusterCreateTime }}'
      AutomatedSnapshotRetentionPeriod: '{{ response.Clusters.AutomatedSnapshotRetentionPeriod
        }}'
      ManualSnapshotRetentionPeriod: '{{ response.Clusters.ManualSnapshotRetentionPeriod
        }}'
      ClusterSecurityGroups: '{{ response.Clusters.ClusterSecurityGroups }}'
      VpcSecurityGroups: '{{ response.Clusters.VpcSecurityGroups }}'
      ClusterParameterGroups: '{{ response.Clusters.ClusterParameterGroups }}'
      ClusterSubnetGroupName: '{{ response.Clusters.ClusterSubnetGroupName }}'
      VpcId: '{{ response.Clusters.VpcId }}'
      AvailabilityZone: '{{ response.Clusters.AvailabilityZone }}'
      PreferredMaintenanceWindow: '{{ response.Clusters.PreferredMaintenanceWindow
        }}'
      PendingModifiedValues: '{{ response.Clusters.PendingModifiedValues }}'
      ClusterVersion: '{{ response.Clusters.ClusterVersion }}'
      AllowVersionUpgrade: '{{ response.Clusters.AllowVersionUpgrade }}'
      NumberOfNodes: '{{ response.Clusters.NumberOfNodes }}'
      PubliclyAccessible: '{{ response.Clusters.PubliclyAccessible }}'
      Encrypted: '{{ response.Clusters.Encrypted }}'
      RestoreStatus: '{{ response.Clusters.RestoreStatus }}'
      DataTransferProgress: '{{ response.Clusters.DataTransferProgress }}'
      HsmStatus: '{{ response.Clusters.HsmStatus }}'
      ClusterSnapshotCopyStatus: '{{ response.Clusters.ClusterSnapshotCopyStatus }}'
      ClusterPublicKey: '{{ response.Clusters.ClusterPublicKey }}'
      ClusterNodes: '{{ response.Clusters.ClusterNodes }}'
      ElasticIpStatus: '{{ response.Clusters.ElasticIpStatus }}'
      ClusterRevisionNumber: '{{ response.Clusters.ClusterRevisionNumber }}'
      Tags: '{{ response.Clusters.Tags }}'
      KmsKeyId: '{{ response.Clusters.KmsKeyId }}'
      EnhancedVpcRouting: '{{ response.Clusters.EnhancedVpcRouting }}'
      IamRoles: '{{ response.Clusters.IamRoles }}'
      PendingActions: '{{ response.Clusters.PendingActions }}'
      MaintenanceTrackName: '{{ response.Clusters.MaintenanceTrackName }}'
      ElasticResizeNumberOfNodeOptions: '{{ response.Clusters.ElasticResizeNumberOfNodeOptions
        }}'
      DeferredMaintenanceWindows: '{{ response.Clusters.DeferredMaintenanceWindows
        }}'
      SnapshotScheduleIdentifier: '{{ response.Clusters.SnapshotScheduleIdentifier
        }}'
      SnapshotScheduleState: '{{ response.Clusters.SnapshotScheduleState }}'
      ExpectedNextSnapshotScheduleTime: '{{ response.Clusters.ExpectedNextSnapshotScheduleTime
        }}'
      ExpectedNextSnapshotScheduleTimeStatus: '{{ response.Clusters.ExpectedNextSnapshotScheduleTimeStatus
        }}'
      NextMaintenanceWindowStartTime: '{{ response.Clusters.NextMaintenanceWindowStartTime
        }}'
      ResizeInfo: '{{ response.Clusters.ResizeInfo }}'
      AvailabilityZoneRelocationStatus: '{{ response.Clusters.AvailabilityZoneRelocationStatus
        }}'
      ClusterNamespaceArn: '{{ response.Clusters.ClusterNamespaceArn }}'
      TotalStorageCapacityInMegaBytes: '{{ response.Clusters.TotalStorageCapacityInMegaBytes
        }}'
      AquaConfiguration: '{{ response.Clusters.AquaConfiguration }}'
      DefaultIamRoleArn: '{{ response.Clusters.DefaultIamRoleArn }}'
      ReservedNodeExchangeStatus: '{{ response.Clusters.ReservedNodeExchangeStatus
        }}'
      CustomDomainName: '{{ response.Clusters.CustomDomainName }}'
      CustomDomainCertificateArn: '{{ response.Clusters.CustomDomainCertificateArn
        }}'
      CustomDomainCertificateExpiryDate: '{{ response.Clusters.CustomDomainCertificateExpiryDate
        }}'
      MasterPasswordSecretArn: '{{ response.Clusters.MasterPasswordSecretArn }}'
      MasterPasswordSecretKmsKeyId: '{{ response.Clusters.MasterPasswordSecretKmsKeyId
        }}'
      IpAddressType: '{{ response.Clusters.IpAddressType }}'
      MultiAZ: '{{ response.Clusters.MultiAZ }}'
      MultiAZSecondary: '{{ response.Clusters.MultiAZSecondary }}'
      LakehouseRegistrationStatus: '{{ response.Clusters.LakehouseRegistrationStatus
        }}'
      CatalogArn: '{{ response.Clusters.CatalogArn }}'
- discovery_id: aws.redshift.describe_data_shares
  calls:
  - action: describe_data_shares
    save_as: response
  emit:
    item:
      DataShareArn: '{{ response.DataShares.DataShareArn }}'
      ProducerArn: '{{ response.DataShares.ProducerArn }}'
      AllowPubliclyAccessibleConsumers: '{{ response.DataShares.AllowPubliclyAccessibleConsumers
        }}'
      DataShareAssociations: '{{ response.DataShares.DataShareAssociations }}'
      ManagedBy: '{{ response.DataShares.ManagedBy }}'
      DataShareType: '{{ response.DataShares.DataShareType }}'
- discovery_id: aws.redshift.describe_endpoint_access
  calls:
  - action: describe_endpoint_access
    save_as: response
  emit:
    item:
      ClusterIdentifier: '{{ response.EndpointAccessList.ClusterIdentifier }}'
      ResourceOwner: '{{ response.EndpointAccessList.ResourceOwner }}'
      SubnetGroupName: '{{ response.EndpointAccessList.SubnetGroupName }}'
      EndpointStatus: '{{ response.EndpointAccessList.EndpointStatus }}'
      EndpointName: '{{ response.EndpointAccessList.EndpointName }}'
      EndpointCreateTime: '{{ response.EndpointAccessList.EndpointCreateTime }}'
      Port: '{{ response.EndpointAccessList.Port }}'
      Address: '{{ response.EndpointAccessList.Address }}'
      VpcSecurityGroups: '{{ response.EndpointAccessList.VpcSecurityGroups }}'
      VpcEndpoint: '{{ response.EndpointAccessList.VpcEndpoint }}'
- discovery_id: aws.redshift.describe_endpoint_authorization
  calls:
  - action: describe_endpoint_authorization
    save_as: response
  emit:
    item:
      Grantor: '{{ response.EndpointAuthorizationList.Grantor }}'
      Grantee: '{{ response.EndpointAuthorizationList.Grantee }}'
      ClusterIdentifier: '{{ response.EndpointAuthorizationList.ClusterIdentifier
        }}'
      AuthorizeTime: '{{ response.EndpointAuthorizationList.AuthorizeTime }}'
      ClusterStatus: '{{ response.EndpointAuthorizationList.ClusterStatus }}'
      Status: '{{ response.EndpointAuthorizationList.Status }}'
      AllowedAllVPCs: '{{ response.EndpointAuthorizationList.AllowedAllVPCs }}'
      AllowedVPCs: '{{ response.EndpointAuthorizationList.AllowedVPCs }}'
      EndpointCount: '{{ response.EndpointAuthorizationList.EndpointCount }}'
- discovery_id: aws.redshift.describe_event_subscriptions
  calls:
  - action: describe_event_subscriptions
    save_as: response
  emit:
    item:
      CustomerAwsId: '{{ response.EventSubscriptionsList.CustomerAwsId }}'
      CustSubscriptionId: '{{ response.EventSubscriptionsList.CustSubscriptionId }}'
      SnsTopicArn: '{{ response.EventSubscriptionsList.SnsTopicArn }}'
      Status: '{{ response.EventSubscriptionsList.Status }}'
      SubscriptionCreationTime: '{{ response.EventSubscriptionsList.SubscriptionCreationTime
        }}'
      SourceType: '{{ response.EventSubscriptionsList.SourceType }}'
      SourceIdsList: '{{ response.EventSubscriptionsList.SourceIdsList }}'
      EventCategoriesList: '{{ response.EventSubscriptionsList.EventCategoriesList
        }}'
      Severity: '{{ response.EventSubscriptionsList.Severity }}'
      Enabled: '{{ response.EventSubscriptionsList.Enabled }}'
      Tags: '{{ response.EventSubscriptionsList.Tags }}'
- discovery_id: aws.redshift.describe_hsm_client_certificates
  calls:
  - action: describe_hsm_client_certificates
    save_as: response
  emit:
    item:
      HsmClientCertificateIdentifier: '{{ response.HsmClientCertificates.HsmClientCertificateIdentifier
        }}'
      HsmClientCertificatePublicKey: '{{ response.HsmClientCertificates.HsmClientCertificatePublicKey
        }}'
      Tags: '{{ response.HsmClientCertificates.Tags }}'
- discovery_id: aws.redshift.describe_hsm_configurations
  calls:
  - action: describe_hsm_configurations
    save_as: response
  emit:
    item:
      HsmConfigurationIdentifier: '{{ response.HsmConfigurations.HsmConfigurationIdentifier
        }}'
      Description: '{{ response.HsmConfigurations.Description }}'
      HsmIpAddress: '{{ response.HsmConfigurations.HsmIpAddress }}'
      HsmPartitionName: '{{ response.HsmConfigurations.HsmPartitionName }}'
      Tags: '{{ response.HsmConfigurations.Tags }}'
checks:
- rule_id: aws.redshift.hsm_configuration.redshift_configuration_present
  for_each: aws.redshift.describe_hsm_configurations
  conditions:
    var: item.HsmConfigurationIdentifier
    op: exists
- rule_id: aws.redshift.hsm_configuration.keys_in_hsm_only_configured
  for_each: aws.redshift.describe_hsm_configurations
  conditions:
    var: item.HsmConfigurationIdentifier
    op: exists
- rule_id: aws.redshift.securitygroup.security_only_required_ports_open_restricted
  for_each: aws.redshift.describe_cluster_security_groups
  conditions:
    var: item.IPRanges
    op: equals
    value: []
- rule_id: aws.redshift.endpointaccess.tls_required
  for_each: aws.redshift.describe_endpoint_access
  conditions:
    var: item.EndpointStatus
    op: equals
    value: ACTIVE
- rule_id: aws.redshift.endpointaccess.access_allowed_cidrs_minimized_configured
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.VpcSecurityGroups
    op: equals
    value: []
- rule_id: aws.redshift.event_subscription.redshift_destination_encrypted
  for_each: aws.redshift.describe_event_subscriptions
  conditions:
    var: item.Enabled
    op: equals
    value: true
- rule_id: aws.redshift.hsm_client_certificate.key_length_minimum
  for_each: aws.redshift.describe_hsm_client_certificates
  conditions:
    var: item.HsmClientCertificatePublicKey
    op: contains
    value: '2048'
- rule_id: aws.redshift.hsm_configuration.only_approved_hsm_endpoints_configured
  for_each: aws.redshift.describe_hsm_configurations
  conditions:
    var: item.HsmIpAddress
    op: contains
    value:
    - approved_endpoint_1
    - approved_endpoint_2
- rule_id: aws.redshift.endpoint_authorization.no_anonymous_access_configured
  for_each: aws.redshift.describe_endpoint_authorization
  conditions:
    var: item.AllowedAllVPCs
    op: equals
    value: false
- rule_id: aws.redshift.user.redshift_approved_list_of_supers_only_configured
  for_each: aws.redshift.describe_cluster_snapshots
  conditions:
    var: item.MasterUsername
    op: contains
    value:
    - approved_superuser1
    - approved_superuser2
- rule_id: aws.redshift.cluster.in_transit_encryption_enabled
  for_each: aws.redshift.describe_cluster_snapshots
  conditions:
    var: item.ClusterVersion
    op: gte
    value: '1.2'
- rule_id: aws.redshift.resource.backup_enabled
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.AutomatedSnapshotRetentionPeriod
    op: gt
    value: 0
- rule_id: aws.redshift.securitygroup.security_no_0_configured
  for_each: aws.redshift.describe_cluster_security_groups
  conditions:
    var: item.IPRanges
    op: equals
    value: []
- rule_id: aws.redshift.cluster.enhanced_vpc_routing_configured
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.ClusterStatus
    op: equals
    value: ENABLED
- rule_id: aws.redshift.cluster.automated_snapshot_configured
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.AutomatedSnapshotRetentionPeriod
    op: gt
    value: 0
- rule_id: aws.redshift.cluster.deletion_protection_enabled
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.ClusterStatus
    op: equals
    value: ENABLED
- rule_id: aws.redshift.cluster.multi_az_enabled
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.ClusterAvailabilityStatus
    op: equals
    value: ENABLED
- rule_id: aws.redshift.cluster.minor_version_auto_upgrade_enabled
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.ClusterStatus
    op: equals
    value: ENABLED
- rule_id: aws.redshift.hsm_client_certificate.certificate_trusted_issuer_verified
  for_each: aws.redshift.describe_hsm_client_certificates
  conditions:
    var: item.HsmClientCertificateIdentifier
    op: exists
- rule_id: aws.redshift.cluster.tls_min_1_2_enforced
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.ClusterParameterGroups
    op: exists
    value: null
- rule_id: aws.redshift.securitygroup.security_egress_restricted
  for_each: aws.redshift.describe_cluster_security_groups
  conditions:
    var: item.IPRanges
    op: equals
    value: []
- rule_id: aws.redshift.securitygroup.security_no_0_ingress_configured
  for_each: aws.redshift.describe_cluster_security_groups
  conditions:
    var: item.IPRanges
    op: equals
    value: []
- rule_id: aws.redshift.securitygroup.security_no_0_ingress_on_db_ports_configured
  for_each: aws.redshift.describe_cluster_security_groups
  conditions:
    var: item.IPRanges
    op: equals
    value: []
- rule_id: aws.redshift.cluster.public_access_configured
  for_each: aws.redshift.describe_data_shares
  conditions:
    var: item.AllowPubliclyAccessibleConsumers
    op: equals
    value: false
- rule_id: aws.redshift.user.iam_auth_preferred_configured
  for_each: aws.redshift.describe_authentication_profiles
  conditions:
    var: item.AuthenticationProfileName
    op: exists
- rule_id: aws.redshift.cluster.encryption_at_rest_cmek_configured
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.ClusterStatus
    op: equals
    value: ENABLED
- rule_id: aws.redshift.snapshot.encryption_at_rest_enabled
  for_each: aws.redshift.describe_cluster_snapshots
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.redshift.snapshot.redshift_cross_account_sharing_restricted
  for_each: aws.redshift.describe_data_shares
  conditions:
    var: item.AllowPubliclyAccessibleConsumers
    op: equals
    value: false
- rule_id: aws.redshift.snapshot.not_publicly_shared_configured
  for_each: aws.redshift.describe_data_shares
  conditions:
    var: item.AllowPubliclyAccessibleConsumers
    op: equals
    value: false
- rule_id: aws.redshift.parametergroup.redshift_insecure_features_disabled_if_applicable_configured
  for_each: aws.redshift.describe_cluster_parameter_groups
  conditions:
    var: item.ParameterGroupName
    op: exists
- rule_id: aws.redshift.cluster.audit_logging_configured
  for_each: aws.redshift.describe_event_subscriptions
  conditions:
    var: item.Enabled
    op: equals
    value: true
- rule_id: aws.redshift.cluster.encryption_at_rest_enabled
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.ClusterStatus
    op: equals
    value: ENABLED
- rule_id: aws.redshift.snapshot.redshift_cross_region_copy_encrypted
  for_each: aws.redshift.describe_cluster_snapshots
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.redshift.endpointaccess.access_private_only_configured
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.VpcSecurityGroups
    op: equals
    value: []
- rule_id: aws.redshift.securitygroup.security_only_required_ports
  for_each: aws.redshift.describe_cluster_security_groups
  conditions:
    var: item.IPRanges
    op: equals
    value: []
- rule_id: aws.redshift.snapshot.kms_key_policy_least_privilege
  for_each: aws.redshift.describe_cluster_snapshots
  conditions:
    var: item.KmsKeyId
    op: exists
- rule_id: aws.redshift.cluster.automatic_upgrades_configured
  for_each: aws.redshift.describe_clusters
  conditions:
    var: item.ClusterStatus
    op: equals
    value: AVAILABLE
- rule_id: aws.redshift.hsm_client_certificate.certificate_valid
  for_each: aws.redshift.describe_hsm_client_certificates
  conditions:
    var: item.HsmClientCertificateIdentifier
    op: exists
