version: '1.0'
provider: aws
service: kafka
services:
  client: kafka
  module: boto3.client
discovery:
- discovery_id: aws.kafka.list_clusters
  calls:
  - action: list_clusters
    save_as: response
  emit:
    items_for: '{{ response.ClusterInfoList }}'
    as: resource
    item:
      ActiveOperationArn: '{{ resource.ActiveOperationArn }}'
      BrokerNodeGroupInfo: '{{ resource.BrokerNodeGroupInfo }}'
      Rebalancing: '{{ resource.Rebalancing }}'
      ClientAuthentication: '{{ resource.ClientAuthentication }}'
      ClusterArn: '{{ resource.ClusterArn }}'
      ClusterName: '{{ resource.ClusterName }}'
      CreationTime: '{{ resource.CreationTime }}'
      CurrentBrokerSoftwareInfo: '{{ resource.CurrentBrokerSoftwareInfo }}'
      CurrentVersion: '{{ resource.CurrentVersion }}'
      EncryptionInfo: '{{ resource.EncryptionInfo }}'
      EnhancedMonitoring: '{{ resource.EnhancedMonitoring }}'
      OpenMonitoring: '{{ resource.OpenMonitoring }}'
      LoggingInfo: '{{ resource.LoggingInfo }}'
      NumberOfBrokerNodes: '{{ resource.NumberOfBrokerNodes }}'
      State: '{{ resource.State }}'
      StateInfo: '{{ resource.StateInfo }}'
      Tags: '{{ resource.Tags }}'
      ZookeeperConnectString: '{{ resource.ZookeeperConnectString }}'
      ZookeeperConnectStringTls: '{{ resource.ZookeeperConnectStringTls }}'
      StorageMode: '{{ resource.StorageMode }}'
      CustomerActionStatus: '{{ resource.CustomerActionStatus }}'
checks:
- rule_id: aws.kafka.resource.connector_in_transit_encryption_enabled
  for_each: aws.kafka.list_clusters
  conditions:
    var: item.EncryptionInfo
    op: not_equals
    value: 'null'
- rule_id: aws.kafka.cluster.in_transit_encryption_enabled
  for_each: aws.kafka.list_clusters
  conditions:
    var: item.EncryptionInfo
    op: not_equals
    value: 'null'
- rule_id: aws.kafka.cluster.encryption_at_rest_uses_cmk_configured
  for_each: aws.kafka.list_clusters
  conditions:
    var: item.EncryptionInfo
    op: not_equals
    value: 'null'
