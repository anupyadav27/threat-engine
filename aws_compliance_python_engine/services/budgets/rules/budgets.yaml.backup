version: '1.0'
provider: aws
service: budgets
discovery:
- discovery_id: aws.budgets.delete_budget_action
  calls:
  - action: delete_budget_action
    save_as: delete_budget_action_response
    params:
      AccountId: '{{ item.FIELD_NAME }}'
      BudgetName: '{{ item.FIELD_NAME }}'
      ActionId: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.budgets.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      action_id: '{{ delete_budget_action_response.Action.ActionId }}'
      budget_name: '{{ delete_budget_action_response.Action.BudgetName }}'
      notification_type: '{{ delete_budget_action_response.Action.NotificationType
        }}'
      action_type: '{{ delete_budget_action_response.Action.ActionType }}'
      action_threshold: '{{ delete_budget_action_response.Action.ActionThreshold }}'
- discovery_id: aws.budgets.describe_notifications_for_budget
  calls:
  - action: describe_notifications_for_budget
    save_as: describe_notifications_for_budget_response
    params:
      AccountId: '{{ item.FIELD_NAME }}'
      BudgetName: '{{ item.FIELD_NAME }}'
    on_error: continue
  for_each: aws.budgets.PARENT_DISCOVERY
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      notification_type: '{{ describe_notifications_for_budget_response.Notifications.NotificationType
        }}'
      comparison_operator: '{{ describe_notifications_for_budget_response.Notifications.ComparisonOperator
        }}'
      threshold: '{{ describe_notifications_for_budget_response.Notifications.Threshold
        }}'
      threshold_type: '{{ describe_notifications_for_budget_response.Notifications.ThresholdType
        }}'
      notification_state: '{{ describe_notifications_for_budget_response.Notifications.NotificationState
        }}'
checks:
- rule_id: aws.budgets.budget.budgets_s_defined_for_accounts_or_projects_configured
  for_each: aws.budgets.delete_budget_action
  conditions:
    all:
    - var: item.status
      op: equals
      value: ACTIVE
    - var: item.budget_name
      op: exists
- rule_id: aws.budgets.budget.alert_destinations_configured
  for_each: aws.budgets.delete_budget_action
  conditions:
    var: item.subscribers
    op: exists
- rule_id: aws.budgets.budget.alert_thresholds_configured
  for_each: aws.budgets.describe_notifications_for_budget
  conditions:
    all:
    - var: item.threshold
      op: exists
    - var: item.comparison_operator
      op: exists
- rule_id: aws.budgets.budget.modify_permissions_restricted
  for_each: aws.budgets.delete_budget_action
  conditions:
    all:
    - var: item.status
      op: equals
      value: ACTIVE
    - var: item.execution_role_arn
      op: exists
