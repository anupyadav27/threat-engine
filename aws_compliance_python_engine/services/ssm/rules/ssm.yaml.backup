version: '1.0'
provider: aws
service: ssm
discovery:
- discovery_id: aws.ssm.describe_patch_baselines
  calls:
  - action: describe_patch_baselines
    save_as: describe_patch_baselines_response
  emit:
    items_for: '{{ describe_patch_baselines_response.BaselineIdentities }}'
    as: resource
    item:
      baseline_id: '{{ resource.BaselineId }}'
      baseline_name: '{{ resource.BaselineName }}'
      operating_system: '{{ resource.OperatingSystem }}'
      baseline_description: '{{ resource.BaselineDescription }}'
      default_baseline: '{{ resource.DefaultBaseline }}'
- discovery_id: aws.ssm.describe_maintenance_windows
  calls:
  - action: describe_maintenance_windows
    save_as: describe_maintenance_windows_response
  emit:
    items_for: '{{ describe_maintenance_windows_response.WindowIdentities }}'
    as: resource
    item:
      window_id: '{{ resource.WindowId }}'
      name: '{{ resource.Name }}'
      description: '{{ resource.Description }}'
      enabled: '{{ resource.Enabled }}'
      duration: '{{ resource.Duration }}'
      cutoff: '{{ resource.Cutoff }}'
      schedule: '{{ resource.Schedule }}'
      schedule_timezone: '{{ resource.ScheduleTimezone }}'
      schedule_offset: '{{ resource.ScheduleOffset }}'
      end_date: '{{ resource.EndDate }}'
- discovery_id: aws.ssm.describe_patch_groups
  calls:
  - action: describe_patch_groups
    save_as: describe_patch_groups_response
  emit:
    items_for: '{{ describe_patch_groups_response.Mappings }}'
    as: resource
    item:
      patch_group: '{{ resource.PatchGroup }}'
      baseline_identity: '{{ resource.BaselineIdentity }}'
- discovery_id: aws.ssm.describe_association
  calls:
  - action: describe_association
    save_as: describe_association_response
  emit:
    items_for: '{{ describe_association_response.AssociationDescription }}'
    as: resource
    item:
      name: '{{ resource.Name }}'
      instance_id: '{{ resource.InstanceId }}'
      association_version: '{{ resource.AssociationVersion }}'
      date: '{{ resource.Date }}'
      last_update_association_date: '{{ resource.LastUpdateAssociationDate }}'
      status: '{{ resource.Status }}'
      overview: '{{ resource.Overview }}'
      document_version: '{{ resource.DocumentVersion }}'
      automation_target_parameter_name: '{{ resource.AutomationTargetParameterName
        }}'
      parameters: '{{ resource.Parameters }}'
- discovery_id: aws.ssm.describe_automation_executions
  calls:
  - action: describe_automation_executions
    save_as: describe_automation_executions_response
  emit:
    items_for: '{{ describe_automation_executions_response.AutomationExecutionMetadataList
      }}'
    as: resource
    item:
      automation_execution_id: '{{ resource.AutomationExecutionId }}'
      document_name: '{{ resource.DocumentName }}'
      document_version: '{{ resource.DocumentVersion }}'
      automation_execution_status: '{{ resource.AutomationExecutionStatus }}'
      execution_start_time: '{{ resource.ExecutionStartTime }}'
      execution_end_time: '{{ resource.ExecutionEndTime }}'
      executed_by: '{{ resource.ExecutedBy }}'
      log_file: '{{ resource.LogFile }}'
      outputs: '{{ resource.Outputs }}'
      mode: '{{ resource.Mode }}'
- discovery_id: aws.ssm.describe_activations
  calls:
  - action: describe_activations
    save_as: describe_activations_response
  emit:
    items_for: '{{ describe_activations_response.ActivationList }}'
    as: resource
    item:
      activation_id: '{{ resource.ActivationId }}'
      description: '{{ resource.Description }}'
      default_instance_name: '{{ resource.DefaultInstanceName }}'
      iam_role: '{{ resource.IamRole }}'
      registration_limit: '{{ resource.RegistrationLimit }}'
      registrations_count: '{{ resource.RegistrationsCount }}'
      expiration_date: '{{ resource.ExpirationDate }}'
      expired: '{{ resource.Expired }}'
      created_date: '{{ resource.CreatedDate }}'
      tags: '{{ resource.Tags }}'
- discovery_id: aws.ssm.list_documents
  calls:
  - action: list_documents
    save_as: list_documents_response
  emit:
    items_for: '{{ list_documents_response.DocumentIdentifiers }}'
    as: resource
    item:
      name: '{{ resource.Name }}'
      created_date: '{{ resource.CreatedDate }}'
      display_name: '{{ resource.DisplayName }}'
      owner: '{{ resource.Owner }}'
      version_name: '{{ resource.VersionName }}'
      platform_types: '{{ resource.PlatformTypes }}'
      document_version: '{{ resource.DocumentVersion }}'
      document_type: '{{ resource.DocumentType }}'
      schema_version: '{{ resource.SchemaVersion }}'
      document_format: '{{ resource.DocumentFormat }}'
- discovery_id: aws.ssm.describe_parameters
  calls:
  - action: describe_parameters
    save_as: describe_parameters_response
  emit:
    items_for: '{{ describe_parameters_response.Parameters }}'
    as: resource
    item:
      name: '{{ resource.Name }}'
      arn: '{{ resource.ARN }}'
      type: '{{ resource.Type }}'
      key_id: '{{ resource.KeyId }}'
      last_modified_date: '{{ resource.LastModifiedDate }}'
      last_modified_user: '{{ resource.LastModifiedUser }}'
      description: '{{ resource.Description }}'
      allowed_pattern: '{{ resource.AllowedPattern }}'
      version: '{{ resource.Version }}'
      tier: '{{ resource.Tier }}'
- discovery_id: aws.ssm.describe_maintenance_window_tasks
  calls:
  - action: describe_maintenance_window_tasks
    save_as: describe_maintenance_window_tasks_response
    params:
      WindowId: '{{ item.window_id }}'
    on_error: continue
  for_each: aws.ssm.describe_maintenance_windows
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      window_id: '{{ describe_maintenance_window_tasks_response.Tasks.WindowId }}'
      window_task_id: '{{ describe_maintenance_window_tasks_response.Tasks.WindowTaskId
        }}'
      task_arn: '{{ describe_maintenance_window_tasks_response.Tasks.TaskArn }}'
      type: '{{ describe_maintenance_window_tasks_response.Tasks.Type }}'
      targets: '{{ describe_maintenance_window_tasks_response.Tasks.Targets }}'
checks:
- rule_id: aws.ssm.patchbaseline.ssm_required_controls_present
  for_each: aws.ssm.describe_patch_baselines
  conditions:
    var: item.default_baseline
    op: equals
    value: true
- rule_id: aws.ssm.patchbaseline.ssm_approval_rules_configured
  for_each: aws.ssm.describe_patch_baselines
  conditions:
    all:
    - var: item.baseline_id
      op: exists
    - var: item.baseline_name
      op: exists
    - var: item.default_baseline
      op: equals
      value: true
- rule_id: aws.ssm.patchbaseline.ssm_baseline_defined_for_os_families_configured
  for_each: aws.ssm.describe_patch_baselines
  conditions:
    var: item.baseline_id
    op: exists
- rule_id: aws.ssm.maintenance_window.ssm_window_configured
  for_each: aws.ssm.describe_maintenance_windows
  conditions:
    all:
    - var: item.enabled
      op: equals
      value: true
    - var: item.schedule
      op: exists
    - var: item.duration
      op: gt
      value: 0
    - var: item.cutoff
      op: gte
      value: 0
- rule_id: aws.ssm.patchgroup.ssm_approval_rules_configured
  for_each: aws.ssm.describe_patch_groups
  conditions:
    var: item.baseline_identity
    op: exists
- rule_id: aws.ssm.restapi.public_access_restricted
  for_each: aws.ssm.describe_association
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.ssm.maintenance_window.execution_roles_least_privilege
  for_each: aws.ssm.describe_maintenance_window_tasks
  conditions:
    var: item.service_role_arn
    op: exists
- rule_id: aws.ssm.baseline.ssm_conformance_pack_deployed_configured
  for_each: aws.ssm.describe_association
  conditions:
    all:
    - var: item.status
      op: equals
      value: ENABLED
    - var: item.association_id
      op: exists
- rule_id: aws.ssm.automation.ssm_storage_encrypted_and_private
  for_each: aws.ssm.describe_automation_executions
  conditions:
    all:
    - var: item.automation_execution_status
      op: equals
      value: SUCCESS
    - var: item.document_name
      op: contains
      value: Encrypted
    - var: item.document_name
      op: contains
      value: Private
- rule_id: aws.ssm.automation.remediation_roles_least_privilege
  for_each: aws.ssm.describe_activations
  conditions:
    var: item.iam_role
    op: exists
- rule_id: aws.ssm.automation.change_audit_logging_enabled
  for_each: aws.ssm.describe_automation_executions
  conditions:
    all:
    - var: item.automation_execution_status
      op: equals
      value: SUCCESS
    - var: item.log_file
      op: exists
- rule_id: aws.ssm.patchbaseline.ssm_maintenance_windows_configured
  for_each: aws.ssm.describe_maintenance_windows
  conditions:
    all:
    - var: item.enabled
      op: equals
      value: true
    - var: item.schedule
      op: exists
- rule_id: aws.ssm.automation.execution_roles_least_privilege
  for_each: aws.ssm.describe_activations
  conditions:
    var: item.iam_role
    op: exists
- rule_id: aws.ssm.automation.versioning_and_immutability_enabled
  for_each: aws.ssm.list_documents
  conditions:
    all:
    - var: item.document_version
      op: exists
    - var: item.version_name
      op: exists
- rule_id: aws.ssm.patchgroup.ssm_baseline_defined_for_os_families_configured
  for_each: aws.ssm.describe_patch_baselines
  conditions:
    var: item.baseline_id
    op: exists
- rule_id: aws.ssm.patchgroup.ssm_maintenance_windows_configured
  for_each: aws.ssm.describe_maintenance_windows
  conditions:
    all:
    - var: item.enabled
      op: equals
      value: true
    - var: item.schedule
      op: exists
- rule_id: aws.ssm.document.ssm_secrets_encrypted
  for_each: aws.ssm.describe_parameters
  conditions:
    var: item.key_id
    op: exists
