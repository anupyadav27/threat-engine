version: '1.0'
provider: aws
service: docdb
services:
  client: docdb
  module: boto3.client
discovery:
- discovery_id: aws.docdb.describe_d_b_clusters
  calls:
  - action: describe_db_clusters
    save_as: response
  emit:
    item:
      AvailabilityZones: '{{ response.DBClusters.AvailabilityZones }}'
      BackupRetentionPeriod: '{{ response.DBClusters.BackupRetentionPeriod }}'
      DBClusterIdentifier: '{{ response.DBClusters.DBClusterIdentifier }}'
      DBClusterParameterGroup: '{{ response.DBClusters.DBClusterParameterGroup }}'
      DBSubnetGroup: '{{ response.DBClusters.DBSubnetGroup }}'
      Status: '{{ response.DBClusters.Status }}'
      PercentProgress: '{{ response.DBClusters.PercentProgress }}'
      EarliestRestorableTime: '{{ response.DBClusters.EarliestRestorableTime }}'
      Endpoint: '{{ response.DBClusters.Endpoint }}'
      ReaderEndpoint: '{{ response.DBClusters.ReaderEndpoint }}'
      MultiAZ: '{{ response.DBClusters.MultiAZ }}'
      Engine: '{{ response.DBClusters.Engine }}'
      EngineVersion: '{{ response.DBClusters.EngineVersion }}'
      LatestRestorableTime: '{{ response.DBClusters.LatestRestorableTime }}'
      Port: '{{ response.DBClusters.Port }}'
      MasterUsername: '{{ response.DBClusters.MasterUsername }}'
      PreferredBackupWindow: '{{ response.DBClusters.PreferredBackupWindow }}'
      PreferredMaintenanceWindow: '{{ response.DBClusters.PreferredMaintenanceWindow
        }}'
      ReplicationSourceIdentifier: '{{ response.DBClusters.ReplicationSourceIdentifier
        }}'
      ReadReplicaIdentifiers: '{{ response.DBClusters.ReadReplicaIdentifiers }}'
      DBClusterMembers: '{{ response.DBClusters.DBClusterMembers }}'
      VpcSecurityGroups: '{{ response.DBClusters.VpcSecurityGroups }}'
      HostedZoneId: '{{ response.DBClusters.HostedZoneId }}'
      StorageEncrypted: '{{ response.DBClusters.StorageEncrypted }}'
      KmsKeyId: '{{ response.DBClusters.KmsKeyId }}'
      DbClusterResourceId: '{{ response.DBClusters.DbClusterResourceId }}'
      DBClusterArn: '{{ response.DBClusters.DBClusterArn }}'
      AssociatedRoles: '{{ response.DBClusters.AssociatedRoles }}'
      CloneGroupId: '{{ response.DBClusters.CloneGroupId }}'
      ClusterCreateTime: '{{ response.DBClusters.ClusterCreateTime }}'
      EnabledCloudwatchLogsExports: '{{ response.DBClusters.EnabledCloudwatchLogsExports
        }}'
      DeletionProtection: '{{ response.DBClusters.DeletionProtection }}'
      IOOptimizedNextAllowedModificationTime: '{{ response.DBClusters.IOOptimizedNextAllowedModificationTime
        }}'
      StorageType: '{{ response.DBClusters.StorageType }}'
      ServerlessV2ScalingConfiguration: '{{ response.DBClusters.ServerlessV2ScalingConfiguration
        }}'
      MasterUserSecret: '{{ response.DBClusters.MasterUserSecret }}'
      NetworkType: '{{ response.DBClusters.NetworkType }}'
      Enabled: '{{ resource.Enabled }}'
- discovery_id: aws.docdb.describe_d_b_instances
  calls:
  - action: describe_db_instances
    save_as: response
  emit:
    item:
      DBInstanceIdentifier: '{{ response.DBInstances.DBInstanceIdentifier }}'
      DBInstanceClass: '{{ response.DBInstances.DBInstanceClass }}'
      Engine: '{{ response.DBInstances.Engine }}'
      DBInstanceStatus: '{{ response.DBInstances.DBInstanceStatus }}'
      Endpoint: '{{ response.DBInstances.Endpoint }}'
      InstanceCreateTime: '{{ response.DBInstances.InstanceCreateTime }}'
      PreferredBackupWindow: '{{ response.DBInstances.PreferredBackupWindow }}'
      BackupRetentionPeriod: '{{ response.DBInstances.BackupRetentionPeriod }}'
      VpcSecurityGroups: '{{ response.DBInstances.VpcSecurityGroups }}'
      AvailabilityZone: '{{ response.DBInstances.AvailabilityZone }}'
      DBSubnetGroup: '{{ response.DBInstances.DBSubnetGroup }}'
      PreferredMaintenanceWindow: '{{ response.DBInstances.PreferredMaintenanceWindow
        }}'
      PendingModifiedValues: '{{ response.DBInstances.PendingModifiedValues }}'
      LatestRestorableTime: '{{ response.DBInstances.LatestRestorableTime }}'
      EngineVersion: '{{ response.DBInstances.EngineVersion }}'
      AutoMinorVersionUpgrade: '{{ response.DBInstances.AutoMinorVersionUpgrade }}'
      PubliclyAccessible: '{{ response.DBInstances.PubliclyAccessible }}'
      StatusInfos: '{{ response.DBInstances.StatusInfos }}'
      DBClusterIdentifier: '{{ response.DBInstances.DBClusterIdentifier }}'
      StorageEncrypted: '{{ response.DBInstances.StorageEncrypted }}'
      KmsKeyId: '{{ response.DBInstances.KmsKeyId }}'
      DbiResourceId: '{{ response.DBInstances.DbiResourceId }}'
      CACertificateIdentifier: '{{ response.DBInstances.CACertificateIdentifier }}'
      CopyTagsToSnapshot: '{{ response.DBInstances.CopyTagsToSnapshot }}'
      PromotionTier: '{{ response.DBInstances.PromotionTier }}'
      DBInstanceArn: '{{ response.DBInstances.DBInstanceArn }}'
      EnabledCloudwatchLogsExports: '{{ response.DBInstances.EnabledCloudwatchLogsExports
        }}'
      CertificateDetails: '{{ response.DBInstances.CertificateDetails }}'
      PerformanceInsightsEnabled: '{{ response.DBInstances.PerformanceInsightsEnabled
        }}'
      PerformanceInsightsKMSKeyId: '{{ response.DBInstances.PerformanceInsightsKMSKeyId
        }}'
- discovery_id: aws.docdb.describe_d_b_cluster_snapshots
  calls:
  - action: describe_db_cluster_snapshots
    save_as: response
  emit:
    item:
      AvailabilityZones: '{{ response.DBClusterSnapshots.AvailabilityZones }}'
      DBClusterSnapshotIdentifier: '{{ response.DBClusterSnapshots.DBClusterSnapshotIdentifier
        }}'
      DBClusterIdentifier: '{{ response.DBClusterSnapshots.DBClusterIdentifier }}'
      SnapshotCreateTime: '{{ response.DBClusterSnapshots.SnapshotCreateTime }}'
      Engine: '{{ response.DBClusterSnapshots.Engine }}'
      Status: '{{ response.DBClusterSnapshots.Status }}'
      Port: '{{ response.DBClusterSnapshots.Port }}'
      VpcId: '{{ response.DBClusterSnapshots.VpcId }}'
      ClusterCreateTime: '{{ response.DBClusterSnapshots.ClusterCreateTime }}'
      MasterUsername: '{{ response.DBClusterSnapshots.MasterUsername }}'
      EngineVersion: '{{ response.DBClusterSnapshots.EngineVersion }}'
      SnapshotType: '{{ response.DBClusterSnapshots.SnapshotType }}'
      PercentProgress: '{{ response.DBClusterSnapshots.PercentProgress }}'
      StorageEncrypted: '{{ response.DBClusterSnapshots.StorageEncrypted }}'
      KmsKeyId: '{{ response.DBClusterSnapshots.KmsKeyId }}'
      DBClusterSnapshotArn: '{{ response.DBClusterSnapshots.DBClusterSnapshotArn }}'
      SourceDBClusterSnapshotArn: '{{ response.DBClusterSnapshots.SourceDBClusterSnapshotArn
        }}'
      StorageType: '{{ response.DBClusterSnapshots.StorageType }}'
      Vpc: '{{ resource.Vpc }}'
checks:
- rule_id: aws.docdb.cluster.monitoring_and_alerting_configured
  for_each: aws.docdb.describe_d_b_clusters
  conditions:
    var: item.Enabled
    op: equals
    value: true
- rule_id: aws.docdb.cluster.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.docdb.describe_d_b_instances
  conditions:
    var: item.PubliclyAccessible
    op: equals
    value: 'false'
- rule_id: aws.docdb.instance.require_tls_in_transit_configured
  for_each: aws.docdb.describe_d_b_clusters
  conditions:
    var: item.Enabled
    op: equals
    value: true
- rule_id: aws.docdb.cluster.public_access_disabled
  for_each: aws.docdb.describe_d_b_instances
  conditions:
    var: item.PubliclyAccessible
    op: equals
    value: 'false'
- rule_id: aws.docdb.cluster.docdb_minor_version_auto_upgrade_enabled
  for_each: aws.docdb.describe_d_b_instances
  conditions:
    var: item.AutoMinorVersionUpgrade
    op: equals
    value: 'true'
- rule_id: aws.docdb.instance.encryption_at_rest_enabled
  for_each: aws.docdb.describe_d_b_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: 'true'
- rule_id: aws.docdb.cluster.encryption_in_transit_enabled
  for_each: aws.docdb.describe_d_b_clusters
  conditions:
    var: item.Enabled
    op: equals
    value: true
- rule_id: aws.docdb.cluster.audit_logging_to_cloudwatch_enabled
  for_each: aws.docdb.describe_d_b_clusters
  conditions:
    var: item.Enabled
    op: equals
    value: true
- rule_id: aws.docdb.cluster.preferred_backup_window_configured
  for_each: aws.docdb.describe_d_b_clusters
  conditions:
    var: item.PreferredBackupWindow
    op: not_equals
    value: 'null'
- rule_id: aws.docdb.cluster.docdb_cloudwatch_log_export_configured
  for_each: aws.docdb.describe_d_b_clusters
  conditions:
    var: item.EnabledCloudwatchLogsExports
    op: not_equals
    value: 'null'
- rule_id: aws.docdb.cluster.iam_authentication_enabled
  for_each: aws.docdb.describe_d_b_clusters
  conditions:
    var: item.Enabled
    op: equals
    value: 'true'
- rule_id: aws.docdb.resource.vpc_security_configuration_configured
  for_each: aws.docdb.describe_d_b_cluster_snapshots
  conditions:
    var: item.Vpc
    op: not_equals
    value: 'null'
- rule_id: aws.docdb.instance.iam_or_managed_identity_auth_enabled_if_supported
  for_each: aws.docdb.describe_d_b_clusters
  conditions:
    var: item.Enabled
    op: equals
    value: 'true'
- rule_id: aws.docdb.cluster.encryption_at_rest_enabled
  for_each: aws.docdb.describe_d_b_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: 'true'
- rule_id: aws.docdb.cluster.docdb_storage_encrypted
  for_each: aws.docdb.describe_d_b_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: 'true'
- rule_id: aws.docdb.cluster.docdb_engine_version_configured
  for_each: aws.docdb.describe_d_b_cluster_snapshots
  conditions:
    var: item.EngineVersion
    op: not_equals
    value: 'null'
- rule_id: aws.docdb.instance.public_access_disabled
  for_each: aws.docdb.describe_d_b_instances
  conditions:
    var: item.PubliclyAccessible
    op: equals
    value: 'false'
- rule_id: aws.docdb.cluster.encryption_at_rest_cmek_configured
  for_each: aws.docdb.describe_d_b_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: 'true'
- rule_id: aws.docdb.cluster.backup_retention_period_configured
  for_each: aws.docdb.describe_d_b_clusters
  conditions:
    var: item.BackupRetentionPeriod
    op: not_equals
    value: 'null'
- rule_id: aws.docdb.cluster.audit_logging_enabled
  for_each: aws.docdb.describe_d_b_clusters
  conditions:
    var: item.Enabled
    op: equals
    value: true
- rule_id: aws.docdb.instance.deletion_protection_enabled
  for_each: aws.docdb.describe_d_b_clusters
  conditions:
    var: item.DeletionProtection
    op: equals
    value: 'true'
- rule_id: aws.docdb.cluster.docdb_multi_az_enabled
  for_each: aws.docdb.describe_d_b_clusters
  conditions:
    var: item.MultiAZ
    op: equals
    value: 'true'
- rule_id: aws.docdb.cluster.deletion_protection_enabled
  for_each: aws.docdb.describe_d_b_clusters
  conditions:
    var: item.DeletionProtection
    op: equals
    value: 'true'
- rule_id: aws.docdb.cluster.require_tls_in_transit_configured
  for_each: aws.docdb.describe_d_b_cluster_snapshots
  conditions:
    var: item.Vpc
    op: not_equals
    value: 'null'
- rule_id: aws.docdb.cluster.private_networking_enforced
  for_each: aws.docdb.describe_d_b_instances
  conditions:
    var: item.PubliclyAccessible
    op: equals
    value: 'false'
