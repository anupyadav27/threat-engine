version: '1.0'
provider: aws
service: docdb
services:
  client: docdb
  module: boto3.client
discovery:
- discovery_id: aws.docdb.describe_db_cluster_snapshots
  calls:
  - action: describe_db_cluster_snapshots
    save_as: response
  emit:
    item:
      AvailabilityZones: '{{ response.DBClusterSnapshots.AvailabilityZones }}'
      DBClusterSnapshotIdentifier: '{{ response.DBClusterSnapshots.DBClusterSnapshotIdentifier
        }}'
      DBClusterIdentifier: '{{ response.DBClusterSnapshots.DBClusterIdentifier }}'
      SnapshotCreateTime: '{{ response.DBClusterSnapshots.SnapshotCreateTime }}'
      Engine: '{{ response.DBClusterSnapshots.Engine }}'
      Status: '{{ response.DBClusterSnapshots.Status }}'
      Port: '{{ response.DBClusterSnapshots.Port }}'
      VpcId: '{{ response.DBClusterSnapshots.VpcId }}'
      ClusterCreateTime: '{{ response.DBClusterSnapshots.ClusterCreateTime }}'
      MasterUsername: '{{ response.DBClusterSnapshots.MasterUsername }}'
      EngineVersion: '{{ response.DBClusterSnapshots.EngineVersion }}'
      SnapshotType: '{{ response.DBClusterSnapshots.SnapshotType }}'
      PercentProgress: '{{ response.DBClusterSnapshots.PercentProgress }}'
      StorageEncrypted: '{{ response.DBClusterSnapshots.StorageEncrypted }}'
      KmsKeyId: '{{ response.DBClusterSnapshots.KmsKeyId }}'
      DBClusterSnapshotArn: '{{ response.DBClusterSnapshots.DBClusterSnapshotArn }}'
      SourceDBClusterSnapshotArn: '{{ response.DBClusterSnapshots.SourceDBClusterSnapshotArn
        }}'
      StorageType: '{{ response.DBClusterSnapshots.StorageType }}'
- discovery_id: aws.docdb.describe_db_clusters
  calls:
  - action: describe_db_clusters
    save_as: response
  emit:
    item:
      AvailabilityZones: '{{ response.DBClusters.AvailabilityZones }}'
      BackupRetentionPeriod: '{{ response.DBClusters.BackupRetentionPeriod }}'
      DBClusterIdentifier: '{{ response.DBClusters.DBClusterIdentifier }}'
      DBClusterParameterGroup: '{{ response.DBClusters.DBClusterParameterGroup }}'
      DBSubnetGroup: '{{ response.DBClusters.DBSubnetGroup }}'
      Status: '{{ response.DBClusters.Status }}'
      PercentProgress: '{{ response.DBClusters.PercentProgress }}'
      EarliestRestorableTime: '{{ response.DBClusters.EarliestRestorableTime }}'
      Endpoint: '{{ response.DBClusters.Endpoint }}'
      ReaderEndpoint: '{{ response.DBClusters.ReaderEndpoint }}'
      MultiAZ: '{{ response.DBClusters.MultiAZ }}'
      Engine: '{{ response.DBClusters.Engine }}'
      EngineVersion: '{{ response.DBClusters.EngineVersion }}'
      LatestRestorableTime: '{{ response.DBClusters.LatestRestorableTime }}'
      Port: '{{ response.DBClusters.Port }}'
      MasterUsername: '{{ response.DBClusters.MasterUsername }}'
      PreferredBackupWindow: '{{ response.DBClusters.PreferredBackupWindow }}'
      PreferredMaintenanceWindow: '{{ response.DBClusters.PreferredMaintenanceWindow
        }}'
      ReplicationSourceIdentifier: '{{ response.DBClusters.ReplicationSourceIdentifier
        }}'
      ReadReplicaIdentifiers: '{{ response.DBClusters.ReadReplicaIdentifiers }}'
      DBClusterMembers: '{{ response.DBClusters.DBClusterMembers }}'
      VpcSecurityGroups: '{{ response.DBClusters.VpcSecurityGroups }}'
      HostedZoneId: '{{ response.DBClusters.HostedZoneId }}'
      StorageEncrypted: '{{ response.DBClusters.StorageEncrypted }}'
      KmsKeyId: '{{ response.DBClusters.KmsKeyId }}'
      DbClusterResourceId: '{{ response.DBClusters.DbClusterResourceId }}'
      DBClusterArn: '{{ response.DBClusters.DBClusterArn }}'
      AssociatedRoles: '{{ response.DBClusters.AssociatedRoles }}'
      CloneGroupId: '{{ response.DBClusters.CloneGroupId }}'
      ClusterCreateTime: '{{ response.DBClusters.ClusterCreateTime }}'
      EnabledCloudwatchLogsExports: '{{ response.DBClusters.EnabledCloudwatchLogsExports
        }}'
      DeletionProtection: '{{ response.DBClusters.DeletionProtection }}'
      IOOptimizedNextAllowedModificationTime: '{{ response.DBClusters.IOOptimizedNextAllowedModificationTime
        }}'
      StorageType: '{{ response.DBClusters.StorageType }}'
      ServerlessV2ScalingConfiguration: '{{ response.DBClusters.ServerlessV2ScalingConfiguration
        }}'
      MasterUserSecret: '{{ response.DBClusters.MasterUserSecret }}'
      NetworkType: '{{ response.DBClusters.NetworkType }}'
- discovery_id: aws.docdb.describe_db_engine_versions
  calls:
  - action: describe_db_engine_versions
    save_as: response
  emit:
    item:
      Engine: '{{ response.DBEngineVersions.Engine }}'
      EngineVersion: '{{ response.DBEngineVersions.EngineVersion }}'
      DBParameterGroupFamily: '{{ response.DBEngineVersions.DBParameterGroupFamily
        }}'
      DBEngineDescription: '{{ response.DBEngineVersions.DBEngineDescription }}'
      DBEngineVersionDescription: '{{ response.DBEngineVersions.DBEngineVersionDescription
        }}'
      ValidUpgradeTarget: '{{ response.DBEngineVersions.ValidUpgradeTarget }}'
      ExportableLogTypes: '{{ response.DBEngineVersions.ExportableLogTypes }}'
      SupportsLogExportsToCloudwatchLogs: '{{ response.DBEngineVersions.SupportsLogExportsToCloudwatchLogs
        }}'
      SupportedCACertificateIdentifiers: '{{ response.DBEngineVersions.SupportedCACertificateIdentifiers
        }}'
      SupportsCertificateRotationWithoutRestart: '{{ response.DBEngineVersions.SupportsCertificateRotationWithoutRestart
        }}'
      ServerlessV2FeaturesSupport: '{{ response.DBEngineVersions.ServerlessV2FeaturesSupport
        }}'
checks:
- rule_id: aws.docdb.instance.require_tls_in_transit_configured
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.DBClusterParameterGroup
    op: contains
    value: rds.force_ssl
- rule_id: aws.docdb.cluster.public_access_disabled
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.VpcSecurityGroups
    op: equals
    value: []
- rule_id: aws.docdb.cluster.docdb_minor_version_auto_upgrade_enabled
  for_each: aws.docdb.describe_db_cluster_snapshots
  conditions:
    var: item.Engine
    op: exists
- rule_id: aws.docdb.instance.encryption_at_rest_enabled
  for_each: aws.docdb.describe_db_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: true
- rule_id: aws.docdb.cluster.encryption_in_transit_enabled
  for_each: aws.docdb.describe_db_cluster_snapshots
  conditions:
    var: item.Engine
    op: gte
    value: '3.6'
- rule_id: aws.docdb.cluster.audit_logging_to_cloudwatch_enabled
  for_each: aws.docdb.describe_db_engine_versions
  conditions:
    var: item.SupportsLogExportsToCloudwatchLogs
    op: equals
    value: true
- rule_id: aws.docdb.cluster.docdb_cloudwatch_log_export_configured
  for_each: aws.docdb.describe_db_engine_versions
  conditions:
    var: item.SupportsLogExportsToCloudwatchLogs
    op: equals
    value: true
- rule_id: aws.docdb.resource.vpc_security_configuration_configured
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.VpcSecurityGroups
    op: exists
- rule_id: aws.docdb.cluster.encryption_at_rest_enabled
  for_each: aws.docdb.describe_db_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: true
- rule_id: aws.docdb.cluster.docdb_storage_encrypted
  for_each: aws.docdb.describe_db_cluster_snapshots
  conditions:
    var: item.StorageEncrypted
    op: equals
    value: true
- rule_id: aws.docdb.cluster.docdb_engine_version_configured
  for_each: aws.docdb.describe_db_cluster_snapshots
  conditions:
    var: item.Engine
    op: equals
    value: 3.6.0
- rule_id: aws.docdb.instance.public_access_disabled
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.VpcSecurityGroups
    op: equals
    value: []
- rule_id: aws.docdb.cluster.backup_retention_period_configured
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.BackupRetentionPeriod
    op: gt
    value: 0
- rule_id: aws.docdb.cluster.audit_logging_enabled
  for_each: aws.docdb.describe_db_engine_versions
  conditions:
    var: item.SupportsLogExportsToCloudwatchLogs
    op: equals
    value: true
- rule_id: aws.docdb.instance.deletion_protection_enabled
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.DeletionProtection
    op: equals
    value: true
- rule_id: aws.docdb.cluster.docdb_multi_az_enabled
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.MultiAZ
    op: equals
    value: true
- rule_id: aws.docdb.cluster.deletion_protection_enabled
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.DeletionProtection
    op: equals
    value: true
- rule_id: aws.docdb.cluster.require_tls_in_transit_configured
  for_each: aws.docdb.describe_db_clusters
  conditions:
    var: item.DBClusterParameterGroup
    op: contains
    value: rds.force_ssl
