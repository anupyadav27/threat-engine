version: '1.0'
provider: aws
service: controltower
discovery:
- discovery_id: aws.controltower.landingzones
  calls:
  - client: controltower
    action: list_baselines
    save_as: landingzone_list
    on_error: continue
    fields:
    - Controltowers
  emit:
    items_for: landingzone_list[]
    as: landingzone
    item:
      id: '{{ landingzone.Id }}'
      name: '{{ landingzone.Name }}'
- discovery_id: aws.controltower.enrollments
  for_each: aws.controltower.enrollment
  calls:
  - client: controltower
    action: list_enabled_controls
    save_as: enrollments
    on_error: continue
  emit:
    item:
      resource_id: '{{ item.id }}'
      compliant: '{{ true }}'
checks:
- title: 'CONTROLTOWER landingzone: Controltower Scps Enabled'
  severity: medium
  rule_id: aws.controltower.landingzone.controltower_scps_enabled
  for_each:
    discovery: aws.controltower.landingzones
    as: landingzone
    item: landingzone
  conditions:
    var: landingzone.compliant
    op: equals
    value: true
- title: 'CONTROLTOWER enrollment: Block Leave Org By Policy Configured'
  severity: high
  rule_id: aws.controltower.enrollment.block_leave_org_by_policy_configured
  for_each:
    discovery: aws.controltower.enrollments
    as: enrollment
    item: enrollment
  conditions:
    var: enrollment.is_public
    op: equals
    value: false
- title: 'CONTROLTOWER landingzone: Block Leave Org By Policy Configured'
  severity: high
  rule_id: aws.controltower.landingzone.block_leave_org_by_policy_configured
  for_each:
    discovery: aws.controltower.landingzones
    as: landingzone
    item: landingzone
  conditions:
    var: landingzone.is_public
    op: equals
    value: false
- title: 'CONTROLTOWER enrollment: Controltower All Accounts Enrolled In Org Configured'
  severity: medium
  rule_id: aws.controltower.enrollment.controltower_all_accounts_enrolled_in_org_configured
  for_each:
    discovery: aws.controltower.enrollments
    as: enrollment
    item: enrollment
  conditions:
    var: enrollment.compliant
    op: equals
    value: true
- title: 'CONTROLTOWER enrollment: Restrict Region Usage By Policy Where Required'
  severity: high
  rule_id: aws.controltower.enrollment.restrict_region_usage_by_policy_where_required
  for_each:
    discovery: aws.controltower.enrollments
    as: enrollment
    item: enrollment
  conditions:
    var: enrollment.is_public
    op: equals
    value: false
- title: 'CONTROLTOWER landingzone: Restrict Region Usage By Policy Where Required'
  severity: high
  rule_id: aws.controltower.landingzone.restrict_region_usage_by_policy_where_required
  for_each:
    discovery: aws.controltower.landingzones
    as: landingzone
    item: landingzone
  conditions:
    var: landingzone.is_public
    op: equals
    value: false
- title: 'CONTROLTOWER landingzone: Controltower All Accounts Enrolled In Org Configured'
  severity: medium
  rule_id: aws.controltower.landingzone.controltower_all_accounts_enrolled_in_org_configured
  for_each:
    discovery: aws.controltower.landingzones
    as: landingzone
    item: landingzone
  conditions:
    var: landingzone.compliant
    op: equals
    value: true
- title: 'CONTROLTOWER enrollment: Controltower Scps Enabled'
  severity: medium
  rule_id: aws.controltower.enrollment.controltower_scps_enabled
  for_each:
    discovery: aws.controltower.enrollments
    as: enrollment
    item: enrollment
  conditions:
    var: enrollment.compliant
    op: equals
    value: true
