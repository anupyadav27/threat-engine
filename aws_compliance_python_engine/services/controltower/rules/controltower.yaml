version: '1.0'
provider: aws
service: controltower
services:
  client: controltower
  module: boto3.client
discovery:
- discovery_id: aws.controltower.get_enabled_control
  calls:
  - action: get_enabled_control
    save_as: response
  emit:
    item:
      arn: '{{ response.enabledControlDetails.arn }}'
      controlIdentifier: '{{ response.enabledControlDetails.controlIdentifier }}'
      targetIdentifier: '{{ response.enabledControlDetails.targetIdentifier }}'
      statusSummary: '{{ response.enabledControlDetails.statusSummary }}'
      driftStatusSummary: '{{ response.enabledControlDetails.driftStatusSummary }}'
      parentIdentifier: '{{ response.enabledControlDetails.parentIdentifier }}'
      targetRegions: '{{ response.enabledControlDetails.targetRegions }}'
      parameters: '{{ response.enabledControlDetails.parameters }}'
      enabledControlDetails: '{{ resource.enabledControlDetails }}'
- discovery_id: aws.controltower.list_control_operations
  calls:
  - action: list_control_operations
    save_as: response
  emit:
    items_for: '{{ response.controlOperations }}'
    as: resource
    item:
      operationType: '{{ resource.operationType }}'
      startTime: '{{ resource.startTime }}'
      endTime: '{{ resource.endTime }}'
      status: '{{ resource.status }}'
      statusMessage: '{{ resource.statusMessage }}'
      operationIdentifier: '{{ resource.operationIdentifier }}'
      controlIdentifier: '{{ resource.controlIdentifier }}'
      targetIdentifier: '{{ resource.targetIdentifier }}'
      enabledControlIdentifier: '{{ resource.enabledControlIdentifier }}'
checks:
- rule_id: aws.controltower.landingzone.controltower_scps_enabled
  for_each: aws.controltower.get_enabled_control
  conditions:
    var: item.enabledControlDetails
    op: not_equals
    value: 'null'
- rule_id: aws.controltower.enrollment.block_leave_org_by_policy_configured
  for_each: aws.controltower.get_enabled_control
  conditions:
    var: item.enabledControlDetails
    op: not_equals
    value: 'null'
- rule_id: aws.controltower.landingzone.block_leave_org_by_policy_configured
  for_each: aws.controltower.get_enabled_control
  conditions:
    var: item.enabledControlDetails
    op: not_equals
    value: 'null'
- rule_id: aws.controltower.enrollment.controltower_all_accounts_enrolled_in_org_configured
  for_each: aws.controltower.list_control_operations
  conditions:
    var: item.enabledControlIdentifier
    op: exists
- rule_id: aws.controltower.enrollment.restrict_region_usage_by_policy_where_required
  for_each: aws.controltower.get_enabled_control
  conditions:
    var: item.targetRegions
    op: not_equals
    value: 'null'
- rule_id: aws.controltower.landingzone.restrict_region_usage_by_policy_where_required
  for_each: aws.controltower.get_enabled_control
  conditions:
    var: item.targetRegions
    op: not_equals
    value: 'null'
- rule_id: aws.controltower.landingzone.controltower_all_accounts_enrolled_in_org_configured
  for_each: aws.controltower.get_enabled_control
  conditions:
    var: item.enabledControlDetails
    op: not_equals
    value: 'null'
- rule_id: aws.controltower.enrollment.controltower_scps_enabled
  for_each: aws.controltower.get_enabled_control
  conditions:
    var: item.enabledControlDetails
    op: not_equals
    value: 'null'
