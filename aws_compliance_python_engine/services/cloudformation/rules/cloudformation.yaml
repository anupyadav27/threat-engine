version: '1.0'
provider: aws
service: cloudformation
services:
  client: cloudformation
  module: boto3.client
discovery:
- discovery_id: aws.cloudformation.describe_stacks
  calls:
  - action: describe_stacks
    save_as: response
  emit:
    item:
      StackId: '{{ response.Stacks.StackId }}'
      StackName: '{{ response.Stacks.StackName }}'
      ChangeSetId: '{{ response.Stacks.ChangeSetId }}'
      Description: '{{ response.Stacks.Description }}'
      Parameters: '{{ response.Stacks.Parameters }}'
      CreationTime: '{{ response.Stacks.CreationTime }}'
      DeletionTime: '{{ response.Stacks.DeletionTime }}'
      LastUpdatedTime: '{{ response.Stacks.LastUpdatedTime }}'
      RollbackConfiguration: '{{ response.Stacks.RollbackConfiguration }}'
      StackStatus: '{{ response.Stacks.StackStatus }}'
      StackStatusReason: '{{ response.Stacks.StackStatusReason }}'
      DisableRollback: '{{ response.Stacks.DisableRollback }}'
      NotificationARNs: '{{ response.Stacks.NotificationARNs }}'
      TimeoutInMinutes: '{{ response.Stacks.TimeoutInMinutes }}'
      Capabilities: '{{ response.Stacks.Capabilities }}'
      Outputs: '{{ response.Stacks.Outputs }}'
      RoleARN: '{{ response.Stacks.RoleARN }}'
      Tags: '{{ response.Stacks.Tags }}'
      EnableTerminationProtection: '{{ response.Stacks.EnableTerminationProtection
        }}'
      ParentId: '{{ response.Stacks.ParentId }}'
      RootId: '{{ response.Stacks.RootId }}'
      DriftInformation: '{{ response.Stacks.DriftInformation }}'
      RetainExceptOnCreate: '{{ response.Stacks.RetainExceptOnCreate }}'
      DeletionMode: '{{ response.Stacks.DeletionMode }}'
      DetailedStatus: '{{ response.Stacks.DetailedStatus }}'
      LastOperations: '{{ response.Stacks.LastOperations }}'
- discovery_id: aws.cloudformation.describe_stack_resources
  calls:
  - action: describe_stack_resources
    save_as: response
  emit:
    item:
      StackName: '{{ response.StackResources.StackName }}'
      StackId: '{{ response.StackResources.StackId }}'
      LogicalResourceId: '{{ response.StackResources.LogicalResourceId }}'
      PhysicalResourceId: '{{ response.StackResources.PhysicalResourceId }}'
      ResourceType: '{{ response.StackResources.ResourceType }}'
      Timestamp: '{{ response.StackResources.Timestamp }}'
      ResourceStatus: '{{ response.StackResources.ResourceStatus }}'
      ResourceStatusReason: '{{ response.StackResources.ResourceStatusReason }}'
      Description: '{{ response.StackResources.Description }}'
      DriftInformation: '{{ response.StackResources.DriftInformation }}'
      ModuleInfo: '{{ response.StackResources.ModuleInfo }}'
      StackResources: '{{ resource.StackResources }}'
- discovery_id: aws.cloudformation.describe_type
  calls:
  - action: describe_type
    save_as: response
  emit:
    item:
      TypeNameAlias: '{{ response.RequiredActivatedTypes.TypeNameAlias }}'
      OriginalTypeName: '{{ response.RequiredActivatedTypes.OriginalTypeName }}'
      PublisherId: '{{ response.RequiredActivatedTypes.PublisherId }}'
      SupportedMajorVersions: '{{ response.RequiredActivatedTypes.SupportedMajorVersions
        }}'
      LoggingConfig: '{{ resource.LoggingConfig }}'
checks:
- rule_id: aws.cloudformation.stack.cloudformation_approvals_required_for_changes
  for_each: aws.cloudformation.describe_stacks
  conditions:
    var: item.StackStatus
    op: not_equals
    value: DELETE_COMPLETE
- rule_id: aws.cloudformation.stack.cloudformation_storage_encrypted_and_private
  for_each: aws.cloudformation.describe_stack_resources
  conditions:
    var: item.StackResources
    op: contains
    value: Encrypted
- rule_id: aws.cloudformation.stack.change_audit_logging_enabled
  for_each: aws.cloudformation.describe_type
  conditions:
    var: item.LoggingConfig
    op: contains
    value: ENABLED
