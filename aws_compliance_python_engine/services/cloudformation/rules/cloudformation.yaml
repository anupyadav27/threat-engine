version: '1.0'
provider: aws
service: cloudformation
services:
  client: cloudformation
  module: boto3.client
discovery:
- discovery_id: aws.cloudformation.describe_stacks
  calls:
  - action: describe_stacks
    save_as: response
  emit:
    item:
      StackId: '{{ response.Stacks.StackId }}'
      StackName: '{{ response.Stacks.StackName }}'
      ChangeSetId: '{{ response.Stacks.ChangeSetId }}'
      Description: '{{ response.Stacks.Description }}'
      Parameters: '{{ response.Stacks.Parameters }}'
      CreationTime: '{{ response.Stacks.CreationTime }}'
      DeletionTime: '{{ response.Stacks.DeletionTime }}'
      LastUpdatedTime: '{{ response.Stacks.LastUpdatedTime }}'
      RollbackConfiguration: '{{ response.Stacks.RollbackConfiguration }}'
      StackStatus: '{{ response.Stacks.StackStatus }}'
      StackStatusReason: '{{ response.Stacks.StackStatusReason }}'
      DisableRollback: '{{ response.Stacks.DisableRollback }}'
      NotificationARNs: '{{ response.Stacks.NotificationARNs }}'
      TimeoutInMinutes: '{{ response.Stacks.TimeoutInMinutes }}'
      Capabilities: '{{ response.Stacks.Capabilities }}'
      Outputs: '{{ response.Stacks.Outputs }}'
      RoleARN: '{{ response.Stacks.RoleARN }}'
      Tags: '{{ response.Stacks.Tags }}'
      EnableTerminationProtection: '{{ response.Stacks.EnableTerminationProtection
        }}'
      ParentId: '{{ response.Stacks.ParentId }}'
      RootId: '{{ response.Stacks.RootId }}'
      DriftInformation: '{{ response.Stacks.DriftInformation }}'
      RetainExceptOnCreate: '{{ response.Stacks.RetainExceptOnCreate }}'
      DeletionMode: '{{ response.Stacks.DeletionMode }}'
      DetailedStatus: '{{ response.Stacks.DetailedStatus }}'
      LastOperations: '{{ response.Stacks.LastOperations }}'
checks:
- rule_id: aws.cloudformation.stack.cloudformation_approvals_required_for_changes
  for_each: aws.cloudformation.describe_stacks
  conditions:
    var: item.StackStatus
    op: equals
    value: REVIEW_IN_PROGRESS
- rule_id: aws.cloudformation.stack.change_audit_logging_enabled
  for_each: aws.cloudformation.describe_stacks
  conditions:
    var: item.StackStatus
    op: equals
    value: ENABLED
