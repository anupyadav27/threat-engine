version: '1.0'
provider: aws
service: elasticbeanstalk
discovery:
- discovery_id: aws.elasticbeanstalk.describe_configuration_options
  calls:
  - action: describe_configuration_options
    save_as: describe_configuration_options_response
  emit:
    items_for: '{{ describe_configuration_options_response.Options }}'
    as: resource
    item:
      namespace: '{{ resource.Namespace }}'
      name: '{{ resource.Name }}'
      default_value: '{{ resource.DefaultValue }}'
      change_severity: '{{ resource.ChangeSeverity }}'
      user_defined: '{{ resource.UserDefined }}'
      value_type: '{{ resource.ValueType }}'
      value_options: '{{ resource.ValueOptions }}'
      min_value: '{{ resource.MinValue }}'
      max_value: '{{ resource.MaxValue }}'
      max_length: '{{ resource.MaxLength }}'
- discovery_id: aws.elasticbeanstalk.compose_environments
  calls:
  - action: compose_environments
    save_as: compose_environments_response
  emit:
    items_for: '{{ compose_environments_response.Environments }}'
    as: resource
    item:
      environment_name: '{{ resource.EnvironmentName }}'
      environment_id: '{{ resource.EnvironmentId }}'
      application_name: '{{ resource.ApplicationName }}'
      version_label: '{{ resource.VersionLabel }}'
      solution_stack_name: '{{ resource.SolutionStackName }}'
      platform_arn: '{{ resource.PlatformArn }}'
      template_name: '{{ resource.TemplateName }}'
      description: '{{ resource.Description }}'
      endpoint_url: '{{ resource.EndpointURL }}'
      cname: '{{ resource.CNAME }}'
- discovery_id: aws.elasticbeanstalk.describe_configuration_settings
  calls:
  - action: describe_configuration_settings
    save_as: describe_configuration_settings_response
    params:
      ApplicationName: '{{ item.name }}'
    on_error: continue
  for_each: aws.elasticbeanstalk.describe_configuration_options
  emit:
    item:
      resource_id: '{{ item.resource_id }}'
      solution_stack_name: '{{ describe_configuration_settings_response.ConfigurationSettings.SolutionStackName
        }}'
      platform_arn: '{{ describe_configuration_settings_response.ConfigurationSettings.PlatformArn
        }}'
      application_name: '{{ describe_configuration_settings_response.ConfigurationSettings.ApplicationName
        }}'
      template_name: '{{ describe_configuration_settings_response.ConfigurationSettings.TemplateName
        }}'
      description: '{{ describe_configuration_settings_response.ConfigurationSettings.Description
        }}'
checks:
- rule_id: aws.elasticbeanstalk.application.tls_min_1_2_enforced
  for_each: aws.elasticbeanstalk.describe_configuration_options
  conditions:
    all:
    - var: item.namespace
      op: equals
      value: aws:elasticbeanstalk:environment:listener
    - var: item.name
      op: equals
      value: Protocol
    - var: item.default_value
      op: equals
      value: TLSv1.2
- rule_id: aws.elasticbeanstalk.resource.environment_cloudwatch_logging_enabled
  for_each: aws.elasticbeanstalk.compose_environments
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.elasticbeanstalk.resource.elasticbeanstalk_managed_updates_enabled
  for_each: aws.elasticbeanstalk.compose_environments
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.elasticbeanstalk.application.private_networking_enforced
  for_each: aws.elasticbeanstalk.compose_environments
  conditions:
    all:
    - var: item.status
      op: equals
      value: Ready
    - var: item.health
      op: equals
      value: Green
- rule_id: aws.elasticbeanstalk.environment.env_secrets_from_vault_only_configured
  for_each: aws.elasticbeanstalk.describe_configuration_settings
  conditions:
    var: item.option_settings
    op: contains
    value:
      Namespace: aws:elasticbeanstalk:application:environment
      OptionName: ENV_SECRETS_FROM_VAULT_ONLY
      Value: 'true'
- rule_id: aws.elasticbeanstalk.environment.tls_min_1_2_enforced
  for_each: aws.elasticbeanstalk.describe_configuration_options
  conditions:
    all:
    - var: item.namespace
      op: equals
      value: aws:elasticbeanstalk:environment:proxy
    - var: item.name
      op: equals
      value: SSLProtocol
    - var: item.value_options
      op: contains
      value: TLSv1.2
- rule_id: aws.elasticbeanstalk.environment.logging_enabled
  for_each: aws.elasticbeanstalk.compose_environments
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.elasticbeanstalk.application.env_secrets_from_vault_only_configured
  for_each: aws.elasticbeanstalk.describe_configuration_settings
  conditions:
    var: item.option_settings
    op: contains
    value:
      Namespace: aws:elasticbeanstalk:application:environment
      OptionName: SECRETS_MANAGER
      Value: 'true'
- rule_id: aws.elasticbeanstalk.application_version.elasticbeanstalk_immutability_enabled
  for_each: aws.elasticbeanstalk.compose_environments
  conditions:
    var: item.status
    op: equals
    value: ENABLED
- rule_id: aws.elasticbeanstalk.application_version.elasticbeanstalk_artifact_encrypted
  for_each: aws.elasticbeanstalk.compose_environments
  conditions:
    var: item.status
    op: equals
    value: ACTIVE
- rule_id: aws.elasticbeanstalk.environment.private_networking_enforced
  for_each: aws.elasticbeanstalk.compose_environments
  conditions:
    all:
    - var: item.status
      op: equals
      value: Ready
    - var: item.health
      op: equals
      value: Green
- rule_id: aws.elasticbeanstalk.application.logging_enabled
  for_each: aws.elasticbeanstalk.compose_environments
  conditions:
    var: item.status
    op: equals
    value: ENABLED
