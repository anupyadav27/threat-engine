version: '1.0'
provider: aws
service: elasticbeanstalk
services:
  client: elasticbeanstalk
  module: boto3.client
discovery:
- discovery_id: aws.elasticbeanstalk.describe_configuration_options
  calls:
  - action: describe_configuration_options
    save_as: response
  emit:
    item:
      Namespace: '{{ response.Options.Namespace }}'
      Name: '{{ response.Options.Name }}'
      DefaultValue: '{{ response.Options.DefaultValue }}'
      ChangeSeverity: '{{ response.Options.ChangeSeverity }}'
      UserDefined: '{{ response.Options.UserDefined }}'
      ValueType: '{{ response.Options.ValueType }}'
      ValueOptions: '{{ response.Options.ValueOptions }}'
      MinValue: '{{ response.Options.MinValue }}'
      MaxValue: '{{ response.Options.MaxValue }}'
      MaxLength: '{{ response.Options.MaxLength }}'
      Regex: '{{ response.Options.Regex }}'
- discovery_id: aws.elasticbeanstalk.describe_environment_resources
  calls:
  - action: describe_environment_resources
    save_as: response
  emit:
    item:
      EnvironmentName: '{{ response.EnvironmentResources.EnvironmentName }}'
      AutoScalingGroups: '{{ response.EnvironmentResources.AutoScalingGroups }}'
      Instances: '{{ response.EnvironmentResources.Instances }}'
      LaunchConfigurations: '{{ response.EnvironmentResources.LaunchConfigurations
        }}'
      LaunchTemplates: '{{ response.EnvironmentResources.LaunchTemplates }}'
      LoadBalancers: '{{ response.EnvironmentResources.LoadBalancers }}'
      Triggers: '{{ response.EnvironmentResources.Triggers }}'
      Queues: '{{ response.EnvironmentResources.Queues }}'
      EnvironmentResources: '{{ resource.EnvironmentResources }}'
- discovery_id: aws.elasticbeanstalk.describe_environment_managed_actions
  calls:
  - action: describe_environment_managed_actions
    save_as: response
  emit:
    item:
      ActionId: '{{ response.ManagedActions.ActionId }}'
      ActionDescription: '{{ response.ManagedActions.ActionDescription }}'
      ActionType: '{{ response.ManagedActions.ActionType }}'
      Status: '{{ response.ManagedActions.Status }}'
      WindowStartTime: '{{ response.ManagedActions.WindowStartTime }}'
      ManagedActions: '{{ resource.ManagedActions }}'
- discovery_id: aws.elasticbeanstalk.describe_application_versions
  calls:
  - action: describe_application_versions
    save_as: response
  emit:
    item:
      ApplicationVersionArn: '{{ response.ApplicationVersions.ApplicationVersionArn
        }}'
      ApplicationName: '{{ response.ApplicationVersions.ApplicationName }}'
      Description: '{{ response.ApplicationVersions.Description }}'
      VersionLabel: '{{ response.ApplicationVersions.VersionLabel }}'
      SourceBuildInformation: '{{ response.ApplicationVersions.SourceBuildInformation
        }}'
      BuildArn: '{{ response.ApplicationVersions.BuildArn }}'
      SourceBundle: '{{ response.ApplicationVersions.SourceBundle }}'
      DateCreated: '{{ response.ApplicationVersions.DateCreated }}'
      DateUpdated: '{{ response.ApplicationVersions.DateUpdated }}'
      Status: '{{ response.ApplicationVersions.Status }}'
- discovery_id: aws.elasticbeanstalk.describe_configuration_settings
  calls:
  - action: describe_configuration_settings
    save_as: response
  emit:
    item:
      SolutionStackName: '{{ response.ConfigurationSettings.SolutionStackName }}'
      PlatformArn: '{{ response.ConfigurationSettings.PlatformArn }}'
      ApplicationName: '{{ response.ConfigurationSettings.ApplicationName }}'
      TemplateName: '{{ response.ConfigurationSettings.TemplateName }}'
      Description: '{{ response.ConfigurationSettings.Description }}'
      EnvironmentName: '{{ response.ConfigurationSettings.EnvironmentName }}'
      DeploymentStatus: '{{ response.ConfigurationSettings.DeploymentStatus }}'
      DateCreated: '{{ response.ConfigurationSettings.DateCreated }}'
      DateUpdated: '{{ response.ConfigurationSettings.DateUpdated }}'
      OptionSettings: '{{ response.ConfigurationSettings.OptionSettings }}'
      ConfigurationSettings: '{{ resource.ConfigurationSettings }}'
- discovery_id: aws.elasticbeanstalk.list_tags_for_resource
  calls:
  - action: list_tags_for_resource
    save_as: response
  emit:
    items_for: '{{ response.ResourceTags }}'
    as: resource
    item:
      Key: '{{ resource.Key }}'
      Value: '{{ resource.Value }}'
- discovery_id: aws.elasticbeanstalk.describe_environment_health
  calls:
  - action: describe_environment_health
    save_as: response
  emit:
    item:
      ApplicationMetrics: '{{ response.ApplicationMetrics }}'
checks:
- rule_id: aws.elasticbeanstalk.application.tls_min_1_2_enforced
  for_each: aws.elasticbeanstalk.describe_configuration_options
  conditions:
    var: item.MinValue
    op: equals
    value: '1.2'
- rule_id: aws.elasticbeanstalk.resource.environment_cloudwatch_logging_enabled
  for_each: aws.elasticbeanstalk.describe_environment_resources
  conditions:
    var: item.EnvironmentResources
    op: not_equals
    value: 'null'
- rule_id: aws.elasticbeanstalk.resource.elasticbeanstalk_managed_updates_enabled
  for_each: aws.elasticbeanstalk.describe_environment_managed_actions
  conditions:
    var: item.ManagedActions
    op: contains
    value: Managed Updates
- rule_id: aws.elasticbeanstalk.application.private_networking_enforced
  for_each: aws.elasticbeanstalk.describe_application_versions
  conditions:
    var: item.ApplicationName
    op: not_equals
    value: 'null'
- rule_id: aws.elasticbeanstalk.environment.env_secrets_from_vault_only_configured
  for_each: aws.elasticbeanstalk.describe_configuration_settings
  conditions:
    var: item.ConfigurationSettings
    op: not_equals
    value: 'null'
- rule_id: aws.elasticbeanstalk.environment.tls_min_1_2_enforced
  for_each: aws.elasticbeanstalk.describe_configuration_options
  conditions:
    var: item.MinValue
    op: equals
    value: '1.2'
- rule_id: aws.elasticbeanstalk.environment.logging_enabled
  for_each: aws.elasticbeanstalk.describe_environment_resources
  conditions:
    var: item.EnvironmentResources
    op: not_equals
    value: 'null'
- rule_id: aws.elasticbeanstalk.application.env_secrets_from_vault_only_configured
  for_each: aws.elasticbeanstalk.describe_configuration_settings
  conditions:
    var: item.ConfigurationSettings
    op: not_equals
    value: 'null'
- rule_id: aws.elasticbeanstalk.application_version.elasticbeanstalk_immutability_enabled
  for_each: aws.elasticbeanstalk.describe_configuration_settings
  conditions:
    var: item.ConfigurationSettings
    op: not_equals
    value: 'null'
- rule_id: aws.elasticbeanstalk.application_version.elasticbeanstalk_artifact_encrypted
  for_each: aws.elasticbeanstalk.list_tags_for_resource
  conditions:
    var: item.Key
    op: not_equals
    value: 'null'
- rule_id: aws.elasticbeanstalk.environment.private_networking_enforced
  for_each: aws.elasticbeanstalk.describe_environment_resources
  conditions:
    var: item.EnvironmentResources
    op: not_equals
    value: 'null'
- rule_id: aws.elasticbeanstalk.application.logging_enabled
  for_each: aws.elasticbeanstalk.describe_environment_health
  conditions:
    var: item.ApplicationMetrics
    op: not_equals
    value: 'null'
