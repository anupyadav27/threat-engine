version: '1.0'
provider: aws
service: elasticbeanstalk
services:
  client: elasticbeanstalk
  module: boto3.client
discovery:
- discovery_id: aws.elasticbeanstalk.compose_environments
  calls:
  - action: compose_environments
    save_as: response
  emit:
    item:
      EnvironmentName: '{{ response.Environments.EnvironmentName }}'
      EnvironmentId: '{{ response.Environments.EnvironmentId }}'
      ApplicationName: '{{ response.Environments.ApplicationName }}'
      VersionLabel: '{{ response.Environments.VersionLabel }}'
      SolutionStackName: '{{ response.Environments.SolutionStackName }}'
      PlatformArn: '{{ response.Environments.PlatformArn }}'
      TemplateName: '{{ response.Environments.TemplateName }}'
      Description: '{{ response.Environments.Description }}'
      EndpointURL: '{{ response.Environments.EndpointURL }}'
      CNAME: '{{ response.Environments.CNAME }}'
      DateCreated: '{{ response.Environments.DateCreated }}'
      DateUpdated: '{{ response.Environments.DateUpdated }}'
      Status: '{{ response.Environments.Status }}'
      AbortableOperationInProgress: '{{ response.Environments.AbortableOperationInProgress
        }}'
      Health: '{{ response.Environments.Health }}'
      HealthStatus: '{{ response.Environments.HealthStatus }}'
      Resources: '{{ response.Environments.Resources }}'
      Tier: '{{ response.Environments.Tier }}'
      EnvironmentLinks: '{{ response.Environments.EnvironmentLinks }}'
      EnvironmentArn: '{{ response.Environments.EnvironmentArn }}'
      OperationsRole: '{{ response.Environments.OperationsRole }}'
- discovery_id: aws.elasticbeanstalk.update_environment
  calls:
  - action: update_environment
    save_as: response
  emit:
    item:
      LinkName: '{{ response.EnvironmentLinks.LinkName }}'
      EnvironmentName: '{{ response.EnvironmentLinks.EnvironmentName }}'
- discovery_id: aws.elasticbeanstalk.describe_configuration_settings
  calls:
  - action: describe_configuration_settings
    save_as: response
    params:
      ApplicationName: '{{ item.ApplicationName }}'
  on_error: continue
  for_each: aws.elasticbeanstalk.update_environment
  emit:
    item:
      SolutionStackName: '{{ response.ConfigurationSettings.SolutionStackName }}'
      PlatformArn: '{{ response.ConfigurationSettings.PlatformArn }}'
      ApplicationName: '{{ response.ConfigurationSettings.ApplicationName }}'
      TemplateName: '{{ response.ConfigurationSettings.TemplateName }}'
      Description: '{{ response.ConfigurationSettings.Description }}'
      EnvironmentName: '{{ response.ConfigurationSettings.EnvironmentName }}'
      DeploymentStatus: '{{ response.ConfigurationSettings.DeploymentStatus }}'
      DateCreated: '{{ response.ConfigurationSettings.DateCreated }}'
      DateUpdated: '{{ response.ConfigurationSettings.DateUpdated }}'
      OptionSettings: '{{ response.ConfigurationSettings.OptionSettings }}'
checks:
- rule_id: aws.elasticbeanstalk.resource.environment_cloudwatch_logging_enabled
  for_each: aws.elasticbeanstalk.compose_environments
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.elasticbeanstalk.resource.elasticbeanstalk_managed_updates_enabled
  for_each: aws.elasticbeanstalk.compose_environments
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.elasticbeanstalk.environment.env_secrets_from_vault_only_configured
  for_each: aws.elasticbeanstalk.describe_configuration_settings
  conditions:
    var: item.OptionSettings
    op: contains
    value:
      Namespace: aws:elasticbeanstalk:application:environment
      OptionName: ENV_SECRETS_FROM_VAULT_ONLY
      Value: 'true'
- rule_id: aws.elasticbeanstalk.environment.logging_enabled
  for_each: aws.elasticbeanstalk.compose_environments
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.elasticbeanstalk.application.env_secrets_from_vault_only_configured
  for_each: aws.elasticbeanstalk.describe_configuration_settings
  conditions:
    var: item.OptionSettings
    op: contains
    value:
      Namespace: aws:elasticbeanstalk:application:environment
      OptionName: SECRETS_MANAGER
      Value: 'true'
- rule_id: aws.elasticbeanstalk.application_version.elasticbeanstalk_immutability_enabled
  for_each: aws.elasticbeanstalk.compose_environments
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
- rule_id: aws.elasticbeanstalk.application_version.elasticbeanstalk_artifact_encrypted
  for_each: aws.elasticbeanstalk.compose_environments
  conditions:
    var: item.Status
    op: equals
    value: ACTIVE
- rule_id: aws.elasticbeanstalk.application.logging_enabled
  for_each: aws.elasticbeanstalk.compose_environments
  conditions:
    var: item.Status
    op: equals
    value: ENABLED
