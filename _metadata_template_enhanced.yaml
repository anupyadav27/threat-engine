# Enhanced Metadata Template for CSPM Tools
# This template provides comprehensive metadata for Cloud Security Posture Management (CSPM) integration

metadata:
  # Core Identification
  rule_id: aws.<service>.<category>.<check_name>
  title: <Human Readable Title>
  description: <Detailed description of the security control and its purpose>
  
  # CSPM Categorization - Primary security domain
  cspm_category: <cspm_category>  # See categories below
  cspm_subcategory: <cspm_subcategory>  # See subcategories below
  security_domain: <security_domain>  # High-level domain (e.g., Data Security, Identity & Access, Network Security)
  
  # Compliance Framework Mapping
  assertion_id: <framework>.<domain>.<control>  # e.g., crypto_data_protection.encryption_at_rest.default_encryption_enabled
  compliance_frameworks:
    - framework: <framework_name>  # e.g., CIS, NIST, SOC2, HIPAA, PCI-DSS, GDPR
      control_id: <control_id>  # e.g., CIS-2.1.1
      control_title: <control_title>
      mapping_type: <direct|partial|related>  # How closely it maps to the framework
  
  # Service & Resource Information
  service: <service_name>  # e.g., s3, iam, ec2, rds
  resource_type: <resource_type>  # e.g., storage.bucket, identity.user, compute.vm
  resource_scope: <resource_scope>  # account|region|resource
  adapter: aws.<service>.<adapter>
  
  # Risk & Severity
  severity: <low|medium|high|critical>
  risk_score: <0-100>  # Numeric risk score for prioritization
  impact: <low|medium|high|critical>  # Business impact if violated
  likelihood: <low|medium|high>  # Likelihood of exploitation
  
  # Detection & Evidence
  evidence_type: <config_read|api_call|log_analysis|scan_result>
  detection_method: <static|runtime|continuous>  # When/how it's detected
  detection_capability: <automated|manual|semi-automated>
  
  # Coverage & Priority
  coverage_tier: <core|extended|premium>  # Core checks are essential, extended are recommended
  priority: <p0|p1|p2|p3>  # P0 = critical, P3 = nice to have
  recommended_frequency: <continuous|daily|weekly|monthly>  # How often to check
  
  # Remediation
  remediation:
    description: <Step-by-step remediation guidance>
    automated: <true|false>  # Can be auto-remediated
    remediation_type: <config_change|policy_update|permission_change|delete|isolate>
    remediation_steps:
      - step: <step_number>
        action: <action_description>
        command: <optional_aws_cli_command>
        api_call: <optional_api_call>
    estimated_time: <minutes|hours|days>
    complexity: <low|medium|high>
  
  # Context & Rationale
  rationale: <Why this control is important and what it protects against>
  business_justification: <Business reason for implementing this control>
  attack_scenario: <Example of how this could be exploited if not implemented>
  
  # Applicability
  not_applicable_when: <condition_description>  # e.g., no_s3_buckets, no_public_resources
  prerequisites: []  # List of prerequisites or dependencies
  related_rules: []  # Related rule_ids that should be checked together
  
  # Parameters & Configuration
  params: {}  # Any parameters required for the check
  configurable: <true|false>  # Can the check be customized
  
  # Additional Information
  notes: <Additional implementation notes or considerations>
  reference_url: <AWS documentation URL>
  aws_well_architected_pillar: <operational_excellence|security|reliability|performance|cost_optimization|sustainability>
  
  # CSPM Tool Integration
  cspm_tags: []  # Additional tags for filtering and organization
  alert_priority: <low|medium|high|critical>  # Alert priority in CSPM tools
  auto_remediation_enabled: <true|false>  # Whether auto-remediation is enabled by default
  suppression_allowed: <true|false>  # Whether findings can be suppressed with justification
  
  # Data Classification (for data security rules)
  data_classification: <public|internal|confidential|restricted>  # If applicable
  pii_handling: <true|false>  # If the check relates to PII/PHI handling
  
  # Network & Access (for network/entitlement rules)
  network_scope: <vpc|public|private|cross_account>  # If applicable
  access_type: <read|write|delete|admin>  # If applicable
  
  # Timestamps
  created_at: <ISO8601_timestamp>
  updated_at: <ISO8601_timestamp>
  last_validated: <ISO8601_timestamp>

# CSPM Categories Reference:
# Categories are based on common CSPM tool taxonomies
cspm_categories:
  # Data Security & Protection
  - category: data_security
    subcategories:
      - data_encryption_at_rest
      - data_encryption_in_transit
      - data_classification
      - data_backup
      - data_retention
      - data_loss_prevention
  
  # Identity & Access Management (Entitlement)
  - category: entitlement
    subcategories:
      - access_control
      - authentication
      - authorization
      - privilege_management
      - service_accounts
      - role_management
      - policy_management
      - mfa_enforcement
      - session_management
  
  # Network Security
  - category: network_security
    subcategories:
      - firewall_rules
      - network_segmentation
      - vpc_configuration
      - network_monitoring
      - dns_security
      - load_balancer_security
      - vpn_security
  
  # Compute Security
  - category: compute_security
    subcategories:
      - instance_security
      - container_security
      - serverless_security
      - image_security
      - runtime_protection
  
  # Storage Security
  - category: storage_security
    subcategories:
      - bucket_security
      - volume_encryption
      - storage_access_control
      - backup_security
  
  # Secrets & Key Management
  - category: secrets_management
    subcategories:
      - key_rotation
      - key_management
      - secret_storage
      - certificate_management
  
  # Compliance & Governance
  - category: compliance_governance
    subcategories:
      - audit_logging
      - compliance_monitoring
      - policy_enforcement
      - configuration_management
      - drift_detection
  
  # Monitoring & Detection
  - category: monitoring_detection
    subcategories:
      - log_management
      - threat_detection
      - anomaly_detection
      - incident_response
      - security_monitoring
  
  # Infrastructure Security
  - category: infrastructure_security
    subcategories:
      - platform_hardening
      - patch_management
      - vulnerability_management
      - endpoint_protection
  
  # Application Security
  - category: application_security
    subcategories:
      - api_security
      - input_validation
      - output_encoding
      - secure_coding
      - dependency_management

# Security Domains Mapping:
security_domains:
  - data_security: "Protection of data at rest, in transit, and in use"
  - identity_access: "Identity verification, authentication, and authorization controls"
  - network_security: "Network perimeter, segmentation, and traffic controls"
  - compute_security: "Virtual machine, container, and serverless security"
  - secrets_management: "Cryptographic keys, certificates, and secret storage"
  - compliance_governance: "Audit, compliance, and policy enforcement"
  - monitoring_detection: "Security monitoring, logging, and threat detection"
  - infrastructure_security: "Platform hardening and vulnerability management"
  - application_security: "Application-level security controls"

# Example Enhanced Metadata:
example_encryption_rule:
  metadata:
    rule_id: aws.s3.bucket_encryption.default_encryption_enabled
    title: S3 Bucket Default Encryption Enabled
    description: Ensure all S3 buckets have default encryption enabled to protect data at rest
    cspm_category: data_security
    cspm_subcategory: data_encryption_at_rest
    security_domain: data_security
    assertion_id: crypto_data_protection.encryption_at_rest.default_encryption_enabled
    compliance_frameworks:
      - framework: CIS
        control_id: CIS-2.1.1
        control_title: Ensure S3 bucket encryption is enabled
        mapping_type: direct
      - framework: NIST
        control_id: SC-13
        control_title: Cryptographic Protection
        mapping_type: direct
    service: s3
    resource_type: storage.bucket
    resource_scope: account
    severity: high
    risk_score: 85
    impact: high
    likelihood: high
    evidence_type: config_read
    detection_method: static
    detection_capability: automated
    coverage_tier: core
    priority: p0
    recommended_frequency: continuous
    remediation:
      description: Enable default encryption on S3 buckets using AWS KMS or S3 managed keys
      automated: true
      remediation_type: config_change
      remediation_steps:
        - step: 1
          action: Enable default encryption on bucket
          command: aws s3api put-bucket-encryption --bucket <bucket-name> --server-side-encryption-configuration file://encryption.json
      estimated_time: minutes
      complexity: low
    rationale: Unencrypted S3 buckets expose data to unauthorized access
    business_justification: Protects sensitive customer data and meets compliance requirements
    attack_scenario: Attackers can access unencrypted data directly from compromised S3 buckets
    not_applicable_when: no_s3_buckets
    data_classification: confidential
    pii_handling: true
    aws_well_architected_pillar: security
    cspm_tags: [encryption, s3, data-protection, compliance]
    alert_priority: high
    auto_remediation_enabled: true
    suppression_allowed: false

example_entitlement_rule:
  metadata:
    rule_id: aws.iam.entitlement_policies.lifecycle_managed
    title: IAM Entitlement Lifecycle Management
    description: Ensure IAM entitlements have proper lifecycle management with regular reviews and automatic deprovisioning
    cspm_category: entitlement
    cspm_subcategory: privilege_management
    security_domain: identity_access
    assertion_id: rbac_entitlements.entitlement_management.lifecycle_managed
    compliance_frameworks:
      - framework: CIS
        control_id: CIS-1.4
        control_title: Ensure access keys are rotated every 90 days
        mapping_type: related
      - framework: SOC2
        control_id: CC6.2
        control_title: Logical Access Controls
        mapping_type: direct
    service: iam
    resource_type: identity.user
    resource_scope: account
    severity: medium
    risk_score: 65
    impact: medium
    likelihood: medium
    evidence_type: config_read
    detection_method: static
    detection_capability: automated
    coverage_tier: core
    priority: p1
    recommended_frequency: weekly
    remediation:
      description: Implement automated access review workflows and set up lifecycle policies
      automated: false
      remediation_type: policy_update
      remediation_steps:
        - step: 1
          action: Configure IAM access analyzer for access reviews
        - step: 2
          action: Set up automated deprovisioning for inactive users
      estimated_time: hours
      complexity: medium
    rationale: Unmanaged entitlements lead to privilege creep and unauthorized access
    business_justification: Reduces security risk and maintains least privilege principles
    attack_scenario: Compromised inactive accounts or overprivileged users can lead to data breaches
    not_applicable_when: no_iam_resources
    network_scope: cross_account
    access_type: admin
    aws_well_architected_pillar: security
    cspm_tags: [iam, entitlement, access-control, compliance]
    alert_priority: medium
    auto_remediation_enabled: false
    suppression_allowed: true

