component: controllermanager
component_type: control_plane
discovery:
- discovery_id: get_controllermanager_config
  calls:
  - action: get_component_config
    params:
      component: kube-controllermanager
    fields:
    - path: arguments.bind-address
      var: bind_address
    - path: arguments.profiling
      var: profiling
    - path: arguments.use-service-account-credentials
      var: use_service_account_credentials
    - path: arguments.service-account-private-key-file
      var: service_account_private_key_file
    - path: arguments.root-ca-file
      var: root_ca_file
    - path: arguments.rotate-kubelet-server-cert
      var: rotate_kubelet_server_cert
    - path: arguments.terminated-pod-gc-threshold
      var: terminated_pod_gc_threshold
    - path: arguments.tls-cert-file
      var: tls_cert_file
    - path: arguments.tls-private-key-file
      var: tls_private_key_file
    - path: pod_name
      var: pod_name
checks:
- check_id: controllermanager_service_account_private_key_file
  name: Controllermanager Service Account Private Key File
  severity: HIGH
  for_each: get_controllermanager_config
  param: config
  calls:
  - action: get_component_config
    params:
      component: kube-controllermanager
    fields:
    - path: service_account_private_key_file
      operator: exists
      expected: true
  logic: AND
  errors_as_fail: []
