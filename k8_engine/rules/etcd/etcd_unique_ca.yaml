component: etcd
component_type: control_plane
discovery:
- discovery_id: get_etcd_config
  calls:
  - action: get_component_config
    params:
      component: etcd
    fields:
    - path: arguments.cert-file
      var: cert_file
    - path: arguments.key-file
      var: key_file
    - path: arguments.client-cert-auth
      var: client_cert_auth
    - path: arguments.trusted-ca-file
      var: trusted_ca_file
    - path: arguments.peer-cert-file
      var: peer_cert_file
    - path: arguments.peer-key-file
      var: peer_key_file
    - path: arguments.peer-client-cert-auth
      var: peer_client_cert_auth
    - path: arguments.peer-trusted-ca-file
      var: peer_trusted_ca_file
    - path: arguments.auto-tls
      var: auto_tls
    - path: arguments.peer-auto-tls
      var: peer_auto_tls
    - path: pod_name
      var: pod_name
checks:
- check_id: etcd_unique_ca
  name: Etcd Unique Ca
  severity: MEDIUM
  for_each: get_etcd_config
  param: config
  calls:
  - action: get_component_config
    params:
      component: etcd
    fields:
    - path: trusted_ca_file
      operator: exists
      expected: true
    - path: peer_trusted_ca_file
      operator: exists
      expected: true
  logic: AND
  errors_as_fail: []
