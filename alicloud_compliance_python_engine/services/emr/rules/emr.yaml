version: '1.0'
provider: alicloud
service: emr
discovery:
- discovery_id: alicloud.emr.cluster
  calls:
  - product: Unknown
    version: '2014-05-26'
    action: DescribeClusters
    params: {}
    save_as: cluster_response
  emit:
    items_for: '{ cluster_response.Clusters.Cluster }'
    as: r
    item:
      id: '{{ r.ClusterId }}'
      name: '{{ r.ClusterId }}'
      resource_type: cluster
      region: '{{ region }}'
      encrypted: '{{ r.Encrypted }}'
      kms_key_id: '{{ r.KMSKeyId }}'
      public_ip_address: '{{ r.PublicIpAddress }}'
      vpc_id: '{{ r.VpcId }}'
      status: '{{ r.Status }}'
      tags: '{{ r.Tags }}'
- discovery_id: alicloud.emr.encrypted
  calls:
  - product: Unknown
    version: '2014-05-26'
    action: DescribeEncrypteds
    params: {}
    save_as: encrypted_response
  emit:
    items_for: '{ encrypted_response.Encrypteds.Encrypted }'
    as: r
    item:
      id: '{{ r.EncryptedId }}'
      name: '{{ r.EncryptedId }}'
      resource_type: encrypted
      region: '{{ region }}'
      encrypted: '{{ r.Encrypted }}'
      kms_key_id: '{{ r.KMSKeyId }}'
      public_ip_address: '{{ r.PublicIpAddress }}'
      vpc_id: '{{ r.VpcId }}'
      status: '{{ r.Status }}'
      tags: '{{ r.Tags }}'
checks:
- rule_id: alicloud.emr.cluster.account_public_access_blocked
  title: Elastic MapReduce cluster should block public access to master node accounts
  severity: high
  assertion_id: canada_pbmm_moderate_multi_cloud_CCCS_AC-17_0013
  for_each: alicloud.emr.cluster
  params: {}
  conditions:
    all:
    - var: item.public_ip_address
      op: not_exists
    - var: item.internet_facing
      op: not_equals
      value: true
    - var: item.permissions
      op: not_contains
      value: '*'
- rule_id: alicloud.emr.cluster.audit_logging_enabled_centralized
  title: Elastic MapReduce cluster should have centralized audit logging enabled
  severity: medium
  assertion_id: ''
  for_each: alicloud.emr.cluster
  params: {}
  conditions:
    var: item.logging_enabled
    op: equals
    value: true
- rule_id: alicloud.emr.cluster.iam_roles_least_privilege_enforced
  title: Elastic MapReduce Cluster IAM Roles Should Follow Least Privilege Principle
  severity: high
  assertion_id: ''
  for_each: alicloud.emr.cluster
  params: {}
  conditions:
    var: item.permissions
    op: not_contains
    value: '*'
- rule_id: alicloud.emr.cluster.master_nodes_public_ip_disabled
  title: Elastic MapReduce (EMR) cluster master nodes should not have public IP addresses assigned
  severity: high
  assertion_id: canada_pbmm_moderate_multi_cloud_CCCS_AC-17_0013
  for_each: alicloud.emr.cluster
  params: {}
  conditions:
    var: item.id
    op: exists
- rule_id: alicloud.emr.cluster.private_networking_enforced
  title: Elastic MapReduce cluster should enforce private networking configuration
  severity: medium
  assertion_id: ''
  for_each: alicloud.emr.cluster
  params: {}
  conditions:
    var: item.id
    op: exists
- rule_id: alicloud.emr.cluster.public_access_blocked
  title: Ensure Elastic MapReduce (EMR) clusters block public access
  severity: high
  assertion_id: canada_pbmm_moderate_multi_cloud_CCCS_AC-17_0013
  for_each: alicloud.emr.cluster
  params: {}
  conditions:
    all:
    - var: item.public_ip_address
      op: not_exists
    - var: item.internet_facing
      op: not_equals
      value: true
- rule_id: alicloud.emr.cluster.tls_version_minimum_1_2_enforced
  title: Elastic MapReduce Cluster Should Enforce Minimum TLS Version 1.2
  severity: medium
  assertion_id: ''
  for_each: alicloud.emr.cluster
  params: {}
  conditions:
    all:
    - var: item.ssl_enabled
      op: equals
      value: true
    - var: item.min_tls_version
      op: gte
      value: '1.2'
- rule_id: alicloud.emr.encrypted.with_cmks_disabled
  title: Elastic MapReduce (EMR) clusters should not have Customer Master Key (CMK) encryption disabled
  severity: medium
  assertion_id: ''
  for_each: alicloud.emr.encrypted
  params: {}
  conditions:
    all:
    - var: item.encrypted
      op: equals
      value: true
    - var: item.kms_key_id
      op: exists
    - var: item.logging_enabled
      op: equals
      value: true
