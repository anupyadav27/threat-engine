version: '1.0'
provider: alicloud
service: apigateway
discovery:
- discovery_id: alicloud.apigateway.api
  calls:
  - product: Unknown
    version: '2014-05-26'
    action: DescribeApis
    params: {}
    save_as: api_response
  emit:
    items_for: '{ api_response.Apis.Api }'
    as: r
    item:
      id: '{{ r.ApiId }}'
      name: '{{ r.ApiId }}'
      resource_type: api
      region: '{{ region }}'
      encrypted: '{{ r.Encrypted }}'
      kms_key_id: '{{ r.KMSKeyId }}'
      public_ip_address: '{{ r.PublicIpAddress }}'
      vpc_id: '{{ r.VpcId }}'
      status: '{{ r.Status }}'
      tags: '{{ r.Tags }}'
- discovery_id: alicloud.apigateway.fileshare
  calls:
  - product: Unknown
    version: '2014-05-26'
    action: DescribeFileshares
    params: {}
    save_as: fileshare_response
  emit:
    items_for: '{ fileshare_response.Fileshares.Fileshare }'
    as: r
    item:
      id: '{{ r.FileshareId }}'
      name: '{{ r.FileshareId }}'
      resource_type: fileshare
      region: '{{ region }}'
      encrypted: '{{ r.Encrypted }}'
      kms_key_id: '{{ r.KMSKeyId }}'
      public_ip_address: '{{ r.PublicIpAddress }}'
      vpc_id: '{{ r.VpcId }}'
      status: '{{ r.Status }}'
      tags: '{{ r.Tags }}'
- discovery_id: alicloud.apigateway.restapi
  calls:
  - product: Unknown
    version: '2014-05-26'
    action: DescribeRestapis
    params: {}
    save_as: restapi_response
  emit:
    items_for: '{ restapi_response.Restapis.Restapi }'
    as: r
    item:
      id: '{{ r.RestapiId }}'
      name: '{{ r.RestapiId }}'
      resource_type: restapi
      region: '{{ region }}'
      encrypted: '{{ r.Encrypted }}'
      kms_key_id: '{{ r.KMSKeyId }}'
      public_ip_address: '{{ r.PublicIpAddress }}'
      vpc_id: '{{ r.VpcId }}'
      status: '{{ r.Status }}'
      tags: '{{ r.Tags }}'
- discovery_id: alicloud.apigateway.restapi_access_logging_enabled_90_day_retention
  calls:
  - product: Unknown
    version: '2014-05-26'
    action: DescribeRestapiAccessLoggingEnabled90DayRetentions
    params: {}
    save_as: restapi_access_logging_enabled_90_day_retention_response
  emit:
    items_for: '{ restapi_access_logging_enabled_90_day_retention_response.RestapiAccessLoggingEnabled90DayRetentions.RestapiAccessLoggingEnabled90DayRetention
      }'
    as: r
    item:
      id: '{{ r.RestapiAccessLoggingEnabled90DayRetentionId }}'
      name: '{{ r.RestapiAccessLoggingEnabled90DayRetentionId }}'
      resource_type: restapi_access_logging_enabled_90_day_retention
      region: '{{ region }}'
      encrypted: '{{ r.Encrypted }}'
      kms_key_id: '{{ r.KMSKeyId }}'
      public_ip_address: '{{ r.PublicIpAddress }}'
      vpc_id: '{{ r.VpcId }}'
      status: '{{ r.Status }}'
      tags: '{{ r.Tags }}'
checks:
- rule_id: alicloud.apigateway.api.access_logging_enabled
  title: Ensure AliCloud API Gateway APIs have access logging enabled
  severity: medium
  assertion_id: ''
  for_each: alicloud.apigateway.api
  params: {}
  conditions:
    var: item.logging_enabled
    op: equals
    value: true
- rule_id: alicloud.apigateway.fileshare.encryption_enabled
  title: API Gateway File Share Encryption Should Be Enabled
  severity: high
  assertion_id: ''
  for_each: alicloud.apigateway.fileshare
  params: {}
  conditions:
    all:
    - var: item.encrypted
      op: equals
      value: true
    - var: item.logging_enabled
      op: equals
      value: true
- rule_id: alicloud.apigateway.restapi.cache_encryption_at_rest_enabled
  title: Alibaba Cloud API Gateway REST API Cache Encryption At Rest Should Be Enabled
  severity: high
  assertion_id: iso27001_2022_multi_cloud_A.8.24_0080
  for_each: alicloud.apigateway.restapi
  params: {}
  conditions:
    var: item.encrypted
    op: equals
    value: true
- rule_id: alicloud.apigateway.restapi.client_certificate_required
  title: AliCloud API Gateway REST API Should Require Client Certificate Authentication
  severity: medium
  assertion_id: nist_800_171_r2_multi_cloud_3_5_10_3.5.10_Store_and_transmit_only_cryptograph_0042
  for_each: alicloud.apigateway.restapi
  params: {}
  conditions:
    var: item.ssl_enabled
    op: equals
    value: true
- rule_id: alicloud.apigateway.restapi.logging_enabled
  title: Ensure AliCloud API Gateway REST API has logging enabled
  severity: medium
  assertion_id: hipaa_multi_cloud_164_308_a_1_ii_d_0003
  for_each: alicloud.apigateway.restapi
  params: {}
  conditions:
    var: item.logging_enabled
    op: equals
    value: true
- rule_id: alicloud.apigateway.restapi.public
  title: Ensure AliCloud API Gateway REST API is not publicly accessible
  severity: high
  assertion_id: iso27001_2022_multi_cloud_A.8.1_0064
  for_each: alicloud.apigateway.restapi
  params: {}
  conditions:
    all:
    - var: item.public_ip_address
      op: not_exists
    - var: item.internet_facing
      op: not_equals
      value: true
- rule_id: alicloud.apigateway.restapi.public_access_detected
  title: AliCloud API Gateway REST API Public Access Detected
  severity: high
  assertion_id: ''
  for_each: alicloud.apigateway.restapi
  params: {}
  conditions:
    var: item.public_ip_address
    op: exists
- rule_id: alicloud.apigateway.restapi_access_logging_enabled_90_day_retention.configured
  title: API Gateway REST API access logging should be enabled with 90-day retention period
  severity: low
  assertion_id: ''
  for_each: alicloud.apigateway.restapi_access_logging_enabled_90_day_retention
  params: {}
  conditions:
    var: item.logging_enabled
    op: equals
    value: true
