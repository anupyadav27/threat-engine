version: '1.0'
provider: alicloud
service: cr
discovery:
- discovery_id: alicloud.cr.container
  calls:
  - product: Unknown
    version: '2014-05-26'
    action: DescribeContainers
    params: {}
    save_as: container_response
  emit:
    items_for: '{ container_response.Containers.Container }'
    as: r
    item:
      id: '{{ r.ContainerId }}'
      name: '{{ r.ContainerId }}'
      resource_type: container
      region: '{{ region }}'
      encrypted: '{{ r.Encrypted }}'
      kms_key_id: '{{ r.KMSKeyId }}'
      public_ip_address: '{{ r.PublicIpAddress }}'
      vpc_id: '{{ r.VpcId }}'
      status: '{{ r.Status }}'
      tags: '{{ r.Tags }}'
- discovery_id: alicloud.cr.image
  calls:
  - product: Unknown
    version: '2014-05-26'
    action: DescribeImages
    params: {}
    save_as: image_response
  emit:
    items_for: '{ image_response.Images.Image }'
    as: r
    item:
      id: '{{ r.ImageId }}'
      name: '{{ r.ImageId }}'
      resource_type: image
      region: '{{ region }}'
      encrypted: '{{ r.Encrypted }}'
      kms_key_id: '{{ r.KMSKeyId }}'
      public_ip_address: '{{ r.PublicIpAddress }}'
      vpc_id: '{{ r.VpcId }}'
      status: '{{ r.Status }}'
      tags: '{{ r.Tags }}'
- discovery_id: alicloud.cr.instance
  calls:
  - product: Unknown
    version: '2014-05-26'
    action: DescribeInstances
    params: {}
    save_as: instance_response
  emit:
    items_for: '{ instance_response.Instances.Instance }'
    as: r
    item:
      id: '{{ r.InstanceId }}'
      name: '{{ r.InstanceId }}'
      resource_type: instance
      region: '{{ region }}'
      encrypted: '{{ r.Encrypted }}'
      kms_key_id: '{{ r.KMSKeyId }}'
      public_ip_address: '{{ r.PublicIpAddress }}'
      vpc_id: '{{ r.VpcId }}'
      status: '{{ r.Status }}'
      tags: '{{ r.Tags }}'
- discovery_id: alicloud.cr.not
  calls:
  - product: Unknown
    version: '2014-05-26'
    action: DescribeNots
    params: {}
    save_as: not_response
  emit:
    items_for: '{ not_response.Nots.Not }'
    as: r
    item:
      id: '{{ r.NotId }}'
      name: '{{ r.NotId }}'
      resource_type: not
      region: '{{ region }}'
      encrypted: '{{ r.Encrypted }}'
      kms_key_id: '{{ r.KMSKeyId }}'
      public_ip_address: '{{ r.PublicIpAddress }}'
      vpc_id: '{{ r.VpcId }}'
      status: '{{ r.Status }}'
      tags: '{{ r.Tags }}'
- discovery_id: alicloud.cr.packages
  calls:
  - product: Unknown
    version: '2014-05-26'
    action: DescribePackagess
    params: {}
    save_as: packages_response
  emit:
    items_for: '{ packages_response.Packagess.Packages }'
    as: r
    item:
      id: '{{ r.PackagesId }}'
      name: '{{ r.PackagesId }}'
      resource_type: packages
      region: '{{ region }}'
      encrypted: '{{ r.Encrypted }}'
      kms_key_id: '{{ r.KMSKeyId }}'
      public_ip_address: '{{ r.PublicIpAddress }}'
      vpc_id: '{{ r.VpcId }}'
      status: '{{ r.Status }}'
      tags: '{{ r.Tags }}'
- discovery_id: alicloud.cr.replication_rule
  calls:
  - product: Unknown
    version: '2014-05-26'
    action: DescribeReplicationRules
    params: {}
    save_as: replication_rule_response
  emit:
    items_for: '{ replication_rule_response.ReplicationRules.ReplicationRule }'
    as: r
    item:
      id: '{{ r.ReplicationRuleId }}'
      name: '{{ r.ReplicationRuleId }}'
      resource_type: replication_rule
      region: '{{ region }}'
      encrypted: '{{ r.Encrypted }}'
      kms_key_id: '{{ r.KMSKeyId }}'
      public_ip_address: '{{ r.PublicIpAddress }}'
      vpc_id: '{{ r.VpcId }}'
      status: '{{ r.Status }}'
      tags: '{{ r.Tags }}'
- discovery_id: alicloud.cr.repo_policy
  calls:
  - product: Unknown
    version: '2014-05-26'
    action: DescribeRepoPolicys
    params: {}
    save_as: repo_policy_response
  emit:
    items_for: '{ repo_policy_response.RepoPolicys.RepoPolicy }'
    as: r
    item:
      id: '{{ r.RepoPolicyId }}'
      name: '{{ r.RepoPolicyId }}'
      resource_type: repo_policy
      region: '{{ region }}'
      encrypted: '{{ r.Encrypted }}'
      kms_key_id: '{{ r.KMSKeyId }}'
      public_ip_address: '{{ r.PublicIpAddress }}'
      vpc_id: '{{ r.VpcId }}'
      status: '{{ r.Status }}'
      tags: '{{ r.Tags }}'
- discovery_id: alicloud.cr.repository
  calls:
  - product: Unknown
    version: '2014-05-26'
    action: DescribeRepositorys
    params: {}
    save_as: repository_response
  emit:
    items_for: '{ repository_response.Repositorys.Repository }'
    as: r
    item:
      id: '{{ r.RepositoryId }}'
      name: '{{ r.RepositoryId }}'
      resource_type: repository
      region: '{{ region }}'
      encrypted: '{{ r.Encrypted }}'
      kms_key_id: '{{ r.KMSKeyId }}'
      public_ip_address: '{{ r.PublicIpAddress }}'
      vpc_id: '{{ r.VpcId }}'
      status: '{{ r.Status }}'
      tags: '{{ r.Tags }}'
- discovery_id: alicloud.cr.uses
  calls:
  - product: Unknown
    version: '2014-05-26'
    action: DescribeUsess
    params: {}
    save_as: uses_response
  emit:
    items_for: '{ uses_response.Usess.Uses }'
    as: r
    item:
      id: '{{ r.UsesId }}'
      name: '{{ r.UsesId }}'
      resource_type: uses
      region: '{{ region }}'
      encrypted: '{{ r.Encrypted }}'
      kms_key_id: '{{ r.KMSKeyId }}'
      public_ip_address: '{{ r.PublicIpAddress }}'
      vpc_id: '{{ r.VpcId }}'
      status: '{{ r.Status }}'
      tags: '{{ r.Tags }}'
checks:
- rule_id: alicloud.cr.container.vulnerability_scanning_enabled
  title: Container Registry vulnerability scanning should be enabled for container images
  severity: medium
  assertion_id: ''
  for_each: alicloud.cr.container
  params: {}
  conditions:
    var: item.id
    op: exists
- rule_id: alicloud.cr.image.critical_vulnerabilities_blocked
  title: Ensure Container Registry images with critical vulnerabilities are blocked from deployment
  severity: low
  assertion_id: ''
  for_each: alicloud.cr.image
  params: {}
  conditions:
    var: item.id
    op: exists
- rule_id: alicloud.cr.image.vulnerability_scan_on_push
  title: Ensure Container Registry images have vulnerability scanning enabled on push
  severity: medium
  assertion_id: ''
  for_each: alicloud.cr.image
  params: {}
  conditions:
    var: item.id
    op: exists
- rule_id: alicloud.cr.instance.access_policy_and_network_restriction_audit
  title: Container Registry Instance Access Policy and Network Restriction Audit
  severity: medium
  assertion_id: ''
  for_each: alicloud.cr.instance
  params: {}
  conditions:
    var: item.id
    op: exists
- rule_id: alicloud.cr.not.publicly_accessible
  title: Ensure Container Registry repositories are not publicly accessible
  severity: high
  assertion_id: ''
  for_each: alicloud.cr.not
  params: {}
  conditions:
    all:
    - var: item.public_ip_address
      op: not_exists
    - var: item.internet_facing
      op: not_equals
      value: true
- rule_id: alicloud.cr.packages.external_public_publishing_disabled
  title: Ensure Container Registry External Public Publishing is Disabled
  severity: high
  assertion_id: ''
  for_each: alicloud.cr.packages
  params: {}
  conditions:
    var: item.id
    op: exists
- rule_id: alicloud.cr.replication_rule.registry_replication_cross_region_encrypted
  title: Container Registry Replication Rules Must Enable Cross-Region Encryption
  severity: low
  assertion_id: ''
  for_each: alicloud.cr.replication_rule
  params: {}
  conditions:
    var: item.encrypted
    op: equals
    value: true
- rule_id: alicloud.cr.replication_rule.registry_replication_destinations_least_privilege
  title: Container Registry Replication Rule Should Follow Least Privilege Access for Destination Registries
  severity: high
  assertion_id: ''
  for_each: alicloud.cr.replication_rule
  params: {}
  conditions:
    var: item.permissions
    op: not_contains
    value: '*'
- rule_id: alicloud.cr.repo_policy.registry_policy_no_public_pull_push
  title: Container Registry Repository Policy Should Not Allow Public Pull and Push Access
  severity: high
  assertion_id: ''
  for_each: alicloud.cr.repo_policy
  params: {}
  conditions:
    all:
    - var: item.public_ip_address
      op: not_exists
    - var: item.internet_facing
      op: not_equals
      value: true
    - var: item.permissions
      op: not_contains
      value: '*'
- rule_id: alicloud.cr.repo_policy.registry_policy_no_wildcard_admin
  title: Container Registry Repository Policy Should Not Grant Wildcard Admin Permissions
  severity: high
  assertion_id: ''
  for_each: alicloud.cr.repo_policy
  params: {}
  conditions:
    var: item.permissions
    op: not_contains
    value: '*'
- rule_id: alicloud.cr.repository.not_publicly_accessible
  title: Alibaba Cloud Container Registry repositories should not be publicly accessible
  severity: high
  assertion_id: ''
  for_each: alicloud.cr.repository
  params: {}
  conditions:
    all:
    - var: item.public_ip_address
      op: not_exists
    - var: item.internet_facing
      op: not_equals
      value: true
- rule_id: alicloud.cr.repository.registry_image_scanning_enabled
  title: Ensure Container Registry Repository Has Image Scanning Enabled
  severity: low
  assertion_id: ''
  for_each: alicloud.cr.repository
  params: {}
  conditions:
    var: item.id
    op: exists
- rule_id: alicloud.cr.repository.registry_immutable_tags_or_signing_enforced
  title: Container Registry Repository Must Enforce Immutable Tags or Image Signing
  severity: low
  assertion_id: ''
  for_each: alicloud.cr.repository
  params: {}
  conditions:
    var: item.versioning_enabled
    op: equals
    value: true
- rule_id: alicloud.cr.repository.registry_repo_private_or_access_restricted
  title: Ensure Container Registry repositories are private or have restricted access controls
  severity: medium
  assertion_id: ''
  for_each: alicloud.cr.repository
  params: {}
  conditions:
    var: item.permissions
    op: not_contains
    value: '*'
- rule_id: alicloud.cr.repository.scanning_enabled
  title: Container Registry Repository Image Scanning Must Be Enabled
  severity: low
  assertion_id: ''
  for_each: alicloud.cr.repository
  params: {}
  conditions:
    var: item.id
    op: exists
- rule_id: alicloud.cr.uses.private_link
  title: Container Registry should use Private Link for secure network connectivity
  severity: medium
  assertion_id: ''
  for_each: alicloud.cr.uses
  params: {}
  conditions:
    var: item.id
    op: exists
