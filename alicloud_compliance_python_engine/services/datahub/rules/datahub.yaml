version: '1.0'
provider: alicloud
service: datahub
discovery:
- discovery_id: alicloud.datahub.consumer
  calls:
  - product: Unknown
    version: '2014-05-26'
    action: DescribeConsumers
    params: {}
    save_as: consumer_response
  emit:
    items_for: '{ consumer_response.Consumers.Consumer }'
    as: r
    item:
      id: '{{ r.ConsumerId }}'
      name: '{{ r.ConsumerId }}'
      resource_type: consumer
      region: '{{ region }}'
      encrypted: '{{ r.Encrypted }}'
      kms_key_id: '{{ r.KMSKeyId }}'
      public_ip_address: '{{ r.PublicIpAddress }}'
      vpc_id: '{{ r.VpcId }}'
      status: '{{ r.Status }}'
      tags: '{{ r.Tags }}'
- discovery_id: alicloud.datahub.stream
  calls:
  - product: Unknown
    version: '2014-05-26'
    action: DescribeStreams
    params: {}
    save_as: stream_response
  emit:
    items_for: '{ stream_response.Streams.Stream }'
    as: r
    item:
      id: '{{ r.StreamId }}'
      name: '{{ r.StreamId }}'
      resource_type: stream
      region: '{{ region }}'
      encrypted: '{{ r.Encrypted }}'
      kms_key_id: '{{ r.KMSKeyId }}'
      public_ip_address: '{{ r.PublicIpAddress }}'
      vpc_id: '{{ r.VpcId }}'
      status: '{{ r.Status }}'
      tags: '{{ r.Tags }}'
checks:
- rule_id: alicloud.datahub.consumer.access_least_privilege
  title: Ensure AliCloud DataHub Consumer Groups Follow Access Least Privilege Principle
  severity: high
  assertion_id: ''
  for_each: alicloud.datahub.consumer
  params: {}
  conditions:
    var: item.permissions
    op: not_contains
    value: '*'
- rule_id: alicloud.datahub.consumer.auth_required
  title: Ensure AliCloud DataHub Consumer Groups Require Authentication
  severity: medium
  assertion_id: ''
  for_each: alicloud.datahub.consumer
  params: {}
  conditions:
    var: item.id
    op: exists
- rule_id: alicloud.datahub.stream.consumer_auth_required
  title: AliCloud DataHub Stream Consumer Authentication Required
  severity: medium
  assertion_id: ''
  for_each: alicloud.datahub.stream
  params: {}
  conditions:
    var: item.id
    op: exists
- rule_id: alicloud.datahub.stream.data_retention_30_days_minimum
  title: Alibaba Cloud DataHub Stream Data Retention Period Must Be At Least 30 Days
  severity: medium
  assertion_id: ''
  for_each: alicloud.datahub.stream
  params: {}
  conditions:
    var: item.id
    op: exists
- rule_id: alicloud.datahub.stream.encrypted
  title: Ensure AliCloud DataHub streams are encrypted
  severity: medium
  assertion_id: ''
  for_each: alicloud.datahub.stream
  params: {}
  conditions:
    var: item.encrypted
    op: equals
    value: true
- rule_id: alicloud.datahub.stream.encryption_at_rest_enabled
  title: Ensure AliCloud DataHub Stream Has Encryption At Rest Enabled
  severity: high
  assertion_id: ''
  for_each: alicloud.datahub.stream
  params: {}
  conditions:
    var: item.encrypted
    op: equals
    value: true
- rule_id: alicloud.datahub.stream.encryption_enabled
  title: Ensure AliCloud DataHub Stream Encryption is Enabled
  severity: high
  assertion_id: ''
  for_each: alicloud.datahub.stream
  params: {}
  conditions:
    var: item.encrypted
    op: equals
    value: true
- rule_id: alicloud.datahub.stream.least_privilege
  title: Alibaba Cloud DataHub Stream Should Follow Least Privilege Access Control
  severity: high
  assertion_id: ''
  for_each: alicloud.datahub.stream
  params: {}
  conditions:
    var: item.permissions
    op: not_contains
    value: '*'
- rule_id: alicloud.datahub.stream.private_network_only_where_supported
  title: Ensure AliCloud DataHub streams are configured for private network access only where supported
  severity: medium
  assertion_id: ''
  for_each: alicloud.datahub.stream
  params: {}
  conditions:
    var: item.id
    op: exists
