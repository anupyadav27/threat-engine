# Enhanced YAML Rule Template (AWS Compliance Engine)
# Updated format with emit section and assertion_id mapping
# Replace <placeholders> with concrete values. Comments explain purpose and usage for AI tools.

# Header section - Standardized format
version: 1.0
provider: aws
service: <service_name>  # e.g., acm, accessanalyzer, api_gateway

# Discovery phase - Enhanced with emit section
# - One discovery pipeline fetches resources and extracts fields into per-item snapshots
# - Emit section defines how resources are iterated over in checks
discovery:
  discovery_id: aws.<service_name>.resources  # Standardized naming pattern
  calls:
    - client: <boto3_client_name>  # e.g., acm, accessanalyzer, apigateway
      action: <describe_action>    # e.g., describe_acms, describe_accessanalyzers, get_rest_apis
      paginate: true               # Standard pagination for AWS APIs
  fields:
    - name: id                     # Primary identifier field
      save_as: <resource_id>       # Variable name for referencing (e.g., rest_api_id, certificate_id)
  emit:                           # NEW: Enhanced resource iteration
    items_for:
      as: resource                # Variable name for iteration in checks
      item: <resource_id>         # References the saved field from above

# Checks phase - Enhanced with assertion_id mapping
# - Evaluates compliance assertions for each discovered item
# - Uses standardized assertion_id for compliance framework mapping
checks:
  - title: <Human Readable Title>           # Human-readable rule name
    severity: <low|medium|high|critical>    # Compliance severity level
    rule_id: aws.<service>.<category>.<specific_check>  # Hierarchical rule identifier
    assertion_id: <framework>.<domain>.<specific_control>  # NEW: Compliance framework mapping
    for_each:
      as: resource                # References emit variable from discovery
      item: <resource_id>         # References the resource identifier
    conditions:
      - field: resource.compliant # Standard compliance check field
        operator: equals          # Standard operator for compliance
        value: true               # Expected compliant state
    remediation: "Implement <check_description> for <service>"
    references:
      - "https://docs.aws.amazon.com/<service>/"

# Enhanced Rule ID Structure Examples:
# - aws.acm.certificate_management.auto_renewal_enabled
# - aws.api_gateway.ssl_enforcement.tls_enforced
# - aws.accessanalyzer.findings.access_reviews_conducted

# Assertion ID Framework Mappings:
# - crypto_data_protection.* - Encryption, certificates, keys
# - rbac_entitlements.* - Access control, permissions
# - network_perimeter.* - Firewalls, WAF, network security
# - serverless_paas.* - Serverless security controls
# - governance_compliance.* - Policy management, compliance
# - platform_surfaces_versions.* - API management, versioning

# Severity Guidelines:
# - critical: Data exposure, authentication bypass
# - high: Encryption, network security, access control
# - medium: Monitoring, logging, configuration
# - low: Best practices, optimization

# Notes for tool-generated rules:
# - Ensure client names match exact boto3 client names
# - Use standardized action naming (describe_*, get_*)
# - Always set paginate: true for AWS APIs
# - Use consistent variable naming throughout
# - Map assertion_ids to real compliance frameworks
# - Provide actionable remediation steps
# - Link to official AWS documentation 