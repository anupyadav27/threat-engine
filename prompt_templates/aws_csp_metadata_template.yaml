# AWS Cloud Security Posture (CSP) Metadata Template
# This template is specifically designed for CSPM (Cloud Security Posture Management) tool integration
# Use this template when generating metadata files for AWS compliance checks

metadata:
  # ============================================================================
  # CORE IDENTIFICATION (Required)
  # ============================================================================
  rule_id: aws.<service>.<category>.<check_name>
  title: <Human Readable Title>
  description: <Detailed description of the security control, what it protects, and why it matters>
  
  # ============================================================================
  # CSP CATEGORIZATION (Required for CSPM Integration)
  # ============================================================================
  # Primary CSPM category - determines how the check is organized in CSPM dashboards
  cspm_category: <data_security|entitlement|network_security|compute_security|secrets_management|compliance_governance|monitoring_detection|infrastructure_security>
  
  # CSPM subcategory - provides granular categorization within the primary category
  cspm_subcategory: <specific_subcategory_from_list_below>
  
  # Security domain - high-level security domain for cross-category grouping
  security_domain: <data_security|identity_access|network_security|compute_security|secrets_management|compliance_governance|monitoring_detection|infrastructure_security>
  
  # CSPM tags - for filtering, grouping, and search in CSPM tools
  cspm_tags:
    - <tag1>  # e.g., encryption, s3, data-protection
    - <tag2>  # e.g., compliance, cis-aws-foundations
    - <tag3>  # e.g., high-priority, auto-remediate
  
  # ============================================================================
  # COMPLIANCE FRAMEWORK MAPPING (Required)
  # ============================================================================
  assertion_id: <framework>.<domain>.<control>  # e.g., crypto_data_protection.encryption_at_rest.default_encryption_enabled
  
  # Map to compliance frameworks - include all relevant frameworks
  compliance_frameworks:
    - framework: <CIS|NIST|SOC2|HIPAA|PCI-DSS|GDPR|ISO27001>
      control_id: <framework_specific_id>  # e.g., CIS-2.1.1, NIST-SC-13
      control_title: <Control Title from Framework>
      mapping_type: <direct|partial|related>  # direct = fully implements, partial = partially implements, related = contextually related
      version: <framework_version>  # e.g., CIS-1.4, NIST-800-53-rev5
    
    # Add additional frameworks as needed
    # - framework: <another_framework>
    #   control_id: <another_control_id>
    #   control_title: <another_control_title>
    #   mapping_type: <direct|partial|related>
  
  # ============================================================================
  # SERVICE & RESOURCE INFORMATION (Required)
  # ============================================================================
  service: <service_name>  # e.g., s3, iam, ec2, rds, kms
  resource_type: <resource_type>  # e.g., storage.bucket, identity.user, compute.vm, database.instance
  resource_scope: <account|region|resource>  # What level this check operates at
  adapter: aws.<service>.<adapter_name>  # Engine adapter identifier
  
  # ============================================================================
  # RISK ASSESSMENT & SEVERITY (Required)
  # ============================================================================
  severity: <low|medium|high|critical>  # Compliance severity level
  
  # Risk scoring for CSPM prioritization (0-100 scale)
  risk_score: <0-100>  # Numeric risk score - see guidelines below
  
  # Business impact if this control fails
  impact: <low|medium|high|critical>  # Business impact level
  
  # Likelihood of exploitation if control fails
  likelihood: <low|medium|high>  # Likelihood of exploitation
  
  # Risk calculation notes (optional)
  risk_calculation: <Brief explanation of how risk_score was determined>
  
  # ============================================================================
  # DETECTION & EVIDENCE (Required)
  # ============================================================================
  # Type of evidence used for this check
  evidence_type: <config_read|api_call|log_analysis|scan_result>
  
  # When/how the check is detected
  detection_method: <static|runtime|continuous>  # static = config check, runtime = live check, continuous = ongoing monitoring
  
  # Detection capability level
  detection_capability: <automated|manual|semi-automated>
  
  # Detection frequency recommendation
  recommended_frequency: <continuous|daily|weekly|monthly>  # How often this should be checked
  
  # ============================================================================
  # COVERAGE & PRIORITY (Required)
  # ============================================================================
  coverage_tier: <core|extended|premium>  # core = essential, extended = recommended, premium = advanced
  priority: <p0|p1|p2|p3>  # P0 = critical, must fix immediately; P3 = nice to have
  
  # ============================================================================
  # REMEDIATION GUIDANCE (Required)
  # ============================================================================
  remediation:
    description: <Step-by-step remediation guidance explaining how to fix the issue>
    
    # Can this be automatically remediated?
    automated: <true|false>
    
    # Type of remediation required
    remediation_type: <config_change|policy_update|permission_change|delete|isolate|quarantine>
    
    # Detailed remediation steps
    remediation_steps:
      - step: 1
        action: <First remediation action>
        command: <AWS CLI command if applicable>
        api_call: <AWS API call if applicable>
        description: <Detailed description of this step>
      
      - step: 2
        action: <Second remediation action>
        command: <AWS CLI command if applicable>
        description: <Detailed description of this step>
    
    # Estimated time to remediate
    estimated_time: <minutes|hours|days>
    
    # Complexity of remediation
    complexity: <low|medium|high>
    
    # Potential side effects or considerations
    side_effects: <Any potential side effects or things to consider during remediation>
    
    # References for remediation
    remediation_references:
      - <URL or document reference>
  
  # ============================================================================
  # CONTEXT & RATIONALE (Required)
  # ============================================================================
  rationale: <Why this control is important - what it protects against and why>
  business_justification: <Business reason for implementing this control - compliance, risk reduction, etc.>
  attack_scenario: <Example of how this could be exploited if not implemented - real-world attack scenario>
  
  # ============================================================================
  # APPLICABILITY & CONDITIONS (Required)
  # ============================================================================
  not_applicable_when: <condition_description>  # e.g., no_s3_buckets, no_public_resources, no_iam_users
  prerequisites: []  # List of prerequisites or dependencies for this check
  related_rules: []  # Related rule_ids that should be checked together or are contextually related
  
  # ============================================================================
  # PARAMETERS & CONFIGURATION (Optional)
  # ============================================================================
  params: {}  # Any parameters required for the check - key-value pairs
  configurable: <true|false>  # Can the check be customized or parameterized
  
  # ============================================================================
  # DATA SECURITY SPECIFIC FIELDS (For data_security category)
  # ============================================================================
  # Only include if cspm_category is data_security
  data_classification: <public|internal|confidential|restricted>  # Classification level of data being protected
  pii_handling: <true|false>  # Does this check relate to PII/PHI handling
  data_residency: <region_specific|global>  # Data residency requirements
  
  # ============================================================================
  # ENTITLEMENT SPECIFIC FIELDS (For entitlement category)
  # ============================================================================
  # Only include if cspm_category is entitlement
  access_type: <read|write|delete|admin|full_control>  # Type of access being controlled
  privilege_level: <readonly|standard|elevated|administrative>  # Privilege level required
  network_scope: <vpc|public|private|cross_account|internet>  # Network scope of access
  
  # ============================================================================
  # NETWORK SECURITY SPECIFIC FIELDS (For network_security category)
  # ============================================================================
  # Only include if cspm_category is network_security
  network_scope: <vpc|public|private|cross_account|internet|peered>  # Network scope
  traffic_direction: <ingress|egress|both>  # Traffic direction being controlled
  protocol: <tcp|udp|icmp|all>  # Network protocol if applicable
  
  # ============================================================================
  # ADDITIONAL INFORMATION (Optional but Recommended)
  # ============================================================================
  notes: <Additional implementation notes, considerations, or best practices>
  reference_url: <AWS documentation URL>
  aws_well_architected_pillar: <operational_excellence|security|reliability|performance_efficiency|cost_optimization|sustainability>
  
  # Alert configuration for CSPM tools
  alert_priority: <low|medium|high|critical>  # Alert priority in CSPM tools
  auto_remediation_enabled: <true|false>  # Whether auto-remediation is enabled by default
  suppression_allowed: <true|false>  # Whether findings can be suppressed with justification
  
  # Timestamps
  created_at: <ISO8601_timestamp>  # e.g., 2025-01-15T10:30:00Z
  updated_at: <ISO8601_timestamp>
  last_validated: <ISO8601_timestamp>

# ============================================================================
# CSPM CATEGORY REFERENCE GUIDE
# ============================================================================

cspm_categories:
  # DATA SECURITY & PROTECTION
  - category: data_security
    description: "Controls for protecting data at rest, in transit, and in use"
    subcategories:
      - data_encryption_at_rest
      - data_encryption_in_transit
      - data_classification
      - data_backup
      - data_retention
      - data_loss_prevention
      - data_access_control
      - data_residency
    examples:
      - "S3 bucket encryption"
      - "RDS database encryption"
      - "EBS volume encryption"
      - "Data backup configuration"
  
  # IDENTITY & ACCESS MANAGEMENT (ENTITLEMENT)
  - category: entitlement
    description: "Controls for managing identity, authentication, authorization, and access permissions"
    subcategories:
      - access_control
      - authentication
      - authorization
      - privilege_management
      - service_accounts
      - role_management
      - policy_management
      - mfa_enforcement
      - session_management
      - least_privilege
      - access_reviews
      - temporary_access
    examples:
      - "IAM user MFA enabled"
      - "IAM role least privilege"
      - "IAM policy permissions"
      - "Service account configuration"
  
  # NETWORK SECURITY
  - category: network_security
    description: "Controls for network perimeter, segmentation, firewall rules, and network access"
    subcategories:
      - firewall_rules
      - network_segmentation
      - vpc_configuration
      - network_monitoring
      - dns_security
      - load_balancer_security
      - vpn_security
      - network_access_control
      - subnet_segmentation
      - security_groups
      - nacl_rules
    examples:
      - "Security group SSH restrictions"
      - "VPC flow logs enabled"
      - "Network ACL rules"
      - "Load balancer security"
  
  # COMPUTE SECURITY
  - category: compute_security
    description: "Controls for virtual machines, containers, serverless, and compute resources"
    subcategories:
      - instance_security
      - container_security
      - serverless_security
      - image_security
      - runtime_protection
      - metadata_service
      - instance_monitoring
      - container_scanning
    examples:
      - "EC2 IMDSv2 enforcement"
      - "ECS container security"
      - "Lambda function security"
      - "AMI image hardening"
  
  # SECRETS & KEY MANAGEMENT
  - category: secrets_management
    description: "Controls for cryptographic keys, certificates, secrets storage, and key rotation"
    subcategories:
      - key_rotation
      - key_management
      - secret_storage
      - certificate_management
      - kms_configuration
      - secrets_encryption
      - key_access_control
    examples:
      - "KMS key rotation"
      - "Secrets Manager encryption"
      - "Certificate auto-renewal"
      - "Key access policies"
  
  # COMPLIANCE & GOVERNANCE
  - category: compliance_governance
    description: "Controls for audit logging, compliance monitoring, policy enforcement, and governance"
    subcategories:
      - audit_logging
      - compliance_monitoring
      - policy_enforcement
      - configuration_management
      - drift_detection
      - resource_tagging
      - compliance_reporting
    examples:
      - "CloudTrail logging enabled"
      - "AWS Config compliance"
      - "Resource tagging policy"
      - "Compliance drift detection"
  
  # MONITORING & DETECTION
  - category: monitoring_detection
    description: "Controls for security monitoring, logging, threat detection, and incident response"
    subcategories:
      - log_management
      - threat_detection
      - anomaly_detection
      - incident_response
      - security_monitoring
      - alerting
      - siem_integration
    examples:
      - "GuardDuty enabled"
      - "CloudWatch logging"
      - "Security Hub findings"
      - "Anomaly detection"
  
  # INFRASTRUCTURE SECURITY
  - category: infrastructure_security
    description: "Controls for platform hardening, vulnerability management, and infrastructure security"
    subcategories:
      - platform_hardening
      - patch_management
      - vulnerability_management
      - endpoint_protection
      - infrastructure_monitoring
      - security_updates
    examples:
      - "EC2 patch management"
      - "System Manager patching"
      - "Vulnerability scanning"
      - "Infrastructure hardening"

# ============================================================================
# SECURITY DOMAIN MAPPING
# ============================================================================
security_domains:
  data_security: "Protection of data at rest, in transit, and in use through encryption, classification, and access controls"
  identity_access: "Identity verification, authentication, authorization, and access management controls"
  network_security: "Network perimeter protection, segmentation, firewall rules, and traffic controls"
  compute_security: "Virtual machine, container, and serverless resource security and hardening"
  secrets_management: "Cryptographic keys, certificates, secrets storage, and key lifecycle management"
  compliance_governance: "Audit logging, compliance monitoring, policy enforcement, and governance controls"
  monitoring_detection: "Security monitoring, logging, threat detection, and incident response capabilities"
  infrastructure_security: "Platform hardening, vulnerability management, and infrastructure security controls"

# ============================================================================
# RISK SCORING GUIDELINES
# ============================================================================
risk_scoring:
  critical_90_100:
    description: "Critical vulnerabilities that pose immediate security risk"
    examples:
      - "Public S3 buckets with sensitive data"
      - "Root account access keys active"
      - "Authentication bypass vulnerabilities"
      - "Public RDS instances with sensitive data"
  
  high_70_89:
    description: "High-risk issues that significantly increase attack surface"
    examples:
      - "Encryption disabled on storage"
      - "Missing MFA for privileged users"
      - "Excessive IAM permissions"
      - "Unrestricted security group rules"
  
  medium_50_69:
    description: "Medium-risk issues that should be addressed"
    examples:
      - "Missing CloudTrail logging"
      - "Outdated security policies"
      - "Suboptimal configuration"
      - "Missing monitoring"
  
  low_0_49:
    description: "Low-risk issues and best practice recommendations"
    examples:
      - "Resource tagging recommendations"
      - "Cost optimization suggestions"
      - "Best practice improvements"
      - "Optimization recommendations"

# ============================================================================
# EXAMPLE METADATA FILES
# ============================================================================

example_data_security:
  metadata:
    rule_id: aws.s3.bucket_encryption.default_encryption_enabled
    title: S3 Bucket Default Encryption Enabled
    description: Ensure all S3 buckets have default encryption enabled to protect data at rest from unauthorized access
    cspm_category: data_security
    cspm_subcategory: data_encryption_at_rest
    security_domain: data_security
    cspm_tags: [encryption, s3, data-protection, compliance, critical]
    assertion_id: crypto_data_protection.encryption_at_rest.default_encryption_enabled
    compliance_frameworks:
      - framework: CIS
        control_id: CIS-2.1.1
        control_title: Ensure S3 bucket encryption is enabled
        mapping_type: direct
        version: CIS-1.4
      - framework: NIST
        control_id: SC-13
        control_title: Cryptographic Protection
        mapping_type: direct
        version: NIST-800-53-rev5
    service: s3
    resource_type: storage.bucket
    resource_scope: account
    severity: high
    risk_score: 85
    impact: high
    likelihood: high
    evidence_type: config_read
    detection_method: static
    detection_capability: automated
    recommended_frequency: continuous
    coverage_tier: core
    priority: p0
    remediation:
      description: Enable default encryption on S3 buckets using AWS KMS or S3 managed keys
      automated: true
      remediation_type: config_change
      remediation_steps:
        - step: 1
          action: Enable default encryption on bucket
          command: aws s3api put-bucket-encryption --bucket <bucket-name> --server-side-encryption-configuration file://encryption.json
          description: Apply encryption configuration to the S3 bucket
      estimated_time: minutes
      complexity: low
    rationale: Unencrypted S3 buckets expose data to unauthorized access, especially if bucket policies are misconfigured
    business_justification: Protects sensitive customer data and meets compliance requirements (HIPAA, PCI-DSS, GDPR)
    attack_scenario: Attacker gains access to unencrypted S3 bucket through misconfigured bucket policy, exfiltrates sensitive customer data
    not_applicable_when: no_s3_buckets
    data_classification: confidential
    pii_handling: true
    aws_well_architected_pillar: security
    alert_priority: high
    auto_remediation_enabled: true
    suppression_allowed: false

example_entitlement:
  metadata:
    rule_id: aws.iam.entitlement_policies.lifecycle_managed
    title: IAM Entitlement Lifecycle Management
    description: Ensure IAM entitlements have proper lifecycle management with regular access reviews and automated deprovisioning
    cspm_category: entitlement
    cspm_subcategory: privilege_management
    security_domain: identity_access
    cspm_tags: [iam, entitlement, access-control, compliance, lifecycle]
    assertion_id: rbac_entitlements.entitlement_management.lifecycle_managed
    compliance_frameworks:
      - framework: CIS
        control_id: CIS-1.4
        control_title: Ensure access keys are rotated every 90 days
        mapping_type: related
        version: CIS-1.4
      - framework: SOC2
        control_id: CC6.2
        control_title: Logical Access Controls
        mapping_type: direct
        version: SOC2-2017
    service: iam
    resource_type: identity.user
    resource_scope: account
    severity: medium
    risk_score: 65
    impact: medium
    likelihood: medium
    evidence_type: config_read
    detection_method: static
    detection_capability: automated
    recommended_frequency: weekly
    coverage_tier: core
    priority: p1
    remediation:
      description: Implement automated access review workflows using IAM Access Analyzer and configure lifecycle policies
      automated: false
      remediation_type: policy_update
      remediation_steps:
        - step: 1
          action: Enable IAM Access Analyzer
          command: aws accessanalyzer create-analyzer --analyzer-name iam-analyzer --type ACCOUNT
          description: Enable IAM Access Analyzer to monitor access patterns
        - step: 2
          action: Configure automated deprovisioning for inactive users
          description: Set up lifecycle policies to automatically disable users inactive for 90+ days
      estimated_time: hours
      complexity: medium
      side_effects: "May require coordination with identity provider if using SSO"
    rationale: Unmanaged entitlements lead to privilege creep and unauthorized access from inactive or overprivileged accounts
    business_justification: Reduces security risk, maintains least privilege principles, and meets compliance requirements
    attack_scenario: Compromised inactive user account or overprivileged service account used for lateral movement and data exfiltration
    not_applicable_when: no_iam_resources
    access_type: admin
    privilege_level: elevated
    network_scope: cross_account
    aws_well_architected_pillar: security
    alert_priority: medium
    auto_remediation_enabled: false
    suppression_allowed: true

